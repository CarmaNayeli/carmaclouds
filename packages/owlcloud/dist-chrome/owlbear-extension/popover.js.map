{
  "version": 3,
  "sources": ["../../owlbear-extension/popover.js"],
  "sourcesContent": ["/**\r\n * OwlCloud Owlbear Extension - Popover Script\r\n *\r\n * This script runs inside the Owlbear extension popover and:\r\n * 1. Communicates with the browser extension via window.postMessage\r\n * 2. Uses the Owlbear SDK to interact with the scene\r\n * 3. Displays character information and controls\r\n */\r\n\r\n/* global OBR, buildImage */\r\n\r\n// ============== State ==============\r\n\r\nlet currentCharacter = null;\r\nlet allCharacters = [];\r\nlet isOwlbearReady = false;\r\nlet rollMode = 'normal'; // 'advantage', 'normal', or 'disadvantage'\r\nlet concentratingSpell = null; // Track which spell is currently being concentrated on\r\nconst concentrationByCharacter = new Map(); // Persist concentration per character ID\r\n\r\n// Dice+ integration\r\nconst OWLCLOUD_EXTENSION_ID = 'com.owlcloud.extension';\r\nlet dicePlusReady = false;\r\nlet pendingRolls = new Map(); // Track rolls waiting for results from Dice+\r\n\r\n// Supabase configuration\r\nconst SUPABASE_URL = 'https://luiesmfjdcmpywavvfqm.supabase.co';\r\nconst SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1aWVzbWZqZGNtcHl3YXZ2ZnFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODYxNDksImV4cCI6MjA4NTQ2MjE0OX0.oqjHFf2HhCLcanh0HVryoQH7iSV7E9dHHZJdYehxZ0U';\r\nconst SUPABASE_HEADERS = {\r\n  'apikey': SUPABASE_ANON_KEY,\r\n  'Content-Type': 'application/json'\r\n};\r\n\r\n// Supabase Auth\r\nlet supabase = null;\r\nlet currentUser = null;\r\n\r\n// ============== DOM Elements ==============\r\n\r\nconst statusText = document.getElementById('status-text');\r\nconst characterSection = document.getElementById('character-section');\r\nconst noCharacterSection = document.getElementById('no-character-section');\r\nconst characterInfo = document.getElementById('character-info');\r\nconst syncCharacterBtn = document.getElementById('sync-character-btn');\r\nconst openChatWindowBtn = document.getElementById('open-chat-window-btn');\r\n\r\n// ============== Theme Management ==============\r\n\r\n/**\r\n * Helper function to generate complementary background colors\r\n * This creates a harmonious color palette based on the primary color\r\n */\r\nfunction generateComplementaryBackgrounds(primaryColor) {\r\n  // Convert hex to RGB\r\n  const hex = primaryColor.replace('#', '');\r\n  const r = parseInt(hex.substr(0, 2), 16);\r\n  const g = parseInt(hex.substr(2, 2), 16);\r\n  const b = parseInt(hex.substr(4, 2), 16);\r\n  \r\n  // Create complementary background variations\r\n  // These are carefully crafted to provide good contrast and harmony\r\n  const backgrounds = {\r\n    // Dark gradient background (complementary to primary)\r\n    bgPrimary: `linear-gradient(135deg, \r\n      rgba(${Math.max(0, r - 80)}, ${Math.max(0, g - 80)}, ${Math.max(0, b - 80)}, 1) 0%, \r\n      rgba(${Math.max(0, r - 60)}, ${Math.max(0, g - 60)}, ${Math.max(0, b - 60)}, 1) 50%, \r\n      rgba(${Math.max(0, r - 40)}, ${Math.max(0, g - 40)}, ${Math.max(0, b - 40)}, 1) 100%)`,\r\n    \r\n    // Semi-transparent secondary background\r\n    bgSecondary: `rgba(${Math.max(0, r - 100)}, ${Math.max(0, g - 100)}, ${Math.max(0, b - 100)}, 0.8)`,\r\n    \r\n    // Light accent background\r\n    bgAccent: `rgba(${r}, ${g}, ${b}, 0.15)`,\r\n    \r\n    // Card background\r\n    bgCard: `rgba(${r}, ${g}, ${b}, 0.1)`,\r\n    \r\n    // Hover state\r\n    bgHover: `rgba(${r}, ${g}, ${b}, 0.2)`\r\n  };\r\n  \r\n  return backgrounds;\r\n}\r\n\r\n/**\r\n * Theme manager for OBR extension\r\n */\r\nconst ThemeManager = {\r\n  // Predefined themes\r\n  themes: {\r\n    purple: {\r\n      name: 'Purple',\r\n      primary: '#8B5CF6',\r\n      primaryLight: '#A78BFA',\r\n      primaryLighter: '#C4B5FD',\r\n      gradient: 'linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%)',\r\n      background: 'rgba(139, 92, 246, 0.1)',\r\n      border: 'rgba(139, 92, 246, 0.3)',\r\n      shadow: 'rgba(139, 92, 246, 0.4)',\r\n      // Complementary background colors\r\n      bgPrimary: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)',\r\n      bgSecondary: 'rgba(26, 26, 46, 0.8)',\r\n      bgAccent: 'rgba(139, 92, 246, 0.15)',\r\n      bgCard: 'rgba(139, 92, 246, 0.1)',\r\n      bgHover: 'rgba(139, 92, 246, 0.2)',\r\n      // Text colors with proper contrast\r\n      textPrimary: '#e0e0e0',\r\n      textSecondary: '#c0c0c0',\r\n      textMuted: '#9ca3af',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    },\r\n    blue: {\r\n      name: 'Blue',\r\n      primary: '#3B82F6',\r\n      primaryLight: '#60A5FA',\r\n      primaryLighter: '#93C5FD',\r\n      gradient: 'linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%)',\r\n      background: 'rgba(59, 130, 246, 0.1)',\r\n      border: 'rgba(59, 130, 246, 0.3)',\r\n      shadow: 'rgba(59, 130, 246, 0.4)',\r\n      // Complementary background colors\r\n      bgPrimary: 'linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%)',\r\n      bgSecondary: 'rgba(15, 23, 42, 0.8)',\r\n      bgAccent: 'rgba(59, 130, 246, 0.15)',\r\n      bgCard: 'rgba(59, 130, 246, 0.1)',\r\n      bgHover: 'rgba(59, 130, 246, 0.2)',\r\n      // Text colors with proper contrast\r\n      textPrimary: '#e0e0e0',\r\n      textSecondary: '#c0c0c0',\r\n      textMuted: '#9ca3af',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    },\r\n    green: {\r\n      name: 'Green',\r\n      primary: '#10B981',\r\n      primaryLight: '#34D399',\r\n      primaryLighter: '#6EE7B7',\r\n      gradient: 'linear-gradient(135deg, #10B981 0%, #34D399 100%)',\r\n      background: 'rgba(16, 185, 129, 0.1)',\r\n      border: 'rgba(16, 185, 129, 0.3)',\r\n      shadow: 'rgba(16, 185, 129, 0.4)',\r\n      // Complementary background colors\r\n      bgPrimary: 'linear-gradient(135deg, #052e16 0%, #0a4d2a 50%, #0f6b3e 100%)',\r\n      bgSecondary: 'rgba(5, 46, 22, 0.8)',\r\n      bgAccent: 'rgba(16, 185, 129, 0.15)',\r\n      bgCard: 'rgba(16, 185, 129, 0.1)',\r\n      bgHover: 'rgba(16, 185, 129, 0.2)',\r\n      // Text colors with proper contrast\r\n      textPrimary: '#e0e0e0',\r\n      textSecondary: '#c0c0c0',\r\n      textMuted: '#9ca3af',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    },\r\n    red: {\r\n      name: 'Red',\r\n      primary: '#EF4444',\r\n      primaryLight: '#F87171',\r\n      primaryLighter: '#FCA5A5',\r\n      gradient: 'linear-gradient(135deg, #EF4444 0%, #F87171 100%)',\r\n      background: 'rgba(239, 68, 68, 0.1)',\r\n      border: 'rgba(239, 68, 68, 0.3)',\r\n      shadow: 'rgba(239, 68, 68, 0.4)',\r\n      // Complementary background colors\r\n      bgPrimary: 'linear-gradient(135deg, #450a0a 0%, #7f1d1d 50%, #991b1b 100%)',\r\n      bgSecondary: 'rgba(69, 10, 10, 0.8)',\r\n      bgAccent: 'rgba(239, 68, 68, 0.15)',\r\n      bgCard: 'rgba(239, 68, 68, 0.1)',\r\n      bgHover: 'rgba(239, 68, 68, 0.2)',\r\n      // Text colors with proper contrast\r\n      textPrimary: '#e0e0e0',\r\n      textSecondary: '#c0c0c0',\r\n      textMuted: '#9ca3af',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    },\r\n    orange: {\r\n      name: 'Orange',\r\n      primary: '#F97316',\r\n      primaryLight: '#FB923C',\r\n      primaryLighter: '#FDBA74',\r\n      gradient: 'linear-gradient(135deg, #F97316 0%, #FB923C 100%)',\r\n      background: 'rgba(249, 115, 22, 0.1)',\r\n      border: 'rgba(249, 115, 22, 0.3)',\r\n      shadow: 'rgba(249, 115, 22, 0.4)',\r\n      // Complementary background colors\r\n      bgPrimary: 'linear-gradient(135deg, #431407 0%, #7c2d12 50%, #9a3412 100%)',\r\n      bgSecondary: 'rgba(67, 20, 7, 0.8)',\r\n      bgAccent: 'rgba(249, 115, 22, 0.15)',\r\n      bgCard: 'rgba(249, 115, 22, 0.1)',\r\n      bgHover: 'rgba(249, 115, 22, 0.2)',\r\n      // Text colors with proper contrast\r\n      textPrimary: '#e0e0e0',\r\n      textSecondary: '#c0c0c0',\r\n      textMuted: '#9ca3af',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    },\r\n    yellow: {\r\n      name: 'Gold',\r\n      primary: '#EAB308',\r\n      primaryLight: '#FACC15',\r\n      primaryLighter: '#FDE047',\r\n      gradient: 'linear-gradient(135deg, #EAB308 0%, #FACC15 100%)',\r\n      background: 'rgba(234, 179, 8, 0.1)',\r\n      border: 'rgba(234, 179, 8, 0.3)',\r\n      shadow: 'rgba(234, 179, 8, 0.4)',\r\n      // Complementary background colors\r\n      bgPrimary: 'linear-gradient(135deg, #422006 0%, #713f12 50%, #854d0e 100%)',\r\n      bgSecondary: 'rgba(66, 34, 6, 0.8)',\r\n      bgAccent: 'rgba(234, 179, 8, 0.15)',\r\n      bgCard: 'rgba(234, 179, 8, 0.1)',\r\n      bgHover: 'rgba(234, 179, 8, 0.2)',\r\n      // Text colors with proper contrast\r\n      textPrimary: '#e0e0e0',\r\n      textSecondary: '#c0c0c0',\r\n      textMuted: '#9ca3af',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    },\r\n    pink: {\r\n      name: 'Pink',\r\n      primary: '#EC4899',\r\n      primaryLight: '#F472B6',\r\n      primaryLighter: '#F9A8D4',\r\n      gradient: 'linear-gradient(135deg, #EC4899 0%, #F472B6 100%)',\r\n      background: 'rgba(236, 72, 153, 0.1)',\r\n      border: 'rgba(236, 72, 153, 0.3)',\r\n      shadow: 'rgba(236, 72, 153, 0.4)',\r\n      // Complementary background colors\r\n      bgPrimary: 'linear-gradient(135deg, #500724 0%, #831843 50%, #9f1239 100%)',\r\n      bgSecondary: 'rgba(80, 7, 36, 0.8)',\r\n      bgAccent: 'rgba(236, 72, 153, 0.15)',\r\n      bgCard: 'rgba(236, 72, 153, 0.1)',\r\n      bgHover: 'rgba(236, 72, 153, 0.2)',\r\n      // Text colors with proper contrast\r\n      textPrimary: '#e0e0e0',\r\n      textSecondary: '#c0c0c0',\r\n      textMuted: '#9ca3af',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    },\r\n    brown: {\r\n      name: 'Brown',\r\n      primary: '#92400E',\r\n      primaryLight: '#B45309',\r\n      primaryLighter: '#D97706',\r\n      gradient: 'linear-gradient(135deg, #92400E 0%, #B45309 100%)',\r\n      background: 'rgba(146, 64, 14, 0.1)',\r\n      border: 'rgba(146, 64, 14, 0.3)',\r\n      shadow: 'rgba(146, 64, 14, 0.4)',\r\n      // Complementary background colors\r\n      bgPrimary: 'linear-gradient(135deg, #1c0f0a 0%, #442c1e 50%, #5c341e 100%)',\r\n      bgSecondary: 'rgba(28, 15, 10, 0.8)',\r\n      bgAccent: 'rgba(146, 64, 14, 0.15)',\r\n      bgCard: 'rgba(146, 64, 14, 0.1)',\r\n      bgHover: 'rgba(146, 64, 14, 0.2)',\r\n      // Text colors with proper contrast\r\n      textPrimary: '#e0e0e0',\r\n      textSecondary: '#c0c0c0',\r\n      textMuted: '#9ca3af',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    },\r\n    grey: {\r\n      name: 'Grey',\r\n      primary: '#6B7280',\r\n      primaryLight: '#9CA3AF',\r\n      primaryLighter: '#D1D5DB',\r\n      gradient: 'linear-gradient(135deg, #6B7280 0%, #9CA3AF 100%)',\r\n      background: 'rgba(107, 114, 128, 0.1)',\r\n      border: 'rgba(107, 114, 128, 0.3)',\r\n      shadow: 'rgba(107, 114, 128, 0.4)',\r\n      // Complementary background colors\r\n      bgPrimary: 'linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%)',\r\n      bgSecondary: 'rgba(31, 41, 55, 0.8)',\r\n      bgAccent: 'rgba(107, 114, 128, 0.15)',\r\n      bgCard: 'rgba(107, 114, 128, 0.1)',\r\n      bgHover: 'rgba(107, 114, 128, 0.2)',\r\n      // Text colors with proper contrast\r\n      textPrimary: '#e0e0e0',\r\n      textSecondary: '#c0c0c0',\r\n      textMuted: '#9ca3af',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    },\r\n    black: {\r\n      name: 'Black',\r\n      primary: '#1F2937',\r\n      primaryLight: '#374151',\r\n      primaryLighter: '#4B5563',\r\n      gradient: 'linear-gradient(135deg, #1F2937 0%, #374151 100%)',\r\n      background: 'rgba(31, 41, 55, 0.1)',\r\n      border: 'rgba(31, 41, 55, 0.3)',\r\n      shadow: 'rgba(31, 41, 55, 0.4)',\r\n      // Complementary background colors\r\n      bgPrimary: 'linear-gradient(135deg, #000000 0%, #111827 50%, #1f2937 100%)',\r\n      bgSecondary: 'rgba(0, 0, 0, 0.8)',\r\n      bgAccent: 'rgba(31, 41, 55, 0.15)',\r\n      bgCard: 'rgba(31, 41, 55, 0.1)',\r\n      bgHover: 'rgba(31, 41, 55, 0.2)',\r\n      // Text colors with proper contrast (dark theme - white text)\r\n      textPrimary: '#ffffff',\r\n      textSecondary: '#e5e7eb',\r\n      textMuted: '#9ca3af',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    },\r\n    white: {\r\n      name: 'White',\r\n      primary: '#F9FAFB',\r\n      primaryLight: '#F3F4F6',\r\n      primaryLighter: '#E5E7EB',\r\n      gradient: 'linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%)',\r\n      background: 'rgba(249, 250, 251, 0.1)',\r\n      border: 'rgba(249, 250, 251, 0.3)',\r\n      shadow: 'rgba(249, 250, 251, 0.4)',\r\n      // Complementary background colors (light theme)\r\n      bgPrimary: 'linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%)',\r\n      bgSecondary: 'rgba(248, 250, 252, 0.9)',\r\n      bgAccent: 'rgba(249, 250, 251, 0.5)',\r\n      bgCard: 'rgba(249, 250, 251, 0.8)',\r\n      bgHover: 'rgba(241, 245, 249, 0.9)',\r\n      // Text colors with proper contrast (light theme - dark text)\r\n      textPrimary: '#1f2937',\r\n      textSecondary: '#374151',\r\n      textMuted: '#6b7280',\r\n      textOnPrimary: '#ffffff',\r\n      textOnLight: '#1f2937'\r\n    }\r\n  },\r\n\r\n  // Current active theme\r\n  currentTheme: 'purple',\r\n\r\n  /**\r\n   * Initialize theme manager\r\n   */\r\n  init() {\r\n    // Load saved theme from localStorage\r\n    const savedTheme = localStorage.getItem('owlcloud-theme');\r\n    if (savedTheme && this.themes[savedTheme]) {\r\n      this.currentTheme = savedTheme;\r\n    }\r\n    this.applyTheme();\r\n  },\r\n\r\n  /**\r\n   * Apply current theme to all elements\r\n   */\r\n  applyTheme() {\r\n    const theme = this.themes[this.currentTheme];\r\n    if (!theme) return;\r\n\r\n    // Update CSS variables\r\n    this.updateCSSVariables(theme);\r\n    \r\n    // Update inline styles in JavaScript\r\n    this.updateInlineStyles(theme);\r\n    \r\n    // Handle special text color adjustments for light themes\r\n    this.updateTextColors(theme);\r\n    \r\n    // Save to localStorage\r\n    localStorage.setItem('owlcloud-theme', this.currentTheme);\r\n    \r\n    console.log(`\uD83C\uDFA8 Applied theme: ${theme.name}`);\r\n  },\r\n\r\n  /**\r\n   * Update text colors for light themes to ensure readability\r\n   */\r\n  updateTextColors(theme) {\r\n    const root = document.documentElement;\r\n    \r\n    // Adjust text colors for specific themes\r\n    if (theme.name === 'White') {\r\n      // Light theme - use dark text throughout\r\n      root.style.setProperty('--theme-text-primary', '#1f2937');\r\n      root.style.setProperty('--theme-text-secondary', '#374151');\r\n      root.style.setProperty('--theme-text-muted', '#6b7280');\r\n      root.style.setProperty('--theme-text-on-primary', '#ffffff');\r\n      root.style.setProperty('--theme-text-on-light', '#1f2937');\r\n    } else if (theme.name === 'Black') {\r\n      // Dark theme - use white text throughout\r\n      root.style.setProperty('--theme-text-primary', '#ffffff');\r\n      root.style.setProperty('--theme-text-secondary', '#e5e7eb');\r\n      root.style.setProperty('--theme-text-muted', '#9ca3af');\r\n      root.style.setProperty('--theme-text-on-primary', '#ffffff');\r\n      root.style.setProperty('--theme-text-on-light', '#1f2937');\r\n    } else if (theme.name === 'Gold') {\r\n      // Gold theme - use dark text for readability\r\n      root.style.setProperty('--theme-text-primary', '#1f2937');\r\n      root.style.setProperty('--theme-text-secondary', '#374151');\r\n      root.style.setProperty('--theme-text-muted', '#6b7280');\r\n      root.style.setProperty('--theme-text-on-primary', '#ffffff');\r\n      root.style.setProperty('--theme-text-on-light', '#1f2937');\r\n    } else {\r\n      // All other themes - use light text on dark backgrounds\r\n      root.style.setProperty('--theme-text-primary', '#e0e0e0');\r\n      root.style.setProperty('--theme-text-secondary', '#c0c0c0');\r\n      root.style.setProperty('--theme-text-muted', '#9ca3af');\r\n      root.style.setProperty('--theme-text-on-primary', '#ffffff');\r\n      root.style.setProperty('--theme-text-on-light', '#1f2937');\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Update CSS custom properties\r\n   */\r\n  updateCSSVariables(theme) {\r\n    const root = document.documentElement;\r\n    root.style.setProperty('--theme-primary', theme.primary);\r\n    root.style.setProperty('--theme-primary-light', theme.primaryLight);\r\n    root.style.setProperty('--theme-primary-lighter', theme.primaryLighter);\r\n    root.style.setProperty('--theme-gradient', theme.gradient);\r\n    root.style.setProperty('--theme-background', theme.background);\r\n    root.style.setProperty('--theme-border', theme.border);\r\n    root.style.setProperty('--theme-shadow', theme.shadow);\r\n    \r\n    // Apply complementary background colors\r\n    if (theme.bgPrimary) {\r\n      root.style.setProperty('--theme-bg-primary', theme.bgPrimary);\r\n      document.body.style.background = theme.bgPrimary;\r\n    }\r\n    if (theme.bgSecondary) {\r\n      root.style.setProperty('--theme-bg-secondary', theme.bgSecondary);\r\n      // Update container background\r\n      const container = document.querySelector('.container');\r\n      if (container) {\r\n        container.style.background = theme.bgSecondary;\r\n      }\r\n    }\r\n    if (theme.bgAccent) {\r\n      root.style.setProperty('--theme-bg-accent', theme.bgAccent);\r\n    }\r\n    if (theme.bgCard) {\r\n      root.style.setProperty('--theme-bg-card', theme.bgCard);\r\n    }\r\n    if (theme.bgHover) {\r\n      root.style.setProperty('--theme-bg-hover', theme.bgHover);\r\n    }\r\n    \r\n    // Apply text colors with proper contrast\r\n    if (theme.textPrimary) {\r\n      root.style.setProperty('--theme-text-primary', theme.textPrimary);\r\n      document.body.style.color = theme.textPrimary;\r\n    }\r\n    if (theme.textSecondary) {\r\n      root.style.setProperty('--theme-text-secondary', theme.textSecondary);\r\n    }\r\n    if (theme.textMuted) {\r\n      root.style.setProperty('--theme-text-muted', theme.textMuted);\r\n    }\r\n    if (theme.textOnPrimary) {\r\n      root.style.setProperty('--theme-text-on-primary', theme.textOnPrimary);\r\n    }\r\n    if (theme.textOnLight) {\r\n      root.style.setProperty('--theme-text-on-light', theme.textOnLight);\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Update inline styles that use hardcoded colors\r\n   */\r\n  updateInlineStyles(theme) {\r\n    // This will be expanded to update all hardcoded color references\r\n    // For now, we'll focus on the most common ones\r\n    this.updateCharacterPortraits(theme);\r\n    this.updateCircularImageBorders(theme);\r\n  },\r\n\r\n  /**\r\n   * Update character portrait borders\r\n   */\r\n  updateCharacterPortraits(theme) {\r\n    const portraits = document.querySelectorAll('#settings-portrait, .character-portrait');\r\n    portraits.forEach(portrait => {\r\n      if (portrait) {\r\n        portrait.style.borderColor = theme.primary;\r\n        portrait.style.boxShadow = `0 4px 12px ${theme.shadow}`;\r\n      }\r\n    });\r\n  },\r\n\r\n  /**\r\n   * Update circular image borders (for tokens)\r\n   */\r\n  updateCircularImageBorders(theme) {\r\n    // This will be called when creating circular images\r\n    // The actual border color will be updated in the createCircularImage function\r\n  },\r\n\r\n  /**\r\n   * Switch to a different theme\r\n   */\r\n  switchTheme(themeName) {\r\n    if (this.themes[themeName]) {\r\n      this.currentTheme = themeName;\r\n      this.applyTheme();\r\n      return true;\r\n    }\r\n    return false;\r\n  },\r\n\r\n  /**\r\n   * Get current theme\r\n   */\r\n  getCurrentTheme() {\r\n    return this.themes[this.currentTheme];\r\n  },\r\n\r\n  /**\r\n   * Get all available themes\r\n   */\r\n  getAvailableThemes() {\r\n    return Object.keys(this.themes).map(key => ({\r\n      key,\r\n      ...this.themes[key]\r\n    }));\r\n  }\r\n};\r\n\r\n/**\r\n * Initialize theme selector\r\n */\r\nfunction initializeThemeSelector() {\r\n  const themeSelector = document.getElementById('theme-selector');\r\n  if (!themeSelector) return;\r\n\r\n  const themes = ThemeManager.getAvailableThemes();\r\n  const currentTheme = ThemeManager.getCurrentTheme();\r\n\r\n  themes.forEach(theme => {\r\n    const themeOption = document.createElement('div');\r\n    themeOption.className = `theme-option ${theme.key === ThemeManager.currentTheme ? 'active' : ''}`;\r\n    themeOption.dataset.theme = theme.key;\r\n    \r\n    themeOption.innerHTML = `\r\n      <div class=\"theme-color-preview\" style=\"background: ${theme.primary}\"></div>\r\n      <div class=\"theme-name\">${theme.name}</div>\r\n    `;\r\n\r\n    themeOption.addEventListener('click', () => {\r\n      // Remove active class from all options\r\n      document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));\r\n      \r\n      // Add active class to clicked option\r\n      themeOption.classList.add('active');\r\n      \r\n      // Switch theme\r\n      ThemeManager.switchTheme(theme.key);\r\n    });\r\n\r\n    themeSelector.appendChild(themeOption);\r\n  });\r\n  \r\n  // Initialize collapsible theme section\r\n  initializeCollapsibleThemeSection();\r\n}\r\n\r\n/**\r\n * Initialize collapsible theme section\r\n */\r\nfunction initializeCollapsibleThemeSection() {\r\n  const themeHeader = document.getElementById('theme-section-header');\r\n  const themeContent = document.getElementById('theme-section-content');\r\n  \r\n  if (!themeHeader || !themeContent) return;\r\n  \r\n  // Set initial state (collapsed by default)\r\n  let isExpanded = false;\r\n  themeContent.classList.add('collapsed');\r\n  themeHeader.classList.add('collapsed');\r\n  \r\n  // Set initial arrow state (pointing right when collapsed)\r\n  const arrow = themeHeader.querySelector('span');\r\n  if (arrow) {\r\n    arrow.style.transform = 'rotate(-90deg)';\r\n  }\r\n  \r\n  themeHeader.addEventListener('click', () => {\r\n    isExpanded = !isExpanded;\r\n    \r\n    if (isExpanded) {\r\n      themeContent.classList.remove('collapsed');\r\n      themeHeader.classList.remove('collapsed');\r\n      if (arrow) {\r\n        arrow.style.transform = 'rotate(0deg)';\r\n      }\r\n    } else {\r\n      themeContent.classList.add('collapsed');\r\n      themeHeader.classList.add('collapsed');\r\n      if (arrow) {\r\n        arrow.style.transform = 'rotate(-90deg)';\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n// ============== Tab Management ==============\r\n\r\n/**\r\n * Initialize tab switching functionality\r\n */\r\nfunction initializeTabs() {\r\n  const tabButtons = document.querySelectorAll('.tab-button');\r\n  const tabContents = document.querySelectorAll('.tab-content');\r\n  const brandingHeader = document.getElementById('branding-header');\r\n  const characterHeader = document.getElementById('character-header');\r\n  const tabsNav = document.querySelector('.tabs-nav');\r\n\r\n  // Add mouse wheel scrolling to tab navigation\r\n  if (tabsNav) {\r\n    tabsNav.addEventListener('wheel', (e) => {\r\n      e.preventDefault();\r\n      tabsNav.scrollLeft += e.deltaY;\r\n    });\r\n  }\r\n\r\n  tabButtons.forEach(button => {\r\n    button.addEventListener('click', () => {\r\n      const tabName = button.getAttribute('data-tab');\r\n\r\n      // Remove active class from all tabs and contents\r\n      tabButtons.forEach(btn => btn.classList.remove('active'));\r\n      tabContents.forEach(content => content.classList.remove('active'));\r\n\r\n      // Add active class to clicked tab and corresponding content\r\n      button.classList.add('active');\r\n      document.getElementById(`tab-${tabName}`).classList.add('active');\r\n\r\n      // Toggle header based on tab\r\n      if (tabName === 'settings') {\r\n        brandingHeader.style.display = 'block';\r\n        characterHeader.style.display = 'none';\r\n      } else {\r\n        brandingHeader.style.display = 'none';\r\n        characterHeader.style.display = 'block';\r\n      }\r\n\r\n      console.log(`\uD83D\uDCD1 Switched to tab: ${tabName}`);\r\n    });\r\n  });\r\n}\r\n\r\n// Initialize tabs when DOM is ready\r\ninitializeTabs();\r\n\r\n// ============== Owlbear SDK Initialization ==============\r\n\r\nOBR.onReady(async () => {\r\n  isOwlbearReady = true;\r\n  console.log('\uD83E\uDD89 Owlbear SDK ready');\r\n  statusText.textContent = 'Connected to Owlbear Rodeo';\r\n\r\n  // Set character sheet height to half viewport minus action bar\r\n  // TODO: Make this dynamic based on actual viewport height\r\n  // Currently using fixed 460px as workaround since window.innerHeight doesn't work in popovers\r\n  const sheetHeight = 460;\r\n\r\n  try {\r\n    await OBR.popover.setHeight(sheetHeight);\r\n  } catch (error) {\r\n    console.error('Error setting popover height:', error);\r\n  }\r\n\r\n  // Initialize Supabase Auth (and link any existing characters)\r\n  await initializeSupabaseAuth();\r\n\r\n  // Check for active character\r\n  checkForActiveCharacter();\r\n\r\n  // Note: We don't auto-refresh character data because the local sheet state\r\n  // is the source of truth during gameplay. Only sync when user explicitly requests it.\r\n\r\n  // Check if Dice+ is available\r\n  checkDicePlusReady();\r\n\r\n  // Set up Dice+ result listeners\r\n  setupDicePlusListeners();\r\n});\r\n\r\n// ============== Dice+ Integration ==============\r\n\r\n/**\r\n * Check if Dice+ extension is ready\r\n */\r\nasync function checkDicePlusReady() {\r\n  if (!isOwlbearReady) return;\r\n\r\n  // Wait a bit for other extensions to load\r\n  await new Promise(resolve => setTimeout(resolve, 500));\r\n\r\n  try {\r\n    const requestId = `ready_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n    console.log('\uD83D\uDD0D Checking for Dice+ extension...');\r\n\r\n    let responseReceived = false;\r\n    let unsubscribed = false;\r\n\r\n    // DEBUG: Listen to ALL broadcast channels temporarily\r\n    const debugUnsubscribe = OBR.broadcast.onMessage('*', (event) => {\r\n      if (event.id.includes('dice-plus') || event.id.includes('dice+')) {\r\n        console.log('\uD83D\uDC1B DEBUG - Received broadcast on channel:', event.id, 'data:', event.data);\r\n      }\r\n    });\r\n\r\n    // Set up one-time listener for ready response BEFORE sending the request\r\n    const unsubscribe = OBR.broadcast.onMessage('dice-plus/isReady', (event) => {\r\n      console.log('\uD83D\uDCE8 Received dice-plus/isReady message:', event.data);\r\n\r\n      // Only process messages that match our requestId to avoid console spam\r\n      if (event.data.requestId === requestId) {\r\n        console.log('\u2705 RequestId matches:', requestId);\r\n\r\n        // Accept either explicit ready:true OR the echo (which proves broadcast works)\r\n        // If we get our own message back, it means OBR broadcast is working\r\n        // and Dice+ will receive it too (even if it doesn't respond)\r\n        if (event.data.ready || event.data.timestamp) {\r\n          responseReceived = true;\r\n          dicePlusReady = true;\r\n          console.log('\u2705 Dice+ broadcast received - 3D dice enabled!');\r\n        }\r\n\r\n        if (!unsubscribed) {\r\n          unsubscribed = true;\r\n          unsubscribe(); // Clean up listener\r\n        }\r\n      } else {\r\n        console.log('\u26A0\uFE0F RequestId mismatch. Expected:', requestId, 'Got:', event.data.requestId);\r\n      }\r\n    });\r\n\r\n    // Send ready check after listener is set up\r\n    console.log('\uD83D\uDCE1 Sending dice-plus/isReady broadcast with requestId:', requestId);\r\n    await OBR.broadcast.sendMessage('dice-plus/isReady', {\r\n      requestId,\r\n      timestamp: Date.now()\r\n    }, { destination: 'ALL' });\r\n    console.log('\u2705 Broadcast sent, waiting 3 seconds for response...');\r\n\r\n    // Wait for response with timeout\r\n    await new Promise(resolve => setTimeout(resolve, 3000));\r\n\r\n    // Clean up listener if not already unsubscribed\r\n    if (!unsubscribed) {\r\n      unsubscribed = true;\r\n      unsubscribe();\r\n    }\r\n\r\n    // Clean up debug listener\r\n    debugUnsubscribe();\r\n\r\n    if (!responseReceived) {\r\n      console.warn('\u26A0\uFE0F Dice+ not detected - 3D dice disabled, using built-in roller');\r\n      dicePlusReady = false;\r\n    }\r\n\r\n  } catch (error) {\r\n    console.warn('Failed to check Dice+ status:', error);\r\n    dicePlusReady = false;\r\n  }\r\n}\r\n\r\n/**\r\n * Set up listeners for Dice+ roll results\r\n */\r\nfunction setupDicePlusListeners() {\r\n  if (!isOwlbearReady) return;\r\n\r\n  // Listen for roll results\r\n  OBR.broadcast.onMessage(`${OWLCLOUD_EXTENSION_ID}/roll-result`, (event) => {\r\n    const { rollId, totalValue, rollSummary, groups } = event.data;\r\n\r\n    // Validate result structure before processing\r\n    if (!rollId || totalValue === undefined) {\r\n      console.warn('\uD83D\uDEAB Invalid roll result structure, ignoring:', event.data);\r\n      return;\r\n    }\r\n\r\n    // Find the pending roll\r\n    const pendingRoll = pendingRolls.get(rollId);\r\n    if (!pendingRoll) {\r\n      console.warn('Received result for unknown roll:', rollId);\r\n      return;\r\n    }\r\n\r\n    // Remove from pending\r\n    pendingRolls.delete(rollId);\r\n\r\n    // Process the result\r\n    handleDicePlusResult(pendingRoll, totalValue, rollSummary, groups);\r\n  });\r\n\r\n  // Listen for roll errors\r\n  OBR.broadcast.onMessage(`${OWLCLOUD_EXTENSION_ID}/roll-error`, (event) => {\r\n    const { rollId, error } = event.data;\r\n    console.error('Dice+ roll error:', error);\r\n\r\n    const pendingRoll = pendingRolls.get(rollId);\r\n    if (pendingRoll) {\r\n      pendingRolls.delete(rollId);\r\n      // Fall back to local roll\r\n      console.warn('Falling back to built-in dice roller');\r\n      executeLocalRoll(pendingRoll);\r\n    }\r\n  });\r\n\r\n  // ALSO listen on Dice+ channel for roll results\r\n  OBR.broadcast.onMessage('dice-plus/roll-result', (event) => {\r\n    console.log('\uD83D\uDCE8 Dice+ roll-result received:', event.data);\r\n    const { result } = event.data;\r\n    \r\n    // Validate result structure before processing\r\n    if (!result || !result.rollId || result.totalValue === undefined) {\r\n      console.warn('\uD83D\uDEAB Invalid Dice+ result structure, ignoring:', result);\r\n      return;\r\n    }\r\n    \r\n    const { rollId, totalValue, rollSummary, groups } = result;\r\n\r\n    // Find the pending roll\r\n    const pendingRoll = pendingRolls.get(rollId);\r\n    if (!pendingRoll) {\r\n      console.warn('Received result for unknown roll:', rollId);\r\n      return;\r\n    }\r\n\r\n    // Remove from pending\r\n    pendingRolls.delete(rollId);\r\n\r\n    // Process the result\r\n    handleDicePlusResult(pendingRoll, totalValue, rollSummary, groups);\r\n  });\r\n}\r\n\r\n/**\r\n * Simplify DiceCloud formula to standard dice notation for Dice+\r\n * Evaluates variables and expressions like (floor((~target.level+1)/6)+1)d8 \u2192 2d8\r\n */\r\nfunction simplifyDiceFormula(formula) {\r\n  if (!formula || !currentCharacter) return formula;\r\n\r\n  let simplified = formula;\r\n\r\n  // Replace ~target.level with actual character level\r\n  if (simplified.includes('~target.level')) {\r\n    const level = currentCharacter.level || 1;\r\n    simplified = simplified.replace(/~target\\.level/g, level.toString());\r\n  }\r\n\r\n  // Try to evaluate mathematical expressions before \"d\"\r\n  // Match patterns like (expression)d8 or expressiond8\r\n  const diceMatch = simplified.match(/^(.+?)d(\\d+)([+-]\\d+)?$/i);\r\n  if (diceMatch) {\r\n    const countExpression = diceMatch[1];\r\n    const sides = diceMatch[2];\r\n    const modifier = diceMatch[3] || '';\r\n\r\n    try {\r\n      // Safely evaluate the count expression\r\n      // Support floor, ceil, round, max, min functions\r\n      let safeExpression = countExpression\r\n        .replace(/floor\\(/g, 'Math.floor(')\r\n        .replace(/ceil\\(/g, 'Math.ceil(')\r\n        .replace(/round\\(/g, 'Math.round(')\r\n        .replace(/max\\(/g, 'Math.max(')\r\n        .replace(/min\\(/g, 'Math.min(');\r\n\r\n      // Only evaluate if it looks safe (numbers, operators, Math functions)\r\n      if (/^[\\d+\\-*/().,\\s\\w]+$/.test(safeExpression) && safeExpression.includes('Math.')) {\r\n        const count = Math.floor(eval(safeExpression));\r\n        if (count > 0 && count < 100) { // Sanity check\r\n          simplified = `${count}d${sides}${modifier}`;\r\n          console.log(`\uD83D\uDCD0 Simplified formula: ${formula} \u2192 ${simplified}`);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to simplify formula:', formula, error);\r\n      // Return original if evaluation fails\r\n    }\r\n  }\r\n\r\n  return simplified;\r\n}\r\n\r\n/**\r\n * Send a roll request to Dice+\r\n * @param {string} diceNotation - Standard dice notation (e.g., \"1d20+5\", \"2d20kh1+3\")\r\n * @param {object} rollContext - Context about the roll (name, modifier, etc.)\r\n * @returns {Promise<string>} - Roll ID\r\n */\r\nasync function sendToDicePlus(diceNotation, rollContext) {\r\n  // Simplify complex DiceCloud formulas before sending to Dice+\r\n  const simplifiedNotation = simplifyDiceFormula(diceNotation);\r\n\r\n  console.log('\uD83C\uDFB2 sendToDicePlus called:', {\r\n    original: diceNotation,\r\n    simplified: simplifiedNotation,\r\n    isOwlbearReady,\r\n    dicePlusReady\r\n  });\r\n\r\n  if (!isOwlbearReady || !dicePlusReady) {\r\n    // Fall back to local rolling\r\n    console.log('\u26A0\uFE0F Falling back to local roll - OBR ready:', isOwlbearReady, 'Dice+ ready:', dicePlusReady);\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    const rollId = `roll_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n    const playerId = await OBR.player.getId();\r\n    const playerName = await OBR.player.getName();\r\n\r\n    // Store pending roll\r\n    pendingRolls.set(rollId, rollContext);\r\n\r\n    console.log('\uD83D\uDCE1 Sending roll request to Dice+:', { rollId, diceNotation: simplifiedNotation });\r\n\r\n    // Send roll request to Dice+\r\n    await OBR.broadcast.sendMessage('dice-plus/roll-request', {\r\n      rollId,\r\n      playerId,\r\n      playerName,\r\n      rollTarget: 'everyone', // Show to all players\r\n      diceNotation: simplifiedNotation,\r\n      showResults: false, // Hide Dice+ popup (OwlCloud chat shows results instead)\r\n      timestamp: Date.now(),\r\n      source: OWLCLOUD_EXTENSION_ID\r\n    }, { destination: 'ALL' });\r\n\r\n    return rollId;\r\n\r\n  } catch (error) {\r\n    console.error('Failed to send to Dice+:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Handle result from Dice+\r\n */\r\nasync function handleDicePlusResult(rollContext, totalValue, rollSummary, groups) {\r\n  const { name, modifier, type, isDeathSave, isDamageRoll, actionName, damageFormula } = rollContext;\r\n\r\n  console.log('\uD83C\uDFB2 Dice+ result received:', {\r\n    totalValue,\r\n    totalValueType: typeof totalValue,\r\n    rollSummary,\r\n    modifier,\r\n    rollContext\r\n  });\r\n\r\n  // Ensure totalValue is a number (parse if needed)\r\n\r\n  // Ensure totalValue is a number\r\n  const numericTotal = typeof totalValue === 'number' ? totalValue : parseInt(totalValue) || 0;\r\n\r\n  console.log('\uD83C\uDFB2 After parsing:', { numericTotal, modifier, willSubtract: (modifier || 0) });\r\n\r\n  // Special handling for death saves\r\n  if (isDeathSave && currentCharacter) {\r\n    const roll = numericTotal;\r\n    let message = '';\r\n    let messageType = 'combat';\r\n\r\n    if (roll === 20) {\r\n      message = `\uD83D\uDC80 Death Save: <strong>20 (Natural 20!)</strong> - Regain 1 HP!`;\r\n      if (!currentCharacter.hitPoints) {\r\n        currentCharacter.hitPoints = { current: 0, max: 0 };\r\n      }\r\n      currentCharacter.hitPoints.current = 1;\r\n      populateStatsTab(currentCharacter);\r\n    } else if (roll === 1) {\r\n      message = `\uD83D\uDC80 Death Save: <strong>1 (Natural 1!)</strong> - Two failures!`;\r\n    } else if (roll >= 10) {\r\n      message = `\uD83D\uDC80 Death Save: <strong>${roll}</strong> - Success`;\r\n    } else {\r\n      message = `\uD83D\uDC80 Death Save: <strong>${roll}</strong> - Failure`;\r\n    }\r\n\r\n    if (isOwlbearReady) {\r\n      OBR.notification.show(`${currentCharacter.name}: Death Save = ${roll}`, roll >= 10 ? 'SUCCESS' : 'ERROR');\r\n    }\r\n    console.log('\uD83D\uDC80', message);\r\n    await addChatMessage(message, messageType, currentCharacter.name);\r\n    return;\r\n  }\r\n\r\n  // Special handling for damage rolls\r\n  if (isDamageRoll) {\r\n    const rolls = groups && groups[0] ? groups[0].dice.filter(d => d.kept).map(d => d.value) : [];\r\n    const message = `${actionName} Damage: <strong>${numericTotal}</strong>`;\r\n\r\n    let detailsHtml = `<strong>Formula:</strong> ${damageFormula}<br>\r\n                       <strong>Rolls:</strong> ${rolls.join(', ')}`;\r\n    if (modifier) {\r\n      detailsHtml += `<br>Modifier: ${modifier >= 0 ? '+' : ''}${modifier}`;\r\n    }\r\n    detailsHtml += `<br>Calculation: ${rolls.join(' + ')}`;\r\n    if (modifier) {\r\n      detailsHtml += ` ${modifier >= 0 ? '+' : ''}${modifier}`;\r\n    }\r\n    detailsHtml += ` = ${numericTotal}`;\r\n\r\n    if (isOwlbearReady) {\r\n      OBR.notification.show(`${currentCharacter?.name || 'Character'}: ${actionName} Damage = ${numericTotal}`, 'INFO');\r\n    }\r\n    console.log('\u2694\uFE0F', message);\r\n    await addChatMessage(message, 'combat', currentCharacter?.name, detailsHtml);\r\n    return;\r\n  }\r\n\r\n  // Create result object similar to local rolls\r\n  // Parse the rollSummary to extract the raw roll and use totalValue as final result\r\n  let rawRoll = numericTotal; // fallback\r\n  let finalTotal = numericTotal;\r\n  \r\n  if (rollSummary) {\r\n    // Extract raw roll from rollSummary format \"[7] 7 + 8 = 15\"\r\n    const rollMatch = rollSummary.match(/^\\[(\\d+)\\]/);\r\n    if (rollMatch) {\r\n      rawRoll = parseInt(rollMatch[1]);\r\n    }\r\n  }\r\n  \r\n  // Use totalValue as the final result since Dice+ already calculated it\r\n  finalTotal = numericTotal;\r\n  \r\n  console.log('\uD83D\uDD0D Dice+ calculation debug:', {\r\n    numericTotal,\r\n    modifier,\r\n    rollContext,\r\n    rollSummary,\r\n    parsedRawRoll: rawRoll,\r\n    finalTotal,\r\n    willCalculateFinal: finalTotal\r\n  });\r\n  \r\n  const result = {\r\n    total: rawRoll,\r\n    rolls: groups && groups[0] ? groups[0].dice.filter(d => d.kept).map(d => d.value) : [rawRoll],\r\n    modifier: modifier || 0,\r\n    formula: rollSummary,\r\n    mode: rollContext.mode || 'normal',\r\n    // Override the final calculation in showRollResult\r\n    _overrideFinal: finalTotal\r\n  };\r\n\r\n  // Show the result using existing UI\r\n  await showRollResult(name, result);\r\n}\r\n\r\n/**\r\n * Execute a local roll (fallback when Dice+ unavailable)\r\n */\r\nasync function executeLocalRoll(rollContext) {\r\n  const { name, modifier, type, mode } = rollContext;\r\n\r\n  let result;\r\n  if (type === 'd20') {\r\n    result = rollD20Local();\r\n  } else {\r\n    result = rollDiceLocal(rollContext.formula);\r\n  }\r\n\r\n  result.total += (modifier || 0);\r\n  result.modifier = modifier || 0;\r\n\r\n  await showRollResult(name, result);\r\n}\r\n\r\n// ============== Supabase Auth ==============\r\n\r\n/**\r\n * Initialize Supabase Auth client and check for existing session\r\n */\r\nasync function initializeSupabaseAuth() {\r\n  try {\r\n    // Initialize Supabase client (createSupabaseClient is loaded from popover.html)\r\n    supabase = window.createSupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY, {\r\n      auth: {\r\n        persistSession: true,\r\n        autoRefreshToken: true,\r\n        detectSessionInUrl: false\r\n      }\r\n    });\r\n\r\n    // Check for existing session\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n\r\n    if (session) {\r\n      currentUser = session.user;\r\n      console.log('\u2705 User already signed in:', currentUser.email);\r\n      updateAuthUI();\r\n\r\n      // Link any existing character to this user's account\r\n      await linkExistingCharacterToUser();\r\n    } else {\r\n      console.log('\u2139\uFE0F No active session');\r\n      updateAuthUI();\r\n    }\r\n\r\n    // Listen for auth state changes\r\n    supabase.auth.onAuthStateChange(async (event, session) => {\r\n      console.log('\uD83D\uDD10 Auth state changed:', event);\r\n      currentUser = session?.user || null;\r\n      updateAuthUI();\r\n\r\n      // When user signs in, link any existing character to their account\r\n      if (event === 'SIGNED_IN') {\r\n        await linkExistingCharacterToUser();\r\n      }\r\n\r\n      // Refresh character data when user signs in/out\r\n      if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {\r\n        checkForActiveCharacter();\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error('Failed to initialize Supabase Auth:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Sign in with email/password\r\n */\r\nasync function signIn(email, password) {\r\n  try {\r\n    const { data, error } = await supabase.auth.signInWithPassword({\r\n      email,\r\n      password\r\n    });\r\n\r\n    if (error) throw error;\r\n\r\n    console.log('\u2705 Signed in successfully');\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error('Sign in error:', error);\r\n    return { success: false, error: error.message };\r\n  }\r\n}\r\n\r\n/**\r\n * Sign up with email/password\r\n */\r\nasync function signUp(email, password) {\r\n  try {\r\n    const { data, error } = await supabase.auth.signUp({\r\n      email,\r\n      password\r\n    });\r\n\r\n    if (error) throw error;\r\n\r\n    console.log('\u2705 Signed up successfully');\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error('Sign up error:', error);\r\n    return { success: false, error: error.message };\r\n  }\r\n}\r\n\r\n/**\r\n * Sign out\r\n */\r\nasync function signOut() {\r\n  try {\r\n    const { error } = await supabase.auth.signOut();\r\n    if (error) throw error;\r\n\r\n    console.log('\u2705 Signed out successfully');\r\n\r\n    // Clear current user\r\n    currentUser = null;\r\n\r\n    // Update UI immediately\r\n    updateAuthUI();\r\n\r\n    // Check for character (will now query by owlbear_player_id only)\r\n    checkForActiveCharacter();\r\n\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error('Sign out error:', error);\r\n    return { success: false, error: error.message };\r\n  }\r\n}\r\n\r\n// Expose signOut to window for onclick handler\r\nwindow.signOut = signOut;\r\n\r\n/**\r\n * Link existing character (by owlbear_player_id) to the signed-in user's account\r\n * This handles the case where a user had a character before creating an account\r\n */\r\nasync function linkExistingCharacterToUser() {\r\n  if (!currentUser) return;\r\n\r\n  try {\r\n    const playerId = await OBR.player.getId();\r\n\r\n    console.log('\uD83D\uDD17 Checking for existing character to link...');\r\n    console.log('  - Current user ID:', currentUser.id);\r\n    console.log('  - Owlbear player ID:', playerId);\r\n\r\n    // Get auth headers with access token\r\n    const authHeaders = { ...SUPABASE_HEADERS };\r\n    if (supabase) {\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n      if (session?.access_token) {\r\n        authHeaders['Authorization'] = `Bearer ${session.access_token}`;\r\n      }\r\n    }\r\n\r\n    // First check if user already has a character linked by supabase_user_id\r\n    console.log('\uD83D\uDCE1 Checking if user already has a character...');\r\n    const userCharResponse = await fetch(\r\n      `${SUPABASE_URL}/functions/v1/characters?supabase_user_id=${encodeURIComponent(currentUser.id)}&fields=essential`,\r\n      { headers: authHeaders }\r\n    );\r\n\r\n    console.log('\uD83D\uDCE1 User character check response:', userCharResponse.status);\r\n    if (userCharResponse.ok) {\r\n      const userData = await userCharResponse.json();\r\n      console.log('\uD83D\uDCE6 User character data:', userData);\r\n      if (userData.success && (userData.character || (userData.characters && userData.characters.length > 0))) {\r\n        console.log('\u2705 User already has a linked character');\r\n        return; // User already has a character, no need to link\r\n      }\r\n    }\r\n\r\n    // No character found by supabase_user_id, check by owlbear_player_id to link existing character\r\n    console.log('\uD83D\uDD0D Checking for character by owlbear_player_id...');\r\n    const playerCharResponse = await fetch(\r\n      `${SUPABASE_URL}/functions/v1/characters?owlbear_player_id=${encodeURIComponent(playerId)}&fields=full`,\r\n      { headers: SUPABASE_HEADERS }\r\n    );\r\n\r\n    console.log('\uD83D\uDCE1 Player character check response:', playerCharResponse.status);\r\n    if (!playerCharResponse.ok) {\r\n      console.log('\u2139\uFE0F No existing character found to link');\r\n      return;\r\n    }\r\n\r\n    const playerData = await playerCharResponse.json();\r\n    console.log('\uD83D\uDCE6 Player character data:', playerData);\r\n\r\n    // Handle both single character and array responses\r\n    const charactersToLink = playerData.success && playerData.characters && playerData.characters.length > 0\r\n      ? playerData.characters\r\n      : (playerData.success && playerData.character ? [playerData.character] : []);\r\n\r\n    if (charactersToLink.length > 0) {\r\n      console.log(`\uD83D\uDD17 Linking ${charactersToLink.length} existing character(s) to user account...`);\r\n\r\n      // Link all characters\r\n      for (const char of charactersToLink) {\r\n        // Construct character object with required fields\r\n        const character = char.raw_dicecloud_data ? {\r\n          ...char.raw_dicecloud_data,\r\n          userId: char.user_id_dicecloud,\r\n          id: char.dicecloud_character_id,\r\n          name: char.character_name\r\n        } : {\r\n          userId: char.user_id_dicecloud,\r\n          id: char.dicecloud_character_id,\r\n          name: char.character_name,\r\n          class: char.class,\r\n          race: char.race,\r\n          level: char.level\r\n        };\r\n\r\n        const linkResponse = await fetch(\r\n          `${SUPABASE_URL}/functions/v1/characters`,\r\n          {\r\n            method: 'POST',\r\n            headers: authHeaders,\r\n            body: JSON.stringify({\r\n              owlbearPlayerId: playerId,\r\n              supabaseUserId: currentUser.id,\r\n              character: character\r\n            })\r\n          }\r\n        );\r\n\r\n        if (linkResponse.ok) {\r\n          const linkData = await linkResponse.json();\r\n          console.log(`\u2705 Character \"${char.character_name}\" successfully linked!`);\r\n        } else {\r\n          const errorText = await linkResponse.text();\r\n          console.error(`\u274C Failed to link character \"${char.character_name}\":`, errorText);\r\n        }\r\n      }\r\n\r\n      // After linking all characters, show notification and refresh\r\n      if (isOwlbearReady) {\r\n        OBR.notification.show(`${charactersToLink.length} character(s) linked to your account!`, 'SUCCESS');\r\n      }\r\n\r\n      // Refresh character data\r\n      await checkForActiveCharacter();\r\n\r\n      // Update auth UI to show unsync button\r\n      updateAuthUI();\r\n    }\r\n  } catch (error) {\r\n    console.error('Error linking character to user:', error);\r\n    if (isOwlbearReady) {\r\n      OBR.notification.show('Error linking character: ' + (error.message || 'Unknown error'), 'ERROR');\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Update auth UI based on current user state\r\n */\r\nfunction updateAuthUI() {\r\n  const authSection = document.getElementById('auth-section');\r\n  if (!authSection) return;\r\n\r\n  if (currentUser) {\r\n    // User is signed in\r\n    authSection.innerHTML = `\r\n      <div style=\"padding: 16px; background: var(--theme-background); border-radius: 8px; border: 1px solid var(--theme-border);\">\r\n        <div style=\"margin-bottom: 12px;\">\r\n          <div style=\"font-size: 12px; color: var(--theme-primary-light); margin-bottom: 4px;\">Signed in as</div>\r\n          <div style=\"font-weight: 600; color: #e0e0e0;\">${currentUser.email}</div>\r\n        </div>\r\n        <div style=\"display: flex; flex-direction: column; gap: 8px;\">\r\n          <button\r\n            onclick=\"handleFetchCharacter()\"\r\n            id=\"fetch-character-btn\"\r\n            style=\"width: 100%; padding: 8px; background: var(--theme-gradient); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s;\">\r\n            \uD83D\uDD04 Fetch Character\r\n          </button>\r\n          <button\r\n            onclick=\"signOut()\"\r\n            style=\"width: 100%; padding: 8px; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; border-radius: 6px; color: #EF4444; font-weight: 600; cursor: pointer; transition: all 0.2s;\">\r\n            Sign Out\r\n          </button>\r\n        </div>\r\n        <div id=\"fetch-status\" style=\"margin-top: 8px; font-size: 12px; display: none;\"></div>\r\n      </div>\r\n    `;\r\n  } else {\r\n    // User is not signed in\r\n    authSection.innerHTML = `\r\n      <div style=\"padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);\">\r\n        <div style=\"font-weight: 600; color: var(--theme-primary-light); font-size: 14px; margin-bottom: 8px;\">\r\n          \uD83D\uDD10 Cross-Device Character Sync\r\n        </div>\r\n        <div style=\"margin-bottom: 12px; color: #c0c0c0; font-size: 12px; line-height: 1.4;\">\r\n          Create a free account to access your characters from any device. This is separate from your DiceCloud login.\r\n        </div>\r\n        <form id=\"auth-form\" onsubmit=\"event.preventDefault(); handleSignIn(); return false;\" style=\"display: flex; flex-direction: column; gap: 8px;\">\r\n          <input\r\n            type=\"email\"\r\n            id=\"auth-email\"\r\n            placeholder=\"Email\"\r\n            required\r\n            autocomplete=\"email\"\r\n            style=\"padding: 8px 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--theme-border); border-radius: 6px; color: #e0e0e0; font-size: 14px;\">\r\n          <div style=\"position: relative;\">\r\n            <input\r\n              type=\"password\"\r\n              id=\"auth-password\"\r\n              placeholder=\"Password (min 6 characters)\"\r\n              required\r\n              autocomplete=\"current-password\"\r\n              style=\"padding: 8px 12px; padding-right: 40px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--theme-border); border-radius: 6px; color: #e0e0e0; font-size: 14px; width: 100%;\">\r\n            <button\r\n              type=\"button\"\r\n              onclick=\"togglePasswordVisibility('auth-password', 'toggle-password-btn')\"\r\n              id=\"toggle-password-btn\"\r\n              aria-label=\"Toggle password visibility\"\r\n              style=\"position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #888; cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px;\">\r\n              <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n                <path d=\"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z\"></path>\r\n                <circle cx=\"12\" cy=\"12\" r=\"3\"></circle>\r\n              </svg>\r\n            </button>\r\n          </div>\r\n          <div style=\"display: flex; gap: 8px;\">\r\n            <button\r\n              type=\"submit\"\r\n              style=\"flex: 1; padding: 8px; background: var(--theme-gradient); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s;\">\r\n              Sign In\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onclick=\"handleSignUp()\"\r\n              style=\"flex: 1; padding: 8px; background: var(--theme-background); border: 1px solid var(--theme-primary); border-radius: 6px; color: var(--theme-primary-light); font-weight: 600; cursor: pointer; transition: all 0.2s;\">\r\n              Sign Up\r\n            </button>\r\n          </div>\r\n          <div style=\"color: #888; font-size: 11px; margin-top: 4px; text-align: center;\">\r\n            New? Click <strong>Sign Up</strong> to create an account\r\n          </div>\r\n          <div id=\"auth-error\" style=\"color: #EF4444; font-size: 12px; margin-top: 4px; display: none;\"></div>\r\n          <div id=\"auth-success\" style=\"color: #10B981; font-size: 12px; margin-top: 4px; padding: 8px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 4px; display: none; transition: opacity 0.3s ease-out;\"></div>\r\n        </form>\r\n      </div>\r\n    `;\r\n  }\r\n}\r\n\r\n/**\r\n * Format Supabase auth errors to be more user-friendly\r\n */\r\nfunction formatAuthError(error) {\r\n  const message = error?.message || '';\r\n\r\n  if (message.includes('Invalid login credentials')) {\r\n    return 'Incorrect email or password. Please try again.';\r\n  }\r\n  if (message.includes('Email not confirmed')) {\r\n    return 'Please check your email and click the confirmation link before signing in.';\r\n  }\r\n  if (message.includes('User already registered')) {\r\n    return 'An account with this email already exists. Try signing in instead.';\r\n  }\r\n  if (message.includes('Password should be at least 6 characters')) {\r\n    return 'Password must be at least 6 characters long.';\r\n  }\r\n  if (message.includes('invalid format') || message.includes('Unable to validate email')) {\r\n    return 'Please enter a valid email address.';\r\n  }\r\n  if (message.includes('rate limit') || message.includes('Email rate limit exceeded')) {\r\n    return 'Too many attempts. Please wait a few minutes and try again.';\r\n  }\r\n  if (message.includes('Signup requires email')) {\r\n    return 'Please enter your email address.';\r\n  }\r\n  if (message.includes('network') || message.includes('fetch')) {\r\n    return 'Network error. Please check your connection and try again.';\r\n  }\r\n\r\n  // Fallback to generic message\r\n  return 'Authentication failed. Please try again.';\r\n}\r\n\r\n/**\r\n * Show success message that fades out after 2 seconds\r\n */\r\nfunction showAuthSuccess(message) {\r\n  const successDiv = document.getElementById('auth-success');\r\n  const errorDiv = document.getElementById('auth-error');\r\n\r\n  if (!successDiv) return;\r\n\r\n  // Hide error message\r\n  if (errorDiv) errorDiv.style.display = 'none';\r\n\r\n  // Show success message\r\n  successDiv.textContent = message;\r\n  successDiv.style.display = 'block';\r\n  successDiv.style.opacity = '1';\r\n\r\n  // Fade out after 2 seconds\r\n  setTimeout(() => {\r\n    successDiv.style.opacity = '0';\r\n    setTimeout(() => {\r\n      successDiv.style.display = 'none';\r\n    }, 300); // Wait for fade animation to complete\r\n  }, 2000);\r\n}\r\n\r\n/**\r\n * Toggle password visibility\r\n */\r\nwindow.togglePasswordVisibility = function(passwordFieldId, toggleButtonId) {\r\n  const passwordField = document.getElementById(passwordFieldId);\r\n  const toggleButton = document.getElementById(toggleButtonId);\r\n\r\n  if (!passwordField || !toggleButton) return;\r\n\r\n  const eyeIcon = '<svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z\"></path><circle cx=\"12\" cy=\"12\" r=\"3\"></circle></svg>';\r\n  const eyeSlashIcon = '<svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24\"></path><line x1=\"1\" y1=\"1\" x2=\"23\" y2=\"23\"></line></svg>';\r\n\r\n  if (passwordField.type === 'password') {\r\n    passwordField.type = 'text';\r\n    toggleButton.innerHTML = eyeSlashIcon;\r\n    toggleButton.setAttribute('aria-label', 'Hide password');\r\n  } else {\r\n    passwordField.type = 'password';\r\n    toggleButton.innerHTML = eyeIcon;\r\n    toggleButton.setAttribute('aria-label', 'Show password');\r\n  }\r\n};\r\n\r\n/**\r\n * Handle sign in button click\r\n */\r\nwindow.handleSignIn = async function() {\r\n  const email = document.getElementById('auth-email').value.trim();\r\n  const password = document.getElementById('auth-password').value;\r\n  const errorDiv = document.getElementById('auth-error');\r\n  const signInBtn = document.querySelector('#auth-form button[type=\"submit\"]');\r\n\r\n  if (!email || !password) {\r\n    errorDiv.textContent = 'Please enter email and password';\r\n    errorDiv.style.display = 'block';\r\n    return;\r\n  }\r\n\r\n  // Disable button and show loading state\r\n  if (signInBtn) {\r\n    signInBtn.disabled = true;\r\n    signInBtn.textContent = 'Signing in...';\r\n  }\r\n\r\n  const result = await signIn(email, password);\r\n\r\n  // Re-enable button\r\n  if (signInBtn) {\r\n    signInBtn.disabled = false;\r\n    signInBtn.textContent = 'Sign In';\r\n  }\r\n\r\n  if (!result.success) {\r\n    errorDiv.textContent = formatAuthError(result);\r\n    errorDiv.style.display = 'block';\r\n  } else {\r\n    errorDiv.style.display = 'none';\r\n    showAuthSuccess('\u2705 Signed in successfully!');\r\n  }\r\n};\r\n\r\n/**\r\n * Handle sign up button click\r\n */\r\nwindow.handleSignUp = async function() {\r\n  const email = document.getElementById('auth-email').value.trim();\r\n  const password = document.getElementById('auth-password').value;\r\n  const errorDiv = document.getElementById('auth-error');\r\n  const signUpBtn = document.querySelector('button[onclick=\"handleSignUp()\"]');\r\n\r\n  // Reset error styling\r\n  errorDiv.style.color = '#EF4444';\r\n\r\n  if (!email || !password) {\r\n    errorDiv.textContent = 'Please enter email and password';\r\n    errorDiv.style.display = 'block';\r\n    return;\r\n  }\r\n\r\n  // Validate email format\r\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n  if (!emailRegex.test(email)) {\r\n    errorDiv.textContent = 'Please enter a valid email address';\r\n    errorDiv.style.display = 'block';\r\n    return;\r\n  }\r\n\r\n  if (password.length < 6) {\r\n    errorDiv.textContent = 'Password must be at least 6 characters long';\r\n    errorDiv.style.display = 'block';\r\n    return;\r\n  }\r\n\r\n  // Disable button and show loading state\r\n  if (signUpBtn) {\r\n    signUpBtn.disabled = true;\r\n    signUpBtn.textContent = 'Creating account...';\r\n  }\r\n\r\n  const result = await signUp(email, password);\r\n\r\n  // Re-enable button\r\n  if (signUpBtn) {\r\n    signUpBtn.disabled = false;\r\n    signUpBtn.textContent = 'Sign Up';\r\n  }\r\n\r\n  if (!result.success) {\r\n    errorDiv.textContent = formatAuthError(result);\r\n    errorDiv.style.display = 'block';\r\n  } else {\r\n    errorDiv.style.display = 'none';\r\n    showAuthSuccess('\u2705 Account created successfully!');\r\n  }\r\n};\r\n\r\n/**\r\n * Handle fetch character button click\r\n */\r\nwindow.handleFetchCharacter = async function() {\r\n  const fetchBtn = document.getElementById('fetch-character-btn');\r\n  const statusDiv = document.getElementById('fetch-status');\r\n\r\n  if (!fetchBtn || !statusDiv) return;\r\n\r\n  // Clear manual unsync flag to allow syncing again\r\n  localStorage.removeItem('owlcloud_manual_unsync');\r\n\r\n  // Show loading state\r\n  fetchBtn.disabled = true;\r\n  fetchBtn.textContent = '\u23F3 Fetching...';\r\n  statusDiv.style.display = 'block';\r\n  statusDiv.style.color = 'var(--theme-primary-light)';\r\n  statusDiv.textContent = 'Loading character...';\r\n\r\n  try {\r\n    await checkForActiveCharacter();\r\n\r\n    // Success\r\n    statusDiv.style.color = '#10B981';\r\n    statusDiv.textContent = '\u2713 Character loaded successfully!';\r\n\r\n    // Hide status after 3 seconds\r\n    setTimeout(() => {\r\n      statusDiv.style.display = 'none';\r\n    }, 3000);\r\n  } catch (error) {\r\n    console.error('Fetch character error:', error);\r\n    statusDiv.style.color = '#EF4444';\r\n    statusDiv.textContent = `\u2717 Error: ${error.message || 'Failed to fetch character'}`;\r\n  } finally {\r\n    // Reset button state\r\n    fetchBtn.disabled = false;\r\n    fetchBtn.textContent = '\uD83D\uDD04 Fetch Character';\r\n  }\r\n};\r\n\r\n/**\r\n * Handle unsync character button click\r\n * Clears the Owlbear sync for the current character, allowing a new character to be synced\r\n */\r\nwindow.handleUnsyncCharacter = async function() {\r\n  const unsyncBtn = document.getElementById('unsync-character-btn');\r\n  const statusDiv = document.getElementById('status-text'); // Use the existing status-text element\r\n\r\n  if (!unsyncBtn) {\r\n    console.error('Unsync button not found');\r\n    return;\r\n  }\r\n\r\n  if (!statusDiv) {\r\n    console.error('Status div not found');\r\n    return;\r\n  }\r\n\r\n  // Check if there's a character to unsync (either in memory or in localStorage)\r\n  const playerId = await OBR.player.getId();\r\n  const cacheKey = currentUser\r\n    ? `owlcloud_char_${currentUser.id}`\r\n    : `owlcloud_char_${playerId}`;\r\n  const cachedData = localStorage.getItem(cacheKey);\r\n\r\n  if (!currentCharacter && !cachedData) {\r\n    console.warn('No character to unsync');\r\n    statusDiv.style.display = 'block';\r\n    statusDiv.style.color = '#EF4444';\r\n    statusDiv.textContent = 'No character data to unsync';\r\n    setTimeout(() => {\r\n      statusDiv.style.display = 'none';\r\n    }, 3000);\r\n    return;\r\n  }\r\n\r\n  // Get character name for confirmation dialog\r\n  const characterName = currentCharacter?.name || 'this character';\r\n\r\n  // Confirm with user\r\n  if (!confirm(`Unsync ${characterName} from this Owlbear session?\\n\\nThis will disconnect the character from this room. You can sync a different character afterwards.`)) {\r\n    return;\r\n  }\r\n\r\n  // Show loading state\r\n  unsyncBtn.disabled = true;\r\n  unsyncBtn.textContent = '\u23F3 Unsyncing...';\r\n  statusDiv.style.display = 'block';\r\n  statusDiv.style.color = '#FB923C';\r\n  statusDiv.textContent = 'Unsyncing character...';\r\n\r\n  try {\r\n    let cloudUnsyncSuccess = false;\r\n\r\n    // Try to unsync from cloud if authenticated\r\n    if (currentUser && SUPABASE_HEADERS) {\r\n      try {\r\n        // Call Supabase function to clear the owlbear_player_id\r\n        const response = await fetch(\r\n          `${SUPABASE_URL}/functions/v1/unsync-character`,\r\n          {\r\n            method: 'POST',\r\n            headers: SUPABASE_HEADERS,\r\n            body: JSON.stringify({\r\n              owlbearPlayerId: playerId,\r\n              supabaseUserId: currentUser.id\r\n            })\r\n          }\r\n        );\r\n\r\n        if (response.ok) {\r\n          const result = await response.json();\r\n          cloudUnsyncSuccess = result.success;\r\n          console.log('\u2705 Character unsynced from cloud');\r\n        } else {\r\n          console.warn('\u26A0\uFE0F Failed to unsync from cloud, continuing with local unsync');\r\n        }\r\n      } catch (cloudError) {\r\n        console.warn('\u26A0\uFE0F Cloud unsync failed, continuing with local unsync:', cloudError);\r\n      }\r\n    } else {\r\n      console.log('\u2139\uFE0F Not authenticated, skipping cloud unsync');\r\n    }\r\n\r\n    // Always clear local cache regardless of cloud unsync result\r\n    const versionKey = `${cacheKey}_version`;\r\n    localStorage.removeItem(cacheKey);\r\n    localStorage.removeItem(versionKey);\r\n\r\n    // Set flag to prevent automatic re-syncing until manual sync\r\n    localStorage.setItem('owlcloud_manual_unsync', 'true');\r\n\r\n    // Clear current character state\r\n    currentCharacter = null;\r\n    allCharacters = [];\r\n\r\n    // Show success with appropriate message\r\n    statusDiv.style.color = '#10B981';\r\n    if (cloudUnsyncSuccess) {\r\n      statusDiv.textContent = '\u2713 Character unsynced! You can now sync a different character.';\r\n    } else if (currentUser) {\r\n      statusDiv.textContent = '\u2713 Character disconnected locally (cloud unsync unavailable)';\r\n    } else {\r\n      statusDiv.textContent = '\u2713 Character disconnected locally';\r\n    }\r\n\r\n    // Show notification\r\n    if (isOwlbearReady) {\r\n      OBR.notification.show(cloudUnsyncSuccess ? 'Character unsynced from Owlbear session' : 'Character disconnected locally', 'SUCCESS');\r\n    }\r\n\r\n    // Update UI to show no character\r\n    showNoCharacter();\r\n\r\n    // Hide status after 5 seconds\r\n    setTimeout(() => {\r\n      statusDiv.style.display = 'none';\r\n    }, 5000);\r\n  } catch (error) {\r\n    console.error('Unsync error:', error);\r\n    statusDiv.style.color = '#EF4444';\r\n    statusDiv.textContent = `\u2717 Error: ${error.message || 'Failed to unsync character'}`;\r\n\r\n    if (isOwlbearReady) {\r\n      OBR.notification.show(`Error unsyncing character: ${error.message}`, 'ERROR');\r\n    }\r\n\r\n    // Re-enable button\r\n    unsyncBtn.disabled = false;\r\n    unsyncBtn.textContent = '\uD83D\uDD13 Unsync from Owlbear';\r\n  }\r\n};\r\n\r\n// ============== Character Management ==============\r\n\r\n/**\r\n * Check if there's an active character from Supabase using Owlbear player ID\r\n */\r\nasync function checkForActiveCharacter() {\r\n  try {\r\n    // Get current player's Owlbear ID\r\n    const playerId = await OBR.player.getId();\r\n\r\n    // Determine query parameter based on auth status\r\n    let queryParam;\r\n    let cacheKey;\r\n\r\n    if (currentUser) {\r\n      // User is authenticated - query by supabase_user_id for cross-device sync\r\n      queryParam = `supabase_user_id=${encodeURIComponent(currentUser.id)}`;\r\n      cacheKey = `owlcloud_char_${currentUser.id}`;\r\n      console.log('\uD83C\uDFAD Checking for character with user ID:', currentUser.id);\r\n    } else {\r\n      // User not authenticated - query by owlbear_player_id (local to this OBR session)\r\n      queryParam = `owlbear_player_id=${encodeURIComponent(playerId)}`;\r\n      cacheKey = `owlcloud_char_${playerId}`;\r\n      console.log('\uD83C\uDFAD Checking for character with player ID:', playerId);\r\n    }\r\n\r\n    // Check localStorage cache first\r\n    const versionKey = `${cacheKey}_version`;\r\n    const cachedChar = localStorage.getItem(cacheKey);\r\n    const cachedVersion = localStorage.getItem(versionKey);\r\n\r\n    // Display cached data immediately for better UX\r\n    if (cachedChar) {\r\n      try {\r\n        displayCharacter(JSON.parse(cachedChar));\r\n      } catch (e) {\r\n        console.warn('Failed to parse cached character:', e);\r\n      }\r\n    }\r\n\r\n    // Prepare headers for conditional fetch\r\n    const headers = { ...SUPABASE_HEADERS };\r\n    if (cachedVersion) {\r\n      headers['If-None-Match'] = cachedVersion;\r\n    }\r\n\r\n    // Add Authorization header if user is authenticated\r\n    if (currentUser && supabase) {\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n      if (session?.access_token) {\r\n        headers['Authorization'] = `Bearer ${session.access_token}`;\r\n      }\r\n    }\r\n\r\n    // Call unified characters edge function with conditional request\r\n    const fetchUrl = `${SUPABASE_URL}/functions/v1/characters?${queryParam}&fields=full`;\r\n    console.log('\uD83C\uDF10 Fetching character from:', fetchUrl);\r\n    console.log('\uD83D\uDD11 Headers:', headers);\r\n\r\n    const response = await fetch(fetchUrl, { headers });\r\n\r\n    console.log('\uD83D\uDCE1 Response received:', response.status, response.statusText);\r\n\r\n    // Handle 304 Not Modified - character hasn't changed\r\n    if (response.status === 304) {\r\n      console.log('\u2705 Character unchanged, using cache');\r\n      if (cachedChar) {\r\n        await fetchAllCharacters(); // Still check for other characters\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (!response.ok) {\r\n      console.error('Failed to get character:', response.statusText);\r\n      if (!cachedChar) {\r\n        showNoCharacter();\r\n      }\r\n      return;\r\n    }\r\n\r\n    const data = await response.json();\r\n    const etag = response.headers.get('etag');\r\n\r\n    console.log('\uD83D\uDCE6 Response data:', data);\r\n\r\n    // Handle both single character and array responses\r\n    let character = null;\r\n    if (data.success && data.characters && data.characters.length > 0) {\r\n      // Array response - take the first character\r\n      character = data.characters[0];\r\n      console.log('\uD83D\uDCE6 Character data received from array (taking first):', character);\r\n    } else if (data.success && data.character) {\r\n      // Single character response\r\n      character = data.character;\r\n      console.log('\uD83D\uDCE6 Character data received:', character);\r\n    }\r\n\r\n    if (character) {\r\n      console.log('  - Has raw_dicecloud_data:', !!character.raw_dicecloud_data);\r\n      console.log('  - Has character_name:', !!character.character_name);\r\n\r\n      // Parse raw_dicecloud_data if available\r\n      let characterData;\r\n      if (character.raw_dicecloud_data) {\r\n        const rawData = character.raw_dicecloud_data;\r\n\r\n        // Check if this is the raw API format (creatures array) or extracted format (creature object)\r\n        if (rawData.creatures && rawData.creatureVariables && rawData.creatureProperties) {\r\n          // This is the raw API response - parse it\r\n          console.log('\uD83D\uDD04 Parsing raw API response...');\r\n          try {\r\n            characterData = parseCharacterData(rawData, character.dicecloud_character_id);\r\n            console.log('\u2705 Parsed character data:', characterData);\r\n          } catch (parseError) {\r\n            console.error('\u274C Failed to parse character data:', parseError);\r\n            characterData = rawData;\r\n          }\r\n        } else if (rawData.creature && rawData.variables && rawData.properties) {\r\n          // This is already extracted by CarmaClouds - use parseForRollCloud\r\n          console.log('\u2705 Using pre-extracted character data');\r\n          console.log('\uD83D\uDD0D Creature object keys:', Object.keys(rawData.creature));\r\n          console.log('\uD83D\uDD0D Creature picture fields:', {\r\n            picture: rawData.creature.picture,\r\n            avatarPicture: rawData.creature.avatarPicture,\r\n            avatar: rawData.creature.avatar,\r\n            image: rawData.creature.image,\r\n            pictureUrl: rawData.creature.pictureUrl\r\n          });\r\n\r\n          // Extract portrait before parsing (it gets lost in flattening)\r\n          const portraitUrl = rawData.creature.picture || rawData.creature.avatarPicture || rawData.creature.avatar || rawData.creature.image;\r\n\r\n          // Log property types for debugging features\r\n          const propertyTypes = new Set(rawData.properties.map(p => p.type));\r\n          console.log('\uD83D\uDD0D Property types in character data:', Array.from(propertyTypes).sort());\r\n\r\n          // Parse it with the comprehensive Roll20 parser (works for OBR too)\r\n          try {\r\n            characterData = window.parseForRollCloud ? window.parseForRollCloud(rawData) : parseForRollCloud(rawData);\r\n\r\n            // Add portrait back to parsed data\r\n            if (portraitUrl) {\r\n              characterData.picture = portraitUrl;\r\n            }\r\n\r\n            console.log('\u2705 Parsed extracted data:', characterData);\r\n            console.log('\uD83D\uDD0D Features count:', characterData.features?.length || 0);\r\n          } catch (parseError) {\r\n            console.error('\u274C Failed to parse extracted data:', parseError);\r\n            // Fallback to basic flattening\r\n            const vars = rawData.variables;\r\n            characterData = {\r\n              ...rawData,\r\n              name: rawData.creature.name || character.character_name,\r\n              race: rawData.creature.race || character.race,\r\n              class: rawData.creature.class || character.class,\r\n              level: rawData.creature.level || character.level,\r\n              picture: portraitUrl\r\n            };\r\n          }\r\n        } else {\r\n          // Unknown format - try to use as-is\r\n          console.warn('\u26A0\uFE0F Unknown data format, using as-is');\r\n          characterData = rawData;\r\n        }\r\n      } else {\r\n        // No raw data, use the database fields directly\r\n        characterData = character;\r\n      }\r\n\r\n      console.log('\u2705 Final character data for display:', characterData);\r\n\r\n      // Update cache\r\n      localStorage.setItem(cacheKey, JSON.stringify(characterData));\r\n      if (etag) {\r\n        localStorage.setItem(versionKey, etag);\r\n      }\r\n\r\n      displayCharacter(characterData);\r\n      await fetchAllCharacters();\r\n\r\n      // Update auth UI to show unsync button if user is signed in\r\n      updateAuthUI();\r\n    } else {\r\n      // Clear cache if no character found\r\n      localStorage.removeItem(cacheKey);\r\n      localStorage.removeItem(versionKey);\r\n      showNoCharacter();\r\n\r\n      // Still fetch all characters to show the character list\r\n      // This handles cases where multiple characters exist but no single \"active\" one\r\n      await fetchAllCharacters();\r\n    }\r\n  } catch (error) {\r\n    console.error('\u274C Error checking for active character:', error);\r\n    console.error('Error details:', {\r\n      message: error.message,\r\n      stack: error.stack,\r\n      name: error.name\r\n    });\r\n    showNoCharacter();\r\n  }\r\n}\r\n\r\n/**\r\n * Fetch all available characters for the current player\r\n */\r\nasync function fetchAllCharacters() {\r\n  try {\r\n    const playerId = await OBR.player.getId();\r\n\r\n    // Build query parameters - prefer user ID if authenticated for cross-device sync\r\n    let queryParams = 'fields=list';\r\n    if (currentUser) {\r\n      // If authenticated, fetch by Supabase user ID to get all synced characters\r\n      queryParams += `&supabase_user_id=${encodeURIComponent(currentUser.id)}`;\r\n    } else {\r\n      // Fall back to Owlbear player ID if not authenticated\r\n      queryParams += `&owlbear_player_id=${encodeURIComponent(playerId)}`;\r\n    }\r\n\r\n    console.log('\uD83D\uDD0D Fetching all characters with query:', queryParams);\r\n\r\n    const response = await fetch(\r\n      `${SUPABASE_URL}/functions/v1/characters?${queryParams}`,\r\n      { headers: SUPABASE_HEADERS }\r\n    );\r\n\r\n    if (!response.ok) {\r\n      console.error('Failed to get characters:', response.statusText);\r\n      return;\r\n    }\r\n\r\n    const data = await response.json();\r\n    console.log('\uD83D\uDCCB Received characters response:', data);\r\n    console.log('\uD83D\uDCCB Number of characters:', data.characters?.length || 0);\r\n    if (data.characters && data.characters.length > 0) {\r\n      console.log('\uD83D\uDCCB Character names:', data.characters.map(c => c.name || c.character_name).join(', '));\r\n    }\r\n\r\n    if (data.success && data.characters && data.characters.length > 0) {\r\n      allCharacters = data.characters;\r\n      console.log('\uD83D\uDCCB Set allCharacters array with', allCharacters.length, 'characters');\r\n      displayCharacterList();\r\n    } else {\r\n      console.log('\u2139\uFE0F No characters found, hiding character list');\r\n      allCharacters = [];\r\n      const characterListSection = document.getElementById('character-list-section');\r\n      if (characterListSection) {\r\n        characterListSection.style.display = 'none';\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error('Error fetching all characters:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Display the character list in the Settings tab\r\n */\r\nfunction displayCharacterList() {\r\n  const characterListSection = document.getElementById('character-list-section');\r\n  const characterList = document.getElementById('character-list');\r\n\r\n  if (!characterListSection || !characterList) {\r\n    console.error('Character list elements not found');\r\n    return;\r\n  }\r\n\r\n  if (!allCharacters || allCharacters.length === 0) {\r\n    // Hide character list if there are no characters\r\n    console.log('Hiding character list - no characters found');\r\n    characterListSection.style.display = 'none';\r\n    return;\r\n  }\r\n\r\n  // Show character list (even if only 1 character)\r\n  console.log('Showing character list with', allCharacters.length, 'character(s)');\r\n  characterListSection.style.display = 'block';\r\n\r\n  let html = '';\r\n  allCharacters.forEach((character) => {\r\n    const isActive = currentCharacter && character.id === currentCharacter.id;\r\n    // Try multiple possible name fields\r\n    const characterName = character.name || character.character_name || character.creature?.name || 'Unknown Character';\r\n    html += `\r\n      <div class=\"character-list-item ${isActive ? 'active' : ''}\" onclick=\"switchToCharacter('${character.id}')\">\r\n        <div class=\"character-list-item-name\">${characterName}</div>\r\n        <div class=\"character-list-item-details\">\r\n          Level ${character.level || '?'} ${character.race || ''} ${character.class || ''}\r\n          ${isActive ? '\u2022 Active' : ''}\r\n        </div>\r\n      </div>\r\n    `;\r\n  });\r\n\r\n  characterList.innerHTML = html;\r\n}\r\n\r\n/**\r\n * Switch to a different character\r\n */\r\nwindow.switchToCharacter = async function(characterId) {\r\n  try {\r\n    // Find the character in the list\r\n    const character = allCharacters.find(c => c.id === characterId);\r\n    if (!character) {\r\n      console.error('Character not found:', characterId);\r\n      return;\r\n    }\r\n\r\n    // Update active character using unified characters edge function\r\n    const playerId = await OBR.player.getId();\r\n    const requestBody = {\r\n      owlbearPlayerId: playerId,\r\n      character: character\r\n    };\r\n\r\n    // Include supabase_user_id if authenticated for cross-device sync\r\n    if (currentUser) {\r\n      requestBody.supabaseUserId = currentUser.id;\r\n    }\r\n\r\n    const response = await fetch(\r\n      `${SUPABASE_URL}/functions/v1/characters`,\r\n      {\r\n        method: 'POST',\r\n        headers: SUPABASE_HEADERS,\r\n        body: JSON.stringify(requestBody)\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n\r\n    if (response.ok && result.success) {\r\n      // Display the new character\r\n      displayCharacter(character);\r\n      displayCharacterList(); // Refresh the list to update active state\r\n      updateAuthUI(); // Update auth UI to show unsync button\r\n\r\n      if (isOwlbearReady) {\r\n        OBR.notification.show(`Switched to ${character.name}`, 'SUCCESS');\r\n      }\r\n    } else {\r\n      console.error('Failed to switch character:', result.error);\r\n      if (isOwlbearReady) {\r\n        OBR.notification.show('Failed to switch character', 'ERROR');\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error('Error switching character:', error);\r\n    if (isOwlbearReady) {\r\n      OBR.notification.show('Error switching character', 'ERROR');\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Display character information\r\n */\r\nfunction displayCharacter(character) {\r\n  // TODO: Save previous character's local state (HP, spell slots, etc.) before switching\r\n  // so that it persists when switching back. Could use a Map keyed by character ID\r\n  // or store in room metadata per character.\r\n\r\n  // Restore concentration state for this character\r\n  const characterId = character._id || character.id || character.name;\r\n  concentratingSpell = concentrationByCharacter.get(characterId) || null;\r\n\r\n  currentCharacter = character;\r\n\r\n  // Update UI\r\n  characterSection.style.display = 'block';\r\n  noCharacterSection.style.display = 'none';\r\n\r\n  // Show unsync button when character is loaded\r\n  const unsyncBtn = document.getElementById('unsync-character-btn');\r\n  if (unsyncBtn) {\r\n    unsyncBtn.style.display = 'block';\r\n  }\r\n\r\n  // Get portrait URL for use in multiple places\r\n  // Portrait data can be at top level or inside creature object\r\n  console.log('\uD83D\uDDBC\uFE0F Checking for portrait in character data:');\r\n  console.log('  character.picture:', character.picture);\r\n  console.log('  character.avatarPicture:', character.avatarPicture);\r\n  console.log('  character.creature?.picture:', character.creature?.picture);\r\n  console.log('  character.creature?.avatarPicture:', character.creature?.avatarPicture);\r\n\r\n  // Try top-level fields first, then check inside creature object\r\n  const portraitUrl = character.picture ||\r\n                      character.avatarPicture ||\r\n                      character.creature?.picture ||\r\n                      character.creature?.avatarPicture;\r\n\r\n  // Populate character info in Settings tab\r\n  characterInfo.innerHTML = `\r\n    <div class=\"character-info-container\">\r\n      ${portraitUrl ? `<img id=\"settings-portrait\" src=\"${portraitUrl}\" alt=\"Character Portrait\">` : ''}\r\n      <div style=\"flex: 1;\">\r\n        <div class=\"character-name\">${character.name || 'Unknown Character'}</div>\r\n        <div class=\"character-detail\">Level ${character.level || '?'} ${character.race || ''} ${character.class || ''}</div>\r\n        <div class=\"character-detail\">HP: ${character.hitPoints?.current || 0} / ${character.hitPoints?.max || 0}</div>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n  // Set up drag-and-drop for settings tab portrait\r\n  const settingsPortrait = document.getElementById('settings-portrait');\r\n  if (settingsPortrait && portraitUrl) {\r\n    setupPortraitDrag(settingsPortrait, character, portraitUrl);\r\n  }\r\n\r\n  // Update character header for other tabs\r\n  const characterHeaderName = document.getElementById('character-header-name');\r\n  const characterHeaderDetails = document.getElementById('character-header-details');\r\n  const characterPortrait = document.getElementById('character-portrait');\r\n\r\n  if (characterHeaderName && characterHeaderDetails) {\r\n    characterHeaderName.textContent = character.name || 'Unknown Character';\r\n    characterHeaderDetails.textContent = `Level ${character.level || '?'} ${character.race || ''} ${character.class || ''}`;\r\n  }\r\n\r\n  // Set character portrait if available\r\n  if (characterPortrait) {\r\n    if (portraitUrl) {\r\n      characterPortrait.src = portraitUrl;\r\n      characterPortrait.style.display = 'block';\r\n      console.log('\u2705 Portrait loaded from:', portraitUrl);\r\n\r\n      // Set up drag-and-drop to create token\r\n      setupPortraitDrag(characterPortrait, character, portraitUrl);\r\n    } else {\r\n      characterPortrait.style.display = 'none';\r\n      console.log('\u274C No portrait found');\r\n    }\r\n  }\r\n\r\n  // Populate other tabs\r\n  populateStatsTab(character);\r\n  populateAbilitiesTab(character);\r\n  populateFeaturesTab(character);\r\n  populateActionsTab(character);\r\n  populateSpellsTab(character);\r\n  populateInventoryTab(character);\r\n\r\n  console.log('\uD83C\uDFAD Displaying character:', character.name);\r\n}\r\n\r\n/**\r\n * Upload circular token image to Supabase Storage and return public URL\r\n */\r\nasync function uploadCircularTokenToSupabase(dataUrl, characterId) {\r\n  try {\r\n    // Convert data URL to blob\r\n    const response = await fetch(dataUrl);\r\n    const blob = await response.blob();\r\n\r\n    // Create unique filename\r\n    const filename = `token-${characterId}-${Date.now()}.png`;\r\n\r\n    // Upload to Supabase Storage\r\n    const formData = new FormData();\r\n    formData.append('file', blob, filename);\r\n    formData.append('characterId', characterId);\r\n\r\n    const uploadResponse = await fetch(\r\n      `${SUPABASE_URL}/functions/v1/upload-token-image`,\r\n      {\r\n        method: 'POST',\r\n        headers: {\r\n          'apikey': SUPABASE_ANON_KEY,\r\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\r\n        },\r\n        body: formData\r\n      }\r\n    );\r\n\r\n    if (!uploadResponse.ok) {\r\n      throw new Error(`Upload failed: ${uploadResponse.statusText}`);\r\n    }\r\n\r\n    const data = await uploadResponse.json();\r\n    return data.url;\r\n  } catch (error) {\r\n    console.error('Failed to upload token image:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Create a circular version of an image using Canvas\r\n */\r\nasync function createCircularImage(imageUrl, size) {\r\n  return new Promise((resolve) => {\r\n    const img = new Image();\r\n    img.crossOrigin = 'anonymous'; // Handle CORS\r\n\r\n    img.onload = () => {\r\n      // Create canvas with extra space for border\r\n      const borderWidth = Math.max(8, size * 0.04); // 4% of size, minimum 8px\r\n      const canvas = document.createElement('canvas');\r\n      canvas.width = size;\r\n      canvas.height = size;\r\n      const ctx = canvas.getContext('2d');\r\n\r\n      // Save context before clipping\r\n      ctx.save();\r\n\r\n      // Draw circular clip (slightly smaller to account for border)\r\n      const radius = (size / 2) - (borderWidth / 2);\r\n      ctx.beginPath();\r\n      ctx.arc(size / 2, size / 2, radius, 0, Math.PI * 2);\r\n      ctx.closePath();\r\n      ctx.clip();\r\n\r\n      // Draw image centered and scaled to fill circle\r\n      const scale = Math.max(size / img.width, size / img.height);\r\n      const x = (size / 2) - (img.width / 2) * scale;\r\n      const y = (size / 2) - (img.height / 2) * scale;\r\n      ctx.drawImage(img, x, y, img.width * scale, img.height * scale);\r\n\r\n      // Restore context to remove clipping\r\n      ctx.restore();\r\n\r\n      // Draw theme-colored outline\r\n      ctx.beginPath();\r\n      ctx.arc(size / 2, size / 2, radius, 0, Math.PI * 2);\r\n      const theme = ThemeManager.getCurrentTheme();\r\n      ctx.strokeStyle = theme ? theme.primary : '#8B5CF6'; // Use theme color or fallback purple\r\n      ctx.lineWidth = borderWidth;\r\n      ctx.stroke();\r\n\r\n      // Convert to data URL\r\n      resolve(canvas.toDataURL('image/png'));\r\n    };\r\n\r\n    img.onerror = () => {\r\n      console.warn('Failed to load image for circular crop, using original');\r\n      resolve(imageUrl); // Fallback to original if loading fails\r\n    };\r\n\r\n    img.src = imageUrl;\r\n  });\r\n}\r\n\r\n/**\r\n * Set up click handler for character portrait to create tokens\r\n */\r\nfunction setupPortraitDrag(portraitElement, character, portraitUrl) {\r\n  if (!isOwlbearReady) return;\r\n\r\n  // Enable HTML5 drag-and-drop for GMs to drag onto map\r\n  portraitElement.draggable = true;\r\n  portraitElement.style.cursor = 'grab';\r\n  portraitElement.title = 'Drag to map (GM) or click to add token';\r\n\r\n  // Handle drag start\r\n  portraitElement.addEventListener('dragstart', (e) => {\r\n    portraitElement.style.cursor = 'grabbing';\r\n    e.dataTransfer.effectAllowed = 'copy';\r\n\r\n    // Set multiple data formats for compatibility\r\n    e.dataTransfer.setData('text/uri-list', portraitUrl);\r\n    e.dataTransfer.setData('text/plain', portraitUrl);\r\n    e.dataTransfer.setData('text/html', `<img src=\"${portraitUrl}\" alt=\"${character.name}\">`);\r\n    e.dataTransfer.setData('DownloadURL', `image/png:${character.name}.png:${portraitUrl}`);\r\n\r\n    // Set drag image\r\n    const img = new Image();\r\n    img.src = portraitUrl;\r\n    e.dataTransfer.setDragImage(portraitElement, 50, 50);\r\n\r\n    console.log('\uD83C\uDFA8 Dragging portrait for', character.name, '- URL:', portraitUrl);\r\n  });\r\n\r\n  portraitElement.addEventListener('dragend', () => {\r\n    portraitElement.style.cursor = 'grab';\r\n  });\r\n\r\n  // Also support click for programmatic creation (fallback for players)\r\n  portraitElement.onclick = async (e) => {\r\n    // Prevent drag from also triggering click\r\n    if (e.detail === 0) return;\r\n\r\n    try {\r\n      console.log('\uD83C\uDFA8 Creating token for', character.name);\r\n\r\n      // Get grid DPI for sizing (1 grid square)\r\n      const dpi = await OBR.scene.grid.getDpi();\r\n\r\n      // Create circular version and upload to Supabase\r\n      console.log('\uD83C\uDFA8 Creating circular token image...');\r\n      const circularDataUrl = await createCircularImage(portraitUrl, dpi * 2); // 2x for quality\r\n\r\n      console.log('\uD83D\uDCE4 Uploading to Supabase...');\r\n      const circularImageUrl = await uploadCircularTokenToSupabase(circularDataUrl, character.id);\r\n\r\n      // Get current player ID to set ownership\r\n      const playerId = await OBR.player.getId();\r\n\r\n      // Build token using buildImage with circular image\r\n      const token = buildImage(\r\n        {\r\n          height: dpi,\r\n          width: dpi,\r\n          url: circularImageUrl,\r\n          mime: 'image/png'\r\n        },\r\n        {\r\n          dpi: dpi,\r\n          offset: { x: 0, y: 0 }\r\n        }\r\n      )\r\n        .layer('CHARACTER')\r\n        .locked(false)\r\n        .name(character.name || 'Character')\r\n        .plainText(character.name || 'Character')\r\n        .metadata({\r\n          owlcloud: {\r\n            characterId: character.id,\r\n            characterName: character.name,\r\n            diceCloudId: character.diceCloudId,\r\n            playerId: playerId\r\n          }\r\n        })\r\n        .build();\r\n\r\n      console.log('\uD83C\uDFA8 Token built:', token);\r\n\r\n      // Add to scene\r\n      await OBR.scene.items.addItems([token]);\r\n\r\n      // Notify user\r\n      OBR.notification.show(`Added ${character.name} to map`, 'SUCCESS');\r\n      console.log('\u2705 Token created successfully with metadata:', token.metadata);\r\n    } catch (error) {\r\n      console.error('\u274C Error creating token:', error);\r\n      OBR.notification.show(`Failed to create token: ${error.message}`, 'ERROR');\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Populate Stats & Resources tab (combined)\r\n */\r\nfunction populateStatsTab(character) {\r\n  const statsContent = document.getElementById('stats-content');\r\n\r\n  const hp = character.hitPoints || {};\r\n  const tempHP = character.temporaryHP || 0;\r\n  const ac = character.armorClass || 10;\r\n  const speed = character.speed || 30;\r\n  const initiative = character.initiative || 0;\r\n  const proficiencyBonus = character.proficiencyBonus || Math.floor((character.level || 1) / 4) + 2;\r\n\r\n  // Build core stats section\r\n  let html = `\r\n    <div class=\"stat-grid\">\r\n      <div class=\"stat-box\" style=\"cursor: pointer;\" onclick=\"adjustHP()\" title=\"Click to adjust HP\">\r\n        <div class=\"stat-label\">HP</div>\r\n        <div class=\"stat-value\">${hp.current || 0}</div>\r\n        <div class=\"stat-modifier\">/ ${hp.max || 0}</div>\r\n      </div>\r\n\r\n      ${tempHP > 0 ? `\r\n      <div class=\"stat-box\">\r\n        <div class=\"stat-label\">Temp HP</div>\r\n        <div class=\"stat-value\" style=\"color: #60A5FA;\">${tempHP}</div>\r\n      </div>\r\n      ` : ''}\r\n\r\n      <div class=\"stat-box\">\r\n        <div class=\"stat-label\">AC</div>\r\n        <div class=\"stat-value\">${ac}</div>\r\n      </div>\r\n\r\n      <div class=\"stat-box\">\r\n        <div class=\"stat-label\">Speed</div>\r\n        <div class=\"stat-value\">${speed}</div>\r\n        <div class=\"stat-modifier\">ft</div>\r\n      </div>\r\n\r\n      <div class=\"stat-box\" style=\"cursor: pointer;\" onclick=\"rollInitiative(${initiative})\" title=\"Click to roll initiative\">\r\n        <div class=\"stat-label\">Initiative</div>\r\n        <div class=\"stat-value\">${initiative >= 0 ? '+' : ''}${initiative}</div>\r\n      </div>\r\n\r\n      <div class=\"stat-box\">\r\n        <div class=\"stat-label\">Prof Bonus</div>\r\n        <div class=\"stat-value\">+${proficiencyBonus}</div>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n  // Hit Dice section\r\n  if (character.hitDice) {\r\n    const hitDice = character.hitDice;\r\n    html += `\r\n      <div class=\"section-header\">Hit Dice</div>\r\n      <div class=\"stat-grid\">\r\n        <div class=\"stat-box\">\r\n          <div class=\"stat-label\">Hit Dice</div>\r\n          <div class=\"stat-value\">${hitDice.current || 0}</div>\r\n          <div class=\"stat-modifier\">/ ${hitDice.max || 0} d${hitDice.type || '8'}</div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  // Death Saves section (if character is unconscious)\r\n  if (character.deathSaves && (character.deathSaves.successes > 0 || character.deathSaves.failures > 0)) {\r\n    html += `\r\n      <div class=\"section-header\">Death Saves</div>\r\n      <div class=\"stat-grid\">\r\n        <div class=\"stat-box\" style=\"border-color: #10B981;\">\r\n          <div class=\"stat-label\">Successes</div>\r\n          <div class=\"stat-value\" style=\"color: #10B981;\">${character.deathSaves.successes || 0}</div>\r\n        </div>\r\n        <div class=\"stat-box\" style=\"border-color: #EF4444;\">\r\n          <div class=\"stat-label\">Failures</div>\r\n          <div class=\"stat-value\" style=\"color: #EF4444;\">${character.deathSaves.failures || 0}</div>\r\n        </div>\r\n      </div>\r\n      <button class=\"rest-btn\" onclick=\"rollDeathSave()\" style=\"margin-top: 8px;\">\uD83D\uDC80 Roll Death Save</button>\r\n    `;\r\n  }\r\n\r\n  // === RESOURCES SECTION ===\r\n\r\n  // Spell Slots Section\r\n  const hasSpellSlots = character.spellSlots && Object.keys(character.spellSlots).some(key =>\r\n    key.includes('Max') && character.spellSlots[key] > 0\r\n  );\r\n\r\n  if (hasSpellSlots) {\r\n    html += '<div class=\"section-header\">Spell Slots</div>';\r\n    html += '<div class=\"spell-slots-grid\">';\r\n\r\n    // Regular spell slots (levels 1-9)\r\n    for (let level = 1; level <= 9; level++) {\r\n      const current = character.spellSlots[`level${level}SpellSlots`] || 0;\r\n      const max = character.spellSlots[`level${level}SpellSlotsMax`] || 0;\r\n\r\n      if (max > 0) {\r\n        html += `\r\n          <div class=\"slot-card ${current === 0 ? 'empty' : ''}\" style=\"cursor: pointer;\" onclick=\"adjustSpellSlot(${level})\" title=\"Click to adjust spell slots\">\r\n            <div class=\"slot-level\">Level ${level}</div>\r\n            <div class=\"slot-count\">${current}/${max}</div>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n\r\n    // Pact Magic slots (Warlock)\r\n    const pactCurrent = character.spellSlots.pactMagicSlots || 0;\r\n    const pactMax = character.spellSlots.pactMagicSlotsMax || 0;\r\n    const pactLevel = character.spellSlots.pactMagicSlotLevel || 1;\r\n\r\n    if (pactMax > 0) {\r\n      html += `\r\n        <div class=\"slot-card pact-magic ${pactCurrent === 0 ? 'empty' : ''}\" style=\"cursor: pointer;\" onclick=\"adjustSpellSlot(null, true)\" title=\"Click to adjust pact magic slots\">\r\n          <div class=\"slot-level\">Pact ${pactLevel}</div>\r\n          <div class=\"slot-count\">${pactCurrent}/${pactMax}</div>\r\n        </div>\r\n      `;\r\n    }\r\n\r\n    html += '</div>';\r\n  }\r\n\r\n  // Class Resources Section\r\n  if (character.resources && character.resources.length > 0) {\r\n    const filteredResources = character.resources.filter(r => {\r\n      if (r.max === 0) return false;\r\n      const lowerName = r.name.toLowerCase().trim();\r\n      if (lowerName.includes('lucky point') || lowerName === 'lucky') return false;\r\n      if (lowerName.includes('hit point') || lowerName === 'hp') return false;\r\n      if (lowerName === 'spell level') return false;\r\n      return true;\r\n    });\r\n\r\n    if (filteredResources.length > 0) {\r\n      html += '<div class=\"section-header\">Class Resources</div>';\r\n      html += '<div class=\"resource-grid\">';\r\n\r\n      filteredResources.forEach(resource => {\r\n        html += `\r\n          <div class=\"resource-card\" style=\"cursor: pointer;\" onclick=\"adjustResource('${resource.name.replace(/'/g, \"\\\\'\")}') \" title=\"Click to adjust ${resource.name}\">\r\n            <div class=\"resource-name\">${resource.name}</div>\r\n            <div class=\"resource-value\">${resource.current || 0}</div>\r\n            <div class=\"resource-max\">/ ${resource.max || 0}</div>\r\n          </div>\r\n        `;\r\n      });\r\n\r\n      html += '</div>';\r\n    }\r\n  }\r\n\r\n  // Rest Buttons\r\n  html += `\r\n    <div class=\"rest-buttons\">\r\n      <button class=\"rest-btn\" onclick=\"takeShortRest()\">\r\n        \u23F8\uFE0F Short Rest\r\n      </button>\r\n      <button class=\"rest-btn\" onclick=\"takeLongRest()\">\r\n        \uD83D\uDECC Long Rest\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  statsContent.innerHTML = html;\r\n}\r\n\r\n\r\n/**\r\n * Populate Abilities & Saves tab\r\n */\r\nfunction populateAbilitiesTab(character) {\r\n  const abilitiesContent = document.getElementById('abilities-content');\r\n\r\n  // Ability scores and modifiers\r\n  const abilityNames = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];\r\n  const abilityShortNames = { strength: 'STR', dexterity: 'DEX', constitution: 'CON', intelligence: 'INT', wisdom: 'WIS', charisma: 'CHA' };\r\n\r\n  let html = '<div class=\"section-header\">Ability Scores & Saving Throws</div>';\r\n  html += '<div class=\"ability-grid\">';\r\n\r\n  abilityNames.forEach(abilityName => {\r\n    const score = character.attributes?.[abilityName] || 10;\r\n    const modifier = character.attributeMods?.[abilityName] || Math.floor((score - 10) / 2);\r\n    const saveMod = character.savingThrows?.[abilityName] || modifier;\r\n    const isProficient = saveMod !== modifier;\r\n    const abilityLabel = abilityShortNames[abilityName];\r\n\r\n    html += `\r\n      <div class=\"ability-box ${isProficient ? 'save-proficient' : ''}\">\r\n        <div style=\"padding: 8px; text-align: center;\">\r\n          <div class=\"ability-name\">${abilityLabel}</div>\r\n          <div class=\"ability-score\" style=\"font-size: 18px; font-weight: bold;\">${score}</div>\r\n        </div>\r\n        <div style=\"display: flex; border-top: 1px solid var(--theme-border);\">\r\n          <div style=\"flex: 1; padding: 6px; cursor: pointer; text-align: center; border-right: 1px solid var(--theme-border);\" onclick=\"event.stopPropagation(); event.preventDefault(); rollAbilityCheck('${abilityLabel}', ${modifier})\" title=\"Roll ${abilityLabel} check\">\r\n            <div style=\"font-size: 11px; color: var(--theme-primary-light); pointer-events: none;\">Check</div>\r\n            <div style=\"font-weight: bold; pointer-events: none;\">${modifier >= 0 ? '+' : ''}${modifier}</div>\r\n          </div>\r\n          <div style=\"flex: 1; padding: 6px; cursor: pointer; text-align: center;\" onclick=\"event.stopPropagation(); event.preventDefault(); rollSavingThrow('${abilityLabel}', ${saveMod})\" title=\"Roll ${abilityLabel} save\">\r\n            <div style=\"font-size: 11px; color: ${isProficient ? '#10B981' : 'var(--theme-primary-light)'}; pointer-events: none;\">Save</div>\r\n            <div style=\"font-weight: bold; color: ${isProficient ? '#10B981' : 'inherit'}; pointer-events: none;\">${saveMod >= 0 ? '+' : ''}${saveMod}</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  });\r\n\r\n  html += '</div>';\r\n\r\n  // Skills Section\r\n  if (character.skills && Object.keys(character.skills).length > 0) {\r\n    html += '<div class=\"section-header\">Skills</div>';\r\n    html += '<div class=\"skill-list\">';\r\n\r\n    const skillNames = {\r\n      acrobatics: 'Acrobatics', animalHandling: 'Animal Handling', arcana: 'Arcana',\r\n      athletics: 'Athletics', deception: 'Deception', history: 'History',\r\n      insight: 'Insight', intimidation: 'Intimidation', investigation: 'Investigation',\r\n      medicine: 'Medicine', nature: 'Nature', perception: 'Perception',\r\n      performance: 'Performance', persuasion: 'Persuasion', religion: 'Religion',\r\n      sleightOfHand: 'Sleight of Hand', stealth: 'Stealth', survival: 'Survival'\r\n    };\r\n\r\n    Object.entries(character.skills).forEach(([skillKey, bonus]) => {\r\n      const skillName = skillNames[skillKey] || skillKey;\r\n\r\n      // Determine proficiency level by comparing to base ability modifier\r\n      const skillAbilityMap = {\r\n        acrobatics: 'dexterity', animalHandling: 'wisdom', arcana: 'intelligence',\r\n        athletics: 'strength', deception: 'charisma', history: 'intelligence',\r\n        insight: 'wisdom', intimidation: 'charisma', investigation: 'intelligence',\r\n        medicine: 'wisdom', nature: 'intelligence', perception: 'wisdom',\r\n        performance: 'charisma', persuasion: 'charisma', religion: 'intelligence',\r\n        sleightOfHand: 'dexterity', stealth: 'dexterity', survival: 'wisdom'\r\n      };\r\n\r\n      const baseAbility = skillAbilityMap[skillKey] || 'strength';\r\n      const baseMod = character.attributeMods?.[baseAbility] || 0;\r\n      const profBonus = character.proficiencyBonus || 2;\r\n\r\n      let proficiencyClass = '';\r\n      if (bonus === baseMod + profBonus) {\r\n        proficiencyClass = 'skill-proficient';\r\n      } else if (bonus === baseMod + (profBonus * 2)) {\r\n        proficiencyClass = 'skill-expert';\r\n      }\r\n\r\n      html += `\r\n        <div class=\"skill-item ${proficiencyClass}\" onclick=\"rollSkillCheck('${skillName}', ${bonus})\" title=\"Click to roll ${skillName}\">\r\n          <span class=\"skill-name\">${skillName}</span>\r\n          <span class=\"skill-bonus\">${bonus >= 0 ? '+' : ''}${bonus}</span>\r\n        </div>\r\n      `;\r\n    });\r\n\r\n    html += '</div>';\r\n  }\r\n\r\n  abilitiesContent.innerHTML = html;\r\n}\r\n\r\n/**\r\n * Populate Features & Traits tab\r\n */\r\nfunction populateFeaturesTab(character) {\r\n  const featuresContent = document.getElementById('features-content');\r\n\r\n  let html = '';\r\n\r\n  // Features & Traits Section\r\n  if (character.features && character.features.length > 0) {\r\n    // Filter out generic spellcasting features and proficiency lists\r\n    const filteredFeatures = character.features.filter(feature => {\r\n      const name = (feature.name || '').toLowerCase();\r\n      // Exclude generic spellcasting features\r\n      if (name.match(/^spellcasting\\s*\\[/i) || name === 'spellcasting') {\r\n        return false;\r\n      }\r\n      // Exclude background and class proficiency lists\r\n      if (name.includes('proficiencies') || name.includes('proficiency')) {\r\n        return false;\r\n      }\r\n      return true;\r\n    });\r\n\r\n    if (filteredFeatures.length > 0) {\r\n      html += '<div class=\"feature-list\">';\r\n\r\n      filteredFeatures.forEach((feature, index) => {\r\n        const featureId = `feature-${index}`;\r\n        const uses = feature.uses;\r\n\r\n        // Infer resource usage from feature name (for class resources)\r\n        let resourceName = null;\r\n        const featureName = (feature.name || '').toLowerCase();\r\n        if (featureName.includes('channel divinity')) {\r\n          resourceName = 'Channel Divinity';\r\n        } else if (featureName.includes('ki point') || featureName.includes('ki ')) {\r\n          resourceName = 'Ki Points';\r\n        } else if (featureName.includes('bardic inspiration')) {\r\n          resourceName = 'Bardic Inspiration';\r\n        } else if (featureName.includes('superiority')) {\r\n          resourceName = 'Superiority Dice';\r\n        } else if (featureName.includes('sorcery point')) {\r\n          resourceName = 'Sorcery Points';\r\n        }\r\n\r\n        // Create Use button if feature has uses OR matches a known resource\r\n        let useButtonHtml = '';\r\n        if (uses && uses.value !== undefined) {\r\n          // Feature has its own uses tracking\r\n          useButtonHtml = `<button class=\"rest-btn\" style=\"margin-top: 8px; width: 100%;\" onclick=\"event.stopPropagation(); useFeatureWithUses('${(feature.name || 'Feature').replace(/'/g, \"\\\\'\")}')\">\u2728 Use (${uses.value}/${uses.max || uses.value})</button>`;\r\n        } else if (resourceName) {\r\n          // Feature uses a class resource\r\n          useButtonHtml = `<button class=\"rest-btn\" style=\"margin-top: 8px; width: 100%;\" onclick=\"event.stopPropagation(); useFeature('${(feature.name || 'Feature').replace(/'/g, \"\\\\'\")}', '${resourceName}')\">\u2728 Use</button>`;\r\n        }\r\n\r\n        // Combine summary and description\r\n        let featureText = '';\r\n        if (feature.summary) {\r\n          featureText += `<div class=\"feature-description\">${feature.summary}</div>`;\r\n        }\r\n        if (feature.description) {\r\n          featureText += `<div class=\"feature-description\">${feature.description}</div>`;\r\n        }\r\n\r\n        html += `\r\n          <div class=\"feature-card\">\r\n            <div class=\"feature-header\" onclick=\"toggleFeatureCard('${featureId}')\" style=\"cursor: pointer;\">\r\n              <div class=\"feature-name\">${feature.name || 'Unknown Feature'}</div>\r\n              <span class=\"expand-icon\">\u25BC</span>\r\n            </div>\r\n            <div id=\"${featureId}\" class=\"feature-details\">\r\n              ${featureText}\r\n              ${feature.source ? `<div class=\"feature-metadata\"><div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Source:</span> ${feature.source}</div></div>` : ''}\r\n              ${useButtonHtml}\r\n            </div>\r\n          </div>\r\n        `;\r\n      });\r\n\r\n      html += '</div>';\r\n    } else {\r\n      html = '<div class=\"empty-state\">No features available</div>';\r\n    }\r\n  } else {\r\n    html = '<div class=\"empty-state\">No features available</div>';\r\n  }\r\n\r\n  featuresContent.innerHTML = html;\r\n}\r\n\r\n/**\r\n * Populate Actions & Attacks tab\r\n */\r\nfunction populateActionsTab(character) {\r\n  const actionsContent = document.getElementById('actions-content');\r\n\r\n  let html = '';\r\n\r\n  // Actions Section\r\n  if (character.actions && character.actions.length > 0) {\r\n    // Deduplicate and filter actions\r\n    const deduplicatedActions = deduplicateActions(character.actions);\r\n\r\n    html += '<div class=\"feature-list\">';\r\n\r\n    deduplicatedActions.forEach((action, index) => {\r\n      const actionId = `action-${index}`;\r\n      const actionType = action.actionType || 'Action';\r\n      const damage = action.damage || '';\r\n      const attackRoll = action.attackRoll || '';\r\n      const uses = action.uses;\r\n\r\n      // Diagnostic logging for uses\r\n      console.log(`[OwlCloud] Action \"${action.name}\" uses:`, uses);\r\n\r\n      // Parse attack bonus from attackRoll string (like \"+5\" or \"1d20+5\")\r\n      let attackBonus = 0;\r\n      if (attackRoll) {\r\n        const bonusMatch = attackRoll.match(/[+-](\\d+)/);\r\n        if (bonusMatch) {\r\n          attackBonus = parseInt(bonusMatch[0]);\r\n        }\r\n      }\r\n\r\n      // Parse damage formula (like \"1d8+3\" or \"2d6\")\r\n      let damageFormula = damage;\r\n\r\n      // Create separate attack and damage buttons\r\n      const hasAttack = attackRoll && attackRoll.trim();\r\n      const hasDamage = damage && damage.trim();\r\n\r\n      let rollButtonHtml = '';\r\n      if (hasAttack || hasDamage) {\r\n        rollButtonHtml = '<div style=\"display: flex; gap: 8px; margin-top: 8px;\">';\r\n\r\n        if (hasAttack) {\r\n          rollButtonHtml += `<button class=\"rest-btn\" style=\"flex: 1;\" onclick=\"event.stopPropagation(); rollAttackOnly('${(action.name || 'Action').replace(/'/g, \"\\\\'\")}', ${attackBonus})\">\uD83C\uDFAF Attack</button>`;\r\n        }\r\n\r\n        if (hasDamage) {\r\n          rollButtonHtml += `<button class=\"rest-btn\" style=\"flex: 1;\" onclick=\"event.stopPropagation(); rollDamageOnly('${(action.name || 'Action').replace(/'/g, \"\\\\'\")}', '${damageFormula}')\">\uD83D\uDCA5 Damage</button>`;\r\n        }\r\n\r\n        rollButtonHtml += '</div>';\r\n      }\r\n\r\n      // Add Use button if action has uses\r\n      const useButtonHtml = (uses && uses.value !== undefined) ?\r\n        `<button class=\"rest-btn\" style=\"margin-top: 8px; width: 100%;\" onclick=\"event.stopPropagation(); useAction('${(action.name || 'Action').replace(/'/g, \"\\\\'\")}')\">\u2728 Use</button>` : '';\r\n\r\n      const hasRollAction = hasAttack || hasDamage;\r\n\r\n      // Determine full action type (e.g., \"attack | action\" or \"utility | bonus action\")\r\n      const attackTypePrefix = hasRollAction ? 'attack' : 'utility';\r\n      const fullActionType = `${attackTypePrefix} | ${actionType.toLowerCase()}`;\r\n\r\n      // Combine summary and description\r\n      let actionText = '';\r\n      if (action.summary) {\r\n        actionText += `<div class=\"feature-description\">${action.summary}</div>`;\r\n      }\r\n      if (action.description) {\r\n        actionText += `<div class=\"feature-description\">${action.description}</div>`;\r\n      }\r\n\r\n      html += `\r\n        <div class=\"feature-card\">\r\n          <div class=\"feature-header\" onclick=\"toggleFeatureCard('${actionId}')\" style=\"cursor: pointer;\">\r\n            <div class=\"feature-name\">${action.name || 'Unknown Action'}</div>\r\n            <span class=\"expand-icon\">\u25BC</span>\r\n          </div>\r\n          <div id=\"${actionId}\" class=\"feature-details\">\r\n            <div class=\"feature-metadata\">\r\n              <div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Type:</span> ${fullActionType}</div>\r\n              ${attackRoll ? `<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Attack:</span> ${attackRoll}</div>` : ''}\r\n              ${damage ? `<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Damage:</span> ${damage}</div>` : ''}\r\n              ${uses && uses.value !== undefined ? `<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Uses:</span> ${uses.value}/${uses.max || uses.value}</div>` : ''}\r\n            </div>\r\n            ${actionText}\r\n            ${rollButtonHtml}\r\n            ${useButtonHtml}\r\n          </div>\r\n        </div>\r\n      `;\r\n    });\r\n\r\n    html += '</div>';\r\n  } else {\r\n    html = '<div class=\"empty-state\">No actions available</div>';\r\n  }\r\n\r\n  actionsContent.innerHTML = html;\r\n}\r\n\r\n/**\r\n * Deduplicate actions by normalized name\r\n */\r\nfunction deduplicateActions(actions) {\r\n  const normalizeActionName = (name) => {\r\n    if (!name) return '';\r\n    const suffixPatterns = [\r\n      /\\s*\\(free\\)$/i,\r\n      /\\s*\\(free action\\)$/i,\r\n      /\\s*\\(bonus action\\)$/i,\r\n      /\\s*\\(bonus\\)$/i,\r\n      /\\s*\\(reaction\\)$/i,\r\n      /\\s*\\(action\\)$/i,\r\n      /\\s*\\(no spell slot\\)$/i,\r\n      /\\s*\\(at will\\)$/i\r\n    ];\r\n\r\n    let normalized = name.trim();\r\n    for (const pattern of suffixPatterns) {\r\n      normalized = normalized.replace(pattern, '');\r\n    }\r\n    return normalized.trim();\r\n  };\r\n\r\n  const deduplicatedActions = [];\r\n  const actionsByNormalizedName = {};\r\n\r\n  // Sort actions: prefer shorter names (base versions)\r\n  const sortedActions = [...actions].sort((a, b) => {\r\n    const normA = normalizeActionName(a.name || '');\r\n    const normB = normalizeActionName(b.name || '');\r\n    if (normA !== normB) return normA.localeCompare(normB);\r\n    return (a.name || '').length - (b.name || '').length;\r\n  });\r\n\r\n  sortedActions.forEach(action => {\r\n    const normalizedName = normalizeActionName(action.name || '');\r\n    if (!normalizedName) return;\r\n\r\n    // Filter out duplicate Divine Smite variants\r\n    const actionLower = (action.name || '').toLowerCase();\r\n    if (actionLower.includes('divine smite') && actionLower !== 'divine smite') {\r\n      return;\r\n    }\r\n\r\n    if (!actionsByNormalizedName[normalizedName]) {\r\n      actionsByNormalizedName[normalizedName] = action;\r\n      deduplicatedActions.push(action);\r\n    } else {\r\n      // Merge duplicate action properties\r\n      const existing = actionsByNormalizedName[normalizedName];\r\n      if (action.source && !existing.source?.includes(action.source)) {\r\n        existing.source = existing.source ? existing.source + '; ' + action.source : action.source;\r\n      }\r\n      if (action.damage && !existing.damage) existing.damage = action.damage;\r\n      if (action.attackRoll && !existing.attackRoll) existing.attackRoll = action.attackRoll;\r\n      if (action.uses && !existing.uses) existing.uses = action.uses;\r\n    }\r\n  });\r\n\r\n  return deduplicatedActions;\r\n}\r\n\r\n/**\r\n * Populate Spells tab\r\n */\r\nfunction populateSpellsTab(character) {\r\n  const spellsContent = document.getElementById('spells-content');\r\n\r\n  if (!character.spells || character.spells.length === 0) {\r\n    spellsContent.innerHTML = '<div class=\"empty-state\">No spells available</div>';\r\n    return;\r\n  }\r\n\r\n  // Filter out Divine Smite duplicates\r\n  const filteredSpells = character.spells.filter(spell => {\r\n    const spellName = (spell.name || '').toLowerCase();\r\n    if (spellName.includes('divine smite') && spellName !== 'divine smite') {\r\n      return false;\r\n    }\r\n    return true;\r\n  });\r\n\r\n  // Group spells by level\r\n  const spellsByLevel = {};\r\n  filteredSpells.forEach(spell => {\r\n    const spellLevel = parseInt(spell.level) || 0;\r\n    const levelKey = spellLevel === 0 ? 'Cantrips' : `Level ${spellLevel}`;\r\n\r\n    if (!spellsByLevel[levelKey]) {\r\n      spellsByLevel[levelKey] = [];\r\n    }\r\n    spellsByLevel[levelKey].push(spell);\r\n  });\r\n\r\n  // Build HTML\r\n  let html = '';\r\n\r\n  // Order levels properly (Cantrips, then 1-9)\r\n  const levelOrder = ['Cantrips', 'Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5', 'Level 6', 'Level 7', 'Level 8', 'Level 9'];\r\n\r\n  levelOrder.forEach((levelKey, index) => {\r\n    if (!spellsByLevel[levelKey]) return;\r\n\r\n    const spells = spellsByLevel[levelKey];\r\n    const spellLevelId = 'spell-level-' + index + '-' + Date.now();\r\n\r\n    html += `<div class=\"spell-level-group\">`;\r\n    html += `<div class=\"spell-level-header collapsible\" onclick=\"toggleCollapsible('${spellLevelId}')\" style=\"cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center;\">${levelKey} (${spells.length})<span style=\"font-size: 12px; transition: transform 0.2s ease;\">\u25BC</span></div>`;\r\n    html += `<div id=\"${spellLevelId}\" class=\"collapsible-content\">`;\r\n    html += `<div class=\"spell-list\">`;\r\n\r\n    spells.forEach((spell, spellIndex) => {\r\n      const spellCardId = `spell-${index}-${spellIndex}`;\r\n      const isConcentration = spell.concentration || false;\r\n      const isRitual = spell.ritual || false;\r\n      const castingTime = spell.castingTime || '';\r\n      const range = spell.range || '';\r\n      const components = spell.components || '';\r\n      const duration = spell.duration || '';\r\n      const spellLevel = parseInt(spell.level) || 0;\r\n      const attackRoll = spell.attackRoll || spell.attack || '';\r\n      const damage = spell.damage || '';\r\n      const healing = spell.healing || '';\r\n\r\n      // Parse attack bonus from attackRoll string\r\n      let attackBonus = 0;\r\n      if (attackRoll) {\r\n        const bonusMatch = attackRoll.match(/[+-](\\d+)/);\r\n        if (bonusMatch) {\r\n          attackBonus = parseInt(bonusMatch[0]);\r\n        }\r\n      }\r\n\r\n      // Create spell buttons - always include Cast, plus Attack/Damage/Healing as needed\r\n      let spellButtonsHtml = '<div style=\"display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;\">';\r\n\r\n      // Cast button (always present) - for leveled spells, prompt for level choice\r\n      if (spellLevel > 0) {\r\n        spellButtonsHtml += `<button class=\"rest-btn\" style=\"flex: 1; min-width: 100px;\" onclick=\"event.stopPropagation(); promptCastSpell('${(spell.name || 'Unknown Spell').replace(/'/g, \"\\\\'\")}', ${spellLevel})\">\u2728 Cast</button>`;\r\n      } else {\r\n        // Cantrips cast directly\r\n        spellButtonsHtml += `<button class=\"rest-btn\" style=\"flex: 1; min-width: 100px;\" onclick=\"event.stopPropagation(); castSpell('${(spell.name || 'Unknown Spell').replace(/'/g, \"\\\\'\")}', 0)\">\u2728 Cast</button>`;\r\n      }\r\n\r\n      // Ritual cast button (for ritual spells, smaller)\r\n      if (isRitual) {\r\n        spellButtonsHtml += `<button class=\"rest-btn\" style=\"padding: 8px 12px; font-size: 12px;\" onclick=\"event.stopPropagation(); castSpellAsRitual('${(spell.name || 'Unknown Spell').replace(/'/g, \"\\\\'\")}')\">\uD83D\uDCFF Ritual</button>`;\r\n      }\r\n\r\n      // Attack button (if spell has attack roll)\r\n      if (attackRoll && attackRoll.trim()) {\r\n        spellButtonsHtml += `<button class=\"rest-btn\" style=\"flex: 1; min-width: 100px;\" onclick=\"event.stopPropagation(); rollAttackOnly('${(spell.name || 'Unknown Spell').replace(/'/g, \"\\\\'\")}', ${attackBonus})\">\uD83C\uDFAF Attack</button>`;\r\n      }\r\n\r\n      // Detect if this is a healing spell by checking name and description\r\n      const spellNameLower = (spell.name || '').toLowerCase();\r\n      const spellTextLower = ((spell.summary || '') + ' ' + (spell.description || '')).toLowerCase();\r\n      const isHealingSpell = spellNameLower.includes('cure') ||\r\n                            spellNameLower.includes('heal') ||\r\n                            spellNameLower.includes('restoration') ||\r\n                            spellNameLower.includes('revivify') ||\r\n                            spellNameLower.includes('regenerate') ||\r\n                            spellTextLower.includes('regain') ||\r\n                            spellTextLower.includes('regains') ||\r\n                            spellTextLower.includes('restores') ||\r\n                            (spellTextLower.includes('hit points') && !spellTextLower.includes('damage'));\r\n\r\n      // Damage or Healing button (if spell has damage/healing formula)\r\n      if (damage && damage.trim()) {\r\n        if (isHealingSpell) {\r\n          spellButtonsHtml += `<button class=\"rest-btn\" style=\"flex: 1; min-width: 100px;\" onclick=\"event.stopPropagation(); rollHealing('${(spell.name || 'Unknown Spell').replace(/'/g, \"\\\\'\")}', '${damage}')\">\uD83D\uDC9A Healing</button>`;\r\n        } else {\r\n          spellButtonsHtml += `<button class=\"rest-btn\" style=\"flex: 1; min-width: 100px;\" onclick=\"event.stopPropagation(); rollDamageOnly('${(spell.name || 'Unknown Spell').replace(/'/g, \"\\\\'\")}', '${damage}')\">\uD83D\uDCA5 Damage</button>`;\r\n        }\r\n      }\r\n\r\n      // Healing button (if spell has explicit healing field)\r\n      if (healing && healing.trim()) {\r\n        spellButtonsHtml += `<button class=\"rest-btn\" style=\"flex: 1; min-width: 100px;\" onclick=\"event.stopPropagation(); rollHealing('${(spell.name || 'Unknown Spell').replace(/'/g, \"\\\\'\")}', '${healing}')\">\uD83D\uDC9A Healing</button>`;\r\n      }\r\n\r\n      spellButtonsHtml += '</div>';\r\n\r\n      // Combine summary and description\r\n      let spellText = '';\r\n      if (spell.summary) {\r\n        spellText += `<div class=\"spell-description\">${spell.summary}</div>`;\r\n      }\r\n      if (spell.description) {\r\n        spellText += `<div class=\"spell-description\">${spell.description}</div>`;\r\n      }\r\n\r\n      html += `\r\n        <div class=\"spell-card ${isConcentration ? 'concentration' : ''} ${isRitual ? 'ritual' : ''}\">\r\n          <div class=\"spell-card-header\" onclick=\"toggleFeatureCard('${spellCardId}')\" style=\"cursor: pointer;\">\r\n            <span class=\"spell-name\">${spell.name || 'Unknown Spell'}</span>\r\n            <div class=\"spell-badges\">\r\n              ${isConcentration ? `<span class=\"spell-concentration-badge ${concentratingSpell === spell.name ? 'active' : ''}\" onclick=\"event.stopPropagation(); toggleConcentration('${(spell.name || '').replace(/'/g, \"\\\\'\")}')\">C</span>` : ''}\r\n              ${isRitual ? '<span class=\"spell-ritual-badge\">R</span>' : ''}\r\n              <span class=\"expand-icon\">\u25BC</span>\r\n            </div>\r\n          </div>\r\n          <div id=\"${spellCardId}\" class=\"spell-details\">\r\n            <div class=\"feature-metadata\">\r\n              ${castingTime ? `<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Casting Time:</span> ${castingTime}</div>` : ''}\r\n              ${range ? `<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Range:</span> ${range}</div>` : ''}\r\n              ${components ? `<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Components:</span> ${components}</div>` : ''}\r\n              ${duration ? `<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Duration:</span> ${duration}</div>` : ''}\r\n              ${isConcentration ? '<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Concentration:</span> Yes</div>' : ''}\r\n              ${isRitual ? '<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Ritual:</span> Yes</div>' : ''}\r\n              ${attackRoll ? `<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Attack:</span> ${attackRoll}</div>` : ''}\r\n              ${damage ? `<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Damage:</span> ${damage}</div>` : ''}\r\n              ${healing ? `<div class=\"feature-meta-item\"><span class=\"feature-meta-label\">Healing:</span> ${healing}</div>` : ''}\r\n            </div>\r\n            ${spellText}\r\n            ${spellButtonsHtml}\r\n          </div>\r\n        </div>\r\n      `;\r\n    });\r\n\r\n    html += `</div></div></div>`;\r\n  });\r\n\r\n  spellsContent.innerHTML = html;\r\n}\r\n\r\n/**\r\n * Populate Inventory tab\r\n */\r\nfunction populateInventoryTab(character) {\r\n  const inventoryContent = document.getElementById('inventory-content');\r\n\r\n  if (!character.inventory || character.inventory.length === 0) {\r\n    inventoryContent.innerHTML = '<div class=\"empty-state\">No items in inventory</div>';\r\n    return;\r\n  }\r\n\r\n  // Filter out coins\r\n  const coinPatterns = ['platinum piece', 'gold piece', 'silver piece', 'copper piece', 'electrum piece',\r\n                        'platinum coin', 'gold coin', 'silver coin', 'copper coin', 'electrum coin',\r\n                        'pp', 'gp', 'sp', 'cp', 'ep'];\r\n\r\n  const filteredInventory = character.inventory.filter(item => {\r\n    const lowerName = (item.name || '').toLowerCase();\r\n    const isCoin = coinPatterns.some(pattern => {\r\n      if (pattern.length <= 2) {\r\n        return lowerName === pattern || lowerName === pattern + 's' || lowerName.match(new RegExp(`^\\\\d+\\\\s*${pattern}s?$`));\r\n      }\r\n      return lowerName.includes(pattern);\r\n    });\r\n    return !isCoin;\r\n  });\r\n\r\n  if (filteredInventory.length === 0) {\r\n    inventoryContent.innerHTML = '<div class=\"empty-state\">No items in inventory</div>';\r\n    return;\r\n  }\r\n\r\n  // Sort: equipped first, then alphabetically\r\n  filteredInventory.sort((a, b) => {\r\n    if (a.equipped && !b.equipped) return -1;\r\n    if (!a.equipped && b.equipped) return 1;\r\n    return (a.name || '').localeCompare(b.name || '');\r\n  });\r\n\r\n  let html = '<div class=\"inventory-grid\">';\r\n\r\n  filteredInventory.forEach(item => {\r\n    const itemClass = item.equipped ? 'equipped' : (item.attuned ? 'attuned' : '');\r\n    const tags = [];\r\n\r\n    if (item.equipped) tags.push('Equipped');\r\n    if (item.attuned) tags.push('Attuned');\r\n    if (item.type) tags.push(item.type);\r\n\r\n    html += `\r\n      <div class=\"item-card ${itemClass}\">\r\n        <div class=\"item-info\">\r\n          <div class=\"item-name\">\r\n            ${item.name || 'Unknown Item'}\r\n            ${item.quantity > 1 ? `<span class=\"item-quantity\">\u00D7${item.quantity}</span>` : ''}\r\n          </div>\r\n          ${tags.length > 0 ? `<div class=\"item-tags\">${tags.join(' \u2022 ')}</div>` : ''}\r\n        </div>\r\n      </div>\r\n    `;\r\n  });\r\n\r\n  html += '</div>';\r\n\r\n  inventoryContent.innerHTML = html;\r\n}\r\n\r\n/**\r\n * Show no character state\r\n */\r\nfunction showNoCharacter() {\r\n  characterSection.style.display = 'none';\r\n  noCharacterSection.style.display = 'block';\r\n  statusText.textContent = 'No character selected';\r\n\r\n  // Hide unsync button when no character is loaded\r\n  const unsyncBtn = document.getElementById('unsync-character-btn');\r\n  if (unsyncBtn) {\r\n    unsyncBtn.style.display = 'none';\r\n  }\r\n\r\n  // Clear all tab content\r\n  const statsContent = document.getElementById('stats-content');\r\n  const actionsContent = document.getElementById('actions-content');\r\n  const spellsContent = document.getElementById('spells-content');\r\n  const featuresContent = document.getElementById('features-content');\r\n  const inventoryContent = document.getElementById('inventory-content');\r\n\r\n  if (statsContent) statsContent.innerHTML = '';\r\n  if (actionsContent) actionsContent.innerHTML = '';\r\n  if (spellsContent) spellsContent.innerHTML = '';\r\n  if (featuresContent) featuresContent.innerHTML = '';\r\n  if (inventoryContent) inventoryContent.innerHTML = '';\r\n}\r\n\r\n// ============== Event Handlers ==============\r\n\r\n/**\r\n * Sync character from DiceCloud\r\n */\r\nif (syncCharacterBtn) {\r\n  syncCharacterBtn.addEventListener('click', () => {\r\n    // Clear manual unsync flag to allow auto-syncing again\r\n    localStorage.removeItem('owlcloud_manual_unsync');\r\n\r\n    // Send message to browser extension to sync character\r\n    const message = {\r\n      type: 'OWLCLOUD_SYNC_CHARACTER',\r\n      source: 'owlbear-extension'\r\n    };\r\n\r\n    window.parent.postMessage(message, 'https://www.owlbear.rodeo');\r\n\r\n  // Show notification in Owlbear\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show('Syncing character from DiceCloud...', 'INFO');\r\n  }\r\n\r\n  // Update status\r\n  statusText.textContent = 'Syncing character...';\r\n\r\n  // Refresh character data after a delay\r\n  setTimeout(checkForActiveCharacter, 2000);\r\n  });\r\n}\r\n\r\n/**\r\n * Open browser extension popup\r\n */\r\nopenExtensionBtn.addEventListener('click', () => {\r\n  // Send message to browser extension to open popup\r\n  const message = {\r\n    type: 'OWLCLOUD_OPEN_POPUP',\r\n    source: 'owlbear-extension'\r\n  };\r\n\r\n  window.parent.postMessage(message, 'https://www.owlbear.rodeo');\r\n\r\n  alert('Please click the OwlCloud extension icon in your browser toolbar to select a character.');\r\n});\r\n\r\n/**\r\n * Toggle chat window\r\n */\r\nlet isChatOpen = false;\r\n\r\nif (openChatWindowBtn) {\r\n  openChatWindowBtn.addEventListener('click', async () => {\r\n    if (!isOwlbearReady) {\r\n      alert('Owlbear SDK not ready. Please wait a moment and try again.');\r\n      return;\r\n    }\r\n\r\n  if (isChatOpen) {\r\n    // Close the chat window\r\n    await OBR.popover.close('com.owlcloud.chat');\r\n    isChatOpen = false;\r\n    openChatWindowBtn.textContent = '\uD83D\uDCAC Open Chat Window';\r\n  } else {\r\n    // Set chat height to match CSS chat-container height\r\n    const chatHeight = 300;\r\n\r\n    // Open chat as a persistent popover at bottom-left\r\n    await OBR.popover.open({\r\n      id: 'com.owlcloud.chat',\r\n      url: '/extension/owlbear-extension/chat.html',\r\n      height: chatHeight,\r\n      width: 400,\r\n      anchorOrigin: { horizontal: 'LEFT', vertical: 'BOTTOM' },\r\n      transformOrigin: { horizontal: 'LEFT', vertical: 'BOTTOM' },\r\n      disableClickAway: true\r\n    });\r\n    isChatOpen = true;\r\n    openChatWindowBtn.textContent = '\uD83D\uDCAC Close Chat Window';\r\n  }\r\n  });\r\n}\r\n\r\n// ============== Message Listener ==============\r\n\r\n/**\r\n * Listen for messages from the browser extension content script\r\n */\r\nwindow.addEventListener('message', (event) => {\r\n  // Verify origin for security\r\n  if (event.origin !== 'https://www.owlbear.rodeo') {\r\n    return;\r\n  }\r\n\r\n  const { type, data } = event.data;\r\n\r\n  switch (type) {\r\n    case 'OWLCLOUD_ACTIVE_CHARACTER_RESPONSE':\r\n      // Check if user manually unsynced - don't auto-sync if they did\r\n      if (localStorage.getItem('owlcloud_manual_unsync') === 'true') {\r\n        console.log('\u2139\uFE0F Character auto-sync prevented - user manually unsynced. Use Sync button to re-sync.');\r\n        showNoCharacter();\r\n        break;\r\n      }\r\n\r\n      if (data && data.character) {\r\n        displayCharacter(data.character);\r\n      } else {\r\n        showNoCharacter();\r\n      }\r\n      break;\r\n\r\n    case 'OWLCLOUD_CHARACTER_UPDATED':\r\n      // Check if user manually unsynced - don't auto-update if they did\r\n      if (localStorage.getItem('owlcloud_manual_unsync') === 'true') {\r\n        console.log('\u2139\uFE0F Character auto-update prevented - user manually unsynced. Use Sync button to re-sync.');\r\n        break;\r\n      }\r\n\r\n      if (data && data.character) {\r\n        displayCharacter(data.character);\r\n        if (isOwlbearReady) {\r\n          OBR.notification.show(`Character updated: ${data.character.name}`, 'SUCCESS');\r\n        }\r\n      }\r\n      break;\r\n\r\n    case 'OWLCLOUD_SYNC_COMPLETE':\r\n      if (isOwlbearReady) {\r\n        OBR.notification.show('Character synced successfully', 'SUCCESS');\r\n      }\r\n      statusText.textContent = 'Connected to Owlbear Rodeo';\r\n      checkForActiveCharacter();\r\n      break;\r\n\r\n    case 'OWLCLOUD_ERROR':\r\n      if (isOwlbearReady) {\r\n        OBR.notification.show(`Error: ${data.message}`, 'ERROR');\r\n      }\r\n      statusText.textContent = `Error: ${data.message}`;\r\n      break;\r\n\r\n    default:\r\n      // Ignore unknown message types\r\n      break;\r\n  }\r\n});\r\n\r\n// ============== Dice Rolling Integration ==============\r\n\r\n/**\r\n * Post a dice roll to Owlbear chat\r\n * This will be called when the browser extension sends roll data\r\n */\r\nfunction postRollToOwlbear(rollData) {\r\n  if (!isOwlbearReady) {\r\n    console.warn('Owlbear not ready, cannot post roll');\r\n    return;\r\n  }\r\n\r\n  // Use Owlbear notification system to display roll\r\n  // TODO: In the future, this could create scene items or use a custom roll display\r\n  const rollResult = rollData.result || '?';\r\n  const rollName = rollData.name || 'Roll';\r\n  const characterName = rollData.characterName || 'Unknown';\r\n\r\n  OBR.notification.show(\r\n    `${characterName} rolled ${rollName}: ${rollResult}`,\r\n    'INFO'\r\n  );\r\n\r\n  console.log('\uD83C\uDFB2 Roll posted to Owlbear:', rollData);\r\n}\r\n\r\n// Listen for roll messages from browser extension\r\nwindow.addEventListener('message', (event) => {\r\n  if (event.origin !== 'https://www.owlbear.rodeo') {\r\n    return;\r\n  }\r\n\r\n  if (event.data.type === 'OWLCLOUD_POST_ROLL') {\r\n    postRollToOwlbear(event.data.data);\r\n  }\r\n});\r\n\r\n// ============== Chat Integration ==============\r\n\r\n/**\r\n * Send message to chat window via OBR metadata\r\n */\r\nasync function sendToChatWindow(type, data) {\r\n  if (!isOwlbearReady || !currentCharacter) return;\r\n\r\n  try {\r\n    const message = {\r\n      type: type,\r\n      data: data,\r\n      character: {\r\n        name: currentCharacter.name,\r\n        id: currentCharacter.id\r\n      },\r\n      timestamp: Date.now()\r\n    };\r\n\r\n    // Note: Removed latest-message metadata to save space (16KB limit)\r\n    // The chat window reads from the messages array instead\r\n  } catch (error) {\r\n    console.error('Error sending to chat:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Add a message to the shared chat history\r\n * This adds messages to the persistent chat that all players can see\r\n * @param {string} text - Message text\r\n * @param {string} type - Message type: 'system', 'roll', 'action', 'spell', 'combat', 'user'\r\n * @param {string} author - Message author (optional)\r\n */\r\nasync function addChatMessage(text, type = 'system', author = null, details = null) {\r\n  if (!isOwlbearReady) return;\r\n\r\n  try {\r\n    const playerId = await OBR.player.getId();\r\n    const metadata = await OBR.room.getMetadata();\r\n    const messages = metadata['com.owlcloud.chat/messages'] || [];\r\n\r\n    // Strip HTML tags and truncate to reduce metadata size\r\n    const plainText = text.replace(/<[^>]*>/g, '');\r\n    const truncatedText = plainText.length > 500 ? plainText.substring(0, 497) + '...' : plainText;\r\n\r\n    // Truncate details as well if present\r\n    let truncatedDetails = null;\r\n    if (details) {\r\n      const plainDetails = details.replace(/<[^>]*>/g, '');\r\n      truncatedDetails = plainDetails.length > 300 ? plainDetails.substring(0, 297) + '...' : plainDetails;\r\n    }\r\n\r\n    const newMessage = {\r\n      id: Date.now() + Math.random(),\r\n      text: truncatedText,\r\n      type: type,\r\n      author: author || (currentCharacter ? currentCharacter.name : 'Character'),\r\n      playerId: playerId,\r\n      timestamp: Date.now(),\r\n      details: truncatedDetails // Optional expandable details (truncated)\r\n    };\r\n\r\n    // Auto-cleanup: Remove messages older than 30 minutes\r\n    const thirtyMinutesAgo = Date.now() - (30 * 60 * 1000);\r\n    const recentMessages = messages.filter(msg => msg.timestamp > thirtyMinutesAgo);\r\n\r\n    // Keep last 10 messages (reduced from 20 to save space)\r\n    const updatedMessages = [...recentMessages, newMessage].slice(-10);\r\n\r\n    await OBR.room.setMetadata({\r\n      'com.owlcloud.chat/messages': updatedMessages\r\n    });\r\n\r\n    console.log('\uD83D\uDCE8 Chat message added:', text);\r\n  } catch (error) {\r\n    console.error('Error adding chat message:', error);\r\n  }\r\n}\r\n\r\n// ============== Dice Rolling System ==============\r\n\r\n/**\r\n * Roll dice and return result\r\n * @param {string} formula - Dice formula like \"1d20+5\" or \"2d6\"\r\n * @returns {object} - {total, rolls, formula}\r\n */\r\n/**\r\n * Set roll mode (advantage, normal, disadvantage)\r\n */\r\nwindow.setRollMode = async function(mode) {\r\n  rollMode = mode;\r\n\r\n  // Update button active states\r\n  document.querySelectorAll('.roll-mode-btn').forEach(btn => btn.classList.remove('active'));\r\n  if (mode === 'advantage') {\r\n    document.getElementById('roll-advantage-btn')?.classList.add('active');\r\n  } else if (mode === 'disadvantage') {\r\n    document.getElementById('roll-disadvantage-btn')?.classList.add('active');\r\n  } else {\r\n    document.getElementById('roll-normal-btn')?.classList.add('active');\r\n  }\r\n\r\n  // Store roll mode in player metadata so chat window can access it\r\n  if (isOwlbearReady) {\r\n    try {\r\n      await OBR.player.setMetadata({\r\n        'owlcloud.rollMode': mode\r\n      });\r\n    } catch (error) {\r\n      console.error('Failed to set roll mode metadata:', error);\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Roll a d20 with advantage/disadvantage based on current roll mode\r\n * Uses Dice+ if available, falls back to local rolling\r\n */\r\nasync function rollD20(name, modifier = 0) {\r\n  // Prepare dice notation for Dice+\r\n  let diceNotation;\r\n  if (rollMode === 'advantage') {\r\n    diceNotation = '2d20kh1'; // Keep highest\r\n  } else if (rollMode === 'disadvantage') {\r\n    diceNotation = '2d20kl1'; // Keep lowest\r\n  } else {\r\n    diceNotation = '1d20';\r\n  }\r\n\r\n  // Add modifier to notation\r\n  if (modifier !== 0) {\r\n    diceNotation += (modifier >= 0 ? '+' : '') + modifier;\r\n  }\r\n\r\n  const rollContext = {\r\n    name,\r\n    modifier,\r\n    type: 'd20',\r\n    mode: rollMode\r\n  };\r\n\r\n  // Try Dice+ first\r\n  const rollId = await sendToDicePlus(diceNotation, rollContext);\r\n  if (rollId) {\r\n    // Dice+ will handle the result via the listener\r\n    return { pending: true, rollId };\r\n  }\r\n\r\n  // Fall back to local roll\r\n  return rollD20Local();\r\n}\r\n\r\n/**\r\n * Local d20 roll (fallback when Dice+ unavailable)\r\n */\r\nfunction rollD20Local() {\r\n  if (rollMode === 'advantage') {\r\n    const roll1 = Math.floor(Math.random() * 20) + 1;\r\n    const roll2 = Math.floor(Math.random() * 20) + 1;\r\n    const total = Math.max(roll1, roll2);\r\n    return {total, rolls: [roll1, roll2], modifier: 0, formula: '2d20 (advantage)', count: 2, sides: 20, mode: 'advantage'};\r\n  } else if (rollMode === 'disadvantage') {\r\n    const roll1 = Math.floor(Math.random() * 20) + 1;\r\n    const roll2 = Math.floor(Math.random() * 20) + 1;\r\n    const total = Math.min(roll1, roll2);\r\n    return {total, rolls: [roll1, roll2], modifier: 0, formula: '2d20 (disadvantage)', count: 2, sides: 20, mode: 'disadvantage'};\r\n  } else {\r\n    const roll = Math.floor(Math.random() * 20) + 1;\r\n    return {total: roll, rolls: [roll], modifier: 0, formula: '1d20', count: 1, sides: 20, mode: 'normal'};\r\n  }\r\n}\r\n\r\n/**\r\n * Roll dice using formula (tries Dice+ first, falls back to local)\r\n */\r\nasync function rollDice(formula, name, modifier = 0) {\r\n  const rollContext = {\r\n    name,\r\n    modifier,\r\n    formula,\r\n    type: 'custom'\r\n  };\r\n\r\n  // Try Dice+ first\r\n  const rollId = await sendToDicePlus(formula, rollContext);\r\n  if (rollId) {\r\n    return { pending: true, rollId };\r\n  }\r\n\r\n  // Fall back to local\r\n  return rollDiceLocal(formula);\r\n}\r\n\r\n/**\r\n * Local dice roll (fallback when Dice+ unavailable)\r\n */\r\nfunction rollDiceLocal(formula) {\r\n  // Parse formula like \"2d6+3\" or \"1d20\"\r\n  const match = formula.match(/(\\d+)?d(\\d+)([+-]\\d+)?/i);\r\n  if (!match) {\r\n    console.error('Invalid dice formula:', formula);\r\n    return {total: 0, rolls: [], formula};\r\n  }\r\n\r\n  const count = parseInt(match[1] || '1');\r\n  const sides = parseInt(match[2]);\r\n  const modifier = parseInt(match[3] || '0');\r\n\r\n  const rolls = [];\r\n  let total = modifier;\r\n\r\n  for (let i = 0; i < count; i++) {\r\n    const roll = Math.floor(Math.random() * sides) + 1;\r\n    rolls.push(roll);\r\n    total += roll;\r\n  }\r\n\r\n  return {total, rolls, modifier, formula, count, sides};\r\n}\r\n\r\n/**\r\n * Show roll result notification and send to chat\r\n */\r\nasync function showRollResult(name, result) {\r\n  let detailsHtml = '';\r\n  // Use override value from Dice+ if available, otherwise calculate normally\r\n  const finalTotal = result._overrideFinal !== undefined ? result._overrideFinal : (result.modifier !== undefined ? result.total + result.modifier : result.total);\r\n  \r\n  console.log('\uD83D\uDD0D showRollResult debug:', {\r\n    name,\r\n    resultTotal: result.total,\r\n    resultModifier: result.modifier,\r\n    overrideFinal: result._overrideFinal,\r\n    calculatedFinalTotal: finalTotal\r\n  });\r\n\r\n  // Build detailed breakdown for expandable section\r\n  if (result.mode === 'advantage' && result.rolls.length === 2) {\r\n    detailsHtml = `<strong>Advantage:</strong> Rolled 2d20, taking higher<br>\r\n                   Roll 1: ${result.rolls[0]}<br>\r\n                   Roll 2: ${result.rolls[1]}<br>\r\n                   <strong>Selected:</strong> ${result.total}`;\r\n    if (result.modifier !== 0) {\r\n      detailsHtml += `<br><strong>Modifier:</strong> ${result.modifier >= 0 ? '+' : ''}${result.modifier}`;\r\n    }\r\n    detailsHtml += `<br><strong>Formula:</strong> ${result.total}`;\r\n    if (result.modifier !== 0) {\r\n      detailsHtml += ` ${result.modifier >= 0 ? '+' : ''}${result.modifier}`;\r\n    }\r\n    detailsHtml += ` = ${finalTotal}`;\r\n  } else if (result.mode === 'disadvantage' && result.rolls.length === 2) {\r\n    detailsHtml = `<strong>Disadvantage:</strong> Rolled 2d20, taking lower<br>\r\n                   Roll 1: ${result.rolls[0]}<br>\r\n                   Roll 2: ${result.rolls[1]}<br>\r\n                   <strong>Selected:</strong> ${result.total}`;\r\n    if (result.modifier !== 0) {\r\n      detailsHtml += `<br><strong>Modifier:</strong> ${result.modifier >= 0 ? '+' : ''}${result.modifier}`;\r\n    }\r\n    detailsHtml += `<br><strong>Formula:</strong> ${result.total}`;\r\n    if (result.modifier !== 0) {\r\n      detailsHtml += ` ${result.modifier >= 0 ? '+' : ''}${result.modifier}`;\r\n    }\r\n    detailsHtml += ` = ${finalTotal}`;\r\n  } else {\r\n    // Normal roll details\r\n    detailsHtml = `<strong>Roll:</strong> 1d20 = ${result.rolls[0]}`;\r\n    if (result.modifier !== 0) {\r\n      detailsHtml += `<br><strong>Modifier:</strong> ${result.modifier >= 0 ? '+' : ''}${result.modifier}`;\r\n    }\r\n    detailsHtml += `<br><strong>Formula:</strong> ${result.rolls[0]}`;\r\n    if (result.modifier !== 0) {\r\n      detailsHtml += ` ${result.modifier >= 0 ? '+' : ''}${result.modifier}`;\r\n    }\r\n    detailsHtml += ` = ${finalTotal}`;\r\n  }\r\n\r\n  // Create concise message showing just the result\r\n  // Don't double-add modifier if it's already in the name\r\n  const modText = result.modifier !== 0 && !name.includes(`(${result.modifier >= 0 ? '+' : ''}${result.modifier})`) \r\n    ? ` (${result.modifier >= 0 ? '+' : ''}${result.modifier})` \r\n    : '';\r\n  const message = `${name}${modText}: <strong>${finalTotal}</strong>`;\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`${currentCharacter?.name || 'Character'}: ${name} = ${finalTotal}`, 'INFO');\r\n  }\r\n  console.log('\uD83C\uDFB2', message);\r\n\r\n  // Send to persistent chat with expandable details\r\n  await addChatMessage(message, 'roll', currentCharacter?.name, detailsHtml);\r\n}\r\n\r\n/**\r\n * Roll ability check\r\n */\r\nwindow.rollAbilityCheck = async function(abilityName, modifier) {\r\n  console.log('\uD83C\uDFB2 rollAbilityCheck called:', abilityName, modifier);\r\n  const name = `${abilityName} Check (${modifier >= 0 ? '+' : ''}${modifier})`;\r\n  const result = await rollD20(name, modifier);\r\n\r\n  // If using Dice+, result will be handled by listener\r\n  if (result.pending) return;\r\n\r\n  // Otherwise show local result\r\n  const total = result.total + modifier;\r\n  await showRollResult(name, {...result, total, modifier});\r\n};\r\n\r\n/**\r\n * Roll saving throw\r\n */\r\nwindow.rollSavingThrow = async function(abilityName, modifier) {\r\n  console.log('\uD83C\uDFB2 rollSavingThrow called:', abilityName, modifier);\r\n  const name = `${abilityName} Save (${modifier >= 0 ? '+' : ''}${modifier})`;\r\n  const result = await rollD20(name, modifier);\r\n\r\n  if (result.pending) return;\r\n\r\n  const total = result.total + modifier;\r\n  await showRollResult(name, {...result, total, modifier});\r\n};\r\n\r\n/**\r\n * Roll skill check\r\n */\r\nwindow.rollSkillCheck = async function(skillName, bonus) {\r\n  const name = `${skillName} (${bonus >= 0 ? '+' : ''}${bonus})`;\r\n  const result = await rollD20(name, bonus);\r\n\r\n  if (result.pending) return;\r\n\r\n  const total = result.total + bonus;\r\n  await showRollResult(name, {...result, total, modifier: bonus});\r\n};\r\n\r\n/**\r\n * Roll initiative\r\n */\r\nwindow.rollInitiative = async function(initiativeBonus) {\r\n  const name = `Initiative (${initiativeBonus >= 0 ? '+' : ''}${initiativeBonus})`;\r\n  const result = await rollD20(name, initiativeBonus);\r\n\r\n  if (result.pending) return;\r\n\r\n  const total = result.total + initiativeBonus;\r\n  await showRollResult(name, {...result, total, modifier: initiativeBonus});\r\n};\r\n\r\n/**\r\n * Roll death save\r\n */\r\nwindow.rollDeathSave = async function() {\r\n  if (!currentCharacter) return;\r\n\r\n  const result = await rollDice('1d20', 'Death Save', 0);\r\n\r\n  // If using Dice+, we need to handle it differently\r\n  if (result.pending) {\r\n    // Store the context for the death save handler\r\n    const rollContext = pendingRolls.get(result.rollId);\r\n    if (rollContext) {\r\n      rollContext.isDeathSave = true;\r\n    }\r\n    return;\r\n  }\r\n\r\n  const roll = result.total;\r\n\r\n  let message = '';\r\n  let messageType = 'combat';\r\n\r\n  if (roll === 20) {\r\n    message = `\uD83D\uDC80 Death Save: <strong>20 (Natural 20!)</strong> - Regain 1 HP!`;\r\n    // Automatically heal 1 HP on nat 20\r\n    if (!currentCharacter.hitPoints) {\r\n      currentCharacter.hitPoints = { current: 0, max: 0 };\r\n    }\r\n    currentCharacter.hitPoints.current = 1;\r\n    populateStatsTab(currentCharacter);\r\n  } else if (roll === 1) {\r\n    message = `\uD83D\uDC80 Death Save: <strong>1 (Natural 1!)</strong> - Two failures!`;\r\n  } else if (roll >= 10) {\r\n    message = `\uD83D\uDC80 Death Save: <strong>${roll}</strong> - Success`;\r\n  } else {\r\n    message = `\uD83D\uDC80 Death Save: <strong>${roll}</strong> - Failure`;\r\n  }\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`${currentCharacter.name}: Death Save = ${roll}`, roll >= 10 ? 'SUCCESS' : 'ERROR');\r\n  }\r\n  console.log('\uD83D\uDC80', message);\r\n\r\n  // Send to persistent chat\r\n  await addChatMessage(message, messageType, currentCharacter.name);\r\n};\r\n\r\n/**\r\n * Roll attack only (no damage)\r\n */\r\nwindow.rollAttackOnly = async function(actionName, attackBonus) {\r\n  const bonusText = attackBonus ? ` (+${attackBonus})` : '';\r\n  const name = `${actionName} Attack${bonusText}`;\r\n  const attackRoll = await rollD20(name, attackBonus || 0);\r\n\r\n  // If using Dice+, result will be handled by listener\r\n  if (attackRoll.pending) return;\r\n\r\n  const attackTotal = attackRoll.total + (attackBonus || 0);\r\n\r\n  // Create concise message\r\n  const message = `${actionName} Attack${bonusText}: <strong>${attackTotal}</strong>`;\r\n\r\n  // Build details for expandable view\r\n  let detailsHtml = '';\r\n  if (attackRoll.mode === 'advantage' && attackRoll.rolls.length === 2) {\r\n    detailsHtml = `<strong>Advantage:</strong> Rolled 2d20, taking higher<br>\r\n                   Roll 1: ${attackRoll.rolls[0]}<br>\r\n                   Roll 2: ${attackRoll.rolls[1]}<br>\r\n                   <strong>Selected:</strong> ${attackRoll.total}`;\r\n  } else if (attackRoll.mode === 'disadvantage' && attackRoll.rolls.length === 2) {\r\n    detailsHtml = `<strong>Disadvantage:</strong> Rolled 2d20, taking lower<br>\r\n                   Roll 1: ${attackRoll.rolls[0]}<br>\r\n                   Roll 2: ${attackRoll.rolls[1]}<br>\r\n                   <strong>Selected:</strong> ${attackRoll.total}`;\r\n  } else {\r\n    detailsHtml = `<strong>Attack Roll:</strong> 1d20 = ${attackRoll.rolls[0]}`;\r\n  }\r\n  if (attackBonus) {\r\n    detailsHtml += `<br><strong>Attack Bonus:</strong> +${attackBonus}`;\r\n  }\r\n  detailsHtml += `<br><strong>Formula:</strong> ${attackRoll.total}`;\r\n  if (attackBonus) {\r\n    detailsHtml += ` + ${attackBonus}`;\r\n  }\r\n  detailsHtml += ` = ${attackTotal}`;\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`${currentCharacter?.name || 'Character'}: ${actionName} Attack = ${attackTotal}`, 'INFO');\r\n  }\r\n  console.log('\u2694\uFE0F', message);\r\n\r\n  // Send to persistent chat with details\r\n  await addChatMessage(message, 'action', currentCharacter?.name, detailsHtml);\r\n};\r\n\r\n/**\r\n * Roll damage only (no attack)\r\n */\r\nwindow.rollDamageOnly = async function(actionName, damageFormula) {\r\n  if (!damageFormula || !damageFormula.trim()) return;\r\n\r\n  const name = `${actionName} Damage`;\r\n  const damageRoll = await rollDice(damageFormula, name, 0);\r\n\r\n  // If using Dice+, store additional context for damage display\r\n  if (damageRoll.pending) {\r\n    const rollContext = pendingRolls.get(damageRoll.rollId);\r\n    if (rollContext) {\r\n      rollContext.isDamageRoll = true;\r\n      rollContext.actionName = actionName;\r\n      rollContext.damageFormula = damageFormula;\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Create concise message\r\n  const message = `${actionName} Damage: <strong>${damageRoll.total}</strong>`;\r\n\r\n  // Build details for expandable view\r\n  let detailsHtml = `<strong>Formula:</strong> ${damageFormula}<br>\r\n                     <strong>Rolls:</strong> ${damageRoll.rolls.join(', ')}`;\r\n  if (damageRoll.modifier) {\r\n    detailsHtml += `<br>Modifier: ${damageRoll.modifier >= 0 ? '+' : ''}${damageRoll.modifier}`;\r\n  }\r\n  detailsHtml += `<br>Calculation: ${damageRoll.rolls.join(' + ')}`;\r\n  if (damageRoll.modifier) {\r\n    detailsHtml += ` ${damageRoll.modifier >= 0 ? '+' : ''}${damageRoll.modifier}`;\r\n  }\r\n  detailsHtml += ` = ${damageRoll.total}`;\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`${currentCharacter?.name || 'Character'}: ${actionName} Damage = ${damageRoll.total}`, 'INFO');\r\n  }\r\n  console.log('\u2694\uFE0F', message);\r\n\r\n  // Send to persistent chat with details\r\n  await addChatMessage(message, 'damage', currentCharacter?.name, detailsHtml);\r\n};\r\n\r\n/**\r\n * Roll healing\r\n */\r\nwindow.rollHealing = async function(spellName, healingFormula) {\r\n  if (!healingFormula || !healingFormula.trim()) return;\r\n\r\n  const healingRoll = rollDice(healingFormula);\r\n\r\n  // Create concise message\r\n  const message = `${spellName} Healing: <strong>${healingRoll.total}</strong>`;\r\n\r\n  // Build details for expandable view\r\n  let detailsHtml = `<strong>Formula:</strong> ${healingFormula}<br>\r\n                     <strong>Rolls:</strong> ${healingRoll.rolls.join(', ')}`;\r\n  if (healingRoll.modifier) {\r\n    detailsHtml += `<br>Modifier: ${healingRoll.modifier >= 0 ? '+' : ''}${healingRoll.modifier}`;\r\n  }\r\n  detailsHtml += `<br>Calculation: ${healingRoll.rolls.join(' + ')}`;\r\n  if (healingRoll.modifier) {\r\n    detailsHtml += ` ${healingRoll.modifier >= 0 ? '+' : ''}${healingRoll.modifier}`;\r\n  }\r\n  detailsHtml += ` = ${healingRoll.total}`;\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`${currentCharacter?.name || 'Character'}: ${spellName} Healing = ${healingRoll.total}`, 'INFO');\r\n  }\r\n  console.log('\uD83D\uDC9A', message);\r\n\r\n  // Send to persistent chat with details (using 'healing' type for green color)\r\n  await addChatMessage(message, 'healing', currentCharacter?.name, detailsHtml);\r\n};\r\n\r\n/**\r\n * Roll attack (kept for backwards compatibility, calls both)\r\n */\r\nwindow.rollAttack = async function(actionName, attackBonus, damageFormula) {\r\n  await rollAttackOnly(actionName, attackBonus);\r\n  if (damageFormula && damageFormula.trim()) {\r\n    await rollDamageOnly(actionName, damageFormula);\r\n  }\r\n};\r\n\r\n// ============== Spell Casting ==============\r\n\r\n/**\r\n * Prompt for spell level and cast\r\n */\r\nwindow.promptCastSpell = async function(spellName, baseLevel) {\r\n  if (!currentCharacter || !currentCharacter.spellSlots) return;\r\n\r\n  // Build list of available spell slots (baseLevel and higher)\r\n  const availableSlots = [];\r\n  for (let level = baseLevel; level <= 9; level++) {\r\n    const slotKey = `level${level}SpellSlots`;\r\n    const current = currentCharacter.spellSlots[slotKey] || 0;\r\n    if (current > 0) {\r\n      availableSlots.push({\r\n        level: level,\r\n        remaining: current\r\n      });\r\n    }\r\n  }\r\n\r\n  if (availableSlots.length === 0) {\r\n    if (isOwlbearReady) {\r\n      OBR.notification.show(`No spell slots available to cast ${spellName}!`, 'ERROR');\r\n    }\r\n    return;\r\n  }\r\n\r\n  // If only one option, cast directly\r\n  if (availableSlots.length === 1) {\r\n    await castSpell(spellName, availableSlots[0].level);\r\n    return;\r\n  }\r\n\r\n  // Otherwise, show modal for level selection\r\n  showSpellLevelModal(spellName, availableSlots);\r\n};\r\n\r\n/**\r\n * Show the spell level selection modal\r\n */\r\nfunction showSpellLevelModal(spellName, availableSlots) {\r\n  const modal = document.getElementById('spell-level-modal');\r\n  const modalSpellName = document.getElementById('modal-spell-name');\r\n  const optionsContainer = document.getElementById('spell-level-options');\r\n\r\n  // Set spell name\r\n  modalSpellName.textContent = `Cast ${spellName}`;\r\n\r\n  // Build options\r\n  optionsContainer.innerHTML = '';\r\n  availableSlots.forEach(slot => {\r\n    const option = document.createElement('div');\r\n    option.className = 'spell-level-option';\r\n    option.onclick = async () => {\r\n      closeSpellLevelModal();\r\n      await castSpell(spellName, slot.level);\r\n    };\r\n\r\n    option.innerHTML = `\r\n      <span class=\"spell-level-label\">Level ${slot.level}</span>\r\n      <span class=\"spell-level-slots\">${slot.remaining} slot${slot.remaining !== 1 ? 's' : ''} remaining</span>\r\n    `;\r\n\r\n    optionsContainer.appendChild(option);\r\n  });\r\n\r\n  // Show modal\r\n  modal.style.display = 'flex';\r\n}\r\n\r\n/**\r\n * Close the spell level selection modal\r\n */\r\nwindow.closeSpellLevelModal = function() {\r\n  const modal = document.getElementById('spell-level-modal');\r\n  modal.style.display = 'none';\r\n};\r\n\r\n/**\r\n * Cast a spell\r\n */\r\nwindow.castSpell = async function(spellName, level) {\r\n  if (!currentCharacter) return;\r\n\r\n  // Find the spell object to get all details\r\n  const spell = currentCharacter.spells?.find(s => s.name === spellName);\r\n  const spellBaseLevel = spell ? parseInt(spell.level) || 0 : level;\r\n  const isUpcast = level > spellBaseLevel;\r\n\r\n  // Cantrips don't use spell slots\r\n  let slotKey = null;\r\n  if (level > 0) {\r\n    if (!currentCharacter.spellSlots) {\r\n      console.warn('No spell slots available on character');\r\n      return;\r\n    }\r\n\r\n    slotKey = `level${level}SpellSlots`;\r\n    const current = currentCharacter.spellSlots[slotKey] || 0;\r\n\r\n    if (current === 0) {\r\n      if (isOwlbearReady) {\r\n        OBR.notification.show(`No Level ${level} spell slots remaining!`, 'ERROR');\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Decrement spell slot\r\n    currentCharacter.spellSlots[slotKey] = current - 1;\r\n    populateStatsTab(currentCharacter);\r\n  }\r\n\r\n  const levelText = level === 0 ? 'Cantrip' : `Level ${level} Spell`;\r\n  const message = `\u2728 Casts <strong>${spellName}</strong> (${levelText})`;\r\n\r\n  // Create expandable details with ALL spell information\r\n  let details = `<strong>${spellName}</strong><br><strong>Level:</strong> ${levelText}`;\r\n\r\n  if (isUpcast && spellBaseLevel > 0) {\r\n    details += ` (Upcast from Level ${spellBaseLevel})`;\r\n  }\r\n\r\n  if (spell) {\r\n    if (spell.castingTime) details += `<br><strong>Casting Time:</strong> ${spell.castingTime}`;\r\n    if (spell.range) details += `<br><strong>Range:</strong> ${spell.range}`;\r\n    if (spell.components) details += `<br><strong>Components:</strong> ${spell.components}`;\r\n    if (spell.duration) details += `<br><strong>Duration:</strong> ${spell.duration}`;\r\n    if (spell.concentration) details += `<br><strong>Concentration:</strong> Yes`;\r\n    if (spell.ritual) details += `<br><strong>Ritual:</strong> Yes`;\r\n    if (spell.attackRoll) details += `<br><strong>Attack:</strong> ${spell.attackRoll}`;\r\n    if (spell.damage) details += `<br><strong>Damage:</strong> ${spell.damage}`;\r\n    if (spell.healing) details += `<br><strong>Healing:</strong> ${spell.healing}`;\r\n    if (spell.summary) details += `<br><br>${spell.summary}`;\r\n    if (spell.description) details += `<br><br>${spell.description}`;\r\n  }\r\n\r\n  if (level > 0 && slotKey) {\r\n    const remaining = currentCharacter.spellSlots[slotKey] || 0;\r\n    details += `<br><br><strong>Spell Slot Used:</strong> Level ${level}<br><strong>Remaining Slots:</strong> ${remaining}`;\r\n  }\r\n\r\n  // Auto-enable concentration if the spell requires it\r\n  if (spell && spell.concentration) {\r\n    const characterId = currentCharacter._id || currentCharacter.id || currentCharacter.name;\r\n    const previousSpell = concentratingSpell;\r\n\r\n    // Set concentration\r\n    concentratingSpell = spellName;\r\n    concentrationByCharacter.set(characterId, spellName);\r\n\r\n    // Notify if switching concentration\r\n    if (previousSpell && previousSpell !== spellName) {\r\n      console.log(`[OwlCloud] Concentration switched from ${previousSpell} to ${spellName}`);\r\n      if (isOwlbearReady) {\r\n        OBR.notification.show(`Concentration switched from ${previousSpell} to ${spellName}`, 'WARNING');\r\n      }\r\n    } else {\r\n      console.log(`[OwlCloud] Now concentrating on ${spellName}`);\r\n    }\r\n\r\n    // Update spells tab to show concentration badge as active\r\n    populateSpellsTab(currentCharacter);\r\n  }\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`${currentCharacter?.name || 'Character'} casts ${spellName}`, 'INFO');\r\n  }\r\n  console.log('\u2728', message);\r\n\r\n  // Send to persistent chat with details\r\n  await addChatMessage(message, 'spell', currentCharacter?.name, details);\r\n};\r\n\r\n/**\r\n * Cast a spell as a ritual (doesn't consume spell slot)\r\n */\r\nwindow.castSpellAsRitual = async function(spellName) {\r\n  if (!currentCharacter) return;\r\n\r\n  // Find the spell object to get all details\r\n  const spell = currentCharacter.spells?.find(s => s.name === spellName);\r\n\r\n  const message = `\uD83D\uDCFF Casts <strong>${spellName}</strong> as a ritual`;\r\n\r\n  // Create expandable details with ALL spell information\r\n  let details = `<strong>${spellName}</strong><br><strong>Cast as Ritual</strong> (no spell slot consumed)`;\r\n\r\n  if (spell) {\r\n    const spellLevel = parseInt(spell.level) || 0;\r\n    const levelText = spellLevel === 0 ? 'Cantrip' : `Level ${spellLevel} Spell`;\r\n    details += `<br><strong>Level:</strong> ${levelText}`;\r\n\r\n    if (spell.castingTime) {\r\n      // Ritual casting adds 10 minutes\r\n      details += `<br><strong>Casting Time:</strong> ${spell.castingTime} + 10 minutes (ritual)`;\r\n    }\r\n    if (spell.range) details += `<br><strong>Range:</strong> ${spell.range}`;\r\n    if (spell.components) details += `<br><strong>Components:</strong> ${spell.components}`;\r\n    if (spell.duration) details += `<br><strong>Duration:</strong> ${spell.duration}`;\r\n    if (spell.concentration) details += `<br><strong>Concentration:</strong> Yes`;\r\n    if (spell.attackRoll) details += `<br><strong>Attack:</strong> ${spell.attackRoll}`;\r\n    if (spell.damage) details += `<br><strong>Damage:</strong> ${spell.damage}`;\r\n    if (spell.healing) details += `<br><strong>Healing:</strong> ${spell.healing}`;\r\n    if (spell.summary) details += `<br><br>${spell.summary}`;\r\n    if (spell.description) details += `<br><br>${spell.description}`;\r\n  }\r\n\r\n  // Auto-enable concentration if the spell requires it\r\n  if (spell && spell.concentration) {\r\n    const characterId = currentCharacter._id || currentCharacter.id || currentCharacter.name;\r\n    const previousSpell = concentratingSpell;\r\n\r\n    // Set concentration\r\n    concentratingSpell = spellName;\r\n    concentrationByCharacter.set(characterId, spellName);\r\n\r\n    // Notify if switching concentration\r\n    if (previousSpell && previousSpell !== spellName) {\r\n      console.log(`[OwlCloud] Concentration switched from ${previousSpell} to ${spellName}`);\r\n      if (isOwlbearReady) {\r\n        OBR.notification.show(`Concentration switched from ${previousSpell} to ${spellName}`, 'WARNING');\r\n      }\r\n    } else {\r\n      console.log(`[OwlCloud] Now concentrating on ${spellName}`);\r\n    }\r\n\r\n    // Update spells tab to show concentration badge as active\r\n    populateSpellsTab(currentCharacter);\r\n  }\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`${currentCharacter?.name || 'Character'} casts ${spellName} as a ritual`, 'INFO');\r\n  }\r\n  console.log('\uD83D\uDCFF', message);\r\n\r\n  // Send to persistent chat with details\r\n  await addChatMessage(message, 'spell', currentCharacter?.name, details);\r\n};\r\n\r\n/**\r\n * Toggle concentration on a spell\r\n */\r\nwindow.toggleConcentration = function(spellName) {\r\n  if (!currentCharacter) return;\r\n\r\n  // Toggle concentration\r\n  if (concentratingSpell === spellName) {\r\n    // Already concentrating on this spell - stop concentration\r\n    concentratingSpell = null;\r\n    console.log(`[OwlCloud] Stopped concentrating on ${spellName}`);\r\n    if (isOwlbearReady) {\r\n      OBR.notification.show(`Concentration on ${spellName} ended`, 'INFO');\r\n    }\r\n  } else {\r\n    // Start concentrating on this spell (ends previous concentration)\r\n    const previousSpell = concentratingSpell;\r\n    concentratingSpell = spellName;\r\n    console.log(`[OwlCloud] Now concentrating on ${spellName}`);\r\n    if (isOwlbearReady) {\r\n      if (previousSpell) {\r\n        OBR.notification.show(`Concentration switched from ${previousSpell} to ${spellName}`, 'WARNING');\r\n      } else {\r\n        OBR.notification.show(`Concentrating on ${spellName}`, 'INFO');\r\n      }\r\n    }\r\n  }\r\n\r\n  // Re-render spells tab to update UI\r\n  populateSpellsTab(currentCharacter);\r\n};\r\n\r\n// ============== HP & Resource Management ==============\r\n\r\n/**\r\n * Adjust HP\r\n */\r\nwindow.adjustHP = async function() {\r\n  if (!currentCharacter) return;\r\n\r\n  console.log('\uD83E\uDE7A adjustHP called, current character:', currentCharacter.name);\r\n  console.log('  Current HP object:', currentCharacter.hitPoints);\r\n\r\n  const currentHP = currentCharacter.hitPoints?.current || 0;\r\n  const maxHP = currentCharacter.hitPoints?.max || 0;\r\n\r\n  const adjustment = prompt(`Current HP: ${currentHP}/${maxHP}\\n\\nEnter HP adjustment (negative for damage, positive for healing):`);\r\n  if (adjustment === null) return;\r\n\r\n  const amount = parseInt(adjustment);\r\n  if (isNaN(amount)) return;\r\n\r\n  const newHP = Math.max(0, Math.min(maxHP, currentHP + amount));\r\n\r\n  console.log(`  Adjustment: ${amount}, New HP: ${newHP}/${maxHP}`);\r\n\r\n  // Ensure hitPoints object exists\r\n  if (!currentCharacter.hitPoints) {\r\n    currentCharacter.hitPoints = { current: 0, max: 0 };\r\n  }\r\n\r\n  // Update character data\r\n  currentCharacter.hitPoints.current = newHP;\r\n  console.log('  Updated currentCharacter.hitPoints:', currentCharacter.hitPoints);\r\n\r\n  // Show notification\r\n  const message = amount > 0\r\n    ? `${currentCharacter.name} heals ${amount} HP (${newHP}/${maxHP})`\r\n    : `${currentCharacter.name} takes ${Math.abs(amount)} damage (${newHP}/${maxHP})`;\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(message, amount > 0 ? 'SUCCESS' : 'WARNING');\r\n  }\r\n\r\n  // Send message to chat (use different type for healing vs damage)\r\n  const messageType = amount > 0 ? 'healing' : 'damage';\r\n  console.log('  Sending message to chat:', message);\r\n  await addChatMessage(message, messageType, currentCharacter.name);\r\n\r\n  // Re-render stats tab\r\n  console.log('  Re-rendering stats tab with currentCharacter:', currentCharacter.hitPoints);\r\n  populateStatsTab(currentCharacter);\r\n\r\n  // Note: HP changes are kept local during gameplay. They persist in the extension state\r\n  // until the user syncs the character or switches characters. This avoids constantly\r\n  // hitting Supabase for every stat change during play.\r\n};\r\n\r\n/**\r\n * Adjust spell slot count\r\n */\r\nwindow.adjustSpellSlot = function(level, isPactMagic = false) {\r\n  if (!currentCharacter || !currentCharacter.spellSlots) return;\r\n\r\n  const slotKey = isPactMagic ? 'pactMagicSlots' : `level${level}SpellSlots`;\r\n  const maxKey = isPactMagic ? 'pactMagicSlotsMax' : `level${level}SpellSlotsMax`;\r\n  const current = currentCharacter.spellSlots[slotKey] || 0;\r\n  const max = currentCharacter.spellSlots[maxKey] || 0;\r\n\r\n  const slotName = isPactMagic ? `Pact Magic` : `Level ${level} Spell Slot`;\r\n  const adjustment = prompt(`${slotName}: ${current}/${max}\\n\\nEnter adjustment (negative to use, positive to restore):`);\r\n  if (adjustment === null) return;\r\n\r\n  const amount = parseInt(adjustment);\r\n  if (isNaN(amount)) return;\r\n\r\n  const newCount = Math.max(0, Math.min(max, current + amount));\r\n  currentCharacter.spellSlots[slotKey] = newCount;\r\n\r\n  // Re-render stats tab\r\n  populateStatsTab(currentCharacter);\r\n\r\n  if (isOwlbearReady) {\r\n    const message = amount > 0 ? `Restored ${amount} ${slotName}` : `Used ${Math.abs(amount)} ${slotName}`;\r\n    OBR.notification.show(message, 'INFO');\r\n  }\r\n};\r\n\r\n/**\r\n * Adjust class resource (like Channel Divinity, Ki Points, etc.)\r\n */\r\nwindow.adjustResource = function(resourceName) {\r\n  if (!currentCharacter || !currentCharacter.resources) return;\r\n\r\n  const resource = currentCharacter.resources.find(r => r.name === resourceName);\r\n  if (!resource) return;\r\n\r\n  const current = resource.current || 0;\r\n  const max = resource.max || 0;\r\n\r\n  const adjustment = prompt(`${resourceName}: ${current}/${max}\\n\\nEnter adjustment (negative to use, positive to restore):`);\r\n  if (adjustment === null) return;\r\n\r\n  const amount = parseInt(adjustment);\r\n  if (isNaN(amount)) return;\r\n\r\n  const newCount = Math.max(0, Math.min(max, current + amount));\r\n  resource.current = newCount;\r\n\r\n  // Re-render stats tab\r\n  populateStatsTab(currentCharacter);\r\n\r\n  if (isOwlbearReady) {\r\n    const message = amount > 0 ? `Restored ${amount} ${resourceName}` : `Used ${Math.abs(amount)} ${resourceName}`;\r\n    OBR.notification.show(message, 'INFO');\r\n  }\r\n};\r\n\r\n/**\r\n * Use a feature or action (decrements uses or associated resource and announces in chat)\r\n */\r\nwindow.useFeature = async function(featureName, resourceName = null) {\r\n  if (!currentCharacter) return;\r\n\r\n  // If it has an associated resource, decrement it\r\n  if (resourceName && currentCharacter.resources) {\r\n    const resource = currentCharacter.resources.find(r => r.name === resourceName);\r\n    if (resource && resource.current > 0) {\r\n      resource.current -= 1;\r\n      populateStatsTab(currentCharacter);\r\n    } else if (resource && resource.current === 0) {\r\n      if (isOwlbearReady) {\r\n        OBR.notification.show(`No ${resourceName} remaining!`, 'ERROR');\r\n      }\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Find the feature to get full details\r\n  const feature = currentCharacter.features?.find(f => f.name === featureName);\r\n\r\n  // Announce in chat with full details\r\n  const message = `\u2728 Uses <strong>${featureName}</strong>${resourceName ? ` (${resourceName})` : ''}`;\r\n\r\n  // Create expandable details with ALL feature information\r\n  let details = `<strong>${featureName}</strong>`;\r\n\r\n  if (feature) {\r\n    if (resourceName) {\r\n      const resource = currentCharacter.resources?.find(r => r.name === resourceName);\r\n      if (resource) {\r\n        details += `<br><strong>Resource:</strong> ${resourceName} (${resource.current}/${resource.max} remaining)`;\r\n      }\r\n    }\r\n    if (feature.summary) details += `<br><br>${feature.summary}`;\r\n    if (feature.description) details += `<br><br>${feature.description}`;\r\n    if (feature.reset) details += `<br><br><strong>Resets:</strong> ${feature.reset}`;\r\n  }\r\n\r\n  await addChatMessage(message, 'action', currentCharacter.name, details);\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`${currentCharacter.name} uses ${featureName}`, 'INFO');\r\n  }\r\n};\r\n\r\n/**\r\n * Use a feature that has its own uses tracking\r\n */\r\nwindow.useFeatureWithUses = async function(featureName) {\r\n  if (!currentCharacter || !currentCharacter.features) return;\r\n\r\n  // Find the feature by name\r\n  const feature = currentCharacter.features.find(f => f.name === featureName);\r\n  if (!feature) {\r\n    console.warn(`Feature \"${featureName}\" not found`);\r\n    return;\r\n  }\r\n\r\n  // Check if feature has uses\r\n  if (!feature.uses || feature.uses.value === undefined) {\r\n    console.warn(`Feature \"${featureName}\" has no uses tracking`);\r\n    return;\r\n  }\r\n\r\n  // Check if uses remaining\r\n  if (feature.uses.value <= 0) {\r\n    if (isOwlbearReady) {\r\n      OBR.notification.show(`No uses of ${featureName} remaining!`, 'ERROR');\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Decrement uses\r\n  feature.uses.value -= 1;\r\n\r\n  // Refresh the features tab to show updated uses\r\n  populateFeaturesTab(currentCharacter);\r\n\r\n  // Announce in chat with full details\r\n  const message = `\u2728 Uses <strong>${featureName}</strong> (${feature.uses.value}/${feature.uses.max || feature.uses.value + 1} remaining)`;\r\n\r\n  // Create expandable details with ALL feature information\r\n  let details = `<strong>${featureName}</strong>`;\r\n\r\n  if (feature.uses) {\r\n    details += `<br><strong>Uses Remaining:</strong> ${feature.uses.value}/${feature.uses.max || feature.uses.value + 1}`;\r\n    if (feature.reset) details += `<br><strong>Resets:</strong> ${feature.reset}`;\r\n  }\r\n\r\n  if (feature.summary) details += `<br><br>${feature.summary}`;\r\n  if (feature.description) details += `<br><br>${feature.description}`;\r\n\r\n  await addChatMessage(message, 'action', currentCharacter.name, details);\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`${currentCharacter.name} uses ${featureName}`, 'INFO');\r\n  }\r\n};\r\n\r\n/**\r\n * Use an action that has limited uses\r\n */\r\nwindow.useAction = async function(actionName) {\r\n  if (!currentCharacter || !currentCharacter.actions) return;\r\n\r\n  // Find the action by name\r\n  const action = currentCharacter.actions.find(a => a.name === actionName);\r\n  if (!action) {\r\n    console.warn(`Action \"${actionName}\" not found`);\r\n    return;\r\n  }\r\n\r\n  // Check if action has uses\r\n  if (!action.uses || action.uses.value === undefined) {\r\n    console.warn(`Action \"${actionName}\" has no uses tracking`);\r\n    return;\r\n  }\r\n\r\n  // Check if uses remaining\r\n  if (action.uses.value <= 0) {\r\n    if (isOwlbearReady) {\r\n      OBR.notification.show(`No uses of ${actionName} remaining!`, 'ERROR');\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Decrement uses\r\n  action.uses.value -= 1;\r\n\r\n  // Refresh the actions tab to show updated uses\r\n  populateActionsTab(currentCharacter);\r\n\r\n  // Announce in chat with full details\r\n  const message = `\u2728 Uses <strong>${actionName}</strong> (${action.uses.value}/${action.uses.max || action.uses.value + 1} remaining)`;\r\n\r\n  // Create expandable details with ALL action information\r\n  let details = `<strong>${actionName}</strong><br><strong>Type:</strong> ${action.actionType || 'Action'}`;\r\n\r\n  if (action.uses) {\r\n    details += `<br><strong>Uses Remaining:</strong> ${action.uses.value}/${action.uses.max || action.uses.value + 1}`;\r\n    if (action.reset) details += `<br><strong>Resets:</strong> ${action.reset}`;\r\n  }\r\n\r\n  if (action.attackRoll) details += `<br><strong>Attack:</strong> ${action.attackRoll}`;\r\n  if (action.damage) details += `<br><strong>Damage:</strong> ${action.damage}`;\r\n  if (action.damageType) details += ` (${action.damageType})`;\r\n  if (action.summary) details += `<br><br>${action.summary}`;\r\n  if (action.description) details += `<br><br>${action.description}`;\r\n\r\n  await addChatMessage(message, 'action', currentCharacter.name, details);\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`${currentCharacter.name} uses ${actionName}`, 'INFO');\r\n  }\r\n};\r\n\r\n// ============== Rest System ==============\r\n\r\n/**\r\n * Take a short rest\r\n */\r\nwindow.takeShortRest = async function() {\r\n  if (!currentCharacter) return;\r\n\r\n  const confirm = window.confirm(\r\n    'Take a Short Rest?\\n\\n' +\r\n    '\u2022 Spend Hit Dice to recover HP\\n' +\r\n    '\u2022 Recover some class resources\\n' +\r\n    '\u2022 Takes 1 hour'\r\n  );\r\n\r\n  if (!confirm) return;\r\n\r\n  // Allow spending hit dice\r\n  const hitDice = currentCharacter.hitDice;\r\n  if (hitDice && hitDice.current > 0) {\r\n    const spend = window.prompt(`You have ${hitDice.current}/${hitDice.max} Hit Dice (d${hitDice.type})\\n\\nHow many do you want to spend?`);\r\n    if (spend) {\r\n      const count = Math.min(parseInt(spend) || 0, hitDice.current);\r\n      if (count > 0) {\r\n        let totalHealing = 0;\r\n        for (let i = 0; i < count; i++) {\r\n          const roll = Math.floor(Math.random() * (hitDice.type)) + 1;\r\n          const conMod = currentCharacter.attributeMods?.constitution || 0;\r\n          totalHealing += roll + conMod;\r\n        }\r\n\r\n        const currentHP = currentCharacter.hitPoints?.current || 0;\r\n        const maxHP = currentCharacter.hitPoints?.max || 0;\r\n        const newHP = Math.min(maxHP, currentHP + totalHealing);\r\n\r\n        currentCharacter.hitPoints.current = newHP;\r\n        currentCharacter.hitDice.current -= count;\r\n\r\n        if (isOwlbearReady) {\r\n          OBR.notification.show(`Short Rest: Spent ${count} Hit Dice, recovered ${totalHealing} HP`, 'SUCCESS');\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Refresh tabs\r\n  populateStatsTab(currentCharacter);\r\n\r\n  // TODO: Recover short rest resources\r\n  // TODO: Save to Supabase\r\n};\r\n\r\n/**\r\n * Take a long rest\r\n */\r\nwindow.takeLongRest = async function() {\r\n  if (!currentCharacter) return;\r\n\r\n  const confirm = window.confirm(\r\n    'Take a Long Rest?\\n\\n' +\r\n    '\u2022 Recover all HP\\n' +\r\n    '\u2022 Recover all spell slots\\n' +\r\n    '\u2022 Recover half of total Hit Dice\\n' +\r\n    '\u2022 Recover all resources\\n' +\r\n    '\u2022 Takes 8 hours'\r\n  );\r\n\r\n  if (!confirm) return;\r\n\r\n  // Recover HP to max\r\n  const maxHP = currentCharacter.hitPoints?.max || 0;\r\n  currentCharacter.hitPoints.current = maxHP;\r\n\r\n  // Recover spell slots\r\n  if (currentCharacter.spellSlots) {\r\n    for (let level = 1; level <= 9; level++) {\r\n      const maxKey = `level${level}SpellSlotsMax`;\r\n      const currentKey = `level${level}SpellSlots`;\r\n      if (currentCharacter.spellSlots[maxKey]) {\r\n        currentCharacter.spellSlots[currentKey] = currentCharacter.spellSlots[maxKey];\r\n      }\r\n    }\r\n    // Pact magic\r\n    if (currentCharacter.spellSlots.pactMagicSlotsMax) {\r\n      currentCharacter.spellSlots.pactMagicSlots = currentCharacter.spellSlots.pactMagicSlotsMax;\r\n    }\r\n  }\r\n\r\n  // Recover hit dice (half of total)\r\n  if (currentCharacter.hitDice) {\r\n    const recovered = Math.max(1, Math.floor(currentCharacter.hitDice.max / 2));\r\n    currentCharacter.hitDice.current = Math.min(\r\n      currentCharacter.hitDice.max,\r\n      currentCharacter.hitDice.current + recovered\r\n    );\r\n  }\r\n\r\n  // Recover resources\r\n  if (currentCharacter.resources) {\r\n    currentCharacter.resources.forEach(resource => {\r\n      resource.current = resource.max;\r\n    });\r\n  }\r\n\r\n  if (isOwlbearReady) {\r\n    OBR.notification.show(`Long Rest: ${currentCharacter.name} is fully rested!`, 'SUCCESS');\r\n  }\r\n\r\n  // Refresh tabs\r\n  populateStatsTab(currentCharacter);\r\n\r\n  // TODO: Save to Supabase\r\n};\r\n\r\n// ============== Collapsible Sections ==============\r\n\r\n/**\r\n * Toggle a collapsible section\r\n */\r\nwindow.toggleCollapsible = function(elementId) {\r\n  const element = document.getElementById(elementId);\r\n  const header = element.previousElementSibling;\r\n\r\n  if (element && header) {\r\n    element.classList.toggle('collapsed');\r\n    header.classList.toggle('collapsed');\r\n\r\n    // Handle arrow rotation for spell level headers\r\n    const arrow = header.querySelector('span[style*=\"transition\"]');\r\n    if (arrow) {\r\n      const isCollapsed = element.classList.contains('collapsed');\r\n      arrow.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Toggle expansion of a feature/action/spell card\r\n */\r\nwindow.toggleFeatureCard = function(cardId) {\r\n  const card = document.getElementById(cardId);\r\n  if (!card) return;\r\n\r\n  // Find the parent card element\r\n  const parentCard = card.parentElement;\r\n  if (parentCard) {\r\n    parentCard.classList.toggle('expanded');\r\n  }\r\n};\r\n\r\n// ============== Initialization ==============\r\n\r\nconsole.log('\uD83C\uDFB2 OwlCloud Owlbear extension popover loaded');\r\nstatusText.textContent = 'Initializing...';\r\n\r\n// Wait for DOM to be ready before initializing themes\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', () => {\r\n    // Initialize theme manager\r\n    ThemeManager.init();\r\n    initializeThemeSelector();\r\n  });\r\n} else {\r\n  // DOM is already ready\r\n  // Initialize theme manager\r\n  ThemeManager.init();\r\n  initializeThemeSelector();\r\n}\r\n\r\n// Initial check for character (will happen after OBR.onReady)\r\nsetTimeout(() => {\r\n  if (!isOwlbearReady) {\r\n    statusText.textContent = 'Waiting for Owlbear SDK...';\r\n  }\r\n}, 1000);\r\n\r\nconsole.log('\uD83C\uDFB2 OwlCloud popover initialized');\r\n"],
  "mappings": ";;AAaA,MAAI,mBAAmB;AACvB,MAAI,gBAAgB,CAAC;AACrB,MAAI,iBAAiB;AACrB,MAAI,WAAW;AACf,MAAI,qBAAqB;AACzB,MAAM,2BAA2B,oBAAI,IAAI;AAGzC,MAAM,wBAAwB;AAC9B,MAAI,gBAAgB;AACpB,MAAI,eAAe,oBAAI,IAAI;AAG3B,MAAM,eAAe;AACrB,MAAM,oBAAoB;AAC1B,MAAM,mBAAmB;AAAA,IACvB,UAAU;AAAA,IACV,gBAAgB;AAAA,EAClB;AAGA,MAAI,WAAW;AACf,MAAI,cAAc;AAIlB,MAAM,aAAa,SAAS,eAAe,aAAa;AACxD,MAAM,mBAAmB,SAAS,eAAe,mBAAmB;AACpE,MAAM,qBAAqB,SAAS,eAAe,sBAAsB;AACzE,MAAM,gBAAgB,SAAS,eAAe,gBAAgB;AAC9D,MAAM,mBAAmB,SAAS,eAAe,oBAAoB;AACrE,MAAM,oBAAoB,SAAS,eAAe,sBAAsB;AAQxE,WAAS,iCAAiC,cAAc;AAEtD,UAAM,MAAM,aAAa,QAAQ,KAAK,EAAE;AACxC,UAAM,IAAI,SAAS,IAAI,OAAO,GAAG,CAAC,GAAG,EAAE;AACvC,UAAM,IAAI,SAAS,IAAI,OAAO,GAAG,CAAC,GAAG,EAAE;AACvC,UAAM,IAAI,SAAS,IAAI,OAAO,GAAG,CAAC,GAAG,EAAE;AAIvC,UAAM,cAAc;AAAA;AAAA,MAElB,WAAW;AAAA,aACF,KAAK,IAAI,GAAG,IAAI,EAAE,CAAC,KAAK,KAAK,IAAI,GAAG,IAAI,EAAE,CAAC,KAAK,KAAK,IAAI,GAAG,IAAI,EAAE,CAAC;AAAA,aACnE,KAAK,IAAI,GAAG,IAAI,EAAE,CAAC,KAAK,KAAK,IAAI,GAAG,IAAI,EAAE,CAAC,KAAK,KAAK,IAAI,GAAG,IAAI,EAAE,CAAC;AAAA,aACnE,KAAK,IAAI,GAAG,IAAI,EAAE,CAAC,KAAK,KAAK,IAAI,GAAG,IAAI,EAAE,CAAC,KAAK,KAAK,IAAI,GAAG,IAAI,EAAE,CAAC;AAAA;AAAA,MAG5E,aAAa,QAAQ,KAAK,IAAI,GAAG,IAAI,GAAG,CAAC,KAAK,KAAK,IAAI,GAAG,IAAI,GAAG,CAAC,KAAK,KAAK,IAAI,GAAG,IAAI,GAAG,CAAC;AAAA;AAAA,MAG3F,UAAU,QAAQ,CAAC,KAAK,CAAC,KAAK,CAAC;AAAA;AAAA,MAG/B,QAAQ,QAAQ,CAAC,KAAK,CAAC,KAAK,CAAC;AAAA;AAAA,MAG7B,SAAS,QAAQ,CAAC,KAAK,CAAC,KAAK,CAAC;AAAA,IAChC;AAEA,WAAO;AAAA,EACT;AAKA,MAAM,eAAe;AAAA;AAAA,IAEnB,QAAQ;AAAA,MACN,QAAQ;AAAA,QACN,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,MACA,MAAM;AAAA,QACJ,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,MACA,OAAO;AAAA,QACL,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,MACA,KAAK;AAAA,QACH,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,MACA,QAAQ;AAAA,QACN,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,MACA,QAAQ;AAAA,QACN,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,MACA,MAAM;AAAA,QACJ,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,MACA,OAAO;AAAA,QACL,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,MACA,MAAM;AAAA,QACJ,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,MACA,OAAO;AAAA,QACL,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,MACA,OAAO;AAAA,QACL,MAAM;AAAA,QACN,SAAS;AAAA,QACT,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QAER,WAAW;AAAA,QACX,aAAa;AAAA,QACb,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,SAAS;AAAA;AAAA,QAET,aAAa;AAAA,QACb,eAAe;AAAA,QACf,WAAW;AAAA,QACX,eAAe;AAAA,QACf,aAAa;AAAA,MACf;AAAA,IACF;AAAA;AAAA,IAGA,cAAc;AAAA;AAAA;AAAA;AAAA,IAKd,OAAO;AAEL,YAAM,aAAa,aAAa,QAAQ,gBAAgB;AACxD,UAAI,cAAc,KAAK,OAAO,UAAU,GAAG;AACzC,aAAK,eAAe;AAAA,MACtB;AACA,WAAK,WAAW;AAAA,IAClB;AAAA;AAAA;AAAA;AAAA,IAKA,aAAa;AACX,YAAM,QAAQ,KAAK,OAAO,KAAK,YAAY;AAC3C,UAAI,CAAC;AAAO;AAGZ,WAAK,mBAAmB,KAAK;AAG7B,WAAK,mBAAmB,KAAK;AAG7B,WAAK,iBAAiB,KAAK;AAG3B,mBAAa,QAAQ,kBAAkB,KAAK,YAAY;AAExD,cAAQ,IAAI,4BAAqB,MAAM,IAAI,EAAE;AAAA,IAC/C;AAAA;AAAA;AAAA;AAAA,IAKA,iBAAiB,OAAO;AACtB,YAAM,OAAO,SAAS;AAGtB,UAAI,MAAM,SAAS,SAAS;AAE1B,aAAK,MAAM,YAAY,wBAAwB,SAAS;AACxD,aAAK,MAAM,YAAY,0BAA0B,SAAS;AAC1D,aAAK,MAAM,YAAY,sBAAsB,SAAS;AACtD,aAAK,MAAM,YAAY,2BAA2B,SAAS;AAC3D,aAAK,MAAM,YAAY,yBAAyB,SAAS;AAAA,MAC3D,WAAW,MAAM,SAAS,SAAS;AAEjC,aAAK,MAAM,YAAY,wBAAwB,SAAS;AACxD,aAAK,MAAM,YAAY,0BAA0B,SAAS;AAC1D,aAAK,MAAM,YAAY,sBAAsB,SAAS;AACtD,aAAK,MAAM,YAAY,2BAA2B,SAAS;AAC3D,aAAK,MAAM,YAAY,yBAAyB,SAAS;AAAA,MAC3D,WAAW,MAAM,SAAS,QAAQ;AAEhC,aAAK,MAAM,YAAY,wBAAwB,SAAS;AACxD,aAAK,MAAM,YAAY,0BAA0B,SAAS;AAC1D,aAAK,MAAM,YAAY,sBAAsB,SAAS;AACtD,aAAK,MAAM,YAAY,2BAA2B,SAAS;AAC3D,aAAK,MAAM,YAAY,yBAAyB,SAAS;AAAA,MAC3D,OAAO;AAEL,aAAK,MAAM,YAAY,wBAAwB,SAAS;AACxD,aAAK,MAAM,YAAY,0BAA0B,SAAS;AAC1D,aAAK,MAAM,YAAY,sBAAsB,SAAS;AACtD,aAAK,MAAM,YAAY,2BAA2B,SAAS;AAC3D,aAAK,MAAM,YAAY,yBAAyB,SAAS;AAAA,MAC3D;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKA,mBAAmB,OAAO;AACxB,YAAM,OAAO,SAAS;AACtB,WAAK,MAAM,YAAY,mBAAmB,MAAM,OAAO;AACvD,WAAK,MAAM,YAAY,yBAAyB,MAAM,YAAY;AAClE,WAAK,MAAM,YAAY,2BAA2B,MAAM,cAAc;AACtE,WAAK,MAAM,YAAY,oBAAoB,MAAM,QAAQ;AACzD,WAAK,MAAM,YAAY,sBAAsB,MAAM,UAAU;AAC7D,WAAK,MAAM,YAAY,kBAAkB,MAAM,MAAM;AACrD,WAAK,MAAM,YAAY,kBAAkB,MAAM,MAAM;AAGrD,UAAI,MAAM,WAAW;AACnB,aAAK,MAAM,YAAY,sBAAsB,MAAM,SAAS;AAC5D,iBAAS,KAAK,MAAM,aAAa,MAAM;AAAA,MACzC;AACA,UAAI,MAAM,aAAa;AACrB,aAAK,MAAM,YAAY,wBAAwB,MAAM,WAAW;AAEhE,cAAM,YAAY,SAAS,cAAc,YAAY;AACrD,YAAI,WAAW;AACb,oBAAU,MAAM,aAAa,MAAM;AAAA,QACrC;AAAA,MACF;AACA,UAAI,MAAM,UAAU;AAClB,aAAK,MAAM,YAAY,qBAAqB,MAAM,QAAQ;AAAA,MAC5D;AACA,UAAI,MAAM,QAAQ;AAChB,aAAK,MAAM,YAAY,mBAAmB,MAAM,MAAM;AAAA,MACxD;AACA,UAAI,MAAM,SAAS;AACjB,aAAK,MAAM,YAAY,oBAAoB,MAAM,OAAO;AAAA,MAC1D;AAGA,UAAI,MAAM,aAAa;AACrB,aAAK,MAAM,YAAY,wBAAwB,MAAM,WAAW;AAChE,iBAAS,KAAK,MAAM,QAAQ,MAAM;AAAA,MACpC;AACA,UAAI,MAAM,eAAe;AACvB,aAAK,MAAM,YAAY,0BAA0B,MAAM,aAAa;AAAA,MACtE;AACA,UAAI,MAAM,WAAW;AACnB,aAAK,MAAM,YAAY,sBAAsB,MAAM,SAAS;AAAA,MAC9D;AACA,UAAI,MAAM,eAAe;AACvB,aAAK,MAAM,YAAY,2BAA2B,MAAM,aAAa;AAAA,MACvE;AACA,UAAI,MAAM,aAAa;AACrB,aAAK,MAAM,YAAY,yBAAyB,MAAM,WAAW;AAAA,MACnE;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKA,mBAAmB,OAAO;AAGxB,WAAK,yBAAyB,KAAK;AACnC,WAAK,2BAA2B,KAAK;AAAA,IACvC;AAAA;AAAA;AAAA;AAAA,IAKA,yBAAyB,OAAO;AAC9B,YAAM,YAAY,SAAS,iBAAiB,yCAAyC;AACrF,gBAAU,QAAQ,cAAY;AAC5B,YAAI,UAAU;AACZ,mBAAS,MAAM,cAAc,MAAM;AACnC,mBAAS,MAAM,YAAY,cAAc,MAAM,MAAM;AAAA,QACvD;AAAA,MACF,CAAC;AAAA,IACH;AAAA;AAAA;AAAA;AAAA,IAKA,2BAA2B,OAAO;AAAA,IAGlC;AAAA;AAAA;AAAA;AAAA,IAKA,YAAY,WAAW;AACrB,UAAI,KAAK,OAAO,SAAS,GAAG;AAC1B,aAAK,eAAe;AACpB,aAAK,WAAW;AAChB,eAAO;AAAA,MACT;AACA,aAAO;AAAA,IACT;AAAA;AAAA;AAAA;AAAA,IAKA,kBAAkB;AAChB,aAAO,KAAK,OAAO,KAAK,YAAY;AAAA,IACtC;AAAA;AAAA;AAAA;AAAA,IAKA,qBAAqB;AACnB,aAAO,OAAO,KAAK,KAAK,MAAM,EAAE,IAAI,UAAQ;AAAA,QAC1C;AAAA,QACA,GAAG,KAAK,OAAO,GAAG;AAAA,MACpB,EAAE;AAAA,IACJ;AAAA,EACF;AAKA,WAAS,0BAA0B;AACjC,UAAM,gBAAgB,SAAS,eAAe,gBAAgB;AAC9D,QAAI,CAAC;AAAe;AAEpB,UAAM,SAAS,aAAa,mBAAmB;AAC/C,UAAM,eAAe,aAAa,gBAAgB;AAElD,WAAO,QAAQ,WAAS;AACtB,YAAM,cAAc,SAAS,cAAc,KAAK;AAChD,kBAAY,YAAY,gBAAgB,MAAM,QAAQ,aAAa,eAAe,WAAW,EAAE;AAC/F,kBAAY,QAAQ,QAAQ,MAAM;AAElC,kBAAY,YAAY;AAAA,4DACgC,MAAM,OAAO;AAAA,gCACzC,MAAM,IAAI;AAAA;AAGtC,kBAAY,iBAAiB,SAAS,MAAM;AAE1C,iBAAS,iBAAiB,eAAe,EAAE,QAAQ,SAAO,IAAI,UAAU,OAAO,QAAQ,CAAC;AAGxF,oBAAY,UAAU,IAAI,QAAQ;AAGlC,qBAAa,YAAY,MAAM,GAAG;AAAA,MACpC,CAAC;AAED,oBAAc,YAAY,WAAW;AAAA,IACvC,CAAC;AAGD,sCAAkC;AAAA,EACpC;AAKA,WAAS,oCAAoC;AAC3C,UAAM,cAAc,SAAS,eAAe,sBAAsB;AAClE,UAAM,eAAe,SAAS,eAAe,uBAAuB;AAEpE,QAAI,CAAC,eAAe,CAAC;AAAc;AAGnC,QAAI,aAAa;AACjB,iBAAa,UAAU,IAAI,WAAW;AACtC,gBAAY,UAAU,IAAI,WAAW;AAGrC,UAAM,QAAQ,YAAY,cAAc,MAAM;AAC9C,QAAI,OAAO;AACT,YAAM,MAAM,YAAY;AAAA,IAC1B;AAEA,gBAAY,iBAAiB,SAAS,MAAM;AAC1C,mBAAa,CAAC;AAEd,UAAI,YAAY;AACd,qBAAa,UAAU,OAAO,WAAW;AACzC,oBAAY,UAAU,OAAO,WAAW;AACxC,YAAI,OAAO;AACT,gBAAM,MAAM,YAAY;AAAA,QAC1B;AAAA,MACF,OAAO;AACL,qBAAa,UAAU,IAAI,WAAW;AACtC,oBAAY,UAAU,IAAI,WAAW;AACrC,YAAI,OAAO;AACT,gBAAM,MAAM,YAAY;AAAA,QAC1B;AAAA,MACF;AAAA,IACF,CAAC;AAAA,EACH;AAOA,WAAS,iBAAiB;AACxB,UAAM,aAAa,SAAS,iBAAiB,aAAa;AAC1D,UAAM,cAAc,SAAS,iBAAiB,cAAc;AAC5D,UAAM,iBAAiB,SAAS,eAAe,iBAAiB;AAChE,UAAM,kBAAkB,SAAS,eAAe,kBAAkB;AAClE,UAAM,UAAU,SAAS,cAAc,WAAW;AAGlD,QAAI,SAAS;AACX,cAAQ,iBAAiB,SAAS,CAAC,MAAM;AACvC,UAAE,eAAe;AACjB,gBAAQ,cAAc,EAAE;AAAA,MAC1B,CAAC;AAAA,IACH;AAEA,eAAW,QAAQ,YAAU;AAC3B,aAAO,iBAAiB,SAAS,MAAM;AACrC,cAAM,UAAU,OAAO,aAAa,UAAU;AAG9C,mBAAW,QAAQ,SAAO,IAAI,UAAU,OAAO,QAAQ,CAAC;AACxD,oBAAY,QAAQ,aAAW,QAAQ,UAAU,OAAO,QAAQ,CAAC;AAGjE,eAAO,UAAU,IAAI,QAAQ;AAC7B,iBAAS,eAAe,OAAO,OAAO,EAAE,EAAE,UAAU,IAAI,QAAQ;AAGhE,YAAI,YAAY,YAAY;AAC1B,yBAAe,MAAM,UAAU;AAC/B,0BAAgB,MAAM,UAAU;AAAA,QAClC,OAAO;AACL,yBAAe,MAAM,UAAU;AAC/B,0BAAgB,MAAM,UAAU;AAAA,QAClC;AAEA,gBAAQ,IAAI,8BAAuB,OAAO,EAAE;AAAA,MAC9C,CAAC;AAAA,IACH,CAAC;AAAA,EACH;AAGA,iBAAe;AAIf,MAAI,QAAQ,YAAY;AACtB,qBAAiB;AACjB,YAAQ,IAAI,6BAAsB;AAClC,eAAW,cAAc;AAKzB,UAAM,cAAc;AAEpB,QAAI;AACF,YAAM,IAAI,QAAQ,UAAU,WAAW;AAAA,IACzC,SAAS,OAAO;AACd,cAAQ,MAAM,iCAAiC,KAAK;AAAA,IACtD;AAGA,UAAM,uBAAuB;AAG7B,4BAAwB;AAMxB,uBAAmB;AAGnB,2BAAuB;AAAA,EACzB,CAAC;AAOD,iBAAe,qBAAqB;AAClC,QAAI,CAAC;AAAgB;AAGrB,UAAM,IAAI,QAAQ,aAAW,WAAW,SAAS,GAAG,CAAC;AAErD,QAAI;AACF,YAAM,YAAY,SAAS,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,GAAG,CAAC,CAAC;AAChF,cAAQ,IAAI,2CAAoC;AAEhD,UAAI,mBAAmB;AACvB,UAAI,eAAe;AAGnB,YAAM,mBAAmB,IAAI,UAAU,UAAU,KAAK,CAAC,UAAU;AAC/D,YAAI,MAAM,GAAG,SAAS,WAAW,KAAK,MAAM,GAAG,SAAS,OAAO,GAAG;AAChE,kBAAQ,IAAI,oDAA6C,MAAM,IAAI,SAAS,MAAM,IAAI;AAAA,QACxF;AAAA,MACF,CAAC;AAGD,YAAM,cAAc,IAAI,UAAU,UAAU,qBAAqB,CAAC,UAAU;AAC1E,gBAAQ,IAAI,iDAA0C,MAAM,IAAI;AAGhE,YAAI,MAAM,KAAK,cAAc,WAAW;AACtC,kBAAQ,IAAI,6BAAwB,SAAS;AAK7C,cAAI,MAAM,KAAK,SAAS,MAAM,KAAK,WAAW;AAC5C,+BAAmB;AACnB,4BAAgB;AAChB,oBAAQ,IAAI,oDAA+C;AAAA,UAC7D;AAEA,cAAI,CAAC,cAAc;AACjB,2BAAe;AACf,wBAAY;AAAA,UACd;AAAA,QACF,OAAO;AACL,kBAAQ,IAAI,8CAAoC,WAAW,QAAQ,MAAM,KAAK,SAAS;AAAA,QACzF;AAAA,MACF,CAAC;AAGD,cAAQ,IAAI,iEAA0D,SAAS;AAC/E,YAAM,IAAI,UAAU,YAAY,qBAAqB;AAAA,QACnD;AAAA,QACA,WAAW,KAAK,IAAI;AAAA,MACtB,GAAG,EAAE,aAAa,MAAM,CAAC;AACzB,cAAQ,IAAI,0DAAqD;AAGjE,YAAM,IAAI,QAAQ,aAAW,WAAW,SAAS,GAAI,CAAC;AAGtD,UAAI,CAAC,cAAc;AACjB,uBAAe;AACf,oBAAY;AAAA,MACd;AAGA,uBAAiB;AAEjB,UAAI,CAAC,kBAAkB;AACrB,gBAAQ,KAAK,2EAAiE;AAC9E,wBAAgB;AAAA,MAClB;AAAA,IAEF,SAAS,OAAO;AACd,cAAQ,KAAK,iCAAiC,KAAK;AACnD,sBAAgB;AAAA,IAClB;AAAA,EACF;AAKA,WAAS,yBAAyB;AAChC,QAAI,CAAC;AAAgB;AAGrB,QAAI,UAAU,UAAU,GAAG,qBAAqB,gBAAgB,CAAC,UAAU;AACzE,YAAM,EAAE,QAAQ,YAAY,aAAa,OAAO,IAAI,MAAM;AAG1D,UAAI,CAAC,UAAU,eAAe,QAAW;AACvC,gBAAQ,KAAK,sDAA+C,MAAM,IAAI;AACtE;AAAA,MACF;AAGA,YAAM,cAAc,aAAa,IAAI,MAAM;AAC3C,UAAI,CAAC,aAAa;AAChB,gBAAQ,KAAK,qCAAqC,MAAM;AACxD;AAAA,MACF;AAGA,mBAAa,OAAO,MAAM;AAG1B,2BAAqB,aAAa,YAAY,aAAa,MAAM;AAAA,IACnE,CAAC;AAGD,QAAI,UAAU,UAAU,GAAG,qBAAqB,eAAe,CAAC,UAAU;AACxE,YAAM,EAAE,QAAQ,MAAM,IAAI,MAAM;AAChC,cAAQ,MAAM,qBAAqB,KAAK;AAExC,YAAM,cAAc,aAAa,IAAI,MAAM;AAC3C,UAAI,aAAa;AACf,qBAAa,OAAO,MAAM;AAE1B,gBAAQ,KAAK,sCAAsC;AACnD,yBAAiB,WAAW;AAAA,MAC9B;AAAA,IACF,CAAC;AAGD,QAAI,UAAU,UAAU,yBAAyB,CAAC,UAAU;AAC1D,cAAQ,IAAI,yCAAkC,MAAM,IAAI;AACxD,YAAM,EAAE,OAAO,IAAI,MAAM;AAGzB,UAAI,CAAC,UAAU,CAAC,OAAO,UAAU,OAAO,eAAe,QAAW;AAChE,gBAAQ,KAAK,uDAAgD,MAAM;AACnE;AAAA,MACF;AAEA,YAAM,EAAE,QAAQ,YAAY,aAAa,OAAO,IAAI;AAGpD,YAAM,cAAc,aAAa,IAAI,MAAM;AAC3C,UAAI,CAAC,aAAa;AAChB,gBAAQ,KAAK,qCAAqC,MAAM;AACxD;AAAA,MACF;AAGA,mBAAa,OAAO,MAAM;AAG1B,2BAAqB,aAAa,YAAY,aAAa,MAAM;AAAA,IACnE,CAAC;AAAA,EACH;AAMA,WAAS,oBAAoB,SAAS;AACpC,QAAI,CAAC,WAAW,CAAC;AAAkB,aAAO;AAE1C,QAAI,aAAa;AAGjB,QAAI,WAAW,SAAS,eAAe,GAAG;AACxC,YAAM,QAAQ,iBAAiB,SAAS;AACxC,mBAAa,WAAW,QAAQ,mBAAmB,MAAM,SAAS,CAAC;AAAA,IACrE;AAIA,UAAM,YAAY,WAAW,MAAM,0BAA0B;AAC7D,QAAI,WAAW;AACb,YAAM,kBAAkB,UAAU,CAAC;AACnC,YAAM,QAAQ,UAAU,CAAC;AACzB,YAAM,WAAW,UAAU,CAAC,KAAK;AAEjC,UAAI;AAGF,YAAI,iBAAiB,gBAClB,QAAQ,YAAY,aAAa,EACjC,QAAQ,WAAW,YAAY,EAC/B,QAAQ,YAAY,aAAa,EACjC,QAAQ,UAAU,WAAW,EAC7B,QAAQ,UAAU,WAAW;AAGhC,YAAI,uBAAuB,KAAK,cAAc,KAAK,eAAe,SAAS,OAAO,GAAG;AACnF,gBAAM,QAAQ,KAAK,MAAM,KAAK,cAAc,CAAC;AAC7C,cAAI,QAAQ,KAAK,QAAQ,KAAK;AAC5B,yBAAa,GAAG,KAAK,IAAI,KAAK,GAAG,QAAQ;AACzC,oBAAQ,IAAI,iCAA0B,OAAO,WAAM,UAAU,EAAE;AAAA,UACjE;AAAA,QACF;AAAA,MACF,SAAS,OAAO;AACd,gBAAQ,KAAK,+BAA+B,SAAS,KAAK;AAAA,MAE5D;AAAA,IACF;AAEA,WAAO;AAAA,EACT;AAQA,iBAAe,eAAe,cAAc,aAAa;AAEvD,UAAM,qBAAqB,oBAAoB,YAAY;AAE3D,YAAQ,IAAI,oCAA6B;AAAA,MACvC,UAAU;AAAA,MACV,YAAY;AAAA,MACZ;AAAA,MACA;AAAA,IACF,CAAC;AAED,QAAI,CAAC,kBAAkB,CAAC,eAAe;AAErC,cAAQ,IAAI,wDAA8C,gBAAgB,gBAAgB,aAAa;AACvG,aAAO;AAAA,IACT;AAEA,QAAI;AACF,YAAM,SAAS,QAAQ,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,GAAG,CAAC,CAAC;AAC5E,YAAM,WAAW,MAAM,IAAI,OAAO,MAAM;AACxC,YAAM,aAAa,MAAM,IAAI,OAAO,QAAQ;AAG5C,mBAAa,IAAI,QAAQ,WAAW;AAEpC,cAAQ,IAAI,4CAAqC,EAAE,QAAQ,cAAc,mBAAmB,CAAC;AAG7F,YAAM,IAAI,UAAU,YAAY,0BAA0B;AAAA,QACxD;AAAA,QACA;AAAA,QACA;AAAA,QACA,YAAY;AAAA;AAAA,QACZ,cAAc;AAAA,QACd,aAAa;AAAA;AAAA,QACb,WAAW,KAAK,IAAI;AAAA,QACpB,QAAQ;AAAA,MACV,GAAG,EAAE,aAAa,MAAM,CAAC;AAEzB,aAAO;AAAA,IAET,SAAS,OAAO;AACd,cAAQ,MAAM,4BAA4B,KAAK;AAC/C,aAAO;AAAA,IACT;AAAA,EACF;AAKA,iBAAe,qBAAqB,aAAa,YAAY,aAAa,QAAQ;AAChF,UAAM,EAAE,MAAM,UAAAA,WAAU,MAAM,aAAa,cAAc,YAAY,cAAc,IAAI;AAEvF,YAAQ,IAAI,oCAA6B;AAAA,MACvC;AAAA,MACA,gBAAgB,OAAO;AAAA,MACvB;AAAA,MACA,UAAAA;AAAA,MACA;AAAA,IACF,CAAC;AAKD,UAAM,eAAe,OAAO,eAAe,WAAW,aAAa,SAAS,UAAU,KAAK;AAE3F,YAAQ,IAAI,4BAAqB,EAAE,cAAc,UAAAA,WAAU,cAAeA,aAAY,EAAG,CAAC;AAG1F,QAAI,eAAe,kBAAkB;AACnC,YAAM,OAAO;AACb,UAAI,UAAU;AACd,UAAI,cAAc;AAElB,UAAI,SAAS,IAAI;AACf,kBAAU;AACV,YAAI,CAAC,iBAAiB,WAAW;AAC/B,2BAAiB,YAAY,EAAE,SAAS,GAAG,KAAK,EAAE;AAAA,QACpD;AACA,yBAAiB,UAAU,UAAU;AACrC,yBAAiB,gBAAgB;AAAA,MACnC,WAAW,SAAS,GAAG;AACrB,kBAAU;AAAA,MACZ,WAAW,QAAQ,IAAI;AACrB,kBAAU,iCAA0B,IAAI;AAAA,MAC1C,OAAO;AACL,kBAAU,iCAA0B,IAAI;AAAA,MAC1C;AAEA,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,GAAG,iBAAiB,IAAI,kBAAkB,IAAI,IAAI,QAAQ,KAAK,YAAY,OAAO;AAAA,MAC1G;AACA,cAAQ,IAAI,aAAM,OAAO;AACzB,YAAM,eAAe,SAAS,aAAa,iBAAiB,IAAI;AAChE;AAAA,IACF;AAGA,QAAI,cAAc;AAChB,YAAM,QAAQ,UAAU,OAAO,CAAC,IAAI,OAAO,CAAC,EAAE,KAAK,OAAO,OAAK,EAAE,IAAI,EAAE,IAAI,OAAK,EAAE,KAAK,IAAI,CAAC;AAC5F,YAAM,UAAU,GAAG,UAAU,oBAAoB,YAAY;AAE7D,UAAI,cAAc,6BAA6B,aAAa;AAAA,iDACf,MAAM,KAAK,IAAI,CAAC;AAC7D,UAAIA,WAAU;AACZ,uBAAe,iBAAiBA,aAAY,IAAI,MAAM,EAAE,GAAGA,SAAQ;AAAA,MACrE;AACA,qBAAe,oBAAoB,MAAM,KAAK,KAAK,CAAC;AACpD,UAAIA,WAAU;AACZ,uBAAe,IAAIA,aAAY,IAAI,MAAM,EAAE,GAAGA,SAAQ;AAAA,MACxD;AACA,qBAAe,MAAM,YAAY;AAEjC,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,GAAG,kBAAkB,QAAQ,WAAW,KAAK,UAAU,aAAa,YAAY,IAAI,MAAM;AAAA,MAClH;AACA,cAAQ,IAAI,gBAAM,OAAO;AACzB,YAAM,eAAe,SAAS,UAAU,kBAAkB,MAAM,WAAW;AAC3E;AAAA,IACF;AAIA,QAAI,UAAU;AACd,QAAI,aAAa;AAEjB,QAAI,aAAa;AAEf,YAAM,YAAY,YAAY,MAAM,YAAY;AAChD,UAAI,WAAW;AACb,kBAAU,SAAS,UAAU,CAAC,CAAC;AAAA,MACjC;AAAA,IACF;AAGA,iBAAa;AAEb,YAAQ,IAAI,sCAA+B;AAAA,MACzC;AAAA,MACA,UAAAA;AAAA,MACA;AAAA,MACA;AAAA,MACA,eAAe;AAAA,MACf;AAAA,MACA,oBAAoB;AAAA,IACtB,CAAC;AAED,UAAM,SAAS;AAAA,MACb,OAAO;AAAA,MACP,OAAO,UAAU,OAAO,CAAC,IAAI,OAAO,CAAC,EAAE,KAAK,OAAO,OAAK,EAAE,IAAI,EAAE,IAAI,OAAK,EAAE,KAAK,IAAI,CAAC,OAAO;AAAA,MAC5F,UAAUA,aAAY;AAAA,MACtB,SAAS;AAAA,MACT,MAAM,YAAY,QAAQ;AAAA;AAAA,MAE1B,gBAAgB;AAAA,IAClB;AAGA,UAAM,eAAe,MAAM,MAAM;AAAA,EACnC;AAKA,iBAAe,iBAAiB,aAAa;AAC3C,UAAM,EAAE,MAAM,UAAAA,WAAU,MAAM,KAAK,IAAI;AAEvC,QAAI;AACJ,QAAI,SAAS,OAAO;AAClB,eAAS,aAAa;AAAA,IACxB,OAAO;AACL,eAAS,cAAc,YAAY,OAAO;AAAA,IAC5C;AAEA,WAAO,SAAUA,aAAY;AAC7B,WAAO,WAAWA,aAAY;AAE9B,UAAM,eAAe,MAAM,MAAM;AAAA,EACnC;AAOA,iBAAe,yBAAyB;AACtC,QAAI;AAEF,iBAAW,OAAO,qBAAqB,cAAc,mBAAmB;AAAA,QACtE,MAAM;AAAA,UACJ,gBAAgB;AAAA,UAChB,kBAAkB;AAAA,UAClB,oBAAoB;AAAA,QACtB;AAAA,MACF,CAAC;AAGD,YAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,MAAM,SAAS,KAAK,WAAW;AAE7D,UAAI,SAAS;AACX,sBAAc,QAAQ;AACtB,gBAAQ,IAAI,kCAA6B,YAAY,KAAK;AAC1D,qBAAa;AAGb,cAAM,4BAA4B;AAAA,MACpC,OAAO;AACL,gBAAQ,IAAI,gCAAsB;AAClC,qBAAa;AAAA,MACf;AAGA,eAAS,KAAK,kBAAkB,OAAO,OAAOC,aAAY;AACxD,gBAAQ,IAAI,iCAA0B,KAAK;AAC3C,sBAAcA,UAAS,QAAQ;AAC/B,qBAAa;AAGb,YAAI,UAAU,aAAa;AACzB,gBAAM,4BAA4B;AAAA,QACpC;AAGA,YAAI,UAAU,eAAe,UAAU,cAAc;AACnD,kCAAwB;AAAA,QAC1B;AAAA,MACF,CAAC;AAAA,IACH,SAAS,OAAO;AACd,cAAQ,MAAM,uCAAuC,KAAK;AAAA,IAC5D;AAAA,EACF;AAKA,iBAAe,OAAO,OAAO,UAAU;AACrC,QAAI;AACF,YAAM,EAAE,MAAM,MAAM,IAAI,MAAM,SAAS,KAAK,mBAAmB;AAAA,QAC7D;AAAA,QACA;AAAA,MACF,CAAC;AAED,UAAI;AAAO,cAAM;AAEjB,cAAQ,IAAI,+BAA0B;AACtC,aAAO,EAAE,SAAS,KAAK;AAAA,IACzB,SAAS,OAAO;AACd,cAAQ,MAAM,kBAAkB,KAAK;AACrC,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAKA,iBAAe,OAAO,OAAO,UAAU;AACrC,QAAI;AACF,YAAM,EAAE,MAAM,MAAM,IAAI,MAAM,SAAS,KAAK,OAAO;AAAA,QACjD;AAAA,QACA;AAAA,MACF,CAAC;AAED,UAAI;AAAO,cAAM;AAEjB,cAAQ,IAAI,+BAA0B;AACtC,aAAO,EAAE,SAAS,KAAK;AAAA,IACzB,SAAS,OAAO;AACd,cAAQ,MAAM,kBAAkB,KAAK;AACrC,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAKA,iBAAe,UAAU;AACvB,QAAI;AACF,YAAM,EAAE,MAAM,IAAI,MAAM,SAAS,KAAK,QAAQ;AAC9C,UAAI;AAAO,cAAM;AAEjB,cAAQ,IAAI,gCAA2B;AAGvC,oBAAc;AAGd,mBAAa;AAGb,8BAAwB;AAExB,aAAO,EAAE,SAAS,KAAK;AAAA,IACzB,SAAS,OAAO;AACd,cAAQ,MAAM,mBAAmB,KAAK;AACtC,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAGA,SAAO,UAAU;AAMjB,iBAAe,8BAA8B;AAC3C,QAAI,CAAC;AAAa;AAElB,QAAI;AACF,YAAM,WAAW,MAAM,IAAI,OAAO,MAAM;AAExC,cAAQ,IAAI,sDAA+C;AAC3D,cAAQ,IAAI,wBAAwB,YAAY,EAAE;AAClD,cAAQ,IAAI,0BAA0B,QAAQ;AAG9C,YAAM,cAAc,EAAE,GAAG,iBAAiB;AAC1C,UAAI,UAAU;AACZ,cAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,MAAM,SAAS,KAAK,WAAW;AAC7D,YAAI,SAAS,cAAc;AACzB,sBAAY,eAAe,IAAI,UAAU,QAAQ,YAAY;AAAA,QAC/D;AAAA,MACF;AAGA,cAAQ,IAAI,uDAAgD;AAC5D,YAAM,mBAAmB,MAAM;AAAA,QAC7B,GAAG,YAAY,6CAA6C,mBAAmB,YAAY,EAAE,CAAC;AAAA,QAC9F,EAAE,SAAS,YAAY;AAAA,MACzB;AAEA,cAAQ,IAAI,4CAAqC,iBAAiB,MAAM;AACxE,UAAI,iBAAiB,IAAI;AACvB,cAAM,WAAW,MAAM,iBAAiB,KAAK;AAC7C,gBAAQ,IAAI,kCAA2B,QAAQ;AAC/C,YAAI,SAAS,YAAY,SAAS,aAAc,SAAS,cAAc,SAAS,WAAW,SAAS,IAAK;AACvG,kBAAQ,IAAI,4CAAuC;AACnD;AAAA,QACF;AAAA,MACF;AAGA,cAAQ,IAAI,0DAAmD;AAC/D,YAAM,qBAAqB,MAAM;AAAA,QAC/B,GAAG,YAAY,8CAA8C,mBAAmB,QAAQ,CAAC;AAAA,QACzF,EAAE,SAAS,iBAAiB;AAAA,MAC9B;AAEA,cAAQ,IAAI,8CAAuC,mBAAmB,MAAM;AAC5E,UAAI,CAAC,mBAAmB,IAAI;AAC1B,gBAAQ,IAAI,kDAAwC;AACpD;AAAA,MACF;AAEA,YAAM,aAAa,MAAM,mBAAmB,KAAK;AACjD,cAAQ,IAAI,oCAA6B,UAAU;AAGnD,YAAM,mBAAmB,WAAW,WAAW,WAAW,cAAc,WAAW,WAAW,SAAS,IACnG,WAAW,aACV,WAAW,WAAW,WAAW,YAAY,CAAC,WAAW,SAAS,IAAI,CAAC;AAE5E,UAAI,iBAAiB,SAAS,GAAG;AAC/B,gBAAQ,IAAI,qBAAc,iBAAiB,MAAM,2CAA2C;AAG5F,mBAAW,QAAQ,kBAAkB;AAEnC,gBAAM,YAAY,KAAK,qBAAqB;AAAA,YAC1C,GAAG,KAAK;AAAA,YACR,QAAQ,KAAK;AAAA,YACb,IAAI,KAAK;AAAA,YACT,MAAM,KAAK;AAAA,UACb,IAAI;AAAA,YACF,QAAQ,KAAK;AAAA,YACb,IAAI,KAAK;AAAA,YACT,MAAM,KAAK;AAAA,YACX,OAAO,KAAK;AAAA,YACZ,MAAM,KAAK;AAAA,YACX,OAAO,KAAK;AAAA,UACd;AAEA,gBAAM,eAAe,MAAM;AAAA,YACzB,GAAG,YAAY;AAAA,YACf;AAAA,cACE,QAAQ;AAAA,cACR,SAAS;AAAA,cACT,MAAM,KAAK,UAAU;AAAA,gBACnB,iBAAiB;AAAA,gBACjB,gBAAgB,YAAY;AAAA,gBAC5B;AAAA,cACF,CAAC;AAAA,YACH;AAAA,UACF;AAEA,cAAI,aAAa,IAAI;AACnB,kBAAM,WAAW,MAAM,aAAa,KAAK;AACzC,oBAAQ,IAAI,qBAAgB,KAAK,cAAc,wBAAwB;AAAA,UACzE,OAAO;AACL,kBAAM,YAAY,MAAM,aAAa,KAAK;AAC1C,oBAAQ,MAAM,oCAA+B,KAAK,cAAc,MAAM,SAAS;AAAA,UACjF;AAAA,QACF;AAGA,YAAI,gBAAgB;AAClB,cAAI,aAAa,KAAK,GAAG,iBAAiB,MAAM,yCAAyC,SAAS;AAAA,QACpG;AAGA,cAAM,wBAAwB;AAG9B,qBAAa;AAAA,MACf;AAAA,IACF,SAAS,OAAO;AACd,cAAQ,MAAM,oCAAoC,KAAK;AACvD,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,+BAA+B,MAAM,WAAW,kBAAkB,OAAO;AAAA,MACjG;AAAA,IACF;AAAA,EACF;AAKA,WAAS,eAAe;AACtB,UAAM,cAAc,SAAS,eAAe,cAAc;AAC1D,QAAI,CAAC;AAAa;AAElB,QAAI,aAAa;AAEf,kBAAY,YAAY;AAAA;AAAA;AAAA;AAAA,2DAI+B,YAAY,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAkB1E,OAAO;AAEL,kBAAY,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAyD1B;AAAA,EACF;AAKA,WAAS,gBAAgB,OAAO;AAC9B,UAAM,UAAU,OAAO,WAAW;AAElC,QAAI,QAAQ,SAAS,2BAA2B,GAAG;AACjD,aAAO;AAAA,IACT;AACA,QAAI,QAAQ,SAAS,qBAAqB,GAAG;AAC3C,aAAO;AAAA,IACT;AACA,QAAI,QAAQ,SAAS,yBAAyB,GAAG;AAC/C,aAAO;AAAA,IACT;AACA,QAAI,QAAQ,SAAS,0CAA0C,GAAG;AAChE,aAAO;AAAA,IACT;AACA,QAAI,QAAQ,SAAS,gBAAgB,KAAK,QAAQ,SAAS,0BAA0B,GAAG;AACtF,aAAO;AAAA,IACT;AACA,QAAI,QAAQ,SAAS,YAAY,KAAK,QAAQ,SAAS,2BAA2B,GAAG;AACnF,aAAO;AAAA,IACT;AACA,QAAI,QAAQ,SAAS,uBAAuB,GAAG;AAC7C,aAAO;AAAA,IACT;AACA,QAAI,QAAQ,SAAS,SAAS,KAAK,QAAQ,SAAS,OAAO,GAAG;AAC5D,aAAO;AAAA,IACT;AAGA,WAAO;AAAA,EACT;AAKA,WAAS,gBAAgB,SAAS;AAChC,UAAM,aAAa,SAAS,eAAe,cAAc;AACzD,UAAM,WAAW,SAAS,eAAe,YAAY;AAErD,QAAI,CAAC;AAAY;AAGjB,QAAI;AAAU,eAAS,MAAM,UAAU;AAGvC,eAAW,cAAc;AACzB,eAAW,MAAM,UAAU;AAC3B,eAAW,MAAM,UAAU;AAG3B,eAAW,MAAM;AACf,iBAAW,MAAM,UAAU;AAC3B,iBAAW,MAAM;AACf,mBAAW,MAAM,UAAU;AAAA,MAC7B,GAAG,GAAG;AAAA,IACR,GAAG,GAAI;AAAA,EACT;AAKA,SAAO,2BAA2B,SAAS,iBAAiB,gBAAgB;AAC1E,UAAM,gBAAgB,SAAS,eAAe,eAAe;AAC7D,UAAM,eAAe,SAAS,eAAe,cAAc;AAE3D,QAAI,CAAC,iBAAiB,CAAC;AAAc;AAErC,UAAM,UAAU;AAChB,UAAM,eAAe;AAErB,QAAI,cAAc,SAAS,YAAY;AACrC,oBAAc,OAAO;AACrB,mBAAa,YAAY;AACzB,mBAAa,aAAa,cAAc,eAAe;AAAA,IACzD,OAAO;AACL,oBAAc,OAAO;AACrB,mBAAa,YAAY;AACzB,mBAAa,aAAa,cAAc,eAAe;AAAA,IACzD;AAAA,EACF;AAKA,SAAO,eAAe,iBAAiB;AACrC,UAAM,QAAQ,SAAS,eAAe,YAAY,EAAE,MAAM,KAAK;AAC/D,UAAM,WAAW,SAAS,eAAe,eAAe,EAAE;AAC1D,UAAM,WAAW,SAAS,eAAe,YAAY;AACrD,UAAM,YAAY,SAAS,cAAc,kCAAkC;AAE3E,QAAI,CAAC,SAAS,CAAC,UAAU;AACvB,eAAS,cAAc;AACvB,eAAS,MAAM,UAAU;AACzB;AAAA,IACF;AAGA,QAAI,WAAW;AACb,gBAAU,WAAW;AACrB,gBAAU,cAAc;AAAA,IAC1B;AAEA,UAAM,SAAS,MAAM,OAAO,OAAO,QAAQ;AAG3C,QAAI,WAAW;AACb,gBAAU,WAAW;AACrB,gBAAU,cAAc;AAAA,IAC1B;AAEA,QAAI,CAAC,OAAO,SAAS;AACnB,eAAS,cAAc,gBAAgB,MAAM;AAC7C,eAAS,MAAM,UAAU;AAAA,IAC3B,OAAO;AACL,eAAS,MAAM,UAAU;AACzB,sBAAgB,gCAA2B;AAAA,IAC7C;AAAA,EACF;AAKA,SAAO,eAAe,iBAAiB;AACrC,UAAM,QAAQ,SAAS,eAAe,YAAY,EAAE,MAAM,KAAK;AAC/D,UAAM,WAAW,SAAS,eAAe,eAAe,EAAE;AAC1D,UAAM,WAAW,SAAS,eAAe,YAAY;AACrD,UAAM,YAAY,SAAS,cAAc,kCAAkC;AAG3E,aAAS,MAAM,QAAQ;AAEvB,QAAI,CAAC,SAAS,CAAC,UAAU;AACvB,eAAS,cAAc;AACvB,eAAS,MAAM,UAAU;AACzB;AAAA,IACF;AAGA,UAAM,aAAa;AACnB,QAAI,CAAC,WAAW,KAAK,KAAK,GAAG;AAC3B,eAAS,cAAc;AACvB,eAAS,MAAM,UAAU;AACzB;AAAA,IACF;AAEA,QAAI,SAAS,SAAS,GAAG;AACvB,eAAS,cAAc;AACvB,eAAS,MAAM,UAAU;AACzB;AAAA,IACF;AAGA,QAAI,WAAW;AACb,gBAAU,WAAW;AACrB,gBAAU,cAAc;AAAA,IAC1B;AAEA,UAAM,SAAS,MAAM,OAAO,OAAO,QAAQ;AAG3C,QAAI,WAAW;AACb,gBAAU,WAAW;AACrB,gBAAU,cAAc;AAAA,IAC1B;AAEA,QAAI,CAAC,OAAO,SAAS;AACnB,eAAS,cAAc,gBAAgB,MAAM;AAC7C,eAAS,MAAM,UAAU;AAAA,IAC3B,OAAO;AACL,eAAS,MAAM,UAAU;AACzB,sBAAgB,sCAAiC;AAAA,IACnD;AAAA,EACF;AAKA,SAAO,uBAAuB,iBAAiB;AAC7C,UAAM,WAAW,SAAS,eAAe,qBAAqB;AAC9D,UAAM,YAAY,SAAS,eAAe,cAAc;AAExD,QAAI,CAAC,YAAY,CAAC;AAAW;AAG7B,iBAAa,WAAW,wBAAwB;AAGhD,aAAS,WAAW;AACpB,aAAS,cAAc;AACvB,cAAU,MAAM,UAAU;AAC1B,cAAU,MAAM,QAAQ;AACxB,cAAU,cAAc;AAExB,QAAI;AACF,YAAM,wBAAwB;AAG9B,gBAAU,MAAM,QAAQ;AACxB,gBAAU,cAAc;AAGxB,iBAAW,MAAM;AACf,kBAAU,MAAM,UAAU;AAAA,MAC5B,GAAG,GAAI;AAAA,IACT,SAAS,OAAO;AACd,cAAQ,MAAM,0BAA0B,KAAK;AAC7C,gBAAU,MAAM,QAAQ;AACxB,gBAAU,cAAc,iBAAY,MAAM,WAAW,2BAA2B;AAAA,IAClF,UAAE;AAEA,eAAS,WAAW;AACpB,eAAS,cAAc;AAAA,IACzB;AAAA,EACF;AAMA,SAAO,wBAAwB,iBAAiB;AAC9C,UAAM,YAAY,SAAS,eAAe,sBAAsB;AAChE,UAAM,YAAY,SAAS,eAAe,aAAa;AAEvD,QAAI,CAAC,WAAW;AACd,cAAQ,MAAM,yBAAyB;AACvC;AAAA,IACF;AAEA,QAAI,CAAC,WAAW;AACd,cAAQ,MAAM,sBAAsB;AACpC;AAAA,IACF;AAGA,UAAM,WAAW,MAAM,IAAI,OAAO,MAAM;AACxC,UAAM,WAAW,cACb,iBAAiB,YAAY,EAAE,KAC/B,iBAAiB,QAAQ;AAC7B,UAAM,aAAa,aAAa,QAAQ,QAAQ;AAEhD,QAAI,CAAC,oBAAoB,CAAC,YAAY;AACpC,cAAQ,KAAK,wBAAwB;AACrC,gBAAU,MAAM,UAAU;AAC1B,gBAAU,MAAM,QAAQ;AACxB,gBAAU,cAAc;AACxB,iBAAW,MAAM;AACf,kBAAU,MAAM,UAAU;AAAA,MAC5B,GAAG,GAAI;AACP;AAAA,IACF;AAGA,UAAM,gBAAgB,kBAAkB,QAAQ;AAGhD,QAAI,CAAC,QAAQ,UAAU,aAAa;AAAA;AAAA,kGAAkI,GAAG;AACvK;AAAA,IACF;AAGA,cAAU,WAAW;AACrB,cAAU,cAAc;AACxB,cAAU,MAAM,UAAU;AAC1B,cAAU,MAAM,QAAQ;AACxB,cAAU,cAAc;AAExB,QAAI;AACF,UAAI,qBAAqB;AAGzB,UAAI,eAAe,kBAAkB;AACnC,YAAI;AAEF,gBAAM,WAAW,MAAM;AAAA,YACrB,GAAG,YAAY;AAAA,YACf;AAAA,cACE,QAAQ;AAAA,cACR,SAAS;AAAA,cACT,MAAM,KAAK,UAAU;AAAA,gBACnB,iBAAiB;AAAA,gBACjB,gBAAgB,YAAY;AAAA,cAC9B,CAAC;AAAA,YACH;AAAA,UACF;AAEA,cAAI,SAAS,IAAI;AACf,kBAAM,SAAS,MAAM,SAAS,KAAK;AACnC,iCAAqB,OAAO;AAC5B,oBAAQ,IAAI,sCAAiC;AAAA,UAC/C,OAAO;AACL,oBAAQ,KAAK,wEAA8D;AAAA,UAC7E;AAAA,QACF,SAAS,YAAY;AACnB,kBAAQ,KAAK,mEAAyD,UAAU;AAAA,QAClF;AAAA,MACF,OAAO;AACL,gBAAQ,IAAI,uDAA6C;AAAA,MAC3D;AAGA,YAAM,aAAa,GAAG,QAAQ;AAC9B,mBAAa,WAAW,QAAQ;AAChC,mBAAa,WAAW,UAAU;AAGlC,mBAAa,QAAQ,0BAA0B,MAAM;AAGrD,yBAAmB;AACnB,sBAAgB,CAAC;AAGjB,gBAAU,MAAM,QAAQ;AACxB,UAAI,oBAAoB;AACtB,kBAAU,cAAc;AAAA,MAC1B,WAAW,aAAa;AACtB,kBAAU,cAAc;AAAA,MAC1B,OAAO;AACL,kBAAU,cAAc;AAAA,MAC1B;AAGA,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,qBAAqB,4CAA4C,kCAAkC,SAAS;AAAA,MACpI;AAGA,sBAAgB;AAGhB,iBAAW,MAAM;AACf,kBAAU,MAAM,UAAU;AAAA,MAC5B,GAAG,GAAI;AAAA,IACT,SAAS,OAAO;AACd,cAAQ,MAAM,iBAAiB,KAAK;AACpC,gBAAU,MAAM,QAAQ;AACxB,gBAAU,cAAc,iBAAY,MAAM,WAAW,4BAA4B;AAEjF,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,8BAA8B,MAAM,OAAO,IAAI,OAAO;AAAA,MAC9E;AAGA,gBAAU,WAAW;AACrB,gBAAU,cAAc;AAAA,IAC1B;AAAA,EACF;AAOA,iBAAe,0BAA0B;AACvC,QAAI;AAEF,YAAM,WAAW,MAAM,IAAI,OAAO,MAAM;AAGxC,UAAI;AACJ,UAAI;AAEJ,UAAI,aAAa;AAEf,qBAAa,oBAAoB,mBAAmB,YAAY,EAAE,CAAC;AACnE,mBAAW,iBAAiB,YAAY,EAAE;AAC1C,gBAAQ,IAAI,kDAA2C,YAAY,EAAE;AAAA,MACvE,OAAO;AAEL,qBAAa,qBAAqB,mBAAmB,QAAQ,CAAC;AAC9D,mBAAW,iBAAiB,QAAQ;AACpC,gBAAQ,IAAI,oDAA6C,QAAQ;AAAA,MACnE;AAGA,YAAM,aAAa,GAAG,QAAQ;AAC9B,YAAM,aAAa,aAAa,QAAQ,QAAQ;AAChD,YAAM,gBAAgB,aAAa,QAAQ,UAAU;AAGrD,UAAI,YAAY;AACd,YAAI;AACF,2BAAiB,KAAK,MAAM,UAAU,CAAC;AAAA,QACzC,SAAS,GAAG;AACV,kBAAQ,KAAK,qCAAqC,CAAC;AAAA,QACrD;AAAA,MACF;AAGA,YAAM,UAAU,EAAE,GAAG,iBAAiB;AACtC,UAAI,eAAe;AACjB,gBAAQ,eAAe,IAAI;AAAA,MAC7B;AAGA,UAAI,eAAe,UAAU;AAC3B,cAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,MAAM,SAAS,KAAK,WAAW;AAC7D,YAAI,SAAS,cAAc;AACzB,kBAAQ,eAAe,IAAI,UAAU,QAAQ,YAAY;AAAA,QAC3D;AAAA,MACF;AAGA,YAAM,WAAW,GAAG,YAAY,4BAA4B,UAAU;AACtE,cAAQ,IAAI,sCAA+B,QAAQ;AACnD,cAAQ,IAAI,sBAAe,OAAO;AAElC,YAAM,WAAW,MAAM,MAAM,UAAU,EAAE,QAAQ,CAAC;AAElD,cAAQ,IAAI,gCAAyB,SAAS,QAAQ,SAAS,UAAU;AAGzE,UAAI,SAAS,WAAW,KAAK;AAC3B,gBAAQ,IAAI,yCAAoC;AAChD,YAAI,YAAY;AACd,gBAAM,mBAAmB;AAAA,QAC3B;AACA;AAAA,MACF;AAEA,UAAI,CAAC,SAAS,IAAI;AAChB,gBAAQ,MAAM,4BAA4B,SAAS,UAAU;AAC7D,YAAI,CAAC,YAAY;AACf,0BAAgB;AAAA,QAClB;AACA;AAAA,MACF;AAEA,YAAM,OAAO,MAAM,SAAS,KAAK;AACjC,YAAM,OAAO,SAAS,QAAQ,IAAI,MAAM;AAExC,cAAQ,IAAI,4BAAqB,IAAI;AAGrC,UAAI,YAAY;AAChB,UAAI,KAAK,WAAW,KAAK,cAAc,KAAK,WAAW,SAAS,GAAG;AAEjE,oBAAY,KAAK,WAAW,CAAC;AAC7B,gBAAQ,IAAI,gEAAyD,SAAS;AAAA,MAChF,WAAW,KAAK,WAAW,KAAK,WAAW;AAEzC,oBAAY,KAAK;AACjB,gBAAQ,IAAI,sCAA+B,SAAS;AAAA,MACtD;AAEA,UAAI,WAAW;AACb,gBAAQ,IAAI,+BAA+B,CAAC,CAAC,UAAU,kBAAkB;AACzE,gBAAQ,IAAI,2BAA2B,CAAC,CAAC,UAAU,cAAc;AAGjE,YAAI;AACJ,YAAI,UAAU,oBAAoB;AAChC,gBAAM,UAAU,UAAU;AAG1B,cAAI,QAAQ,aAAa,QAAQ,qBAAqB,QAAQ,oBAAoB;AAEhF,oBAAQ,IAAI,uCAAgC;AAC5C,gBAAI;AACF,8BAAgB,mBAAmB,SAAS,UAAU,sBAAsB;AAC5E,sBAAQ,IAAI,iCAA4B,aAAa;AAAA,YACvD,SAAS,YAAY;AACnB,sBAAQ,MAAM,0CAAqC,UAAU;AAC7D,8BAAgB;AAAA,YAClB;AAAA,UACF,WAAW,QAAQ,YAAY,QAAQ,aAAa,QAAQ,YAAY;AAEtE,oBAAQ,IAAI,2CAAsC;AAClD,oBAAQ,IAAI,mCAA4B,OAAO,KAAK,QAAQ,QAAQ,CAAC;AACrE,oBAAQ,IAAI,sCAA+B;AAAA,cACzC,SAAS,QAAQ,SAAS;AAAA,cAC1B,eAAe,QAAQ,SAAS;AAAA,cAChC,QAAQ,QAAQ,SAAS;AAAA,cACzB,OAAO,QAAQ,SAAS;AAAA,cACxB,YAAY,QAAQ,SAAS;AAAA,YAC/B,CAAC;AAGD,kBAAM,cAAc,QAAQ,SAAS,WAAW,QAAQ,SAAS,iBAAiB,QAAQ,SAAS,UAAU,QAAQ,SAAS;AAG9H,kBAAM,gBAAgB,IAAI,IAAI,QAAQ,WAAW,IAAI,OAAK,EAAE,IAAI,CAAC;AACjE,oBAAQ,IAAI,+CAAwC,MAAM,KAAK,aAAa,EAAE,KAAK,CAAC;AAGpF,gBAAI;AACF,8BAAgB,OAAO,oBAAoB,OAAO,kBAAkB,OAAO,IAAI,kBAAkB,OAAO;AAGxG,kBAAI,aAAa;AACf,8BAAc,UAAU;AAAA,cAC1B;AAEA,sBAAQ,IAAI,iCAA4B,aAAa;AACrD,sBAAQ,IAAI,6BAAsB,cAAc,UAAU,UAAU,CAAC;AAAA,YACvE,SAAS,YAAY;AACnB,sBAAQ,MAAM,0CAAqC,UAAU;AAE7D,oBAAM,OAAO,QAAQ;AACrB,8BAAgB;AAAA,gBACd,GAAG;AAAA,gBACH,MAAM,QAAQ,SAAS,QAAQ,UAAU;AAAA,gBACzC,MAAM,QAAQ,SAAS,QAAQ,UAAU;AAAA,gBACzC,OAAO,QAAQ,SAAS,SAAS,UAAU;AAAA,gBAC3C,OAAO,QAAQ,SAAS,SAAS,UAAU;AAAA,gBAC3C,SAAS;AAAA,cACX;AAAA,YACF;AAAA,UACF,OAAO;AAEL,oBAAQ,KAAK,+CAAqC;AAClD,4BAAgB;AAAA,UAClB;AAAA,QACF,OAAO;AAEL,0BAAgB;AAAA,QAClB;AAEA,gBAAQ,IAAI,4CAAuC,aAAa;AAGhE,qBAAa,QAAQ,UAAU,KAAK,UAAU,aAAa,CAAC;AAC5D,YAAI,MAAM;AACR,uBAAa,QAAQ,YAAY,IAAI;AAAA,QACvC;AAEA,yBAAiB,aAAa;AAC9B,cAAM,mBAAmB;AAGzB,qBAAa;AAAA,MACf,OAAO;AAEL,qBAAa,WAAW,QAAQ;AAChC,qBAAa,WAAW,UAAU;AAClC,wBAAgB;AAIhB,cAAM,mBAAmB;AAAA,MAC3B;AAAA,IACF,SAAS,OAAO;AACd,cAAQ,MAAM,+CAA0C,KAAK;AAC7D,cAAQ,MAAM,kBAAkB;AAAA,QAC9B,SAAS,MAAM;AAAA,QACf,OAAO,MAAM;AAAA,QACb,MAAM,MAAM;AAAA,MACd,CAAC;AACD,sBAAgB;AAAA,IAClB;AAAA,EACF;AAKA,iBAAe,qBAAqB;AAClC,QAAI;AACF,YAAM,WAAW,MAAM,IAAI,OAAO,MAAM;AAGxC,UAAI,cAAc;AAClB,UAAI,aAAa;AAEf,uBAAe,qBAAqB,mBAAmB,YAAY,EAAE,CAAC;AAAA,MACxE,OAAO;AAEL,uBAAe,sBAAsB,mBAAmB,QAAQ,CAAC;AAAA,MACnE;AAEA,cAAQ,IAAI,iDAA0C,WAAW;AAEjE,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY,4BAA4B,WAAW;AAAA,QACtD,EAAE,SAAS,iBAAiB;AAAA,MAC9B;AAEA,UAAI,CAAC,SAAS,IAAI;AAChB,gBAAQ,MAAM,6BAA6B,SAAS,UAAU;AAC9D;AAAA,MACF;AAEA,YAAM,OAAO,MAAM,SAAS,KAAK;AACjC,cAAQ,IAAI,2CAAoC,IAAI;AACpD,cAAQ,IAAI,mCAA4B,KAAK,YAAY,UAAU,CAAC;AACpE,UAAI,KAAK,cAAc,KAAK,WAAW,SAAS,GAAG;AACjD,gBAAQ,IAAI,8BAAuB,KAAK,WAAW,IAAI,OAAK,EAAE,QAAQ,EAAE,cAAc,EAAE,KAAK,IAAI,CAAC;AAAA,MACpG;AAEA,UAAI,KAAK,WAAW,KAAK,cAAc,KAAK,WAAW,SAAS,GAAG;AACjE,wBAAgB,KAAK;AACrB,gBAAQ,IAAI,0CAAmC,cAAc,QAAQ,YAAY;AACjF,6BAAqB;AAAA,MACvB,OAAO;AACL,gBAAQ,IAAI,yDAA+C;AAC3D,wBAAgB,CAAC;AACjB,cAAM,uBAAuB,SAAS,eAAe,wBAAwB;AAC7E,YAAI,sBAAsB;AACxB,+BAAqB,MAAM,UAAU;AAAA,QACvC;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AACd,cAAQ,MAAM,kCAAkC,KAAK;AAAA,IACvD;AAAA,EACF;AAKA,WAAS,uBAAuB;AAC9B,UAAM,uBAAuB,SAAS,eAAe,wBAAwB;AAC7E,UAAM,gBAAgB,SAAS,eAAe,gBAAgB;AAE9D,QAAI,CAAC,wBAAwB,CAAC,eAAe;AAC3C,cAAQ,MAAM,mCAAmC;AACjD;AAAA,IACF;AAEA,QAAI,CAAC,iBAAiB,cAAc,WAAW,GAAG;AAEhD,cAAQ,IAAI,6CAA6C;AACzD,2BAAqB,MAAM,UAAU;AACrC;AAAA,IACF;AAGA,YAAQ,IAAI,+BAA+B,cAAc,QAAQ,cAAc;AAC/E,yBAAqB,MAAM,UAAU;AAErC,QAAI,OAAO;AACX,kBAAc,QAAQ,CAAC,cAAc;AACnC,YAAM,WAAW,oBAAoB,UAAU,OAAO,iBAAiB;AAEvE,YAAM,gBAAgB,UAAU,QAAQ,UAAU,kBAAkB,UAAU,UAAU,QAAQ;AAChG,cAAQ;AAAA,wCAC4B,WAAW,WAAW,EAAE,iCAAiC,UAAU,EAAE;AAAA,gDAC7D,aAAa;AAAA;AAAA,kBAE3C,UAAU,SAAS,GAAG,IAAI,UAAU,QAAQ,EAAE,IAAI,UAAU,SAAS,EAAE;AAAA,YAC7E,WAAW,kBAAa,EAAE;AAAA;AAAA;AAAA;AAAA,IAIpC,CAAC;AAED,kBAAc,YAAY;AAAA,EAC5B;AAKA,SAAO,oBAAoB,eAAe,aAAa;AACrD,QAAI;AAEF,YAAM,YAAY,cAAc,KAAK,OAAK,EAAE,OAAO,WAAW;AAC9D,UAAI,CAAC,WAAW;AACd,gBAAQ,MAAM,wBAAwB,WAAW;AACjD;AAAA,MACF;AAGA,YAAM,WAAW,MAAM,IAAI,OAAO,MAAM;AACxC,YAAM,cAAc;AAAA,QAClB,iBAAiB;AAAA,QACjB;AAAA,MACF;AAGA,UAAI,aAAa;AACf,oBAAY,iBAAiB,YAAY;AAAA,MAC3C;AAEA,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY;AAAA,QACf;AAAA,UACE,QAAQ;AAAA,UACR,SAAS;AAAA,UACT,MAAM,KAAK,UAAU,WAAW;AAAA,QAClC;AAAA,MACF;AAEA,YAAM,SAAS,MAAM,SAAS,KAAK;AAEnC,UAAI,SAAS,MAAM,OAAO,SAAS;AAEjC,yBAAiB,SAAS;AAC1B,6BAAqB;AACrB,qBAAa;AAEb,YAAI,gBAAgB;AAClB,cAAI,aAAa,KAAK,eAAe,UAAU,IAAI,IAAI,SAAS;AAAA,QAClE;AAAA,MACF,OAAO;AACL,gBAAQ,MAAM,+BAA+B,OAAO,KAAK;AACzD,YAAI,gBAAgB;AAClB,cAAI,aAAa,KAAK,8BAA8B,OAAO;AAAA,QAC7D;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AACd,cAAQ,MAAM,8BAA8B,KAAK;AACjD,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,6BAA6B,OAAO;AAAA,MAC5D;AAAA,IACF;AAAA,EACF;AAKA,WAAS,iBAAiB,WAAW;AAMnC,UAAM,cAAc,UAAU,OAAO,UAAU,MAAM,UAAU;AAC/D,yBAAqB,yBAAyB,IAAI,WAAW,KAAK;AAElE,uBAAmB;AAGnB,qBAAiB,MAAM,UAAU;AACjC,uBAAmB,MAAM,UAAU;AAGnC,UAAM,YAAY,SAAS,eAAe,sBAAsB;AAChE,QAAI,WAAW;AACb,gBAAU,MAAM,UAAU;AAAA,IAC5B;AAIA,YAAQ,IAAI,0DAA8C;AAC1D,YAAQ,IAAI,wBAAwB,UAAU,OAAO;AACrD,YAAQ,IAAI,8BAA8B,UAAU,aAAa;AACjE,YAAQ,IAAI,kCAAkC,UAAU,UAAU,OAAO;AACzE,YAAQ,IAAI,wCAAwC,UAAU,UAAU,aAAa;AAGrF,UAAM,cAAc,UAAU,WACV,UAAU,iBACV,UAAU,UAAU,WACpB,UAAU,UAAU;AAGxC,kBAAc,YAAY;AAAA;AAAA,QAEpB,cAAc,oCAAoC,WAAW,gCAAgC,EAAE;AAAA;AAAA,sCAEjE,UAAU,QAAQ,mBAAmB;AAAA,8CAC7B,UAAU,SAAS,GAAG,IAAI,UAAU,QAAQ,EAAE,IAAI,UAAU,SAAS,EAAE;AAAA,4CACzE,UAAU,WAAW,WAAW,CAAC,MAAM,UAAU,WAAW,OAAO,CAAC;AAAA;AAAA;AAAA;AAM9G,UAAM,mBAAmB,SAAS,eAAe,mBAAmB;AACpE,QAAI,oBAAoB,aAAa;AACnC,wBAAkB,kBAAkB,WAAW,WAAW;AAAA,IAC5D;AAGA,UAAM,sBAAsB,SAAS,eAAe,uBAAuB;AAC3E,UAAM,yBAAyB,SAAS,eAAe,0BAA0B;AACjF,UAAM,oBAAoB,SAAS,eAAe,oBAAoB;AAEtE,QAAI,uBAAuB,wBAAwB;AACjD,0BAAoB,cAAc,UAAU,QAAQ;AACpD,6BAAuB,cAAc,SAAS,UAAU,SAAS,GAAG,IAAI,UAAU,QAAQ,EAAE,IAAI,UAAU,SAAS,EAAE;AAAA,IACvH;AAGA,QAAI,mBAAmB;AACrB,UAAI,aAAa;AACf,0BAAkB,MAAM;AACxB,0BAAkB,MAAM,UAAU;AAClC,gBAAQ,IAAI,gCAA2B,WAAW;AAGlD,0BAAkB,mBAAmB,WAAW,WAAW;AAAA,MAC7D,OAAO;AACL,0BAAkB,MAAM,UAAU;AAClC,gBAAQ,IAAI,0BAAqB;AAAA,MACnC;AAAA,IACF;AAGA,qBAAiB,SAAS;AAC1B,yBAAqB,SAAS;AAC9B,wBAAoB,SAAS;AAC7B,uBAAmB,SAAS;AAC5B,sBAAkB,SAAS;AAC3B,yBAAqB,SAAS;AAE9B,YAAQ,IAAI,mCAA4B,UAAU,IAAI;AAAA,EACxD;AAKA,iBAAe,8BAA8B,SAAS,aAAa;AACjE,QAAI;AAEF,YAAM,WAAW,MAAM,MAAM,OAAO;AACpC,YAAM,OAAO,MAAM,SAAS,KAAK;AAGjC,YAAM,WAAW,SAAS,WAAW,IAAI,KAAK,IAAI,CAAC;AAGnD,YAAM,WAAW,IAAI,SAAS;AAC9B,eAAS,OAAO,QAAQ,MAAM,QAAQ;AACtC,eAAS,OAAO,eAAe,WAAW;AAE1C,YAAM,iBAAiB,MAAM;AAAA,QAC3B,GAAG,YAAY;AAAA,QACf;AAAA,UACE,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,UAC9C;AAAA,UACA,MAAM;AAAA,QACR;AAAA,MACF;AAEA,UAAI,CAAC,eAAe,IAAI;AACtB,cAAM,IAAI,MAAM,kBAAkB,eAAe,UAAU,EAAE;AAAA,MAC/D;AAEA,YAAM,OAAO,MAAM,eAAe,KAAK;AACvC,aAAO,KAAK;AAAA,IACd,SAAS,OAAO;AACd,cAAQ,MAAM,iCAAiC,KAAK;AACpD,YAAM;AAAA,IACR;AAAA,EACF;AAKA,iBAAe,oBAAoB,UAAU,MAAM;AACjD,WAAO,IAAI,QAAQ,CAAC,YAAY;AAC9B,YAAM,MAAM,IAAI,MAAM;AACtB,UAAI,cAAc;AAElB,UAAI,SAAS,MAAM;AAEjB,cAAM,cAAc,KAAK,IAAI,GAAG,OAAO,IAAI;AAC3C,cAAM,SAAS,SAAS,cAAc,QAAQ;AAC9C,eAAO,QAAQ;AACf,eAAO,SAAS;AAChB,cAAM,MAAM,OAAO,WAAW,IAAI;AAGlC,YAAI,KAAK;AAGT,cAAM,SAAU,OAAO,IAAM,cAAc;AAC3C,YAAI,UAAU;AACd,YAAI,IAAI,OAAO,GAAG,OAAO,GAAG,QAAQ,GAAG,KAAK,KAAK,CAAC;AAClD,YAAI,UAAU;AACd,YAAI,KAAK;AAGT,cAAM,QAAQ,KAAK,IAAI,OAAO,IAAI,OAAO,OAAO,IAAI,MAAM;AAC1D,cAAM,IAAK,OAAO,IAAM,IAAI,QAAQ,IAAK;AACzC,cAAM,IAAK,OAAO,IAAM,IAAI,SAAS,IAAK;AAC1C,YAAI,UAAU,KAAK,GAAG,GAAG,IAAI,QAAQ,OAAO,IAAI,SAAS,KAAK;AAG9D,YAAI,QAAQ;AAGZ,YAAI,UAAU;AACd,YAAI,IAAI,OAAO,GAAG,OAAO,GAAG,QAAQ,GAAG,KAAK,KAAK,CAAC;AAClD,cAAM,QAAQ,aAAa,gBAAgB;AAC3C,YAAI,cAAc,QAAQ,MAAM,UAAU;AAC1C,YAAI,YAAY;AAChB,YAAI,OAAO;AAGX,gBAAQ,OAAO,UAAU,WAAW,CAAC;AAAA,MACvC;AAEA,UAAI,UAAU,MAAM;AAClB,gBAAQ,KAAK,wDAAwD;AACrE,gBAAQ,QAAQ;AAAA,MAClB;AAEA,UAAI,MAAM;AAAA,IACZ,CAAC;AAAA,EACH;AAKA,WAAS,kBAAkB,iBAAiB,WAAW,aAAa;AAClE,QAAI,CAAC;AAAgB;AAGrB,oBAAgB,YAAY;AAC5B,oBAAgB,MAAM,SAAS;AAC/B,oBAAgB,QAAQ;AAGxB,oBAAgB,iBAAiB,aAAa,CAAC,MAAM;AACnD,sBAAgB,MAAM,SAAS;AAC/B,QAAE,aAAa,gBAAgB;AAG/B,QAAE,aAAa,QAAQ,iBAAiB,WAAW;AACnD,QAAE,aAAa,QAAQ,cAAc,WAAW;AAChD,QAAE,aAAa,QAAQ,aAAa,aAAa,WAAW,UAAU,UAAU,IAAI,IAAI;AACxF,QAAE,aAAa,QAAQ,eAAe,aAAa,UAAU,IAAI,QAAQ,WAAW,EAAE;AAGtF,YAAM,MAAM,IAAI,MAAM;AACtB,UAAI,MAAM;AACV,QAAE,aAAa,aAAa,iBAAiB,IAAI,EAAE;AAEnD,cAAQ,IAAI,mCAA4B,UAAU,MAAM,UAAU,WAAW;AAAA,IAC/E,CAAC;AAED,oBAAgB,iBAAiB,WAAW,MAAM;AAChD,sBAAgB,MAAM,SAAS;AAAA,IACjC,CAAC;AAGD,oBAAgB,UAAU,OAAO,MAAM;AAErC,UAAI,EAAE,WAAW;AAAG;AAEpB,UAAI;AACF,gBAAQ,IAAI,gCAAyB,UAAU,IAAI;AAGnD,cAAM,MAAM,MAAM,IAAI,MAAM,KAAK,OAAO;AAGxC,gBAAQ,IAAI,4CAAqC;AACjD,cAAM,kBAAkB,MAAM,oBAAoB,aAAa,MAAM,CAAC;AAEtE,gBAAQ,IAAI,oCAA6B;AACzC,cAAM,mBAAmB,MAAM,8BAA8B,iBAAiB,UAAU,EAAE;AAG1F,cAAM,WAAW,MAAM,IAAI,OAAO,MAAM;AAGxC,cAAM,QAAQ;AAAA,UACZ;AAAA,YACE,QAAQ;AAAA,YACR,OAAO;AAAA,YACP,KAAK;AAAA,YACL,MAAM;AAAA,UACR;AAAA,UACA;AAAA,YACE;AAAA,YACA,QAAQ,EAAE,GAAG,GAAG,GAAG,EAAE;AAAA,UACvB;AAAA,QACF,EACG,MAAM,WAAW,EACjB,OAAO,KAAK,EACZ,KAAK,UAAU,QAAQ,WAAW,EAClC,UAAU,UAAU,QAAQ,WAAW,EACvC,SAAS;AAAA,UACR,UAAU;AAAA,YACR,aAAa,UAAU;AAAA,YACvB,eAAe,UAAU;AAAA,YACzB,aAAa,UAAU;AAAA,YACvB;AAAA,UACF;AAAA,QACF,CAAC,EACA,MAAM;AAET,gBAAQ,IAAI,0BAAmB,KAAK;AAGpC,cAAM,IAAI,MAAM,MAAM,SAAS,CAAC,KAAK,CAAC;AAGtC,YAAI,aAAa,KAAK,SAAS,UAAU,IAAI,WAAW,SAAS;AACjE,gBAAQ,IAAI,oDAA+C,MAAM,QAAQ;AAAA,MAC3E,SAAS,OAAO;AACd,gBAAQ,MAAM,gCAA2B,KAAK;AAC9C,YAAI,aAAa,KAAK,2BAA2B,MAAM,OAAO,IAAI,OAAO;AAAA,MAC3E;AAAA,IACF;AAAA,EACF;AAKA,WAAS,iBAAiB,WAAW;AACnC,UAAM,eAAe,SAAS,eAAe,eAAe;AAE5D,UAAM,KAAK,UAAU,aAAa,CAAC;AACnC,UAAM,SAAS,UAAU,eAAe;AACxC,UAAM,KAAK,UAAU,cAAc;AACnC,UAAM,QAAQ,UAAU,SAAS;AACjC,UAAM,aAAa,UAAU,cAAc;AAC3C,UAAM,mBAAmB,UAAU,oBAAoB,KAAK,OAAO,UAAU,SAAS,KAAK,CAAC,IAAI;AAGhG,QAAI,OAAO;AAAA;AAAA;AAAA;AAAA,kCAIqB,GAAG,WAAW,CAAC;AAAA,uCACV,GAAG,OAAO,CAAC;AAAA;AAAA;AAAA,QAG1C,SAAS,IAAI;AAAA;AAAA;AAAA,0DAGqC,MAAM;AAAA;AAAA,UAEtD,EAAE;AAAA;AAAA;AAAA;AAAA,kCAIsB,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA,kCAKF,KAAK;AAAA;AAAA;AAAA;AAAA,+EAIwC,UAAU;AAAA;AAAA,kCAEvD,cAAc,IAAI,MAAM,EAAE,GAAG,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA,mCAKtC,gBAAgB;AAAA;AAAA;AAAA;AAMjD,QAAI,UAAU,SAAS;AACrB,YAAM,UAAU,UAAU;AAC1B,cAAQ;AAAA;AAAA;AAAA;AAAA;AAAA,oCAKwB,QAAQ,WAAW,CAAC;AAAA,yCACf,QAAQ,OAAO,CAAC,KAAK,QAAQ,QAAQ,GAAG;AAAA;AAAA;AAAA;AAAA,IAI/E;AAGA,QAAI,UAAU,eAAe,UAAU,WAAW,YAAY,KAAK,UAAU,WAAW,WAAW,IAAI;AACrG,cAAQ;AAAA;AAAA;AAAA;AAAA;AAAA,4DAKgD,UAAU,WAAW,aAAa,CAAC;AAAA;AAAA;AAAA;AAAA,4DAInC,UAAU,WAAW,YAAY,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA,IAK5F;AAKA,UAAM,gBAAgB,UAAU,cAAc,OAAO,KAAK,UAAU,UAAU,EAAE;AAAA,MAAK,SACnF,IAAI,SAAS,KAAK,KAAK,UAAU,WAAW,GAAG,IAAI;AAAA,IACrD;AAEA,QAAI,eAAe;AACjB,cAAQ;AACR,cAAQ;AAGR,eAAS,QAAQ,GAAG,SAAS,GAAG,SAAS;AACvC,cAAM,UAAU,UAAU,WAAW,QAAQ,KAAK,YAAY,KAAK;AACnE,cAAM,MAAM,UAAU,WAAW,QAAQ,KAAK,eAAe,KAAK;AAElE,YAAI,MAAM,GAAG;AACX,kBAAQ;AAAA,kCACkB,YAAY,IAAI,UAAU,EAAE,uDAAuD,KAAK;AAAA,4CAC9E,KAAK;AAAA,sCACX,OAAO,IAAI,GAAG;AAAA;AAAA;AAAA,QAG9C;AAAA,MACF;AAGA,YAAM,cAAc,UAAU,WAAW,kBAAkB;AAC3D,YAAM,UAAU,UAAU,WAAW,qBAAqB;AAC1D,YAAM,YAAY,UAAU,WAAW,sBAAsB;AAE7D,UAAI,UAAU,GAAG;AACf,gBAAQ;AAAA,2CAC6B,gBAAgB,IAAI,UAAU,EAAE;AAAA,yCAClC,SAAS;AAAA,oCACd,WAAW,IAAI,OAAO;AAAA;AAAA;AAAA,MAGtD;AAEA,cAAQ;AAAA,IACV;AAGA,QAAI,UAAU,aAAa,UAAU,UAAU,SAAS,GAAG;AACzD,YAAM,oBAAoB,UAAU,UAAU,OAAO,OAAK;AACxD,YAAI,EAAE,QAAQ;AAAG,iBAAO;AACxB,cAAM,YAAY,EAAE,KAAK,YAAY,EAAE,KAAK;AAC5C,YAAI,UAAU,SAAS,aAAa,KAAK,cAAc;AAAS,iBAAO;AACvE,YAAI,UAAU,SAAS,WAAW,KAAK,cAAc;AAAM,iBAAO;AAClE,YAAI,cAAc;AAAe,iBAAO;AACxC,eAAO;AAAA,MACT,CAAC;AAED,UAAI,kBAAkB,SAAS,GAAG;AAChC,gBAAQ;AACR,gBAAQ;AAER,0BAAkB,QAAQ,cAAY;AACpC,kBAAQ;AAAA,yFACyE,SAAS,KAAK,QAAQ,MAAM,KAAK,CAAC,+BAA+B,SAAS,IAAI;AAAA,yCAC9H,SAAS,IAAI;AAAA,0CACZ,SAAS,WAAW,CAAC;AAAA,0CACrB,SAAS,OAAO,CAAC;AAAA;AAAA;AAAA,QAGrD,CAAC;AAED,gBAAQ;AAAA,MACV;AAAA,IACF;AAGA,YAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAWR,iBAAa,YAAY;AAAA,EAC3B;AAMA,WAAS,qBAAqB,WAAW;AACvC,UAAM,mBAAmB,SAAS,eAAe,mBAAmB;AAGpE,UAAM,eAAe,CAAC,YAAY,aAAa,gBAAgB,gBAAgB,UAAU,UAAU;AACnG,UAAM,oBAAoB,EAAE,UAAU,OAAO,WAAW,OAAO,cAAc,OAAO,cAAc,OAAO,QAAQ,OAAO,UAAU,MAAM;AAExI,QAAI,OAAO;AACX,YAAQ;AAER,iBAAa,QAAQ,iBAAe;AAClC,YAAM,QAAQ,UAAU,aAAa,WAAW,KAAK;AACrD,YAAMD,YAAW,UAAU,gBAAgB,WAAW,KAAK,KAAK,OAAO,QAAQ,MAAM,CAAC;AACtF,YAAM,UAAU,UAAU,eAAe,WAAW,KAAKA;AACzD,YAAM,eAAe,YAAYA;AACjC,YAAM,eAAe,kBAAkB,WAAW;AAElD,cAAQ;AAAA,gCACoB,eAAe,oBAAoB,EAAE;AAAA;AAAA,sCAE/B,YAAY;AAAA,mFACiC,KAAK;AAAA;AAAA;AAAA,8MAGsH,YAAY,MAAMA,SAAQ,kBAAkB,YAAY;AAAA;AAAA,oEAElMA,aAAY,IAAI,MAAM,EAAE,GAAGA,SAAQ;AAAA;AAAA,gKAEyD,YAAY,MAAM,OAAO,kBAAkB,YAAY;AAAA,kDACrK,eAAe,YAAY,4BAA4B;AAAA,oDACrD,eAAe,YAAY,SAAS,4BAA4B,WAAW,IAAI,MAAM,EAAE,GAAG,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA,IAKnJ,CAAC;AAED,YAAQ;AAGR,QAAI,UAAU,UAAU,OAAO,KAAK,UAAU,MAAM,EAAE,SAAS,GAAG;AAChE,cAAQ;AACR,cAAQ;AAER,YAAM,aAAa;AAAA,QACjB,YAAY;AAAA,QAAc,gBAAgB;AAAA,QAAmB,QAAQ;AAAA,QACrE,WAAW;AAAA,QAAa,WAAW;AAAA,QAAa,SAAS;AAAA,QACzD,SAAS;AAAA,QAAW,cAAc;AAAA,QAAgB,eAAe;AAAA,QACjE,UAAU;AAAA,QAAY,QAAQ;AAAA,QAAU,YAAY;AAAA,QACpD,aAAa;AAAA,QAAe,YAAY;AAAA,QAAc,UAAU;AAAA,QAChE,eAAe;AAAA,QAAmB,SAAS;AAAA,QAAW,UAAU;AAAA,MAClE;AAEA,aAAO,QAAQ,UAAU,MAAM,EAAE,QAAQ,CAAC,CAAC,UAAU,KAAK,MAAM;AAC9D,cAAM,YAAY,WAAW,QAAQ,KAAK;AAG1C,cAAM,kBAAkB;AAAA,UACtB,YAAY;AAAA,UAAa,gBAAgB;AAAA,UAAU,QAAQ;AAAA,UAC3D,WAAW;AAAA,UAAY,WAAW;AAAA,UAAY,SAAS;AAAA,UACvD,SAAS;AAAA,UAAU,cAAc;AAAA,UAAY,eAAe;AAAA,UAC5D,UAAU;AAAA,UAAU,QAAQ;AAAA,UAAgB,YAAY;AAAA,UACxD,aAAa;AAAA,UAAY,YAAY;AAAA,UAAY,UAAU;AAAA,UAC3D,eAAe;AAAA,UAAa,SAAS;AAAA,UAAa,UAAU;AAAA,QAC9D;AAEA,cAAM,cAAc,gBAAgB,QAAQ,KAAK;AACjD,cAAM,UAAU,UAAU,gBAAgB,WAAW,KAAK;AAC1D,cAAM,YAAY,UAAU,oBAAoB;AAEhD,YAAI,mBAAmB;AACvB,YAAI,UAAU,UAAU,WAAW;AACjC,6BAAmB;AAAA,QACrB,WAAW,UAAU,UAAW,YAAY,GAAI;AAC9C,6BAAmB;AAAA,QACrB;AAEA,gBAAQ;AAAA,iCACmB,gBAAgB,8BAA8B,SAAS,MAAM,KAAK,2BAA2B,SAAS;AAAA,qCAClG,SAAS;AAAA,sCACR,SAAS,IAAI,MAAM,EAAE,GAAG,KAAK;AAAA;AAAA;AAAA,MAG/D,CAAC;AAED,cAAQ;AAAA,IACV;AAEA,qBAAiB,YAAY;AAAA,EAC/B;AAKA,WAAS,oBAAoB,WAAW;AACtC,UAAM,kBAAkB,SAAS,eAAe,kBAAkB;AAElE,QAAI,OAAO;AAGX,QAAI,UAAU,YAAY,UAAU,SAAS,SAAS,GAAG;AAEvD,YAAM,mBAAmB,UAAU,SAAS,OAAO,aAAW;AAC5D,cAAM,QAAQ,QAAQ,QAAQ,IAAI,YAAY;AAE9C,YAAI,KAAK,MAAM,qBAAqB,KAAK,SAAS,gBAAgB;AAChE,iBAAO;AAAA,QACT;AAEA,YAAI,KAAK,SAAS,eAAe,KAAK,KAAK,SAAS,aAAa,GAAG;AAClE,iBAAO;AAAA,QACT;AACA,eAAO;AAAA,MACT,CAAC;AAED,UAAI,iBAAiB,SAAS,GAAG;AAC/B,gBAAQ;AAER,yBAAiB,QAAQ,CAAC,SAAS,UAAU;AAC3C,gBAAM,YAAY,WAAW,KAAK;AAClC,gBAAM,OAAO,QAAQ;AAGrB,cAAI,eAAe;AACnB,gBAAM,eAAe,QAAQ,QAAQ,IAAI,YAAY;AACrD,cAAI,YAAY,SAAS,kBAAkB,GAAG;AAC5C,2BAAe;AAAA,UACjB,WAAW,YAAY,SAAS,UAAU,KAAK,YAAY,SAAS,KAAK,GAAG;AAC1E,2BAAe;AAAA,UACjB,WAAW,YAAY,SAAS,oBAAoB,GAAG;AACrD,2BAAe;AAAA,UACjB,WAAW,YAAY,SAAS,aAAa,GAAG;AAC9C,2BAAe;AAAA,UACjB,WAAW,YAAY,SAAS,eAAe,GAAG;AAChD,2BAAe;AAAA,UACjB;AAGA,cAAI,gBAAgB;AACpB,cAAI,QAAQ,KAAK,UAAU,QAAW;AAEpC,4BAAgB,yHAAyH,QAAQ,QAAQ,WAAW,QAAQ,MAAM,KAAK,CAAC,mBAAc,KAAK,KAAK,IAAI,KAAK,OAAO,KAAK,KAAK;AAAA,UAC5O,WAAW,cAAc;AAEvB,4BAAgB,iHAAiH,QAAQ,QAAQ,WAAW,QAAQ,MAAM,KAAK,CAAC,OAAO,YAAY;AAAA,UACrM;AAGA,cAAI,cAAc;AAClB,cAAI,QAAQ,SAAS;AACnB,2BAAe,oCAAoC,QAAQ,OAAO;AAAA,UACpE;AACA,cAAI,QAAQ,aAAa;AACvB,2BAAe,oCAAoC,QAAQ,WAAW;AAAA,UACxE;AAEA,kBAAQ;AAAA;AAAA,sEAEsD,SAAS;AAAA,0CACrC,QAAQ,QAAQ,iBAAiB;AAAA;AAAA;AAAA,uBAGpD,SAAS;AAAA,gBAChB,WAAW;AAAA,gBACX,QAAQ,SAAS,gHAAgH,QAAQ,MAAM,iBAAiB,EAAE;AAAA,gBAClK,aAAa;AAAA;AAAA;AAAA;AAAA,QAIvB,CAAC;AAED,gBAAQ;AAAA,MACV,OAAO;AACL,eAAO;AAAA,MACT;AAAA,IACF,OAAO;AACL,aAAO;AAAA,IACT;AAEA,oBAAgB,YAAY;AAAA,EAC9B;AAKA,WAAS,mBAAmB,WAAW;AACrC,UAAM,iBAAiB,SAAS,eAAe,iBAAiB;AAEhE,QAAI,OAAO;AAGX,QAAI,UAAU,WAAW,UAAU,QAAQ,SAAS,GAAG;AAErD,YAAM,sBAAsB,mBAAmB,UAAU,OAAO;AAEhE,cAAQ;AAER,0BAAoB,QAAQ,CAAC,QAAQ,UAAU;AAC7C,cAAM,WAAW,UAAU,KAAK;AAChC,cAAM,aAAa,OAAO,cAAc;AACxC,cAAM,SAAS,OAAO,UAAU;AAChC,cAAM,aAAa,OAAO,cAAc;AACxC,cAAM,OAAO,OAAO;AAGpB,gBAAQ,IAAI,sBAAsB,OAAO,IAAI,WAAW,IAAI;AAG5D,YAAI,cAAc;AAClB,YAAI,YAAY;AACd,gBAAM,aAAa,WAAW,MAAM,WAAW;AAC/C,cAAI,YAAY;AACd,0BAAc,SAAS,WAAW,CAAC,CAAC;AAAA,UACtC;AAAA,QACF;AAGA,YAAI,gBAAgB;AAGpB,cAAM,YAAY,cAAc,WAAW,KAAK;AAChD,cAAM,YAAY,UAAU,OAAO,KAAK;AAExC,YAAI,iBAAiB;AACrB,YAAI,aAAa,WAAW;AAC1B,2BAAiB;AAEjB,cAAI,WAAW;AACb,8BAAkB,gGAAgG,OAAO,QAAQ,UAAU,QAAQ,MAAM,KAAK,CAAC,MAAM,WAAW;AAAA,UAClL;AAEA,cAAI,WAAW;AACb,8BAAkB,gGAAgG,OAAO,QAAQ,UAAU,QAAQ,MAAM,KAAK,CAAC,OAAO,aAAa;AAAA,UACrL;AAEA,4BAAkB;AAAA,QACpB;AAGA,cAAM,gBAAiB,QAAQ,KAAK,UAAU,SAC5C,gHAAgH,OAAO,QAAQ,UAAU,QAAQ,MAAM,KAAK,CAAC,4BAAuB;AAEtL,cAAM,gBAAgB,aAAa;AAGnC,cAAM,mBAAmB,gBAAgB,WAAW;AACpD,cAAM,iBAAiB,GAAG,gBAAgB,MAAM,WAAW,YAAY,CAAC;AAGxE,YAAI,aAAa;AACjB,YAAI,OAAO,SAAS;AAClB,wBAAc,oCAAoC,OAAO,OAAO;AAAA,QAClE;AACA,YAAI,OAAO,aAAa;AACtB,wBAAc,oCAAoC,OAAO,WAAW;AAAA,QACtE;AAEA,gBAAQ;AAAA;AAAA,oEAEsD,QAAQ;AAAA,wCACpC,OAAO,QAAQ,gBAAgB;AAAA;AAAA;AAAA,qBAGlD,QAAQ;AAAA;AAAA,6FAEgE,cAAc;AAAA,gBAC3F,aAAa,kFAAkF,UAAU,WAAW,EAAE;AAAA,gBACtH,SAAS,kFAAkF,MAAM,WAAW,EAAE;AAAA,gBAC9G,QAAQ,KAAK,UAAU,SAAY,gFAAgF,KAAK,KAAK,IAAI,KAAK,OAAO,KAAK,KAAK,WAAW,EAAE;AAAA;AAAA,cAEtK,UAAU;AAAA,cACV,cAAc;AAAA,cACd,aAAa;AAAA;AAAA;AAAA;AAAA,MAIvB,CAAC;AAED,cAAQ;AAAA,IACV,OAAO;AACL,aAAO;AAAA,IACT;AAEA,mBAAe,YAAY;AAAA,EAC7B;AAKA,WAAS,mBAAmB,SAAS;AACnC,UAAM,sBAAsB,CAAC,SAAS;AACpC,UAAI,CAAC;AAAM,eAAO;AAClB,YAAM,iBAAiB;AAAA,QACrB;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACF;AAEA,UAAI,aAAa,KAAK,KAAK;AAC3B,iBAAW,WAAW,gBAAgB;AACpC,qBAAa,WAAW,QAAQ,SAAS,EAAE;AAAA,MAC7C;AACA,aAAO,WAAW,KAAK;AAAA,IACzB;AAEA,UAAM,sBAAsB,CAAC;AAC7B,UAAM,0BAA0B,CAAC;AAGjC,UAAM,gBAAgB,CAAC,GAAG,OAAO,EAAE,KAAK,CAAC,GAAG,MAAM;AAChD,YAAM,QAAQ,oBAAoB,EAAE,QAAQ,EAAE;AAC9C,YAAM,QAAQ,oBAAoB,EAAE,QAAQ,EAAE;AAC9C,UAAI,UAAU;AAAO,eAAO,MAAM,cAAc,KAAK;AACrD,cAAQ,EAAE,QAAQ,IAAI,UAAU,EAAE,QAAQ,IAAI;AAAA,IAChD,CAAC;AAED,kBAAc,QAAQ,YAAU;AAC9B,YAAM,iBAAiB,oBAAoB,OAAO,QAAQ,EAAE;AAC5D,UAAI,CAAC;AAAgB;AAGrB,YAAM,eAAe,OAAO,QAAQ,IAAI,YAAY;AACpD,UAAI,YAAY,SAAS,cAAc,KAAK,gBAAgB,gBAAgB;AAC1E;AAAA,MACF;AAEA,UAAI,CAAC,wBAAwB,cAAc,GAAG;AAC5C,gCAAwB,cAAc,IAAI;AAC1C,4BAAoB,KAAK,MAAM;AAAA,MACjC,OAAO;AAEL,cAAM,WAAW,wBAAwB,cAAc;AACvD,YAAI,OAAO,UAAU,CAAC,SAAS,QAAQ,SAAS,OAAO,MAAM,GAAG;AAC9D,mBAAS,SAAS,SAAS,SAAS,SAAS,SAAS,OAAO,OAAO,SAAS,OAAO;AAAA,QACtF;AACA,YAAI,OAAO,UAAU,CAAC,SAAS;AAAQ,mBAAS,SAAS,OAAO;AAChE,YAAI,OAAO,cAAc,CAAC,SAAS;AAAY,mBAAS,aAAa,OAAO;AAC5E,YAAI,OAAO,QAAQ,CAAC,SAAS;AAAM,mBAAS,OAAO,OAAO;AAAA,MAC5D;AAAA,IACF,CAAC;AAED,WAAO;AAAA,EACT;AAKA,WAAS,kBAAkB,WAAW;AACpC,UAAM,gBAAgB,SAAS,eAAe,gBAAgB;AAE9D,QAAI,CAAC,UAAU,UAAU,UAAU,OAAO,WAAW,GAAG;AACtD,oBAAc,YAAY;AAC1B;AAAA,IACF;AAGA,UAAM,iBAAiB,UAAU,OAAO,OAAO,WAAS;AACtD,YAAM,aAAa,MAAM,QAAQ,IAAI,YAAY;AACjD,UAAI,UAAU,SAAS,cAAc,KAAK,cAAc,gBAAgB;AACtE,eAAO;AAAA,MACT;AACA,aAAO;AAAA,IACT,CAAC;AAGD,UAAM,gBAAgB,CAAC;AACvB,mBAAe,QAAQ,WAAS;AAC9B,YAAM,aAAa,SAAS,MAAM,KAAK,KAAK;AAC5C,YAAM,WAAW,eAAe,IAAI,aAAa,SAAS,UAAU;AAEpE,UAAI,CAAC,cAAc,QAAQ,GAAG;AAC5B,sBAAc,QAAQ,IAAI,CAAC;AAAA,MAC7B;AACA,oBAAc,QAAQ,EAAE,KAAK,KAAK;AAAA,IACpC,CAAC;AAGD,QAAI,OAAO;AAGX,UAAM,aAAa,CAAC,YAAY,WAAW,WAAW,WAAW,WAAW,WAAW,WAAW,WAAW,WAAW,SAAS;AAEjI,eAAW,QAAQ,CAAC,UAAU,UAAU;AACtC,UAAI,CAAC,cAAc,QAAQ;AAAG;AAE9B,YAAM,SAAS,cAAc,QAAQ;AACrC,YAAM,eAAe,iBAAiB,QAAQ,MAAM,KAAK,IAAI;AAE7D,cAAQ;AACR,cAAQ,2EAA2E,YAAY,uHAAuH,QAAQ,KAAK,OAAO,MAAM;AAChP,cAAQ,YAAY,YAAY;AAChC,cAAQ;AAER,aAAO,QAAQ,CAAC,OAAO,eAAe;AACpC,cAAM,cAAc,SAAS,KAAK,IAAI,UAAU;AAChD,cAAM,kBAAkB,MAAM,iBAAiB;AAC/C,cAAM,WAAW,MAAM,UAAU;AACjC,cAAM,cAAc,MAAM,eAAe;AACzC,cAAM,QAAQ,MAAM,SAAS;AAC7B,cAAM,aAAa,MAAM,cAAc;AACvC,cAAM,WAAW,MAAM,YAAY;AACnC,cAAM,aAAa,SAAS,MAAM,KAAK,KAAK;AAC5C,cAAM,aAAa,MAAM,cAAc,MAAM,UAAU;AACvD,cAAM,SAAS,MAAM,UAAU;AAC/B,cAAM,UAAU,MAAM,WAAW;AAGjC,YAAI,cAAc;AAClB,YAAI,YAAY;AACd,gBAAM,aAAa,WAAW,MAAM,WAAW;AAC/C,cAAI,YAAY;AACd,0BAAc,SAAS,WAAW,CAAC,CAAC;AAAA,UACtC;AAAA,QACF;AAGA,YAAI,mBAAmB;AAGvB,YAAI,aAAa,GAAG;AAClB,8BAAoB,mHAAmH,MAAM,QAAQ,iBAAiB,QAAQ,MAAM,KAAK,CAAC,MAAM,UAAU;AAAA,QAC5M,OAAO;AAEL,8BAAoB,6GAA6G,MAAM,QAAQ,iBAAiB,QAAQ,MAAM,KAAK,CAAC;AAAA,QACtL;AAGA,YAAI,UAAU;AACZ,8BAAoB,8HAA8H,MAAM,QAAQ,iBAAiB,QAAQ,MAAM,KAAK,CAAC;AAAA,QACvM;AAGA,YAAI,cAAc,WAAW,KAAK,GAAG;AACnC,8BAAoB,kHAAkH,MAAM,QAAQ,iBAAiB,QAAQ,MAAM,KAAK,CAAC,MAAM,WAAW;AAAA,QAC5M;AAGA,cAAM,kBAAkB,MAAM,QAAQ,IAAI,YAAY;AACtD,cAAM,mBAAmB,MAAM,WAAW,MAAM,OAAO,MAAM,eAAe,KAAK,YAAY;AAC7F,cAAM,iBAAiB,eAAe,SAAS,MAAM,KAC/B,eAAe,SAAS,MAAM,KAC9B,eAAe,SAAS,aAAa,KACrC,eAAe,SAAS,UAAU,KAClC,eAAe,SAAS,YAAY,KACpC,eAAe,SAAS,QAAQ,KAChC,eAAe,SAAS,SAAS,KACjC,eAAe,SAAS,UAAU,KACjC,eAAe,SAAS,YAAY,KAAK,CAAC,eAAe,SAAS,QAAQ;AAGjG,YAAI,UAAU,OAAO,KAAK,GAAG;AAC3B,cAAI,gBAAgB;AAClB,gCAAoB,+GAA+G,MAAM,QAAQ,iBAAiB,QAAQ,MAAM,KAAK,CAAC,OAAO,MAAM;AAAA,UACrM,OAAO;AACL,gCAAoB,kHAAkH,MAAM,QAAQ,iBAAiB,QAAQ,MAAM,KAAK,CAAC,OAAO,MAAM;AAAA,UACxM;AAAA,QACF;AAGA,YAAI,WAAW,QAAQ,KAAK,GAAG;AAC7B,8BAAoB,+GAA+G,MAAM,QAAQ,iBAAiB,QAAQ,MAAM,KAAK,CAAC,OAAO,OAAO;AAAA,QACtM;AAEA,4BAAoB;AAGpB,YAAI,YAAY;AAChB,YAAI,MAAM,SAAS;AACjB,uBAAa,kCAAkC,MAAM,OAAO;AAAA,QAC9D;AACA,YAAI,MAAM,aAAa;AACrB,uBAAa,kCAAkC,MAAM,WAAW;AAAA,QAClE;AAEA,gBAAQ;AAAA,iCACmB,kBAAkB,kBAAkB,EAAE,IAAI,WAAW,WAAW,EAAE;AAAA,uEAC5B,WAAW;AAAA,uCAC3C,MAAM,QAAQ,eAAe;AAAA;AAAA,gBAEpD,kBAAkB,0CAA0C,uBAAuB,MAAM,OAAO,WAAW,EAAE,6DAA6D,MAAM,QAAQ,IAAI,QAAQ,MAAM,KAAK,CAAC,iBAAiB,EAAE;AAAA,gBACnO,WAAW,8CAA8C,EAAE;AAAA;AAAA;AAAA;AAAA,qBAItD,WAAW;AAAA;AAAA,gBAEhB,cAAc,wFAAwF,WAAW,WAAW,EAAE;AAAA,gBAC9H,QAAQ,iFAAiF,KAAK,WAAW,EAAE;AAAA,gBAC3G,aAAa,sFAAsF,UAAU,WAAW,EAAE;AAAA,gBAC1H,WAAW,oFAAoF,QAAQ,WAAW,EAAE;AAAA,gBACpH,kBAAkB,oGAAoG,EAAE;AAAA,gBACxH,WAAW,6FAA6F,EAAE;AAAA,gBAC1G,aAAa,kFAAkF,UAAU,WAAW,EAAE;AAAA,gBACtH,SAAS,kFAAkF,MAAM,WAAW,EAAE;AAAA,gBAC9G,UAAU,mFAAmF,OAAO,WAAW,EAAE;AAAA;AAAA,cAEnH,SAAS;AAAA,cACT,gBAAgB;AAAA;AAAA;AAAA;AAAA,MAI1B,CAAC;AAED,cAAQ;AAAA,IACV,CAAC;AAED,kBAAc,YAAY;AAAA,EAC5B;AAKA,WAAS,qBAAqB,WAAW;AACvC,UAAM,mBAAmB,SAAS,eAAe,mBAAmB;AAEpE,QAAI,CAAC,UAAU,aAAa,UAAU,UAAU,WAAW,GAAG;AAC5D,uBAAiB,YAAY;AAC7B;AAAA,IACF;AAGA,UAAM,eAAe;AAAA,MAAC;AAAA,MAAkB;AAAA,MAAc;AAAA,MAAgB;AAAA,MAAgB;AAAA,MAChE;AAAA,MAAiB;AAAA,MAAa;AAAA,MAAe;AAAA,MAAe;AAAA,MAC5D;AAAA,MAAM;AAAA,MAAM;AAAA,MAAM;AAAA,MAAM;AAAA,IAAI;AAElD,UAAM,oBAAoB,UAAU,UAAU,OAAO,UAAQ;AAC3D,YAAM,aAAa,KAAK,QAAQ,IAAI,YAAY;AAChD,YAAM,SAAS,aAAa,KAAK,aAAW;AAC1C,YAAI,QAAQ,UAAU,GAAG;AACvB,iBAAO,cAAc,WAAW,cAAc,UAAU,OAAO,UAAU,MAAM,IAAI,OAAO,YAAY,OAAO,KAAK,CAAC;AAAA,QACrH;AACA,eAAO,UAAU,SAAS,OAAO;AAAA,MACnC,CAAC;AACD,aAAO,CAAC;AAAA,IACV,CAAC;AAED,QAAI,kBAAkB,WAAW,GAAG;AAClC,uBAAiB,YAAY;AAC7B;AAAA,IACF;AAGA,sBAAkB,KAAK,CAAC,GAAG,MAAM;AAC/B,UAAI,EAAE,YAAY,CAAC,EAAE;AAAU,eAAO;AACtC,UAAI,CAAC,EAAE,YAAY,EAAE;AAAU,eAAO;AACtC,cAAQ,EAAE,QAAQ,IAAI,cAAc,EAAE,QAAQ,EAAE;AAAA,IAClD,CAAC;AAED,QAAI,OAAO;AAEX,sBAAkB,QAAQ,UAAQ;AAChC,YAAM,YAAY,KAAK,WAAW,aAAc,KAAK,UAAU,YAAY;AAC3E,YAAM,OAAO,CAAC;AAEd,UAAI,KAAK;AAAU,aAAK,KAAK,UAAU;AACvC,UAAI,KAAK;AAAS,aAAK,KAAK,SAAS;AACrC,UAAI,KAAK;AAAM,aAAK,KAAK,KAAK,IAAI;AAElC,cAAQ;AAAA,8BACkB,SAAS;AAAA;AAAA;AAAA,cAGzB,KAAK,QAAQ,cAAc;AAAA,cAC3B,KAAK,WAAW,IAAI,mCAAgC,KAAK,QAAQ,YAAY,EAAE;AAAA;AAAA,YAEjF,KAAK,SAAS,IAAI,0BAA0B,KAAK,KAAK,UAAK,CAAC,WAAW,EAAE;AAAA;AAAA;AAAA;AAAA,IAInF,CAAC;AAED,YAAQ;AAER,qBAAiB,YAAY;AAAA,EAC/B;AAKA,WAAS,kBAAkB;AACzB,qBAAiB,MAAM,UAAU;AACjC,uBAAmB,MAAM,UAAU;AACnC,eAAW,cAAc;AAGzB,UAAM,YAAY,SAAS,eAAe,sBAAsB;AAChE,QAAI,WAAW;AACb,gBAAU,MAAM,UAAU;AAAA,IAC5B;AAGA,UAAM,eAAe,SAAS,eAAe,eAAe;AAC5D,UAAM,iBAAiB,SAAS,eAAe,iBAAiB;AAChE,UAAM,gBAAgB,SAAS,eAAe,gBAAgB;AAC9D,UAAM,kBAAkB,SAAS,eAAe,kBAAkB;AAClE,UAAM,mBAAmB,SAAS,eAAe,mBAAmB;AAEpE,QAAI;AAAc,mBAAa,YAAY;AAC3C,QAAI;AAAgB,qBAAe,YAAY;AAC/C,QAAI;AAAe,oBAAc,YAAY;AAC7C,QAAI;AAAiB,sBAAgB,YAAY;AACjD,QAAI;AAAkB,uBAAiB,YAAY;AAAA,EACrD;AAOA,MAAI,kBAAkB;AACpB,qBAAiB,iBAAiB,SAAS,MAAM;AAE/C,mBAAa,WAAW,wBAAwB;AAGhD,YAAM,UAAU;AAAA,QACd,MAAM;AAAA,QACN,QAAQ;AAAA,MACV;AAEA,aAAO,OAAO,YAAY,SAAS,2BAA2B;AAGhE,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,uCAAuC,MAAM;AAAA,MACrE;AAGA,iBAAW,cAAc;AAGzB,iBAAW,yBAAyB,GAAI;AAAA,IACxC,CAAC;AAAA,EACH;AAKA,mBAAiB,iBAAiB,SAAS,MAAM;AAE/C,UAAM,UAAU;AAAA,MACd,MAAM;AAAA,MACN,QAAQ;AAAA,IACV;AAEA,WAAO,OAAO,YAAY,SAAS,2BAA2B;AAE9D,UAAM,yFAAyF;AAAA,EACjG,CAAC;AAKD,MAAI,aAAa;AAEjB,MAAI,mBAAmB;AACrB,sBAAkB,iBAAiB,SAAS,YAAY;AACtD,UAAI,CAAC,gBAAgB;AACnB,cAAM,4DAA4D;AAClE;AAAA,MACF;AAEF,UAAI,YAAY;AAEd,cAAM,IAAI,QAAQ,MAAM,mBAAmB;AAC3C,qBAAa;AACb,0BAAkB,cAAc;AAAA,MAClC,OAAO;AAEL,cAAM,aAAa;AAGnB,cAAM,IAAI,QAAQ,KAAK;AAAA,UACrB,IAAI;AAAA,UACJ,KAAK;AAAA,UACL,QAAQ;AAAA,UACR,OAAO;AAAA,UACP,cAAc,EAAE,YAAY,QAAQ,UAAU,SAAS;AAAA,UACvD,iBAAiB,EAAE,YAAY,QAAQ,UAAU,SAAS;AAAA,UAC1D,kBAAkB;AAAA,QACpB,CAAC;AACD,qBAAa;AACb,0BAAkB,cAAc;AAAA,MAClC;AAAA,IACA,CAAC;AAAA,EACH;AAOA,SAAO,iBAAiB,WAAW,CAAC,UAAU;AAE5C,QAAI,MAAM,WAAW,6BAA6B;AAChD;AAAA,IACF;AAEA,UAAM,EAAE,MAAM,KAAK,IAAI,MAAM;AAE7B,YAAQ,MAAM;AAAA,MACZ,KAAK;AAEH,YAAI,aAAa,QAAQ,wBAAwB,MAAM,QAAQ;AAC7D,kBAAQ,IAAI,kGAAwF;AACpG,0BAAgB;AAChB;AAAA,QACF;AAEA,YAAI,QAAQ,KAAK,WAAW;AAC1B,2BAAiB,KAAK,SAAS;AAAA,QACjC,OAAO;AACL,0BAAgB;AAAA,QAClB;AACA;AAAA,MAEF,KAAK;AAEH,YAAI,aAAa,QAAQ,wBAAwB,MAAM,QAAQ;AAC7D,kBAAQ,IAAI,oGAA0F;AACtG;AAAA,QACF;AAEA,YAAI,QAAQ,KAAK,WAAW;AAC1B,2BAAiB,KAAK,SAAS;AAC/B,cAAI,gBAAgB;AAClB,gBAAI,aAAa,KAAK,sBAAsB,KAAK,UAAU,IAAI,IAAI,SAAS;AAAA,UAC9E;AAAA,QACF;AACA;AAAA,MAEF,KAAK;AACH,YAAI,gBAAgB;AAClB,cAAI,aAAa,KAAK,iCAAiC,SAAS;AAAA,QAClE;AACA,mBAAW,cAAc;AACzB,gCAAwB;AACxB;AAAA,MAEF,KAAK;AACH,YAAI,gBAAgB;AAClB,cAAI,aAAa,KAAK,UAAU,KAAK,OAAO,IAAI,OAAO;AAAA,QACzD;AACA,mBAAW,cAAc,UAAU,KAAK,OAAO;AAC/C;AAAA,MAEF;AAEE;AAAA,IACJ;AAAA,EACF,CAAC;AAQD,WAAS,kBAAkB,UAAU;AACnC,QAAI,CAAC,gBAAgB;AACnB,cAAQ,KAAK,qCAAqC;AAClD;AAAA,IACF;AAIA,UAAM,aAAa,SAAS,UAAU;AACtC,UAAM,WAAW,SAAS,QAAQ;AAClC,UAAM,gBAAgB,SAAS,iBAAiB;AAEhD,QAAI,aAAa;AAAA,MACf,GAAG,aAAa,WAAW,QAAQ,KAAK,UAAU;AAAA,MAClD;AAAA,IACF;AAEA,YAAQ,IAAI,qCAA8B,QAAQ;AAAA,EACpD;AAGA,SAAO,iBAAiB,WAAW,CAAC,UAAU;AAC5C,QAAI,MAAM,WAAW,6BAA6B;AAChD;AAAA,IACF;AAEA,QAAI,MAAM,KAAK,SAAS,sBAAsB;AAC5C,wBAAkB,MAAM,KAAK,IAAI;AAAA,IACnC;AAAA,EACF,CAAC;AAOD,iBAAe,iBAAiB,MAAM,MAAM;AAC1C,QAAI,CAAC,kBAAkB,CAAC;AAAkB;AAE1C,QAAI;AACF,YAAM,UAAU;AAAA,QACd;AAAA,QACA;AAAA,QACA,WAAW;AAAA,UACT,MAAM,iBAAiB;AAAA,UACvB,IAAI,iBAAiB;AAAA,QACvB;AAAA,QACA,WAAW,KAAK,IAAI;AAAA,MACtB;AAAA,IAIF,SAAS,OAAO;AACd,cAAQ,MAAM,0BAA0B,KAAK;AAAA,IAC/C;AAAA,EACF;AASA,iBAAe,eAAe,MAAM,OAAO,UAAU,SAAS,MAAM,UAAU,MAAM;AAClF,QAAI,CAAC;AAAgB;AAErB,QAAI;AACF,YAAM,WAAW,MAAM,IAAI,OAAO,MAAM;AACxC,YAAM,WAAW,MAAM,IAAI,KAAK,YAAY;AAC5C,YAAM,WAAW,SAAS,4BAA4B,KAAK,CAAC;AAG5D,YAAM,YAAY,KAAK,QAAQ,YAAY,EAAE;AAC7C,YAAM,gBAAgB,UAAU,SAAS,MAAM,UAAU,UAAU,GAAG,GAAG,IAAI,QAAQ;AAGrF,UAAI,mBAAmB;AACvB,UAAI,SAAS;AACX,cAAM,eAAe,QAAQ,QAAQ,YAAY,EAAE;AACnD,2BAAmB,aAAa,SAAS,MAAM,aAAa,UAAU,GAAG,GAAG,IAAI,QAAQ;AAAA,MAC1F;AAEA,YAAM,aAAa;AAAA,QACjB,IAAI,KAAK,IAAI,IAAI,KAAK,OAAO;AAAA,QAC7B,MAAM;AAAA,QACN;AAAA,QACA,QAAQ,WAAW,mBAAmB,iBAAiB,OAAO;AAAA,QAC9D;AAAA,QACA,WAAW,KAAK,IAAI;AAAA,QACpB,SAAS;AAAA;AAAA,MACX;AAGA,YAAM,mBAAmB,KAAK,IAAI,IAAK,KAAK,KAAK;AACjD,YAAM,iBAAiB,SAAS,OAAO,SAAO,IAAI,YAAY,gBAAgB;AAG9E,YAAM,kBAAkB,CAAC,GAAG,gBAAgB,UAAU,EAAE,MAAM,GAAG;AAEjE,YAAM,IAAI,KAAK,YAAY;AAAA,QACzB,8BAA8B;AAAA,MAChC,CAAC;AAED,cAAQ,IAAI,iCAA0B,IAAI;AAAA,IAC5C,SAAS,OAAO;AACd,cAAQ,MAAM,8BAA8B,KAAK;AAAA,IACnD;AAAA,EACF;AAYA,SAAO,cAAc,eAAe,MAAM;AACxC,eAAW;AAGX,aAAS,iBAAiB,gBAAgB,EAAE,QAAQ,SAAO,IAAI,UAAU,OAAO,QAAQ,CAAC;AACzF,QAAI,SAAS,aAAa;AACxB,eAAS,eAAe,oBAAoB,GAAG,UAAU,IAAI,QAAQ;AAAA,IACvE,WAAW,SAAS,gBAAgB;AAClC,eAAS,eAAe,uBAAuB,GAAG,UAAU,IAAI,QAAQ;AAAA,IAC1E,OAAO;AACL,eAAS,eAAe,iBAAiB,GAAG,UAAU,IAAI,QAAQ;AAAA,IACpE;AAGA,QAAI,gBAAgB;AAClB,UAAI;AACF,cAAM,IAAI,OAAO,YAAY;AAAA,UAC3B,qBAAqB;AAAA,QACvB,CAAC;AAAA,MACH,SAAS,OAAO;AACd,gBAAQ,MAAM,qCAAqC,KAAK;AAAA,MAC1D;AAAA,IACF;AAAA,EACF;AAMA,iBAAe,QAAQ,MAAMA,YAAW,GAAG;AAEzC,QAAI;AACJ,QAAI,aAAa,aAAa;AAC5B,qBAAe;AAAA,IACjB,WAAW,aAAa,gBAAgB;AACtC,qBAAe;AAAA,IACjB,OAAO;AACL,qBAAe;AAAA,IACjB;AAGA,QAAIA,cAAa,GAAG;AAClB,uBAAiBA,aAAY,IAAI,MAAM,MAAMA;AAAA,IAC/C;AAEA,UAAM,cAAc;AAAA,MAClB;AAAA,MACA,UAAAA;AAAA,MACA,MAAM;AAAA,MACN,MAAM;AAAA,IACR;AAGA,UAAM,SAAS,MAAM,eAAe,cAAc,WAAW;AAC7D,QAAI,QAAQ;AAEV,aAAO,EAAE,SAAS,MAAM,OAAO;AAAA,IACjC;AAGA,WAAO,aAAa;AAAA,EACtB;AAKA,WAAS,eAAe;AACtB,QAAI,aAAa,aAAa;AAC5B,YAAM,QAAQ,KAAK,MAAM,KAAK,OAAO,IAAI,EAAE,IAAI;AAC/C,YAAM,QAAQ,KAAK,MAAM,KAAK,OAAO,IAAI,EAAE,IAAI;AAC/C,YAAM,QAAQ,KAAK,IAAI,OAAO,KAAK;AACnC,aAAO,EAAC,OAAO,OAAO,CAAC,OAAO,KAAK,GAAG,UAAU,GAAG,SAAS,oBAAoB,OAAO,GAAG,OAAO,IAAI,MAAM,YAAW;AAAA,IACxH,WAAW,aAAa,gBAAgB;AACtC,YAAM,QAAQ,KAAK,MAAM,KAAK,OAAO,IAAI,EAAE,IAAI;AAC/C,YAAM,QAAQ,KAAK,MAAM,KAAK,OAAO,IAAI,EAAE,IAAI;AAC/C,YAAM,QAAQ,KAAK,IAAI,OAAO,KAAK;AACnC,aAAO,EAAC,OAAO,OAAO,CAAC,OAAO,KAAK,GAAG,UAAU,GAAG,SAAS,uBAAuB,OAAO,GAAG,OAAO,IAAI,MAAM,eAAc;AAAA,IAC9H,OAAO;AACL,YAAM,OAAO,KAAK,MAAM,KAAK,OAAO,IAAI,EAAE,IAAI;AAC9C,aAAO,EAAC,OAAO,MAAM,OAAO,CAAC,IAAI,GAAG,UAAU,GAAG,SAAS,QAAQ,OAAO,GAAG,OAAO,IAAI,MAAM,SAAQ;AAAA,IACvG;AAAA,EACF;AAKA,iBAAe,SAASE,UAAS,MAAMF,YAAW,GAAG;AACnD,UAAM,cAAc;AAAA,MAClB;AAAA,MACA,UAAAA;AAAA,MACA,SAAAE;AAAA,MACA,MAAM;AAAA,IACR;AAGA,UAAM,SAAS,MAAM,eAAeA,UAAS,WAAW;AACxD,QAAI,QAAQ;AACV,aAAO,EAAE,SAAS,MAAM,OAAO;AAAA,IACjC;AAGA,WAAO,cAAcA,QAAO;AAAA,EAC9B;AAKA,WAAS,cAAcA,UAAS;AAE9B,UAAM,QAAQA,SAAQ,MAAM,yBAAyB;AACrD,QAAI,CAAC,OAAO;AACV,cAAQ,MAAM,yBAAyBA,QAAO;AAC9C,aAAO,EAAC,OAAO,GAAG,OAAO,CAAC,GAAG,SAAAA,SAAO;AAAA,IACtC;AAEA,UAAMC,SAAQ,SAAS,MAAM,CAAC,KAAK,GAAG;AACtC,UAAMC,SAAQ,SAAS,MAAM,CAAC,CAAC;AAC/B,UAAMJ,YAAW,SAAS,MAAM,CAAC,KAAK,GAAG;AAEzC,UAAM,QAAQ,CAAC;AACf,QAAI,QAAQA;AAEZ,aAAS,IAAI,GAAG,IAAIG,QAAO,KAAK;AAC9B,YAAM,OAAO,KAAK,MAAM,KAAK,OAAO,IAAIC,MAAK,IAAI;AACjD,YAAM,KAAK,IAAI;AACf,eAAS;AAAA,IACX;AAEA,WAAO,EAAC,OAAO,OAAO,UAAAJ,WAAU,SAAAE,UAAS,OAAAC,QAAO,OAAAC,OAAK;AAAA,EACvD;AAKA,iBAAe,eAAe,MAAM,QAAQ;AAC1C,QAAI,cAAc;AAElB,UAAM,aAAa,OAAO,mBAAmB,SAAY,OAAO,iBAAkB,OAAO,aAAa,SAAY,OAAO,QAAQ,OAAO,WAAW,OAAO;AAE1J,YAAQ,IAAI,mCAA4B;AAAA,MACtC;AAAA,MACA,aAAa,OAAO;AAAA,MACpB,gBAAgB,OAAO;AAAA,MACvB,eAAe,OAAO;AAAA,MACtB,sBAAsB;AAAA,IACxB,CAAC;AAGD,QAAI,OAAO,SAAS,eAAe,OAAO,MAAM,WAAW,GAAG;AAC5D,oBAAc;AAAA,6BACW,OAAO,MAAM,CAAC,CAAC;AAAA,6BACf,OAAO,MAAM,CAAC,CAAC;AAAA,gDACI,OAAO,KAAK;AACxD,UAAI,OAAO,aAAa,GAAG;AACzB,uBAAe,kCAAkC,OAAO,YAAY,IAAI,MAAM,EAAE,GAAG,OAAO,QAAQ;AAAA,MACpG;AACA,qBAAe,iCAAiC,OAAO,KAAK;AAC5D,UAAI,OAAO,aAAa,GAAG;AACzB,uBAAe,IAAI,OAAO,YAAY,IAAI,MAAM,EAAE,GAAG,OAAO,QAAQ;AAAA,MACtE;AACA,qBAAe,MAAM,UAAU;AAAA,IACjC,WAAW,OAAO,SAAS,kBAAkB,OAAO,MAAM,WAAW,GAAG;AACtE,oBAAc;AAAA,6BACW,OAAO,MAAM,CAAC,CAAC;AAAA,6BACf,OAAO,MAAM,CAAC,CAAC;AAAA,gDACI,OAAO,KAAK;AACxD,UAAI,OAAO,aAAa,GAAG;AACzB,uBAAe,kCAAkC,OAAO,YAAY,IAAI,MAAM,EAAE,GAAG,OAAO,QAAQ;AAAA,MACpG;AACA,qBAAe,iCAAiC,OAAO,KAAK;AAC5D,UAAI,OAAO,aAAa,GAAG;AACzB,uBAAe,IAAI,OAAO,YAAY,IAAI,MAAM,EAAE,GAAG,OAAO,QAAQ;AAAA,MACtE;AACA,qBAAe,MAAM,UAAU;AAAA,IACjC,OAAO;AAEL,oBAAc,iCAAiC,OAAO,MAAM,CAAC,CAAC;AAC9D,UAAI,OAAO,aAAa,GAAG;AACzB,uBAAe,kCAAkC,OAAO,YAAY,IAAI,MAAM,EAAE,GAAG,OAAO,QAAQ;AAAA,MACpG;AACA,qBAAe,iCAAiC,OAAO,MAAM,CAAC,CAAC;AAC/D,UAAI,OAAO,aAAa,GAAG;AACzB,uBAAe,IAAI,OAAO,YAAY,IAAI,MAAM,EAAE,GAAG,OAAO,QAAQ;AAAA,MACtE;AACA,qBAAe,MAAM,UAAU;AAAA,IACjC;AAIA,UAAM,UAAU,OAAO,aAAa,KAAK,CAAC,KAAK,SAAS,IAAI,OAAO,YAAY,IAAI,MAAM,EAAE,GAAG,OAAO,QAAQ,GAAG,IAC5G,KAAK,OAAO,YAAY,IAAI,MAAM,EAAE,GAAG,OAAO,QAAQ,MACtD;AACJ,UAAM,UAAU,GAAG,IAAI,GAAG,OAAO,aAAa,UAAU;AAExD,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,GAAG,kBAAkB,QAAQ,WAAW,KAAK,IAAI,MAAM,UAAU,IAAI,MAAM;AAAA,IACnG;AACA,YAAQ,IAAI,aAAM,OAAO;AAGzB,UAAM,eAAe,SAAS,QAAQ,kBAAkB,MAAM,WAAW;AAAA,EAC3E;AAKA,SAAO,mBAAmB,eAAe,aAAaJ,WAAU;AAC9D,YAAQ,IAAI,sCAA+B,aAAaA,SAAQ;AAChE,UAAM,OAAO,GAAG,WAAW,WAAWA,aAAY,IAAI,MAAM,EAAE,GAAGA,SAAQ;AACzE,UAAM,SAAS,MAAM,QAAQ,MAAMA,SAAQ;AAG3C,QAAI,OAAO;AAAS;AAGpB,UAAM,QAAQ,OAAO,QAAQA;AAC7B,UAAM,eAAe,MAAM,EAAC,GAAG,QAAQ,OAAO,UAAAA,UAAQ,CAAC;AAAA,EACzD;AAKA,SAAO,kBAAkB,eAAe,aAAaA,WAAU;AAC7D,YAAQ,IAAI,qCAA8B,aAAaA,SAAQ;AAC/D,UAAM,OAAO,GAAG,WAAW,UAAUA,aAAY,IAAI,MAAM,EAAE,GAAGA,SAAQ;AACxE,UAAM,SAAS,MAAM,QAAQ,MAAMA,SAAQ;AAE3C,QAAI,OAAO;AAAS;AAEpB,UAAM,QAAQ,OAAO,QAAQA;AAC7B,UAAM,eAAe,MAAM,EAAC,GAAG,QAAQ,OAAO,UAAAA,UAAQ,CAAC;AAAA,EACzD;AAKA,SAAO,iBAAiB,eAAe,WAAW,OAAO;AACvD,UAAM,OAAO,GAAG,SAAS,KAAK,SAAS,IAAI,MAAM,EAAE,GAAG,KAAK;AAC3D,UAAM,SAAS,MAAM,QAAQ,MAAM,KAAK;AAExC,QAAI,OAAO;AAAS;AAEpB,UAAM,QAAQ,OAAO,QAAQ;AAC7B,UAAM,eAAe,MAAM,EAAC,GAAG,QAAQ,OAAO,UAAU,MAAK,CAAC;AAAA,EAChE;AAKA,SAAO,iBAAiB,eAAe,iBAAiB;AACtD,UAAM,OAAO,eAAe,mBAAmB,IAAI,MAAM,EAAE,GAAG,eAAe;AAC7E,UAAM,SAAS,MAAM,QAAQ,MAAM,eAAe;AAElD,QAAI,OAAO;AAAS;AAEpB,UAAM,QAAQ,OAAO,QAAQ;AAC7B,UAAM,eAAe,MAAM,EAAC,GAAG,QAAQ,OAAO,UAAU,gBAAe,CAAC;AAAA,EAC1E;AAKA,SAAO,gBAAgB,iBAAiB;AACtC,QAAI,CAAC;AAAkB;AAEvB,UAAM,SAAS,MAAM,SAAS,QAAQ,cAAc,CAAC;AAGrD,QAAI,OAAO,SAAS;AAElB,YAAM,cAAc,aAAa,IAAI,OAAO,MAAM;AAClD,UAAI,aAAa;AACf,oBAAY,cAAc;AAAA,MAC5B;AACA;AAAA,IACF;AAEA,UAAM,OAAO,OAAO;AAEpB,QAAI,UAAU;AACd,QAAI,cAAc;AAElB,QAAI,SAAS,IAAI;AACf,gBAAU;AAEV,UAAI,CAAC,iBAAiB,WAAW;AAC/B,yBAAiB,YAAY,EAAE,SAAS,GAAG,KAAK,EAAE;AAAA,MACpD;AACA,uBAAiB,UAAU,UAAU;AACrC,uBAAiB,gBAAgB;AAAA,IACnC,WAAW,SAAS,GAAG;AACrB,gBAAU;AAAA,IACZ,WAAW,QAAQ,IAAI;AACrB,gBAAU,iCAA0B,IAAI;AAAA,IAC1C,OAAO;AACL,gBAAU,iCAA0B,IAAI;AAAA,IAC1C;AAEA,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,GAAG,iBAAiB,IAAI,kBAAkB,IAAI,IAAI,QAAQ,KAAK,YAAY,OAAO;AAAA,IAC1G;AACA,YAAQ,IAAI,aAAM,OAAO;AAGzB,UAAM,eAAe,SAAS,aAAa,iBAAiB,IAAI;AAAA,EAClE;AAKA,SAAO,iBAAiB,eAAe,YAAY,aAAa;AAC9D,UAAM,YAAY,cAAc,MAAM,WAAW,MAAM;AACvD,UAAM,OAAO,GAAG,UAAU,UAAU,SAAS;AAC7C,UAAM,aAAa,MAAM,QAAQ,MAAM,eAAe,CAAC;AAGvD,QAAI,WAAW;AAAS;AAExB,UAAM,cAAc,WAAW,SAAS,eAAe;AAGvD,UAAM,UAAU,GAAG,UAAU,UAAU,SAAS,aAAa,WAAW;AAGxE,QAAI,cAAc;AAClB,QAAI,WAAW,SAAS,eAAe,WAAW,MAAM,WAAW,GAAG;AACpE,oBAAc;AAAA,6BACW,WAAW,MAAM,CAAC,CAAC;AAAA,6BACnB,WAAW,MAAM,CAAC,CAAC;AAAA,gDACA,WAAW,KAAK;AAAA,IAC9D,WAAW,WAAW,SAAS,kBAAkB,WAAW,MAAM,WAAW,GAAG;AAC9E,oBAAc;AAAA,6BACW,WAAW,MAAM,CAAC,CAAC;AAAA,6BACnB,WAAW,MAAM,CAAC,CAAC;AAAA,gDACA,WAAW,KAAK;AAAA,IAC9D,OAAO;AACL,oBAAc,wCAAwC,WAAW,MAAM,CAAC,CAAC;AAAA,IAC3E;AACA,QAAI,aAAa;AACf,qBAAe,uCAAuC,WAAW;AAAA,IACnE;AACA,mBAAe,iCAAiC,WAAW,KAAK;AAChE,QAAI,aAAa;AACf,qBAAe,MAAM,WAAW;AAAA,IAClC;AACA,mBAAe,MAAM,WAAW;AAEhC,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,GAAG,kBAAkB,QAAQ,WAAW,KAAK,UAAU,aAAa,WAAW,IAAI,MAAM;AAAA,IACjH;AACA,YAAQ,IAAI,gBAAM,OAAO;AAGzB,UAAM,eAAe,SAAS,UAAU,kBAAkB,MAAM,WAAW;AAAA,EAC7E;AAKA,SAAO,iBAAiB,eAAe,YAAY,eAAe;AAChE,QAAI,CAAC,iBAAiB,CAAC,cAAc,KAAK;AAAG;AAE7C,UAAM,OAAO,GAAG,UAAU;AAC1B,UAAM,aAAa,MAAM,SAAS,eAAe,MAAM,CAAC;AAGxD,QAAI,WAAW,SAAS;AACtB,YAAM,cAAc,aAAa,IAAI,WAAW,MAAM;AACtD,UAAI,aAAa;AACf,oBAAY,eAAe;AAC3B,oBAAY,aAAa;AACzB,oBAAY,gBAAgB;AAAA,MAC9B;AACA;AAAA,IACF;AAGA,UAAM,UAAU,GAAG,UAAU,oBAAoB,WAAW,KAAK;AAGjE,QAAI,cAAc,6BAA6B,aAAa;AAAA,+CACf,WAAW,MAAM,KAAK,IAAI,CAAC;AACxE,QAAI,WAAW,UAAU;AACvB,qBAAe,iBAAiB,WAAW,YAAY,IAAI,MAAM,EAAE,GAAG,WAAW,QAAQ;AAAA,IAC3F;AACA,mBAAe,oBAAoB,WAAW,MAAM,KAAK,KAAK,CAAC;AAC/D,QAAI,WAAW,UAAU;AACvB,qBAAe,IAAI,WAAW,YAAY,IAAI,MAAM,EAAE,GAAG,WAAW,QAAQ;AAAA,IAC9E;AACA,mBAAe,MAAM,WAAW,KAAK;AAErC,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,GAAG,kBAAkB,QAAQ,WAAW,KAAK,UAAU,aAAa,WAAW,KAAK,IAAI,MAAM;AAAA,IACtH;AACA,YAAQ,IAAI,gBAAM,OAAO;AAGzB,UAAM,eAAe,SAAS,UAAU,kBAAkB,MAAM,WAAW;AAAA,EAC7E;AAKA,SAAO,cAAc,eAAe,WAAW,gBAAgB;AAC7D,QAAI,CAAC,kBAAkB,CAAC,eAAe,KAAK;AAAG;AAE/C,UAAM,cAAc,SAAS,cAAc;AAG3C,UAAM,UAAU,GAAG,SAAS,qBAAqB,YAAY,KAAK;AAGlE,QAAI,cAAc,6BAA6B,cAAc;AAAA,+CAChB,YAAY,MAAM,KAAK,IAAI,CAAC;AACzE,QAAI,YAAY,UAAU;AACxB,qBAAe,iBAAiB,YAAY,YAAY,IAAI,MAAM,EAAE,GAAG,YAAY,QAAQ;AAAA,IAC7F;AACA,mBAAe,oBAAoB,YAAY,MAAM,KAAK,KAAK,CAAC;AAChE,QAAI,YAAY,UAAU;AACxB,qBAAe,IAAI,YAAY,YAAY,IAAI,MAAM,EAAE,GAAG,YAAY,QAAQ;AAAA,IAChF;AACA,mBAAe,MAAM,YAAY,KAAK;AAEtC,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,GAAG,kBAAkB,QAAQ,WAAW,KAAK,SAAS,cAAc,YAAY,KAAK,IAAI,MAAM;AAAA,IACvH;AACA,YAAQ,IAAI,aAAM,OAAO;AAGzB,UAAM,eAAe,SAAS,WAAW,kBAAkB,MAAM,WAAW;AAAA,EAC9E;AAKA,SAAO,aAAa,eAAe,YAAY,aAAa,eAAe;AACzE,UAAM,eAAe,YAAY,WAAW;AAC5C,QAAI,iBAAiB,cAAc,KAAK,GAAG;AACzC,YAAM,eAAe,YAAY,aAAa;AAAA,IAChD;AAAA,EACF;AAOA,SAAO,kBAAkB,eAAe,WAAW,WAAW;AAC5D,QAAI,CAAC,oBAAoB,CAAC,iBAAiB;AAAY;AAGvD,UAAM,iBAAiB,CAAC;AACxB,aAAS,QAAQ,WAAW,SAAS,GAAG,SAAS;AAC/C,YAAM,UAAU,QAAQ,KAAK;AAC7B,YAAM,UAAU,iBAAiB,WAAW,OAAO,KAAK;AACxD,UAAI,UAAU,GAAG;AACf,uBAAe,KAAK;AAAA,UAClB;AAAA,UACA,WAAW;AAAA,QACb,CAAC;AAAA,MACH;AAAA,IACF;AAEA,QAAI,eAAe,WAAW,GAAG;AAC/B,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,oCAAoC,SAAS,KAAK,OAAO;AAAA,MACjF;AACA;AAAA,IACF;AAGA,QAAI,eAAe,WAAW,GAAG;AAC/B,YAAM,UAAU,WAAW,eAAe,CAAC,EAAE,KAAK;AAClD;AAAA,IACF;AAGA,wBAAoB,WAAW,cAAc;AAAA,EAC/C;AAKA,WAAS,oBAAoB,WAAW,gBAAgB;AACtD,UAAM,QAAQ,SAAS,eAAe,mBAAmB;AACzD,UAAM,iBAAiB,SAAS,eAAe,kBAAkB;AACjE,UAAM,mBAAmB,SAAS,eAAe,qBAAqB;AAGtE,mBAAe,cAAc,QAAQ,SAAS;AAG9C,qBAAiB,YAAY;AAC7B,mBAAe,QAAQ,UAAQ;AAC7B,YAAM,SAAS,SAAS,cAAc,KAAK;AAC3C,aAAO,YAAY;AACnB,aAAO,UAAU,YAAY;AAC3B,6BAAqB;AACrB,cAAM,UAAU,WAAW,KAAK,KAAK;AAAA,MACvC;AAEA,aAAO,YAAY;AAAA,8CACuB,KAAK,KAAK;AAAA,wCAChB,KAAK,SAAS,QAAQ,KAAK,cAAc,IAAI,MAAM,EAAE;AAAA;AAGzF,uBAAiB,YAAY,MAAM;AAAA,IACrC,CAAC;AAGD,UAAM,MAAM,UAAU;AAAA,EACxB;AAKA,SAAO,uBAAuB,WAAW;AACvC,UAAM,QAAQ,SAAS,eAAe,mBAAmB;AACzD,UAAM,MAAM,UAAU;AAAA,EACxB;AAKA,SAAO,YAAY,eAAe,WAAW,OAAO;AAClD,QAAI,CAAC;AAAkB;AAGvB,UAAM,QAAQ,iBAAiB,QAAQ,KAAK,OAAK,EAAE,SAAS,SAAS;AACrE,UAAM,iBAAiB,QAAQ,SAAS,MAAM,KAAK,KAAK,IAAI;AAC5D,UAAM,WAAW,QAAQ;AAGzB,QAAI,UAAU;AACd,QAAI,QAAQ,GAAG;AACb,UAAI,CAAC,iBAAiB,YAAY;AAChC,gBAAQ,KAAK,uCAAuC;AACpD;AAAA,MACF;AAEA,gBAAU,QAAQ,KAAK;AACvB,YAAM,UAAU,iBAAiB,WAAW,OAAO,KAAK;AAExD,UAAI,YAAY,GAAG;AACjB,YAAI,gBAAgB;AAClB,cAAI,aAAa,KAAK,YAAY,KAAK,2BAA2B,OAAO;AAAA,QAC3E;AACA;AAAA,MACF;AAGA,uBAAiB,WAAW,OAAO,IAAI,UAAU;AACjD,uBAAiB,gBAAgB;AAAA,IACnC;AAEA,UAAM,YAAY,UAAU,IAAI,YAAY,SAAS,KAAK;AAC1D,UAAM,UAAU,wBAAmB,SAAS,cAAc,SAAS;AAGnE,QAAI,UAAU,WAAW,SAAS,wCAAwC,SAAS;AAEnF,QAAI,YAAY,iBAAiB,GAAG;AAClC,iBAAW,uBAAuB,cAAc;AAAA,IAClD;AAEA,QAAI,OAAO;AACT,UAAI,MAAM;AAAa,mBAAW,sCAAsC,MAAM,WAAW;AACzF,UAAI,MAAM;AAAO,mBAAW,+BAA+B,MAAM,KAAK;AACtE,UAAI,MAAM;AAAY,mBAAW,oCAAoC,MAAM,UAAU;AACrF,UAAI,MAAM;AAAU,mBAAW,kCAAkC,MAAM,QAAQ;AAC/E,UAAI,MAAM;AAAe,mBAAW;AACpC,UAAI,MAAM;AAAQ,mBAAW;AAC7B,UAAI,MAAM;AAAY,mBAAW,gCAAgC,MAAM,UAAU;AACjF,UAAI,MAAM;AAAQ,mBAAW,gCAAgC,MAAM,MAAM;AACzE,UAAI,MAAM;AAAS,mBAAW,iCAAiC,MAAM,OAAO;AAC5E,UAAI,MAAM;AAAS,mBAAW,WAAW,MAAM,OAAO;AACtD,UAAI,MAAM;AAAa,mBAAW,WAAW,MAAM,WAAW;AAAA,IAChE;AAEA,QAAI,QAAQ,KAAK,SAAS;AACxB,YAAM,YAAY,iBAAiB,WAAW,OAAO,KAAK;AAC1D,iBAAW,mDAAmD,KAAK,yCAAyC,SAAS;AAAA,IACvH;AAGA,QAAI,SAAS,MAAM,eAAe;AAChC,YAAM,cAAc,iBAAiB,OAAO,iBAAiB,MAAM,iBAAiB;AACpF,YAAM,gBAAgB;AAGtB,2BAAqB;AACrB,+BAAyB,IAAI,aAAa,SAAS;AAGnD,UAAI,iBAAiB,kBAAkB,WAAW;AAChD,gBAAQ,IAAI,0CAA0C,aAAa,OAAO,SAAS,EAAE;AACrF,YAAI,gBAAgB;AAClB,cAAI,aAAa,KAAK,+BAA+B,aAAa,OAAO,SAAS,IAAI,SAAS;AAAA,QACjG;AAAA,MACF,OAAO;AACL,gBAAQ,IAAI,mCAAmC,SAAS,EAAE;AAAA,MAC5D;AAGA,wBAAkB,gBAAgB;AAAA,IACpC;AAEA,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,GAAG,kBAAkB,QAAQ,WAAW,UAAU,SAAS,IAAI,MAAM;AAAA,IAC7F;AACA,YAAQ,IAAI,UAAK,OAAO;AAGxB,UAAM,eAAe,SAAS,SAAS,kBAAkB,MAAM,OAAO;AAAA,EACxE;AAKA,SAAO,oBAAoB,eAAe,WAAW;AACnD,QAAI,CAAC;AAAkB;AAGvB,UAAM,QAAQ,iBAAiB,QAAQ,KAAK,OAAK,EAAE,SAAS,SAAS;AAErE,UAAM,UAAU,2BAAoB,SAAS;AAG7C,QAAI,UAAU,WAAW,SAAS;AAElC,QAAI,OAAO;AACT,YAAM,aAAa,SAAS,MAAM,KAAK,KAAK;AAC5C,YAAM,YAAY,eAAe,IAAI,YAAY,SAAS,UAAU;AACpE,iBAAW,+BAA+B,SAAS;AAEnD,UAAI,MAAM,aAAa;AAErB,mBAAW,sCAAsC,MAAM,WAAW;AAAA,MACpE;AACA,UAAI,MAAM;AAAO,mBAAW,+BAA+B,MAAM,KAAK;AACtE,UAAI,MAAM;AAAY,mBAAW,oCAAoC,MAAM,UAAU;AACrF,UAAI,MAAM;AAAU,mBAAW,kCAAkC,MAAM,QAAQ;AAC/E,UAAI,MAAM;AAAe,mBAAW;AACpC,UAAI,MAAM;AAAY,mBAAW,gCAAgC,MAAM,UAAU;AACjF,UAAI,MAAM;AAAQ,mBAAW,gCAAgC,MAAM,MAAM;AACzE,UAAI,MAAM;AAAS,mBAAW,iCAAiC,MAAM,OAAO;AAC5E,UAAI,MAAM;AAAS,mBAAW,WAAW,MAAM,OAAO;AACtD,UAAI,MAAM;AAAa,mBAAW,WAAW,MAAM,WAAW;AAAA,IAChE;AAGA,QAAI,SAAS,MAAM,eAAe;AAChC,YAAM,cAAc,iBAAiB,OAAO,iBAAiB,MAAM,iBAAiB;AACpF,YAAM,gBAAgB;AAGtB,2BAAqB;AACrB,+BAAyB,IAAI,aAAa,SAAS;AAGnD,UAAI,iBAAiB,kBAAkB,WAAW;AAChD,gBAAQ,IAAI,0CAA0C,aAAa,OAAO,SAAS,EAAE;AACrF,YAAI,gBAAgB;AAClB,cAAI,aAAa,KAAK,+BAA+B,aAAa,OAAO,SAAS,IAAI,SAAS;AAAA,QACjG;AAAA,MACF,OAAO;AACL,gBAAQ,IAAI,mCAAmC,SAAS,EAAE;AAAA,MAC5D;AAGA,wBAAkB,gBAAgB;AAAA,IACpC;AAEA,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,GAAG,kBAAkB,QAAQ,WAAW,UAAU,SAAS,gBAAgB,MAAM;AAAA,IACzG;AACA,YAAQ,IAAI,aAAM,OAAO;AAGzB,UAAM,eAAe,SAAS,SAAS,kBAAkB,MAAM,OAAO;AAAA,EACxE;AAKA,SAAO,sBAAsB,SAAS,WAAW;AAC/C,QAAI,CAAC;AAAkB;AAGvB,QAAI,uBAAuB,WAAW;AAEpC,2BAAqB;AACrB,cAAQ,IAAI,uCAAuC,SAAS,EAAE;AAC9D,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,oBAAoB,SAAS,UAAU,MAAM;AAAA,MACrE;AAAA,IACF,OAAO;AAEL,YAAM,gBAAgB;AACtB,2BAAqB;AACrB,cAAQ,IAAI,mCAAmC,SAAS,EAAE;AAC1D,UAAI,gBAAgB;AAClB,YAAI,eAAe;AACjB,cAAI,aAAa,KAAK,+BAA+B,aAAa,OAAO,SAAS,IAAI,SAAS;AAAA,QACjG,OAAO;AACL,cAAI,aAAa,KAAK,oBAAoB,SAAS,IAAI,MAAM;AAAA,QAC/D;AAAA,MACF;AAAA,IACF;AAGA,sBAAkB,gBAAgB;AAAA,EACpC;AAOA,SAAO,WAAW,iBAAiB;AACjC,QAAI,CAAC;AAAkB;AAEvB,YAAQ,IAAI,iDAA0C,iBAAiB,IAAI;AAC3E,YAAQ,IAAI,wBAAwB,iBAAiB,SAAS;AAE9D,UAAM,YAAY,iBAAiB,WAAW,WAAW;AACzD,UAAM,QAAQ,iBAAiB,WAAW,OAAO;AAEjD,UAAM,aAAa,OAAO,eAAe,SAAS,IAAI,KAAK;AAAA;AAAA,iEAAsE;AACjI,QAAI,eAAe;AAAM;AAEzB,UAAM,SAAS,SAAS,UAAU;AAClC,QAAI,MAAM,MAAM;AAAG;AAEnB,UAAM,QAAQ,KAAK,IAAI,GAAG,KAAK,IAAI,OAAO,YAAY,MAAM,CAAC;AAE7D,YAAQ,IAAI,iBAAiB,MAAM,aAAa,KAAK,IAAI,KAAK,EAAE;AAGhE,QAAI,CAAC,iBAAiB,WAAW;AAC/B,uBAAiB,YAAY,EAAE,SAAS,GAAG,KAAK,EAAE;AAAA,IACpD;AAGA,qBAAiB,UAAU,UAAU;AACrC,YAAQ,IAAI,yCAAyC,iBAAiB,SAAS;AAG/E,UAAM,UAAU,SAAS,IACrB,GAAG,iBAAiB,IAAI,UAAU,MAAM,QAAQ,KAAK,IAAI,KAAK,MAC9D,GAAG,iBAAiB,IAAI,UAAU,KAAK,IAAI,MAAM,CAAC,YAAY,KAAK,IAAI,KAAK;AAEhF,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,SAAS,SAAS,IAAI,YAAY,SAAS;AAAA,IACnE;AAGA,UAAM,cAAc,SAAS,IAAI,YAAY;AAC7C,YAAQ,IAAI,8BAA8B,OAAO;AACjD,UAAM,eAAe,SAAS,aAAa,iBAAiB,IAAI;AAGhE,YAAQ,IAAI,mDAAmD,iBAAiB,SAAS;AACzF,qBAAiB,gBAAgB;AAAA,EAKnC;AAKA,SAAO,kBAAkB,SAAS,OAAO,cAAc,OAAO;AAC5D,QAAI,CAAC,oBAAoB,CAAC,iBAAiB;AAAY;AAEvD,UAAM,UAAU,cAAc,mBAAmB,QAAQ,KAAK;AAC9D,UAAM,SAAS,cAAc,sBAAsB,QAAQ,KAAK;AAChE,UAAM,UAAU,iBAAiB,WAAW,OAAO,KAAK;AACxD,UAAM,MAAM,iBAAiB,WAAW,MAAM,KAAK;AAEnD,UAAM,WAAW,cAAc,eAAe,SAAS,KAAK;AAC5D,UAAM,aAAa,OAAO,GAAG,QAAQ,KAAK,OAAO,IAAI,GAAG;AAAA;AAAA,yDAA8D;AACtH,QAAI,eAAe;AAAM;AAEzB,UAAM,SAAS,SAAS,UAAU;AAClC,QAAI,MAAM,MAAM;AAAG;AAEnB,UAAM,WAAW,KAAK,IAAI,GAAG,KAAK,IAAI,KAAK,UAAU,MAAM,CAAC;AAC5D,qBAAiB,WAAW,OAAO,IAAI;AAGvC,qBAAiB,gBAAgB;AAEjC,QAAI,gBAAgB;AAClB,YAAM,UAAU,SAAS,IAAI,YAAY,MAAM,IAAI,QAAQ,KAAK,QAAQ,KAAK,IAAI,MAAM,CAAC,IAAI,QAAQ;AACpG,UAAI,aAAa,KAAK,SAAS,MAAM;AAAA,IACvC;AAAA,EACF;AAKA,SAAO,iBAAiB,SAAS,cAAc;AAC7C,QAAI,CAAC,oBAAoB,CAAC,iBAAiB;AAAW;AAEtD,UAAM,WAAW,iBAAiB,UAAU,KAAK,OAAK,EAAE,SAAS,YAAY;AAC7E,QAAI,CAAC;AAAU;AAEf,UAAM,UAAU,SAAS,WAAW;AACpC,UAAM,MAAM,SAAS,OAAO;AAE5B,UAAM,aAAa,OAAO,GAAG,YAAY,KAAK,OAAO,IAAI,GAAG;AAAA;AAAA,yDAA8D;AAC1H,QAAI,eAAe;AAAM;AAEzB,UAAM,SAAS,SAAS,UAAU;AAClC,QAAI,MAAM,MAAM;AAAG;AAEnB,UAAM,WAAW,KAAK,IAAI,GAAG,KAAK,IAAI,KAAK,UAAU,MAAM,CAAC;AAC5D,aAAS,UAAU;AAGnB,qBAAiB,gBAAgB;AAEjC,QAAI,gBAAgB;AAClB,YAAM,UAAU,SAAS,IAAI,YAAY,MAAM,IAAI,YAAY,KAAK,QAAQ,KAAK,IAAI,MAAM,CAAC,IAAI,YAAY;AAC5G,UAAI,aAAa,KAAK,SAAS,MAAM;AAAA,IACvC;AAAA,EACF;AAKA,SAAO,aAAa,eAAe,aAAa,eAAe,MAAM;AACnE,QAAI,CAAC;AAAkB;AAGvB,QAAI,gBAAgB,iBAAiB,WAAW;AAC9C,YAAM,WAAW,iBAAiB,UAAU,KAAK,OAAK,EAAE,SAAS,YAAY;AAC7E,UAAI,YAAY,SAAS,UAAU,GAAG;AACpC,iBAAS,WAAW;AACpB,yBAAiB,gBAAgB;AAAA,MACnC,WAAW,YAAY,SAAS,YAAY,GAAG;AAC7C,YAAI,gBAAgB;AAClB,cAAI,aAAa,KAAK,MAAM,YAAY,eAAe,OAAO;AAAA,QAChE;AACA;AAAA,MACF;AAAA,IACF;AAGA,UAAM,UAAU,iBAAiB,UAAU,KAAK,OAAK,EAAE,SAAS,WAAW;AAG3E,UAAM,UAAU,uBAAkB,WAAW,YAAY,eAAe,KAAK,YAAY,MAAM,EAAE;AAGjG,QAAI,UAAU,WAAW,WAAW;AAEpC,QAAI,SAAS;AACX,UAAI,cAAc;AAChB,cAAM,WAAW,iBAAiB,WAAW,KAAK,OAAK,EAAE,SAAS,YAAY;AAC9E,YAAI,UAAU;AACZ,qBAAW,kCAAkC,YAAY,KAAK,SAAS,OAAO,IAAI,SAAS,GAAG;AAAA,QAChG;AAAA,MACF;AACA,UAAI,QAAQ;AAAS,mBAAW,WAAW,QAAQ,OAAO;AAC1D,UAAI,QAAQ;AAAa,mBAAW,WAAW,QAAQ,WAAW;AAClE,UAAI,QAAQ;AAAO,mBAAW,oCAAoC,QAAQ,KAAK;AAAA,IACjF;AAEA,UAAM,eAAe,SAAS,UAAU,iBAAiB,MAAM,OAAO;AAEtE,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,GAAG,iBAAiB,IAAI,SAAS,WAAW,IAAI,MAAM;AAAA,IAC9E;AAAA,EACF;AAKA,SAAO,qBAAqB,eAAe,aAAa;AACtD,QAAI,CAAC,oBAAoB,CAAC,iBAAiB;AAAU;AAGrD,UAAM,UAAU,iBAAiB,SAAS,KAAK,OAAK,EAAE,SAAS,WAAW;AAC1E,QAAI,CAAC,SAAS;AACZ,cAAQ,KAAK,YAAY,WAAW,aAAa;AACjD;AAAA,IACF;AAGA,QAAI,CAAC,QAAQ,QAAQ,QAAQ,KAAK,UAAU,QAAW;AACrD,cAAQ,KAAK,YAAY,WAAW,wBAAwB;AAC5D;AAAA,IACF;AAGA,QAAI,QAAQ,KAAK,SAAS,GAAG;AAC3B,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,cAAc,WAAW,eAAe,OAAO;AAAA,MACvE;AACA;AAAA,IACF;AAGA,YAAQ,KAAK,SAAS;AAGtB,wBAAoB,gBAAgB;AAGpC,UAAM,UAAU,uBAAkB,WAAW,cAAc,QAAQ,KAAK,KAAK,IAAI,QAAQ,KAAK,OAAO,QAAQ,KAAK,QAAQ,CAAC;AAG3H,QAAI,UAAU,WAAW,WAAW;AAEpC,QAAI,QAAQ,MAAM;AAChB,iBAAW,wCAAwC,QAAQ,KAAK,KAAK,IAAI,QAAQ,KAAK,OAAO,QAAQ,KAAK,QAAQ,CAAC;AACnH,UAAI,QAAQ;AAAO,mBAAW,gCAAgC,QAAQ,KAAK;AAAA,IAC7E;AAEA,QAAI,QAAQ;AAAS,iBAAW,WAAW,QAAQ,OAAO;AAC1D,QAAI,QAAQ;AAAa,iBAAW,WAAW,QAAQ,WAAW;AAElE,UAAM,eAAe,SAAS,UAAU,iBAAiB,MAAM,OAAO;AAEtE,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,GAAG,iBAAiB,IAAI,SAAS,WAAW,IAAI,MAAM;AAAA,IAC9E;AAAA,EACF;AAKA,SAAO,YAAY,eAAe,YAAY;AAC5C,QAAI,CAAC,oBAAoB,CAAC,iBAAiB;AAAS;AAGpD,UAAM,SAAS,iBAAiB,QAAQ,KAAK,OAAK,EAAE,SAAS,UAAU;AACvE,QAAI,CAAC,QAAQ;AACX,cAAQ,KAAK,WAAW,UAAU,aAAa;AAC/C;AAAA,IACF;AAGA,QAAI,CAAC,OAAO,QAAQ,OAAO,KAAK,UAAU,QAAW;AACnD,cAAQ,KAAK,WAAW,UAAU,wBAAwB;AAC1D;AAAA,IACF;AAGA,QAAI,OAAO,KAAK,SAAS,GAAG;AAC1B,UAAI,gBAAgB;AAClB,YAAI,aAAa,KAAK,cAAc,UAAU,eAAe,OAAO;AAAA,MACtE;AACA;AAAA,IACF;AAGA,WAAO,KAAK,SAAS;AAGrB,uBAAmB,gBAAgB;AAGnC,UAAM,UAAU,uBAAkB,UAAU,cAAc,OAAO,KAAK,KAAK,IAAI,OAAO,KAAK,OAAO,OAAO,KAAK,QAAQ,CAAC;AAGvH,QAAI,UAAU,WAAW,UAAU,uCAAuC,OAAO,cAAc,QAAQ;AAEvG,QAAI,OAAO,MAAM;AACf,iBAAW,wCAAwC,OAAO,KAAK,KAAK,IAAI,OAAO,KAAK,OAAO,OAAO,KAAK,QAAQ,CAAC;AAChH,UAAI,OAAO;AAAO,mBAAW,gCAAgC,OAAO,KAAK;AAAA,IAC3E;AAEA,QAAI,OAAO;AAAY,iBAAW,gCAAgC,OAAO,UAAU;AACnF,QAAI,OAAO;AAAQ,iBAAW,gCAAgC,OAAO,MAAM;AAC3E,QAAI,OAAO;AAAY,iBAAW,KAAK,OAAO,UAAU;AACxD,QAAI,OAAO;AAAS,iBAAW,WAAW,OAAO,OAAO;AACxD,QAAI,OAAO;AAAa,iBAAW,WAAW,OAAO,WAAW;AAEhE,UAAM,eAAe,SAAS,UAAU,iBAAiB,MAAM,OAAO;AAEtE,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,GAAG,iBAAiB,IAAI,SAAS,UAAU,IAAI,MAAM;AAAA,IAC7E;AAAA,EACF;AAOA,SAAO,gBAAgB,iBAAiB;AACtC,QAAI,CAAC;AAAkB;AAEvB,UAAMK,WAAU,OAAO;AAAA,MACrB;AAAA,IAIF;AAEA,QAAI,CAACA;AAAS;AAGd,UAAM,UAAU,iBAAiB;AACjC,QAAI,WAAW,QAAQ,UAAU,GAAG;AAClC,YAAM,QAAQ,OAAO,OAAO,YAAY,QAAQ,OAAO,IAAI,QAAQ,GAAG,eAAe,QAAQ,IAAI;AAAA;AAAA,+BAAqC;AACtI,UAAI,OAAO;AACT,cAAMF,SAAQ,KAAK,IAAI,SAAS,KAAK,KAAK,GAAG,QAAQ,OAAO;AAC5D,YAAIA,SAAQ,GAAG;AACb,cAAI,eAAe;AACnB,mBAAS,IAAI,GAAG,IAAIA,QAAO,KAAK;AAC9B,kBAAM,OAAO,KAAK,MAAM,KAAK,OAAO,IAAK,QAAQ,IAAK,IAAI;AAC1D,kBAAM,SAAS,iBAAiB,eAAe,gBAAgB;AAC/D,4BAAgB,OAAO;AAAA,UACzB;AAEA,gBAAM,YAAY,iBAAiB,WAAW,WAAW;AACzD,gBAAM,QAAQ,iBAAiB,WAAW,OAAO;AACjD,gBAAM,QAAQ,KAAK,IAAI,OAAO,YAAY,YAAY;AAEtD,2BAAiB,UAAU,UAAU;AACrC,2BAAiB,QAAQ,WAAWA;AAEpC,cAAI,gBAAgB;AAClB,gBAAI,aAAa,KAAK,qBAAqBA,MAAK,wBAAwB,YAAY,OAAO,SAAS;AAAA,UACtG;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAGA,qBAAiB,gBAAgB;AAAA,EAInC;AAKA,SAAO,eAAe,iBAAiB;AACrC,QAAI,CAAC;AAAkB;AAEvB,UAAME,WAAU,OAAO;AAAA,MACrB;AAAA,IAMF;AAEA,QAAI,CAACA;AAAS;AAGd,UAAM,QAAQ,iBAAiB,WAAW,OAAO;AACjD,qBAAiB,UAAU,UAAU;AAGrC,QAAI,iBAAiB,YAAY;AAC/B,eAAS,QAAQ,GAAG,SAAS,GAAG,SAAS;AACvC,cAAM,SAAS,QAAQ,KAAK;AAC5B,cAAM,aAAa,QAAQ,KAAK;AAChC,YAAI,iBAAiB,WAAW,MAAM,GAAG;AACvC,2BAAiB,WAAW,UAAU,IAAI,iBAAiB,WAAW,MAAM;AAAA,QAC9E;AAAA,MACF;AAEA,UAAI,iBAAiB,WAAW,mBAAmB;AACjD,yBAAiB,WAAW,iBAAiB,iBAAiB,WAAW;AAAA,MAC3E;AAAA,IACF;AAGA,QAAI,iBAAiB,SAAS;AAC5B,YAAM,YAAY,KAAK,IAAI,GAAG,KAAK,MAAM,iBAAiB,QAAQ,MAAM,CAAC,CAAC;AAC1E,uBAAiB,QAAQ,UAAU,KAAK;AAAA,QACtC,iBAAiB,QAAQ;AAAA,QACzB,iBAAiB,QAAQ,UAAU;AAAA,MACrC;AAAA,IACF;AAGA,QAAI,iBAAiB,WAAW;AAC9B,uBAAiB,UAAU,QAAQ,cAAY;AAC7C,iBAAS,UAAU,SAAS;AAAA,MAC9B,CAAC;AAAA,IACH;AAEA,QAAI,gBAAgB;AAClB,UAAI,aAAa,KAAK,cAAc,iBAAiB,IAAI,qBAAqB,SAAS;AAAA,IACzF;AAGA,qBAAiB,gBAAgB;AAAA,EAGnC;AAOA,SAAO,oBAAoB,SAAS,WAAW;AAC7C,UAAM,UAAU,SAAS,eAAe,SAAS;AACjD,UAAM,SAAS,QAAQ;AAEvB,QAAI,WAAW,QAAQ;AACrB,cAAQ,UAAU,OAAO,WAAW;AACpC,aAAO,UAAU,OAAO,WAAW;AAGnC,YAAM,QAAQ,OAAO,cAAc,2BAA2B;AAC9D,UAAI,OAAO;AACT,cAAM,cAAc,QAAQ,UAAU,SAAS,WAAW;AAC1D,cAAM,MAAM,YAAY,cAAc,mBAAmB;AAAA,MAC3D;AAAA,IACF;AAAA,EACF;AAKA,SAAO,oBAAoB,SAAS,QAAQ;AAC1C,UAAM,OAAO,SAAS,eAAe,MAAM;AAC3C,QAAI,CAAC;AAAM;AAGX,UAAM,aAAa,KAAK;AACxB,QAAI,YAAY;AACd,iBAAW,UAAU,OAAO,UAAU;AAAA,IACxC;AAAA,EACF;AAIA,UAAQ,IAAI,qDAA8C;AAC1D,aAAW,cAAc;AAGzB,MAAI,SAAS,eAAe,WAAW;AACrC,aAAS,iBAAiB,oBAAoB,MAAM;AAElD,mBAAa,KAAK;AAClB,8BAAwB;AAAA,IAC1B,CAAC;AAAA,EACH,OAAO;AAGL,iBAAa,KAAK;AAClB,4BAAwB;AAAA,EAC1B;AAGA,aAAW,MAAM;AACf,QAAI,CAAC,gBAAgB;AACnB,iBAAW,cAAc;AAAA,IAC3B;AAAA,EACF,GAAG,GAAI;AAEP,UAAQ,IAAI,wCAAiC;",
  "names": ["modifier", "session", "formula", "count", "sides", "confirm"]
}
