{
  "version": 3,
  "sources": ["../../../core/src/supabase/config.js", "../../src/background-chrome.js"],
  "sourcesContent": ["/**\r\n * Supabase Configuration\r\n * Single Supabase instance shared across all CarmaClouds projects\r\n */\r\n\r\n// Shared Supabase instance\r\nexport const SUPABASE_URL = 'https://luiesmfjdcmpywavvfqm.supabase.co';\r\nexport const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1aWVzbWZqZGNtcHl3YXZ2ZnFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODYxNDksImV4cCI6MjA4NTQ2MjE0OX0.oqjHFf2HhCLcanh0HVryoQH7iSV7E9dHHZJdYehxZ0U';\r\n\r\n/**\r\n * Table names for different projects\r\n */\r\nexport const TABLES = {\r\n  // Shared tables\r\n  AUTH_TOKENS: 'auth_tokens',\r\n  PAIRINGS: 'clouds_pairings',\r\n\r\n  // Project-specific character tables\r\n  OWLCLOUD_CHARACTERS: 'clouds_characters',\r\n  ROLLCLOUD_CHARACTERS: 'rollcloud_characters',\r\n  FOUNDCLOUD_CHARACTERS: 'foundcloud_characters', // Future\r\n};\r\n\r\n/**\r\n * Project-specific configurations\r\n */\r\nexport const PROJECT_CONFIGS = {\r\n  owlcloud: {\r\n    characterTable: TABLES.OWLCLOUD_CHARACTERS,\r\n    pairingTable: TABLES.PAIRINGS,\r\n    cacheStorageKey: 'owlcloud_character_cache',\r\n  },\r\n  rollcloud: {\r\n    characterTable: TABLES.ROLLCLOUD_CHARACTERS,\r\n    pairingTable: TABLES.PAIRINGS,\r\n    cacheStorageKey: 'rollcloud_character_cache',\r\n  },\r\n  foundcloud: {\r\n    characterTable: TABLES.FOUNDCLOUD_CHARACTERS,\r\n    pairingTable: TABLES.PAIRINGS,\r\n    cacheStorageKey: 'foundcloud_character_cache',\r\n  },\r\n};\r\n\r\n/**\r\n * Get configuration for a specific project\r\n * @param {string} projectName - Project name (owlcloud, rollcloud, foundcloud)\r\n * @returns {Object} Project configuration\r\n */\r\nexport function getProjectConfig(projectName) {\r\n  const config = PROJECT_CONFIGS[projectName];\r\n  if (!config) {\r\n    throw new Error(`Unknown project: ${projectName}`);\r\n  }\r\n  return {\r\n    ...config,\r\n    supabaseUrl: SUPABASE_URL,\r\n    supabaseKey: SUPABASE_ANON_KEY,\r\n  };\r\n}\r\n", "/**\n * Background Service Worker - Chrome Manifest V3\n * Handles data storage, API authentication, and communication between Dice Cloud and Discord\n */\n\n// Import Supabase config directly for service worker context\nimport { SUPABASE_URL, SUPABASE_ANON_KEY } from '../../core/src/supabase/config.js';\n\n// Service worker context doesn't have window, so define debug locally\nconst debug = {\n  log: console.log.bind(console),\n  warn: console.warn.bind(console),\n  error: console.error.bind(console),\n  info: console.info.bind(console),\n  group: console.group.bind(console),\n  groupEnd: console.groupEnd.bind(console),\n  table: console.table.bind(console),\n  time: console.time.bind(console),\n  timeEnd: console.timeEnd.bind(console),\n  isEnabled: () => true\n};\n\n// Note: We don't import browser.js here because it's designed for DOM contexts\n// Service workers only need minimal dependencies\n\ndebug.log('OwlCloud: Background script starting...');\n\n// Detect browser and use appropriate API\n// For Firefox, use the native Promise-based 'browser' API\n// For Chrome, use native 'chrome' API directly (no polyfill needed in service worker)\nconst browserAPI = (typeof browser !== 'undefined' && browser.runtime) ? browser : chrome;\n\n/**\n * Chrome MV3-compatible storage wrapper\n * Handles both Promise-based and callback-based Chrome storage API\n */\nconst storage = {\n  async get(keys) {\n    return new Promise((resolve, reject) => {\n      try {\n        const result = browserAPI.storage.local.get(keys, (items) => {\n          if (browserAPI.runtime.lastError) {\n            reject(new Error(browserAPI.runtime.lastError.message));\n          } else {\n            resolve(items);\n          }\n        });\n        // If it returns a Promise, use that instead (Chrome MV3)\n        if (result && typeof result.then === 'function') {\n          result.then(resolve).catch(reject);\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n  },\n\n  async set(items) {\n    return new Promise((resolve, reject) => {\n      try {\n        const result = browserAPI.storage.local.set(items, () => {\n          if (browserAPI.runtime.lastError) {\n            reject(new Error(browserAPI.runtime.lastError.message));\n          } else {\n            resolve();\n          }\n        });\n        // If it returns a Promise, use that instead (Chrome MV3)\n        if (result && typeof result.then === 'function') {\n          result.then(resolve).catch(reject);\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n  },\n\n  async remove(keys) {\n    return new Promise((resolve, reject) => {\n      try {\n        const result = browserAPI.storage.local.remove(keys, () => {\n          if (browserAPI.runtime.lastError) {\n            reject(new Error(browserAPI.runtime.lastError.message));\n          } else {\n            resolve();\n          }\n        });\n        // If it returns a Promise, use that instead (Chrome MV3)\n        if (result && typeof result.then === 'function') {\n          result.then(resolve).catch(reject);\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n};\n\n// Listen for storage changes to help debug unexpected logout/token removal\nif (browserAPI && browserAPI.storage && browserAPI.storage.onChanged) {\n  browserAPI.storage.onChanged.addListener((changes, area) => {\n    if (area !== 'local') return;\n    if (changes.diceCloudToken) {\n      const oldVal = changes.diceCloudToken.oldValue;\n      const newVal = changes.diceCloudToken.newValue;\n      debug.log('\uD83D\uDD01 Storage change: diceCloudToken updated', { hasOld: !!oldVal, hasNew: !!newVal });\n    }\n    if (changes.explicitlyLoggedOut) {\n      debug.log('\uD83D\uDD12 Storage change: explicitlyLoggedOut set/cleared', { old: changes.explicitlyLoggedOut.oldValue, new: changes.explicitlyLoggedOut.newValue });\n    }\n  });\n  debug.log('\uD83D\uDEF0\uFE0F Storage change listener registered for debug');\n}\n\n// Add startup storage check to debug auth persistence\n(async () => {\n  try {\n    const startupStorage = await storage.get(['diceCloudToken', 'diceCloudUserId', 'tokenExpires', 'username', 'explicitlyLoggedOut']);\n    debug.log('\uD83D\uDE80 Background script startup storage state:', {\n      hasToken: !!startupStorage.diceCloudToken,\n      tokenLength: startupStorage.diceCloudToken ? startupStorage.diceCloudToken.length : 0,\n      tokenStart: startupStorage.diceCloudToken ? startupStorage.diceCloudToken.substring(0, 20) + '...' : 'none',\n      username: startupStorage.username,\n      diceCloudUserId: startupStorage.diceCloudUserId,\n      tokenExpires: startupStorage.tokenExpires,\n      explicitlyLoggedOut: startupStorage.explicitlyLoggedOut,\n      allKeys: Object.keys(startupStorage)\n    });\n\n    // If we have a token but no explicitlyLoggedOut flag, ensure we're in a good state\n    if (startupStorage.diceCloudToken && !startupStorage.explicitlyLoggedOut) {\n      debug.log('\u2705 Service worker restarted with valid auth state');\n\n      // Validate the token expiry on startup\n      if (startupStorage.tokenExpires) {\n        const expiryDate = new Date(startupStorage.tokenExpires);\n        const now = new Date();\n\n        if (!isNaN(expiryDate.getTime()) && now < expiryDate) {\n          debug.log('\u2705 Token is still valid on startup');\n        } else if (isNaN(expiryDate.getTime())) {\n          debug.warn('\u26A0\uFE0F Invalid expiry date on startup, clearing it');\n          await storage.remove('tokenExpires');\n        } else {\n          debug.warn('\u23F0 Token expired on startup, logging out');\n          await logout();\n        }\n      }\n    } else if (startupStorage.explicitlyLoggedOut) {\n      debug.log('\u23ED\uFE0F Service worker restarted after explicit logout');\n    } else {\n      debug.log('\uD83D\uDD0D No auth state found on startup');\n    }\n  } catch (error) {\n    debug.error('Failed to check startup storage:', error);\n  }\n})();\n\n// Detect which browser we're running on\nconst isFirefox = typeof browser !== 'undefined';\ndebug.log('OwlCloud: Background script initialized on', isFirefox ? 'Firefox' : 'Chrome');\n\n// Add service worker lifecycle listeners for Chrome\nif (!isFirefox && chrome.runtime && chrome.runtime.onSuspend) {\n  chrome.runtime.onSuspend.addListener(() => {\n    debug.log('\uD83D\uDD0C Service worker suspending - saving state...');\n    // Any cleanup before suspension goes here\n  });\n}\n\nif (!isFirefox && chrome.runtime && chrome.runtime.onSuspendCanceled) {\n  chrome.runtime.onSuspendCanceled.addListener(() => {\n    debug.log('\u267B\uFE0F Service worker suspension canceled');\n  });\n}\n\nif (!isFirefox && chrome.runtime && chrome.runtime.onStartup) {\n  chrome.runtime.onStartup.addListener(() => {\n    debug.log('\uD83D\uDE80 Chrome startup event received');\n  });\n}\n\n// Persistent alarm to keep service worker alive for realtime connections\n// Chrome MV3 service workers terminate after ~30s of inactivity, breaking WebSockets\n// Firefox event pages also benefit from periodic activity\nconst REALTIME_KEEPALIVE_ALARM = 'realtimeKeepAlive';\n\n// Setup alarm listener for both Chrome and Firefox\nif (browserAPI.alarms) {\n  browserAPI.alarms.onAlarm.addListener(async (alarm) => {\n    if (alarm.name === REALTIME_KEEPALIVE_ALARM) {\n      debug.log('\u23F0 Realtime keep-alive alarm triggered');\n\n      // Check if we should have a realtime connection\n      const settings = await browserAPI.storage.local.get(['discordWebhookEnabled', 'discordPairingId', 'discordWebhookUrl']);\n      const hasWebhookIntegration = settings.discordWebhookEnabled && settings.discordWebhookUrl;\n      const hasPairingIntegration = settings.discordPairingId;\n\n      if (!hasWebhookIntegration && !hasPairingIntegration) {\n        debug.log('\u23ED\uFE0F No active Discord connection, skipping realtime check');\n        return;\n      }\n\n      // Check if WebSocket is still connected\n      if (!commandRealtimeSocket || commandRealtimeSocket.readyState !== WebSocket.OPEN) {\n        debug.log('\uD83D\uDD04 WebSocket disconnected, reconnecting...');\n        await subscribeToCommandRealtime(settings.discordPairingId);\n      } else {\n        debug.log('\u2705 WebSocket still connected');\n      }\n\n      // Drain any pending commands that may have arrived\n      drainPendingCommands();\n    }\n  });\n  debug.log('\uD83D\uDEF0\uFE0F Realtime keep-alive alarm listener registered');\n\n  // Also handle the short-term keepAlive alarm\n  browserAPI.alarms.onAlarm.addListener((alarm) => {\n    if (alarm.name === 'keepAlive') {\n      debug.log('\uD83D\uDC93 Keep-alive alarm triggered');\n    }\n  });\n}\n\n/**\n * Start the realtime keep-alive alarm (call when Discord is connected)\n */\nfunction startRealtimeKeepAlive() {\n  if (browserAPI.alarms) {\n    // Fire every 1 minute to keep service worker/event page alive\n    // Chrome terminates after ~30s of inactivity, but sub-minute alarms are unreliable\n    // Firefox event pages benefit from periodic activity too\n    browserAPI.alarms.create(REALTIME_KEEPALIVE_ALARM, { periodInMinutes: 1 });\n    debug.log('\u23F0 Started realtime keep-alive alarm');\n  }\n}\n\n/**\n * Stop the realtime keep-alive alarm (call when Discord is disconnected)\n */\nfunction stopRealtimeKeepAlive() {\n  if (browserAPI.alarms) {\n    browserAPI.alarms.clear(REALTIME_KEEPALIVE_ALARM);\n    debug.log('\u23F0 Stopped realtime keep-alive alarm');\n  }\n}\n\nlet keepAliveInterval = null;\n\n/**\n * Keeps the service worker alive during critical operations\n * Chrome service workers can be terminated after ~5 minutes of inactivity\n */\nfunction keepServiceWorkerAlive(durationMs = 30000) {\n  if (keepAliveInterval) {\n    clearInterval(keepAliveInterval);\n  }\n  \n  debug.log('\uD83D\uDC93 Keeping service worker alive for', durationMs, 'ms');\n\n  // Use chrome.alarms API if available, otherwise fallback to setInterval\n  if (chrome.alarms) {\n    chrome.alarms.create('keepAlive', { delayInMinutes: durationMs / 60000 });\n    // Listener is set up globally, no need to add it here\n  } else {\n    // Fallback: ping ourselves every 25 seconds\n    keepAliveInterval = setInterval(() => {\n      debug.log('\uD83D\uDC93 Service worker keep-alive ping');\n    }, 25000);\n    \n    setTimeout(() => {\n      if (keepAliveInterval) {\n        clearInterval(keepAliveInterval);\n        keepAliveInterval = null;\n        debug.log('\uD83D\uDC93 Keep-alive interval cleared');\n      }\n    }, durationMs);\n  }\n}\n\n/**\n * Stops the keep-alive mechanism\n */\nfunction stopKeepAlive() {\n  if (keepAliveInterval) {\n    clearInterval(keepAliveInterval);\n    keepAliveInterval = null;\n  }\n  if (chrome.alarms) {\n    chrome.alarms.clear('keepAlive');\n  }\n  debug.log('\uD83D\uDC94 Keep-alive stopped');\n}\nif (isFirefox) {\n  debug.log('\uD83E\uDD8A Firefox detected - checking extension context...');\n  \n  // Test if we can access runtime\n  try {\n    const manifest = browserAPI.runtime.getManifest();\n    debug.log('\u2705 Firefox runtime accessible, version:', manifest.version);\n  } catch (error) {\n    debug.error('\u274C Firefox runtime not accessible:', error);\n  }\n  \n  // Test storage\n  try {\n    browserAPI.storage.local.get(['test'], (result) => {\n      if (browserAPI.runtime.lastError) {\n        debug.error('\u274C Firefox storage error:', browserAPI.runtime.lastError);\n      } else {\n        debug.log('\u2705 Firefox storage working');\n      }\n    });\n  } catch (error) {\n    debug.error('\u274C Firefox storage test error:', error);\n  }\n}\n\nconst API_BASE = 'https://dicecloud.com/api';\n\n// Listen for messages from content scripts and popup\nbrowserAPI.runtime.onMessage.addListener((request, sender, sendResponse) => {\n  debug.log('Background received message:', request);\n  debug.log('Message sender:', sender);\n\n  // If this is a content script message, let it handle itself\n  if (sender.tab && request.action === 'extractAuthToken') {\n    debug.log('\uD83D\uDCE4 Passing extractAuthToken to content script - not handling in background');\n    return false; // Don't handle here, let content script handle it\n  }\n\n  // Handle async operations and call sendResponse when done\n  // This pattern keeps the message port open until sendResponse is called\n  (async () => {\n    try {\n      let response;\n\n      switch (request.action) {\n        case 'storeCharacterData':\n          await storeCharacterData(request.data, request.slotId);\n          // Auto-sync to Supabase if Discord is connected (for Discord bot commands)\n          // This ensures spells/actions are always available to Discord commands\n          try {\n            if (typeof SupabaseTokenManager !== 'undefined') {\n              const webhookSettings = await browserAPI.storage.local.get(['discordWebhookEnabled', 'discordUserId']);\n              const shouldAutoSync = request.syncToCloud || webhookSettings.discordWebhookEnabled || webhookSettings.discordUserId;\n              if (shouldAutoSync) {\n                debug.log('\u2601\uFE0F Auto-syncing character to cloud (Discord connected)');\n                await storeCharacterToCloud(request.data, request.pairingCode);\n              }\n            }\n          } catch (syncError) {\n            debug.warn('\u26A0\uFE0F Auto-sync to cloud failed (non-fatal):', syncError.message);\n          }\n          response = { success: true };\n          break;\n\n        case 'syncCharacterToCloud': {\n          // Explicitly sync character to Supabase\n          const syncResult = await storeCharacterToCloud(request.characterData, request.pairingCode);\n          response = syncResult;\n          break;\n        }\n\n        case 'syncCharacterColor': {\n          // Sync character color to Supabase\n          const syncResult = await syncCharacterColorToSupabase(request.characterId, request.color);\n          response = syncResult;\n          break;\n        }\n\n        case 'checkDiscordCharacterIntegration': {\n          // Check if current character is active in Discord bot\n          const checkResult = await checkDiscordCharacterIntegration(request.characterName, request.characterId);\n          response = checkResult;\n          break;\n        }\n\n        case 'fetchDiceCloudAPI': {\n          // Fetch from DiceCloud API\n          const fetchResult = await fetchFromDiceCloudAPI(request.url, request.token);\n          response = fetchResult;\n          break;\n        }\n\n        case 'getCharacterData': {\n          const data = await getCharacterData(request.characterId);\n          response = { success: true, data };\n          break;\n        }\n\n        case 'getCharacterDataFromDatabase': {\n          // Handle database character loading\n          const data = await getCharacterDataFromDatabase(request.characterId);\n          response = { success: true, data };\n          break;\n        }\n\n        case 'getAllCharacterProfiles': {\n          const profiles = await getAllCharacterProfiles();\n          response = { success: true, profiles };\n          break;\n        }\n\n        case 'setActiveCharacter':\n          await setActiveCharacter(request.characterId);\n          response = { success: true };\n          break;\n\n        case 'getActiveCharacter': {\n          const character = await getActiveCharacter();\n          response = { success: true, character };\n          break;\n        }\n\n        case 'clearCharacterData':\n          await clearCharacterData(request.characterId);\n          response = { success: true };\n          break;\n\n        case 'deleteCharacterFromCloud':\n          await deleteCharacterFromCloud(request.characterId);\n          response = { success: true };\n          break;\n\n        case 'loginToDiceCloud': {\n          const authData = await loginToDiceCloud(request.username, request.password);\n          response = { success: true, authData };\n          break;\n        }\n\n        case 'setApiToken': {\n          await setApiToken(request.token, request.userId, request.tokenExpires, request.username);\n          response = { success: true };\n          break;\n        }\n\n        case 'getApiToken': {\n          const token = await getApiToken();\n          response = { success: true, token };\n          break;\n        }\n\n        case 'getManifest': {\n          const manifest = browserAPI.runtime.getManifest();\n          response = { success: true, manifest };\n          break;\n        }\n\n        case 'logout':\n          await logout();\n          response = { success: true };\n          break;\n\n        // Handle extractAuthToken with tabId and forward to content script\n        case 'extractAuthToken': {\n          if (request.tabId) {\n            debug.log('\uD83D\uDCE4 Forwarding extractAuthToken to tab:', request.tabId);\n            try {\n              const contentResponse = await browserAPI.tabs.sendMessage(request.tabId, {\n                action: 'extractAuthToken'\n              });\n              debug.log('\uD83D\uDCE5 Received response from content script:', contentResponse);\n              response = { success: true, data: contentResponse };\n            } catch (error) {\n              debug.error('\u274C Error forwarding to content script:', error);\n              response = { success: false, error: error.message };\n            }\n          } else {\n            response = { success: false, error: 'No tabId provided' };\n          }\n          break;\n        }\n\n        // ============== Discord Pairing Message Handlers ==============\n\n        case 'checkLoginStatus': {\n          const loginStatus = await checkLoginStatus();\n          response = { success: true, ...loginStatus };\n          break;\n        }\n\n        case 'createDiscordPairing': {\n          const pairingResult = await createDiscordPairing(request.code, request.username, request.diceCloudUserId);\n          response = pairingResult;\n          break;\n        }\n\n        case 'checkDiscordPairing': {\n          const checkResult = await checkDiscordPairing(request.code);\n          response = checkResult;\n          break;\n        }\n\n        case 'setDiscordWebhook': {\n          // Use request.enabled if provided, otherwise default to true when URL is provided\n          const enabled = request.enabled !== undefined ? request.enabled : !!request.webhookUrl;\n          debug.log('\uD83D\uDCDD setDiscordWebhook called:', {\n            webhookUrl: request.webhookUrl ? `${request.webhookUrl.substring(0, 50)}...` : '(empty)',\n            enabled,\n            serverName: request.serverName,\n            pairingId: request.pairingId\n          });\n          await setDiscordWebhookSettings(request.webhookUrl, enabled, request.serverName);\n          // Also set the pairing ID for command polling if provided\n          if (request.pairingId) {\n            currentPairingId = request.pairingId;\n            await browserAPI.storage.local.set({\n              currentPairingId: request.pairingId,\n              discordPairingId: request.pairingId\n            });\n            // Subscribe to command realtime\n            subscribeToCommandRealtime(request.pairingId);\n          }\n          // Link Discord user info to auth_tokens if provided\n          if (request.discordUserId && request.discordUserId !== 'null') {\n            await linkDiscordUserToAuthTokens(\n              request.discordUserId,\n              request.discordUsername,\n              request.discordGlobalName\n            );\n          }\n          response = { success: true };\n          break;\n        }\n\n        case 'getDiscordWebhook': {\n          const settings = await getDiscordWebhookSettings();\n\n          // If connected, ensure discord_user_id is linked to auth_tokens\n          if (settings.enabled && settings.webhookUrl) {\n            const stored = await browserAPI.storage.local.get(['discordPairingId']);\n            if (stored.discordPairingId && isSupabaseConfigured()) {\n              try {\n                const pairingResponse = await fetch(\n                  `${SUPABASE_URL}/rest/v1/clouds_pairings?id=eq.${stored.discordPairingId}&select=discord_user_id,discord_username,discord_global_name`,\n                  {\n                    headers: {\n                      'apikey': SUPABASE_ANON_KEY,\n                      'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n                    }\n                  }\n                );\n                if (pairingResponse.ok) {\n                  const pairings = await pairingResponse.json();\n                  if (pairings.length > 0 && pairings[0].discord_user_id) {\n                    // Ensure auth_tokens has all Discord info\n                    await linkDiscordUserToAuthTokens(\n                      pairings[0].discord_user_id,\n                      pairings[0].discord_username,\n                      pairings[0].discord_global_name\n                    );\n                  }\n                }\n              } catch (e) {\n                debug.warn('Could not sync discord_user_id on getDiscordWebhook:', e);\n              }\n            }\n          }\n\n          response = { success: true, ...settings };\n          break;\n        }\n\n        case 'testDiscordWebhook': {\n          // Use the provided URL, or fall back to the stored webhook URL\n          let webhookUrlToTest = request.webhookUrl;\n          if (!webhookUrlToTest) {\n            const settings = await getDiscordWebhookSettings();\n            webhookUrlToTest = settings.webhookUrl;\n          }\n          const testResult = await testDiscordWebhook(webhookUrlToTest);\n          response = testResult;\n          break;\n        }\n\n        case 'getUserCharacters': {\n          // Get user's synced characters from Supabase\n          const characters = await getUserCharactersFromCloud(request.pairingId);\n          response = { success: true, characters };\n          break;\n        }\n\n        case 'requestPairingCodeFromInstaller': {\n          // Request pairing code from native messaging host\n          if (installerPort) {\n            installerPort.postMessage({ type: 'getPairingCode' });\n            response = { success: true, message: 'Pairing code requested from installer' };\n          } else {\n            // Try to connect first\n            const port = await connectToInstaller();\n            if (port) {\n              port.postMessage({ type: 'getPairingCode' });\n              response = { success: true, message: 'Connected and requested pairing code' };\n            } else {\n              response = { success: false, error: 'Could not connect to installer' };\n            }\n          }\n          break;\n        }\n\n        case 'getRealtimeStatus': {\n          // Return current Realtime connection status for debugging\n          const realtimeConnected = commandRealtimeSocket && commandRealtimeSocket.readyState === WebSocket.OPEN;\n          const settings = await browserAPI.storage.local.get(['discordPairingId', 'discordWebhookEnabled']);\n          response = {\n            success: true,\n            realtimeConnected,\n            socketState: commandRealtimeSocket ? commandRealtimeSocket.readyState : null,\n            currentPairingId,\n            storedPairingId: settings.discordPairingId,\n            webhookEnabled: settings.discordWebhookEnabled,\n            supabaseConfigured: isSupabaseConfigured()\n          };\n          debug.log('Realtime status:', response);\n          break;\n        }\n\n        default:\n          debug.warn('Unknown action:', request.action);\n          response = { success: false, error: 'Unknown action: ' + request.action };\n          break;\n      }\n\n      debug.log('Sending response:', response);\n      sendResponse(response);\n    } catch (error) {\n      debug.error('Error handling message:', error);\n      sendResponse({ success: false, error: error.message });\n    }\n  })();\n\n  // Return true to indicate we'll respond asynchronously\n  return true;\n});\n\n/**\n * Clears all existing auth and character data before logging in\n * This ensures a clean state when switching between accounts\n */\nasync function clearExistingAuthData() {\n  debug.log('\uD83E\uDDF9 Clearing existing auth and character data for new login...');\n\n  try {\n    // Clear all auth-related data\n    await new Promise((resolve, reject) => {\n      const keysToRemove = [\n        'diceCloudToken',\n        'diceCloudUserId',\n        'tokenExpires',\n        'username',\n        'characterProfiles',\n        'activeCharacterId',\n        'characterData',\n        'explicitlyLoggedOut'\n      ];\n\n      try {\n        const result = browserAPI.storage.local.remove(keysToRemove);\n        if (result && typeof result.then === 'function') {\n          result.then(resolve).catch(reject);\n        } else {\n          browserAPI.runtime.lastError ? reject(new Error(browserAPI.runtime.lastError.message)) : resolve();\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n\n    debug.log('\u2705 Existing auth data cleared successfully');\n  } catch (error) {\n    debug.error('\u274C Failed to clear existing auth data:', error);\n    // Don't throw - continue with login even if clear fails\n  }\n}\n\n/**\n * Logs in to DiceCloud API with username/password\n * Per DiceCloud API docs: POST https://dicecloud.com/api/login\n * Accepts either username or email with password\n */\nasync function loginToDiceCloud(username, password) {\n  try {\n    // Keep service worker alive during login process\n    keepServiceWorkerAlive(60000); // Keep alive for 1 minute during login\n\n    // Clear any existing auth data first to prevent conflicts when switching accounts\n    await clearExistingAuthData();\n\n    // Try to determine if input is email or username\n    const isEmail = username.includes('@');\n\n    const response = await fetch(`${API_BASE}/login`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(isEmail ? {\n        email: username,\n        password: password\n      } : {\n        username: username,\n        password: password\n      })\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Login failed: ${response.status} - ${errorText}`);\n    }\n\n    const data = await response.json();\n\n    // Store authentication data including token expiry\n    // Use explicit Promise wrapper for Chrome MV3 compatibility\n    await new Promise((resolve, reject) => {\n      const storageData = {\n        diceCloudToken: data.token,\n        diceCloudUserId: data.id,\n        tokenExpires: data.tokenExpires,\n        username: username\n      };\n\n      debug.log('\uD83D\uDCDD Storing auth data:', {\n        hasToken: !!data.token,\n        userId: data.id,\n        username: username\n      });\n\n      try {\n        const result = browserAPI.storage.local.set(storageData);\n\n        // Handle both Promise and callback-based APIs\n        if (result && typeof result.then === 'function') {\n          result.then(resolve).catch(reject);\n        } else {\n          // Callback-based (older Chrome)\n          browserAPI.runtime.lastError ? reject(new Error(browserAPI.runtime.lastError.message)) : resolve();\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n\n    debug.log('Successfully logged in to DiceCloud');\n    debug.log('Token expires:', data.tokenExpires);\n    \n    // Keep alive a bit longer to ensure token is properly stored\n    setTimeout(() => stopKeepAlive(), 5000);\n    \n    return data;\n  } catch (error) {\n    stopKeepAlive();\n    debug.error('Failed to login to DiceCloud:', error);\n    throw error;\n  }\n}\n\n/**\n * Stores the API token (extracted from DiceCloud session or manually entered)\n */\nasync function setApiToken(token, userId = null, tokenExpires = null, username = null) {\n  try {\n    // Keep service worker alive during token storage\n    keepServiceWorkerAlive(30000); // Keep alive for 30 seconds\n\n    debug.log('\uD83D\uDD10 setApiToken called:', {\n      tokenLength: token ? token.length : 0,\n      tokenStart: token ? token.substring(0, 20) + '...' : 'none',\n      userId,\n      tokenExpires,\n      username\n    });\n\n    // Validate token format (basic check)\n    if (!token || token.length < 10) {\n      throw new Error('Invalid API token format');\n    }\n\n    // Clear any existing auth data first to prevent conflicts when switching accounts\n    await clearExistingAuthData();\n\n    // Store the API token with optional metadata\n    const storageData = {\n      diceCloudToken: token,\n      username: username || 'DiceCloud User'\n    };\n\n    if (userId) {\n      storageData.diceCloudUserId = userId;\n    }\n\n    if (tokenExpires) {\n      storageData.tokenExpires = tokenExpires;\n    }\n\n    // Use explicit Promise wrapper for Chrome MV3 compatibility\n    await new Promise((resolve, reject) => {\n      debug.log('\uD83D\uDCDD setApiToken: Storing token data');\n      try {\n        const result = browserAPI.storage.local.set(storageData);\n        if (result && typeof result.then === 'function') {\n          result.then(resolve).catch(reject);\n        } else {\n          browserAPI.runtime.lastError ? reject(new Error(browserAPI.runtime.lastError.message)) : resolve();\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n\n    // Verify the token was stored correctly\n    const verification = await new Promise((resolve, reject) => {\n      try {\n        const result = browserAPI.storage.local.get(['diceCloudToken', 'diceCloudUserId', 'tokenExpires', 'username']);\n        if (result && typeof result.then === 'function') {\n          result.then(resolve).catch(reject);\n        } else {\n          browserAPI.runtime.lastError ? reject(new Error(browserAPI.runtime.lastError.message)) : resolve(result);\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n    debug.log('\u2705 setApiToken verification:', {\n      storedToken: verification.diceCloudToken ? verification.diceCloudToken.substring(0, 20) + '...' : 'none',\n      storedUserId: verification.diceCloudUserId,\n      storedUsername: verification.username,\n      storedExpires: verification.tokenExpires\n    });\n\n    debug.log('Successfully stored API token');\n    \n    // Keep alive a bit longer to ensure token is properly stored\n    setTimeout(() => stopKeepAlive(), 3000);\n    \n    return { success: true };\n  } catch (error) {\n    stopKeepAlive();\n    debug.error('Failed to store API token:', error);\n    throw error;\n  }\n}\n\n/**\n * Gets the stored API token\n * Checks expiry for tokens obtained via username/password login\n */\nasync function getApiToken() {\n  try {\n    const result = await browserAPI.storage.local.get(['diceCloudToken', 'tokenExpires']);\n    \n    debug.log('\uD83D\uDD0D getApiToken called, storage result:', {\n      hasToken: !!result.diceCloudToken,\n      tokenLength: result.diceCloudToken ? result.diceCloudToken.length : 0,\n      tokenStart: result.diceCloudToken ? result.diceCloudToken.substring(0, 20) + '...' : 'none',\n      tokenExpires: result.tokenExpires,\n      allKeys: Object.keys(result)\n    });\n\n    if (!result.diceCloudToken) {\n      debug.warn('\u274C No diceCloudToken found in storage');\n      return null;\n    }\n\n    // Check if token is expired (only if tokenExpires exists - API tokens don't expire)\n    if (result.tokenExpires) {\n      let expiryDate;\n      \n      // Handle different date formats that DiceCloud might send\n      if (typeof result.tokenExpires === 'number') {\n        // Unix timestamp (milliseconds)\n        expiryDate = new Date(result.tokenExpires);\n      } else if (typeof result.tokenExpires === 'string') {\n        // ISO string or other format\n        expiryDate = new Date(result.tokenExpires);\n        // Check if date parsing failed\n        if (isNaN(expiryDate.getTime())) {\n          debug.warn('\u26A0\uFE0F Invalid tokenExpires date format:', result.tokenExpires);\n          // Don't logout, just skip expiry check\n          expiryDate = null;\n        }\n      }\n      \n      const now = new Date();\n      debug.log('\uD83D\uDD0D Token expiry check:', {\n        tokenExpires: result.tokenExpires,\n        expiryDate: expiryDate ? expiryDate.toISOString() : 'invalid',\n        now: now.toISOString(),\n        isExpired: expiryDate ? now >= expiryDate : 'unknown'\n      });\n      \n      if (expiryDate && now >= expiryDate) {\n        debug.warn('\u23F0 API token has expired, logging out');\n        await logout();\n        return null;\n      }\n    }\n\n    debug.log('\u2705 getApiToken returning valid token');\n    return result.diceCloudToken;\n  } catch (error) {\n    debug.error('Failed to retrieve API token:', error);\n    throw error;\n  }\n}\n\n/**\n * Checks if the user is logged in\n * Also validates token expiry for username/password logins\n */\nasync function checkLoginStatus() {\n  try {\n    const result = await browserAPI.storage.local.get(['diceCloudToken', 'username', 'tokenExpires', 'diceCloudUserId']);\n    \n    debug.log('\uD83D\uDD0D checkLoginStatus called, storage result:', {\n      hasToken: !!result.diceCloudToken,\n      tokenLength: result.diceCloudToken ? result.diceCloudToken.length : 0,\n      tokenStart: result.diceCloudToken ? result.diceCloudToken.substring(0, 20) + '...' : 'none',\n      username: result.username,\n      diceCloudUserId: result.diceCloudUserId,\n      tokenExpires: result.tokenExpires,\n      allKeys: Object.keys(result)\n    });\n\n    if (!result.diceCloudToken) {\n      debug.warn('\u274C checkLoginStatus: No diceCloudToken found');\n      return { loggedIn: false };\n    }\n\n    // Check if token is expired (only if tokenExpires exists - API tokens don't expire)\n    if (result.tokenExpires) {\n      let expiryDate;\n      \n      // Handle different date formats that DiceCloud might send\n      if (typeof result.tokenExpires === 'number') {\n        // Unix timestamp (milliseconds)\n        expiryDate = new Date(result.tokenExpires);\n      } else if (typeof result.tokenExpires === 'string') {\n        // ISO string or other format\n        expiryDate = new Date(result.tokenExpires);\n        // Check if date parsing failed\n        if (isNaN(expiryDate.getTime())) {\n          debug.warn('\u26A0\uFE0F Invalid tokenExpires date format in checkLoginStatus:', result.tokenExpires);\n          // Don't logout, just skip expiry check\n          expiryDate = null;\n        }\n      }\n      \n      const now = new Date();\n      debug.log('\uD83D\uDD0D Login status expiry check:', {\n        tokenExpires: result.tokenExpires,\n        expiryDate: expiryDate ? expiryDate.toISOString() : 'invalid',\n        now: now.toISOString(),\n        isExpired: expiryDate ? now >= expiryDate : 'unknown'\n      });\n      \n      if (expiryDate && now >= expiryDate) {\n        debug.warn('\u23F0 Session expired - please login again');\n        await logout();\n        return { loggedIn: false };\n      }\n    }\n\n    debug.log('\u2705 checkLoginStatus: User is logged in');\n    return {\n      loggedIn: true,\n      username: result.username || 'DiceCloud User',\n      userId: result.diceCloudUserId || null\n    };\n  } catch (error) {\n    debug.error('Failed to check login status:', error);\n    throw error;\n  }\n}\n\n/**\n * Logs out (clears authentication data)\n */\nasync function logout() {\n  try {\n    debug.warn('\uD83D\uDEAA logout() called - getting current storage state...');\n\n    // Get current state before clearing - use Promise wrapper\n    const currentState = await new Promise((resolve, reject) => {\n      try {\n        const result = browserAPI.storage.local.get(['diceCloudToken', 'diceCloudUserId', 'tokenExpires', 'username', 'explicitlyLoggedOut']);\n        if (result && typeof result.then === 'function') {\n          result.then(resolve).catch(reject);\n        } else {\n          browserAPI.runtime.lastError ? reject(new Error(browserAPI.runtime.lastError.message)) : resolve(result);\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n\n    debug.log('\uD83D\uDD0D Current storage before logout:', {\n      hasToken: !!currentState.diceCloudToken,\n      tokenLength: currentState.diceCloudToken ? currentState.diceCloudToken.length : 0,\n      username: currentState.username,\n      diceCloudUserId: currentState.diceCloudUserId,\n      tokenExpires: currentState.tokenExpires,\n      explicitlyLoggedOut: currentState.explicitlyLoggedOut\n    });\n\n    // Set flag first to prevent autoRefreshToken from re-saving the token\n    await new Promise((resolve, reject) => {\n      debug.log('\uD83D\uDCDD logout: Setting explicitlyLoggedOut flag');\n      try {\n        const result = browserAPI.storage.local.set({ explicitlyLoggedOut: true });\n        if (result && typeof result.then === 'function') {\n          result.then(resolve).catch(reject);\n        } else {\n          browserAPI.runtime.lastError ? reject(new Error(browserAPI.runtime.lastError.message)) : resolve();\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n\n    // Remove all auth data\n    await new Promise((resolve, reject) => {\n      debug.log('\uD83D\uDDD1\uFE0F logout: Removing auth tokens');\n      try {\n        const result = browserAPI.storage.local.remove(['diceCloudToken', 'diceCloudUserId', 'tokenExpires', 'username']);\n        if (result && typeof result.then === 'function') {\n          result.then(resolve).catch(reject);\n        } else {\n          browserAPI.runtime.lastError ? reject(new Error(browserAPI.runtime.lastError.message)) : resolve();\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n\n    // Also delete token from Supabase database to prevent auto-restore\n    try {\n      if (typeof SupabaseTokenManager !== 'undefined') {\n        debug.log('\uD83D\uDDD1\uFE0F logout: Removing auth token from Supabase database');\n        const tokenManager = new SupabaseTokenManager();\n        await tokenManager.deleteToken();\n        debug.log('\u2705 logout: Token removed from Supabase');\n      }\n    } catch (dbError) {\n      debug.warn('\u26A0\uFE0F logout: Failed to delete token from Supabase (non-fatal):', dbError.message);\n    }\n\n    debug.warn('\uD83D\uDEAA logout() completed - storage cleared');\n  } catch (error) {\n    debug.error('Failed to logout:', error);\n    throw error;\n  }\n}\n\n/**\n * Stores character data in browserAPI.storage (supports multiple profiles)\n * @param {Object} characterData - Character data to store\n * @param {string} slotId - Optional slot ID (e.g., 'slot-1'). If not provided, uses characterId from data.\n */\nasync function storeCharacterData(characterData, slotId) {\n  try {\n    // Normalize field names: database uses character_name, DiceCloud uses name\n    // Ensure 'name' field exists for consistent display\n    if (characterData.character_name && !characterData.name) {\n      characterData.name = characterData.character_name;\n    }\n\n    // Tag the character with the current DiceCloud user ID for ownership filtering.\n    // This prevents characters viewed on other users' pages from leaking into the\n    // current user's character list.\n    if (!characterData.ownerUserId) {\n      try {\n        const stored = await browserAPI.storage.local.get(['diceCloudUserId']);\n        if (stored.diceCloudUserId) {\n          characterData.ownerUserId = stored.diceCloudUserId;\n        }\n      } catch (e) {\n        debug.warn('Could not retrieve DiceCloud user ID for ownership tagging:', e);\n      }\n    }\n\n    // Use slotId if provided, otherwise fall back to character ID from the data\n    const storageId = slotId || characterData.id || characterData._id || 'default';\n\n    // --- Ensure armorClass is populated for local saves ---\n    try {\n      // Try to extract armor class from common locations in the raw payload\n      const extractArmor = (obj) => {\n        if (!obj || typeof obj !== 'object') return null;\n        if (typeof obj.armorClass === 'number') return obj.armorClass;\n        if (typeof obj.armor_class === 'number') return obj.armor_class;\n        if (obj.ac && typeof obj.ac === 'object') {\n          if (typeof obj.ac.base === 'number') return obj.ac.base;\n          if (typeof obj.ac.total === 'number') return obj.ac.total;\n        }\n        if (obj.defenses && typeof obj.defenses === 'object') {\n          if (typeof obj.defenses.armor_class === 'number') return obj.defenses.armor_class;\n          if (typeof obj.defenses.armorClass === 'number') return obj.defenses.armorClass;\n        }\n        return null;\n      };\n\n      let candidate = null;\n      if (characterData && characterData.raw_dicecloud_data) candidate = characterData.raw_dicecloud_data;\n      else if (characterData && characterData._fullData && characterData._fullData.raw_dicecloud_data) candidate = characterData._fullData.raw_dicecloud_data;\n      else if (characterData && characterData._fullData) candidate = characterData._fullData;\n\n      // Unwrap nested wrappers\n      const seenLocal = new Set();\n      while (candidate && typeof candidate === 'object' && candidate.raw_dicecloud_data && !seenLocal.has(candidate)) {\n        seenLocal.add(candidate);\n        candidate = candidate.raw_dicecloud_data;\n      }\n\n      const acFromRaw = extractArmor(candidate);\n      if (typeof acFromRaw === 'number') {\n        characterData.armorClass = acFromRaw;\n      } else if (!characterData.armorClass && characterData.ac && typeof characterData.ac === 'number') {\n        characterData.armorClass = characterData.ac;\n      }\n    } catch (e) {\n      debug.warn('\u26A0\uFE0F Failed to derive armorClass for local save:', e && e.message ? e.message : e);\n    }\n\n    // Get existing profiles\n    const result = await browserAPI.storage.local.get(['characterProfiles', 'activeCharacterId']);\n    const characterProfiles = result.characterProfiles || {};\n\n    // Deduplication: Check if this character already exists in a different slot\n    // If it does, delete it from the old slot before saving to the new slot\n    const characterId = characterData.id || characterData._id;\n    if (characterId) {\n      for (const [existingSlotId, existingProfile] of Object.entries(characterProfiles)) {\n        // Skip if it's the same slot we're saving to\n        if (existingSlotId === storageId) continue;\n\n        // Check if the existing profile has the same character ID\n        const existingId = existingProfile.id || existingProfile._id;\n        if (existingId === characterId) {\n          debug.log(`\uD83D\uDD04 Deduplicating character: \"${characterData.name}\" found in ${existingSlotId}, removing before saving to ${storageId}`);\n          delete characterProfiles[existingSlotId];\n          break; // Only one duplicate should exist\n        }\n      }\n    }\n\n    // SPECIAL CASE: Preserve notification color from existing profile\n    // When syncing from DiceCloud, the character data may not include notificationColor\n    // or may have a default color. Preserve the user's chosen color if it exists.\n    const existingProfile = characterProfiles[storageId];\n    if (existingProfile && existingProfile.notificationColor) {\n      // Only preserve if the new data doesn't have a color, or has the default color\n      if (!characterData.notificationColor || characterData.notificationColor === '#3498db') {\n        debug.log(`\uD83C\uDFA8 Preserving existing notification color: ${existingProfile.notificationColor}`);\n        characterData.notificationColor = existingProfile.notificationColor;\n      }\n    }\n\n    // Store this character's data EXACTLY as received (now includes ownerUserId)\n    characterProfiles[storageId] = characterData;\n\n    // Only update activeCharacterId if slotId was explicitly provided\n    // This prevents the \"default\" storage from overriding a specific slot selection\n    const updates = {\n      characterProfiles: characterProfiles,\n      timestamp: Date.now()\n    };\n\n    // Only set activeCharacterId if there's no active character currently\n    // This prevents character data updates from overwriting user's character selection\n    if (!result.activeCharacterId) {\n      updates.activeCharacterId = storageId;\n      debug.log(`Setting active character to: ${storageId}`);\n    } else {\n      debug.log(`Keeping existing active character: ${result.activeCharacterId}`);\n    }\n\n    await browserAPI.storage.local.set(updates);\n\n    debug.log(`Character data stored successfully for ID: ${storageId}`, characterData);\n  } catch (error) {\n    debug.error('Failed to store character data:', error);\n    throw error;\n  }\n}\n\n/**\n * Retrieves character data from browserAPI.storage\n * If characterId is provided, returns that specific character\n * Otherwise returns the active character\n */\nasync function getCharacterData(characterId = null) {\n  try {\n    const result = await browserAPI.storage.local.get(['characterProfiles', 'activeCharacterId', 'characterData']);\n\n    // Migration: if old single characterData exists, migrate it\n    if (result.characterData && !result.characterProfiles) {\n      debug.log('Migrating old single character data to profiles...');\n      const charId = result.characterData.characterId || result.characterData._id || 'default';\n      const characterProfiles = {};\n      characterProfiles[charId] = result.characterData;\n\n      await browserAPI.storage.local.set({\n        characterProfiles: characterProfiles,\n        activeCharacterId: charId\n      });\n\n      // Remove old storage\n      await browserAPI.storage.local.remove('characterData');\n\n      return result.characterData;\n    }\n\n    // Get character profiles\n    const characterProfiles = result.characterProfiles || {};\n\n    // Helper function to extract full character data from database profiles\n    const extractFullData = (characterData) => {\n      if (!characterData) return null;\n\n      // For database profiles, extract full character data from _fullData.raw_dicecloud_data\n      if (characterData.source === 'database' && characterData._fullData) {\n        const fullData = characterData._fullData.raw_dicecloud_data;\n        if (fullData && typeof fullData === 'object') {\n          debug.log('\uD83D\uDCE6 Extracting full character data from database raw_dicecloud_data');\n          // Merge the full data with metadata\n          return {\n            ...fullData,\n            source: 'database',\n            lastUpdated: characterData.lastUpdated || characterData._fullData.updated_at,\n            notificationColor: characterData._fullData.notification_color || fullData.notificationColor\n          };\n        } else {\n          debug.warn('\u26A0\uFE0F Database profile missing raw_dicecloud_data, using summary only');\n        }\n      }\n\n      // For local profiles or database profiles without nested data, return as-is\n      return characterData;\n    };\n\n    // If specific character ID requested, return it\n    if (characterId) {\n      const characterData = characterProfiles[characterId] || null;\n      return extractFullData(characterData);\n    }\n\n    // Otherwise return active character\n    const activeCharacterId = result.activeCharacterId;\n    debug.log(`\uD83C\uDFAF Getting active character: activeCharacterId=\"${activeCharacterId}\"`);\n    debug.log(`\uD83C\uDFAF Available characters:`, Object.keys(characterProfiles));\n\n    if (activeCharacterId && characterProfiles[activeCharacterId]) {\n      const activeChar = characterProfiles[activeCharacterId];\n      debug.log('\u2705 Retrieved active character data:', {\n        id: activeCharacterId,\n        name: activeChar.name || activeChar.character_name,\n        class: activeChar.class,\n        level: activeChar.level\n      });\n      return extractFullData(activeChar);\n    }\n\n    // Fallback: If activeCharacterId is a raw DiceCloud ID, search for a matching profile\n    // by checking the character's ID fields (prioritize local profiles over database)\n    if (activeCharacterId) {\n      debug.log(`\uD83D\uDD0D Active character not found by key, searching by ID: ${activeCharacterId}`);\n\n      // Check local profiles first (they have full actions/spells data)\n      for (const [key, profile] of Object.entries(characterProfiles)) {\n        if (profile.source !== 'database') {\n          const charId = profile.id || profile._id || profile.dicecloud_character_id || profile.characterId;\n          if (charId === activeCharacterId) {\n            debug.log(`\u2705 Found matching local profile by ID: ${key}`);\n            return extractFullData(profile);\n          }\n        }\n      }\n\n      // Then check database profiles if no local match found\n      for (const [key, profile] of Object.entries(characterProfiles)) {\n        if (profile.source === 'database') {\n          const charId = profile.id || profile._id || profile.dicecloud_character_id || profile.characterId;\n          if (charId === activeCharacterId) {\n            debug.log(`\u2705 Found matching database profile by ID: ${key}`);\n            return extractFullData(profile);\n          }\n        }\n      }\n\n      debug.warn(`\u26A0\uFE0F No profile found matching activeCharacterId: ${activeCharacterId}`);\n    }\n\n    // Fallback: return first available character (prefer local over database)\n    const characterIds = Object.keys(characterProfiles);\n    if (characterIds.length > 0) {\n      // Prefer local profiles over database profiles\n      const localProfile = characterIds.find(key => {\n        const profile = characterProfiles[key];\n        return !profile.source || profile.source !== 'database';\n      });\n\n      if (localProfile) {\n        debug.log('No active character found, returning first local profile:', characterProfiles[localProfile]);\n        return extractFullData(characterProfiles[localProfile]);\n      }\n\n      debug.log('No active character, returning first available:', characterProfiles[characterIds[0]]);\n      return extractFullData(characterProfiles[characterIds[0]]);\n    }\n\n    return null;\n  } catch (error) {\n    debug.error('Failed to retrieve character data:', error);\n    throw error;\n  }\n}\n\n/**\n * Gets all character profiles from both local storage and database.\n * Deduplicates by DiceCloud character ID and filters out characters\n * that don't belong to the current user.\n */\nasync function getAllCharacterProfiles() {\n  try {\n    // Get local profiles first\n    const localResult = await browserAPI.storage.local.get(['characterProfiles']);\n    const localProfiles = localResult.characterProfiles || {};\n\n    // Normalize local profiles: ensure 'name' field exists (database uses character_name)\n    for (const id of Object.keys(localProfiles)) {\n      const profile = localProfiles[id];\n      if (profile.character_name && !profile.name) {\n        profile.name = profile.character_name;\n      }\n    }\n\n    // Try to get database characters and the current user's DiceCloud ID\n    let databaseCharacters = {};\n    let currentDicecloudUserId = null;\n    try {\n      if (typeof SupabaseTokenManager !== 'undefined') {\n        const supabase = new SupabaseTokenManager();\n\n        // Prefer local cached token/user when available to avoid hitting Supabase every popup open\n        try {\n          const stored = await browserAPI.storage.local.get(['diceCloudToken', 'diceCloudUserId', 'tokenExpires']);\n          if (stored.diceCloudToken && stored.diceCloudUserId) {\n            let useStored = true;\n            if (stored.tokenExpires) {\n              const expiry = new Date(stored.tokenExpires);\n              if (isNaN(expiry.getTime()) || expiry <= new Date()) {\n                useStored = false;\n              }\n            }\n            if (useStored) {\n              currentDicecloudUserId = stored.diceCloudUserId;\n              debug.log('\uD83C\uDF10 Using cached DiceCloud user from storage:', currentDicecloudUserId);\n            } else {\n              debug.log('\uD83D\uDD01 Cached token expired or invalid, falling back to Supabase lookup');\n            }\n          }\n        } catch (e) {\n          debug.warn('\u26A0\uFE0F Error reading stored token:', e);\n        }\n\n        // If we don't have a valid cached user ID, retrieve from Supabase\n        if (!currentDicecloudUserId) {\n          const tokenResult = await supabase.retrieveToken();\n          if (tokenResult.success && tokenResult.userId) {\n            currentDicecloudUserId = tokenResult.userId;\n            debug.log('\uD83C\uDF10 Fetching database characters for DiceCloud user:', currentDicecloudUserId);\n          }\n        }\n\n        if (currentDicecloudUserId) {\n          // Get all characters for this user from database\n          const response = await fetch(\n            `${supabase.supabaseUrl}/rest/v1/clouds_characters?user_id_dicecloud=eq.${currentDicecloudUserId}&select=*`,\n            {\n              headers: {\n                'apikey': supabase.supabaseKey,\n                'Authorization': `Bearer ${supabase.supabaseKey}`\n              }\n            }\n          );\n\n          if (response.ok) {\n            const characters = await response.json();\n            debug.log(`\uD83D\uDCE6 Found ${characters.length} characters in database`);\n\n            // Convert database characters to profile format\n            characters.forEach(character => {\n              const slotId = `db-${character.dicecloud_character_id}`;\n              databaseCharacters[slotId] = {\n                name: character.character_name,\n                id: character.dicecloud_character_id,\n                source: 'database',\n                lastUpdated: character.updated_at,\n                race: character.race,\n                class: character.class,\n                level: character.level,\n                // Store full character data for loading\n                _fullData: character\n              };\n            });\n          } else {\n            debug.warn('\u26A0\uFE0F Failed to fetch database characters:', response.status);\n          }\n        }\n      }\n    } catch (dbError) {\n      debug.warn('\u26A0\uFE0F Failed to load database characters:', dbError);\n      // Continue with local profiles only\n    }\n\n    // Also try to get the current DiceCloud user ID from local storage if\n    // the Supabase lookup didn't provide one (e.g. offline / not configured)\n    if (!currentDicecloudUserId) {\n      try {\n        const stored = await browserAPI.storage.local.get(['diceCloudUserId']);\n        currentDicecloudUserId = stored.diceCloudUserId || null;\n      } catch (e) {\n        // ignore\n      }\n    }\n\n    // Filter local profiles: remove characters belonging to a different user.\n    // Character data may store the owner's DiceCloud user ID under several\n    // possible field names depending on the code path that created it.\n    // If ANY of them is set and doesn't match the current user, drop it.\n    if (currentDicecloudUserId) {\n      for (const key of Object.keys(localProfiles)) {\n        const profile = localProfiles[key];\n        const profileOwner = profile.ownerUserId\n          || profile.dicecloudUserId\n          || profile.userId\n          || profile.user_id_dicecloud\n          || null;\n        if (profileOwner && profileOwner !== currentDicecloudUserId) {\n          debug.log(`\uD83D\uDEAB Filtering out character \"${profile.name || profile.character_name}\" (belongs to ${profileOwner}, current user is ${currentDicecloudUserId})`);\n          delete localProfiles[key];\n        }\n      }\n    }\n\n    // --- Deduplication ---\n    // Merge local and database profiles, keeping only one entry per unique\n    // character. Local entries take precedence over database ones.\n    //\n    // We use two dedup strategies:\n    //  1. By DiceCloud character ID (checking multiple possible field names)\n    //  2. By display fingerprint (name + class + level) as a fallback for\n    //     entries where the ID field is missing or stored under a different key\n    const seenCharacterIds = new Map();    // charId -> storage key\n    const seenFingerprints = new Map();     // \"Name|Class|Level\" -> storage key\n    const mergedProfiles = {};\n\n    // Extract the DiceCloud character ID from a profile, checking all known fields\n    function getCharId(profile) {\n      return profile.id || profile._id || profile.dicecloud_character_id || profile.characterId || null;\n    }\n\n    // Build a display fingerprint for fallback dedup\n    function getFingerprint(profile) {\n      const name = (profile.name || profile.character_name || '').trim().toLowerCase();\n      const cls = (profile.class || '').trim().toLowerCase();\n      const level = String(profile.level || '');\n      return name ? `${name}|${cls}|${level}` : null;\n    }\n\n    // Returns true if this profile is a duplicate of one already seen\n    function isDuplicate(profile, key) {\n      const charId = getCharId(profile);\n      if (charId && seenCharacterIds.has(charId)) {\n        debug.log(`\uD83D\uDD04 Skipping duplicate \"${profile.name || profile.character_name}\" (key: ${key}), same char ID as: ${seenCharacterIds.get(charId)}`);\n        return true;\n      }\n      const fp = getFingerprint(profile);\n      if (fp && seenFingerprints.has(fp)) {\n        debug.log(`\uD83D\uDD04 Skipping duplicate \"${profile.name || profile.character_name}\" (key: ${key}), same fingerprint as: ${seenFingerprints.get(fp)}`);\n        return true;\n      }\n      return false;\n    }\n\n    // Mark a profile as seen\n    function markSeen(profile, key) {\n      const charId = getCharId(profile);\n      if (charId) seenCharacterIds.set(charId, key);\n      const fp = getFingerprint(profile);\n      if (fp) seenFingerprints.set(fp, key);\n    }\n\n    // Build a lookup of database characters by ID and fingerprint for marking local profiles\n    const dbCharactersByCharId = new Map();\n    const dbCharactersByFingerprint = new Map();\n    for (const [key, profile] of Object.entries(databaseCharacters)) {\n      const charId = getCharId(profile);\n      const fp = getFingerprint(profile);\n      if (charId) dbCharactersByCharId.set(charId, { key, profile });\n      if (fp) dbCharactersByFingerprint.set(fp, { key, profile });\n    }\n\n    // Process local profiles first (local saves have priority)\n    for (const [key, profile] of Object.entries(localProfiles)) {\n      const fp = getFingerprint(profile);\n      const charId = getCharId(profile);\n\n      const existingById = charId ? seenCharacterIds.get(charId) : null;\n      const existingByFp = fp ? seenFingerprints.get(fp) : null;\n\n      // Check if this local profile has a database counterpart\n      const dbMatch = (charId && dbCharactersByCharId.get(charId)) ||\n                      (fp && dbCharactersByFingerprint.get(fp));\n      if (dbMatch) {\n        // Mark this local profile as having a cloud version\n        profile.source = 'database';\n        profile.hasCloudVersion = true;\n        profile.cloudSlotId = dbMatch.key;\n        debug.log(`\u2601\uFE0F Local profile \"${profile.name || profile.character_name}\" has cloud version, marking as database source`);\n\n        // SPECIAL CASE: Always prefer database notification color over local\n        // This ensures color changes sync across devices\n        if (dbMatch.profile.notificationColor || dbMatch.profile.notification_color) {\n          const dbColor = dbMatch.profile.notificationColor || dbMatch.profile.notification_color;\n          if (profile.notificationColor !== dbColor) {\n            debug.log(`\uD83C\uDFA8 Updating local profile color from database: ${profile.notificationColor} -> ${dbColor}`);\n            profile.notificationColor = dbColor;\n          }\n        }\n      }\n\n      // If there's an existing entry with the same character ID, decide\n      // whether to replace it. Prefer local `slot-` keys over DB keys.\n      if (existingById) {\n        if (key.startsWith('slot-') && existingById.startsWith('db-')) {\n          delete mergedProfiles[existingById];\n          markSeen(profile, key);\n          mergedProfiles[key] = profile;\n        } else {\n          debug.log(`\uD83D\uDD04 Skipping duplicate \"${profile.name || profile.character_name}\" (key: ${key}), same char ID as: ${existingById}`);\n        }\n        continue;\n      }\n\n      // If there's an existing fingerprint match, prefer local slot keys\n      // over non-slot keys. If neither is a slot key, keep the first seen.\n      if (existingByFp) {\n        if (key.startsWith('slot-') && !existingByFp.startsWith('slot-')) {\n          delete mergedProfiles[existingByFp];\n          markSeen(profile, key);\n          mergedProfiles[key] = profile;\n        } else {\n          debug.log(`\uD83D\uDD04 Skipping duplicate \"${profile.name || profile.character_name}\" (key: ${key}), same fingerprint as: ${existingByFp}`);\n        }\n        continue;\n      }\n\n      // Otherwise mark and add\n      markSeen(profile, key);\n      mergedProfiles[key] = profile;\n    }\n\n    // Then add database characters only if not already present\n    for (const [key, profile] of Object.entries(databaseCharacters)) {\n      if (!isDuplicate(profile, key)) {\n        markSeen(profile, key);\n        mergedProfiles[key] = profile;\n      } else {\n        debug.log(`\uD83D\uDD12 Skipping database character ${key} because a local version exists (but marked with cloud source)`);\n      }\n    }\n\n    debug.log('\uD83D\uDCCB Character profiles loaded:', {\n      local: Object.keys(localProfiles).length,\n      database: Object.keys(databaseCharacters).length,\n      deduplicated: Object.keys(mergedProfiles).length\n    });\n\n    return mergedProfiles;\n  } catch (error) {\n    debug.error('Failed to retrieve character profiles:', error);\n    throw error;\n  }\n}\n\n/**\n * Get character data from database by character ID\n */\nasync function getCharacterDataFromDatabase(characterId) {\n  try {\n    if (typeof SupabaseTokenManager === 'undefined') {\n      throw new Error('SupabaseTokenManager not available');\n    }\n\n    const supabase = new SupabaseTokenManager();\n\n    // Scope the query to the current user so we never load another user's character\n    let userFilter = '';\n    try {\n      // Prefer local cached user id when available to avoid extra Supabase calls\n      try {\n        const stored = await browserAPI.storage.local.get(['diceCloudUserId', 'diceCloudToken', 'tokenExpires']);\n        if (stored.diceCloudUserId && stored.diceCloudToken) {\n          let useStored = true;\n          if (stored.tokenExpires) {\n            const expiry = new Date(stored.tokenExpires);\n            if (isNaN(expiry.getTime()) || expiry <= new Date()) {\n              useStored = false;\n            }\n          }\n          if (useStored) {\n            userFilter = `&user_id_dicecloud=eq.${stored.diceCloudUserId}`;\n            debug.log('\uD83C\uDF10 Using cached DiceCloud user for DB query:', stored.diceCloudUserId);\n          }\n        }\n      } catch (e) {\n        debug.warn('\u26A0\uFE0F Error reading stored user for DB query:', e);\n      }\n\n      if (!userFilter) {\n        const tokenResult = await supabase.retrieveToken();\n        if (tokenResult.success && tokenResult.userId) {\n          userFilter = `&user_id_dicecloud=eq.${tokenResult.userId}`;\n        }\n      }\n    } catch (e) {\n      debug.warn('Could not get user ID for database character query:', e);\n    }\n\n    // Try multiple lookup strategies so callers can pass either a DiceCloud ID,\n    // a storage key, or a DB primary key. Query order: exact dicecloud_character_id,\n    // dicecloud_character_id prefixed with/without `db-`, then primary `id`.\n    const tryQuery = async (field, value) => {\n      const url = `${supabase.supabaseUrl}/rest/v1/clouds_characters?${field}=eq.${encodeURIComponent(value)}${userFilter}&select=*&order=updated_at.desc&limit=1`;\n      const resp = await fetch(url, {\n        headers: {\n          'apikey': supabase.supabaseKey,\n          'Authorization': `Bearer ${supabase.supabaseKey}`\n        }\n      });\n      if (!resp.ok) return null;\n      const arr = await resp.json();\n      return (arr && arr.length > 0) ? arr[0] : null;\n    };\n\n    let dbCharacter = null;\n\n    // 1) Try as dicecloud_character_id exactly\n    dbCharacter = await tryQuery('dicecloud_character_id', characterId);\n\n    // 2) If not found, try adding/removing a leading `db-` prefix\n    if (!dbCharacter) {\n      if (characterId && characterId.startsWith('db-')) {\n        dbCharacter = await tryQuery('dicecloud_character_id', characterId.replace(/^db-/, ''));\n      } else {\n        dbCharacter = await tryQuery('dicecloud_character_id', `db-${characterId}`);\n      }\n    }\n\n    // 3) If still not found, query by primary `id` (some callers pass DB PK)\n    if (!dbCharacter) {\n      dbCharacter = await tryQuery('id', characterId);\n    }\n\n    if (!dbCharacter) {\n      throw new Error('Character not found in database');\n    }\n\n    // If raw_dicecloud_data contains the full character object, prefer it.\n    // Also defensively unwrap any nested DB wrappers and normalize IDs.\n    let rawData = dbCharacter.raw_dicecloud_data || dbCharacter._fullData || null;\n\n    // Handle raw_dicecloud_data being a JSON string (Supabase may return JSONB as string in some cases)\n    if (rawData && typeof rawData === 'string') {\n      try {\n        rawData = JSON.parse(rawData);\n        debug.log('\uD83D\uDCE6 Parsed raw_dicecloud_data from JSON string');\n      } catch (parseError) {\n        debug.warn('\u26A0\uFE0F raw_dicecloud_data is a string but not valid JSON:', parseError.message);\n        rawData = null;\n      }\n    }\n\n    // DEBUG: Check what data was actually returned from Supabase\n    debug.log('\uD83D\uDD0D POST-RETRIEVE: raw_dicecloud_data from Supabase:', {\n      hasRawData: !!rawData,\n      rawDataType: typeof rawData,\n      rawDataIsArray: Array.isArray(rawData),\n      hasSpells: !!(rawData && rawData.spells),\n      spellsIsArray: Array.isArray(rawData?.spells),\n      spellsLength: rawData?.spells?.length,\n      hasActions: !!(rawData && rawData.actions),\n      actionsIsArray: Array.isArray(rawData?.actions),\n      actionsLength: rawData?.actions?.length,\n      topLevelKeys: rawData ? Object.keys(rawData).slice(0, 30) : []\n    });\n\n    if (rawData && typeof rawData === 'object' && !Array.isArray(rawData)) {\n      // Defensive unwrap: if rawData itself contains `raw_dicecloud_data`, drill down\n      let candidate = rawData;\n      const seen = new Set();\n      while (candidate && typeof candidate === 'object' && candidate.raw_dicecloud_data && !seen.has(candidate)) {\n        seen.add(candidate);\n        candidate = candidate.raw_dicecloud_data;\n      }\n\n      // If candidate.id looks like a DB-wrapped id (db-...), try to recover an original id\n      if (candidate && typeof candidate.id === 'string' && candidate.id.startsWith('db-')) {\n        if (candidate._id && typeof candidate._id === 'string' && !candidate._id.startsWith('db-')) {\n          candidate.id = candidate._id;\n        } else if (candidate.raw_dicecloud_data && candidate.raw_dicecloud_data.id && !candidate.raw_dicecloud_data.id.startsWith('db-')) {\n          candidate.id = candidate.raw_dicecloud_data.id;\n        }\n      }\n\n      const fullCharacter = candidate;\n      // Add database metadata\n      fullCharacter.source = 'database';\n      fullCharacter.lastUpdated = dbCharacter.updated_at;\n      // Ensure ID fields are set correctly (in case of older records)\n      if (!fullCharacter.id) {\n        fullCharacter.id = dbCharacter.dicecloud_character_id;\n      }\n      if (!fullCharacter.name) {\n        fullCharacter.name = dbCharacter.character_name;\n      }\n      // Restore notification color from database\n      if (dbCharacter.notification_color) {\n        fullCharacter.notificationColor = dbCharacter.notification_color;\n      }\n\n      // DEBUG: Check if spells and actions are present\n      debug.log('\uD83D\uDD0D Database character data check:', {\n        name: fullCharacter.name,\n        hasSpells: !!fullCharacter.spells,\n        spellsIsArray: Array.isArray(fullCharacter.spells),\n        spellsLength: fullCharacter.spells?.length,\n        hasActions: !!fullCharacter.actions,\n        actionsIsArray: Array.isArray(fullCharacter.actions),\n        actionsLength: fullCharacter.actions?.length,\n        topLevelKeys: Object.keys(fullCharacter).slice(0, 30)\n      });\n      // Add a compact preview of the parsed raw data for debugging\n      try {\n        const keys = Object.keys(fullCharacter || {}).slice(0, 50);\n        let sample = '';\n        try {\n          sample = JSON.stringify(fullCharacter, keys);\n        } catch (e) {\n          sample = '[unserializable fullCharacter]';\n        }\n        debug.log('\u2705 Loaded full character from database raw_dicecloud_data:', fullCharacter.name, {\n          keys: keys,\n          sample: sample && sample.slice ? sample.slice(0, 2000) : sample,\n          lastUpdated: fullCharacter.lastUpdated\n        });\n      } catch (e) {\n        debug.log('\u2705 Loaded full character from database raw_dicecloud_data:', fullCharacter.name);\n      }\n      return fullCharacter;\n    }\n\n    // Fallback: Return database record with minimal transformation\n    // This should rarely be used since raw_dicecloud_data should always be present\n    debug.warn('\u26A0\uFE0F No raw_dicecloud_data found (type:', typeof rawData, '), using database fields directly');\n    debug.warn('\u26A0\uFE0F DB record keys:', Object.keys(dbCharacter));\n    const characterData = {\n      // Use the exact database field names to maintain consistency\n      id: dbCharacter.dicecloud_character_id,\n      name: dbCharacter.character_name,\n      race: dbCharacter.race,\n      class: dbCharacter.class,\n      level: dbCharacter.level,\n      alignment: dbCharacter.alignment,\n      hitPoints: dbCharacter.hit_points,\n      hitDice: dbCharacter.hit_dice,\n      temporaryHP: dbCharacter.temporary_hp,\n      deathSaves: dbCharacter.death_saves,\n      inspiration: dbCharacter.inspiration,\n      armorClass: dbCharacter.armor_class,\n      speed: dbCharacter.speed,\n      initiative: dbCharacter.initiative,\n      proficiencyBonus: dbCharacter.proficiency_bonus,\n      attributes: dbCharacter.attributes,\n      attributeMods: dbCharacter.attribute_mods,\n      saves: dbCharacter.saves,\n      skills: dbCharacter.skills,\n      spellSlots: dbCharacter.spell_slots,\n      resources: dbCharacter.resources,\n      conditions: dbCharacter.conditions,\n      notificationColor: dbCharacter.notification_color,\n      // Preserve the raw database record for debugging\n      rawDiceCloudData: dbCharacter,\n      source: 'database',\n      lastUpdated: dbCharacter.updated_at\n    };\n\n    debug.log('\u2705 Loaded character from database (individual fields):', characterData.name);\n    return characterData;\n  } catch (error) {\n    debug.error('\u274C Failed to get character data from database:', error);\n    throw error;\n  }\n}\n\n/**\n * Sets the active character\n */\nasync function setActiveCharacter(characterId) {\n  try {\n    // Get character data before setting for logging\n    const result = await browserAPI.storage.local.get(['characterProfiles']);\n    const characterProfiles = result.characterProfiles || {};\n    const characterData = characterProfiles[characterId];\n    \n    debug.log(`\uD83C\uDFAF Setting active character: ${characterId}`);\n    debug.log(`\uD83C\uDFAF Character data:`, characterData ? {\n      name: characterData.name || characterData.character_name,\n      class: characterData.class,\n      level: characterData.level\n    } : 'NOT FOUND');\n\n    await browserAPI.storage.local.set({\n      activeCharacterId: characterId\n    });\n    debug.log(`\u2705 Active character set to: ${characterId}`);\n\n    // Also mark this character as active in Supabase\n    if (characterData && characterData.id) {\n      try {\n        await markCharacterActiveInSupabase(characterData.id, characterData.name || characterData.character_name);\n      } catch (error) {\n        debug.warn('\u26A0\uFE0F Failed to mark character as active in Supabase:', error);\n      }\n    }\n\n    // Notify Owlbear content script if on Owlbear page\n    try {\n      const tabs = await browserAPI.tabs.query({ url: 'https://www.owlbear.rodeo/*' });\n      for (const tab of tabs) {\n        await browserAPI.tabs.sendMessage(tab.id, {\n          action: 'characterSelected',\n          character: characterData\n        });\n        debug.log(`\uD83D\uDCE8 Notified Owlbear tab ${tab.id} of character selection`);\n      }\n    } catch (error) {\n      debug.log('\u2139\uFE0F No Owlbear tabs to notify (this is normal if not on Owlbear)');\n    }\n\n  } catch (error) {\n    debug.error('Failed to set active character:', error);\n    throw error;\n  }\n}\n\n/**\n * Get the currently active character\n */\nasync function getActiveCharacter() {\n  try {\n    const result = await browserAPI.storage.local.get(['characterProfiles', 'activeCharacterId']);\n    const activeCharacterId = result.activeCharacterId;\n\n    if (!activeCharacterId) {\n      debug.log('\uD83D\uDCCB No active character set');\n      return null;\n    }\n\n    const characterProfiles = result.characterProfiles || {};\n    const characterData = characterProfiles[activeCharacterId];\n\n    if (!characterData) {\n      debug.warn(`\u26A0\uFE0F Active character ${activeCharacterId} not found in profiles`);\n      return null;\n    }\n\n    debug.log(`\uD83C\uDFAF Retrieved active character: ${characterData.name || characterData.character_name}`);\n    return characterData;\n  } catch (error) {\n    debug.error('Failed to get active character:', error);\n    return null;\n  }\n}\n\n/**\n * Mark a character as active in Supabase\n */\nasync function markCharacterActiveInSupabase(characterId, characterName) {\n  if (!isSupabaseConfigured()) {\n    debug.warn('Supabase not configured - cannot mark character as active');\n    return;\n  }\n\n  try {\n    debug.log(`\uD83C\uDFAF Marking character as active in Supabase: ${characterName} (${characterId})`);\n\n    // First, get the Discord user ID for this character\n    const pairingResponse = await fetch(\n      `${SUPABASE_URL}/rest/v1/clouds_characters?dicecloud_character_id=eq.${characterId}&select=discord_user_id`,\n      {\n        headers: {\n          'apikey': SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n        }\n      }\n    );\n\n    if (pairingResponse.ok) {\n      const characters = await pairingResponse.json();\n      if (characters.length > 0) {\n        const discordUserId = characters[0].discord_user_id;\n        \n        if (discordUserId && discordUserId !== 'not_linked') {\n          // Deactivate all other characters for this user\n          await fetch(\n            `${SUPABASE_URL}/rest/v1/clouds_characters?discord_user_id=eq.${discordUserId}`,\n            {\n              method: 'PATCH',\n              headers: {\n                'apikey': SUPABASE_ANON_KEY,\n                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n                'Content-Type': 'application/json'\n              },\n              body: JSON.stringify({ is_active: false })\n            }\n          );\n\n          // Activate this character\n          const updateResponse = await fetch(\n            `${SUPABASE_URL}/rest/v1/clouds_characters?dicecloud_character_id=eq.${characterId}`,\n            {\n              method: 'PATCH',\n              headers: {\n                'apikey': SUPABASE_ANON_KEY,\n                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n                'Content-Type': 'application/json'\n              },\n              body: JSON.stringify({ is_active: true })\n            }\n          );\n\n          if (updateResponse.ok) {\n            debug.log(`\u2705 Successfully marked ${characterName} as active in Supabase`);\n          } else {\n            debug.warn(`\u26A0\uFE0F Failed to update active status in Supabase: ${updateResponse.status}`);\n          }\n        } else {\n          debug.warn(`\u26A0\uFE0F Character ${characterName} not linked to Discord user, cannot mark as active`);\n        }\n      } else {\n        debug.warn(`\u26A0\uFE0F Character ${characterId} not found in Supabase`);\n      }\n    } else {\n      debug.warn(`\u26A0\uFE0F Failed to query Supabase for character: ${pairingResponse.status}`);\n    }\n  } catch (error) {\n    debug.error('\u274C Error marking character as active in Supabase:', error);\n  }\n}\n\n/**\n * Clears stored character data (all profiles or specific profile)\n */\nasync function clearCharacterData(characterId = null) {\n  try {\n    if (characterId) {\n      // Clear specific character\n      const result = await browserAPI.storage.local.get(['characterProfiles', 'activeCharacterId']);\n      const characterProfiles = result.characterProfiles || {};\n      const activeCharacterId = result.activeCharacterId;\n\n      delete characterProfiles[characterId];\n\n      const updates = {\n        characterProfiles: characterProfiles\n      };\n\n      // If we just deleted the active character, switch to another one\n      if (activeCharacterId === characterId) {\n        const remainingIds = Object.keys(characterProfiles);\n        if (remainingIds.length > 0) {\n          // Set first available character as active\n          updates.activeCharacterId = remainingIds[0];\n          debug.log(`Active character was cleared, switching to ${remainingIds[0]}`);\n        } else {\n          // No characters left, clear active ID\n          updates.activeCharacterId = null;\n          debug.log('No characters remaining, clearing active character ID');\n        }\n      }\n\n      await browserAPI.storage.local.set(updates);\n\n      debug.log(`Character profile cleared for ID: ${characterId}`);\n    } else {\n      // Clear all characters - include ALL legacy storage keys\n      const legacyKeys = [\n        'characterProfiles',\n        'activeCharacterId',\n        'timestamp',\n        'characterData',           // Legacy single-character key\n        'activeSlot',              // Legacy slot system\n        'slot1', 'slot2', 'slot3', 'slot4', 'slot5',  // Legacy slots\n        'currentCharacter',        // Another legacy key\n        'cachedCharacter'          // Cache key\n      ];\n      await browserAPI.storage.local.remove(legacyKeys);\n      debug.log('All character data cleared successfully (including legacy keys)');\n    }\n  } catch (error) {\n    debug.error('Failed to clear character data:', error);\n    throw error;\n  }\n}\n\n/**\n * Delete character from cloud (Supabase)\n */\nasync function deleteCharacterFromCloud(characterId) {\n  try {\n    if (!characterId) {\n      throw new Error('Character ID is required');\n    }\n\n    if (!isSupabaseConfigured()) {\n      throw new Error('Supabase not configured');\n    }\n\n    debug.log(`\uD83D\uDDD1\uFE0F Deleting character from cloud: ${characterId}`);\n\n    // Strip db- prefix if present for database query\n    const cleanId = characterId.startsWith('db-') ? characterId.replace('db-', '') : characterId;\n\n    // Try to delete with both the clean ID and the original ID\n    // Some records may have been stored with the prefix, some without\n    const idsToTry = [cleanId];\n    if (cleanId !== characterId) {\n      idsToTry.push(characterId); // Also try with prefix\n    }\n\n    let deleted = false;\n    for (const idToDelete of idsToTry) {\n      const response = await fetch(\n        `${SUPABASE_URL}/rest/v1/clouds_characters?dicecloud_character_id=eq.${encodeURIComponent(idToDelete)}`,\n        {\n          method: 'DELETE',\n          headers: {\n            'apikey': SUPABASE_ANON_KEY,\n            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n            'Prefer': 'return=representation'  // Return deleted rows to verify\n          }\n        }\n      );\n\n      if (response.ok) {\n        const deletedRows = await response.json();\n        if (deletedRows && deletedRows.length > 0) {\n          debug.log(`\u2705 Deleted ${deletedRows.length} record(s) from cloud with ID: ${idToDelete}`);\n          deleted = true;\n        }\n      }\n    }\n\n    if (!deleted) {\n      debug.warn(`\u26A0\uFE0F No records found in cloud for character: ${characterId}`);\n    }\n\n    debug.log(`\u2705 Character delete from cloud completed: ${characterId}`);\n    return { success: true };\n  } catch (error) {\n    debug.error('Failed to delete character from cloud:', error);\n    throw error;\n  }\n}\n\n/**\n * Rolls in Dice Cloud\n */\nasync function rollInDiceCloudAndForward(rollData) {\n  try {\n    // Find Dice Cloud tab\n    const diceCloudTabs = await browserAPI.tabs.query({ url: '*://dicecloud.com/*' });\n\n    if (diceCloudTabs.length === 0) {\n      throw new Error('No Dice Cloud tab found. Please open Dice Cloud first.');\n    }\n\n    // Send roll request to Dice Cloud\n    const diceCloudTab = diceCloudTabs[0];\n    const response = await browserAPI.tabs.sendMessage(diceCloudTab.id, {\n      action: 'rollInDiceCloud',\n      roll: rollData\n    });\n\n    if (!response || !response.success) {\n      throw new Error('Failed to roll in Dice Cloud');\n    }\n\n    debug.log('Roll initiated in Dice Cloud');\n    return response;\n  } catch (error) {\n    debug.error('Failed to roll in Dice Cloud:', error);\n    throw error;\n  }\n}\n\n/**\n * Handle extension installation\n */\nbrowserAPI.runtime.onInstalled.addListener((details) => {\n  if (details.reason === 'install') {\n    debug.log('Extension installed');\n    \n    // Auto-open popup after installation\n    setTimeout(() => {\n      openExtensionPopup();\n    }, 1000); // Wait 1 second for extension to fully initialize\n    // Prompt user to re-sync Discord integration after install\n    try {\n      browserAPI.storage.local.set({ requireDiscordResync: true });\n      debug.log('Set requireDiscordResync flag after install');\n    } catch (e) {\n      debug.warn('Could not set requireDiscordResync flag:', e);\n    }\n  } else if (details.reason === 'update') {\n    debug.log('Extension updated to version', browserAPI.runtime.getManifest().version);\n    // Prompt user to re-sync Discord integration after update\n    try {\n      browserAPI.storage.local.set({ requireDiscordResync: true });\n      debug.log('Set requireDiscordResync flag after update');\n    } catch (e) {\n      debug.warn('Could not set requireDiscordResync flag on update:', e);\n    }\n    // Attempt automatic resync to cloud if Discord integration appears active\n    (async () => {\n      try {\n        const stored = await browserAPI.storage.local.get(['discordWebhookEnabled', 'discordUserId', 'discordPairingId']);\n        const discordConnected = stored.discordWebhookEnabled || stored.discordUserId || stored.discordPairingId;\n\n        if (!discordConnected) {\n          debug.log('No Discord integration detected on update; skipping automatic resync');\n          return;\n        }\n\n        if (!isSupabaseConfigured()) {\n          debug.log('Supabase not configured; skipping automatic resync');\n          return;\n        }\n\n        debug.log('\uD83D\uDD01 Attempting automatic character resync after update (Discord connected)');\n        // Keep service worker alive while we attempt the sync\n        keepServiceWorkerAlive(60000);\n\n        const activeChar = await getCharacterData();\n        if (!activeChar) {\n          debug.log('No active character found; nothing to resync');\n          return;\n        }\n\n        const res = await storeCharacterToCloud(activeChar);\n        if (res && res.success) {\n          debug.log('\u2705 Automatic resync successful after update');\n        } else {\n          debug.warn('\u26A0\uFE0F Automatic resync failed after update:', res && res.error);\n        }\n      } catch (err) {\n        debug.warn('\u26A0\uFE0F Automatic resync encountered an error on update:', err);\n      } finally {\n        // Allow the service worker to stop naturally after a short delay\n        setTimeout(() => stopKeepAlive(), 5000);\n      }\n    })();\n  }\n});\n\n/**\n * Open the extension popup\n */\nasync function openExtensionPopup() {\n  try {\n    debug.log('\uD83D\uDE80 Opening extension popup after installation...');\n    \n    // For Chrome, we can open the popup directly\n    if (!isFirefox) {\n      // Chrome doesn't have a direct API to open popup, but we can open the options page\n      // which serves a similar purpose for first-time setup\n      browserAPI.runtime.openOptionsPage();\n      debug.log('\u2705 Opened options page for Chrome');\n    } else {\n      // For Firefox, we can try to open the popup\n      try {\n        // Firefox doesn't have a direct popup opening API either\n        // So we'll open the options page as well\n        browserAPI.runtime.openOptionsPage();\n        debug.log('\u2705 Opened options page for Firefox');\n      } catch (error) {\n        debug.log('\u26A0\uFE0F Could not open options page:', error);\n      }\n    }\n  } catch (error) {\n    debug.log('\u274C Error opening popup/options:', error);\n  }\n}\n\n// ============================================================================\n// Discord Webhook Integration\n// ============================================================================\n\n/**\n * Stores Discord webhook settings\n * @param {string} webhookUrl - The Discord webhook URL\n * @param {boolean} enabled - Whether notifications are enabled\n * @param {string} serverName - Optional Discord server name for display\n */\nasync function setDiscordWebhookSettings(webhookUrl, enabled = true, serverName = null) {\n  try {\n    const settings = {\n      discordWebhookUrl: webhookUrl || '',\n      discordWebhookEnabled: enabled\n    };\n    if (serverName) {\n      settings.discordServerName = serverName;\n    }\n    debug.log('\uD83D\uDCDD Saving Discord webhook settings:', {\n      webhookUrl: webhookUrl ? `${webhookUrl.substring(0, 50)}...` : '(empty)',\n      enabled,\n      serverName\n    });\n    await browserAPI.storage.local.set(settings);\n\n    // Verify storage was successful\n    const verification = await browserAPI.storage.local.get(['discordWebhookUrl', 'discordWebhookEnabled']);\n    debug.log('\u2705 Discord webhook settings verified:', {\n      storedUrl: verification.discordWebhookUrl ? `${verification.discordWebhookUrl.substring(0, 50)}...` : '(empty)',\n      storedEnabled: verification.discordWebhookEnabled\n    });\n\n    // Sync webhook URL to the pairing record in Supabase if we have a pairing ID\n    if (webhookUrl && isSupabaseConfigured()) {\n      try {\n        const stored = await browserAPI.storage.local.get(['discordPairingId']);\n        if (stored.discordPairingId) {\n          debug.log('\u2601\uFE0F Syncing webhook URL to pairing record:', stored.discordPairingId);\n          await fetch(\n            `${SUPABASE_URL}/rest/v1/clouds_pairings?id=eq.${stored.discordPairingId}`,\n            {\n              method: 'PATCH',\n              headers: {\n                'apikey': SUPABASE_ANON_KEY,\n                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n                'Content-Type': 'application/json',\n                'Prefer': 'return=minimal'\n              },\n              body: JSON.stringify({ webhook_url: webhookUrl })\n            }\n          );\n          debug.log('\u2705 Webhook URL synced to pairing');\n        }\n      } catch (syncError) {\n        debug.warn('\u26A0\uFE0F Failed to sync webhook to pairing:', syncError.message);\n        // Don't throw - local save was successful\n      }\n    }\n  } catch (error) {\n    debug.error('Failed to save Discord webhook settings:', error);\n    throw error;\n  }\n}\n\n/**\n * Gets Discord webhook settings\n */\nasync function getDiscordWebhookSettings() {\n  try {\n    const result = await browserAPI.storage.local.get([\n      'discordWebhookUrl',\n      'discordWebhookEnabled',\n      'discordServerName'\n    ]);\n    return {\n      webhookUrl: result.discordWebhookUrl || '',\n      enabled: result.discordWebhookEnabled !== false, // Default to true if URL exists\n      serverName: result.discordServerName || null\n    };\n  } catch (error) {\n    debug.error('Failed to get Discord webhook settings:', error);\n    return { webhookUrl: '', enabled: false, serverName: null };\n  }\n}\n\n/**\n * Tests a Discord webhook by sending a test message\n */\nasync function testDiscordWebhook(webhookUrl) {\n  try {\n    if (!webhookUrl || !webhookUrl.includes('discord.com/api/webhooks')) {\n      return { success: false, error: 'Invalid Discord webhook URL' };\n    }\n\n    const testEmbed = {\n      embeds: [{\n        title: '\uD83C\uDFB2 OwlCloud Connected!',\n        description: 'Discord webhook integration is working correctly.',\n        color: 0x4ECDC4, // Teal color matching the extension theme\n        footer: {\n          text: 'OwlCloud - Dice Cloud \u2192 Discord Bridge'\n        },\n        timestamp: new Date().toISOString()\n      }]\n    };\n\n    const response = await fetch(webhookUrl, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(testEmbed)\n    });\n\n    if (response.ok || response.status === 204) {\n      debug.log('\u2705 Discord webhook test successful');\n      return { success: true };\n    } else {\n      const errorText = await response.text();\n      debug.warn('\u274C Discord webhook test failed:', response.status, errorText);\n      return { success: false, error: `HTTP ${response.status}: ${errorText}` };\n    }\n  } catch (error) {\n    debug.error('\u274C Discord webhook test error:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n/**\n * Posts a message to Discord via webhook\n * Rate limited to prevent spam (max 1 message per second)\n */\nlet lastDiscordPost = 0;\nconst DISCORD_RATE_LIMIT_MS = 1000;\n\nasync function postToDiscordWebhook(payload) {\n  try {\n    // Get webhook settings\n    const settings = await getDiscordWebhookSettings();\n\n    if (!settings.enabled || !settings.webhookUrl) {\n      debug.log('Discord webhook disabled or not configured');\n      return { success: false, error: 'Webhook not configured' };\n    }\n\n    // Rate limiting\n    const now = Date.now();\n    if (now - lastDiscordPost < DISCORD_RATE_LIMIT_MS) {\n      debug.log('Discord rate limit - skipping post');\n      return { success: false, error: 'Rate limited' };\n    }\n    lastDiscordPost = now;\n\n    // Build the Discord message\n    const message = buildDiscordMessage(payload);\n\n    const response = await fetch(settings.webhookUrl, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(message)\n    });\n\n    if (response.ok || response.status === 204) {\n      debug.log('\u2705 Posted to Discord:', payload.type);\n      return { success: true };\n    } else {\n      const errorText = await response.text();\n      debug.warn('\u274C Discord post failed:', response.status);\n      return { success: false, error: `HTTP ${response.status}` };\n    }\n  } catch (error) {\n    debug.error('\u274C Discord post error:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n/**\n * Builds a Discord embed message from the payload\n * Messages are structured for both human readability and Pip Bot parsing\n *\n * Pip Bot can parse these fields:\n * - embed.title: Contains character name and event type\n * - embed.fields: Structured data (character, round, actions)\n * - embed.footer.text: Contains parseable metadata like \"TURN_START|Chepi|Round:3\"\n */\nfunction buildDiscordMessage(payload) {\n  const { type, characterName, combatant, round, actions, initiative } = payload;\n\n  // Action economy status icons\n  const getIcon = (used) => used ? '\u274C' : '\u2705';\n\n  // Build action status string\n  const buildActionStatus = (acts) => {\n    if (!acts) return null;\n    return [\n      `Action: ${getIcon(acts.action)}`,\n      `Bonus: ${getIcon(acts.bonus)}`,\n      `Move: ${getIcon(acts.movement)}`,\n      `React: ${getIcon(acts.reaction)}`\n    ].join(' | ');\n  };\n\n  // Build parseable footer for Pip Bot\n  const buildFooter = (eventType, charName, roundNum, acts) => {\n    const parts = [eventType, charName];\n    if (roundNum) parts.push(`Round:${roundNum}`);\n    if (acts) {\n      const actionBits = [\n        acts.action ? '0' : '1',\n        acts.bonus ? '0' : '1',\n        acts.movement ? '0' : '1',\n        acts.reaction ? '0' : '1'\n      ].join('');\n      parts.push(`Actions:${actionBits}`); // e.g., \"Actions:1111\" = all available\n    }\n    return parts.join('|');\n  };\n\n  if (type === 'turnStart') {\n    const actionStatus = buildActionStatus(actions);\n\n    return {\n      embeds: [{\n        title: `\uD83C\uDFB2 ${characterName}'s Turn`,\n        description: actionStatus || 'Combat turn started!',\n        color: 0x4ECDC4, // Teal - active turn\n        fields: [\n          { name: 'Character', value: characterName, inline: true },\n          ...(round ? [{ name: 'Round', value: String(round), inline: true }] : []),\n          ...(initiative ? [{ name: 'Initiative', value: String(initiative), inline: true }] : [])\n        ],\n        footer: { text: buildFooter('TURN_START', characterName, round, actions) },\n        timestamp: new Date().toISOString()\n      }]\n    };\n  }\n\n  if (type === 'turnEnd') {\n    return {\n      embeds: [{\n        title: `\u23F8\uFE0F ${characterName}'s Turn Ended`,\n        color: 0x95A5A6, // Gray - inactive\n        fields: [\n          { name: 'Character', value: characterName, inline: true }\n        ],\n        footer: { text: buildFooter('TURN_END', characterName, round) },\n        timestamp: new Date().toISOString()\n      }]\n    };\n  }\n\n  if (type === 'actionUpdate') {\n    const actionStatus = buildActionStatus(actions);\n    const hasUsedActions = actions && (actions.action || actions.bonus);\n\n    return {\n      embeds: [{\n        title: `\u2694\uFE0F ${characterName}`,\n        description: actionStatus,\n        color: hasUsedActions ? 0xF39C12 : 0x4ECDC4, // Orange if actions used, teal if available\n        fields: [\n          { name: 'Character', value: characterName, inline: true },\n          { name: 'Status', value: hasUsedActions ? 'Actions Used' : 'Actions Available', inline: true }\n        ],\n        footer: { text: buildFooter('ACTION_UPDATE', characterName, round, actions) },\n        timestamp: new Date().toISOString()\n      }]\n    };\n  }\n\n  if (type === 'combatStart') {\n    return {\n      embeds: [{\n        title: '\u2694\uFE0F Combat Started!',\n        description: combatant ? `First up: **${combatant}**` : 'Roll for initiative!',\n        color: 0xE74C3C, // Red - combat\n        footer: { text: 'COMBAT_START' },\n        timestamp: new Date().toISOString()\n      }]\n    };\n  }\n\n  if (type === 'roundChange') {\n    return {\n      embeds: [{\n        title: `\uD83D\uDD04 Round ${round}`,\n        description: combatant ? `Current turn: **${combatant}**` : 'New round begins!',\n        color: 0x9B59B6, // Purple - round change\n        footer: { text: `ROUND_CHANGE|Round:${round}` },\n        timestamp: new Date().toISOString()\n      }]\n    };\n  }\n\n  if (type === 'roll') {\n    // Format the roll string for Discord display\n    const rollDisplay = rollString.replace(/\\[\\[([^\\]]+)\\]/g, '$1'); // Convert [XdY] to XdY\n    \n    return {\n      embeds: [{\n        title: `\uD83C\uDFB2 ${characterName} rolls ${rollName}`,\n        description: `**${rollDisplay}**`,\n        color: 0x4ECDC4, // Teal - roll\n        fields: [\n          { name: 'Character', value: characterName || 'Unknown', inline: true },\n          { name: 'Roll', value: rollDisplay, inline: true }\n        ],\n        timestamp: new Date().toISOString()\n      }]\n    };\n  }\n\n  // Default simple message\n  return {\n    content: payload.message || `\uD83C\uDFB2 ${characterName || 'Unknown'}: ${type}`\n  };\n}\n\n// ============================================================================\n// Discord User Linking\n// ============================================================================\n\n/**\n * Link Discord user info to auth_tokens table\n * This allows character sync to associate characters with Discord accounts\n * @param {string} discordUserId - The Discord user ID\n * @param {string} [discordUsername] - The Discord username\n * @param {string} [discordGlobalName] - The Discord display name\n */\nasync function linkDiscordUserToAuthTokens(discordUserId, discordUsername, discordGlobalName) {\n  if (!isSupabaseConfigured() || !discordUserId) {\n    debug.warn('Cannot link Discord user - Supabase not configured or no user ID');\n    return { success: false };\n  }\n\n  try {\n    // Generate browser fingerprint (same as SupabaseTokenManager)\n    // Note: screen is not available in service workers, use fallback\n    const screenDimensions = (typeof screen !== 'undefined' && screen)\n      ? `${screen.width}x${screen.height}`\n      : '0x0';\n    const browserFingerprint = [\n      navigator.userAgent,\n      navigator.language,\n      screenDimensions,\n      new Date().getTimezoneOffset()\n    ].join('|');\n    let hash = 0;\n    for (let i = 0; i < browserFingerprint.length; i++) {\n      const char = browserFingerprint.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    const visitorId = 'user_' + Math.abs(hash).toString(36);\n\n    debug.log('\uD83D\uDD17 Linking Discord user to auth_tokens:', discordUserId, discordUsername, discordGlobalName, 'for browser:', visitorId);\n\n    // Build upsert payload with all available Discord fields\n    const upsertPayload = {\n      user_id: visitorId,\n      discord_user_id: discordUserId,\n      updated_at: new Date().toISOString()\n    };\n    if (discordUsername) {\n      upsertPayload.discord_username = discordUsername;\n    }\n    if (discordGlobalName) {\n      upsertPayload.discord_global_name = discordGlobalName;\n    }\n\n    // Upsert auth_tokens with Discord info (insert if not exists, update if exists)\n    const response = await fetch(\n      `${SUPABASE_URL}/rest/v1/auth_tokens`,\n      {\n        method: 'POST',\n        headers: {\n          'apikey': SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n          'Content-Type': 'application/json',\n          'Prefer': 'resolution=merge-duplicates,return=minimal'\n        },\n        body: JSON.stringify(upsertPayload)\n      }\n    );\n\n    if (response.ok) {\n      debug.log('\u2705 Discord user linked to auth_tokens via POST');\n\n      // Also update any existing characters with this user's DiceCloud ID\n      const authResult = await browserAPI.storage.local.get(['diceCloudUserId']);\n      if (authResult.diceCloudUserId) {\n        await linkDiscordUserToCharacters(discordUserId, authResult.diceCloudUserId);\n      }\n\n      return { success: true };\n    } else {\n      const errorText = await response.text();\n\n      // If duplicate key error, try PATCH instead\n      if (response.status === 409 && errorText.includes('auth_tokens_user_id_key')) {\n        debug.log('\u26A0\uFE0F Auth token exists, trying PATCH update:', visitorId);\n\n        const patchResponse = await fetch(\n          `${SUPABASE_URL}/rest/v1/auth_tokens?user_id=eq.${encodeURIComponent(visitorId)}`,\n          {\n            method: 'PATCH',\n            headers: {\n              'apikey': SUPABASE_ANON_KEY,\n              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n              'Content-Type': 'application/json',\n              'Prefer': 'return=minimal'\n            },\n            body: JSON.stringify(upsertPayload)\n          }\n        );\n\n        if (patchResponse.ok) {\n          debug.log('\u2705 Discord user linked to auth_tokens via PATCH');\n\n          // Also update any existing characters with this user's DiceCloud ID\n          const authResult = await browserAPI.storage.local.get(['diceCloudUserId']);\n          if (authResult.diceCloudUserId) {\n            await linkDiscordUserToCharacters(discordUserId, authResult.diceCloudUserId);\n          }\n\n          return { success: true };\n        } else {\n          const patchError = await patchResponse.text();\n          debug.error('\u274C PATCH also failed:', patchResponse.status, patchError);\n          return { success: false, error: patchError };\n        }\n      }\n\n      debug.error('\u274C Failed to link Discord user:', response.status, errorText);\n      return { success: false, error: errorText };\n    }\n  } catch (error) {\n    debug.error('\u274C Error linking Discord user:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n/**\n * Update existing characters with the Discord user ID\n */\nasync function linkDiscordUserToCharacters(discordUserId, diceCloudUserId) {\n  if (!isSupabaseConfigured()) return;\n\n  try {\n    debug.log('\uD83D\uDD17 Linking Discord user to existing characters:', discordUserId);\n\n    // Update characters that have user_id_dicecloud matching but discord_user_id is 'not_linked'\n    const response = await fetch(\n      `${SUPABASE_URL}/rest/v1/clouds_characters?user_id_dicecloud=eq.${diceCloudUserId}&discord_user_id=eq.not_linked`,\n      {\n        method: 'PATCH',\n        headers: {\n          'apikey': SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n          'Content-Type': 'application/json',\n          'Prefer': 'return=minimal'\n        },\n        body: JSON.stringify({\n          discord_user_id: discordUserId,\n          updated_at: new Date().toISOString()\n        })\n      }\n    );\n\n    if (response.ok) {\n      debug.log('\u2705 Updated existing characters with Discord user ID');\n    } else {\n      debug.warn('\u26A0\uFE0F Could not update existing characters:', response.status);\n    }\n  } catch (error) {\n    debug.warn('\u26A0\uFE0F Error updating existing characters:', error);\n  }\n}\n\n// ============================================================================\n// Character Cloud Sync to Supabase\n// ============================================================================\n\n/**\n * Store character data in Supabase for cloud sync\n * This allows character data to be accessed by the Discord bot\n */\nasync function storeCharacterToCloud(characterData, pairingCode = null) {\n  if (!isSupabaseConfigured()) {\n    debug.warn('Supabase not configured - character sync unavailable');\n    return {\n      success: false,\n      error: 'Cloud sync not available. Supabase not configured.',\n      supabaseNotConfigured: true\n    };\n  }\n\n  try {\n    debug.log('\uD83C\uDFAD Storing character in Supabase:', characterData.name || characterData.id);\n\n    // Generate a browser ID for looking up auth tokens\n    // Note: screen is not available in service workers, use fallback\n    const screenDimensions = (typeof screen !== 'undefined' && screen)\n      ? `${screen.width}x${screen.height}`\n      : '0x0';\n    const browserFingerprint = [\n      navigator.userAgent,\n      navigator.language,\n      screenDimensions,\n      new Date().getTimezoneOffset()\n    ].join('|');\n    let hash = 0;\n    for (let i = 0; i < browserFingerprint.length; i++) {\n      const char = browserFingerprint.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    const visitorId = 'user_' + Math.abs(hash).toString(36);\n\n    // Get DiceCloud user ID from character data, or fall back to local storage\n    let dicecloudUserId = characterData.dicecloudUserId || characterData.userId || characterData.ownerUserId || null;\n    if (!dicecloudUserId) {\n      const stored = await browserAPI.storage.local.get(['diceCloudUserId']);\n      dicecloudUserId = stored.diceCloudUserId || null;\n      if (dicecloudUserId) {\n        debug.log('\u2705 Got DiceCloud user ID from storage:', dicecloudUserId);\n      }\n    }\n\n    // Refuse to store a character to the cloud without a valid user ID.\n    // Without this, the character would be saved with null ownership and\n    // could leak into other users' character lists.\n    if (!dicecloudUserId) {\n      debug.error('\u274C Cannot store character to cloud: no DiceCloud user ID available');\n      return {\n        success: false,\n        error: 'Cannot sync to cloud: not logged in to DiceCloud. Please login first.'\n      };\n    }\n\n    // Resolve the real DiceCloud character ID.  Storage slot keys like\n    // \"slot-1\" or \"db-slot-1\" must NOT be used as the character ID in the\n    // database \u2014 they are internal storage keys, not DiceCloud identifiers.\n    let resolvedCharId = characterData.id || characterData._id || null;\n\n    // Helper to check if an ID looks like a storage/internal key\n    const isStorageKey = (id) => {\n      if (!id) return false;\n      // Match: slot-N, db-slot-N, db-db-slot-N, db-UUID, etc.\n      return /^(db-)+/.test(id) || /^slot-\\d+$/.test(id) || /^db-slot-\\d+$/.test(id);\n    };\n\n    // Helper to check if an ID looks like a real DiceCloud ID (17-char alphanumeric)\n    const isDiceCloudId = (id) => {\n      if (!id) return false;\n      // DiceCloud IDs are typically 17-character alphanumeric strings\n      return /^[A-Za-z0-9]{17}$/.test(id);\n    };\n\n    if (resolvedCharId && isStorageKey(resolvedCharId)) {\n      debug.warn(`\u26A0\uFE0F Character ID \"${resolvedCharId}\" looks like a storage key, not a DiceCloud ID`);\n\n      // Try to find the real DiceCloud character ID from multiple sources\n      const nested = characterData.raw_dicecloud_data || characterData._fullData || {};\n      const possibleIds = [\n        nested.dicecloud_character_id,\n        nested._id,\n        nested.id,\n        characterData.dicecloud_character_id,\n        characterData.dicecloudId,\n        characterData.characterId,\n        // Also check nested raw_dicecloud_data (for double-nested data)\n        nested.raw_dicecloud_data?.id,\n        nested.raw_dicecloud_data?._id\n      ].filter(id => id && !isStorageKey(id));\n\n      // Prefer a real DiceCloud ID if found\n      const realId = possibleIds.find(isDiceCloudId) || possibleIds[0];\n\n      if (realId) {\n        resolvedCharId = realId;\n        debug.log(`\u2705 Resolved real DiceCloud character ID: ${resolvedCharId}`);\n      } else {\n        // Last resort: generate a fingerprint from character name + user ID + class/level\n        // This ensures the same character always gets the same ID\n        const fingerprint = `${dicecloudUserId}-${characterData.name}-${characterData.class}-${characterData.level}`;\n        let fpHash = 0;\n        for (let i = 0; i < fingerprint.length; i++) {\n          const char = fingerprint.charCodeAt(i);\n          fpHash = ((fpHash << 5) - fpHash) + char;\n          fpHash = fpHash & fpHash;\n        }\n        resolvedCharId = `fp-${Math.abs(fpHash).toString(36)}`;\n        debug.warn(`\u26A0\uFE0F Using fingerprint ID for dedup: ${resolvedCharId}`);\n      }\n    }\n\n    // Prepare payload, ensuring we store the original DiceCloud raw object\n    // and avoid embedding previous DB wrapper objects (which cause deep nesting).\n    const prepareRawForPayload = (data) => {\n      try {\n        // Prefer explicit nested raw_dicecloud_data or _fullData.raw_dicecloud_data\n        let candidate = null;\n        if (data && data._fullData && data._fullData.raw_dicecloud_data) {\n          candidate = data._fullData.raw_dicecloud_data;\n        } else if (data && data.raw_dicecloud_data) {\n          candidate = data.raw_dicecloud_data;\n        } else if (data && data._fullData) {\n          candidate = data._fullData;\n        }\n\n        // Unwrap repeated wrappers like { raw_dicecloud_data: { raw_dicecloud_data: { ... } } }\n        const seen = new Set();\n        while (candidate && typeof candidate === 'object' && candidate.raw_dicecloud_data && !seen.has(candidate)) {\n          seen.add(candidate);\n          candidate = candidate.raw_dicecloud_data;\n        }\n\n        // If candidate looks like a DB wrapper (id starting with db-), try to recover original\n        if (candidate && typeof candidate.id === 'string' && candidate.id.startsWith('db-')) {\n          if (candidate._id && typeof candidate._id === 'string' && !candidate._id.startsWith('db-')) {\n            candidate.id = candidate._id;\n          } else if (candidate.raw_dicecloud_data && candidate.raw_dicecloud_data.id && !candidate.raw_dicecloud_data.id.startsWith('db-')) {\n            candidate.id = candidate.raw_dicecloud_data.id;\n          }\n        }\n\n        // Small normalization: if there are snake_case keys in raw payload, prefer camelCase aliases\n        if (candidate && typeof candidate === 'object') {\n          if (candidate.armor_class && !candidate.armorClass) candidate.armorClass = candidate.armor_class;\n          if (candidate.hit_points && !candidate.hitPoints) candidate.hitPoints = candidate.hit_points;\n        }\n\n        // If we managed to find a candidate that looks like a DiceCloud object, use it;\n        // otherwise fall back to the original `data` (best-effort).\n        if (candidate && typeof candidate === 'object') return candidate;\n      } catch (e) {\n        debug.warn('\u26A0\uFE0F Error while preparing raw_dicecloud_data for payload:', e && e.message ? e.message : e);\n      }\n      return data;\n    };\n\n    // Extract armor class from a prepared raw object using common field names\n    const extractArmorClass = (raw, fallback) => {\n      if (!raw || typeof raw !== 'object') return fallback;\n      if (typeof raw.armorClass === 'number') return raw.armorClass;\n      if (typeof raw.armor_class === 'number') return raw.armor_class;\n      if (raw.ac && typeof raw.ac === 'object') {\n        if (typeof raw.ac.base === 'number') return raw.ac.base;\n        if (typeof raw.ac.total === 'number') return raw.ac.total;\n      }\n      if (raw.defenses && typeof raw.defenses === 'object') {\n        if (typeof raw.defenses.armor_class === 'number') return raw.defenses.armor_class;\n        if (typeof raw.defenses.armorClass === 'number') return raw.defenses.armorClass;\n      }\n      return fallback;\n    };\n\n    const preparedRaw = prepareRawForPayload(characterData);\n\n    // DEBUG: Check what preparedRaw contains BEFORE saving to database\n    debug.log('\uD83D\uDD0D PRE-SAVE: Prepared raw_dicecloud_data check:', {\n      hasSpells: !!preparedRaw.spells,\n      spellsIsArray: Array.isArray(preparedRaw.spells),\n      spellsLength: preparedRaw.spells?.length,\n      hasActions: !!preparedRaw.actions,\n      actionsIsArray: Array.isArray(preparedRaw.actions),\n      actionsLength: preparedRaw.actions?.length,\n      topLevelKeys: Object.keys(preparedRaw || {}).slice(0, 30),\n      rawDataSizeKB: (JSON.stringify(preparedRaw).length / 1024).toFixed(2)\n    });\n\n    const payload = {\n      user_id_dicecloud: dicecloudUserId,\n      dicecloud_character_id: resolvedCharId,\n      character_name: characterData.name || 'Unknown',\n      race: characterData.race || null,\n      class: characterData.class || null,\n      level: characterData.level || 1,\n      alignment: characterData.alignment || null,\n      hit_points: characterData.hitPoints || { current: 0, max: 0 },\n      hit_dice: characterData.hitDice || { current: 0, max: 0, type: 'd8' },\n      temporary_hp: characterData.temporaryHP || 0,\n      death_saves: characterData.deathSaves || { successes: 0, failures: 0 },\n      inspiration: characterData.inspiration || false,\n      armor_class: extractArmorClass(preparedRaw, characterData.armorClass || 10),\n      speed: characterData.speed || 30,\n      initiative: characterData.initiative || 0,\n      proficiency_bonus: characterData.proficiencyBonus || 2,\n      attributes: characterData.attributes || {},\n      attribute_mods: characterData.attributeMods || {},\n      saves: characterData.saves || {},\n      skills: characterData.skills || {},\n      spell_slots: characterData.spellSlots || {},\n      resources: characterData.resources || [],\n      conditions: characterData.conditions || [],\n      notification_color: characterData.notificationColor || '#3498db',\n      // Mark character as active when synced\n      is_active: true,\n      // Store the FULL parsed character object (but unwrap DB wrappers first)\n      // The individual fields above are for Discord bot quick access\n      raw_dicecloud_data: preparedRaw,\n      updated_at: new Date().toISOString()\n    };\n\n    // If pairing code provided, look up the pairing to link\n    if (pairingCode) {\n      const pairingResponse = await fetch(\n        `${SUPABASE_URL}/rest/v1/clouds_pairings?pairing_code=eq.${pairingCode}&select=id,discord_user_id`,\n        {\n          headers: {\n            'apikey': SUPABASE_ANON_KEY,\n            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n          }\n        }\n      );\n      if (pairingResponse.ok) {\n        const pairings = await pairingResponse.json();\n        if (pairings.length > 0) {\n          // TODO: pairing_id field requires database migration - commented out for now\n          // payload.pairing_id = pairings[0].id;\n          payload.discord_user_id = pairings[0].discord_user_id;\n          debug.log('\u2705 Linked to pairing:', pairings[0].id);\n        }\n      }\n    } else {\n      // No pairing code provided - try multiple sources for Discord user ID\n      let discordUserId = null;\n\n      // 1. First check auth_tokens\n      try {\n        const authResponse = await fetch(\n          `${SUPABASE_URL}/rest/v1/auth_tokens?user_id=eq.${visitorId}&select=discord_user_id`,\n          {\n            headers: {\n              'apikey': SUPABASE_ANON_KEY,\n              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n            }\n          }\n        );\n        if (authResponse.ok) {\n          const authTokens = await authResponse.json();\n          if (authTokens.length > 0 && authTokens[0].discord_user_id) {\n            discordUserId = authTokens[0].discord_user_id;\n            debug.log('\u2705 Found Discord user ID from auth_tokens:', discordUserId);\n          }\n        }\n      } catch (error) {\n        debug.warn('\u26A0\uFE0F Failed to check auth_tokens:', error.message);\n      }\n\n      // 2. If not in auth_tokens, check pairings table for this DiceCloud user\n      if (!discordUserId && payload.user_id_dicecloud) {\n        try {\n          const pairingResponse = await fetch(\n            `${SUPABASE_URL}/rest/v1/clouds_pairings?dicecloud_user_id=eq.${payload.user_id_dicecloud}&status=eq.connected&select=id,discord_user_id,discord_username,discord_global_name,webhook_url`,\n            {\n              headers: {\n                'apikey': SUPABASE_ANON_KEY,\n                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n              }\n            }\n          );\n          if (pairingResponse.ok) {\n            const pairings = await pairingResponse.json();\n            if (pairings.length > 0 && pairings[0].discord_user_id) {\n              discordUserId = pairings[0].discord_user_id;\n              // TODO: pairing_id field requires database migration - commented out for now\n              // payload.pairing_id = pairings[0].id;\n              debug.log('\u2705 Found Discord user ID from pairings:', discordUserId);\n              debug.log('\u2705 Linked to pairing:', pairings[0].id);\n              // Also update auth_tokens so future lookups are faster\n              await linkDiscordUserToAuthTokens(\n                discordUserId,\n                pairings[0].discord_username,\n                pairings[0].discord_global_name\n              );\n              // Restore webhook URL from pairing if available\n              if (pairings[0].webhook_url) {\n                const currentSettings = await getDiscordWebhookSettings();\n                if (!currentSettings.webhookUrl) {\n                  debug.log('\u2705 Restoring webhook URL from pairing');\n                  await setDiscordWebhookSettings(pairings[0].webhook_url, true);\n                }\n              }\n            }\n          }\n        } catch (error) {\n          debug.warn('\u26A0\uFE0F Failed to check pairings:', error.message);\n        }\n      }\n\n      // 3. If still not found, check local storage for saved pairing ID\n      if (!discordUserId) {\n        try {\n          const stored = await browserAPI.storage.local.get(['discordPairingId']);\n          if (stored.discordPairingId) {\n            const pairingResponse = await fetch(\n              `${SUPABASE_URL}/rest/v1/clouds_pairings?id=eq.${stored.discordPairingId}&select=id,discord_user_id,discord_username,discord_global_name,webhook_url`,\n              {\n                headers: {\n                  'apikey': SUPABASE_ANON_KEY,\n                  'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n                }\n              }\n            );\n            if (pairingResponse.ok) {\n              const pairings = await pairingResponse.json();\n              if (pairings.length > 0 && pairings[0].discord_user_id) {\n                discordUserId = pairings[0].discord_user_id;\n                // TODO: pairing_id field requires database migration - commented out for now\n                // payload.pairing_id = pairings[0].id;\n                debug.log('\u2705 Found Discord user ID from stored pairing:', discordUserId);\n                debug.log('\u2705 Linked to pairing:', pairings[0].id);\n                // Also update auth_tokens with all Discord info\n                await linkDiscordUserToAuthTokens(\n                  discordUserId,\n                  pairings[0].discord_username,\n                  pairings[0].discord_global_name\n                );\n                // Restore webhook URL from pairing if available\n                if (pairings[0].webhook_url) {\n                  const currentSettings = await getDiscordWebhookSettings();\n                  if (!currentSettings.webhookUrl) {\n                    debug.log('\u2705 Restoring webhook URL from stored pairing');\n                    await setDiscordWebhookSettings(pairings[0].webhook_url, true);\n                  }\n                }\n              }\n            }\n          }\n        } catch (error) {\n          debug.warn('\u26A0\uFE0F Failed to check stored pairing:', error.message);\n        }\n      }\n\n      payload.discord_user_id = discordUserId || 'not_linked';\n      if (!discordUserId) {\n        debug.log('\u26A0\uFE0F No Discord user ID found from any source, using placeholder');\n      }\n    }\n\n    debug.log('\uD83D\uDCE4 Sending character payload to Supabase:', payload.character_name);\n\n    // Lightweight payload preview for debugging: keys + small sample of raw data\n    try {\n      const raw = payload.raw_dicecloud_data;\n      const rawKeys = raw && typeof raw === 'object' && !Array.isArray(raw) ? Object.keys(raw) : [];\n      let rawSample = '';\n      try {\n        if (raw && typeof raw === 'object') {\n          const allowed = rawKeys.slice(0, 50);\n          rawSample = JSON.stringify(raw, allowed);\n        } else {\n          rawSample = String(raw);\n        }\n      } catch (e) {\n        rawSample = '[unserializable raw_dicecloud_data]';\n      }\n      debug.log('\uD83D\uDD01 storeCharacterToCloud payload preview', {\n        dicecloud_character_id: payload.dicecloud_character_id,\n        character_name: payload.character_name,\n        raw_keys_count: rawKeys.length,\n        raw_keys: rawKeys.slice(0, 20),\n        raw_sample: rawSample && rawSample.slice ? rawSample.slice(0, 2000) : rawSample\n      });\n    } catch (e) {\n      debug.warn('\u26A0\uFE0F Failed to produce storeCharacterToCloud payload preview:', e && e.message ? e.message : e);\n    }\n\n    // Delete any existing records for this user + character name to prevent duplicates\n    // This handles cases where the same character was stored with different IDs\n    try {\n      const deleteResponse = await fetch(\n        `${SUPABASE_URL}/rest/v1/clouds_characters?user_id_dicecloud=eq.${encodeURIComponent(payload.user_id_dicecloud)}&character_name=eq.${encodeURIComponent(payload.character_name)}`,\n        {\n          method: 'DELETE',\n          headers: {\n            'apikey': SUPABASE_ANON_KEY,\n            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n            'Prefer': 'return=minimal'\n          }\n        }\n      );\n      if (deleteResponse.ok) {\n        debug.log('\uD83E\uDDF9 Cleaned up existing character records before insert');\n      }\n    } catch (deleteError) {\n      debug.warn('\u26A0\uFE0F Failed to cleanup existing records:', deleteError.message);\n      // Continue anyway - insert will still work (or upsert)\n    }\n\n    // Insert the new character record\n    const response = await fetch(\n      `${SUPABASE_URL}/rest/v1/clouds_characters`,\n      {\n        method: 'POST',\n        headers: {\n          'apikey': SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n          'Content-Type': 'application/json',\n          'Prefer': 'resolution=merge-duplicates,return=minimal'\n        },\n        body: JSON.stringify(payload)\n      }\n    );\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      debug.log('\u26A0\uFE0F Character POST failed, trying PATCH:', response.status, errorText);\n\n      // Try PATCH (update) instead\n      const updateResponse = await fetch(\n        `${SUPABASE_URL}/rest/v1/clouds_characters?dicecloud_character_id=eq.${characterData.id}`,\n        {\n          method: 'PATCH',\n          headers: {\n            'apikey': SUPABASE_ANON_KEY,\n            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n            'Content-Type': 'application/json',\n            'Prefer': 'return=minimal'\n          },\n          body: JSON.stringify(payload)\n        }\n      );\n\n      if (!updateResponse.ok) {\n        const patchError = await updateResponse.text();\n        debug.error('\u274C Character PATCH also failed:', updateResponse.status, patchError);\n        throw new Error(`Character update failed: ${patchError}`);\n      }\n      debug.log('\u2705 Character updated via PATCH');\n    } else {\n      debug.log('\u2705 Character inserted via POST');\n    }\n\n    debug.log('\u2705 Character stored in Supabase:', characterData.name);\n    \n    // Update last sync time for session tracking\n    await browserAPI.storage.local.set({\n      lastSyncTime: new Date().toISOString()\n    });\n    \n    return { success: true };\n  } catch (error) {\n    debug.error('\u274C Failed to store character in Supabase:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n/**\n * Sync character color to Supabase\n * Updates only the notification_color field for a specific character\n */\nasync function syncCharacterColorToSupabase(characterId, color) {\n  if (!isSupabaseConfigured()) {\n    debug.warn('Supabase not configured - color sync unavailable');\n    return {\n      success: false,\n      error: 'Color sync not available. Supabase not configured.',\n      supabaseNotConfigured: true\n    };\n  }\n\n  try {\n    debug.log('\uD83C\uDFA8 Syncing character color to Supabase:', characterId, color);\n\n    // Update only the notification_color field\n    const response = await fetch(\n      `${SUPABASE_URL}/rest/v1/clouds_characters?dicecloud_character_id=eq.${characterId}`,\n      {\n        method: 'PATCH',\n        headers: {\n          'apikey': SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n          'Content-Type': 'application/json',\n          'Prefer': 'return=minimal'\n        },\n        body: JSON.stringify({\n          notification_color: color\n        })\n      }\n    );\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      debug.error('\u274C Failed to sync color to Supabase:', response.status, errorText);\n      return { success: false, error: `Sync failed: ${response.status}` };\n    }\n\n    debug.log('\u2705 Character color synced to Supabase successfully');\n    return { success: true };\n  } catch (error) {\n    debug.error('\u274C Failed to sync character color to Supabase:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n/**\n * Check if character is currently active in Discord bot instances\n * This calls the pip-bot's character status API\n */\nasync function checkDiscordCharacterIntegration(characterName, characterId) {\n  try {\n    debug.log(`\uD83D\uDD0D Checking Discord integration for character: ${characterName} (${characterId})`);\n    \n    // Check for both webhook and pairing-based integration\n    const webhookResult = await getDiscordWebhookSettings();\n    const pairingResult = await browserAPI.storage.local.get(['discordPairingId', 'discordPairingCode']);\n    \n    debug.log(`\uD83D\uDD0D Webhook result:`, { hasUrl: !!webhookResult.webhookUrl, enabled: webhookResult.enabled });\n    debug.log(`\uD83D\uDD0D Pairing result:`, { hasPairingId: !!pairingResult.discordPairingId, hasCode: !!pairingResult.discordPairingCode });\n    \n    // Check if either webhook or pairing is configured\n    const hasWebhookIntegration = webhookResult.webhookUrl && webhookResult.enabled;\n    const hasPairingIntegration = pairingResult.discordPairingId || pairingResult.discordPairingCode;\n    \n    if (!hasWebhookIntegration && !hasPairingIntegration) {\n      debug.log('\u274C Discord integration not configured - no webhook or pairing found');\n      return {\n        success: true,\n        found: false,\n        serverName: null,\n        message: 'Discord integration not configured'\n      };\n    }\n    \n    let serverName = webhookResult.serverName;\n    \n    if (hasWebhookIntegration) {\n      // Extract Discord server info from webhook URL\n      // Webhook URL format: https://discord.com/api/webhooks/{bot_id}/{token}\n      const webhookUrl = new URL(webhookResult.webhookUrl);\n      const botId = webhookUrl.pathname.split('/')[2];\n      \n      debug.log(`\uD83E\uDD16 Checking with bot ID: ${botId} for character: ${characterName}`);\n    } else if (hasPairingIntegration) {\n      debug.log(`\uD83E\uDD16 Checking with pairing system for character: ${characterName}`);\n      serverName = 'Discord Server (Paired)';\n    }\n    \n    // Get active character data to compare\n    const characterData = await getCharacterData();\n    // Handle both DiceCloud format (name) and database format (character_name)\n    const activeCharacterName = characterData?.character_name || characterData?.name;\n\n    debug.log(`\uD83D\uDD0D Character comparison: Discord=\"${characterName}\" vs Active=\"${activeCharacterName}\"`);\n    debug.log(`\uD83D\uDD0D Active character data:`, characterData);\n\n    // Normalize character names for comparison (trim whitespace, case-insensitive)\n    const normalizedDiscordName = characterName?.trim().toLowerCase();\n    const normalizedActiveName = activeCharacterName?.trim().toLowerCase();\n\n    debug.log(`\uD83D\uDD0D Normalized comparison: Discord=\"${normalizedDiscordName}\" vs Active=\"${normalizedActiveName}\"`);\n\n    if (characterData && normalizedDiscordName && normalizedActiveName && normalizedDiscordName === normalizedActiveName) {\n      debug.log(`\u2705 Character ${characterName} found in local storage and matches Discord integration`);\n\n      return {\n        success: true,\n        found: true,\n        serverName: serverName || 'Unknown Server',\n        message: `Character ${characterName} is active in Discord server: ${serverName || 'Unknown Server'}`,\n        characterData: {\n          name: activeCharacterName,\n          race: characterData.race,\n          class: characterData.class,\n          level: characterData.level,\n          discordServer: serverName\n        }\n      };\n    } else {\n      debug.log(`\u274C Character ${characterName} not found in local storage or doesn't match active character`);\n      debug.log(`\u274C Comparison failed: \"${normalizedDiscordName}\" !== \"${normalizedActiveName}\"`);\n\n      return {\n        success: true,\n        found: false,\n        serverName: null,\n        message: `Character ${characterName} is not currently active in Discord`,\n        availableCharacter: characterData ? {\n          name: activeCharacterName,\n          race: characterData.race,\n          class: characterData.class,\n          level: characterData.level\n        } : null\n      };\n    }\n    \n  } catch (error) {\n    debug.error('\u274C Error checking Discord character integration:', error);\n    return {\n      success: false,\n      error: error.message\n    };\n  }\n}\n\n/**\n * Fetch data from DiceCloud API\n * Used to get character data\n */\nasync function fetchFromDiceCloudAPI(url, token) {\n  try {\n    debug.log('\uD83D\uDD0C Fetching from DiceCloud API:', url);\n\n    const headers = {\n      'Content-Type': 'application/json'\n    };\n\n    if (token) {\n      headers['Authorization'] = `Bearer ${token}`;\n    }\n\n    const response = await fetch(url, {\n      method: 'GET',\n      headers: headers\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      debug.error('\u274C DiceCloud API fetch failed:', response.status, errorText);\n      return { success: false, error: `API error: ${response.status}` };\n    }\n\n    const data = await response.json();\n    debug.log('\u2705 DiceCloud API fetch successful');\n    return { success: true, data: data };\n  } catch (error) {\n    debug.error('\u274C Failed to fetch from DiceCloud API:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n// ============================================================================\n// Discord Pairing via Supabase\n// ============================================================================\n\n/**\n * Check if Supabase is configured\n */\nfunction isSupabaseConfigured() {\n  return SUPABASE_URL &&\n         !SUPABASE_URL.includes('your-project') &&\n         SUPABASE_ANON_KEY &&\n         SUPABASE_ANON_KEY !== 'your-anon-key';\n}\n\n// ============================================================================\n// Supabase Realtime Subscription for Pairing Updates\n// ============================================================================\n\nlet realtimeSocket = null;\nlet realtimeHeartbeat = null;\nlet currentPairingCode = null;\n\n/**\n * Subscribe to Realtime updates for a pairing code\n * When the Discord bot completes the pairing, we'll get notified immediately\n */\nfunction subscribeToRealtimePairing(pairingCode) {\n  if (!isSupabaseConfigured()) {\n    debug.warn('Cannot subscribe to Realtime - Supabase not configured');\n    return;\n  }\n\n  // Store the pairing code we're watching\n  currentPairingCode = pairingCode;\n\n  // Close existing connection if any\n  if (realtimeSocket) {\n    realtimeSocket.close();\n  }\n\n  // Extract project ref from URL\n  const projectRef = SUPABASE_URL.replace('https://', '').split('.')[0];\n  const wsUrl = `wss://${projectRef}.supabase.co/realtime/v1/websocket?apikey=${SUPABASE_ANON_KEY}&vsn=1.0.0`;\n\n  debug.log('\uD83D\uDD0C Connecting to Supabase Realtime for pairing:', pairingCode);\n\n  try {\n    realtimeSocket = new WebSocket(wsUrl);\n\n    realtimeSocket.onopen = () => {\n      debug.log('\u2705 Realtime WebSocket connected');\n\n      // Send join message to subscribe to pairing updates\n      const joinMessage = {\n        topic: `realtime:public:clouds_pairings:pairing_code=eq.${pairingCode}`,\n        event: 'phx_join',\n        payload: {\n          config: {\n            broadcast: { self: false },\n            presence: { key: '' },\n            postgres_changes: [{\n              event: 'UPDATE',\n              schema: 'public',\n              table: 'clouds_pairings',\n              filter: `pairing_code=eq.${pairingCode}`\n            }]\n          }\n        },\n        ref: '1'\n      };\n      realtimeSocket.send(JSON.stringify(joinMessage));\n\n      // Start heartbeat to keep connection alive\n      realtimeHeartbeat = setInterval(() => {\n        if (realtimeSocket && realtimeSocket.readyState === WebSocket.OPEN) {\n          realtimeSocket.send(JSON.stringify({\n            topic: 'phoenix',\n            event: 'heartbeat',\n            payload: {},\n            ref: Date.now().toString()\n          }));\n        }\n      }, 30000);\n    };\n\n    realtimeSocket.onmessage = async (event) => {\n      try {\n        const message = JSON.parse(event.data);\n        debug.log('\uD83D\uDCE8 Realtime message:', message.event);\n\n        // Handle postgres_changes events\n        if (message.event === 'postgres_changes' && message.payload?.data?.record) {\n          const record = message.payload.data.record;\n\n          // Check if pairing was completed\n          if (record.status === 'connected' && record.discord_user_id) {\n            debug.log('\uD83C\uDF89 Pairing completed via Realtime! Discord user:', record.discord_user_id);\n\n            // Update auth_tokens with full Discord info\n            await linkDiscordUserToAuthTokens(\n              record.discord_user_id,\n              record.discord_username,\n              record.discord_global_name\n            );\n\n            // IMPORTANT: Save webhook settings directly - don't rely on popup being open\n            if (record.webhook_url) {\n              debug.log('\uD83D\uDCDD Saving webhook URL from Realtime:', record.webhook_url.substring(0, 50) + '...');\n              await setDiscordWebhookSettings(record.webhook_url, true, record.discord_guild_name);\n\n              // Also save pairing ID for command polling\n              await browserAPI.storage.local.set({\n                currentPairingId: record.id,\n                discordPairingId: record.id\n              });\n\n              // Subscribe to command realtime\n              subscribeToCommandRealtime(record.id);\n              debug.log('\u2705 Discord webhook and pairing ID saved from Realtime');\n            }\n\n            // Notify popup that pairing is complete (if it's open)\n            try {\n              await browserAPI.runtime.sendMessage({\n                action: 'pairingComplete',\n                discordUserId: record.discord_user_id,\n                discordUsername: record.discord_username,\n                discordGlobalName: record.discord_global_name,\n                webhookUrl: record.webhook_url,\n                serverName: record.discord_guild_name,\n                pairingId: record.id\n              });\n            } catch (e) {\n              // Popup might not be open - but webhook is already saved above\n              debug.log('Could not notify popup (probably not open)');\n            }\n\n            // Clean up subscription\n            unsubscribeFromRealtimePairing();\n          }\n        }\n      } catch (e) {\n        debug.warn('Error processing Realtime message:', e);\n      }\n    };\n\n    realtimeSocket.onerror = (error) => {\n      debug.warn('Realtime WebSocket error:', error);\n    };\n\n    realtimeSocket.onclose = () => {\n      debug.log('\uD83D\uDD0C Realtime WebSocket closed');\n      if (realtimeHeartbeat) {\n        clearInterval(realtimeHeartbeat);\n        realtimeHeartbeat = null;\n      }\n    };\n  } catch (error) {\n    debug.error('Failed to connect to Realtime:', error);\n  }\n}\n\n/**\n * Unsubscribe from Realtime updates\n */\nfunction unsubscribeFromRealtimePairing() {\n  if (realtimeSocket) {\n    realtimeSocket.close();\n    realtimeSocket = null;\n  }\n  if (realtimeHeartbeat) {\n    clearInterval(realtimeHeartbeat);\n    realtimeHeartbeat = null;\n  }\n  currentPairingCode = null;\n  debug.log('\uD83D\uDD0C Unsubscribed from Realtime pairing updates');\n}\n\n// Before creating new pairing, expire old ones\nasync function createPairing(code, username, userId) {\n  // Clean up old pairings for this user\n  await supabase\n    .from('clouds_pairings')\n    .update({ status: 'expired' })\n    .eq('dicecloud_user_id', userId)\n    .eq('status', 'connected');\n  \n  // NOW create the new one\n  const { data } = await supabase\n    .from('clouds_pairings')\n    .insert({\n      pairing_code: code,\n      dicecloud_username: username,\n      dicecloud_user_id: userId,\n      status: 'pending'\n    });\n}\n\n/**\n * Create a Discord pairing code in Supabase\n */\nasync function createDiscordPairing(code, diceCloudUsername, diceCloudUserId) {\n  // Check if Supabase is configured\n  if (!isSupabaseConfigured()) {\n    debug.warn('Supabase not configured - pairing unavailable');\n    return {\n      success: false,\n      error: 'Automatic pairing not available. Please use manual webhook setup.',\n      supabaseNotConfigured: true\n    };\n  }\n\n  try {\n    // Expire ALL existing pairings for this DiceCloud user (both pending and connected)\n    // This ensures only one active pairing exists per user at a time\n    if (diceCloudUserId) {\n      try {\n        const expireResponse = await fetch(\n          `${SUPABASE_URL}/rest/v1/clouds_pairings?dicecloud_user_id=eq.${diceCloudUserId}&status=in.(pending,connected)`,\n          {\n            method: 'PATCH',\n            headers: {\n              'Content-Type': 'application/json',\n              'apikey': SUPABASE_ANON_KEY,\n              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n              'Prefer': 'return=minimal'\n            },\n            body: JSON.stringify({ status: 'expired' })\n          }\n        );\n        if (expireResponse.ok) {\n          debug.log('\uD83E\uDDF9 Expired old pairings (pending + connected) for user:', diceCloudUserId);\n        }\n      } catch (expireError) {\n        debug.warn('\u26A0\uFE0F Could not expire old pairings:', expireError.message);\n        // Continue anyway - this is not critical\n      }\n    }\n\n    const response = await fetch(`${SUPABASE_URL}/rest/v1/clouds_pairings`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'apikey': SUPABASE_ANON_KEY,\n        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n        'Prefer': 'return=representation'\n      },\n      body: JSON.stringify({\n        pairing_code: code,\n        dicecloud_username: diceCloudUsername,\n        dicecloud_user_id: diceCloudUserId, // Store the actual DiceCloud user ID (Meteor ID)\n        status: 'pending'\n      })\n    });\n\n    if (response.ok) {\n      debug.log('\u2705 Discord pairing created:', code, 'for DiceCloud user:', diceCloudUserId);\n\n      // Subscribe to Realtime updates for this pairing code\n      // This will notify us immediately when the Discord bot completes the pairing\n      subscribeToRealtimePairing(code);\n\n      return { success: true, code };\n    } else {\n      const error = await response.text();\n      debug.error('\u274C Failed to create pairing:', error);\n      return { success: false, error: 'Failed to create pairing code' };\n    }\n  } catch (error) {\n    debug.error('\u274C Supabase error:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n/**\n * Check if a Discord pairing has been completed (webhook URL filled in)\n */\nasync function checkDiscordPairing(code) {\n  // Check if Supabase is configured\n  if (!isSupabaseConfigured()) {\n    return { success: false, error: 'Supabase not configured', supabaseNotConfigured: true };\n  }\n\n  try {\n    const response = await fetch(\n      `${SUPABASE_URL}/rest/v1/clouds_pairings?pairing_code=eq.${code}&select=*`,\n      {\n        headers: {\n          'apikey': SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n        }\n      }\n    );\n\n    if (response.ok) {\n      const data = await response.json();\n      if (data.length > 0) {\n        const pairing = data[0];\n        if (pairing.status === 'connected' && pairing.webhook_url) {\n          debug.log('\u2705 Discord pairing connected!');\n          return {\n            success: true,\n            connected: true,\n            webhookUrl: pairing.webhook_url,\n            serverName: pairing.discord_guild_name,\n            pairingId: pairing.id, // Return pairing ID for command polling\n            discordUserId: pairing.discord_user_id, // Return Discord user ID to link to auth_tokens\n            discordUsername: pairing.discord_username,\n            discordGlobalName: pairing.discord_global_name\n          };\n        } else {\n          return { success: true, connected: false };\n        }\n      } else {\n        return { success: false, error: 'Pairing code not found' };\n      }\n    } else {\n      return { success: false, error: 'Failed to check pairing' };\n    }\n  } catch (error) {\n    debug.error('\u274C Supabase check error:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n/**\n * Get user's synced characters from Supabase\n */\nasync function getUserCharactersFromCloud(pairingId = null) {\n  if (!isSupabaseConfigured()) {\n    debug.warn('Supabase not configured - cannot get user characters');\n    return [];\n  }\n\n  try {\n    let characters = [];\n    \n    if (pairingId) {\n      // Get characters for specific pairing\n      const response = await fetch(\n        `${SUPABASE_URL}/rest/v1/clouds_pairings?id=eq.${pairingId}&select=discord_user_id`,\n        {\n          headers: {\n            'apikey': SUPABASE_ANON_KEY,\n            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n          }\n        }\n      );\n\n      if (response.ok) {\n        const pairings = await response.json();\n        if (pairings.length > 0) {\n          const discordUserId = pairings[0].discord_user_id;\n          \n          // Get characters for this Discord user\n          const charsResponse = await fetch(\n            `${SUPABASE_URL}/rest/v1/clouds_characters?discord_user_id=eq.${discordUserId}&select=character_name,level,race,class,is_active,updated_at&order=updated_at.desc`,\n            {\n              headers: {\n                'apikey': SUPABASE_ANON_KEY,\n                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n              }\n            }\n          );\n\n          if (charsResponse.ok) {\n            characters = await charsResponse.json();\n          }\n        }\n      }\n    } else {\n      // No pairing ID - try to get from current webhook settings\n      const settings = await getDiscordWebhookSettings();\n      if (settings.pairingId) {\n        return await getUserCharactersFromCloud(settings.pairingId);\n      }\n    }\n\n    debug.log(`\uD83D\uDCCB Retrieved ${characters.length} characters from cloud`);\n    return characters;\n  } catch (error) {\n    debug.error('\u274C Error getting user characters from cloud:', error);\n    return [];\n  }\n}\n\n// ============================================================================\n// Discord Command Realtime Subscription (Discord \u2192 Extension)\n// ============================================================================\n\nlet commandRealtimeSocket = null;\nlet commandRealtimeHeartbeat = null;\nlet currentPairingId = null;\nlet commandRealtimeReconnectTimeout = null;\n\n/**\n * CORRECTED subscribeToCommandRealtime function\n * Replace the existing function in background.js with this\n */\n\nasync function subscribeToCommandRealtime(pairingId) {\n  if (!pairingId) {\n    const settings = await browserAPI.storage.local.get(['discordPairingId']);\n    pairingId = settings.discordPairingId;\n  }\n\n  if (!pairingId) {\n    debug.warn('No pairing ID available for command subscription');\n    return;\n  }\n\n  if (!isSupabaseConfigured()) {\n    debug.warn('Supabase not configured \u2014 cannot subscribe to commands');\n    return;\n  }\n\n  // If already subscribed with same pairing, skip\n  if (commandRealtimeSocket && commandRealtimeSocket.readyState === WebSocket.OPEN && currentPairingId === pairingId) {\n    debug.log('Command realtime already connected for pairing:', pairingId);\n    return;\n  }\n\n  // Tear down any existing connection first\n  unsubscribeFromCommandRealtime();\n\n  currentPairingId = pairingId;\n\n  const projectRef = SUPABASE_URL.replace('https://', '').split('.')[0];\n  const wsUrl = `wss://${projectRef}.supabase.co/realtime/v1/websocket?apikey=${SUPABASE_ANON_KEY}&vsn=1.0.0`;\n\n  debug.log('\uD83D\uDD0C Connecting to Supabase Realtime for commands, pairing:', pairingId);\n\n  try {\n    commandRealtimeSocket = new WebSocket(wsUrl);\n\n    commandRealtimeSocket.onopen = () => {\n      debug.log('\u2705 Command Realtime WebSocket connected');\n\n      // CORRECTED: Subscribe to postgres_changes for INSERT events on clouds_commands\n      const topic = `realtime:public:clouds_commands`;\n      const joinMessage = {\n        topic: topic,\n        event: 'phx_join',\n        payload: {\n          config: {\n            postgres_changes: [{\n              event: 'INSERT',  // \u2705 Listen for new commands being inserted\n              schema: 'public',\n              table: 'clouds_commands',  // \u2705 Correct table\n              filter: `pairing_id=eq.${pairingId}`  // \u2705 Only this pairing's commands\n            }]\n          }\n        },\n        ref: 'cmd_1'\n      };\n      \n      debug.log('\uD83D\uDCE4 Subscribing to postgres_changes:', JSON.stringify(joinMessage, null, 2));\n      commandRealtimeSocket.send(JSON.stringify(joinMessage));\n\n      // Start keep-alive alarm to prevent service worker termination\n      startRealtimeKeepAlive();\n\n      // Heartbeat every 30s to keep connection alive and drain pending commands\n      commandRealtimeHeartbeat = setInterval(() => {\n        if (commandRealtimeSocket && commandRealtimeSocket.readyState === WebSocket.OPEN) {\n          commandRealtimeSocket.send(JSON.stringify({\n            topic: 'phoenix',\n            event: 'heartbeat',\n            payload: {},\n            ref: 'cmd_hb_' + Date.now()\n          }));\n          // Also drain pending commands periodically in case realtime missed anything\n          drainPendingCommands();\n        }\n      }, 5000);\n\n      // Also drain any pending commands that arrived while we were disconnected\n      drainPendingCommands();\n    };\n\n    commandRealtimeSocket.onmessage = async (event) => {\n      try {\n        const message = JSON.parse(event.data);\n\n        // Log ALL raw messages for debugging\n        debug.log('\uD83D\uDCE8 RAW Realtime message:', JSON.stringify(message).substring(0, 500));\n\n        // Handle Phoenix protocol replies (subscription confirmation)\n        if (message.event === 'phx_reply') {\n          if (message.payload?.status === 'ok') {\n            debug.log('\u2705 Realtime subscription confirmed for topic:', message.topic || 'unknown');\n          } else {\n            debug.error('\u274C Realtime subscription FAILED:', message.payload?.response || message.payload);\n          }\n          return;\n        }\n\n        // Handle system messages\n        if (message.event === 'system' && message.payload?.status === 'ok') {\n          debug.log('\u2705 Realtime system ready:', message.payload?.message || 'connected');\n          return;\n        }\n\n        // \u2705 CORRECTED: Handle postgres_changes events (not broadcast)\n        if (message.event === 'postgres_changes') {\n          const payload = message.payload;\n          \n          debug.log('\uD83D\uDCE5 postgres_changes event received:', payload?.data?.type || 'unknown type');\n\n          // For INSERT events, the new record is in payload.data.record\n          if (payload?.data?.type === 'INSERT' && payload.data.record) {\n            const record = payload.data.record;\n            \n            debug.log('\uD83D\uDCE5 New command inserted! Type:', record.command_type, 'ID:', record.id);\n\n            // Only process if status is pending\n            if (record.status === 'pending') {\n              debug.log('\u26A1 Executing command:', record.command_type);\n              await executeCommand(record);\n            } else {\n              debug.log('\u23ED\uFE0F Skipping command with status:', record.status);\n            }\n          }\n          return;\n        }\n\n        // Still handle broadcast events as fallback (if you add that later)\n        if (message.event === 'broadcast') {\n          const record = message.payload?.record ?? message.payload?.new ?? message.payload;\n\n          debug.log('\uD83D\uDCE5 Broadcast received! Record:', JSON.stringify(record).substring(0, 300));\n\n          if (record && record.status === 'pending') {\n            debug.log('\uD83D\uDCE5 Realtime command received via broadcast:', record.command_type, record.id);\n            await executeCommand(record);\n          }\n        }\n      } catch (e) {\n        debug.warn('Error processing command Realtime message:', e);\n      }\n    };\n\n    commandRealtimeSocket.onerror = (error) => {\n      debug.warn('Command Realtime WebSocket error:', error);\n    };\n\n    commandRealtimeSocket.onclose = () => {\n      debug.log('\uD83D\uDD0C Command Realtime WebSocket closed');\n      if (commandRealtimeHeartbeat) {\n        clearInterval(commandRealtimeHeartbeat);\n        commandRealtimeHeartbeat = null;\n      }\n\n      // Auto-reconnect after 5 seconds if we still have a pairing\n      if (currentPairingId) {\n        debug.log('\u23F3 Scheduling command realtime reconnect in 5s...');\n        commandRealtimeReconnectTimeout = setTimeout(() => {\n          if (currentPairingId) {\n            subscribeToCommandRealtime(currentPairingId);\n          }\n        }, 5000);\n      }\n    };\n  } catch (error) {\n    debug.error('Failed to connect to command Realtime:', error);\n  }\n}\n\n/**\n * Unsubscribe from command Realtime updates\n */\nfunction unsubscribeFromCommandRealtime() {\n  // Stop keep-alive alarm\n  stopRealtimeKeepAlive();\n\n  if (commandRealtimeReconnectTimeout) {\n    clearTimeout(commandRealtimeReconnectTimeout);\n    commandRealtimeReconnectTimeout = null;\n  }\n  if (commandRealtimeSocket) {\n    commandRealtimeSocket.close();\n    commandRealtimeSocket = null;\n  }\n  if (commandRealtimeHeartbeat) {\n    clearInterval(commandRealtimeHeartbeat);\n    commandRealtimeHeartbeat = null;\n  }\n  debug.log('\uD83D\uDD07 Unsubscribed from command Realtime');\n}\n\n/**\n * Drain any pending commands that may have arrived while disconnected.\n * Called once on (re-)connect to catch anything missed.\n */\nasync function drainPendingCommands() {\n  if (!isSupabaseConfigured() || !currentPairingId) return;\n\n  try {\n    const response = await fetch(\n      `${SUPABASE_URL}/rest/v1/clouds_commands?pairing_id=eq.${currentPairingId}&status=eq.pending&order=created_at.asc&limit=10`,\n      {\n        headers: {\n          'apikey': SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n        }\n      }\n    );\n\n    if (!response.ok) {\n      debug.warn('Failed to drain pending commands:', response.status);\n      return;\n    }\n\n    const commands = await response.json();\n    if (commands.length > 0) {\n      debug.log(`\uD83D\uDCE5 Draining ${commands.length} pending command(s)`);\n      for (const command of commands) {\n        await executeCommand(command);\n      }\n    }\n  } catch (error) {\n    debug.error('Drain pending commands error:', error);\n  }\n}\n\n/**\n * Execute a command from Discord\n */\nasync function executeCommand(command) {\n  debug.log('\u26A1 Executing command:', command.command_type, command);\n\n  try {\n    // Mark as processing\n    await updateCommandStatus(command.id, 'processing');\n\n    let result;\n\n    switch (command.command_type) {\n      case 'roll':\n        result = await executeRollCommand(command);\n        break;\n\n      case 'rollhere':\n        result = await executeRollHereCommand(command);\n        break;\n\n      case 'use_action':\n        result = await executeUseActionCommand(command, 'action');\n        break;\n\n      case 'use_bonus':\n        result = await executeUseActionCommand(command, 'bonus');\n        break;\n\n      case 'end_turn':\n        result = await executeEndTurnCommand(command);\n        break;\n\n      case 'use_ability':\n        result = await executeUseAbilityCommand(command);\n        break;\n\n      case 'use':\n        // Handle /use command from Discord bot (actions, abilities, etc.)\n        result = await executeUseAbilityCommand(command);\n        break;\n\n      case 'cast':\n        result = await executeCastCommand(command);\n        break;\n\n      case 'heal':\n        result = await executeHealCommand(command);\n        break;\n\n      case 'takedamage':\n        result = await executeTakeDamageCommand(command);\n        break;\n\n      case 'rest':\n        result = await executeRestCommand(command);\n        break;\n\n      default:\n        result = { success: false, error: `Unknown command type: ${command.command_type}` };\n    }\n\n    // Mark as completed or failed\n    await updateCommandStatus(\n      command.id,\n      result.success ? 'completed' : 'failed',\n      result\n    );\n\n    debug.log('\u2705 Command executed:', command.command_type, result);\n  } catch (error) {\n    debug.error('\u274C Command execution failed:', error);\n    await updateCommandStatus(command.id, 'failed', null, error.message);\n  }\n}\n\n/**\n * Execute a rollhere command (roll dice in Discord only)\n * Uses [XdY] or [XdY+X] format\n */\nasync function executeRollHereCommand(command) {\n  const { action_name, command_data } = command;\n\n  // Get roll string from command data, default to 1d20\n  const rollString = command_data.roll_string || '1d20';\n  const rollName = action_name || command_data.roll_name || 'Roll';\n  const characterName = command_data.character_name || 'Unknown';\n\n  debug.log('\uD83C\uDFB2 Rolling in Discord:', rollString, rollName);\n\n  try {\n    // Post the roll to Discord webhook with proper payload structure\n    const payload = {\n      type: 'roll',\n      characterName: characterName,\n      rollName: rollName,\n      rollString: rollString,\n      timestamp: new Date().toISOString()\n    };\n\n    const result = await postToDiscordWebhook(payload);\n\n    if (result.success) {\n      debug.log('\u2705 Roll posted to Discord:', rollName);\n      return { success: true, message: `Rolled ${rollName} in Discord` };\n    } else {\n      debug.error('\u274C Failed to post roll to Discord:', result.error);\n      return { success: false, message: `Failed to roll in Discord: ${result.error}` };\n    }\n  } catch (error) {\n    debug.error('\u274C Error executing rollhere command:', error);\n    return { success: false, message: `Error: ${error.message}` };\n  }\n}\n\n/**\n * Execute a roll command (e.g., attack roll, save, check)\n * Note: This function is deprecated as Roll20 integration has been removed\n */\nasync function executeRollCommand(command) {\n  const { action_name } = command;\n  const rollName = action_name || 'Discord Roll';\n\n  debug.warn('\u274C Roll command not supported - Roll20 integration removed');\n  return { success: false, message: `Roll command not supported: ${rollName}` };\n}\n\n/**\n * Execute an action/bonus action use command\n * Note: This function is deprecated as Roll20 integration has been removed\n */\nasync function executeUseActionCommand(command, actionType) {\n  const { action_name } = command;\n\n  debug.warn('\u274C Use action command not supported - Roll20 integration removed');\n  return { success: false, message: `Use action command not supported: ${actionType} ${action_name}` };\n}\n\n/**\n * Execute end turn command\n * Note: This function is deprecated as Roll20 integration has been removed\n */\nasync function executeEndTurnCommand(command) {\n  debug.warn('\u274C End turn command not supported - Roll20 integration removed');\n  return { success: false, message: 'End turn command not supported' };\n}\n\n/**\n * Execute use ability command (spell, feature, etc.)\n * Note: This function is deprecated as Roll20 integration has been removed\n */\nasync function executeUseAbilityCommand(command) {\n  const { action_name } = command;\n\n  debug.warn('\u274C Use ability command not supported - Roll20 integration removed');\n  return { success: false, message: `Use ability command not supported: ${action_name}` };\n}\n\n/**\n * Execute a cast spell command from Discord\n */\nasync function executeCastCommand(command) {\n  const { action_name, command_data } = command;\n\n  try {\n    // Get character data for metamagic processing\n    const characterData = await getCharacterDataForDiscordCommand(command_data.character_name, command_data.character_id);\n    \n    if (!characterData) {\n      debug.warn(`No character data found for Discord command: ${command_data.character_name}`);\n      return { success: false, error: 'Character not found' };\n    }\n\n    debug.warn('\u274C Cast spell command not supported - Roll20 integration removed');\n    return { success: false, message: `Cast spell command not supported: ${action_name}` };\n  } catch (error) {\n    debug.error('Error executing Discord cast command:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n/**\n * Execute a heal command from Discord\n * Note: This function is deprecated as Roll20 integration has been removed\n */\nasync function executeHealCommand(command) {\n  const { command_data } = command;\n\n  debug.warn('\u274C Heal command not supported - Roll20 integration removed');\n  return {\n    success: false,\n    message: command_data.is_temp\n      ? `Temp HP command not supported`\n      : `Heal command not supported`\n  };\n}\n\n/**\n * Execute a take damage command from Discord\n * Note: This function is deprecated as Roll20 integration has been removed\n */\nasync function executeTakeDamageCommand(command) {\n  const { command_data } = command;\n\n  debug.warn('\u274C Take damage command not supported - Roll20 integration removed');\n  return {\n    success: false,\n    message: `Take damage command not supported`\n  };\n}\n\n/**\n * Execute a rest command from Discord\n * Note: This function is deprecated as Roll20 integration has been removed\n */\nasync function executeRestCommand(command) {\n  const { command_data } = command;\n\n  debug.warn('\u274C Rest command not supported - Roll20 integration removed');\n  return {\n    success: false,\n    message: `Rest command not supported`\n  };\n}\n\n/**\n * Safely parse JSON with circular reference detection\n * @param {string} jsonString - JSON string to parse\n * @param {number} maxDepth - Maximum allowed depth\n * @returns {Object|null} Parsed object or null if parsing fails\n */\nfunction safeJsonParse(jsonString, maxDepth = 20) {\n  try {\n    const seen = new WeakSet();\n    \n    return JSON.parse(jsonString, (key, value) => {\n      // Check for circular references\n      if (typeof value === 'object' && value !== null) {\n        if (seen.has(value)) {\n          debug.warn(`Circular reference detected for key: ${key}`);\n          return '[Circular Reference]';\n        }\n        seen.add(value);\n      }\n      return value;\n    });\n  } catch (error) {\n    debug.error('JSON parsing failed:', error.message);\n    return null;\n  }\n}\n\n/**\n * Get character data for Discord command processing\n */\nasync function getCharacterDataForDiscordCommand(characterName, characterId) {\n  try {\n    // First try to get active character from local storage (this is what /roll uses)\n    const result = await browserAPI.storage.local.get(['characterProfiles', 'activeCharacterId']);\n    const characterProfiles = result.characterProfiles || {};\n    const activeCharacterId = result.activeCharacterId;\n    \n    debug.log(`\uD83C\uDFAF Discord command looking for character: ${characterName}, activeCharacterId: ${activeCharacterId}`);\n    \n    // If we have an active character, use it\n    if (activeCharacterId && characterProfiles[activeCharacterId]) {\n      const activeChar = characterProfiles[activeCharacterId];\n      // Check if the active character matches the requested name (if provided)\n      if (!characterName || activeChar.character?.name === characterName || activeChar.name === characterName) {\n        debug.log(`\uD83D\uDCE5 Using active character for Discord command: ${activeChar.character?.name || activeChar.name}`);\n        return activeChar.character || activeChar;\n      }\n    }\n    \n    // Fallback: try to find character by name in local storage\n    if (characterName && characterProfiles) {\n      for (const [id, profile] of Object.entries(characterProfiles)) {\n        if (profile.type === 'dicecloud' && (profile.character?.name === characterName || profile.name === characterName)) {\n          debug.log(`\uD83D\uDCE5 Found character by name in local storage for ${characterName}`);\n          return profile.character || profile;\n        }\n      }\n    }\n    \n    // Last resort: try Supabase (but this is unlikely to work for most users)\n    if (characterId && isSupabaseConfigured()) {\n      const response = await fetch(\n        `${SUPABASE_URL}/rest/v1/raw_dicecloud_data?character_id=eq.${characterId}&select=*`,\n        {\n          headers: {\n            'apikey': SUPABASE_ANON_KEY,\n            'Content-Type': 'application/json'\n          }\n        }\n      );\n      \n      if (response.ok) {\n        const responseText = await response.text();\n        const data = safeJsonParse(responseText);\n        \n        if (data && Array.isArray(data) && data.length > 0) {\n          debug.log(`\uD83D\uDCE5 Retrieved character data from Supabase for ${characterName}`);\n          return data[0].character_data;\n        }\n      }\n    }\n\n    debug.warn(`No character data found for ${characterName || 'unknown character'}`);\n    return null;\n  } catch (error) {\n    debug.error(`Error getting character data for ${characterName}:`, error);\n    \n    // Re-throw with more context if it's a stack overflow\n    if (error.message && error.message.includes('Maximum call stack size exceeded')) {\n      debug.error('Stack overflow detected in character data processing');\n      return null;\n    }\n    \n    return null;\n  }\n}\n\n/**\n * Update command status in Supabase\n */\nasync function updateCommandStatus(commandId, status, result = null, errorMessage = null) {\n  if (!isSupabaseConfigured()) return;\n\n  try {\n    const update = {\n      status: status,\n      processed_at: new Date().toISOString()\n    };\n\n    if (result) {\n      update.result = result;\n    }\n\n    if (errorMessage) {\n      update.error_message = errorMessage;\n    }\n\n    const response = await fetch(\n      `${SUPABASE_URL}/rest/v1/clouds_commands?id=eq.${commandId}`,\n      {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'apikey': SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n        },\n        body: JSON.stringify(update)\n      }\n    );\n\n    if (!response.ok) {\n      debug.warn('Failed to update command status:', response.status);\n    }\n  } catch (error) {\n    debug.error('Error updating command status:', error);\n  }\n}\n\n/**\n * Store pairing ID for command polling\n */\nasync function storePairingId(pairingId) {\n  await browserAPI.storage.local.set({ discordPairingId: pairingId });\n  debug.log('Stored pairing ID:', pairingId);\n}\n\n/**\n * Cleanup old Discord commands periodically\n */\nasync function cleanupDiscordCommands() {\n  try {\n    if (!isSupabaseConfigured()) {\n      debug.log('Skipping command cleanup - Supabase not configured');\n      return;\n    }\n\n    const response = await fetch(\n      `${SUPABASE_URL}/rest/v1/rpc/cleanup_and_maintain_commands`,\n      {\n        method: 'POST',\n        headers: {\n          'apikey': SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n          'Content-Type': 'application/json'\n        }\n      }\n    );\n\n    if (response.ok) {\n      const result = await response.json();\n      debug.log('\uD83E\uDDF9 Command cleanup completed:', result);\n    } else {\n      debug.warn('Failed to run command cleanup:', response.status);\n    }\n  } catch (error) {\n    debug.error('Error during command cleanup:', error);\n  }\n}\n\n/**\n * Get command health metrics for monitoring\n */\nasync function getCommandHealthMetrics() {\n  try {\n    if (!isSupabaseConfigured()) {\n      return null;\n    }\n\n    const response = await fetch(\n      `${SUPABASE_URL}/rest/v1/rpc/get_command_health_metrics`,\n      {\n        method: 'POST',\n        headers: {\n          'apikey': SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n          'Content-Type': 'application/json'\n        }\n      }\n    );\n\n    if (response.ok) {\n      const metrics = await response.json();\n      debug.log('\uD83D\uDCCA Command health metrics:', metrics);\n      \n      // If cleanup is needed, run it\n      if (metrics.cleanup_needed && metrics.length > 0) {\n        debug.log('\uD83E\uDDF9 Cleanup needed, running automatic cleanup...');\n        await cleanupDiscordCommands();\n      }\n      \n      return metrics[0] || metrics;\n    } else {\n      debug.warn('Failed to get command health metrics:', response.status);\n      return null;\n    }\n  } catch (error) {\n    debug.error('Error getting command health metrics:', error);\n    return null;\n  }\n}\n\n// Set up periodic cleanup (every 15 minutes)\nsetInterval(async () => {\n  try {\n    await cleanupDiscordCommands();\n  } catch (error) {\n    debug.error('Periodic cleanup failed:', error);\n  }\n}, 15 * 60 * 1000); // 15 minutes\n\n// Set up health check (every 5 minutes)\nsetInterval(async () => {\n  try {\n    await getCommandHealthMetrics();\n  } catch (error) {\n    debug.error('Health check failed:', error);\n  }\n}, 5 * 60 * 1000); // 5 minutes\n\n// Auto-start command realtime subscription when extension loads and Discord is configured\n(async () => {\n  try {\n    const settings = await browserAPI.storage.local.get(['discordWebhookEnabled', 'discordPairingId', 'discordWebhookUrl']);\n    debug.log('\uD83D\uDD04 Auto-start check - webhookEnabled:', settings.discordWebhookEnabled, 'pairingId:', settings.discordPairingId ? 'set' : 'not set', 'webhookUrl:', settings.discordWebhookUrl ? 'set' : 'not set');\n    \n    // Start Discord connection if EITHER webhook is enabled OR we have a pairing ID\n    const hasWebhookIntegration = settings.discordWebhookEnabled && settings.discordWebhookUrl;\n    const hasPairingIntegration = settings.discordPairingId;\n    \n    if (hasWebhookIntegration || hasPairingIntegration) {\n      debug.log('\u2705 Discord integration detected, auto-starting command realtime subscription...');\n      await subscribeToCommandRealtime(settings.discordPairingId);\n    } else {\n      debug.log('\u23ED\uFE0F Skipping auto-start - no Discord integration configured (webhook:', hasWebhookIntegration, 'pairing:', hasPairingIntegration);\n    }\n  } catch (error) {\n    debug.warn('Failed to auto-start command realtime:', error);\n  }\n})();\n\n// ============================================================================\n// Turn Posting via Supabase (for Pip Bot to add buttons)\n// ============================================================================\n\n/**\n * Post turn data to Supabase for Pip Bot to pick up and post with buttons\n * This enables interactive buttons on Discord messages (webhooks can't do this)\n */\nasync function postTurnToSupabase(payload) {\n  // Check if Supabase is configured\n  if (!isSupabaseConfigured()) {\n    // Fall back to webhook if Supabase not configured\n    debug.log('Supabase not configured, falling back to webhook');\n    return await postToDiscordWebhook(payload);\n  }\n\n  // Get pairing ID\n  const settings = await browserAPI.storage.local.get(['discordPairingId']);\n  if (!settings.discordPairingId) {\n    debug.warn('No pairing ID, falling back to webhook');\n    return await postToDiscordWebhook(payload);\n  }\n\n  const { type, characterName, round, actions, initiative } = payload;\n\n  // Map payload type to event type\n  const eventTypeMap = {\n    turnStart: 'turn_start',\n    turnEnd: 'turn_end',\n    actionUpdate: 'action_update',\n    combatStart: 'combat_start',\n    roundChange: 'round_change'\n  };\n\n  const eventType = eventTypeMap[type] || type;\n\n  try {\n    // Get character data for available actions\n    const characterData = await getCharacterData();\n    const availableActions = characterData ? extractAvailableActions(characterData) : [];\n\n    const turnData = {\n      pairing_id: settings.discordPairingId,\n      event_type: eventType,\n      character_name: characterName,\n      character_id: characterData?.id || null,\n      round_number: round || null,\n      initiative: initiative || null,\n      action_available: actions ? !actions.action : true,\n      bonus_available: actions ? !actions.bonus : true,\n      movement_available: actions ? !actions.movement : true,\n      reaction_available: actions ? !actions.reaction : true,\n      available_actions: availableActions,\n      status: 'pending'\n    };\n\n    const response = await fetch(`${SUPABASE_URL}/rest/v1/clouds_turns`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'apikey': SUPABASE_ANON_KEY,\n        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n        'Prefer': 'return=representation'\n      },\n      body: JSON.stringify(turnData)\n    });\n\n    if (response.ok) {\n      debug.log('\u2705 Turn posted to Supabase for Pip Bot:', eventType);\n      return { success: true };\n    } else {\n      const error = await response.text();\n      debug.warn('\u274C Failed to post turn to Supabase:', error);\n      // Fall back to webhook\n      return await postToDiscordWebhook(payload);\n    }\n  } catch (error) {\n    debug.error('\u274C Error posting turn to Supabase:', error);\n    // Fall back to webhook\n    return await postToDiscordWebhook(payload);\n  }\n}\n\n/**\n * Extract available actions from character data for Discord buttons\n * Returns array of { name, type, roll } objects\n */\nfunction extractAvailableActions(characterData) {\n  const actions = [];\n\n  // Extract attacks\n  if (characterData.attacks) {\n    for (const attack of characterData.attacks) {\n      actions.push({\n        name: attack.name,\n        type: 'action',\n        roll: attack.attackBonus ? `1d20+${attack.attackBonus}` : '1d20',\n        damage: attack.damage\n      });\n    }\n  }\n\n  // Extract spells (cantrips and prepared)\n  if (characterData.spells) {\n    for (const spell of characterData.spells) {\n      if (spell.prepared || spell.level === 0) {\n        actions.push({\n          name: spell.name,\n          type: spell.level === 0 ? 'cantrip' : 'spell',\n          level: spell.level,\n          actionType: spell.castingTime?.includes('bonus') ? 'bonus' : 'action'\n        });\n      }\n    }\n  }\n\n  // Extract common actions\n  actions.push(\n    { name: 'Dodge', type: 'action', builtin: true },\n    { name: 'Dash', type: 'action', builtin: true },\n    { name: 'Disengage', type: 'action', builtin: true },\n    { name: 'Help', type: 'action', builtin: true },\n    { name: 'Hide', type: 'action', builtin: true, roll: '1d20+stealth' }\n  );\n\n  return actions;\n}\n\n// ============================================================================\n// Native Messaging for Installer Communication\n// ============================================================================\n\nlet installerPort = null;\n\n/**\n * Connect to installer via native messaging\n */\nasync function connectToInstaller() {\n  try {\n    if (installerPort) {\n      return installerPort;\n    }\n\n    // Try to connect to the installer native messaging host\n    installerPort = browserAPI.runtime.connectNative('com.owlcloud.installer');\n    \n    installerPort.onMessage.addListener((message) => {\n      debug.log('Received message from installer:', message);\n      handleInstallerMessage(message);\n    });\n    \n    installerPort.onDisconnect.addListener(() => {\n      debug.log('Disconnected from installer');\n      installerPort = null;\n    });\n\n    // Send a ping to test connection\n    installerPort.postMessage({ type: 'ping' });\n    \n    debug.log('\u2705 Connected to installer via native messaging');\n    return installerPort;\n  } catch (error) {\n    debug.warn('Failed to connect to installer:', error);\n    return null;\n  }\n}\n\n/**\n * Handle messages from installer\n */\nfunction handleInstallerMessage(message) {\n  switch (message.type) {\n    case 'pong':\n      debug.log('\u2705 Installer is available, requesting pairing code...');\n      // After confirming connection, request pairing code\n      if (installerPort) {\n        installerPort.postMessage({ type: 'getPairingCode' });\n      }\n      break;\n\n    case 'pairingCode':\n      if (message.code) {\n        debug.log('\uD83D\uDCE5 Received pairing code from installer:', message.code);\n        // Store the pairing code and start the pairing process\n        handleInstallerPairingCode(message.code, message.username);\n      } else {\n        debug.log('No pairing code available from installer (code is null)');\n      }\n      break;\n\n    default:\n      debug.warn('Unknown message type from installer:', message.type);\n  }\n}\n\n/**\n * Handle pairing code received from installer\n * @param {string} code - The pairing code\n * @param {string} installerUsername - Optional username from installer\n */\nasync function handleInstallerPairingCode(code, installerUsername = null) {\n  try {\n    // Store the pairing code\n    await browserAPI.storage.local.set({\n      installerPairingCode: code,\n      pairingSource: 'installer'\n    });\n\n    // Get DiceCloud username - prefer installer-provided, fall back to local\n    let diceCloudUsername = installerUsername;\n    if (!diceCloudUsername) {\n      const loginStatus = await checkLoginStatus();\n      diceCloudUsername = loginStatus.username || 'DiceCloud User';\n    }\n\n    debug.log('\uD83D\uDCE4 Creating Discord pairing with code:', code, 'username:', diceCloudUsername);\n\n    // Create pairing in Supabase\n    const result = await createDiscordPairing(code, diceCloudUsername);\n\n    if (result.success) {\n      debug.log('\u2705 Pairing created from installer code');\n\n      // Notify popup that pairing is in progress\n      broadcastToPopup({\n        action: 'installerPairingStarted',\n        code: code\n      });\n    } else {\n      debug.error('Failed to create pairing from installer code:', result.error);\n    }\n  } catch (error) {\n    debug.error('Error handling installer pairing code:', error);\n  }\n}\n\n/**\n * Broadcast message to popup if it's open\n */\nasync function broadcastToPopup(message) {\n  try {\n    // Try to send to popup via runtime message\n    await browserAPI.runtime.sendMessage(message);\n  } catch (error) {\n    // Popup might not be open, that's okay\n    debug.log('Popup not available for broadcast');\n  }\n}\n\n// Auto-connect to installer when extension loads\n(async () => {\n  setTimeout(async () => {\n    await connectToInstaller();\n  }, 2000); // Wait 2 seconds for extension to fully initialize\n})();\n"],
  "mappings": ";;AAMO,MAAM,eAAe;AACrB,MAAM,oBAAoB;AAK1B,MAAM,SAAS;AAAA;AAAA,IAEpB,aAAa;AAAA,IACb,UAAU;AAAA;AAAA,IAGV,qBAAqB;AAAA,IACrB,sBAAsB;AAAA,IACtB,uBAAuB;AAAA;AAAA,EACzB;AAKO,MAAM,kBAAkB;AAAA,IAC7B,UAAU;AAAA,MACR,gBAAgB,OAAO;AAAA,MACvB,cAAc,OAAO;AAAA,MACrB,iBAAiB;AAAA,IACnB;AAAA,IACA,WAAW;AAAA,MACT,gBAAgB,OAAO;AAAA,MACvB,cAAc,OAAO;AAAA,MACrB,iBAAiB;AAAA,IACnB;AAAA,IACA,YAAY;AAAA,MACV,gBAAgB,OAAO;AAAA,MACvB,cAAc,OAAO;AAAA,MACrB,iBAAiB;AAAA,IACnB;AAAA,EACF;;;ACjCA,MAAM,QAAQ;AAAA,IACZ,KAAK,QAAQ,IAAI,KAAK,OAAO;AAAA,IAC7B,MAAM,QAAQ,KAAK,KAAK,OAAO;AAAA,IAC/B,OAAO,QAAQ,MAAM,KAAK,OAAO;AAAA,IACjC,MAAM,QAAQ,KAAK,KAAK,OAAO;AAAA,IAC/B,OAAO,QAAQ,MAAM,KAAK,OAAO;AAAA,IACjC,UAAU,QAAQ,SAAS,KAAK,OAAO;AAAA,IACvC,OAAO,QAAQ,MAAM,KAAK,OAAO;AAAA,IACjC,MAAM,QAAQ,KAAK,KAAK,OAAO;AAAA,IAC/B,SAAS,QAAQ,QAAQ,KAAK,OAAO;AAAA,IACrC,WAAW,MAAM;AAAA,EACnB;AAKA,QAAM,IAAI,yCAAyC;AAKnD,MAAM,aAAc,OAAO,YAAY,eAAe,QAAQ,UAAW,UAAU;AAMnF,MAAM,UAAU;AAAA,IACd,MAAM,IAAI,MAAM;AACd,aAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,YAAI;AACF,gBAAM,SAAS,WAAW,QAAQ,MAAM,IAAI,MAAM,CAAC,UAAU;AAC3D,gBAAI,WAAW,QAAQ,WAAW;AAChC,qBAAO,IAAI,MAAM,WAAW,QAAQ,UAAU,OAAO,CAAC;AAAA,YACxD,OAAO;AACL,sBAAQ,KAAK;AAAA,YACf;AAAA,UACF,CAAC;AAED,cAAI,UAAU,OAAO,OAAO,SAAS,YAAY;AAC/C,mBAAO,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,UACnC;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AAAA,IACH;AAAA,IAEA,MAAM,IAAI,OAAO;AACf,aAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,YAAI;AACF,gBAAM,SAAS,WAAW,QAAQ,MAAM,IAAI,OAAO,MAAM;AACvD,gBAAI,WAAW,QAAQ,WAAW;AAChC,qBAAO,IAAI,MAAM,WAAW,QAAQ,UAAU,OAAO,CAAC;AAAA,YACxD,OAAO;AACL,sBAAQ;AAAA,YACV;AAAA,UACF,CAAC;AAED,cAAI,UAAU,OAAO,OAAO,SAAS,YAAY;AAC/C,mBAAO,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,UACnC;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AAAA,IACH;AAAA,IAEA,MAAM,OAAO,MAAM;AACjB,aAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,YAAI;AACF,gBAAM,SAAS,WAAW,QAAQ,MAAM,OAAO,MAAM,MAAM;AACzD,gBAAI,WAAW,QAAQ,WAAW;AAChC,qBAAO,IAAI,MAAM,WAAW,QAAQ,UAAU,OAAO,CAAC;AAAA,YACxD,OAAO;AACL,sBAAQ;AAAA,YACV;AAAA,UACF,CAAC;AAED,cAAI,UAAU,OAAO,OAAO,SAAS,YAAY;AAC/C,mBAAO,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,UACnC;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF;AAGA,MAAI,cAAc,WAAW,WAAW,WAAW,QAAQ,WAAW;AACpE,eAAW,QAAQ,UAAU,YAAY,CAAC,SAAS,SAAS;AAC1D,UAAI,SAAS;AAAS;AACtB,UAAI,QAAQ,gBAAgB;AAC1B,cAAM,SAAS,QAAQ,eAAe;AACtC,cAAM,SAAS,QAAQ,eAAe;AACtC,cAAM,IAAI,oDAA6C,EAAE,QAAQ,CAAC,CAAC,QAAQ,QAAQ,CAAC,CAAC,OAAO,CAAC;AAAA,MAC/F;AACA,UAAI,QAAQ,qBAAqB;AAC/B,cAAM,IAAI,6DAAsD,EAAE,KAAK,QAAQ,oBAAoB,UAAU,KAAK,QAAQ,oBAAoB,SAAS,CAAC;AAAA,MAC1J;AAAA,IACF,CAAC;AACD,UAAM,IAAI,8DAAkD;AAAA,EAC9D;AAGA,GAAC,YAAY;AACX,QAAI;AACF,YAAM,iBAAiB,MAAM,QAAQ,IAAI,CAAC,kBAAkB,mBAAmB,gBAAgB,YAAY,qBAAqB,CAAC;AACjI,YAAM,IAAI,sDAA+C;AAAA,QACvD,UAAU,CAAC,CAAC,eAAe;AAAA,QAC3B,aAAa,eAAe,iBAAiB,eAAe,eAAe,SAAS;AAAA,QACpF,YAAY,eAAe,iBAAiB,eAAe,eAAe,UAAU,GAAG,EAAE,IAAI,QAAQ;AAAA,QACrG,UAAU,eAAe;AAAA,QACzB,iBAAiB,eAAe;AAAA,QAChC,cAAc,eAAe;AAAA,QAC7B,qBAAqB,eAAe;AAAA,QACpC,SAAS,OAAO,KAAK,cAAc;AAAA,MACrC,CAAC;AAGD,UAAI,eAAe,kBAAkB,CAAC,eAAe,qBAAqB;AACxE,cAAM,IAAI,uDAAkD;AAG5D,YAAI,eAAe,cAAc;AAC/B,gBAAM,aAAa,IAAI,KAAK,eAAe,YAAY;AACvD,gBAAM,MAAM,oBAAI,KAAK;AAErB,cAAI,CAAC,MAAM,WAAW,QAAQ,CAAC,KAAK,MAAM,YAAY;AACpD,kBAAM,IAAI,wCAAmC;AAAA,UAC/C,WAAW,MAAM,WAAW,QAAQ,CAAC,GAAG;AACtC,kBAAM,KAAK,0DAAgD;AAC3D,kBAAM,QAAQ,OAAO,cAAc;AAAA,UACrC,OAAO;AACL,kBAAM,KAAK,8CAAyC;AACpD,kBAAM,OAAO;AAAA,UACf;AAAA,QACF;AAAA,MACF,WAAW,eAAe,qBAAqB;AAC7C,cAAM,IAAI,6DAAmD;AAAA,MAC/D,OAAO;AACL,cAAM,IAAI,0CAAmC;AAAA,MAC/C;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,oCAAoC,KAAK;AAAA,IACvD;AAAA,EACF,GAAG;AAGH,MAAM,YAAY,OAAO,YAAY;AACrC,QAAM,IAAI,8CAA8C,YAAY,YAAY,QAAQ;AAGxF,MAAI,CAAC,aAAa,OAAO,WAAW,OAAO,QAAQ,WAAW;AAC5D,WAAO,QAAQ,UAAU,YAAY,MAAM;AACzC,YAAM,IAAI,uDAAgD;AAAA,IAE5D,CAAC;AAAA,EACH;AAEA,MAAI,CAAC,aAAa,OAAO,WAAW,OAAO,QAAQ,mBAAmB;AACpE,WAAO,QAAQ,kBAAkB,YAAY,MAAM;AACjD,YAAM,IAAI,iDAAuC;AAAA,IACnD,CAAC;AAAA,EACH;AAEA,MAAI,CAAC,aAAa,OAAO,WAAW,OAAO,QAAQ,WAAW;AAC5D,WAAO,QAAQ,UAAU,YAAY,MAAM;AACzC,YAAM,IAAI,yCAAkC;AAAA,IAC9C,CAAC;AAAA,EACH;AAKA,MAAM,2BAA2B;AAGjC,MAAI,WAAW,QAAQ;AACrB,eAAW,OAAO,QAAQ,YAAY,OAAO,UAAU;AACrD,UAAI,MAAM,SAAS,0BAA0B;AAC3C,cAAM,IAAI,4CAAuC;AAGjD,cAAM,WAAW,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,yBAAyB,oBAAoB,mBAAmB,CAAC;AACtH,cAAM,wBAAwB,SAAS,yBAAyB,SAAS;AACzE,cAAM,wBAAwB,SAAS;AAEvC,YAAI,CAAC,yBAAyB,CAAC,uBAAuB;AACpD,gBAAM,IAAI,oEAA0D;AACpE;AAAA,QACF;AAGA,YAAI,CAAC,yBAAyB,sBAAsB,eAAe,UAAU,MAAM;AACjF,gBAAM,IAAI,mDAA4C;AACtD,gBAAM,2BAA2B,SAAS,gBAAgB;AAAA,QAC5D,OAAO;AACL,gBAAM,IAAI,kCAA6B;AAAA,QACzC;AAGA,6BAAqB;AAAA,MACvB;AAAA,IACF,CAAC;AACD,UAAM,IAAI,+DAAmD;AAG7D,eAAW,OAAO,QAAQ,YAAY,CAAC,UAAU;AAC/C,UAAI,MAAM,SAAS,aAAa;AAC9B,cAAM,IAAI,sCAA+B;AAAA,MAC3C;AAAA,IACF,CAAC;AAAA,EACH;AAKA,WAAS,yBAAyB;AAChC,QAAI,WAAW,QAAQ;AAIrB,iBAAW,OAAO,OAAO,0BAA0B,EAAE,iBAAiB,EAAE,CAAC;AACzE,YAAM,IAAI,0CAAqC;AAAA,IACjD;AAAA,EACF;AAKA,WAAS,wBAAwB;AAC/B,QAAI,WAAW,QAAQ;AACrB,iBAAW,OAAO,MAAM,wBAAwB;AAChD,YAAM,IAAI,0CAAqC;AAAA,IACjD;AAAA,EACF;AAEA,MAAI,oBAAoB;AAMxB,WAAS,uBAAuB,aAAa,KAAO;AAClD,QAAI,mBAAmB;AACrB,oBAAc,iBAAiB;AAAA,IACjC;AAEA,UAAM,IAAI,8CAAuC,YAAY,IAAI;AAGjE,QAAI,OAAO,QAAQ;AACjB,aAAO,OAAO,OAAO,aAAa,EAAE,gBAAgB,aAAa,IAAM,CAAC;AAAA,IAE1E,OAAO;AAEL,0BAAoB,YAAY,MAAM;AACpC,cAAM,IAAI,0CAAmC;AAAA,MAC/C,GAAG,IAAK;AAER,iBAAW,MAAM;AACf,YAAI,mBAAmB;AACrB,wBAAc,iBAAiB;AAC/B,8BAAoB;AACpB,gBAAM,IAAI,uCAAgC;AAAA,QAC5C;AAAA,MACF,GAAG,UAAU;AAAA,IACf;AAAA,EACF;AAKA,WAAS,gBAAgB;AACvB,QAAI,mBAAmB;AACrB,oBAAc,iBAAiB;AAC/B,0BAAoB;AAAA,IACtB;AACA,QAAI,OAAO,QAAQ;AACjB,aAAO,OAAO,MAAM,WAAW;AAAA,IACjC;AACA,UAAM,IAAI,8BAAuB;AAAA,EACnC;AACA,MAAI,WAAW;AACb,UAAM,IAAI,4DAAqD;AAG/D,QAAI;AACF,YAAM,WAAW,WAAW,QAAQ,YAAY;AAChD,YAAM,IAAI,+CAA0C,SAAS,OAAO;AAAA,IACtE,SAAS,OAAO;AACd,YAAM,MAAM,0CAAqC,KAAK;AAAA,IACxD;AAGA,QAAI;AACF,iBAAW,QAAQ,MAAM,IAAI,CAAC,MAAM,GAAG,CAAC,WAAW;AACjD,YAAI,WAAW,QAAQ,WAAW;AAChC,gBAAM,MAAM,iCAA4B,WAAW,QAAQ,SAAS;AAAA,QACtE,OAAO;AACL,gBAAM,IAAI,gCAA2B;AAAA,QACvC;AAAA,MACF,CAAC;AAAA,IACH,SAAS,OAAO;AACd,YAAM,MAAM,sCAAiC,KAAK;AAAA,IACpD;AAAA,EACF;AAEA,MAAM,WAAW;AAGjB,aAAW,QAAQ,UAAU,YAAY,CAAC,SAAS,QAAQ,iBAAiB;AAC1E,UAAM,IAAI,gCAAgC,OAAO;AACjD,UAAM,IAAI,mBAAmB,MAAM;AAGnC,QAAI,OAAO,OAAO,QAAQ,WAAW,oBAAoB;AACvD,YAAM,IAAI,mFAA4E;AACtF,aAAO;AAAA,IACT;AAIA,KAAC,YAAY;AACX,UAAI;AACF,YAAI;AAEJ,gBAAQ,QAAQ,QAAQ;AAAA,UACtB,KAAK;AACH,kBAAM,mBAAmB,QAAQ,MAAM,QAAQ,MAAM;AAGrD,gBAAI;AACF,kBAAI,OAAO,yBAAyB,aAAa;AAC/C,sBAAM,kBAAkB,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,yBAAyB,eAAe,CAAC;AACrG,sBAAM,iBAAiB,QAAQ,eAAe,gBAAgB,yBAAyB,gBAAgB;AACvG,oBAAI,gBAAgB;AAClB,wBAAM,IAAI,kEAAwD;AAClE,wBAAM,sBAAsB,QAAQ,MAAM,QAAQ,WAAW;AAAA,gBAC/D;AAAA,cACF;AAAA,YACF,SAAS,WAAW;AAClB,oBAAM,KAAK,uDAA6C,UAAU,OAAO;AAAA,YAC3E;AACA,uBAAW,EAAE,SAAS,KAAK;AAC3B;AAAA,UAEF,KAAK,wBAAwB;AAE3B,kBAAM,aAAa,MAAM,sBAAsB,QAAQ,eAAe,QAAQ,WAAW;AACzF,uBAAW;AACX;AAAA,UACF;AAAA,UAEA,KAAK,sBAAsB;AAEzB,kBAAM,aAAa,MAAM,6BAA6B,QAAQ,aAAa,QAAQ,KAAK;AACxF,uBAAW;AACX;AAAA,UACF;AAAA,UAEA,KAAK,oCAAoC;AAEvC,kBAAM,cAAc,MAAM,iCAAiC,QAAQ,eAAe,QAAQ,WAAW;AACrG,uBAAW;AACX;AAAA,UACF;AAAA,UAEA,KAAK,qBAAqB;AAExB,kBAAM,cAAc,MAAM,sBAAsB,QAAQ,KAAK,QAAQ,KAAK;AAC1E,uBAAW;AACX;AAAA,UACF;AAAA,UAEA,KAAK,oBAAoB;AACvB,kBAAM,OAAO,MAAM,iBAAiB,QAAQ,WAAW;AACvD,uBAAW,EAAE,SAAS,MAAM,KAAK;AACjC;AAAA,UACF;AAAA,UAEA,KAAK,gCAAgC;AAEnC,kBAAM,OAAO,MAAM,6BAA6B,QAAQ,WAAW;AACnE,uBAAW,EAAE,SAAS,MAAM,KAAK;AACjC;AAAA,UACF;AAAA,UAEA,KAAK,2BAA2B;AAC9B,kBAAM,WAAW,MAAM,wBAAwB;AAC/C,uBAAW,EAAE,SAAS,MAAM,SAAS;AACrC;AAAA,UACF;AAAA,UAEA,KAAK;AACH,kBAAM,mBAAmB,QAAQ,WAAW;AAC5C,uBAAW,EAAE,SAAS,KAAK;AAC3B;AAAA,UAEF,KAAK,sBAAsB;AACzB,kBAAM,YAAY,MAAM,mBAAmB;AAC3C,uBAAW,EAAE,SAAS,MAAM,UAAU;AACtC;AAAA,UACF;AAAA,UAEA,KAAK;AACH,kBAAM,mBAAmB,QAAQ,WAAW;AAC5C,uBAAW,EAAE,SAAS,KAAK;AAC3B;AAAA,UAEF,KAAK;AACH,kBAAM,yBAAyB,QAAQ,WAAW;AAClD,uBAAW,EAAE,SAAS,KAAK;AAC3B;AAAA,UAEF,KAAK,oBAAoB;AACvB,kBAAM,WAAW,MAAM,iBAAiB,QAAQ,UAAU,QAAQ,QAAQ;AAC1E,uBAAW,EAAE,SAAS,MAAM,SAAS;AACrC;AAAA,UACF;AAAA,UAEA,KAAK,eAAe;AAClB,kBAAM,YAAY,QAAQ,OAAO,QAAQ,QAAQ,QAAQ,cAAc,QAAQ,QAAQ;AACvF,uBAAW,EAAE,SAAS,KAAK;AAC3B;AAAA,UACF;AAAA,UAEA,KAAK,eAAe;AAClB,kBAAM,QAAQ,MAAM,YAAY;AAChC,uBAAW,EAAE,SAAS,MAAM,MAAM;AAClC;AAAA,UACF;AAAA,UAEA,KAAK,eAAe;AAClB,kBAAM,WAAW,WAAW,QAAQ,YAAY;AAChD,uBAAW,EAAE,SAAS,MAAM,SAAS;AACrC;AAAA,UACF;AAAA,UAEA,KAAK;AACH,kBAAM,OAAO;AACb,uBAAW,EAAE,SAAS,KAAK;AAC3B;AAAA,UAGF,KAAK,oBAAoB;AACvB,gBAAI,QAAQ,OAAO;AACjB,oBAAM,IAAI,iDAA0C,QAAQ,KAAK;AACjE,kBAAI;AACF,sBAAM,kBAAkB,MAAM,WAAW,KAAK,YAAY,QAAQ,OAAO;AAAA,kBACvE,QAAQ;AAAA,gBACV,CAAC;AACD,sBAAM,IAAI,oDAA6C,eAAe;AACtE,2BAAW,EAAE,SAAS,MAAM,MAAM,gBAAgB;AAAA,cACpD,SAAS,OAAO;AACd,sBAAM,MAAM,8CAAyC,KAAK;AAC1D,2BAAW,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,cACpD;AAAA,YACF,OAAO;AACL,yBAAW,EAAE,SAAS,OAAO,OAAO,oBAAoB;AAAA,YAC1D;AACA;AAAA,UACF;AAAA,UAIA,KAAK,oBAAoB;AACvB,kBAAM,cAAc,MAAM,iBAAiB;AAC3C,uBAAW,EAAE,SAAS,MAAM,GAAG,YAAY;AAC3C;AAAA,UACF;AAAA,UAEA,KAAK,wBAAwB;AAC3B,kBAAM,gBAAgB,MAAM,qBAAqB,QAAQ,MAAM,QAAQ,UAAU,QAAQ,eAAe;AACxG,uBAAW;AACX;AAAA,UACF;AAAA,UAEA,KAAK,uBAAuB;AAC1B,kBAAM,cAAc,MAAM,oBAAoB,QAAQ,IAAI;AAC1D,uBAAW;AACX;AAAA,UACF;AAAA,UAEA,KAAK,qBAAqB;AAExB,kBAAM,UAAU,QAAQ,YAAY,SAAY,QAAQ,UAAU,CAAC,CAAC,QAAQ;AAC5E,kBAAM,IAAI,uCAAgC;AAAA,cACxC,YAAY,QAAQ,aAAa,GAAG,QAAQ,WAAW,UAAU,GAAG,EAAE,CAAC,QAAQ;AAAA,cAC/E;AAAA,cACA,YAAY,QAAQ;AAAA,cACpB,WAAW,QAAQ;AAAA,YACrB,CAAC;AACD,kBAAM,0BAA0B,QAAQ,YAAY,SAAS,QAAQ,UAAU;AAE/E,gBAAI,QAAQ,WAAW;AACrB,iCAAmB,QAAQ;AAC3B,oBAAM,WAAW,QAAQ,MAAM,IAAI;AAAA,gBACjC,kBAAkB,QAAQ;AAAA,gBAC1B,kBAAkB,QAAQ;AAAA,cAC5B,CAAC;AAED,yCAA2B,QAAQ,SAAS;AAAA,YAC9C;AAEA,gBAAI,QAAQ,iBAAiB,QAAQ,kBAAkB,QAAQ;AAC7D,oBAAM;AAAA,gBACJ,QAAQ;AAAA,gBACR,QAAQ;AAAA,gBACR,QAAQ;AAAA,cACV;AAAA,YACF;AACA,uBAAW,EAAE,SAAS,KAAK;AAC3B;AAAA,UACF;AAAA,UAEA,KAAK,qBAAqB;AACxB,kBAAM,WAAW,MAAM,0BAA0B;AAGjD,gBAAI,SAAS,WAAW,SAAS,YAAY;AAC3C,oBAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,kBAAkB,CAAC;AACtE,kBAAI,OAAO,oBAAoB,qBAAqB,GAAG;AACrD,oBAAI;AACF,wBAAM,kBAAkB,MAAM;AAAA,oBAC5B,GAAG,YAAY,kCAAkC,OAAO,gBAAgB;AAAA,oBACxE;AAAA,sBACE,SAAS;AAAA,wBACP,UAAU;AAAA,wBACV,iBAAiB,UAAU,iBAAiB;AAAA,sBAC9C;AAAA,oBACF;AAAA,kBACF;AACA,sBAAI,gBAAgB,IAAI;AACtB,0BAAM,WAAW,MAAM,gBAAgB,KAAK;AAC5C,wBAAI,SAAS,SAAS,KAAK,SAAS,CAAC,EAAE,iBAAiB;AAEtD,4BAAM;AAAA,wBACJ,SAAS,CAAC,EAAE;AAAA,wBACZ,SAAS,CAAC,EAAE;AAAA,wBACZ,SAAS,CAAC,EAAE;AAAA,sBACd;AAAA,oBACF;AAAA,kBACF;AAAA,gBACF,SAAS,GAAG;AACV,wBAAM,KAAK,wDAAwD,CAAC;AAAA,gBACtE;AAAA,cACF;AAAA,YACF;AAEA,uBAAW,EAAE,SAAS,MAAM,GAAG,SAAS;AACxC;AAAA,UACF;AAAA,UAEA,KAAK,sBAAsB;AAEzB,gBAAI,mBAAmB,QAAQ;AAC/B,gBAAI,CAAC,kBAAkB;AACrB,oBAAM,WAAW,MAAM,0BAA0B;AACjD,iCAAmB,SAAS;AAAA,YAC9B;AACA,kBAAM,aAAa,MAAM,mBAAmB,gBAAgB;AAC5D,uBAAW;AACX;AAAA,UACF;AAAA,UAEA,KAAK,qBAAqB;AAExB,kBAAM,aAAa,MAAM,2BAA2B,QAAQ,SAAS;AACrE,uBAAW,EAAE,SAAS,MAAM,WAAW;AACvC;AAAA,UACF;AAAA,UAEA,KAAK,mCAAmC;AAEtC,gBAAI,eAAe;AACjB,4BAAc,YAAY,EAAE,MAAM,iBAAiB,CAAC;AACpD,yBAAW,EAAE,SAAS,MAAM,SAAS,wCAAwC;AAAA,YAC/E,OAAO;AAEL,oBAAM,OAAO,MAAM,mBAAmB;AACtC,kBAAI,MAAM;AACR,qBAAK,YAAY,EAAE,MAAM,iBAAiB,CAAC;AAC3C,2BAAW,EAAE,SAAS,MAAM,SAAS,uCAAuC;AAAA,cAC9E,OAAO;AACL,2BAAW,EAAE,SAAS,OAAO,OAAO,iCAAiC;AAAA,cACvE;AAAA,YACF;AACA;AAAA,UACF;AAAA,UAEA,KAAK,qBAAqB;AAExB,kBAAM,oBAAoB,yBAAyB,sBAAsB,eAAe,UAAU;AAClG,kBAAM,WAAW,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,oBAAoB,uBAAuB,CAAC;AACjG,uBAAW;AAAA,cACT,SAAS;AAAA,cACT;AAAA,cACA,aAAa,wBAAwB,sBAAsB,aAAa;AAAA,cACxE;AAAA,cACA,iBAAiB,SAAS;AAAA,cAC1B,gBAAgB,SAAS;AAAA,cACzB,oBAAoB,qBAAqB;AAAA,YAC3C;AACA,kBAAM,IAAI,oBAAoB,QAAQ;AACtC;AAAA,UACF;AAAA,UAEA;AACE,kBAAM,KAAK,mBAAmB,QAAQ,MAAM;AAC5C,uBAAW,EAAE,SAAS,OAAO,OAAO,qBAAqB,QAAQ,OAAO;AACxE;AAAA,QACJ;AAEA,cAAM,IAAI,qBAAqB,QAAQ;AACvC,qBAAa,QAAQ;AAAA,MACvB,SAAS,OAAO;AACd,cAAM,MAAM,2BAA2B,KAAK;AAC5C,qBAAa,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ,CAAC;AAAA,MACvD;AAAA,IACF,GAAG;AAGH,WAAO;AAAA,EACT,CAAC;AAMD,iBAAe,wBAAwB;AACrC,UAAM,IAAI,sEAA+D;AAEzE,QAAI;AAEF,YAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACrC,cAAM,eAAe;AAAA,UACnB;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QACF;AAEA,YAAI;AACF,gBAAM,SAAS,WAAW,QAAQ,MAAM,OAAO,YAAY;AAC3D,cAAI,UAAU,OAAO,OAAO,SAAS,YAAY;AAC/C,mBAAO,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,UACnC,OAAO;AACL,uBAAW,QAAQ,YAAY,OAAO,IAAI,MAAM,WAAW,QAAQ,UAAU,OAAO,CAAC,IAAI,QAAQ;AAAA,UACnG;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AAED,YAAM,IAAI,gDAA2C;AAAA,IACvD,SAAS,OAAO;AACd,YAAM,MAAM,8CAAyC,KAAK;AAAA,IAE5D;AAAA,EACF;AAOA,iBAAe,iBAAiB,UAAU,UAAU;AAClD,QAAI;AAEF,6BAAuB,GAAK;AAG5B,YAAM,sBAAsB;AAG5B,YAAM,UAAU,SAAS,SAAS,GAAG;AAErC,YAAM,WAAW,MAAM,MAAM,GAAG,QAAQ,UAAU;AAAA,QAChD,QAAQ;AAAA,QACR,SAAS;AAAA,UACP,gBAAgB;AAAA,QAClB;AAAA,QACA,MAAM,KAAK,UAAU,UAAU;AAAA,UAC7B,OAAO;AAAA,UACP;AAAA,QACF,IAAI;AAAA,UACF;AAAA,UACA;AAAA,QACF,CAAC;AAAA,MACH,CAAC;AAED,UAAI,CAAC,SAAS,IAAI;AAChB,cAAM,YAAY,MAAM,SAAS,KAAK;AACtC,cAAM,IAAI,MAAM,iBAAiB,SAAS,MAAM,MAAM,SAAS,EAAE;AAAA,MACnE;AAEA,YAAM,OAAO,MAAM,SAAS,KAAK;AAIjC,YAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACrC,cAAM,cAAc;AAAA,UAClB,gBAAgB,KAAK;AAAA,UACrB,iBAAiB,KAAK;AAAA,UACtB,cAAc,KAAK;AAAA,UACnB;AAAA,QACF;AAEA,cAAM,IAAI,gCAAyB;AAAA,UACjC,UAAU,CAAC,CAAC,KAAK;AAAA,UACjB,QAAQ,KAAK;AAAA,UACb;AAAA,QACF,CAAC;AAED,YAAI;AACF,gBAAM,SAAS,WAAW,QAAQ,MAAM,IAAI,WAAW;AAGvD,cAAI,UAAU,OAAO,OAAO,SAAS,YAAY;AAC/C,mBAAO,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,UACnC,OAAO;AAEL,uBAAW,QAAQ,YAAY,OAAO,IAAI,MAAM,WAAW,QAAQ,UAAU,OAAO,CAAC,IAAI,QAAQ;AAAA,UACnG;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AAED,YAAM,IAAI,qCAAqC;AAC/C,YAAM,IAAI,kBAAkB,KAAK,YAAY;AAG7C,iBAAW,MAAM,cAAc,GAAG,GAAI;AAEtC,aAAO;AAAA,IACT,SAAS,OAAO;AACd,oBAAc;AACd,YAAM,MAAM,iCAAiC,KAAK;AAClD,YAAM;AAAA,IACR;AAAA,EACF;AAKA,iBAAe,YAAY,OAAO,SAAS,MAAM,eAAe,MAAM,WAAW,MAAM;AACrF,QAAI;AAEF,6BAAuB,GAAK;AAE5B,YAAM,IAAI,iCAA0B;AAAA,QAClC,aAAa,QAAQ,MAAM,SAAS;AAAA,QACpC,YAAY,QAAQ,MAAM,UAAU,GAAG,EAAE,IAAI,QAAQ;AAAA,QACrD;AAAA,QACA;AAAA,QACA;AAAA,MACF,CAAC;AAGD,UAAI,CAAC,SAAS,MAAM,SAAS,IAAI;AAC/B,cAAM,IAAI,MAAM,0BAA0B;AAAA,MAC5C;AAGA,YAAM,sBAAsB;AAG5B,YAAM,cAAc;AAAA,QAClB,gBAAgB;AAAA,QAChB,UAAU,YAAY;AAAA,MACxB;AAEA,UAAI,QAAQ;AACV,oBAAY,kBAAkB;AAAA,MAChC;AAEA,UAAI,cAAc;AAChB,oBAAY,eAAe;AAAA,MAC7B;AAGA,YAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACrC,cAAM,IAAI,2CAAoC;AAC9C,YAAI;AACF,gBAAM,SAAS,WAAW,QAAQ,MAAM,IAAI,WAAW;AACvD,cAAI,UAAU,OAAO,OAAO,SAAS,YAAY;AAC/C,mBAAO,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,UACnC,OAAO;AACL,uBAAW,QAAQ,YAAY,OAAO,IAAI,MAAM,WAAW,QAAQ,UAAU,OAAO,CAAC,IAAI,QAAQ;AAAA,UACnG;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AAGD,YAAM,eAAe,MAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AAC1D,YAAI;AACF,gBAAM,SAAS,WAAW,QAAQ,MAAM,IAAI,CAAC,kBAAkB,mBAAmB,gBAAgB,UAAU,CAAC;AAC7G,cAAI,UAAU,OAAO,OAAO,SAAS,YAAY;AAC/C,mBAAO,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,UACnC,OAAO;AACL,uBAAW,QAAQ,YAAY,OAAO,IAAI,MAAM,WAAW,QAAQ,UAAU,OAAO,CAAC,IAAI,QAAQ,MAAM;AAAA,UACzG;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AACD,YAAM,IAAI,oCAA+B;AAAA,QACvC,aAAa,aAAa,iBAAiB,aAAa,eAAe,UAAU,GAAG,EAAE,IAAI,QAAQ;AAAA,QAClG,cAAc,aAAa;AAAA,QAC3B,gBAAgB,aAAa;AAAA,QAC7B,eAAe,aAAa;AAAA,MAC9B,CAAC;AAED,YAAM,IAAI,+BAA+B;AAGzC,iBAAW,MAAM,cAAc,GAAG,GAAI;AAEtC,aAAO,EAAE,SAAS,KAAK;AAAA,IACzB,SAAS,OAAO;AACd,oBAAc;AACd,YAAM,MAAM,8BAA8B,KAAK;AAC/C,YAAM;AAAA,IACR;AAAA,EACF;AAMA,iBAAe,cAAc;AAC3B,QAAI;AACF,YAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,kBAAkB,cAAc,CAAC;AAEpF,YAAM,IAAI,iDAA0C;AAAA,QAClD,UAAU,CAAC,CAAC,OAAO;AAAA,QACnB,aAAa,OAAO,iBAAiB,OAAO,eAAe,SAAS;AAAA,QACpE,YAAY,OAAO,iBAAiB,OAAO,eAAe,UAAU,GAAG,EAAE,IAAI,QAAQ;AAAA,QACrF,cAAc,OAAO;AAAA,QACrB,SAAS,OAAO,KAAK,MAAM;AAAA,MAC7B,CAAC;AAED,UAAI,CAAC,OAAO,gBAAgB;AAC1B,cAAM,KAAK,2CAAsC;AACjD,eAAO;AAAA,MACT;AAGA,UAAI,OAAO,cAAc;AACvB,YAAI;AAGJ,YAAI,OAAO,OAAO,iBAAiB,UAAU;AAE3C,uBAAa,IAAI,KAAK,OAAO,YAAY;AAAA,QAC3C,WAAW,OAAO,OAAO,iBAAiB,UAAU;AAElD,uBAAa,IAAI,KAAK,OAAO,YAAY;AAEzC,cAAI,MAAM,WAAW,QAAQ,CAAC,GAAG;AAC/B,kBAAM,KAAK,kDAAwC,OAAO,YAAY;AAEtE,yBAAa;AAAA,UACf;AAAA,QACF;AAEA,cAAM,MAAM,oBAAI,KAAK;AACrB,cAAM,IAAI,iCAA0B;AAAA,UAClC,cAAc,OAAO;AAAA,UACrB,YAAY,aAAa,WAAW,YAAY,IAAI;AAAA,UACpD,KAAK,IAAI,YAAY;AAAA,UACrB,WAAW,aAAa,OAAO,aAAa;AAAA,QAC9C,CAAC;AAED,YAAI,cAAc,OAAO,YAAY;AACnC,gBAAM,KAAK,2CAAsC;AACjD,gBAAM,OAAO;AACb,iBAAO;AAAA,QACT;AAAA,MACF;AAEA,YAAM,IAAI,0CAAqC;AAC/C,aAAO,OAAO;AAAA,IAChB,SAAS,OAAO;AACd,YAAM,MAAM,iCAAiC,KAAK;AAClD,YAAM;AAAA,IACR;AAAA,EACF;AAMA,iBAAe,mBAAmB;AAChC,QAAI;AACF,YAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,kBAAkB,YAAY,gBAAgB,iBAAiB,CAAC;AAEnH,YAAM,IAAI,sDAA+C;AAAA,QACvD,UAAU,CAAC,CAAC,OAAO;AAAA,QACnB,aAAa,OAAO,iBAAiB,OAAO,eAAe,SAAS;AAAA,QACpE,YAAY,OAAO,iBAAiB,OAAO,eAAe,UAAU,GAAG,EAAE,IAAI,QAAQ;AAAA,QACrF,UAAU,OAAO;AAAA,QACjB,iBAAiB,OAAO;AAAA,QACxB,cAAc,OAAO;AAAA,QACrB,SAAS,OAAO,KAAK,MAAM;AAAA,MAC7B,CAAC;AAED,UAAI,CAAC,OAAO,gBAAgB;AAC1B,cAAM,KAAK,kDAA6C;AACxD,eAAO,EAAE,UAAU,MAAM;AAAA,MAC3B;AAGA,UAAI,OAAO,cAAc;AACvB,YAAI;AAGJ,YAAI,OAAO,OAAO,iBAAiB,UAAU;AAE3C,uBAAa,IAAI,KAAK,OAAO,YAAY;AAAA,QAC3C,WAAW,OAAO,OAAO,iBAAiB,UAAU;AAElD,uBAAa,IAAI,KAAK,OAAO,YAAY;AAEzC,cAAI,MAAM,WAAW,QAAQ,CAAC,GAAG;AAC/B,kBAAM,KAAK,sEAA4D,OAAO,YAAY;AAE1F,yBAAa;AAAA,UACf;AAAA,QACF;AAEA,cAAM,MAAM,oBAAI,KAAK;AACrB,cAAM,IAAI,wCAAiC;AAAA,UACzC,cAAc,OAAO;AAAA,UACrB,YAAY,aAAa,WAAW,YAAY,IAAI;AAAA,UACpD,KAAK,IAAI,YAAY;AAAA,UACrB,WAAW,aAAa,OAAO,aAAa;AAAA,QAC9C,CAAC;AAED,YAAI,cAAc,OAAO,YAAY;AACnC,gBAAM,KAAK,6CAAwC;AACnD,gBAAM,OAAO;AACb,iBAAO,EAAE,UAAU,MAAM;AAAA,QAC3B;AAAA,MACF;AAEA,YAAM,IAAI,4CAAuC;AACjD,aAAO;AAAA,QACL,UAAU;AAAA,QACV,UAAU,OAAO,YAAY;AAAA,QAC7B,QAAQ,OAAO,mBAAmB;AAAA,MACpC;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,iCAAiC,KAAK;AAClD,YAAM;AAAA,IACR;AAAA,EACF;AAKA,iBAAe,SAAS;AACtB,QAAI;AACF,YAAM,KAAK,8DAAuD;AAGlE,YAAM,eAAe,MAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AAC1D,YAAI;AACF,gBAAM,SAAS,WAAW,QAAQ,MAAM,IAAI,CAAC,kBAAkB,mBAAmB,gBAAgB,YAAY,qBAAqB,CAAC;AACpI,cAAI,UAAU,OAAO,OAAO,SAAS,YAAY;AAC/C,mBAAO,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,UACnC,OAAO;AACL,uBAAW,QAAQ,YAAY,OAAO,IAAI,MAAM,WAAW,QAAQ,UAAU,OAAO,CAAC,IAAI,QAAQ,MAAM;AAAA,UACzG;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AAED,YAAM,IAAI,4CAAqC;AAAA,QAC7C,UAAU,CAAC,CAAC,aAAa;AAAA,QACzB,aAAa,aAAa,iBAAiB,aAAa,eAAe,SAAS;AAAA,QAChF,UAAU,aAAa;AAAA,QACvB,iBAAiB,aAAa;AAAA,QAC9B,cAAc,aAAa;AAAA,QAC3B,qBAAqB,aAAa;AAAA,MACpC,CAAC;AAGD,YAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACrC,cAAM,IAAI,oDAA6C;AACvD,YAAI;AACF,gBAAM,SAAS,WAAW,QAAQ,MAAM,IAAI,EAAE,qBAAqB,KAAK,CAAC;AACzE,cAAI,UAAU,OAAO,OAAO,SAAS,YAAY;AAC/C,mBAAO,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,UACnC,OAAO;AACL,uBAAW,QAAQ,YAAY,OAAO,IAAI,MAAM,WAAW,QAAQ,UAAU,OAAO,CAAC,IAAI,QAAQ;AAAA,UACnG;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AAGD,YAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACrC,cAAM,IAAI,8CAAkC;AAC5C,YAAI;AACF,gBAAM,SAAS,WAAW,QAAQ,MAAM,OAAO,CAAC,kBAAkB,mBAAmB,gBAAgB,UAAU,CAAC;AAChH,cAAI,UAAU,OAAO,OAAO,SAAS,YAAY;AAC/C,mBAAO,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,UACnC,OAAO;AACL,uBAAW,QAAQ,YAAY,OAAO,IAAI,MAAM,WAAW,QAAQ,UAAU,OAAO,CAAC,IAAI,QAAQ;AAAA,UACnG;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AAGD,UAAI;AACF,YAAI,OAAO,yBAAyB,aAAa;AAC/C,gBAAM,IAAI,oEAAwD;AAClE,gBAAM,eAAe,IAAI,qBAAqB;AAC9C,gBAAM,aAAa,YAAY;AAC/B,gBAAM,IAAI,4CAAuC;AAAA,QACnD;AAAA,MACF,SAAS,SAAS;AAChB,cAAM,KAAK,0EAAgE,QAAQ,OAAO;AAAA,MAC5F;AAEA,YAAM,KAAK,gDAAyC;AAAA,IACtD,SAAS,OAAO;AACd,YAAM,MAAM,qBAAqB,KAAK;AACtC,YAAM;AAAA,IACR;AAAA,EACF;AAOA,iBAAe,mBAAmB,eAAe,QAAQ;AACvD,QAAI;AAGF,UAAI,cAAc,kBAAkB,CAAC,cAAc,MAAM;AACvD,sBAAc,OAAO,cAAc;AAAA,MACrC;AAKA,UAAI,CAAC,cAAc,aAAa;AAC9B,YAAI;AACF,gBAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,iBAAiB,CAAC;AACrE,cAAI,OAAO,iBAAiB;AAC1B,0BAAc,cAAc,OAAO;AAAA,UACrC;AAAA,QACF,SAAS,GAAG;AACV,gBAAM,KAAK,+DAA+D,CAAC;AAAA,QAC7E;AAAA,MACF;AAGA,YAAM,YAAY,UAAU,cAAc,MAAM,cAAc,OAAO;AAGrE,UAAI;AAEF,cAAM,eAAe,CAAC,QAAQ;AAC5B,cAAI,CAAC,OAAO,OAAO,QAAQ;AAAU,mBAAO;AAC5C,cAAI,OAAO,IAAI,eAAe;AAAU,mBAAO,IAAI;AACnD,cAAI,OAAO,IAAI,gBAAgB;AAAU,mBAAO,IAAI;AACpD,cAAI,IAAI,MAAM,OAAO,IAAI,OAAO,UAAU;AACxC,gBAAI,OAAO,IAAI,GAAG,SAAS;AAAU,qBAAO,IAAI,GAAG;AACnD,gBAAI,OAAO,IAAI,GAAG,UAAU;AAAU,qBAAO,IAAI,GAAG;AAAA,UACtD;AACA,cAAI,IAAI,YAAY,OAAO,IAAI,aAAa,UAAU;AACpD,gBAAI,OAAO,IAAI,SAAS,gBAAgB;AAAU,qBAAO,IAAI,SAAS;AACtE,gBAAI,OAAO,IAAI,SAAS,eAAe;AAAU,qBAAO,IAAI,SAAS;AAAA,UACvE;AACA,iBAAO;AAAA,QACT;AAEA,YAAI,YAAY;AAChB,YAAI,iBAAiB,cAAc;AAAoB,sBAAY,cAAc;AAAA,iBACxE,iBAAiB,cAAc,aAAa,cAAc,UAAU;AAAoB,sBAAY,cAAc,UAAU;AAAA,iBAC5H,iBAAiB,cAAc;AAAW,sBAAY,cAAc;AAG7E,cAAM,YAAY,oBAAI,IAAI;AAC1B,eAAO,aAAa,OAAO,cAAc,YAAY,UAAU,sBAAsB,CAAC,UAAU,IAAI,SAAS,GAAG;AAC9G,oBAAU,IAAI,SAAS;AACvB,sBAAY,UAAU;AAAA,QACxB;AAEA,cAAM,YAAY,aAAa,SAAS;AACxC,YAAI,OAAO,cAAc,UAAU;AACjC,wBAAc,aAAa;AAAA,QAC7B,WAAW,CAAC,cAAc,cAAc,cAAc,MAAM,OAAO,cAAc,OAAO,UAAU;AAChG,wBAAc,aAAa,cAAc;AAAA,QAC3C;AAAA,MACF,SAAS,GAAG;AACV,cAAM,KAAK,4DAAkD,KAAK,EAAE,UAAU,EAAE,UAAU,CAAC;AAAA,MAC7F;AAGA,YAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,qBAAqB,mBAAmB,CAAC;AAC5F,YAAM,oBAAoB,OAAO,qBAAqB,CAAC;AAIvD,YAAM,cAAc,cAAc,MAAM,cAAc;AACtD,UAAI,aAAa;AACf,mBAAW,CAAC,gBAAgBA,gBAAe,KAAK,OAAO,QAAQ,iBAAiB,GAAG;AAEjF,cAAI,mBAAmB;AAAW;AAGlC,gBAAM,aAAaA,iBAAgB,MAAMA,iBAAgB;AACzD,cAAI,eAAe,aAAa;AAC9B,kBAAM,IAAI,uCAAgC,cAAc,IAAI,cAAc,cAAc,+BAA+B,SAAS,EAAE;AAClI,mBAAO,kBAAkB,cAAc;AACvC;AAAA,UACF;AAAA,QACF;AAAA,MACF;AAKA,YAAM,kBAAkB,kBAAkB,SAAS;AACnD,UAAI,mBAAmB,gBAAgB,mBAAmB;AAExD,YAAI,CAAC,cAAc,qBAAqB,cAAc,sBAAsB,WAAW;AACrF,gBAAM,IAAI,qDAA8C,gBAAgB,iBAAiB,EAAE;AAC3F,wBAAc,oBAAoB,gBAAgB;AAAA,QACpD;AAAA,MACF;AAGA,wBAAkB,SAAS,IAAI;AAI/B,YAAM,UAAU;AAAA,QACd;AAAA,QACA,WAAW,KAAK,IAAI;AAAA,MACtB;AAIA,UAAI,CAAC,OAAO,mBAAmB;AAC7B,gBAAQ,oBAAoB;AAC5B,cAAM,IAAI,gCAAgC,SAAS,EAAE;AAAA,MACvD,OAAO;AACL,cAAM,IAAI,sCAAsC,OAAO,iBAAiB,EAAE;AAAA,MAC5E;AAEA,YAAM,WAAW,QAAQ,MAAM,IAAI,OAAO;AAE1C,YAAM,IAAI,8CAA8C,SAAS,IAAI,aAAa;AAAA,IACpF,SAAS,OAAO;AACd,YAAM,MAAM,mCAAmC,KAAK;AACpD,YAAM;AAAA,IACR;AAAA,EACF;AAOA,iBAAe,iBAAiB,cAAc,MAAM;AAClD,QAAI;AACF,YAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,qBAAqB,qBAAqB,eAAe,CAAC;AAG7G,UAAI,OAAO,iBAAiB,CAAC,OAAO,mBAAmB;AACrD,cAAM,IAAI,oDAAoD;AAC9D,cAAM,SAAS,OAAO,cAAc,eAAe,OAAO,cAAc,OAAO;AAC/E,cAAMC,qBAAoB,CAAC;AAC3B,QAAAA,mBAAkB,MAAM,IAAI,OAAO;AAEnC,cAAM,WAAW,QAAQ,MAAM,IAAI;AAAA,UACjC,mBAAmBA;AAAA,UACnB,mBAAmB;AAAA,QACrB,CAAC;AAGD,cAAM,WAAW,QAAQ,MAAM,OAAO,eAAe;AAErD,eAAO,OAAO;AAAA,MAChB;AAGA,YAAM,oBAAoB,OAAO,qBAAqB,CAAC;AAGvD,YAAM,kBAAkB,CAAC,kBAAkB;AACzC,YAAI,CAAC;AAAe,iBAAO;AAG3B,YAAI,cAAc,WAAW,cAAc,cAAc,WAAW;AAClE,gBAAM,WAAW,cAAc,UAAU;AACzC,cAAI,YAAY,OAAO,aAAa,UAAU;AAC5C,kBAAM,IAAI,2EAAoE;AAE9E,mBAAO;AAAA,cACL,GAAG;AAAA,cACH,QAAQ;AAAA,cACR,aAAa,cAAc,eAAe,cAAc,UAAU;AAAA,cAClE,mBAAmB,cAAc,UAAU,sBAAsB,SAAS;AAAA,YAC5E;AAAA,UACF,OAAO;AACL,kBAAM,KAAK,8EAAoE;AAAA,UACjF;AAAA,QACF;AAGA,eAAO;AAAA,MACT;AAGA,UAAI,aAAa;AACf,cAAM,gBAAgB,kBAAkB,WAAW,KAAK;AACxD,eAAO,gBAAgB,aAAa;AAAA,MACtC;AAGA,YAAM,oBAAoB,OAAO;AACjC,YAAM,IAAI,0DAAmD,iBAAiB,GAAG;AACjF,YAAM,IAAI,mCAA4B,OAAO,KAAK,iBAAiB,CAAC;AAEpE,UAAI,qBAAqB,kBAAkB,iBAAiB,GAAG;AAC7D,cAAM,aAAa,kBAAkB,iBAAiB;AACtD,cAAM,IAAI,2CAAsC;AAAA,UAC9C,IAAI;AAAA,UACJ,MAAM,WAAW,QAAQ,WAAW;AAAA,UACpC,OAAO,WAAW;AAAA,UAClB,OAAO,WAAW;AAAA,QACpB,CAAC;AACD,eAAO,gBAAgB,UAAU;AAAA,MACnC;AAIA,UAAI,mBAAmB;AACrB,cAAM,IAAI,iEAA0D,iBAAiB,EAAE;AAGvF,mBAAW,CAAC,KAAK,OAAO,KAAK,OAAO,QAAQ,iBAAiB,GAAG;AAC9D,cAAI,QAAQ,WAAW,YAAY;AACjC,kBAAM,SAAS,QAAQ,MAAM,QAAQ,OAAO,QAAQ,0BAA0B,QAAQ;AACtF,gBAAI,WAAW,mBAAmB;AAChC,oBAAM,IAAI,8CAAyC,GAAG,EAAE;AACxD,qBAAO,gBAAgB,OAAO;AAAA,YAChC;AAAA,UACF;AAAA,QACF;AAGA,mBAAW,CAAC,KAAK,OAAO,KAAK,OAAO,QAAQ,iBAAiB,GAAG;AAC9D,cAAI,QAAQ,WAAW,YAAY;AACjC,kBAAM,SAAS,QAAQ,MAAM,QAAQ,OAAO,QAAQ,0BAA0B,QAAQ;AACtF,gBAAI,WAAW,mBAAmB;AAChC,oBAAM,IAAI,iDAA4C,GAAG,EAAE;AAC3D,qBAAO,gBAAgB,OAAO;AAAA,YAChC;AAAA,UACF;AAAA,QACF;AAEA,cAAM,KAAK,6DAAmD,iBAAiB,EAAE;AAAA,MACnF;AAGA,YAAM,eAAe,OAAO,KAAK,iBAAiB;AAClD,UAAI,aAAa,SAAS,GAAG;AAE3B,cAAM,eAAe,aAAa,KAAK,SAAO;AAC5C,gBAAM,UAAU,kBAAkB,GAAG;AACrC,iBAAO,CAAC,QAAQ,UAAU,QAAQ,WAAW;AAAA,QAC/C,CAAC;AAED,YAAI,cAAc;AAChB,gBAAM,IAAI,6DAA6D,kBAAkB,YAAY,CAAC;AACtG,iBAAO,gBAAgB,kBAAkB,YAAY,CAAC;AAAA,QACxD;AAEA,cAAM,IAAI,mDAAmD,kBAAkB,aAAa,CAAC,CAAC,CAAC;AAC/F,eAAO,gBAAgB,kBAAkB,aAAa,CAAC,CAAC,CAAC;AAAA,MAC3D;AAEA,aAAO;AAAA,IACT,SAAS,OAAO;AACd,YAAM,MAAM,sCAAsC,KAAK;AACvD,YAAM;AAAA,IACR;AAAA,EACF;AAOA,iBAAe,0BAA0B;AACvC,QAAI;AAuIF,UAAS,YAAT,SAAmB,SAAS;AAC1B,eAAO,QAAQ,MAAM,QAAQ,OAAO,QAAQ,0BAA0B,QAAQ,eAAe;AAAA,MAC/F,GAGS,iBAAT,SAAwB,SAAS;AAC/B,cAAM,QAAQ,QAAQ,QAAQ,QAAQ,kBAAkB,IAAI,KAAK,EAAE,YAAY;AAC/E,cAAM,OAAO,QAAQ,SAAS,IAAI,KAAK,EAAE,YAAY;AACrD,cAAM,QAAQ,OAAO,QAAQ,SAAS,EAAE;AACxC,eAAO,OAAO,GAAG,IAAI,IAAI,GAAG,IAAI,KAAK,KAAK;AAAA,MAC5C,GAGS,cAAT,SAAqB,SAAS,KAAK;AACjC,cAAM,SAAS,UAAU,OAAO;AAChC,YAAI,UAAU,iBAAiB,IAAI,MAAM,GAAG;AAC1C,gBAAM,IAAI,iCAA0B,QAAQ,QAAQ,QAAQ,cAAc,WAAW,GAAG,uBAAuB,iBAAiB,IAAI,MAAM,CAAC,EAAE;AAC7I,iBAAO;AAAA,QACT;AACA,cAAM,KAAK,eAAe,OAAO;AACjC,YAAI,MAAM,iBAAiB,IAAI,EAAE,GAAG;AAClC,gBAAM,IAAI,iCAA0B,QAAQ,QAAQ,QAAQ,cAAc,WAAW,GAAG,2BAA2B,iBAAiB,IAAI,EAAE,CAAC,EAAE;AAC7I,iBAAO;AAAA,QACT;AACA,eAAO;AAAA,MACT,GAGS,WAAT,SAAkB,SAAS,KAAK;AAC9B,cAAM,SAAS,UAAU,OAAO;AAChC,YAAI;AAAQ,2BAAiB,IAAI,QAAQ,GAAG;AAC5C,cAAM,KAAK,eAAe,OAAO;AACjC,YAAI;AAAI,2BAAiB,IAAI,IAAI,GAAG;AAAA,MACtC;AAtKA,YAAM,cAAc,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,mBAAmB,CAAC;AAC5E,YAAM,gBAAgB,YAAY,qBAAqB,CAAC;AAGxD,iBAAW,MAAM,OAAO,KAAK,aAAa,GAAG;AAC3C,cAAM,UAAU,cAAc,EAAE;AAChC,YAAI,QAAQ,kBAAkB,CAAC,QAAQ,MAAM;AAC3C,kBAAQ,OAAO,QAAQ;AAAA,QACzB;AAAA,MACF;AAGA,UAAI,qBAAqB,CAAC;AAC1B,UAAI,yBAAyB;AAC7B,UAAI;AACF,YAAI,OAAO,yBAAyB,aAAa;AAC/C,gBAAMC,YAAW,IAAI,qBAAqB;AAG1C,cAAI;AACF,kBAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,kBAAkB,mBAAmB,cAAc,CAAC;AACvG,gBAAI,OAAO,kBAAkB,OAAO,iBAAiB;AACnD,kBAAI,YAAY;AAChB,kBAAI,OAAO,cAAc;AACvB,sBAAM,SAAS,IAAI,KAAK,OAAO,YAAY;AAC3C,oBAAI,MAAM,OAAO,QAAQ,CAAC,KAAK,UAAU,oBAAI,KAAK,GAAG;AACnD,8BAAY;AAAA,gBACd;AAAA,cACF;AACA,kBAAI,WAAW;AACb,yCAAyB,OAAO;AAChC,sBAAM,IAAI,uDAAgD,sBAAsB;AAAA,cAClF,OAAO;AACL,sBAAM,IAAI,4EAAqE;AAAA,cACjF;AAAA,YACF;AAAA,UACF,SAAS,GAAG;AACV,kBAAM,KAAK,4CAAkC,CAAC;AAAA,UAChD;AAGA,cAAI,CAAC,wBAAwB;AAC3B,kBAAM,cAAc,MAAMA,UAAS,cAAc;AACjD,gBAAI,YAAY,WAAW,YAAY,QAAQ;AAC7C,uCAAyB,YAAY;AACrC,oBAAM,IAAI,8DAAuD,sBAAsB;AAAA,YACzF;AAAA,UACF;AAEA,cAAI,wBAAwB;AAE1B,kBAAM,WAAW,MAAM;AAAA,cACrB,GAAGA,UAAS,WAAW,mDAAmD,sBAAsB;AAAA,cAChG;AAAA,gBACE,SAAS;AAAA,kBACP,UAAUA,UAAS;AAAA,kBACnB,iBAAiB,UAAUA,UAAS,WAAW;AAAA,gBACjD;AAAA,cACF;AAAA,YACF;AAEA,gBAAI,SAAS,IAAI;AACf,oBAAM,aAAa,MAAM,SAAS,KAAK;AACvC,oBAAM,IAAI,mBAAY,WAAW,MAAM,yBAAyB;AAGhE,yBAAW,QAAQ,eAAa;AAC9B,sBAAM,SAAS,MAAM,UAAU,sBAAsB;AACrD,mCAAmB,MAAM,IAAI;AAAA,kBAC3B,MAAM,UAAU;AAAA,kBAChB,IAAI,UAAU;AAAA,kBACd,QAAQ;AAAA,kBACR,aAAa,UAAU;AAAA,kBACvB,MAAM,UAAU;AAAA,kBAChB,OAAO,UAAU;AAAA,kBACjB,OAAO,UAAU;AAAA;AAAA,kBAEjB,WAAW;AAAA,gBACb;AAAA,cACF,CAAC;AAAA,YACH,OAAO;AACL,oBAAM,KAAK,qDAA2C,SAAS,MAAM;AAAA,YACvE;AAAA,UACF;AAAA,QACF;AAAA,MACF,SAAS,SAAS;AAChB,cAAM,KAAK,oDAA0C,OAAO;AAAA,MAE9D;AAIA,UAAI,CAAC,wBAAwB;AAC3B,YAAI;AACF,gBAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,iBAAiB,CAAC;AACrE,mCAAyB,OAAO,mBAAmB;AAAA,QACrD,SAAS,GAAG;AAAA,QAEZ;AAAA,MACF;AAMA,UAAI,wBAAwB;AAC1B,mBAAW,OAAO,OAAO,KAAK,aAAa,GAAG;AAC5C,gBAAM,UAAU,cAAc,GAAG;AACjC,gBAAM,eAAe,QAAQ,eACxB,QAAQ,mBACR,QAAQ,UACR,QAAQ,qBACR;AACL,cAAI,gBAAgB,iBAAiB,wBAAwB;AAC3D,kBAAM,IAAI,sCAA+B,QAAQ,QAAQ,QAAQ,cAAc,iBAAiB,YAAY,qBAAqB,sBAAsB,GAAG;AAC1J,mBAAO,cAAc,GAAG;AAAA,UAC1B;AAAA,QACF;AAAA,MACF;AAUA,YAAM,mBAAmB,oBAAI,IAAI;AACjC,YAAM,mBAAmB,oBAAI,IAAI;AACjC,YAAM,iBAAiB,CAAC;AAuCxB,YAAM,uBAAuB,oBAAI,IAAI;AACrC,YAAM,4BAA4B,oBAAI,IAAI;AAC1C,iBAAW,CAAC,KAAK,OAAO,KAAK,OAAO,QAAQ,kBAAkB,GAAG;AAC/D,cAAM,SAAS,UAAU,OAAO;AAChC,cAAM,KAAK,eAAe,OAAO;AACjC,YAAI;AAAQ,+BAAqB,IAAI,QAAQ,EAAE,KAAK,QAAQ,CAAC;AAC7D,YAAI;AAAI,oCAA0B,IAAI,IAAI,EAAE,KAAK,QAAQ,CAAC;AAAA,MAC5D;AAGA,iBAAW,CAAC,KAAK,OAAO,KAAK,OAAO,QAAQ,aAAa,GAAG;AAC1D,cAAM,KAAK,eAAe,OAAO;AACjC,cAAM,SAAS,UAAU,OAAO;AAEhC,cAAM,eAAe,SAAS,iBAAiB,IAAI,MAAM,IAAI;AAC7D,cAAM,eAAe,KAAK,iBAAiB,IAAI,EAAE,IAAI;AAGrD,cAAM,UAAW,UAAU,qBAAqB,IAAI,MAAM,KACzC,MAAM,0BAA0B,IAAI,EAAE;AACvD,YAAI,SAAS;AAEX,kBAAQ,SAAS;AACjB,kBAAQ,kBAAkB;AAC1B,kBAAQ,cAAc,QAAQ;AAC9B,gBAAM,IAAI,+BAAqB,QAAQ,QAAQ,QAAQ,cAAc,iDAAiD;AAItH,cAAI,QAAQ,QAAQ,qBAAqB,QAAQ,QAAQ,oBAAoB;AAC3E,kBAAM,UAAU,QAAQ,QAAQ,qBAAqB,QAAQ,QAAQ;AACrE,gBAAI,QAAQ,sBAAsB,SAAS;AACzC,oBAAM,IAAI,yDAAkD,QAAQ,iBAAiB,OAAO,OAAO,EAAE;AACrG,sBAAQ,oBAAoB;AAAA,YAC9B;AAAA,UACF;AAAA,QACF;AAIA,YAAI,cAAc;AAChB,cAAI,IAAI,WAAW,OAAO,KAAK,aAAa,WAAW,KAAK,GAAG;AAC7D,mBAAO,eAAe,YAAY;AAClC,qBAAS,SAAS,GAAG;AACrB,2BAAe,GAAG,IAAI;AAAA,UACxB,OAAO;AACL,kBAAM,IAAI,iCAA0B,QAAQ,QAAQ,QAAQ,cAAc,WAAW,GAAG,uBAAuB,YAAY,EAAE;AAAA,UAC/H;AACA;AAAA,QACF;AAIA,YAAI,cAAc;AAChB,cAAI,IAAI,WAAW,OAAO,KAAK,CAAC,aAAa,WAAW,OAAO,GAAG;AAChE,mBAAO,eAAe,YAAY;AAClC,qBAAS,SAAS,GAAG;AACrB,2BAAe,GAAG,IAAI;AAAA,UACxB,OAAO;AACL,kBAAM,IAAI,iCAA0B,QAAQ,QAAQ,QAAQ,cAAc,WAAW,GAAG,2BAA2B,YAAY,EAAE;AAAA,UACnI;AACA;AAAA,QACF;AAGA,iBAAS,SAAS,GAAG;AACrB,uBAAe,GAAG,IAAI;AAAA,MACxB;AAGA,iBAAW,CAAC,KAAK,OAAO,KAAK,OAAO,QAAQ,kBAAkB,GAAG;AAC/D,YAAI,CAAC,YAAY,SAAS,GAAG,GAAG;AAC9B,mBAAS,SAAS,GAAG;AACrB,yBAAe,GAAG,IAAI;AAAA,QACxB,OAAO;AACL,gBAAM,IAAI,yCAAkC,GAAG,gEAAgE;AAAA,QACjH;AAAA,MACF;AAEA,YAAM,IAAI,wCAAiC;AAAA,QACzC,OAAO,OAAO,KAAK,aAAa,EAAE;AAAA,QAClC,UAAU,OAAO,KAAK,kBAAkB,EAAE;AAAA,QAC1C,cAAc,OAAO,KAAK,cAAc,EAAE;AAAA,MAC5C,CAAC;AAED,aAAO;AAAA,IACT,SAAS,OAAO;AACd,YAAM,MAAM,0CAA0C,KAAK;AAC3D,YAAM;AAAA,IACR;AAAA,EACF;AAKA,iBAAe,6BAA6B,aAAa;AACvD,QAAI;AACF,UAAI,OAAO,yBAAyB,aAAa;AAC/C,cAAM,IAAI,MAAM,oCAAoC;AAAA,MACtD;AAEA,YAAMA,YAAW,IAAI,qBAAqB;AAG1C,UAAI,aAAa;AACjB,UAAI;AAEF,YAAI;AACF,gBAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,mBAAmB,kBAAkB,cAAc,CAAC;AACvG,cAAI,OAAO,mBAAmB,OAAO,gBAAgB;AACnD,gBAAI,YAAY;AAChB,gBAAI,OAAO,cAAc;AACvB,oBAAM,SAAS,IAAI,KAAK,OAAO,YAAY;AAC3C,kBAAI,MAAM,OAAO,QAAQ,CAAC,KAAK,UAAU,oBAAI,KAAK,GAAG;AACnD,4BAAY;AAAA,cACd;AAAA,YACF;AACA,gBAAI,WAAW;AACb,2BAAa,yBAAyB,OAAO,eAAe;AAC5D,oBAAM,IAAI,uDAAgD,OAAO,eAAe;AAAA,YAClF;AAAA,UACF;AAAA,QACF,SAAS,GAAG;AACV,gBAAM,KAAK,wDAA8C,CAAC;AAAA,QAC5D;AAEA,YAAI,CAAC,YAAY;AACf,gBAAM,cAAc,MAAMA,UAAS,cAAc;AACjD,cAAI,YAAY,WAAW,YAAY,QAAQ;AAC7C,yBAAa,yBAAyB,YAAY,MAAM;AAAA,UAC1D;AAAA,QACF;AAAA,MACF,SAAS,GAAG;AACV,cAAM,KAAK,uDAAuD,CAAC;AAAA,MACrE;AAKA,YAAM,WAAW,OAAO,OAAO,UAAU;AACvC,cAAM,MAAM,GAAGA,UAAS,WAAW,8BAA8B,KAAK,OAAO,mBAAmB,KAAK,CAAC,GAAG,UAAU;AACnH,cAAM,OAAO,MAAM,MAAM,KAAK;AAAA,UAC5B,SAAS;AAAA,YACP,UAAUA,UAAS;AAAA,YACnB,iBAAiB,UAAUA,UAAS,WAAW;AAAA,UACjD;AAAA,QACF,CAAC;AACD,YAAI,CAAC,KAAK;AAAI,iBAAO;AACrB,cAAM,MAAM,MAAM,KAAK,KAAK;AAC5B,eAAQ,OAAO,IAAI,SAAS,IAAK,IAAI,CAAC,IAAI;AAAA,MAC5C;AAEA,UAAI,cAAc;AAGlB,oBAAc,MAAM,SAAS,0BAA0B,WAAW;AAGlE,UAAI,CAAC,aAAa;AAChB,YAAI,eAAe,YAAY,WAAW,KAAK,GAAG;AAChD,wBAAc,MAAM,SAAS,0BAA0B,YAAY,QAAQ,QAAQ,EAAE,CAAC;AAAA,QACxF,OAAO;AACL,wBAAc,MAAM,SAAS,0BAA0B,MAAM,WAAW,EAAE;AAAA,QAC5E;AAAA,MACF;AAGA,UAAI,CAAC,aAAa;AAChB,sBAAc,MAAM,SAAS,MAAM,WAAW;AAAA,MAChD;AAEA,UAAI,CAAC,aAAa;AAChB,cAAM,IAAI,MAAM,iCAAiC;AAAA,MACnD;AAIA,UAAI,UAAU,YAAY,sBAAsB,YAAY,aAAa;AAGzE,UAAI,WAAW,OAAO,YAAY,UAAU;AAC1C,YAAI;AACF,oBAAU,KAAK,MAAM,OAAO;AAC5B,gBAAM,IAAI,sDAA+C;AAAA,QAC3D,SAAS,YAAY;AACnB,gBAAM,KAAK,mEAAyD,WAAW,OAAO;AACtF,oBAAU;AAAA,QACZ;AAAA,MACF;AAGA,YAAM,IAAI,8DAAuD;AAAA,QAC/D,YAAY,CAAC,CAAC;AAAA,QACd,aAAa,OAAO;AAAA,QACpB,gBAAgB,MAAM,QAAQ,OAAO;AAAA,QACrC,WAAW,CAAC,EAAE,WAAW,QAAQ;AAAA,QACjC,eAAe,MAAM,QAAQ,SAAS,MAAM;AAAA,QAC5C,cAAc,SAAS,QAAQ;AAAA,QAC/B,YAAY,CAAC,EAAE,WAAW,QAAQ;AAAA,QAClC,gBAAgB,MAAM,QAAQ,SAAS,OAAO;AAAA,QAC9C,eAAe,SAAS,SAAS;AAAA,QACjC,cAAc,UAAU,OAAO,KAAK,OAAO,EAAE,MAAM,GAAG,EAAE,IAAI,CAAC;AAAA,MAC/D,CAAC;AAED,UAAI,WAAW,OAAO,YAAY,YAAY,CAAC,MAAM,QAAQ,OAAO,GAAG;AAErE,YAAI,YAAY;AAChB,cAAM,OAAO,oBAAI,IAAI;AACrB,eAAO,aAAa,OAAO,cAAc,YAAY,UAAU,sBAAsB,CAAC,KAAK,IAAI,SAAS,GAAG;AACzG,eAAK,IAAI,SAAS;AAClB,sBAAY,UAAU;AAAA,QACxB;AAGA,YAAI,aAAa,OAAO,UAAU,OAAO,YAAY,UAAU,GAAG,WAAW,KAAK,GAAG;AACnF,cAAI,UAAU,OAAO,OAAO,UAAU,QAAQ,YAAY,CAAC,UAAU,IAAI,WAAW,KAAK,GAAG;AAC1F,sBAAU,KAAK,UAAU;AAAA,UAC3B,WAAW,UAAU,sBAAsB,UAAU,mBAAmB,MAAM,CAAC,UAAU,mBAAmB,GAAG,WAAW,KAAK,GAAG;AAChI,sBAAU,KAAK,UAAU,mBAAmB;AAAA,UAC9C;AAAA,QACF;AAEA,cAAM,gBAAgB;AAEtB,sBAAc,SAAS;AACvB,sBAAc,cAAc,YAAY;AAExC,YAAI,CAAC,cAAc,IAAI;AACrB,wBAAc,KAAK,YAAY;AAAA,QACjC;AACA,YAAI,CAAC,cAAc,MAAM;AACvB,wBAAc,OAAO,YAAY;AAAA,QACnC;AAEA,YAAI,YAAY,oBAAoB;AAClC,wBAAc,oBAAoB,YAAY;AAAA,QAChD;AAGA,cAAM,IAAI,4CAAqC;AAAA,UAC7C,MAAM,cAAc;AAAA,UACpB,WAAW,CAAC,CAAC,cAAc;AAAA,UAC3B,eAAe,MAAM,QAAQ,cAAc,MAAM;AAAA,UACjD,cAAc,cAAc,QAAQ;AAAA,UACpC,YAAY,CAAC,CAAC,cAAc;AAAA,UAC5B,gBAAgB,MAAM,QAAQ,cAAc,OAAO;AAAA,UACnD,eAAe,cAAc,SAAS;AAAA,UACtC,cAAc,OAAO,KAAK,aAAa,EAAE,MAAM,GAAG,EAAE;AAAA,QACtD,CAAC;AAED,YAAI;AACF,gBAAM,OAAO,OAAO,KAAK,iBAAiB,CAAC,CAAC,EAAE,MAAM,GAAG,EAAE;AACzD,cAAI,SAAS;AACb,cAAI;AACF,qBAAS,KAAK,UAAU,eAAe,IAAI;AAAA,UAC7C,SAAS,GAAG;AACV,qBAAS;AAAA,UACX;AACA,gBAAM,IAAI,kEAA6D,cAAc,MAAM;AAAA,YACzF;AAAA,YACA,QAAQ,UAAU,OAAO,QAAQ,OAAO,MAAM,GAAG,GAAI,IAAI;AAAA,YACzD,aAAa,cAAc;AAAA,UAC7B,CAAC;AAAA,QACH,SAAS,GAAG;AACV,gBAAM,IAAI,kEAA6D,cAAc,IAAI;AAAA,QAC3F;AACA,eAAO;AAAA,MACT;AAIA,YAAM,KAAK,mDAAyC,OAAO,SAAS,mCAAmC;AACvG,YAAM,KAAK,gCAAsB,OAAO,KAAK,WAAW,CAAC;AACzD,YAAM,gBAAgB;AAAA;AAAA,QAEpB,IAAI,YAAY;AAAA,QAChB,MAAM,YAAY;AAAA,QAClB,MAAM,YAAY;AAAA,QAClB,OAAO,YAAY;AAAA,QACnB,OAAO,YAAY;AAAA,QACnB,WAAW,YAAY;AAAA,QACvB,WAAW,YAAY;AAAA,QACvB,SAAS,YAAY;AAAA,QACrB,aAAa,YAAY;AAAA,QACzB,YAAY,YAAY;AAAA,QACxB,aAAa,YAAY;AAAA,QACzB,YAAY,YAAY;AAAA,QACxB,OAAO,YAAY;AAAA,QACnB,YAAY,YAAY;AAAA,QACxB,kBAAkB,YAAY;AAAA,QAC9B,YAAY,YAAY;AAAA,QACxB,eAAe,YAAY;AAAA,QAC3B,OAAO,YAAY;AAAA,QACnB,QAAQ,YAAY;AAAA,QACpB,YAAY,YAAY;AAAA,QACxB,WAAW,YAAY;AAAA,QACvB,YAAY,YAAY;AAAA,QACxB,mBAAmB,YAAY;AAAA;AAAA,QAE/B,kBAAkB;AAAA,QAClB,QAAQ;AAAA,QACR,aAAa,YAAY;AAAA,MAC3B;AAEA,YAAM,IAAI,8DAAyD,cAAc,IAAI;AACrF,aAAO;AAAA,IACT,SAAS,OAAO;AACd,YAAM,MAAM,sDAAiD,KAAK;AAClE,YAAM;AAAA,IACR;AAAA,EACF;AAKA,iBAAe,mBAAmB,aAAa;AAC7C,QAAI;AAEF,YAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,mBAAmB,CAAC;AACvE,YAAM,oBAAoB,OAAO,qBAAqB,CAAC;AACvD,YAAM,gBAAgB,kBAAkB,WAAW;AAEnD,YAAM,IAAI,uCAAgC,WAAW,EAAE;AACvD,YAAM,IAAI,6BAAsB,gBAAgB;AAAA,QAC9C,MAAM,cAAc,QAAQ,cAAc;AAAA,QAC1C,OAAO,cAAc;AAAA,QACrB,OAAO,cAAc;AAAA,MACvB,IAAI,WAAW;AAEf,YAAM,WAAW,QAAQ,MAAM,IAAI;AAAA,QACjC,mBAAmB;AAAA,MACrB,CAAC;AACD,YAAM,IAAI,mCAA8B,WAAW,EAAE;AAGrD,UAAI,iBAAiB,cAAc,IAAI;AACrC,YAAI;AACF,gBAAM,8BAA8B,cAAc,IAAI,cAAc,QAAQ,cAAc,cAAc;AAAA,QAC1G,SAAS,OAAO;AACd,gBAAM,KAAK,gEAAsD,KAAK;AAAA,QACxE;AAAA,MACF;AAGA,UAAI;AACF,cAAM,OAAO,MAAM,WAAW,KAAK,MAAM,EAAE,KAAK,8BAA8B,CAAC;AAC/E,mBAAW,OAAO,MAAM;AACtB,gBAAM,WAAW,KAAK,YAAY,IAAI,IAAI;AAAA,YACxC,QAAQ;AAAA,YACR,WAAW;AAAA,UACb,CAAC;AACD,gBAAM,IAAI,kCAA2B,IAAI,EAAE,yBAAyB;AAAA,QACtE;AAAA,MACF,SAAS,OAAO;AACd,cAAM,IAAI,2EAAiE;AAAA,MAC7E;AAAA,IAEF,SAAS,OAAO;AACd,YAAM,MAAM,mCAAmC,KAAK;AACpD,YAAM;AAAA,IACR;AAAA,EACF;AAKA,iBAAe,qBAAqB;AAClC,QAAI;AACF,YAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,qBAAqB,mBAAmB,CAAC;AAC5F,YAAM,oBAAoB,OAAO;AAEjC,UAAI,CAAC,mBAAmB;AACtB,cAAM,IAAI,mCAA4B;AACtC,eAAO;AAAA,MACT;AAEA,YAAM,oBAAoB,OAAO,qBAAqB,CAAC;AACvD,YAAM,gBAAgB,kBAAkB,iBAAiB;AAEzD,UAAI,CAAC,eAAe;AAClB,cAAM,KAAK,iCAAuB,iBAAiB,wBAAwB;AAC3E,eAAO;AAAA,MACT;AAEA,YAAM,IAAI,yCAAkC,cAAc,QAAQ,cAAc,cAAc,EAAE;AAChG,aAAO;AAAA,IACT,SAAS,OAAO;AACd,YAAM,MAAM,mCAAmC,KAAK;AACpD,aAAO;AAAA,IACT;AAAA,EACF;AAKA,iBAAe,8BAA8B,aAAa,eAAe;AACvE,QAAI,CAAC,qBAAqB,GAAG;AAC3B,YAAM,KAAK,2DAA2D;AACtE;AAAA,IACF;AAEA,QAAI;AACF,YAAM,IAAI,sDAA+C,aAAa,KAAK,WAAW,GAAG;AAGzF,YAAM,kBAAkB,MAAM;AAAA,QAC5B,GAAG,YAAY,wDAAwD,WAAW;AAAA,QAClF;AAAA,UACE,SAAS;AAAA,YACP,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,UAC9C;AAAA,QACF;AAAA,MACF;AAEA,UAAI,gBAAgB,IAAI;AACtB,cAAM,aAAa,MAAM,gBAAgB,KAAK;AAC9C,YAAI,WAAW,SAAS,GAAG;AACzB,gBAAM,gBAAgB,WAAW,CAAC,EAAE;AAEpC,cAAI,iBAAiB,kBAAkB,cAAc;AAEnD,kBAAM;AAAA,cACJ,GAAG,YAAY,iDAAiD,aAAa;AAAA,cAC7E;AAAA,gBACE,QAAQ;AAAA,gBACR,SAAS;AAAA,kBACP,UAAU;AAAA,kBACV,iBAAiB,UAAU,iBAAiB;AAAA,kBAC5C,gBAAgB;AAAA,gBAClB;AAAA,gBACA,MAAM,KAAK,UAAU,EAAE,WAAW,MAAM,CAAC;AAAA,cAC3C;AAAA,YACF;AAGA,kBAAM,iBAAiB,MAAM;AAAA,cAC3B,GAAG,YAAY,wDAAwD,WAAW;AAAA,cAClF;AAAA,gBACE,QAAQ;AAAA,gBACR,SAAS;AAAA,kBACP,UAAU;AAAA,kBACV,iBAAiB,UAAU,iBAAiB;AAAA,kBAC5C,gBAAgB;AAAA,gBAClB;AAAA,gBACA,MAAM,KAAK,UAAU,EAAE,WAAW,KAAK,CAAC;AAAA,cAC1C;AAAA,YACF;AAEA,gBAAI,eAAe,IAAI;AACrB,oBAAM,IAAI,8BAAyB,aAAa,wBAAwB;AAAA,YAC1E,OAAO;AACL,oBAAM,KAAK,4DAAkD,eAAe,MAAM,EAAE;AAAA,YACtF;AAAA,UACF,OAAO;AACL,kBAAM,KAAK,0BAAgB,aAAa,oDAAoD;AAAA,UAC9F;AAAA,QACF,OAAO;AACL,gBAAM,KAAK,0BAAgB,WAAW,wBAAwB;AAAA,QAChE;AAAA,MACF,OAAO;AACL,cAAM,KAAK,wDAA8C,gBAAgB,MAAM,EAAE;AAAA,MACnF;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,yDAAoD,KAAK;AAAA,IACvE;AAAA,EACF;AAKA,iBAAe,mBAAmB,cAAc,MAAM;AACpD,QAAI;AACF,UAAI,aAAa;AAEf,cAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,qBAAqB,mBAAmB,CAAC;AAC5F,cAAM,oBAAoB,OAAO,qBAAqB,CAAC;AACvD,cAAM,oBAAoB,OAAO;AAEjC,eAAO,kBAAkB,WAAW;AAEpC,cAAM,UAAU;AAAA,UACd;AAAA,QACF;AAGA,YAAI,sBAAsB,aAAa;AACrC,gBAAM,eAAe,OAAO,KAAK,iBAAiB;AAClD,cAAI,aAAa,SAAS,GAAG;AAE3B,oBAAQ,oBAAoB,aAAa,CAAC;AAC1C,kBAAM,IAAI,8CAA8C,aAAa,CAAC,CAAC,EAAE;AAAA,UAC3E,OAAO;AAEL,oBAAQ,oBAAoB;AAC5B,kBAAM,IAAI,uDAAuD;AAAA,UACnE;AAAA,QACF;AAEA,cAAM,WAAW,QAAQ,MAAM,IAAI,OAAO;AAE1C,cAAM,IAAI,qCAAqC,WAAW,EAAE;AAAA,MAC9D,OAAO;AAEL,cAAM,aAAa;AAAA,UACjB;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA;AAAA,UACA;AAAA;AAAA,UACA;AAAA,UAAS;AAAA,UAAS;AAAA,UAAS;AAAA,UAAS;AAAA;AAAA,UACpC;AAAA;AAAA,UACA;AAAA;AAAA,QACF;AACA,cAAM,WAAW,QAAQ,MAAM,OAAO,UAAU;AAChD,cAAM,IAAI,iEAAiE;AAAA,MAC7E;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,mCAAmC,KAAK;AACpD,YAAM;AAAA,IACR;AAAA,EACF;AAKA,iBAAe,yBAAyB,aAAa;AACnD,QAAI;AACF,UAAI,CAAC,aAAa;AAChB,cAAM,IAAI,MAAM,0BAA0B;AAAA,MAC5C;AAEA,UAAI,CAAC,qBAAqB,GAAG;AAC3B,cAAM,IAAI,MAAM,yBAAyB;AAAA,MAC3C;AAEA,YAAM,IAAI,kDAAsC,WAAW,EAAE;AAG7D,YAAM,UAAU,YAAY,WAAW,KAAK,IAAI,YAAY,QAAQ,OAAO,EAAE,IAAI;AAIjF,YAAM,WAAW,CAAC,OAAO;AACzB,UAAI,YAAY,aAAa;AAC3B,iBAAS,KAAK,WAAW;AAAA,MAC3B;AAEA,UAAI,UAAU;AACd,iBAAW,cAAc,UAAU;AACjC,cAAM,WAAW,MAAM;AAAA,UACrB,GAAG,YAAY,wDAAwD,mBAAmB,UAAU,CAAC;AAAA,UACrG;AAAA,YACE,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,UAAU;AAAA,cACV,iBAAiB,UAAU,iBAAiB;AAAA,cAC5C,UAAU;AAAA;AAAA,YACZ;AAAA,UACF;AAAA,QACF;AAEA,YAAI,SAAS,IAAI;AACf,gBAAM,cAAc,MAAM,SAAS,KAAK;AACxC,cAAI,eAAe,YAAY,SAAS,GAAG;AACzC,kBAAM,IAAI,kBAAa,YAAY,MAAM,kCAAkC,UAAU,EAAE;AACvF,sBAAU;AAAA,UACZ;AAAA,QACF;AAAA,MACF;AAEA,UAAI,CAAC,SAAS;AACZ,cAAM,KAAK,yDAA+C,WAAW,EAAE;AAAA,MACzE;AAEA,YAAM,IAAI,iDAA4C,WAAW,EAAE;AACnE,aAAO,EAAE,SAAS,KAAK;AAAA,IACzB,SAAS,OAAO;AACd,YAAM,MAAM,0CAA0C,KAAK;AAC3D,YAAM;AAAA,IACR;AAAA,EACF;AAoCA,aAAW,QAAQ,YAAY,YAAY,CAAC,YAAY;AACtD,QAAI,QAAQ,WAAW,WAAW;AAChC,YAAM,IAAI,qBAAqB;AAG/B,iBAAW,MAAM;AACf,2BAAmB;AAAA,MACrB,GAAG,GAAI;AAEP,UAAI;AACF,mBAAW,QAAQ,MAAM,IAAI,EAAE,sBAAsB,KAAK,CAAC;AAC3D,cAAM,IAAI,6CAA6C;AAAA,MACzD,SAAS,GAAG;AACV,cAAM,KAAK,4CAA4C,CAAC;AAAA,MAC1D;AAAA,IACF,WAAW,QAAQ,WAAW,UAAU;AACtC,YAAM,IAAI,gCAAgC,WAAW,QAAQ,YAAY,EAAE,OAAO;AAElF,UAAI;AACF,mBAAW,QAAQ,MAAM,IAAI,EAAE,sBAAsB,KAAK,CAAC;AAC3D,cAAM,IAAI,4CAA4C;AAAA,MACxD,SAAS,GAAG;AACV,cAAM,KAAK,sDAAsD,CAAC;AAAA,MACpE;AAEA,OAAC,YAAY;AACX,YAAI;AACF,gBAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,yBAAyB,iBAAiB,kBAAkB,CAAC;AAChH,gBAAM,mBAAmB,OAAO,yBAAyB,OAAO,iBAAiB,OAAO;AAExF,cAAI,CAAC,kBAAkB;AACrB,kBAAM,IAAI,sEAAsE;AAChF;AAAA,UACF;AAEA,cAAI,CAAC,qBAAqB,GAAG;AAC3B,kBAAM,IAAI,oDAAoD;AAC9D;AAAA,UACF;AAEA,gBAAM,IAAI,kFAA2E;AAErF,iCAAuB,GAAK;AAE5B,gBAAM,aAAa,MAAM,iBAAiB;AAC1C,cAAI,CAAC,YAAY;AACf,kBAAM,IAAI,8CAA8C;AACxD;AAAA,UACF;AAEA,gBAAM,MAAM,MAAM,sBAAsB,UAAU;AAClD,cAAI,OAAO,IAAI,SAAS;AACtB,kBAAM,IAAI,iDAA4C;AAAA,UACxD,OAAO;AACL,kBAAM,KAAK,sDAA4C,OAAO,IAAI,KAAK;AAAA,UACzE;AAAA,QACF,SAAS,KAAK;AACZ,gBAAM,KAAK,iEAAuD,GAAG;AAAA,QACvE,UAAE;AAEA,qBAAW,MAAM,cAAc,GAAG,GAAI;AAAA,QACxC;AAAA,MACF,GAAG;AAAA,IACL;AAAA,EACF,CAAC;AAKD,iBAAe,qBAAqB;AAClC,QAAI;AACF,YAAM,IAAI,yDAAkD;AAG5D,UAAI,CAAC,WAAW;AAGd,mBAAW,QAAQ,gBAAgB;AACnC,cAAM,IAAI,uCAAkC;AAAA,MAC9C,OAAO;AAEL,YAAI;AAGF,qBAAW,QAAQ,gBAAgB;AACnC,gBAAM,IAAI,wCAAmC;AAAA,QAC/C,SAAS,OAAO;AACd,gBAAM,IAAI,6CAAmC,KAAK;AAAA,QACpD;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AACd,YAAM,IAAI,uCAAkC,KAAK;AAAA,IACnD;AAAA,EACF;AAYA,iBAAe,0BAA0B,YAAY,UAAU,MAAM,aAAa,MAAM;AACtF,QAAI;AACF,YAAM,WAAW;AAAA,QACf,mBAAmB,cAAc;AAAA,QACjC,uBAAuB;AAAA,MACzB;AACA,UAAI,YAAY;AACd,iBAAS,oBAAoB;AAAA,MAC/B;AACA,YAAM,IAAI,8CAAuC;AAAA,QAC/C,YAAY,aAAa,GAAG,WAAW,UAAU,GAAG,EAAE,CAAC,QAAQ;AAAA,QAC/D;AAAA,QACA;AAAA,MACF,CAAC;AACD,YAAM,WAAW,QAAQ,MAAM,IAAI,QAAQ;AAG3C,YAAM,eAAe,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,qBAAqB,uBAAuB,CAAC;AACtG,YAAM,IAAI,6CAAwC;AAAA,QAChD,WAAW,aAAa,oBAAoB,GAAG,aAAa,kBAAkB,UAAU,GAAG,EAAE,CAAC,QAAQ;AAAA,QACtG,eAAe,aAAa;AAAA,MAC9B,CAAC;AAGD,UAAI,cAAc,qBAAqB,GAAG;AACxC,YAAI;AACF,gBAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,kBAAkB,CAAC;AACtE,cAAI,OAAO,kBAAkB;AAC3B,kBAAM,IAAI,uDAA6C,OAAO,gBAAgB;AAC9E,kBAAM;AAAA,cACJ,GAAG,YAAY,kCAAkC,OAAO,gBAAgB;AAAA,cACxE;AAAA,gBACE,QAAQ;AAAA,gBACR,SAAS;AAAA,kBACP,UAAU;AAAA,kBACV,iBAAiB,UAAU,iBAAiB;AAAA,kBAC5C,gBAAgB;AAAA,kBAChB,UAAU;AAAA,gBACZ;AAAA,gBACA,MAAM,KAAK,UAAU,EAAE,aAAa,WAAW,CAAC;AAAA,cAClD;AAAA,YACF;AACA,kBAAM,IAAI,sCAAiC;AAAA,UAC7C;AAAA,QACF,SAAS,WAAW;AAClB,gBAAM,KAAK,mDAAyC,UAAU,OAAO;AAAA,QAEvE;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,4CAA4C,KAAK;AAC7D,YAAM;AAAA,IACR;AAAA,EACF;AAKA,iBAAe,4BAA4B;AACzC,QAAI;AACF,YAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI;AAAA,QAChD;AAAA,QACA;AAAA,QACA;AAAA,MACF,CAAC;AACD,aAAO;AAAA,QACL,YAAY,OAAO,qBAAqB;AAAA,QACxC,SAAS,OAAO,0BAA0B;AAAA;AAAA,QAC1C,YAAY,OAAO,qBAAqB;AAAA,MAC1C;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,2CAA2C,KAAK;AAC5D,aAAO,EAAE,YAAY,IAAI,SAAS,OAAO,YAAY,KAAK;AAAA,IAC5D;AAAA,EACF;AAKA,iBAAe,mBAAmB,YAAY;AAC5C,QAAI;AACF,UAAI,CAAC,cAAc,CAAC,WAAW,SAAS,0BAA0B,GAAG;AACnE,eAAO,EAAE,SAAS,OAAO,OAAO,8BAA8B;AAAA,MAChE;AAEA,YAAM,YAAY;AAAA,QAChB,QAAQ,CAAC;AAAA,UACP,OAAO;AAAA,UACP,aAAa;AAAA,UACb,OAAO;AAAA;AAAA,UACP,QAAQ;AAAA,YACN,MAAM;AAAA,UACR;AAAA,UACA,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,QACpC,CAAC;AAAA,MACH;AAEA,YAAM,WAAW,MAAM,MAAM,YAAY;AAAA,QACvC,QAAQ;AAAA,QACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,QAC9C,MAAM,KAAK,UAAU,SAAS;AAAA,MAChC,CAAC;AAED,UAAI,SAAS,MAAM,SAAS,WAAW,KAAK;AAC1C,cAAM,IAAI,wCAAmC;AAC7C,eAAO,EAAE,SAAS,KAAK;AAAA,MACzB,OAAO;AACL,cAAM,YAAY,MAAM,SAAS,KAAK;AACtC,cAAM,KAAK,uCAAkC,SAAS,QAAQ,SAAS;AACvE,eAAO,EAAE,SAAS,OAAO,OAAO,QAAQ,SAAS,MAAM,KAAK,SAAS,GAAG;AAAA,MAC1E;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,sCAAiC,KAAK;AAClD,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAMA,MAAI,kBAAkB;AACtB,MAAM,wBAAwB;AAE9B,iBAAe,qBAAqB,SAAS;AAC3C,QAAI;AAEF,YAAM,WAAW,MAAM,0BAA0B;AAEjD,UAAI,CAAC,SAAS,WAAW,CAAC,SAAS,YAAY;AAC7C,cAAM,IAAI,4CAA4C;AACtD,eAAO,EAAE,SAAS,OAAO,OAAO,yBAAyB;AAAA,MAC3D;AAGA,YAAM,MAAM,KAAK,IAAI;AACrB,UAAI,MAAM,kBAAkB,uBAAuB;AACjD,cAAM,IAAI,oCAAoC;AAC9C,eAAO,EAAE,SAAS,OAAO,OAAO,eAAe;AAAA,MACjD;AACA,wBAAkB;AAGlB,YAAM,UAAU,oBAAoB,OAAO;AAE3C,YAAM,WAAW,MAAM,MAAM,SAAS,YAAY;AAAA,QAChD,QAAQ;AAAA,QACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,QAC9C,MAAM,KAAK,UAAU,OAAO;AAAA,MAC9B,CAAC;AAED,UAAI,SAAS,MAAM,SAAS,WAAW,KAAK;AAC1C,cAAM,IAAI,6BAAwB,QAAQ,IAAI;AAC9C,eAAO,EAAE,SAAS,KAAK;AAAA,MACzB,OAAO;AACL,cAAM,YAAY,MAAM,SAAS,KAAK;AACtC,cAAM,KAAK,+BAA0B,SAAS,MAAM;AACpD,eAAO,EAAE,SAAS,OAAO,OAAO,QAAQ,SAAS,MAAM,GAAG;AAAA,MAC5D;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,8BAAyB,KAAK;AAC1C,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAWA,WAAS,oBAAoB,SAAS;AACpC,UAAM,EAAE,MAAM,eAAe,WAAW,OAAO,SAAS,WAAW,IAAI;AAGvE,UAAM,UAAU,CAAC,SAAS,OAAO,WAAM;AAGvC,UAAM,oBAAoB,CAAC,SAAS;AAClC,UAAI,CAAC;AAAM,eAAO;AAClB,aAAO;AAAA,QACL,WAAW,QAAQ,KAAK,MAAM,CAAC;AAAA,QAC/B,UAAU,QAAQ,KAAK,KAAK,CAAC;AAAA,QAC7B,SAAS,QAAQ,KAAK,QAAQ,CAAC;AAAA,QAC/B,UAAU,QAAQ,KAAK,QAAQ,CAAC;AAAA,MAClC,EAAE,KAAK,KAAK;AAAA,IACd;AAGA,UAAM,cAAc,CAAC,WAAW,UAAU,UAAU,SAAS;AAC3D,YAAM,QAAQ,CAAC,WAAW,QAAQ;AAClC,UAAI;AAAU,cAAM,KAAK,SAAS,QAAQ,EAAE;AAC5C,UAAI,MAAM;AACR,cAAM,aAAa;AAAA,UACjB,KAAK,SAAS,MAAM;AAAA,UACpB,KAAK,QAAQ,MAAM;AAAA,UACnB,KAAK,WAAW,MAAM;AAAA,UACtB,KAAK,WAAW,MAAM;AAAA,QACxB,EAAE,KAAK,EAAE;AACT,cAAM,KAAK,WAAW,UAAU,EAAE;AAAA,MACpC;AACA,aAAO,MAAM,KAAK,GAAG;AAAA,IACvB;AAEA,QAAI,SAAS,aAAa;AACxB,YAAM,eAAe,kBAAkB,OAAO;AAE9C,aAAO;AAAA,QACL,QAAQ,CAAC;AAAA,UACP,OAAO,aAAM,aAAa;AAAA,UAC1B,aAAa,gBAAgB;AAAA,UAC7B,OAAO;AAAA;AAAA,UACP,QAAQ;AAAA,YACN,EAAE,MAAM,aAAa,OAAO,eAAe,QAAQ,KAAK;AAAA,YACxD,GAAI,QAAQ,CAAC,EAAE,MAAM,SAAS,OAAO,OAAO,KAAK,GAAG,QAAQ,KAAK,CAAC,IAAI,CAAC;AAAA,YACvE,GAAI,aAAa,CAAC,EAAE,MAAM,cAAc,OAAO,OAAO,UAAU,GAAG,QAAQ,KAAK,CAAC,IAAI,CAAC;AAAA,UACxF;AAAA,UACA,QAAQ,EAAE,MAAM,YAAY,cAAc,eAAe,OAAO,OAAO,EAAE;AAAA,UACzE,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,QACpC,CAAC;AAAA,MACH;AAAA,IACF;AAEA,QAAI,SAAS,WAAW;AACtB,aAAO;AAAA,QACL,QAAQ,CAAC;AAAA,UACP,OAAO,gBAAM,aAAa;AAAA,UAC1B,OAAO;AAAA;AAAA,UACP,QAAQ;AAAA,YACN,EAAE,MAAM,aAAa,OAAO,eAAe,QAAQ,KAAK;AAAA,UAC1D;AAAA,UACA,QAAQ,EAAE,MAAM,YAAY,YAAY,eAAe,KAAK,EAAE;AAAA,UAC9D,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,QACpC,CAAC;AAAA,MACH;AAAA,IACF;AAEA,QAAI,SAAS,gBAAgB;AAC3B,YAAM,eAAe,kBAAkB,OAAO;AAC9C,YAAM,iBAAiB,YAAY,QAAQ,UAAU,QAAQ;AAE7D,aAAO;AAAA,QACL,QAAQ,CAAC;AAAA,UACP,OAAO,gBAAM,aAAa;AAAA,UAC1B,aAAa;AAAA,UACb,OAAO,iBAAiB,WAAW;AAAA;AAAA,UACnC,QAAQ;AAAA,YACN,EAAE,MAAM,aAAa,OAAO,eAAe,QAAQ,KAAK;AAAA,YACxD,EAAE,MAAM,UAAU,OAAO,iBAAiB,iBAAiB,qBAAqB,QAAQ,KAAK;AAAA,UAC/F;AAAA,UACA,QAAQ,EAAE,MAAM,YAAY,iBAAiB,eAAe,OAAO,OAAO,EAAE;AAAA,UAC5E,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,QACpC,CAAC;AAAA,MACH;AAAA,IACF;AAEA,QAAI,SAAS,eAAe;AAC1B,aAAO;AAAA,QACL,QAAQ,CAAC;AAAA,UACP,OAAO;AAAA,UACP,aAAa,YAAY,eAAe,SAAS,OAAO;AAAA,UACxD,OAAO;AAAA;AAAA,UACP,QAAQ,EAAE,MAAM,eAAe;AAAA,UAC/B,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,QACpC,CAAC;AAAA,MACH;AAAA,IACF;AAEA,QAAI,SAAS,eAAe;AAC1B,aAAO;AAAA,QACL,QAAQ,CAAC;AAAA,UACP,OAAO,mBAAY,KAAK;AAAA,UACxB,aAAa,YAAY,mBAAmB,SAAS,OAAO;AAAA,UAC5D,OAAO;AAAA;AAAA,UACP,QAAQ,EAAE,MAAM,sBAAsB,KAAK,GAAG;AAAA,UAC9C,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,QACpC,CAAC;AAAA,MACH;AAAA,IACF;AAEA,QAAI,SAAS,QAAQ;AAEnB,YAAM,cAAc,WAAW,QAAQ,mBAAmB,IAAI;AAE9D,aAAO;AAAA,QACL,QAAQ,CAAC;AAAA,UACP,OAAO,aAAM,aAAa,UAAU,QAAQ;AAAA,UAC5C,aAAa,KAAK,WAAW;AAAA,UAC7B,OAAO;AAAA;AAAA,UACP,QAAQ;AAAA,YACN,EAAE,MAAM,aAAa,OAAO,iBAAiB,WAAW,QAAQ,KAAK;AAAA,YACrE,EAAE,MAAM,QAAQ,OAAO,aAAa,QAAQ,KAAK;AAAA,UACnD;AAAA,UACA,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,QACpC,CAAC;AAAA,MACH;AAAA,IACF;AAGA,WAAO;AAAA,MACL,SAAS,QAAQ,WAAW,aAAM,iBAAiB,SAAS,KAAK,IAAI;AAAA,IACvE;AAAA,EACF;AAaA,iBAAe,4BAA4B,eAAe,iBAAiB,mBAAmB;AAC5F,QAAI,CAAC,qBAAqB,KAAK,CAAC,eAAe;AAC7C,YAAM,KAAK,kEAAkE;AAC7E,aAAO,EAAE,SAAS,MAAM;AAAA,IAC1B;AAEA,QAAI;AAGF,YAAM,mBAAoB,OAAO,WAAW,eAAe,SACvD,GAAG,OAAO,KAAK,IAAI,OAAO,MAAM,KAChC;AACJ,YAAM,qBAAqB;AAAA,QACzB,UAAU;AAAA,QACV,UAAU;AAAA,QACV;AAAA,SACA,oBAAI,KAAK,GAAE,kBAAkB;AAAA,MAC/B,EAAE,KAAK,GAAG;AACV,UAAI,OAAO;AACX,eAAS,IAAI,GAAG,IAAI,mBAAmB,QAAQ,KAAK;AAClD,cAAM,OAAO,mBAAmB,WAAW,CAAC;AAC5C,gBAAS,QAAQ,KAAK,OAAQ;AAC9B,eAAO,OAAO;AAAA,MAChB;AACA,YAAM,YAAY,UAAU,KAAK,IAAI,IAAI,EAAE,SAAS,EAAE;AAEtD,YAAM,IAAI,kDAA2C,eAAe,iBAAiB,mBAAmB,gBAAgB,SAAS;AAGjI,YAAM,gBAAgB;AAAA,QACpB,SAAS;AAAA,QACT,iBAAiB;AAAA,QACjB,aAAY,oBAAI,KAAK,GAAE,YAAY;AAAA,MACrC;AACA,UAAI,iBAAiB;AACnB,sBAAc,mBAAmB;AAAA,MACnC;AACA,UAAI,mBAAmB;AACrB,sBAAc,sBAAsB;AAAA,MACtC;AAGA,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY;AAAA,QACf;AAAA,UACE,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,YAC5C,gBAAgB;AAAA,YAChB,UAAU;AAAA,UACZ;AAAA,UACA,MAAM,KAAK,UAAU,aAAa;AAAA,QACpC;AAAA,MACF;AAEA,UAAI,SAAS,IAAI;AACf,cAAM,IAAI,oDAA+C;AAGzD,cAAM,aAAa,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,iBAAiB,CAAC;AACzE,YAAI,WAAW,iBAAiB;AAC9B,gBAAM,4BAA4B,eAAe,WAAW,eAAe;AAAA,QAC7E;AAEA,eAAO,EAAE,SAAS,KAAK;AAAA,MACzB,OAAO;AACL,cAAM,YAAY,MAAM,SAAS,KAAK;AAGtC,YAAI,SAAS,WAAW,OAAO,UAAU,SAAS,yBAAyB,GAAG;AAC5E,gBAAM,IAAI,wDAA8C,SAAS;AAEjE,gBAAM,gBAAgB,MAAM;AAAA,YAC1B,GAAG,YAAY,mCAAmC,mBAAmB,SAAS,CAAC;AAAA,YAC/E;AAAA,cACE,QAAQ;AAAA,cACR,SAAS;AAAA,gBACP,UAAU;AAAA,gBACV,iBAAiB,UAAU,iBAAiB;AAAA,gBAC5C,gBAAgB;AAAA,gBAChB,UAAU;AAAA,cACZ;AAAA,cACA,MAAM,KAAK,UAAU,aAAa;AAAA,YACpC;AAAA,UACF;AAEA,cAAI,cAAc,IAAI;AACpB,kBAAM,IAAI,qDAAgD;AAG1D,kBAAM,aAAa,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,iBAAiB,CAAC;AACzE,gBAAI,WAAW,iBAAiB;AAC9B,oBAAM,4BAA4B,eAAe,WAAW,eAAe;AAAA,YAC7E;AAEA,mBAAO,EAAE,SAAS,KAAK;AAAA,UACzB,OAAO;AACL,kBAAM,aAAa,MAAM,cAAc,KAAK;AAC5C,kBAAM,MAAM,6BAAwB,cAAc,QAAQ,UAAU;AACpE,mBAAO,EAAE,SAAS,OAAO,OAAO,WAAW;AAAA,UAC7C;AAAA,QACF;AAEA,cAAM,MAAM,uCAAkC,SAAS,QAAQ,SAAS;AACxE,eAAO,EAAE,SAAS,OAAO,OAAO,UAAU;AAAA,MAC5C;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,sCAAiC,KAAK;AAClD,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAKA,iBAAe,4BAA4B,eAAe,iBAAiB;AACzE,QAAI,CAAC,qBAAqB;AAAG;AAE7B,QAAI;AACF,YAAM,IAAI,0DAAmD,aAAa;AAG1E,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY,mDAAmD,eAAe;AAAA,QACjF;AAAA,UACE,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,YAC5C,gBAAgB;AAAA,YAChB,UAAU;AAAA,UACZ;AAAA,UACA,MAAM,KAAK,UAAU;AAAA,YACnB,iBAAiB;AAAA,YACjB,aAAY,oBAAI,KAAK,GAAE,YAAY;AAAA,UACrC,CAAC;AAAA,QACH;AAAA,MACF;AAEA,UAAI,SAAS,IAAI;AACf,cAAM,IAAI,yDAAoD;AAAA,MAChE,OAAO;AACL,cAAM,KAAK,sDAA4C,SAAS,MAAM;AAAA,MACxE;AAAA,IACF,SAAS,OAAO;AACd,YAAM,KAAK,oDAA0C,KAAK;AAAA,IAC5D;AAAA,EACF;AAUA,iBAAe,sBAAsB,eAAe,cAAc,MAAM;AACtE,QAAI,CAAC,qBAAqB,GAAG;AAC3B,YAAM,KAAK,sDAAsD;AACjE,aAAO;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,QACP,uBAAuB;AAAA,MACzB;AAAA,IACF;AAEA,QAAI;AACF,YAAM,IAAI,4CAAqC,cAAc,QAAQ,cAAc,EAAE;AAIrF,YAAM,mBAAoB,OAAO,WAAW,eAAe,SACvD,GAAG,OAAO,KAAK,IAAI,OAAO,MAAM,KAChC;AACJ,YAAM,qBAAqB;AAAA,QACzB,UAAU;AAAA,QACV,UAAU;AAAA,QACV;AAAA,SACA,oBAAI,KAAK,GAAE,kBAAkB;AAAA,MAC/B,EAAE,KAAK,GAAG;AACV,UAAI,OAAO;AACX,eAAS,IAAI,GAAG,IAAI,mBAAmB,QAAQ,KAAK;AAClD,cAAM,OAAO,mBAAmB,WAAW,CAAC;AAC5C,gBAAS,QAAQ,KAAK,OAAQ;AAC9B,eAAO,OAAO;AAAA,MAChB;AACA,YAAM,YAAY,UAAU,KAAK,IAAI,IAAI,EAAE,SAAS,EAAE;AAGtD,UAAI,kBAAkB,cAAc,mBAAmB,cAAc,UAAU,cAAc,eAAe;AAC5G,UAAI,CAAC,iBAAiB;AACpB,cAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,iBAAiB,CAAC;AACrE,0BAAkB,OAAO,mBAAmB;AAC5C,YAAI,iBAAiB;AACnB,gBAAM,IAAI,8CAAyC,eAAe;AAAA,QACpE;AAAA,MACF;AAKA,UAAI,CAAC,iBAAiB;AACpB,cAAM,MAAM,wEAAmE;AAC/E,eAAO;AAAA,UACL,SAAS;AAAA,UACT,OAAO;AAAA,QACT;AAAA,MACF;AAKA,UAAI,iBAAiB,cAAc,MAAM,cAAc,OAAO;AAG9D,YAAM,eAAe,CAAC,OAAO;AAC3B,YAAI,CAAC;AAAI,iBAAO;AAEhB,eAAO,UAAU,KAAK,EAAE,KAAK,aAAa,KAAK,EAAE,KAAK,gBAAgB,KAAK,EAAE;AAAA,MAC/E;AAGA,YAAM,gBAAgB,CAAC,OAAO;AAC5B,YAAI,CAAC;AAAI,iBAAO;AAEhB,eAAO,oBAAoB,KAAK,EAAE;AAAA,MACpC;AAEA,UAAI,kBAAkB,aAAa,cAAc,GAAG;AAClD,cAAM,KAAK,8BAAoB,cAAc,gDAAgD;AAG7F,cAAM,SAAS,cAAc,sBAAsB,cAAc,aAAa,CAAC;AAC/E,cAAM,cAAc;AAAA,UAClB,OAAO;AAAA,UACP,OAAO;AAAA,UACP,OAAO;AAAA,UACP,cAAc;AAAA,UACd,cAAc;AAAA,UACd,cAAc;AAAA;AAAA,UAEd,OAAO,oBAAoB;AAAA,UAC3B,OAAO,oBAAoB;AAAA,QAC7B,EAAE,OAAO,QAAM,MAAM,CAAC,aAAa,EAAE,CAAC;AAGtC,cAAM,SAAS,YAAY,KAAK,aAAa,KAAK,YAAY,CAAC;AAE/D,YAAI,QAAQ;AACV,2BAAiB;AACjB,gBAAM,IAAI,gDAA2C,cAAc,EAAE;AAAA,QACvE,OAAO;AAGL,gBAAM,cAAc,GAAG,eAAe,IAAI,cAAc,IAAI,IAAI,cAAc,KAAK,IAAI,cAAc,KAAK;AAC1G,cAAI,SAAS;AACb,mBAAS,IAAI,GAAG,IAAI,YAAY,QAAQ,KAAK;AAC3C,kBAAM,OAAO,YAAY,WAAW,CAAC;AACrC,sBAAW,UAAU,KAAK,SAAU;AACpC,qBAAS,SAAS;AAAA,UACpB;AACA,2BAAiB,MAAM,KAAK,IAAI,MAAM,EAAE,SAAS,EAAE,CAAC;AACpD,gBAAM,KAAK,gDAAsC,cAAc,EAAE;AAAA,QACnE;AAAA,MACF;AAIA,YAAM,uBAAuB,CAAC,SAAS;AACrC,YAAI;AAEF,cAAI,YAAY;AAChB,cAAI,QAAQ,KAAK,aAAa,KAAK,UAAU,oBAAoB;AAC/D,wBAAY,KAAK,UAAU;AAAA,UAC7B,WAAW,QAAQ,KAAK,oBAAoB;AAC1C,wBAAY,KAAK;AAAA,UACnB,WAAW,QAAQ,KAAK,WAAW;AACjC,wBAAY,KAAK;AAAA,UACnB;AAGA,gBAAM,OAAO,oBAAI,IAAI;AACrB,iBAAO,aAAa,OAAO,cAAc,YAAY,UAAU,sBAAsB,CAAC,KAAK,IAAI,SAAS,GAAG;AACzG,iBAAK,IAAI,SAAS;AAClB,wBAAY,UAAU;AAAA,UACxB;AAGA,cAAI,aAAa,OAAO,UAAU,OAAO,YAAY,UAAU,GAAG,WAAW,KAAK,GAAG;AACnF,gBAAI,UAAU,OAAO,OAAO,UAAU,QAAQ,YAAY,CAAC,UAAU,IAAI,WAAW,KAAK,GAAG;AAC1F,wBAAU,KAAK,UAAU;AAAA,YAC3B,WAAW,UAAU,sBAAsB,UAAU,mBAAmB,MAAM,CAAC,UAAU,mBAAmB,GAAG,WAAW,KAAK,GAAG;AAChI,wBAAU,KAAK,UAAU,mBAAmB;AAAA,YAC9C;AAAA,UACF;AAGA,cAAI,aAAa,OAAO,cAAc,UAAU;AAC9C,gBAAI,UAAU,eAAe,CAAC,UAAU;AAAY,wBAAU,aAAa,UAAU;AACrF,gBAAI,UAAU,cAAc,CAAC,UAAU;AAAW,wBAAU,YAAY,UAAU;AAAA,UACpF;AAIA,cAAI,aAAa,OAAO,cAAc;AAAU,mBAAO;AAAA,QACzD,SAAS,GAAG;AACV,gBAAM,KAAK,sEAA4D,KAAK,EAAE,UAAU,EAAE,UAAU,CAAC;AAAA,QACvG;AACA,eAAO;AAAA,MACT;AAGA,YAAM,oBAAoB,CAAC,KAAK,aAAa;AAC3C,YAAI,CAAC,OAAO,OAAO,QAAQ;AAAU,iBAAO;AAC5C,YAAI,OAAO,IAAI,eAAe;AAAU,iBAAO,IAAI;AACnD,YAAI,OAAO,IAAI,gBAAgB;AAAU,iBAAO,IAAI;AACpD,YAAI,IAAI,MAAM,OAAO,IAAI,OAAO,UAAU;AACxC,cAAI,OAAO,IAAI,GAAG,SAAS;AAAU,mBAAO,IAAI,GAAG;AACnD,cAAI,OAAO,IAAI,GAAG,UAAU;AAAU,mBAAO,IAAI,GAAG;AAAA,QACtD;AACA,YAAI,IAAI,YAAY,OAAO,IAAI,aAAa,UAAU;AACpD,cAAI,OAAO,IAAI,SAAS,gBAAgB;AAAU,mBAAO,IAAI,SAAS;AACtE,cAAI,OAAO,IAAI,SAAS,eAAe;AAAU,mBAAO,IAAI,SAAS;AAAA,QACvE;AACA,eAAO;AAAA,MACT;AAEA,YAAM,cAAc,qBAAqB,aAAa;AAGtD,YAAM,IAAI,0DAAmD;AAAA,QAC3D,WAAW,CAAC,CAAC,YAAY;AAAA,QACzB,eAAe,MAAM,QAAQ,YAAY,MAAM;AAAA,QAC/C,cAAc,YAAY,QAAQ;AAAA,QAClC,YAAY,CAAC,CAAC,YAAY;AAAA,QAC1B,gBAAgB,MAAM,QAAQ,YAAY,OAAO;AAAA,QACjD,eAAe,YAAY,SAAS;AAAA,QACpC,cAAc,OAAO,KAAK,eAAe,CAAC,CAAC,EAAE,MAAM,GAAG,EAAE;AAAA,QACxD,gBAAgB,KAAK,UAAU,WAAW,EAAE,SAAS,MAAM,QAAQ,CAAC;AAAA,MACtE,CAAC;AAED,YAAM,UAAU;AAAA,QACd,mBAAmB;AAAA,QACnB,wBAAwB;AAAA,QACxB,gBAAgB,cAAc,QAAQ;AAAA,QACtC,MAAM,cAAc,QAAQ;AAAA,QAC5B,OAAO,cAAc,SAAS;AAAA,QAC9B,OAAO,cAAc,SAAS;AAAA,QAC9B,WAAW,cAAc,aAAa;AAAA,QACtC,YAAY,cAAc,aAAa,EAAE,SAAS,GAAG,KAAK,EAAE;AAAA,QAC5D,UAAU,cAAc,WAAW,EAAE,SAAS,GAAG,KAAK,GAAG,MAAM,KAAK;AAAA,QACpE,cAAc,cAAc,eAAe;AAAA,QAC3C,aAAa,cAAc,cAAc,EAAE,WAAW,GAAG,UAAU,EAAE;AAAA,QACrE,aAAa,cAAc,eAAe;AAAA,QAC1C,aAAa,kBAAkB,aAAa,cAAc,cAAc,EAAE;AAAA,QAC1E,OAAO,cAAc,SAAS;AAAA,QAC9B,YAAY,cAAc,cAAc;AAAA,QACxC,mBAAmB,cAAc,oBAAoB;AAAA,QACrD,YAAY,cAAc,cAAc,CAAC;AAAA,QACzC,gBAAgB,cAAc,iBAAiB,CAAC;AAAA,QAChD,OAAO,cAAc,SAAS,CAAC;AAAA,QAC/B,QAAQ,cAAc,UAAU,CAAC;AAAA,QACjC,aAAa,cAAc,cAAc,CAAC;AAAA,QAC1C,WAAW,cAAc,aAAa,CAAC;AAAA,QACvC,YAAY,cAAc,cAAc,CAAC;AAAA,QACzC,oBAAoB,cAAc,qBAAqB;AAAA;AAAA,QAEvD,WAAW;AAAA;AAAA;AAAA,QAGX,oBAAoB;AAAA,QACpB,aAAY,oBAAI,KAAK,GAAE,YAAY;AAAA,MACrC;AAGA,UAAI,aAAa;AACf,cAAM,kBAAkB,MAAM;AAAA,UAC5B,GAAG,YAAY,4CAA4C,WAAW;AAAA,UACtE;AAAA,YACE,SAAS;AAAA,cACP,UAAU;AAAA,cACV,iBAAiB,UAAU,iBAAiB;AAAA,YAC9C;AAAA,UACF;AAAA,QACF;AACA,YAAI,gBAAgB,IAAI;AACtB,gBAAM,WAAW,MAAM,gBAAgB,KAAK;AAC5C,cAAI,SAAS,SAAS,GAAG;AAGvB,oBAAQ,kBAAkB,SAAS,CAAC,EAAE;AACtC,kBAAM,IAAI,6BAAwB,SAAS,CAAC,EAAE,EAAE;AAAA,UAClD;AAAA,QACF;AAAA,MACF,OAAO;AAEL,YAAI,gBAAgB;AAGpB,YAAI;AACF,gBAAM,eAAe,MAAM;AAAA,YACzB,GAAG,YAAY,mCAAmC,SAAS;AAAA,YAC3D;AAAA,cACE,SAAS;AAAA,gBACP,UAAU;AAAA,gBACV,iBAAiB,UAAU,iBAAiB;AAAA,cAC9C;AAAA,YACF;AAAA,UACF;AACA,cAAI,aAAa,IAAI;AACnB,kBAAM,aAAa,MAAM,aAAa,KAAK;AAC3C,gBAAI,WAAW,SAAS,KAAK,WAAW,CAAC,EAAE,iBAAiB;AAC1D,8BAAgB,WAAW,CAAC,EAAE;AAC9B,oBAAM,IAAI,kDAA6C,aAAa;AAAA,YACtE;AAAA,UACF;AAAA,QACF,SAAS,OAAO;AACd,gBAAM,KAAK,6CAAmC,MAAM,OAAO;AAAA,QAC7D;AAGA,YAAI,CAAC,iBAAiB,QAAQ,mBAAmB;AAC/C,cAAI;AACF,kBAAM,kBAAkB,MAAM;AAAA,cAC5B,GAAG,YAAY,iDAAiD,QAAQ,iBAAiB;AAAA,cACzF;AAAA,gBACE,SAAS;AAAA,kBACP,UAAU;AAAA,kBACV,iBAAiB,UAAU,iBAAiB;AAAA,gBAC9C;AAAA,cACF;AAAA,YACF;AACA,gBAAI,gBAAgB,IAAI;AACtB,oBAAM,WAAW,MAAM,gBAAgB,KAAK;AAC5C,kBAAI,SAAS,SAAS,KAAK,SAAS,CAAC,EAAE,iBAAiB;AACtD,gCAAgB,SAAS,CAAC,EAAE;AAG5B,sBAAM,IAAI,+CAA0C,aAAa;AACjE,sBAAM,IAAI,6BAAwB,SAAS,CAAC,EAAE,EAAE;AAEhD,sBAAM;AAAA,kBACJ;AAAA,kBACA,SAAS,CAAC,EAAE;AAAA,kBACZ,SAAS,CAAC,EAAE;AAAA,gBACd;AAEA,oBAAI,SAAS,CAAC,EAAE,aAAa;AAC3B,wBAAM,kBAAkB,MAAM,0BAA0B;AACxD,sBAAI,CAAC,gBAAgB,YAAY;AAC/B,0BAAM,IAAI,2CAAsC;AAChD,0BAAM,0BAA0B,SAAS,CAAC,EAAE,aAAa,IAAI;AAAA,kBAC/D;AAAA,gBACF;AAAA,cACF;AAAA,YACF;AAAA,UACF,SAAS,OAAO;AACd,kBAAM,KAAK,0CAAgC,MAAM,OAAO;AAAA,UAC1D;AAAA,QACF;AAGA,YAAI,CAAC,eAAe;AAClB,cAAI;AACF,kBAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,kBAAkB,CAAC;AACtE,gBAAI,OAAO,kBAAkB;AAC3B,oBAAM,kBAAkB,MAAM;AAAA,gBAC5B,GAAG,YAAY,kCAAkC,OAAO,gBAAgB;AAAA,gBACxE;AAAA,kBACE,SAAS;AAAA,oBACP,UAAU;AAAA,oBACV,iBAAiB,UAAU,iBAAiB;AAAA,kBAC9C;AAAA,gBACF;AAAA,cACF;AACA,kBAAI,gBAAgB,IAAI;AACtB,sBAAM,WAAW,MAAM,gBAAgB,KAAK;AAC5C,oBAAI,SAAS,SAAS,KAAK,SAAS,CAAC,EAAE,iBAAiB;AACtD,kCAAgB,SAAS,CAAC,EAAE;AAG5B,wBAAM,IAAI,qDAAgD,aAAa;AACvE,wBAAM,IAAI,6BAAwB,SAAS,CAAC,EAAE,EAAE;AAEhD,wBAAM;AAAA,oBACJ;AAAA,oBACA,SAAS,CAAC,EAAE;AAAA,oBACZ,SAAS,CAAC,EAAE;AAAA,kBACd;AAEA,sBAAI,SAAS,CAAC,EAAE,aAAa;AAC3B,0BAAM,kBAAkB,MAAM,0BAA0B;AACxD,wBAAI,CAAC,gBAAgB,YAAY;AAC/B,4BAAM,IAAI,kDAA6C;AACvD,4BAAM,0BAA0B,SAAS,CAAC,EAAE,aAAa,IAAI;AAAA,oBAC/D;AAAA,kBACF;AAAA,gBACF;AAAA,cACF;AAAA,YACF;AAAA,UACF,SAAS,OAAO;AACd,kBAAM,KAAK,gDAAsC,MAAM,OAAO;AAAA,UAChE;AAAA,QACF;AAEA,gBAAQ,kBAAkB,iBAAiB;AAC3C,YAAI,CAAC,eAAe;AAClB,gBAAM,IAAI,0EAAgE;AAAA,QAC5E;AAAA,MACF;AAEA,YAAM,IAAI,oDAA6C,QAAQ,cAAc;AAG7E,UAAI;AACF,cAAM,MAAM,QAAQ;AACpB,cAAM,UAAU,OAAO,OAAO,QAAQ,YAAY,CAAC,MAAM,QAAQ,GAAG,IAAI,OAAO,KAAK,GAAG,IAAI,CAAC;AAC5F,YAAI,YAAY;AAChB,YAAI;AACF,cAAI,OAAO,OAAO,QAAQ,UAAU;AAClC,kBAAM,UAAU,QAAQ,MAAM,GAAG,EAAE;AACnC,wBAAY,KAAK,UAAU,KAAK,OAAO;AAAA,UACzC,OAAO;AACL,wBAAY,OAAO,GAAG;AAAA,UACxB;AAAA,QACF,SAAS,GAAG;AACV,sBAAY;AAAA,QACd;AACA,cAAM,IAAI,mDAA4C;AAAA,UACpD,wBAAwB,QAAQ;AAAA,UAChC,gBAAgB,QAAQ;AAAA,UACxB,gBAAgB,QAAQ;AAAA,UACxB,UAAU,QAAQ,MAAM,GAAG,EAAE;AAAA,UAC7B,YAAY,aAAa,UAAU,QAAQ,UAAU,MAAM,GAAG,GAAI,IAAI;AAAA,QACxE,CAAC;AAAA,MACH,SAAS,GAAG;AACV,cAAM,KAAK,yEAA+D,KAAK,EAAE,UAAU,EAAE,UAAU,CAAC;AAAA,MAC1G;AAIA,UAAI;AACF,cAAM,iBAAiB,MAAM;AAAA,UAC3B,GAAG,YAAY,mDAAmD,mBAAmB,QAAQ,iBAAiB,CAAC,sBAAsB,mBAAmB,QAAQ,cAAc,CAAC;AAAA,UAC/K;AAAA,YACE,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,UAAU;AAAA,cACV,iBAAiB,UAAU,iBAAiB;AAAA,cAC5C,UAAU;AAAA,YACZ;AAAA,UACF;AAAA,QACF;AACA,YAAI,eAAe,IAAI;AACrB,gBAAM,IAAI,+DAAwD;AAAA,QACpE;AAAA,MACF,SAAS,aAAa;AACpB,cAAM,KAAK,oDAA0C,YAAY,OAAO;AAAA,MAE1E;AAGA,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY;AAAA,QACf;AAAA,UACE,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,YAC5C,gBAAgB;AAAA,YAChB,UAAU;AAAA,UACZ;AAAA,UACA,MAAM,KAAK,UAAU,OAAO;AAAA,QAC9B;AAAA,MACF;AAEA,UAAI,CAAC,SAAS,IAAI;AAChB,cAAM,YAAY,MAAM,SAAS,KAAK;AACtC,cAAM,IAAI,qDAA2C,SAAS,QAAQ,SAAS;AAG/E,cAAM,iBAAiB,MAAM;AAAA,UAC3B,GAAG,YAAY,wDAAwD,cAAc,EAAE;AAAA,UACvF;AAAA,YACE,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,UAAU;AAAA,cACV,iBAAiB,UAAU,iBAAiB;AAAA,cAC5C,gBAAgB;AAAA,cAChB,UAAU;AAAA,YACZ;AAAA,YACA,MAAM,KAAK,UAAU,OAAO;AAAA,UAC9B;AAAA,QACF;AAEA,YAAI,CAAC,eAAe,IAAI;AACtB,gBAAM,aAAa,MAAM,eAAe,KAAK;AAC7C,gBAAM,MAAM,uCAAkC,eAAe,QAAQ,UAAU;AAC/E,gBAAM,IAAI,MAAM,4BAA4B,UAAU,EAAE;AAAA,QAC1D;AACA,cAAM,IAAI,oCAA+B;AAAA,MAC3C,OAAO;AACL,cAAM,IAAI,oCAA+B;AAAA,MAC3C;AAEA,YAAM,IAAI,wCAAmC,cAAc,IAAI;AAG/D,YAAM,WAAW,QAAQ,MAAM,IAAI;AAAA,QACjC,eAAc,oBAAI,KAAK,GAAE,YAAY;AAAA,MACvC,CAAC;AAED,aAAO,EAAE,SAAS,KAAK;AAAA,IACzB,SAAS,OAAO;AACd,YAAM,MAAM,iDAA4C,KAAK;AAC7D,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAMA,iBAAe,6BAA6B,aAAa,OAAO;AAC9D,QAAI,CAAC,qBAAqB,GAAG;AAC3B,YAAM,KAAK,kDAAkD;AAC7D,aAAO;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,QACP,uBAAuB;AAAA,MACzB;AAAA,IACF;AAEA,QAAI;AACF,YAAM,IAAI,kDAA2C,aAAa,KAAK;AAGvE,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY,wDAAwD,WAAW;AAAA,QAClF;AAAA,UACE,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,YAC5C,gBAAgB;AAAA,YAChB,UAAU;AAAA,UACZ;AAAA,UACA,MAAM,KAAK,UAAU;AAAA,YACnB,oBAAoB;AAAA,UACtB,CAAC;AAAA,QACH;AAAA,MACF;AAEA,UAAI,CAAC,SAAS,IAAI;AAChB,cAAM,YAAY,MAAM,SAAS,KAAK;AACtC,cAAM,MAAM,4CAAuC,SAAS,QAAQ,SAAS;AAC7E,eAAO,EAAE,SAAS,OAAO,OAAO,gBAAgB,SAAS,MAAM,GAAG;AAAA,MACpE;AAEA,YAAM,IAAI,wDAAmD;AAC7D,aAAO,EAAE,SAAS,KAAK;AAAA,IACzB,SAAS,OAAO;AACd,YAAM,MAAM,sDAAiD,KAAK;AAClE,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAMA,iBAAe,iCAAiC,eAAe,aAAa;AAC1E,QAAI;AACF,YAAM,IAAI,yDAAkD,aAAa,KAAK,WAAW,GAAG;AAG5F,YAAM,gBAAgB,MAAM,0BAA0B;AACtD,YAAM,gBAAgB,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,oBAAoB,oBAAoB,CAAC;AAEnG,YAAM,IAAI,6BAAsB,EAAE,QAAQ,CAAC,CAAC,cAAc,YAAY,SAAS,cAAc,QAAQ,CAAC;AACtG,YAAM,IAAI,6BAAsB,EAAE,cAAc,CAAC,CAAC,cAAc,kBAAkB,SAAS,CAAC,CAAC,cAAc,mBAAmB,CAAC;AAG/H,YAAM,wBAAwB,cAAc,cAAc,cAAc;AACxE,YAAM,wBAAwB,cAAc,oBAAoB,cAAc;AAE9E,UAAI,CAAC,yBAAyB,CAAC,uBAAuB;AACpD,cAAM,IAAI,yEAAoE;AAC9E,eAAO;AAAA,UACL,SAAS;AAAA,UACT,OAAO;AAAA,UACP,YAAY;AAAA,UACZ,SAAS;AAAA,QACX;AAAA,MACF;AAEA,UAAI,aAAa,cAAc;AAE/B,UAAI,uBAAuB;AAGzB,cAAM,aAAa,IAAI,IAAI,cAAc,UAAU;AACnD,cAAM,QAAQ,WAAW,SAAS,MAAM,GAAG,EAAE,CAAC;AAE9C,cAAM,IAAI,mCAA4B,KAAK,mBAAmB,aAAa,EAAE;AAAA,MAC/E,WAAW,uBAAuB;AAChC,cAAM,IAAI,yDAAkD,aAAa,EAAE;AAC3E,qBAAa;AAAA,MACf;AAGA,YAAM,gBAAgB,MAAM,iBAAiB;AAE7C,YAAM,sBAAsB,eAAe,kBAAkB,eAAe;AAE5E,YAAM,IAAI,4CAAqC,aAAa,gBAAgB,mBAAmB,GAAG;AAClG,YAAM,IAAI,oCAA6B,aAAa;AAGpD,YAAM,wBAAwB,eAAe,KAAK,EAAE,YAAY;AAChE,YAAM,uBAAuB,qBAAqB,KAAK,EAAE,YAAY;AAErE,YAAM,IAAI,6CAAsC,qBAAqB,gBAAgB,oBAAoB,GAAG;AAE5G,UAAI,iBAAiB,yBAAyB,wBAAwB,0BAA0B,sBAAsB;AACpH,cAAM,IAAI,oBAAe,aAAa,yDAAyD;AAE/F,eAAO;AAAA,UACL,SAAS;AAAA,UACT,OAAO;AAAA,UACP,YAAY,cAAc;AAAA,UAC1B,SAAS,aAAa,aAAa,iCAAiC,cAAc,gBAAgB;AAAA,UAClG,eAAe;AAAA,YACb,MAAM;AAAA,YACN,MAAM,cAAc;AAAA,YACpB,OAAO,cAAc;AAAA,YACrB,OAAO,cAAc;AAAA,YACrB,eAAe;AAAA,UACjB;AAAA,QACF;AAAA,MACF,OAAO;AACL,cAAM,IAAI,oBAAe,aAAa,+DAA+D;AACrG,cAAM,IAAI,8BAAyB,qBAAqB,UAAU,oBAAoB,GAAG;AAEzF,eAAO;AAAA,UACL,SAAS;AAAA,UACT,OAAO;AAAA,UACP,YAAY;AAAA,UACZ,SAAS,aAAa,aAAa;AAAA,UACnC,oBAAoB,gBAAgB;AAAA,YAClC,MAAM;AAAA,YACN,MAAM,cAAc;AAAA,YACpB,OAAO,cAAc;AAAA,YACrB,OAAO,cAAc;AAAA,UACvB,IAAI;AAAA,QACN;AAAA,MACF;AAAA,IAEF,SAAS,OAAO;AACd,YAAM,MAAM,wDAAmD,KAAK;AACpE,aAAO;AAAA,QACL,SAAS;AAAA,QACT,OAAO,MAAM;AAAA,MACf;AAAA,IACF;AAAA,EACF;AAMA,iBAAe,sBAAsB,KAAK,OAAO;AAC/C,QAAI;AACF,YAAM,IAAI,0CAAmC,GAAG;AAEhD,YAAM,UAAU;AAAA,QACd,gBAAgB;AAAA,MAClB;AAEA,UAAI,OAAO;AACT,gBAAQ,eAAe,IAAI,UAAU,KAAK;AAAA,MAC5C;AAEA,YAAM,WAAW,MAAM,MAAM,KAAK;AAAA,QAChC,QAAQ;AAAA,QACR;AAAA,MACF,CAAC;AAED,UAAI,CAAC,SAAS,IAAI;AAChB,cAAM,YAAY,MAAM,SAAS,KAAK;AACtC,cAAM,MAAM,sCAAiC,SAAS,QAAQ,SAAS;AACvE,eAAO,EAAE,SAAS,OAAO,OAAO,cAAc,SAAS,MAAM,GAAG;AAAA,MAClE;AAEA,YAAM,OAAO,MAAM,SAAS,KAAK;AACjC,YAAM,IAAI,uCAAkC;AAC5C,aAAO,EAAE,SAAS,MAAM,KAAW;AAAA,IACrC,SAAS,OAAO;AACd,YAAM,MAAM,8CAAyC,KAAK;AAC1D,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AASA,WAAS,uBAAuB;AAC9B,WAAO,gBACA,CAAC,aAAa,SAAS,cAAc,KACrC,qBACA,sBAAsB;AAAA,EAC/B;AAMA,MAAI,iBAAiB;AACrB,MAAI,oBAAoB;AACxB,MAAI,qBAAqB;AAMzB,WAAS,2BAA2B,aAAa;AAC/C,QAAI,CAAC,qBAAqB,GAAG;AAC3B,YAAM,KAAK,wDAAwD;AACnE;AAAA,IACF;AAGA,yBAAqB;AAGrB,QAAI,gBAAgB;AAClB,qBAAe,MAAM;AAAA,IACvB;AAGA,UAAM,aAAa,aAAa,QAAQ,YAAY,EAAE,EAAE,MAAM,GAAG,EAAE,CAAC;AACpE,UAAM,QAAQ,SAAS,UAAU,6CAA6C,iBAAiB;AAE/F,UAAM,IAAI,0DAAmD,WAAW;AAExE,QAAI;AACF,uBAAiB,IAAI,UAAU,KAAK;AAEpC,qBAAe,SAAS,MAAM;AAC5B,cAAM,IAAI,qCAAgC;AAG1C,cAAM,cAAc;AAAA,UAClB,OAAO,mDAAmD,WAAW;AAAA,UACrE,OAAO;AAAA,UACP,SAAS;AAAA,YACP,QAAQ;AAAA,cACN,WAAW,EAAE,MAAM,MAAM;AAAA,cACzB,UAAU,EAAE,KAAK,GAAG;AAAA,cACpB,kBAAkB,CAAC;AAAA,gBACjB,OAAO;AAAA,gBACP,QAAQ;AAAA,gBACR,OAAO;AAAA,gBACP,QAAQ,mBAAmB,WAAW;AAAA,cACxC,CAAC;AAAA,YACH;AAAA,UACF;AAAA,UACA,KAAK;AAAA,QACP;AACA,uBAAe,KAAK,KAAK,UAAU,WAAW,CAAC;AAG/C,4BAAoB,YAAY,MAAM;AACpC,cAAI,kBAAkB,eAAe,eAAe,UAAU,MAAM;AAClE,2BAAe,KAAK,KAAK,UAAU;AAAA,cACjC,OAAO;AAAA,cACP,OAAO;AAAA,cACP,SAAS,CAAC;AAAA,cACV,KAAK,KAAK,IAAI,EAAE,SAAS;AAAA,YAC3B,CAAC,CAAC;AAAA,UACJ;AAAA,QACF,GAAG,GAAK;AAAA,MACV;AAEA,qBAAe,YAAY,OAAO,UAAU;AAC1C,YAAI;AACF,gBAAM,UAAU,KAAK,MAAM,MAAM,IAAI;AACrC,gBAAM,IAAI,+BAAwB,QAAQ,KAAK;AAG/C,cAAI,QAAQ,UAAU,sBAAsB,QAAQ,SAAS,MAAM,QAAQ;AACzE,kBAAM,SAAS,QAAQ,QAAQ,KAAK;AAGpC,gBAAI,OAAO,WAAW,eAAe,OAAO,iBAAiB;AAC3D,oBAAM,IAAI,2DAAoD,OAAO,eAAe;AAGpF,oBAAM;AAAA,gBACJ,OAAO;AAAA,gBACP,OAAO;AAAA,gBACP,OAAO;AAAA,cACT;AAGA,kBAAI,OAAO,aAAa;AACtB,sBAAM,IAAI,+CAAwC,OAAO,YAAY,UAAU,GAAG,EAAE,IAAI,KAAK;AAC7F,sBAAM,0BAA0B,OAAO,aAAa,MAAM,OAAO,kBAAkB;AAGnF,sBAAM,WAAW,QAAQ,MAAM,IAAI;AAAA,kBACjC,kBAAkB,OAAO;AAAA,kBACzB,kBAAkB,OAAO;AAAA,gBAC3B,CAAC;AAGD,2CAA2B,OAAO,EAAE;AACpC,sBAAM,IAAI,2DAAsD;AAAA,cAClE;AAGA,kBAAI;AACF,sBAAM,WAAW,QAAQ,YAAY;AAAA,kBACnC,QAAQ;AAAA,kBACR,eAAe,OAAO;AAAA,kBACtB,iBAAiB,OAAO;AAAA,kBACxB,mBAAmB,OAAO;AAAA,kBAC1B,YAAY,OAAO;AAAA,kBACnB,YAAY,OAAO;AAAA,kBACnB,WAAW,OAAO;AAAA,gBACpB,CAAC;AAAA,cACH,SAAS,GAAG;AAEV,sBAAM,IAAI,4CAA4C;AAAA,cACxD;AAGA,6CAA+B;AAAA,YACjC;AAAA,UACF;AAAA,QACF,SAAS,GAAG;AACV,gBAAM,KAAK,sCAAsC,CAAC;AAAA,QACpD;AAAA,MACF;AAEA,qBAAe,UAAU,CAAC,UAAU;AAClC,cAAM,KAAK,6BAA6B,KAAK;AAAA,MAC/C;AAEA,qBAAe,UAAU,MAAM;AAC7B,cAAM,IAAI,qCAA8B;AACxC,YAAI,mBAAmB;AACrB,wBAAc,iBAAiB;AAC/B,8BAAoB;AAAA,QACtB;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,kCAAkC,KAAK;AAAA,IACrD;AAAA,EACF;AAKA,WAAS,iCAAiC;AACxC,QAAI,gBAAgB;AAClB,qBAAe,MAAM;AACrB,uBAAiB;AAAA,IACnB;AACA,QAAI,mBAAmB;AACrB,oBAAc,iBAAiB;AAC/B,0BAAoB;AAAA,IACtB;AACA,yBAAqB;AACrB,UAAM,IAAI,sDAA+C;AAAA,EAC3D;AAyBA,iBAAe,qBAAqB,MAAM,mBAAmB,iBAAiB;AAE5E,QAAI,CAAC,qBAAqB,GAAG;AAC3B,YAAM,KAAK,+CAA+C;AAC1D,aAAO;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,QACP,uBAAuB;AAAA,MACzB;AAAA,IACF;AAEA,QAAI;AAGF,UAAI,iBAAiB;AACnB,YAAI;AACF,gBAAM,iBAAiB,MAAM;AAAA,YAC3B,GAAG,YAAY,iDAAiD,eAAe;AAAA,YAC/E;AAAA,cACE,QAAQ;AAAA,cACR,SAAS;AAAA,gBACP,gBAAgB;AAAA,gBAChB,UAAU;AAAA,gBACV,iBAAiB,UAAU,iBAAiB;AAAA,gBAC5C,UAAU;AAAA,cACZ;AAAA,cACA,MAAM,KAAK,UAAU,EAAE,QAAQ,UAAU,CAAC;AAAA,YAC5C;AAAA,UACF;AACA,cAAI,eAAe,IAAI;AACrB,kBAAM,IAAI,kEAA2D,eAAe;AAAA,UACtF;AAAA,QACF,SAAS,aAAa;AACpB,gBAAM,KAAK,+CAAqC,YAAY,OAAO;AAAA,QAErE;AAAA,MACF;AAEA,YAAM,WAAW,MAAM,MAAM,GAAG,YAAY,4BAA4B;AAAA,QACtE,QAAQ;AAAA,QACR,SAAS;AAAA,UACP,gBAAgB;AAAA,UAChB,UAAU;AAAA,UACV,iBAAiB,UAAU,iBAAiB;AAAA,UAC5C,UAAU;AAAA,QACZ;AAAA,QACA,MAAM,KAAK,UAAU;AAAA,UACnB,cAAc;AAAA,UACd,oBAAoB;AAAA,UACpB,mBAAmB;AAAA;AAAA,UACnB,QAAQ;AAAA,QACV,CAAC;AAAA,MACH,CAAC;AAED,UAAI,SAAS,IAAI;AACf,cAAM,IAAI,mCAA8B,MAAM,uBAAuB,eAAe;AAIpF,mCAA2B,IAAI;AAE/B,eAAO,EAAE,SAAS,MAAM,KAAK;AAAA,MAC/B,OAAO;AACL,cAAM,QAAQ,MAAM,SAAS,KAAK;AAClC,cAAM,MAAM,oCAA+B,KAAK;AAChD,eAAO,EAAE,SAAS,OAAO,OAAO,gCAAgC;AAAA,MAClE;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,0BAAqB,KAAK;AACtC,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAKA,iBAAe,oBAAoB,MAAM;AAEvC,QAAI,CAAC,qBAAqB,GAAG;AAC3B,aAAO,EAAE,SAAS,OAAO,OAAO,2BAA2B,uBAAuB,KAAK;AAAA,IACzF;AAEA,QAAI;AACF,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY,4CAA4C,IAAI;AAAA,QAC/D;AAAA,UACE,SAAS;AAAA,YACP,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,UAC9C;AAAA,QACF;AAAA,MACF;AAEA,UAAI,SAAS,IAAI;AACf,cAAM,OAAO,MAAM,SAAS,KAAK;AACjC,YAAI,KAAK,SAAS,GAAG;AACnB,gBAAM,UAAU,KAAK,CAAC;AACtB,cAAI,QAAQ,WAAW,eAAe,QAAQ,aAAa;AACzD,kBAAM,IAAI,mCAA8B;AACxC,mBAAO;AAAA,cACL,SAAS;AAAA,cACT,WAAW;AAAA,cACX,YAAY,QAAQ;AAAA,cACpB,YAAY,QAAQ;AAAA,cACpB,WAAW,QAAQ;AAAA;AAAA,cACnB,eAAe,QAAQ;AAAA;AAAA,cACvB,iBAAiB,QAAQ;AAAA,cACzB,mBAAmB,QAAQ;AAAA,YAC7B;AAAA,UACF,OAAO;AACL,mBAAO,EAAE,SAAS,MAAM,WAAW,MAAM;AAAA,UAC3C;AAAA,QACF,OAAO;AACL,iBAAO,EAAE,SAAS,OAAO,OAAO,yBAAyB;AAAA,QAC3D;AAAA,MACF,OAAO;AACL,eAAO,EAAE,SAAS,OAAO,OAAO,0BAA0B;AAAA,MAC5D;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,gCAA2B,KAAK;AAC5C,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAKA,iBAAe,2BAA2B,YAAY,MAAM;AAC1D,QAAI,CAAC,qBAAqB,GAAG;AAC3B,YAAM,KAAK,sDAAsD;AACjE,aAAO,CAAC;AAAA,IACV;AAEA,QAAI;AACF,UAAI,aAAa,CAAC;AAElB,UAAI,WAAW;AAEb,cAAM,WAAW,MAAM;AAAA,UACrB,GAAG,YAAY,kCAAkC,SAAS;AAAA,UAC1D;AAAA,YACE,SAAS;AAAA,cACP,UAAU;AAAA,cACV,iBAAiB,UAAU,iBAAiB;AAAA,YAC9C;AAAA,UACF;AAAA,QACF;AAEA,YAAI,SAAS,IAAI;AACf,gBAAM,WAAW,MAAM,SAAS,KAAK;AACrC,cAAI,SAAS,SAAS,GAAG;AACvB,kBAAM,gBAAgB,SAAS,CAAC,EAAE;AAGlC,kBAAM,gBAAgB,MAAM;AAAA,cAC1B,GAAG,YAAY,iDAAiD,aAAa;AAAA,cAC7E;AAAA,gBACE,SAAS;AAAA,kBACP,UAAU;AAAA,kBACV,iBAAiB,UAAU,iBAAiB;AAAA,gBAC9C;AAAA,cACF;AAAA,YACF;AAEA,gBAAI,cAAc,IAAI;AACpB,2BAAa,MAAM,cAAc,KAAK;AAAA,YACxC;AAAA,UACF;AAAA,QACF;AAAA,MACF,OAAO;AAEL,cAAM,WAAW,MAAM,0BAA0B;AACjD,YAAI,SAAS,WAAW;AACtB,iBAAO,MAAM,2BAA2B,SAAS,SAAS;AAAA,QAC5D;AAAA,MACF;AAEA,YAAM,IAAI,uBAAgB,WAAW,MAAM,wBAAwB;AACnE,aAAO;AAAA,IACT,SAAS,OAAO;AACd,YAAM,MAAM,oDAA+C,KAAK;AAChE,aAAO,CAAC;AAAA,IACV;AAAA,EACF;AAMA,MAAI,wBAAwB;AAC5B,MAAI,2BAA2B;AAC/B,MAAI,mBAAmB;AACvB,MAAI,kCAAkC;AAOtC,iBAAe,2BAA2B,WAAW;AACnD,QAAI,CAAC,WAAW;AACd,YAAM,WAAW,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,kBAAkB,CAAC;AACxE,kBAAY,SAAS;AAAA,IACvB;AAEA,QAAI,CAAC,WAAW;AACd,YAAM,KAAK,kDAAkD;AAC7D;AAAA,IACF;AAEA,QAAI,CAAC,qBAAqB,GAAG;AAC3B,YAAM,KAAK,6DAAwD;AACnE;AAAA,IACF;AAGA,QAAI,yBAAyB,sBAAsB,eAAe,UAAU,QAAQ,qBAAqB,WAAW;AAClH,YAAM,IAAI,mDAAmD,SAAS;AACtE;AAAA,IACF;AAGA,mCAA+B;AAE/B,uBAAmB;AAEnB,UAAM,aAAa,aAAa,QAAQ,YAAY,EAAE,EAAE,MAAM,GAAG,EAAE,CAAC;AACpE,UAAM,QAAQ,SAAS,UAAU,6CAA6C,iBAAiB;AAE/F,UAAM,IAAI,oEAA6D,SAAS;AAEhF,QAAI;AACF,8BAAwB,IAAI,UAAU,KAAK;AAE3C,4BAAsB,SAAS,MAAM;AACnC,cAAM,IAAI,6CAAwC;AAGlD,cAAM,QAAQ;AACd,cAAM,cAAc;AAAA,UAClB;AAAA,UACA,OAAO;AAAA,UACP,SAAS;AAAA,YACP,QAAQ;AAAA,cACN,kBAAkB,CAAC;AAAA,gBACjB,OAAO;AAAA;AAAA,gBACP,QAAQ;AAAA,gBACR,OAAO;AAAA;AAAA,gBACP,QAAQ,iBAAiB,SAAS;AAAA;AAAA,cACpC,CAAC;AAAA,YACH;AAAA,UACF;AAAA,UACA,KAAK;AAAA,QACP;AAEA,cAAM,IAAI,8CAAuC,KAAK,UAAU,aAAa,MAAM,CAAC,CAAC;AACrF,8BAAsB,KAAK,KAAK,UAAU,WAAW,CAAC;AAGtD,+BAAuB;AAGvB,mCAA2B,YAAY,MAAM;AAC3C,cAAI,yBAAyB,sBAAsB,eAAe,UAAU,MAAM;AAChF,kCAAsB,KAAK,KAAK,UAAU;AAAA,cACxC,OAAO;AAAA,cACP,OAAO;AAAA,cACP,SAAS,CAAC;AAAA,cACV,KAAK,YAAY,KAAK,IAAI;AAAA,YAC5B,CAAC,CAAC;AAEF,iCAAqB;AAAA,UACvB;AAAA,QACF,GAAG,GAAI;AAGP,6BAAqB;AAAA,MACvB;AAEA,4BAAsB,YAAY,OAAO,UAAU;AACjD,YAAI;AACF,gBAAM,UAAU,KAAK,MAAM,MAAM,IAAI;AAGrC,gBAAM,IAAI,mCAA4B,KAAK,UAAU,OAAO,EAAE,UAAU,GAAG,GAAG,CAAC;AAG/E,cAAI,QAAQ,UAAU,aAAa;AACjC,gBAAI,QAAQ,SAAS,WAAW,MAAM;AACpC,oBAAM,IAAI,qDAAgD,QAAQ,SAAS,SAAS;AAAA,YACtF,OAAO;AACL,oBAAM,MAAM,wCAAmC,QAAQ,SAAS,YAAY,QAAQ,OAAO;AAAA,YAC7F;AACA;AAAA,UACF;AAGA,cAAI,QAAQ,UAAU,YAAY,QAAQ,SAAS,WAAW,MAAM;AAClE,kBAAM,IAAI,iCAA4B,QAAQ,SAAS,WAAW,WAAW;AAC7E;AAAA,UACF;AAGA,cAAI,QAAQ,UAAU,oBAAoB;AACxC,kBAAM,UAAU,QAAQ;AAExB,kBAAM,IAAI,8CAAuC,SAAS,MAAM,QAAQ,cAAc;AAGtF,gBAAI,SAAS,MAAM,SAAS,YAAY,QAAQ,KAAK,QAAQ;AAC3D,oBAAM,SAAS,QAAQ,KAAK;AAE5B,oBAAM,IAAI,yCAAkC,OAAO,cAAc,OAAO,OAAO,EAAE;AAGjF,kBAAI,OAAO,WAAW,WAAW;AAC/B,sBAAM,IAAI,6BAAwB,OAAO,YAAY;AACrD,sBAAM,eAAe,MAAM;AAAA,cAC7B,OAAO;AACL,sBAAM,IAAI,8CAAoC,OAAO,MAAM;AAAA,cAC7D;AAAA,YACF;AACA;AAAA,UACF;AAGA,cAAI,QAAQ,UAAU,aAAa;AACjC,kBAAM,SAAS,QAAQ,SAAS,UAAU,QAAQ,SAAS,OAAO,QAAQ;AAE1E,kBAAM,IAAI,yCAAkC,KAAK,UAAU,MAAM,EAAE,UAAU,GAAG,GAAG,CAAC;AAEpF,gBAAI,UAAU,OAAO,WAAW,WAAW;AACzC,oBAAM,IAAI,sDAA+C,OAAO,cAAc,OAAO,EAAE;AACvF,oBAAM,eAAe,MAAM;AAAA,YAC7B;AAAA,UACF;AAAA,QACF,SAAS,GAAG;AACV,gBAAM,KAAK,8CAA8C,CAAC;AAAA,QAC5D;AAAA,MACF;AAEA,4BAAsB,UAAU,CAAC,UAAU;AACzC,cAAM,KAAK,qCAAqC,KAAK;AAAA,MACvD;AAEA,4BAAsB,UAAU,MAAM;AACpC,cAAM,IAAI,6CAAsC;AAChD,YAAI,0BAA0B;AAC5B,wBAAc,wBAAwB;AACtC,qCAA2B;AAAA,QAC7B;AAGA,YAAI,kBAAkB;AACpB,gBAAM,IAAI,uDAAkD;AAC5D,4CAAkC,WAAW,MAAM;AACjD,gBAAI,kBAAkB;AACpB,yCAA2B,gBAAgB;AAAA,YAC7C;AAAA,UACF,GAAG,GAAI;AAAA,QACT;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,0CAA0C,KAAK;AAAA,IAC7D;AAAA,EACF;AAKA,WAAS,iCAAiC;AAExC,0BAAsB;AAEtB,QAAI,iCAAiC;AACnC,mBAAa,+BAA+B;AAC5C,wCAAkC;AAAA,IACpC;AACA,QAAI,uBAAuB;AACzB,4BAAsB,MAAM;AAC5B,8BAAwB;AAAA,IAC1B;AACA,QAAI,0BAA0B;AAC5B,oBAAc,wBAAwB;AACtC,iCAA2B;AAAA,IAC7B;AACA,UAAM,IAAI,8CAAuC;AAAA,EACnD;AAMA,iBAAe,uBAAuB;AACpC,QAAI,CAAC,qBAAqB,KAAK,CAAC;AAAkB;AAElD,QAAI;AACF,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY,0CAA0C,gBAAgB;AAAA,QACzE;AAAA,UACE,SAAS;AAAA,YACP,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,UAC9C;AAAA,QACF;AAAA,MACF;AAEA,UAAI,CAAC,SAAS,IAAI;AAChB,cAAM,KAAK,qCAAqC,SAAS,MAAM;AAC/D;AAAA,MACF;AAEA,YAAM,WAAW,MAAM,SAAS,KAAK;AACrC,UAAI,SAAS,SAAS,GAAG;AACvB,cAAM,IAAI,sBAAe,SAAS,MAAM,qBAAqB;AAC7D,mBAAW,WAAW,UAAU;AAC9B,gBAAM,eAAe,OAAO;AAAA,QAC9B;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,iCAAiC,KAAK;AAAA,IACpD;AAAA,EACF;AAKA,iBAAe,eAAe,SAAS;AACrC,UAAM,IAAI,6BAAwB,QAAQ,cAAc,OAAO;AAE/D,QAAI;AAEF,YAAM,oBAAoB,QAAQ,IAAI,YAAY;AAElD,UAAI;AAEJ,cAAQ,QAAQ,cAAc;AAAA,QAC5B,KAAK;AACH,mBAAS,MAAM,mBAAmB,OAAO;AACzC;AAAA,QAEF,KAAK;AACH,mBAAS,MAAM,uBAAuB,OAAO;AAC7C;AAAA,QAEF,KAAK;AACH,mBAAS,MAAM,wBAAwB,SAAS,QAAQ;AACxD;AAAA,QAEF,KAAK;AACH,mBAAS,MAAM,wBAAwB,SAAS,OAAO;AACvD;AAAA,QAEF,KAAK;AACH,mBAAS,MAAM,sBAAsB,OAAO;AAC5C;AAAA,QAEF,KAAK;AACH,mBAAS,MAAM,yBAAyB,OAAO;AAC/C;AAAA,QAEF,KAAK;AAEH,mBAAS,MAAM,yBAAyB,OAAO;AAC/C;AAAA,QAEF,KAAK;AACH,mBAAS,MAAM,mBAAmB,OAAO;AACzC;AAAA,QAEF,KAAK;AACH,mBAAS,MAAM,mBAAmB,OAAO;AACzC;AAAA,QAEF,KAAK;AACH,mBAAS,MAAM,yBAAyB,OAAO;AAC/C;AAAA,QAEF,KAAK;AACH,mBAAS,MAAM,mBAAmB,OAAO;AACzC;AAAA,QAEF;AACE,mBAAS,EAAE,SAAS,OAAO,OAAO,yBAAyB,QAAQ,YAAY,GAAG;AAAA,MACtF;AAGA,YAAM;AAAA,QACJ,QAAQ;AAAA,QACR,OAAO,UAAU,cAAc;AAAA,QAC/B;AAAA,MACF;AAEA,YAAM,IAAI,4BAAuB,QAAQ,cAAc,MAAM;AAAA,IAC/D,SAAS,OAAO;AACd,YAAM,MAAM,oCAA+B,KAAK;AAChD,YAAM,oBAAoB,QAAQ,IAAI,UAAU,MAAM,MAAM,OAAO;AAAA,IACrE;AAAA,EACF;AAMA,iBAAe,uBAAuB,SAAS;AAC7C,UAAM,EAAE,aAAa,aAAa,IAAI;AAGtC,UAAMC,cAAa,aAAa,eAAe;AAC/C,UAAMC,YAAW,eAAe,aAAa,aAAa;AAC1D,UAAM,gBAAgB,aAAa,kBAAkB;AAErD,UAAM,IAAI,iCAA0BD,aAAYC,SAAQ;AAExD,QAAI;AAEF,YAAM,UAAU;AAAA,QACd,MAAM;AAAA,QACN;AAAA,QACA,UAAUA;AAAA,QACV,YAAYD;AAAA,QACZ,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,MACpC;AAEA,YAAM,SAAS,MAAM,qBAAqB,OAAO;AAEjD,UAAI,OAAO,SAAS;AAClB,cAAM,IAAI,kCAA6BC,SAAQ;AAC/C,eAAO,EAAE,SAAS,MAAM,SAAS,UAAUA,SAAQ,cAAc;AAAA,MACnE,OAAO;AACL,cAAM,MAAM,0CAAqC,OAAO,KAAK;AAC7D,eAAO,EAAE,SAAS,OAAO,SAAS,8BAA8B,OAAO,KAAK,GAAG;AAAA,MACjF;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,4CAAuC,KAAK;AACxD,aAAO,EAAE,SAAS,OAAO,SAAS,UAAU,MAAM,OAAO,GAAG;AAAA,IAC9D;AAAA,EACF;AAMA,iBAAe,mBAAmB,SAAS;AACzC,UAAM,EAAE,YAAY,IAAI;AACxB,UAAMA,YAAW,eAAe;AAEhC,UAAM,KAAK,gEAA2D;AACtE,WAAO,EAAE,SAAS,OAAO,SAAS,+BAA+BA,SAAQ,GAAG;AAAA,EAC9E;AAMA,iBAAe,wBAAwB,SAAS,YAAY;AAC1D,UAAM,EAAE,YAAY,IAAI;AAExB,UAAM,KAAK,sEAAiE;AAC5E,WAAO,EAAE,SAAS,OAAO,SAAS,qCAAqC,UAAU,IAAI,WAAW,GAAG;AAAA,EACrG;AAMA,iBAAe,sBAAsB,SAAS;AAC5C,UAAM,KAAK,oEAA+D;AAC1E,WAAO,EAAE,SAAS,OAAO,SAAS,iCAAiC;AAAA,EACrE;AAMA,iBAAe,yBAAyB,SAAS;AAC/C,UAAM,EAAE,YAAY,IAAI;AAExB,UAAM,KAAK,uEAAkE;AAC7E,WAAO,EAAE,SAAS,OAAO,SAAS,sCAAsC,WAAW,GAAG;AAAA,EACxF;AAKA,iBAAe,mBAAmB,SAAS;AACzC,UAAM,EAAE,aAAa,aAAa,IAAI;AAEtC,QAAI;AAEF,YAAM,gBAAgB,MAAM,kCAAkC,aAAa,gBAAgB,aAAa,YAAY;AAEpH,UAAI,CAAC,eAAe;AAClB,cAAM,KAAK,gDAAgD,aAAa,cAAc,EAAE;AACxF,eAAO,EAAE,SAAS,OAAO,OAAO,sBAAsB;AAAA,MACxD;AAEA,YAAM,KAAK,sEAAiE;AAC5E,aAAO,EAAE,SAAS,OAAO,SAAS,qCAAqC,WAAW,GAAG;AAAA,IACvF,SAAS,OAAO;AACd,YAAM,MAAM,yCAAyC,KAAK;AAC1D,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ;AAAA,IAChD;AAAA,EACF;AAMA,iBAAe,mBAAmB,SAAS;AACzC,UAAM,EAAE,aAAa,IAAI;AAEzB,UAAM,KAAK,gEAA2D;AACtE,WAAO;AAAA,MACL,SAAS;AAAA,MACT,SAAS,aAAa,UAClB,kCACA;AAAA,IACN;AAAA,EACF;AAMA,iBAAe,yBAAyB,SAAS;AAC/C,UAAM,EAAE,aAAa,IAAI;AAEzB,UAAM,KAAK,uEAAkE;AAC7E,WAAO;AAAA,MACL,SAAS;AAAA,MACT,SAAS;AAAA,IACX;AAAA,EACF;AAMA,iBAAe,mBAAmB,SAAS;AACzC,UAAM,EAAE,aAAa,IAAI;AAEzB,UAAM,KAAK,gEAA2D;AACtE,WAAO;AAAA,MACL,SAAS;AAAA,MACT,SAAS;AAAA,IACX;AAAA,EACF;AAQA,WAAS,cAAc,YAAY,WAAW,IAAI;AAChD,QAAI;AACF,YAAM,OAAO,oBAAI,QAAQ;AAEzB,aAAO,KAAK,MAAM,YAAY,CAAC,KAAK,UAAU;AAE5C,YAAI,OAAO,UAAU,YAAY,UAAU,MAAM;AAC/C,cAAI,KAAK,IAAI,KAAK,GAAG;AACnB,kBAAM,KAAK,wCAAwC,GAAG,EAAE;AACxD,mBAAO;AAAA,UACT;AACA,eAAK,IAAI,KAAK;AAAA,QAChB;AACA,eAAO;AAAA,MACT,CAAC;AAAA,IACH,SAAS,OAAO;AACd,YAAM,MAAM,wBAAwB,MAAM,OAAO;AACjD,aAAO;AAAA,IACT;AAAA,EACF;AAKA,iBAAe,kCAAkC,eAAe,aAAa;AAC3E,QAAI;AAEF,YAAM,SAAS,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,qBAAqB,mBAAmB,CAAC;AAC5F,YAAM,oBAAoB,OAAO,qBAAqB,CAAC;AACvD,YAAM,oBAAoB,OAAO;AAEjC,YAAM,IAAI,oDAA6C,aAAa,wBAAwB,iBAAiB,EAAE;AAG/G,UAAI,qBAAqB,kBAAkB,iBAAiB,GAAG;AAC7D,cAAM,aAAa,kBAAkB,iBAAiB;AAEtD,YAAI,CAAC,iBAAiB,WAAW,WAAW,SAAS,iBAAiB,WAAW,SAAS,eAAe;AACvG,gBAAM,IAAI,yDAAkD,WAAW,WAAW,QAAQ,WAAW,IAAI,EAAE;AAC3G,iBAAO,WAAW,aAAa;AAAA,QACjC;AAAA,MACF;AAGA,UAAI,iBAAiB,mBAAmB;AACtC,mBAAW,CAAC,IAAI,OAAO,KAAK,OAAO,QAAQ,iBAAiB,GAAG;AAC7D,cAAI,QAAQ,SAAS,gBAAgB,QAAQ,WAAW,SAAS,iBAAiB,QAAQ,SAAS,gBAAgB;AACjH,kBAAM,IAAI,0DAAmD,aAAa,EAAE;AAC5E,mBAAO,QAAQ,aAAa;AAAA,UAC9B;AAAA,QACF;AAAA,MACF;AAGA,UAAI,eAAe,qBAAqB,GAAG;AACzC,cAAM,WAAW,MAAM;AAAA,UACrB,GAAG,YAAY,+CAA+C,WAAW;AAAA,UACzE;AAAA,YACE,SAAS;AAAA,cACP,UAAU;AAAA,cACV,gBAAgB;AAAA,YAClB;AAAA,UACF;AAAA,QACF;AAEA,YAAI,SAAS,IAAI;AACf,gBAAM,eAAe,MAAM,SAAS,KAAK;AACzC,gBAAM,OAAO,cAAc,YAAY;AAEvC,cAAI,QAAQ,MAAM,QAAQ,IAAI,KAAK,KAAK,SAAS,GAAG;AAClD,kBAAM,IAAI,wDAAiD,aAAa,EAAE;AAC1E,mBAAO,KAAK,CAAC,EAAE;AAAA,UACjB;AAAA,QACF;AAAA,MACF;AAEA,YAAM,KAAK,+BAA+B,iBAAiB,mBAAmB,EAAE;AAChF,aAAO;AAAA,IACT,SAAS,OAAO;AACd,YAAM,MAAM,oCAAoC,aAAa,KAAK,KAAK;AAGvE,UAAI,MAAM,WAAW,MAAM,QAAQ,SAAS,kCAAkC,GAAG;AAC/E,cAAM,MAAM,sDAAsD;AAClE,eAAO;AAAA,MACT;AAEA,aAAO;AAAA,IACT;AAAA,EACF;AAKA,iBAAe,oBAAoB,WAAW,QAAQ,SAAS,MAAM,eAAe,MAAM;AACxF,QAAI,CAAC,qBAAqB;AAAG;AAE7B,QAAI;AACF,YAAM,SAAS;AAAA,QACb;AAAA,QACA,eAAc,oBAAI,KAAK,GAAE,YAAY;AAAA,MACvC;AAEA,UAAI,QAAQ;AACV,eAAO,SAAS;AAAA,MAClB;AAEA,UAAI,cAAc;AAChB,eAAO,gBAAgB;AAAA,MACzB;AAEA,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY,kCAAkC,SAAS;AAAA,QAC1D;AAAA,UACE,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,gBAAgB;AAAA,YAChB,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,UAC9C;AAAA,UACA,MAAM,KAAK,UAAU,MAAM;AAAA,QAC7B;AAAA,MACF;AAEA,UAAI,CAAC,SAAS,IAAI;AAChB,cAAM,KAAK,oCAAoC,SAAS,MAAM;AAAA,MAChE;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,kCAAkC,KAAK;AAAA,IACrD;AAAA,EACF;AAaA,iBAAe,yBAAyB;AACtC,QAAI;AACF,UAAI,CAAC,qBAAqB,GAAG;AAC3B,cAAM,IAAI,oDAAoD;AAC9D;AAAA,MACF;AAEA,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY;AAAA,QACf;AAAA,UACE,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,YAC5C,gBAAgB;AAAA,UAClB;AAAA,QACF;AAAA,MACF;AAEA,UAAI,SAAS,IAAI;AACf,cAAM,SAAS,MAAM,SAAS,KAAK;AACnC,cAAM,IAAI,wCAAiC,MAAM;AAAA,MACnD,OAAO;AACL,cAAM,KAAK,kCAAkC,SAAS,MAAM;AAAA,MAC9D;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,iCAAiC,KAAK;AAAA,IACpD;AAAA,EACF;AAKA,iBAAe,0BAA0B;AACvC,QAAI;AACF,UAAI,CAAC,qBAAqB,GAAG;AAC3B,eAAO;AAAA,MACT;AAEA,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,YAAY;AAAA,QACf;AAAA,UACE,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,UAAU;AAAA,YACV,iBAAiB,UAAU,iBAAiB;AAAA,YAC5C,gBAAgB;AAAA,UAClB;AAAA,QACF;AAAA,MACF;AAEA,UAAI,SAAS,IAAI;AACf,cAAM,UAAU,MAAM,SAAS,KAAK;AACpC,cAAM,IAAI,qCAA8B,OAAO;AAG/C,YAAI,QAAQ,kBAAkB,QAAQ,SAAS,GAAG;AAChD,gBAAM,IAAI,wDAAiD;AAC3D,gBAAM,uBAAuB;AAAA,QAC/B;AAEA,eAAO,QAAQ,CAAC,KAAK;AAAA,MACvB,OAAO;AACL,cAAM,KAAK,yCAAyC,SAAS,MAAM;AACnE,eAAO;AAAA,MACT;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,yCAAyC,KAAK;AAC1D,aAAO;AAAA,IACT;AAAA,EACF;AAGA,cAAY,YAAY;AACtB,QAAI;AACF,YAAM,uBAAuB;AAAA,IAC/B,SAAS,OAAO;AACd,YAAM,MAAM,4BAA4B,KAAK;AAAA,IAC/C;AAAA,EACF,GAAG,KAAK,KAAK,GAAI;AAGjB,cAAY,YAAY;AACtB,QAAI;AACF,YAAM,wBAAwB;AAAA,IAChC,SAAS,OAAO;AACd,YAAM,MAAM,wBAAwB,KAAK;AAAA,IAC3C;AAAA,EACF,GAAG,IAAI,KAAK,GAAI;AAGhB,GAAC,YAAY;AACX,QAAI;AACF,YAAM,WAAW,MAAM,WAAW,QAAQ,MAAM,IAAI,CAAC,yBAAyB,oBAAoB,mBAAmB,CAAC;AACtH,YAAM,IAAI,gDAAyC,SAAS,uBAAuB,cAAc,SAAS,mBAAmB,QAAQ,WAAW,eAAe,SAAS,oBAAoB,QAAQ,SAAS;AAG7M,YAAM,wBAAwB,SAAS,yBAAyB,SAAS;AACzE,YAAM,wBAAwB,SAAS;AAEvC,UAAI,yBAAyB,uBAAuB;AAClD,cAAM,IAAI,qFAAgF;AAC1F,cAAM,2BAA2B,SAAS,gBAAgB;AAAA,MAC5D,OAAO;AACL,cAAM,IAAI,kFAAwE,uBAAuB,YAAY,qBAAqB;AAAA,MAC5I;AAAA,IACF,SAAS,OAAO;AACd,YAAM,KAAK,0CAA0C,KAAK;AAAA,IAC5D;AAAA,EACF,GAAG;AAsIH,MAAI,gBAAgB;AAKpB,iBAAe,qBAAqB;AAClC,QAAI;AACF,UAAI,eAAe;AACjB,eAAO;AAAA,MACT;AAGA,sBAAgB,WAAW,QAAQ,cAAc,wBAAwB;AAEzE,oBAAc,UAAU,YAAY,CAAC,YAAY;AAC/C,cAAM,IAAI,oCAAoC,OAAO;AACrD,+BAAuB,OAAO;AAAA,MAChC,CAAC;AAED,oBAAc,aAAa,YAAY,MAAM;AAC3C,cAAM,IAAI,6BAA6B;AACvC,wBAAgB;AAAA,MAClB,CAAC;AAGD,oBAAc,YAAY,EAAE,MAAM,OAAO,CAAC;AAE1C,YAAM,IAAI,oDAA+C;AACzD,aAAO;AAAA,IACT,SAAS,OAAO;AACd,YAAM,KAAK,mCAAmC,KAAK;AACnD,aAAO;AAAA,IACT;AAAA,EACF;AAKA,WAAS,uBAAuB,SAAS;AACvC,YAAQ,QAAQ,MAAM;AAAA,MACpB,KAAK;AACH,cAAM,IAAI,2DAAsD;AAEhE,YAAI,eAAe;AACjB,wBAAc,YAAY,EAAE,MAAM,iBAAiB,CAAC;AAAA,QACtD;AACA;AAAA,MAEF,KAAK;AACH,YAAI,QAAQ,MAAM;AAChB,gBAAM,IAAI,mDAA4C,QAAQ,IAAI;AAElE,qCAA2B,QAAQ,MAAM,QAAQ,QAAQ;AAAA,QAC3D,OAAO;AACL,gBAAM,IAAI,yDAAyD;AAAA,QACrE;AACA;AAAA,MAEF;AACE,cAAM,KAAK,wCAAwC,QAAQ,IAAI;AAAA,IACnE;AAAA,EACF;AAOA,iBAAe,2BAA2B,MAAM,oBAAoB,MAAM;AACxE,QAAI;AAEF,YAAM,WAAW,QAAQ,MAAM,IAAI;AAAA,QACjC,sBAAsB;AAAA,QACtB,eAAe;AAAA,MACjB,CAAC;AAGD,UAAI,oBAAoB;AACxB,UAAI,CAAC,mBAAmB;AACtB,cAAM,cAAc,MAAM,iBAAiB;AAC3C,4BAAoB,YAAY,YAAY;AAAA,MAC9C;AAEA,YAAM,IAAI,iDAA0C,MAAM,aAAa,iBAAiB;AAGxF,YAAM,SAAS,MAAM,qBAAqB,MAAM,iBAAiB;AAEjE,UAAI,OAAO,SAAS;AAClB,cAAM,IAAI,4CAAuC;AAGjD,yBAAiB;AAAA,UACf,QAAQ;AAAA,UACR;AAAA,QACF,CAAC;AAAA,MACH,OAAO;AACL,cAAM,MAAM,iDAAiD,OAAO,KAAK;AAAA,MAC3E;AAAA,IACF,SAAS,OAAO;AACd,YAAM,MAAM,0CAA0C,KAAK;AAAA,IAC7D;AAAA,EACF;AAKA,iBAAe,iBAAiB,SAAS;AACvC,QAAI;AAEF,YAAM,WAAW,QAAQ,YAAY,OAAO;AAAA,IAC9C,SAAS,OAAO;AAEd,YAAM,IAAI,mCAAmC;AAAA,IAC/C;AAAA,EACF;AAGA,GAAC,YAAY;AACX,eAAW,YAAY;AACrB,YAAM,mBAAmB;AAAA,IAC3B,GAAG,GAAI;AAAA,EACT,GAAG;",
  "names": ["existingProfile", "characterProfiles", "supabase", "rollString", "rollName"]
}
