{
  "version": 3,
  "sources": ["../../src/popup-sheet.js"],
  "sourcesContent": ["debug.log('\u2705 Popup HTML loaded');\r\n\r\n// Note: Edge case modules and action-executor.js are loaded as regular scripts before this script.\r\n// They export their functions to globalThis, making them globally available without needing to import.\r\n// Functions like isEdgeCase, getEdgeCase, resolveSpellCast, etc. are already available globally.\r\n\r\n/**\r\n * Crop image to circular format with colored border\r\n * @param {string} imageUrl - URL of the image to crop\r\n * @param {number} size - Size of the output image (default: 200)\r\n * @returns {Promise<string>} - Data URL of the cropped circular image\r\n */\r\nfunction cropToCircle(imageUrl, size = 200) {\r\n  return new Promise((resolve) => {\r\n    const img = new Image();\r\n    img.crossOrigin = 'anonymous'; // Handle CORS\r\n\r\n    img.onload = () => {\r\n      // Create canvas with extra space for border\r\n      const borderWidth = Math.max(8, size * 0.04); // 4% of size, minimum 8px\r\n      const canvas = document.createElement('canvas');\r\n      canvas.width = size;\r\n      canvas.height = size;\r\n      const ctx = canvas.getContext('2d');\r\n\r\n      // Save context before clipping\r\n      ctx.save();\r\n\r\n      // Draw circular clip (slightly smaller to account for border)\r\n      const radius = (size / 2) - (borderWidth / 2);\r\n      ctx.beginPath();\r\n      ctx.arc(size / 2, size / 2, radius, 0, Math.PI * 2);\r\n      ctx.closePath();\r\n      ctx.clip();\r\n\r\n      // Draw image centered and scaled to fill circle\r\n      const scale = Math.max(size / img.width, size / img.height);\r\n      const x = (size / 2) - (img.width / 2) * scale;\r\n      const y = (size / 2) - (img.height / 2) * scale;\r\n      ctx.drawImage(img, x, y, img.width * scale, img.height * scale);\r\n\r\n      // Restore context to remove clipping\r\n      ctx.restore();\r\n\r\n      // Draw pink border (matching RollCloud theme)\r\n      ctx.beginPath();\r\n      ctx.arc(size / 2, size / 2, radius, 0, Math.PI * 2);\r\n      ctx.strokeStyle = '#FC57F9'; // Pink accent color\r\n      ctx.lineWidth = borderWidth;\r\n      ctx.stroke();\r\n\r\n      // Convert to data URL\r\n      resolve(canvas.toDataURL('image/png'));\r\n    };\r\n\r\n    img.onerror = () => {\r\n      debug.warn('Failed to load image for circular crop, using original');\r\n      resolve(imageUrl); // Fallback to original if loading fails\r\n    };\r\n\r\n    img.src = imageUrl;\r\n  });\r\n}\r\n\r\n// Initialize theme manager\r\nif (typeof ThemeManager !== 'undefined') {\r\n  ThemeManager.init().then(() => {\r\n    debug.log('\uD83C\uDFA8 Theme system initialized');\r\n\r\n    // Set up theme button click handlers\r\n    // Note: Don't wrap in DOMContentLoaded since this script runs after the DOM is loaded\r\n    const themeButtons = document.querySelectorAll('.theme-btn');\r\n    themeButtons.forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        const theme = btn.dataset.theme;\r\n        ThemeManager.setTheme(theme);\r\n\r\n        // Update active state\r\n        themeButtons.forEach(b => b.classList.remove('active'));\r\n        btn.classList.add('active');\r\n      });\r\n    });\r\n\r\n    // Set initial active button based on current theme\r\n    const currentTheme = ThemeManager.getCurrentTheme();\r\n    const activeBtn = document.querySelector(`[data-theme=\"${currentTheme}\"]`);\r\n    if (activeBtn) {\r\n      themeButtons.forEach(b => b.classList.remove('active'));\r\n      activeBtn.classList.add('active');\r\n    }\r\n  });\r\n} else {\r\n  debug.warn('\u26A0\uFE0F ThemeManager not available');\r\n}\r\n\r\n// Store character data globally so we can update it\r\n// Using 'var' instead of 'let' to ensure global scope accessibility for modules\r\nvar characterData = null;\r\n\r\n// Track current character slot ID (e.g., \"slot-1\") for persistence\r\n// NOTE: This is now managed by data-manager.js via globalThis.currentSlotId\r\n// Keep this comment for reference but don't declare a local variable\r\n\r\n\r\n// Note: activeBuffs and activeConditions are now in effects-manager.js\r\n\r\n// Track Feline Agility usage\r\nvar felineAgilityUsed = false;\r\n\r\n// Setting: Show custom macro gear buttons on spells (disabled by default)\r\nlet showCustomMacroButtons = false;\r\n\r\n// Track if DOM is ready\r\nlet domReady = false;\r\n\r\n// Queue for operations waiting for DOM\r\nlet pendingOperations = [];\r\n\r\n\r\n// Listen for character data from parent window via postMessage\r\nwindow.addEventListener('message', async (event) => {\r\n  debug.log('\u2705 Received message in popup:', event.data);\r\n\r\n  if (event.data && event.data.action === 'initCharacterSheet') {\r\n    debug.log('\u2705 Initializing character sheet with data:', event.data.data.name);\r\n    \r\n    // Check if this is opened from GM panel (read-only mode)\r\n    const isFromGMPanel = event.data.source === 'gm-panel';\r\n    if (isFromGMPanel) {\r\n      debug.log('\uD83D\uDC51 Popup opened from GM panel - hiding GM controls');\r\n      hideGMControls();\r\n\r\n      // Initialize action economy as disabled until we receive activateTurn message\r\n      // (combat might already be active when sheet is opened)\r\n      setTimeout(() => {\r\n        deactivateTurn();\r\n        debug.log('\u23F8\uFE0F Action economy initialized as disabled (combat may be active)');\r\n      }, 100);\r\n    }\r\n    \r\n    // Function to initialize the sheet\r\n    const initSheet = async () => {\r\n      characterData = event.data.data;  // Store globally\r\n\r\n      // Validate that character data has required arrays (spells and actions)\r\n      const hasSpells = Array.isArray(characterData.spells);\r\n      const hasActions = Array.isArray(characterData.actions);\r\n\r\n      if (!hasSpells || !hasActions) {\r\n        debug.warn('\u26A0\uFE0F Character data from initCharacterSheet is incomplete');\r\n        debug.warn(`Missing data: spells=${!hasSpells}, actions=${!hasActions}`);\r\n        showNotification('\u26A0\uFE0F Character data incomplete. Please resync from DiceCloud.', 'error');\r\n        return;\r\n      }\r\n\r\n      // Get and store current slot ID for persistence\r\n      globalThis.currentSlotId = await getActiveCharacterId();\r\n      debug.log('\uD83D\uDCCB Current slot ID set to:', globalThis.currentSlotId);\r\n\r\n      // Build tabs first (need to load profiles from storage)\r\n      await loadAndBuildTabs();\r\n\r\n      // Then build the sheet with character data\r\n      if (typeof buildSheet === 'function') {\r\n        buildSheet(characterData);\r\n      } else {\r\n        debug.warn('\u26A0\uFE0F buildSheet function not available');\r\n      }\r\n      \r\n      // Display character portrait if available\r\n      const portraitElement = document.getElementById('char-portrait');\r\n      debug.log('\uD83D\uDDBC\uFE0F Portrait element found:', portraitElement);\r\n      debug.log('\uD83D\uDDBC\uFE0F Character data for portrait:', characterData?.picture, characterData?.avatarPicture);\r\n      if (portraitElement && characterData) {\r\n        const portraitUrl = characterData.picture || characterData.avatarPicture;\r\n        if (portraitUrl) {\r\n          debug.log('\uD83D\uDDBC\uFE0F Cropping portrait from URL:', portraitUrl);\r\n          cropToCircle(portraitUrl, 120).then(croppedUrl => {\r\n            portraitElement.src = croppedUrl;\r\n            portraitElement.style.display = 'block';\r\n            debug.log('\u2705 Portrait displayed successfully');\r\n          }).catch(err => {\r\n            debug.warn('\u26A0\uFE0F Failed to crop portrait:', err);\r\n            // Fallback to original image\r\n            portraitElement.src = portraitUrl;\r\n            portraitElement.style.display = 'block';\r\n            debug.log('\u2705 Portrait displayed (uncropped fallback)');\r\n          });\r\n        } else {\r\n          debug.log('\u2139\uFE0F No portrait URL available in character data');\r\n        }\r\n      } else {\r\n        if (!portraitElement) debug.warn('\u26A0\uFE0F Portrait element not found');\r\n        if (!characterData) debug.warn('\u26A0\uFE0F No character data for portrait');\r\n      }\r\n      \r\n      // Initialize racial traits based on character data\r\n      initRacialTraits();\r\n\r\n      // Initialize feat traits based on character data\r\n      initFeatTraits();\r\n\r\n      // Initialize class features based on character data\r\n      initClassFeatures();\r\n\r\n      // Restore concentration state from saved data\r\n      if (characterData.concentrationSpell) {\r\n        // Directly set the global variable and update display\r\n        concentratingSpell = characterData.concentrationSpell;\r\n        if (typeof updateConcentrationDisplay === 'function') {\r\n          updateConcentrationDisplay();\r\n        }\r\n        debug.log(`\uD83E\uDDE0 Restored concentration: ${characterData.concentrationSpell}`);\r\n      }\r\n\r\n      // Initialize character cache with current data\r\n      if (characterData && characterData.id) {\r\n        characterCache.set(characterData.id, JSON.parse(JSON.stringify(characterData)));\r\n        debug.log(`\uD83D\uDCC2 Initialized cache for character: ${characterData.name}`);\r\n      }\r\n\r\n      // Register this character with GM Initiative Tracker (if it exists)\r\n      // Use postMessage to avoid CORS issues - send character name only\r\n      if (window.opener) {\r\n        window.opener.postMessage({\r\n          action: 'registerPopup',\r\n          characterName: event.data.data.name\r\n        }, '*');\r\n        debug.log(`\u2705 Sent registration message for: ${event.data.data.name}`);\r\n        \r\n        // Check if it's currently this character's turn by reading recent chat\r\n        // Add a small delay to ensure combat system has processed start of combat\r\n        setTimeout(() => {\r\n          checkCurrentTurnFromChat(event.data.data.name);\r\n        }, 500);\r\n      } else {\r\n        debug.warn(`\u26A0\uFE0F No window.opener available for: ${event.data.data.name}`);\r\n      }\r\n    };\r\n\r\n    // Only initialize if DOM is ready, otherwise queue it\r\n    if (domReady) {\r\n      await initSheet();\r\n    } else {\r\n      debug.log('\u23F3 DOM not ready yet, queuing initialization...');\r\n      pendingOperations.push(initSheet);\r\n    }\r\n  } else if (event.data && event.data.action === 'loadCharacterData') {\r\n    debug.log('\uD83D\uDCCB Loading character data from GM panel:', event.data.characterData.name);\r\n    \r\n    // This is from GM panel - hide GM controls\r\n    hideGMControls();\r\n    \r\n    // Load the character data using the same initialization process\r\n    characterData = event.data.characterData;\r\n\r\n    // Validate that character data has required arrays (spells and actions)\r\n    const hasSpells = Array.isArray(characterData.spells);\r\n    const hasActions = Array.isArray(characterData.actions);\r\n\r\n    if (!hasSpells || !hasActions) {\r\n      debug.warn('\u26A0\uFE0F Shared character data is incomplete');\r\n      debug.warn(`Missing data: spells=${!hasSpells}, actions=${!hasActions}`);\r\n      showNotification('\u26A0\uFE0F Shared character data incomplete. Player needs to resync from DiceCloud.', 'error');\r\n      return;\r\n    }\r\n\r\n    // Function to initialize the sheet with GM panel data\r\n    const initSheetFromGM = async () => {\r\n      // DO NOT load tabs for shared characters - show only this character\r\n      // Skip loadAndBuildTabs() to prevent mixing with GM's own characters\r\n\r\n      // Hide the character tabs container since this is a standalone sheet\r\n      const tabsContainer = document.getElementById('character-tabs');\r\n      if (tabsContainer) {\r\n        tabsContainer.style.display = 'none';\r\n        debug.log('\uD83D\uDD12 Hidden character tabs for standalone GM view');\r\n      }\r\n\r\n      // Build the sheet directly with character data\r\n      if (typeof buildSheet === 'function') {\r\n        buildSheet(characterData);\r\n      } else {\r\n        debug.warn('\u26A0\uFE0F buildSheet function not available');\r\n      }\r\n\r\n      // Initialize racial traits based on character data\r\n      initRacialTraits();\r\n\r\n      // Initialize feat traits based on character data\r\n      initFeatTraits();\r\n\r\n      // Initialize class features based on character data\r\n      initClassFeatures();\r\n\r\n      // Restore concentration state from saved data\r\n      if (characterData.concentrationSpell) {\r\n        // Directly set the global variable and update display\r\n        concentratingSpell = characterData.concentrationSpell;\r\n        if (typeof updateConcentrationDisplay === 'function') {\r\n          updateConcentrationDisplay();\r\n        }\r\n        debug.log(`\uD83E\uDDE0 Restored concentration: ${characterData.concentrationSpell}`);\r\n      }\r\n\r\n      // Initialize character cache with current data\r\n      if (characterData && characterData.id) {\r\n        characterCache.set(characterData.id, JSON.parse(JSON.stringify(characterData)));\r\n        debug.log(`\uD83D\uDCC2 Initialized cache for character: ${characterData.name}`);\r\n      }\r\n\r\n      // Register this popup with GM Initiative Tracker for turn notifications\r\n      // Only register if window.opener exists (opened from Roll20 page)\r\n      if (window.opener) {\r\n        window.opener.postMessage({\r\n          action: 'registerPopup',\r\n          characterName: characterData.name\r\n        }, '*');\r\n        debug.log(`\u2705 Sent registration message for: ${characterData.name}`);\r\n\r\n        // Don't automatically check turn - let GM panel notify us when it's our turn\r\n        // This prevents false \"Your turn!\" notifications when not in combat\r\n      } else {\r\n        debug.log(`\u2139\uFE0F Standalone sheet (no window.opener) for: ${characterData.name}`);\r\n      }\r\n    };\r\n\r\n    // Only initialize if DOM is ready, otherwise queue it\r\n    if (domReady) {\r\n      await initSheetFromGM();\r\n    } else {\r\n      debug.log('\u23F3 DOM not ready yet, queuing GM panel initialization...');\r\n      pendingOperations.push(initSheetFromGM);\r\n    }\r\n  } else if (event.data && event.data.action === 'requestStatusData') {\r\n    // Status bar is requesting current character status\r\n    debug.log('\uD83D\uDCCA Status bar requesting data');\r\n    sendStatusUpdate(event.source);\r\n  }\r\n});\r\n\r\n// Tell parent window we're ready - wait for DOM to be fully loaded\r\n// This prevents race conditions in Firefox\r\nfunction notifyParentReady() {\r\n  try {\r\n    if (window.opener && !window.opener.closed) {\r\n      debug.log('\u2705 Sending ready message to parent window...');\r\n      window.opener.postMessage({ action: 'popupReady' }, '*');\r\n    } else {\r\n      debug.warn('\u26A0\uFE0F No parent window available, waiting for postMessage...');\r\n    }\r\n  } catch (error) {\r\n    debug.warn('\u26A0\uFE0F Could not notify parent (this is normal):', error.message);\r\n  }\r\n}\r\n\r\n// Wait for DOM to be ready before doing anything\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', async () => {\r\n    debug.log('\u2705 DOM is ready');\r\n    domReady = true;\r\n    \r\n    // Send ready message to parent\r\n    notifyParentReady();\r\n    \r\n    // Execute any pending operations\r\n    for (const operation of pendingOperations) {\r\n      await operation();\r\n    }\r\n    pendingOperations = [];\r\n  });\r\n} else {\r\n  // DOM is already ready\r\n  debug.log('\u2705 DOM already ready');\r\n  domReady = true;\r\n  notifyParentReady();\r\n}\r\n\r\ndebug.log('\u2705 Waiting for character data via postMessage...');\r\n\r\n// Fallback: If we don't receive data via postMessage within 1.5 seconds,\r\n// load directly from storage (Firefox sometimes blocks postMessage between windows)\r\nsetTimeout(() => {\r\n  if (!characterData && domReady) {\r\n    debug.log('\u23F1\uFE0F No data received via postMessage, loading from storage...');\r\n    loadCharacterWithTabs();\r\n  } else if (!characterData && !domReady) {\r\n    debug.log('\u23F3 DOM not ready yet, will retry fallback...');\r\n    setTimeout(() => {\r\n      if (!characterData) {\r\n        debug.log('\u23F1\uFE0F Retry: Loading from storage...');\r\n        loadCharacterWithTabs();\r\n      }\r\n    }, 500);\r\n  }\r\n}, 1500);\r\n\r\n// Global timeout: If we still don't have character data after 10 seconds, show error\r\nsetTimeout(() => {\r\n  if (!characterData) {\r\n    debug.warn('\u23F0 Loading timeout - no character data after 10 seconds');\r\n    showLoadingError();\r\n  }\r\n}, 10000);\r\n\r\n// Show loading error with try again button\r\nfunction showLoadingError() {\r\n  const loadingOverlay = document.getElementById('loading-overlay');\r\n  if (!loadingOverlay) return;\r\n\r\n  loadingOverlay.innerHTML = `\r\n    <div style=\"text-align: center; color: var(--text-primary); max-width: 450px; padding: 20px;\">\r\n      <div style=\"font-size: 4em; margin-bottom: 20px;\">\u26A0\uFE0F</div>\r\n      <div style=\"font-size: 1.3em; font-weight: bold; margin-bottom: 15px; color: var(--accent-danger);\">\r\n        No Valid Character Data Found\r\n      </div>\r\n      <div style=\"font-size: 0.95em; color: var(--text-secondary); line-height: 1.6; margin-bottom: 25px;\">\r\n        No character data could be loaded. This might happen if you haven't synced a character yet, or if the character data is outdated.\r\n      </div>\r\n      <div style=\"background: var(--background-secondary); padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid var(--accent-info);\">\r\n        <p style=\"margin: 0 0 12px 0; font-weight: bold; color: var(--text-primary); font-size: 0.95em;\">To fix this:</p>\r\n        <ol style=\"text-align: left; margin: 0; padding-left: 20px; line-height: 1.8; font-size: 0.9em; color: var(--text-secondary);\">\r\n          <li>Use the <strong>Refresh Characters</strong> button in the extension popup</li>\r\n          <li>Or visit your character on <a href=\"https://dicecloud.com\" target=\"_blank\" style=\"color: var(--accent-info);\">DiceCloud.com</a> and click <strong>Sync to Extension</strong></li>\r\n        </ol>\r\n      </div>\r\n      <button id=\"try-again-btn\" style=\"\r\n        padding: 14px 28px;\r\n        background: linear-gradient(135deg, var(--accent-info) 0%, #2980b9 100%);\r\n        color: white;\r\n        border: none;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 1em;\r\n        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);\r\n        transition: transform 0.2s, box-shadow 0.2s;\r\n      \" onmouseover=\"this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(52, 152, 219, 0.4)';\" onmouseout=\"this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(52, 152, 219, 0.3)';\">\r\n        \uD83D\uDD04 Try Again\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  // Add click handler to try again button\r\n  const tryAgainBtn = document.getElementById('try-again-btn');\r\n  if (tryAgainBtn) {\r\n    tryAgainBtn.addEventListener('click', () => {\r\n      debug.log('\uD83D\uDD04 Try again button clicked - reloading character data...');\r\n\r\n      // Reset the loading overlay to show loading state\r\n      loadingOverlay.innerHTML = `\r\n        <div style=\"display: flex; align-items: center; justify-content: center; width: 80px; height: 80px; margin: 0 auto 20px;\">\r\n          <div style=\"width: 100%; height: 100%; border: 4px solid var(--border-subtle); border-top: 4px solid var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite;\"></div>\r\n        </div>\r\n        <div style=\"text-align: center; color: var(--text-primary);\">\r\n          <div style=\"font-size: 1.2em; font-weight: bold; margin-bottom: 10px;\">\r\n            Loading Characters...\r\n          </div>\r\n          <div style=\"font-size: 0.9em; color: var(--text-secondary); max-width: 300px; line-height: 1.4;\">\r\n            Attempting to reload character data...\r\n          </div>\r\n        </div>\r\n      `;\r\n\r\n      // Reset characterData and try loading again\r\n      characterData = null;\r\n      loadCharacterWithTabs();\r\n\r\n      // Set another timeout in case it fails again\r\n      setTimeout(() => {\r\n        if (!characterData) {\r\n          debug.warn('\u23F0 Retry timeout - still no character data');\r\n          showLoadingError();\r\n        }\r\n      }, 10000);\r\n    });\r\n  }\r\n}\r\n\r\n// Load profiles and build tabs (without building sheet)\r\nasync function loadAndBuildTabs() {\r\n  try {\r\n    debug.log('\uD83D\uDCCB Loading character profiles for tabs...');\r\n\r\n    // Get all character profiles\r\n    const profilesResponse = await browserAPI.runtime.sendMessage({ action: 'getAllCharacterProfiles' });\r\n    const profiles = profilesResponse.success ? profilesResponse.profiles : {};\r\n    debug.log('\uD83D\uDCCB Profiles loaded:', Object.keys(profiles));\r\n\r\n    // Get active character ID (this is the slotId like \"slot-1\")\r\n    const activeCharacterId = await getActiveCharacterId();\r\n    debug.log('\uD83D\uDCCB Active character ID:', activeCharacterId);\r\n\r\n    // Build character tabs\r\n    buildCharacterTabs(profiles, activeCharacterId);\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to load and build tabs:', error);\r\n  }\r\n}\r\n\r\n// Load character data and build tabs\r\nasync function loadCharacterWithTabs() {\r\n  // Wait for DOM to be ready\r\n  if (!domReady) {\r\n    debug.log('\u23F3 DOM not ready, queuing loadCharacterWithTabs...');\r\n    pendingOperations.push(loadCharacterWithTabs);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    // Build tabs first\r\n    await loadAndBuildTabs();\r\n\r\n    // Get and store current slot ID for persistence\r\n    globalThis.currentSlotId = await getActiveCharacterId();\r\n    debug.log('\uD83D\uDCCB Current slot ID set to:', globalThis.currentSlotId);\r\n\r\n    // Get active character data\r\n    let activeCharacter = null;\r\n    \r\n    // Check if this is a database character\r\n    if (globalThis.currentSlotId && globalThis.currentSlotId.startsWith('db-')) {\r\n      // Load from database\r\n      const characterId = globalThis.currentSlotId.replace('db-', '');\r\n      try {\r\n        const dbResponse = await browserAPI.runtime.sendMessage({ \r\n          action: 'getCharacterDataFromDatabase', \r\n          characterId: characterId \r\n        });\r\n        if (dbResponse.success) {\r\n          activeCharacter = dbResponse.data;\r\n          debug.log('\u2705 Loaded character from database:', activeCharacter.name);\r\n        }\r\n      } catch (dbError) {\r\n        debug.warn('\u26A0\uFE0F Failed to load database character:', dbError);\r\n      }\r\n    } else {\r\n      // Load from local storage\r\n      const activeResponse = await browserAPI.runtime.sendMessage({ action: 'getCharacterData' });\r\n      activeCharacter = activeResponse.success ? activeResponse.data : null;\r\n    }\r\n\r\n    // Load active character\r\n    if (activeCharacter) {\r\n      characterData = activeCharacter;\r\n\r\n      // Validate that character data has required arrays (spells and actions)\r\n      const hasSpells = Array.isArray(characterData.spells);\r\n      const hasActions = Array.isArray(characterData.actions);\r\n\r\n      if (!hasSpells || !hasActions) {\r\n        debug.warn('\u26A0\uFE0F Character data is incomplete or outdated');\r\n        debug.warn(`Missing data: spells=${!hasSpells}, actions=${!hasActions}`);\r\n\r\n        // Show error message to user\r\n        const characterName = characterData.name || characterData.character_name || 'this character';\r\n        const missingData = [];\r\n        if (!hasSpells) missingData.push('spells');\r\n        if (!hasActions) missingData.push('actions');\r\n\r\n        const errorContainer = document.getElementById('main-content');\r\n        if (errorContainer) {\r\n          errorContainer.innerHTML = `\r\n            <div style=\"padding: 40px; text-align: center; color: var(--text-primary);\">\r\n              <h2 style=\"color: #e74c3c; margin-bottom: 20px;\">\u26A0\uFE0F Incomplete Character Data</h2>\r\n              <p style=\"margin-bottom: 15px; font-size: 1.1em;\">\r\n                The character data for <strong>${characterName}</strong> is missing ${missingData.join(' and ')}.\r\n              </p>\r\n              <p style=\"margin-bottom: 15px; color: var(--text-secondary);\">\r\n                This usually happens when loading old cloud data that was saved before spells and actions were synced.\r\n              </p>\r\n              <div style=\"background: #2c3e50; padding: 20px; border-radius: 8px; margin: 20px 0;\">\r\n                <p style=\"margin-bottom: 10px; font-weight: bold;\">To fix this:</p>\r\n                <ol style=\"text-align: left; max-width: 500px; margin: 0 auto; line-height: 1.8;\">\r\n                  <li>Go to your character on <a href=\"https://dicecloud.com\" target=\"_blank\" style=\"color: #FC57F9;\">DiceCloud.com</a></li>\r\n                  <li>Click the <strong>\"Sync to Extension\"</strong> button on the character page</li>\r\n                  <li>Wait for the sync to complete</li>\r\n                  <li>Reopen this character sheet</li>\r\n                </ol>\r\n              </div>\r\n              <p style=\"color: var(--text-secondary); font-size: 0.9em;\">\r\n                Character ID: ${characterData.id || characterData.dicecloud_character_id || 'unknown'}\r\n              </p>\r\n            </div>\r\n          `;\r\n        }\r\n\r\n        // Don't continue loading the incomplete character\r\n        return;\r\n      }\r\n\r\n      // Call buildSheet if available\r\n      if (typeof buildSheet === 'function') {\r\n        buildSheet(characterData);\r\n      } else {\r\n        debug.warn('\u26A0\uFE0F buildSheet function not available');\r\n      }\r\n\r\n      // Display character portrait if available\r\n      const portraitElement = document.getElementById('char-portrait');\r\n      debug.log('\uD83D\uDDBC\uFE0F Portrait element found:', portraitElement);\r\n      debug.log('\uD83D\uDDBC\uFE0F Character data for portrait:', characterData?.picture, characterData?.avatarPicture);\r\n      if (portraitElement && characterData) {\r\n        const portraitUrl = characterData.picture || characterData.avatarPicture;\r\n        if (portraitUrl) {\r\n          debug.log('\uD83D\uDDBC\uFE0F Cropping portrait from URL:', portraitUrl);\r\n          cropToCircle(portraitUrl, 120).then(croppedUrl => {\r\n            portraitElement.src = croppedUrl;\r\n            portraitElement.style.display = 'block';\r\n            debug.log('\u2705 Portrait displayed successfully');\r\n          }).catch(err => {\r\n            debug.warn('\u26A0\uFE0F Failed to crop portrait:', err);\r\n            // Fallback to original image\r\n            portraitElement.src = portraitUrl;\r\n            portraitElement.style.display = 'block';\r\n            debug.log('\u2705 Portrait displayed (uncropped fallback)');\r\n          });\r\n        } else {\r\n          debug.log('\u2139\uFE0F No portrait URL available in character data');\r\n        }\r\n      } else {\r\n        if (!portraitElement) debug.warn('\u26A0\uFE0F Portrait element not found');\r\n        if (!characterData) debug.warn('\u26A0\uFE0F No character data for portrait');\r\n      }\r\n\r\n      // Initialize racial traits based on character data\r\n      initRacialTraits();\r\n\r\n      // Initialize feat traits based on character data\r\n      initFeatTraits();\r\n\r\n      // Initialize class features based on character data\r\n      initClassFeatures();\r\n    } else {\r\n      debug.error('\u274C No character data found');\r\n      // Hide loading overlay even if no character data\r\n      const loadingOverlay = document.getElementById('loading-overlay');\r\n      if (loadingOverlay) {\r\n        loadingOverlay.innerHTML = `\r\n          <div style=\"text-align: center; color: var(--text-primary); max-width: 400px;\">\r\n            <div style=\"font-size: 3em; margin-bottom: 20px;\">\uD83D\uDCCB</div>\r\n            <div style=\"font-size: 1.2em; font-weight: bold; margin-bottom: 10px;\">\r\n              No Character Found\r\n            </div>\r\n            <div style=\"font-size: 0.9em; color: var(--text-secondary); line-height: 1.4;\">\r\n              Use the <strong>Refresh Characters</strong> button in the extension popup to sync your characters from DiceCloud\r\n            </div>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to load characters:', error);\r\n    // Hide loading overlay and show error\r\n    const loadingOverlay = document.getElementById('loading-overlay');\r\n    if (loadingOverlay) {\r\n      loadingOverlay.innerHTML = `\r\n        <div style=\"text-align: center; color: var(--text-primary); max-width: 400px;\">\r\n          <div style=\"font-size: 3em; margin-bottom: 20px;\">\u26A0\uFE0F</div>\r\n          <div style=\"font-size: 1.2em; font-weight: bold; margin-bottom: 10px;\">\r\n            Failed to Load Character\r\n          </div>\r\n          <div style=\"font-size: 0.9em; color: var(--text-secondary); line-height: 1.4; margin-bottom: 15px;\">\r\n            ${error.message || 'Unknown error'}\r\n          </div>\r\n          <div style=\"font-size: 0.9em; color: var(--text-secondary); line-height: 1.4;\">\r\n            Try using the <strong>Refresh Characters</strong> button in the extension popup\r\n          </div>\r\n        </div>\r\n      `;\r\n    }\r\n  }\r\n}\r\n\r\n// Get the active character ID from storage\r\nasync function getActiveCharacterId() {\r\n  // Use Promise-based API (works in both Chrome and Firefox with our polyfill)\r\n  const result = await browserAPI.storage.local.get(['activeCharacterId']);\r\n  return result.activeCharacterId || null;\r\n}\r\n\r\n// Build character tabs UI\r\n/**\r\n * Check recent chat messages to see if it's currently this character's turn\r\n * This handles the case where a character tab is switched after turn notifications were sent\r\n */\r\nfunction checkCurrentTurnFromChat(characterName) {\r\n  try {\r\n    if (!window.opener) {\r\n      debug.warn('\u26A0\uFE0F No window.opener available for turn check');\r\n      return;\r\n    }\r\n\r\n    // Request recent chat messages from parent window\r\n    window.opener.postMessage({\r\n      action: 'checkCurrentTurn',\r\n      characterName: characterName\r\n    }, '*');\r\n    \r\n    debug.log(`\uD83D\uDD0D Requested turn check for: ${characterName}`);\r\n  } catch (error) {\r\n    debug.warn('\u26A0\uFE0F Error checking current turn:', error);\r\n  }\r\n}\r\n\r\n// Switch to a different character\r\nasync function switchToCharacter(characterId) {\r\n  try {\r\n    debug.log(`\uD83D\uDD04 Switching to character: ${characterId}`);\r\n\r\n    // Save current character data before switching to preserve local state\r\n    // CRITICAL: Save to BOTH cache AND browser storage to persist through refresh\r\n    if (characterData && globalThis.currentSlotId && globalThis.currentSlotId !== characterId) {\r\n      debug.log('\uD83D\uDCBE Saving current character data before switching');\r\n      const dataToSave = JSON.parse(JSON.stringify(characterData));\r\n      \r\n      // Save to cache for immediate access\r\n      if (typeof characterCache !== 'undefined') {\r\n        characterCache.set(globalThis.currentSlotId, dataToSave);\r\n        debug.log(`\u2705 Cached current character data: ${characterData.name}`);\r\n      }\r\n\r\n      // Save to browser storage (persists through refresh/close) WITH slotId\r\n      await browserAPI.runtime.sendMessage({\r\n        action: 'storeCharacterData',\r\n        data: dataToSave,\r\n        slotId: globalThis.currentSlotId\r\n      });\r\n      debug.log(`\u2705 Saved current character data to storage: ${characterData.name}`);\r\n    }\r\n\r\n    // Set as active character\r\n    await setActiveCharacter(characterId);\r\n    globalThis.currentSlotId = characterId;\r\n\r\n    // Load the new character data\r\n    let newCharacterData = null;\r\n    \r\n    // Check if this is a database character\r\n    if (characterId.startsWith('db-')) {\r\n      // Load from database\r\n      const dbCharacterId = characterId.replace('db-', '');\r\n      try {\r\n        const dbResponse = await browserAPI.runtime.sendMessage({ \r\n          action: 'getCharacterDataFromDatabase', \r\n          characterId: dbCharacterId \r\n        });\r\n        if (dbResponse.success) {\r\n          newCharacterData = dbResponse.data;\r\n          debug.log('\u2705 Loaded database character:', newCharacterData.name);\r\n          showNotification(`\u2601\uFE0F Loaded ${newCharacterData.name} from cloud`, 'info');\r\n        } else {\r\n          throw new Error(dbResponse.error || 'Failed to load database character');\r\n        }\r\n      } catch (dbError) {\r\n        debug.error('\u274C Failed to load database character:', dbError);\r\n        showNotification('\u274C Failed to load character from database', 'error');\r\n        return;\r\n      }\r\n    } else {\r\n      // Load from local storage\r\n      const response = await browserAPI.runtime.sendMessage({\r\n        action: 'getCharacterData',\r\n        characterId: characterId\r\n      });\r\n\r\n      if (response.success) {\r\n        newCharacterData = response.data;\r\n        debug.log('\u2705 Loaded local character:', newCharacterData.name);\r\n        showNotification(`\uD83D\uDCBE Loaded ${newCharacterData.name} from local storage`, 'success');\r\n      } else {\r\n        throw new Error(response.error || 'Failed to load local character');\r\n      }\r\n    }\r\n\r\n    if (newCharacterData) {\r\n      characterData = newCharacterData;\r\n      \r\n      // Cache the loaded character data\r\n      if (typeof characterCache !== 'undefined') {\r\n        characterCache.set(characterId, characterData);\r\n      }\r\n\r\n      // Build the character sheet\r\n      if (typeof buildSheet === 'function') {\r\n        buildSheet(characterData);\r\n      } else {\r\n        debug.warn('\u26A0\uFE0F buildSheet function not available');\r\n      }\r\n      \r\n      // Initialize racial traits based on character data\r\n      initRacialTraits();\r\n\r\n      // Initialize feat traits based on character data\r\n      initFeatTraits();\r\n\r\n      // Initialize class features based on character data\r\n      initClassFeatures();\r\n\r\n      // Send sync message to DiceCloud if experimental sync is available\r\n      // Always send sync messages in experimental build - they'll be handled by Roll20 content script\r\n      debug.log('\uD83D\uDD04 Sending character data update to DiceCloud sync...');\r\n\r\n      // Extract Channel Divinity from resources if it exists\r\n      const channelDivinityResource = characterData.resources?.find(r =>\r\n        r.name && r.name.toLowerCase().includes('channel divinity')\r\n      );\r\n\r\n      const syncMessage = {\r\n        action: 'characterUpdate',\r\n        characterId: characterData.id,\r\n        characterName: characterData.name,\r\n        hitPoints: characterData.hitPoints,\r\n        temporaryHP: characterData.temporaryHP,\r\n        spellSlots: characterData.spellSlots,\r\n        channelDivinity: channelDivinityResource ? {\r\n          current: channelDivinityResource.current,\r\n          max: channelDivinityResource.max,\r\n          variableName: channelDivinityResource.variableName || channelDivinityResource.varName\r\n        } : null,\r\n        resources: characterData.resources || [],\r\n        actions: characterData.actions || [],\r\n        deathSaves: characterData.deathSaves,\r\n        inspiration: characterData.inspiration,\r\n        conditions: characterData.conditions || [],\r\n        source: characterData.source || 'local'\r\n      };\r\n\r\n      // Send to all Roll20 tabs\r\n      try {\r\n        const tabs = await browserAPI.tabs.query({ url: '*://app.roll20.net/*' });\r\n        for (const tab of tabs) {\r\n          browserAPI.tabs.sendMessage(tab.id, syncMessage).catch(err => {\r\n            debug.warn(`Failed to send sync to tab ${tab.id}:`, err);\r\n          });\r\n        }\r\n        debug.log(`\uD83D\uDCE4 Sent character update to ${tabs.length} Roll20 tabs`);\r\n      } catch (syncError) {\r\n        debug.warn('Failed to send sync to Roll20 tabs:', syncError);\r\n      }\r\n\r\n      // Update tabs to show new active character\r\n      await loadAndBuildTabs();\r\n      \r\n      // Show success notification\r\n      const source = characterData.source || 'local';\r\n      const sourceText = source === 'database' ? '\uD83C\uDF10' : '\uD83D\uDCBE';\r\n      showNotification(`${sourceText} Switched to ${characterData.name}`, 'success');\r\n      \r\n      debug.log(`\u2705 Successfully switched to character: ${characterData.name}`);\r\n    } else {\r\n      throw new Error('No character data available');\r\n    }\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to switch character:', error);\r\n    showNotification('\u274C Failed to switch character', 'error');\r\n  }\r\n}\r\n\r\n// Show options modal for clearing/deleting character\r\nfunction showClearCharacterOptions(slotId, slotNum, characterName) {\r\n  const colors = getPopupThemeColors();\r\n\r\n  // Create modal overlay\r\n  const overlay = document.createElement('div');\r\n  overlay.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background: rgba(0, 0, 0, 0.7);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10000;\r\n  `;\r\n\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = `\r\n    background: ${colors.background};\r\n    border: 2px solid ${colors.border};\r\n    border-radius: 12px;\r\n    padding: 24px;\r\n    max-width: 400px;\r\n    width: 90%;\r\n    box-shadow: 0 4px 20px rgba(0,0,0,0.3);\r\n  `;\r\n\r\n  modal.innerHTML = `\r\n    <h3 style=\"margin: 0 0 16px 0; color: ${colors.text};\">Clear Character Data</h3>\r\n    <p style=\"margin: 0 0 20px 0; color: ${colors.textSecondary};\">\r\n      What would you like to do with <strong>${characterName}</strong>?\r\n    </p>\r\n\r\n    <div style=\"display: flex; flex-direction: column; gap: 12px;\">\r\n      <button id=\"clear-local-btn\" style=\"\r\n        padding: 12px 20px;\r\n        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);\r\n        color: white;\r\n        border: none;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 14px;\r\n      \">\r\n        \uD83D\uDDD1\uFE0F Clear Local Data Only\r\n      </button>\r\n      <p style=\"margin: -8px 0 0 0; padding-left: 8px; font-size: 12px; color: ${colors.textSecondary};\">\r\n        Remove from this browser, keep in cloud\r\n      </p>\r\n\r\n      <button id=\"delete-cloud-btn\" style=\"\r\n        padding: 12px 20px;\r\n        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);\r\n        color: white;\r\n        border: none;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 14px;\r\n      \">\r\n        \u2601\uFE0F Delete from Cloud\r\n      </button>\r\n      <p style=\"margin: -8px 0 0 0; padding-left: 8px; font-size: 12px; color: ${colors.textSecondary};\">\r\n        Delete from cloud AND local storage\r\n      </p>\r\n\r\n      <button id=\"cancel-clear-btn\" style=\"\r\n        padding: 12px 20px;\r\n        background: ${colors.buttonSecondary};\r\n        color: ${colors.text};\r\n        border: 2px solid ${colors.border};\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 14px;\r\n        margin-top: 8px;\r\n      \">\r\n        Cancel\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  overlay.appendChild(modal);\r\n  document.body.appendChild(overlay);\r\n\r\n  // Clear local only\r\n  modal.querySelector('#clear-local-btn').addEventListener('click', async () => {\r\n    document.body.removeChild(overlay);\r\n    await clearCharacterSlot(slotId, slotNum, false);\r\n  });\r\n\r\n  // Delete from cloud\r\n  modal.querySelector('#delete-cloud-btn').addEventListener('click', async () => {\r\n    if (confirm(`\u26A0\uFE0F Delete ${characterName} from cloud?\\n\\nThis will permanently delete the character from cloud storage and remove it from this browser.`)) {\r\n      document.body.removeChild(overlay);\r\n      await deleteCharacterFromCloud(slotId, slotNum);\r\n    }\r\n  });\r\n\r\n  // Cancel\r\n  modal.querySelector('#cancel-clear-btn').addEventListener('click', () => {\r\n    document.body.removeChild(overlay);\r\n  });\r\n\r\n  // Close on overlay click\r\n  overlay.addEventListener('click', (e) => {\r\n    if (e.target === overlay) {\r\n      document.body.removeChild(overlay);\r\n    }\r\n  });\r\n}\r\n\r\n// Clear a character slot (local only)\r\nasync function clearCharacterSlot(slotId, slotNum) {\r\n  try {\r\n    // Clear in-memory state if this is the current character\r\n    if (globalThis.currentSlotId === slotId) {\r\n      characterData = null;\r\n      globalThis.currentSlotId = null;\r\n    }\r\n\r\n    await browserAPI.runtime.sendMessage({\r\n      action: 'clearCharacterData',\r\n      characterId: slotId\r\n    });\r\n\r\n    showNotification(`\u2705 Slot ${slotNum} cleared from local storage`);\r\n\r\n    // Reload tabs (will load a different character if available)\r\n    loadCharacterWithTabs();\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to clear slot:', error);\r\n    showNotification('\u274C Failed to clear slot', 'error');\r\n  }\r\n}\r\n\r\n// Delete character from cloud AND local\r\nasync function deleteCharacterFromCloud(slotId, slotNum) {\r\n  try {\r\n    // Clear in-memory state if this is the current character\r\n    if (globalThis.currentSlotId === slotId) {\r\n      characterData = null;\r\n      globalThis.currentSlotId = null;\r\n    }\r\n\r\n    // First delete from cloud\r\n    await browserAPI.runtime.sendMessage({\r\n      action: 'deleteCharacterFromCloud',\r\n      characterId: slotId\r\n    });\r\n\r\n    // Then clear from local\r\n    await browserAPI.runtime.sendMessage({\r\n      action: 'clearCharacterData',\r\n      characterId: slotId\r\n    });\r\n\r\n    showNotification(`\u2705 Character deleted from cloud and local storage`);\r\n\r\n    // Reload tabs (will load a different character if available)\r\n    loadCharacterWithTabs();\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to delete character:', error);\r\n    showNotification('\u274C Failed to delete character: ' + error.message, 'error');\r\n  }\r\n}\r\n\r\n\r\n// Global advantage state\r\nlet advantageState = 'normal'; // 'advantage', 'normal', or 'disadvantage'\r\n\r\n// Add event listeners for rest buttons and advantage toggle\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  const shortRestBtn = document.getElementById('short-rest-btn');\r\n  const longRestBtn = document.getElementById('long-rest-btn');\r\n\r\n  if (shortRestBtn) {\r\n    shortRestBtn.addEventListener('click', takeShortRest);\r\n  }\r\n\r\n  if (longRestBtn) {\r\n    longRestBtn.addEventListener('click', takeLongRest);\r\n  }\r\n\r\n  // Advantage toggle buttons\r\n  const advantageBtn = document.getElementById('advantage-btn');\r\n  const normalBtn = document.getElementById('normal-btn');\r\n  const disadvantageBtn = document.getElementById('disadvantage-btn');\r\n\r\n  if (advantageBtn) {\r\n    advantageBtn.addEventListener('click', () => setAdvantageState('advantage'));\r\n  }\r\n\r\n  if (normalBtn) {\r\n    normalBtn.addEventListener('click', () => setAdvantageState('normal'));\r\n  }\r\n\r\n  if (disadvantageBtn) {\r\n    disadvantageBtn.addEventListener('click', () => setAdvantageState('disadvantage'));\r\n  }\r\n});\r\n\r\n// Helper function for setting active character (backup if runtime message fails)\r\nasync function setActiveCharacter(characterId) {\r\n  try {\r\n    await browserAPI.storage.local.set({\r\n      activeCharacterId: characterId\r\n    });\r\n    debug.log(`\u2705 Set active character: ${characterId}`);\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to set active character:', error);\r\n  }\r\n}\r\n\r\nfunction setAdvantageState(state) {\r\n  advantageState = state;\r\n\r\n  const advantageBtn = document.getElementById('advantage-btn');\r\n  const normalBtn = document.getElementById('normal-btn');\r\n  const disadvantageBtn = document.getElementById('disadvantage-btn');\r\n\r\n  // Reset all buttons\r\n  [advantageBtn, normalBtn, disadvantageBtn].forEach(btn => {\r\n    if (btn) {\r\n      btn.classList.remove('active');\r\n      const color = btn.id.includes('advantage') ? 'var(--accent-success)' :\r\n                   btn.id.includes('normal') ? '#FC57F9' :\r\n                   'var(--accent-danger)';\r\n      btn.style.background = 'transparent';\r\n      btn.style.color = color;\r\n      btn.style.borderColor = color;\r\n    }\r\n  });\r\n\r\n  // Highlight active button\r\n  const activeBtn = state === 'advantage' ? advantageBtn :\r\n                   state === 'normal' ? normalBtn :\r\n                   disadvantageBtn;\r\n\r\n  if (activeBtn) {\r\n    activeBtn.classList.add('active');\r\n    const color = state === 'advantage' ? 'var(--accent-success)' :\r\n                 state === 'normal' ? '#FC57F9' :\r\n                 'var(--accent-danger)';\r\n    activeBtn.style.background = color;\r\n    activeBtn.style.color = 'white';\r\n  }\r\n\r\n  debug.log(`\uD83C\uDFB2 Advantage state set to: ${state}`);\r\n  showNotification(`\uD83C\uDFB2 ${state === 'advantage' ? 'Advantage' : state === 'disadvantage' ? 'Disadvantage' : 'Normal'} rolls selected`);\r\n\r\n  // Announce advantage state change to Roll20\r\n  const stateEmoji = state === 'advantage' ? '\uD83C\uDFAF' : state === 'disadvantage' ? '\uD83C\uDFB2' : '\u2696\uFE0F';\r\n  const announcement = `&{template:default} {{name=${getColoredBanner(characterData)}${characterData.name} sets roll mode}} {{${stateEmoji}=${state === 'advantage' ? 'Advantage' : state === 'disadvantage' ? 'Disadvantage' : 'Normal'} rolls selected}}`;\r\n  const messageData = {\r\n    action: 'announceSpell',\r\n    message: announcement,\r\n    color: characterData.notificationColor\r\n  };\r\n\r\n  // Send to Roll20\r\n  if (window.opener && !window.opener.closed) {\r\n    try {\r\n      window.opener.postMessage(messageData, '*');\r\n    } catch (error) {\r\n      debug.warn('\u26A0\uFE0F Could not send advantage state via window.opener:', error.message);\r\n      browserAPI.runtime.sendMessage({\r\n        action: 'relayRollToRoll20',\r\n        roll: messageData\r\n      });\r\n    }\r\n  } else {\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'relayRollToRoll20',\r\n      roll: messageData\r\n    });\r\n  }\r\n}\r\n\r\n\r\n// buildSpellsBySource is now in modules/spell-display.js\r\n\r\n// Store Sneak Attack toggle state (independent from DiceCloud - controlled only by our sheet)\r\nlet sneakAttackEnabled = false;  // Always starts unchecked - user manually enables when needed\r\nlet sneakAttackDamage = '';\r\n\r\n// Store Elemental Weapon toggle state (independent from DiceCloud - controlled only by our sheet)\r\nlet elementalWeaponEnabled = false;  // Always starts unchecked - user manually enables when needed\r\nlet elementalWeaponDamage = '1d4';  // Default to level 3 (base damage)\r\n\r\n// Filter state for actions\r\n// actionFilters now in modules/action-filters.js\r\n\r\n// Filter state for spells (now handled by modules/spell-display.js as window.spellFilters)\r\n\r\n// Filter state for inventory (default to equipped only)\r\nlet inventoryFilters = {\r\n  filter: 'equipped', // all, equipped, attuned, container\r\n  search: ''\r\n};\r\n\r\n// Helper function to categorize an action\r\n// categorizeAction now in modules/action-filters.js\r\n\r\n// categorizeSpell is now in modules/spell-display.js\r\n\r\n// Initialize filter event listeners\r\nfunction initializeFilters() {\r\n  // Action filters now handled by modules/action-filters.js\r\n  initializeActionFilters();\r\n\r\n  // Spell filters now handled by modules/spell-display.js\r\n  initializeSpellFilters();\r\n\r\n  // Inventory filters\r\n  const inventorySearch = document.getElementById('inventory-search');\r\n  if (inventorySearch) {\r\n    inventorySearch.addEventListener('input', (e) => {\r\n      inventoryFilters.search = e.target.value.toLowerCase();\r\n      rebuildInventory();\r\n    });\r\n  }\r\n\r\n  // Inventory type filters\r\n  document.querySelectorAll('[data-type=\"inventory-filter\"]').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      inventoryFilters.filter = btn.dataset.filter;\r\n      document.querySelectorAll('[data-type=\"inventory-filter\"]').forEach(b => b.classList.remove('active'));\r\n      btn.classList.add('active');\r\n      rebuildInventory();\r\n    });\r\n  });\r\n}\r\n\r\n// Rebuild actions with current filters\r\n// rebuildActions now in modules/action-display.js\r\n\r\n// rebuildSpells is now in modules/spell-display.js\r\n\r\n// Rebuild inventory with current filters\r\n// Note: rebuildInventory is now provided by inventory-manager.js\r\n\r\n// getActionOptions now in modules/action-options.js\r\n\r\n// buildActionsDisplay now in modules/action-display.js\r\n// decrementActionUses now in modules/action-display.js\r\n\r\n\r\n// buildSpellSlotsDisplay and adjustSpellSlot are now in modules/spell-slots.js\r\n\r\n\r\n// ===== CARD CREATION =====\r\n// Moved to modules/card-creator.js - using wrapper for compatibility\r\nfunction createCard(title, main, sub, onClick) {\r\n  return window.CardCreator.createCard(title, main, sub, onClick);\r\n}\r\n\r\n\r\n// createSpellCard, validateSpellData, getSpellOptions now in modules/spell-cards.js\r\n\r\n// showSpellModal, handleSpellOption now in modules/spell-modals.js\r\n\r\n// getCustomMacros, saveCustomMacros, showCustomMacroModal now in modules/spell-macros.js\r\n\r\n// ===== SPELL CASTING =====\r\n// castSpell, castWithSlot, useClassResource, detectClassResources, showResourceChoice, showUpcastChoice now in modules/spell-casting.js\r\n// announceSpellDescription, announceSpellCast, getSpellcastingAbilityMod, getSpellAttackBonus now in modules/spell-casting.js\r\n\r\n// ===== METAMAGIC SYSTEM =====\r\n// Core logic lives in modules/action-executor.js; these are thin wrappers\r\n// that pass the global characterData.\r\n\r\nfunction getAvailableMetamagic() {\r\n  const options = executorGetAvailableMetamagic(characterData);\r\n  debug.log('\uD83D\uDD2E Found metamagic options:', options.map(m => m.name));\r\n  return options;\r\n}\r\n\r\n// Theme-aware modal helper\r\nfunction handleLayOnHands(action) {\r\n  const layOnHandsPool = getLayOnHandsResource();\r\n\r\n  if (!layOnHandsPool) {\r\n    showNotification(`\u274C No Lay on Hands pool resource found`, 'error');\r\n    return;\r\n  }\r\n\r\n  if (layOnHandsPool.current <= 0) {\r\n    showNotification(`\u274C No Lay on Hands points remaining!`, 'error');\r\n    return;\r\n  }\r\n\r\n  // Show modal for Lay on Hands\r\n  showLayOnHandsModal(layOnHandsPool);\r\n}\r\n\r\n\r\n// handleRecoverSpellSlot, recoverSpellSlot now in modules/spell-casting.js\r\n\r\n// Legacy functions for backwards compatibility (now use structured data)\r\nfunction calculateMetamagicCost(metamagicName, spellLevel) {\r\n  return executorCalculateMetamagicCost(metamagicName, spellLevel);\r\n}\r\n\r\n// announceAction now in modules/action-announcements.js\r\n\r\n\r\n// Save character data when window is about to close/refresh\r\n// This ensures local modifications persist through browser refresh\r\nwindow.addEventListener('beforeunload', () => {\r\n  if (characterData && globalThis.currentSlotId) {\r\n    debug.log('\uD83D\uDCBE Saving character data before window closes');\r\n    // Use sendMessage synchronously during unload\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'storeCharacterData',\r\n      data: characterData,\r\n      slotId: globalThis.currentSlotId  // CRITICAL: Pass slotId for proper persistence\r\n    });\r\n    debug.log(`\u2705 Saved character data: ${characterData.name} (slotId: ${globalThis.currentSlotId})`);\r\n  }\r\n});\r\n\r\n// ============================================================================\r\n// COMBAT MECHANICS\r\n// ============================================================================\r\n\r\n\r\n/**\r\n * Initialize manual DiceCloud sync button in settings\r\n */\r\nfunction initManualSyncButton() {\r\n  const syncSection = document.getElementById('dicecloud-sync-section');\r\n  const syncButton = document.getElementById('manual-sync-btn');\r\n  const syncStatus = document.getElementById('sync-status');\r\n\r\n  // Only show in experimental builds\r\n  browserAPI.runtime.sendMessage({ action: 'getManifest' }).then(response => {\r\n    if (response && response.success && response.manifest &&\r\n        response.manifest.name && response.manifest.name.includes('EXPERIMENTAL')) {\r\n      if (syncSection) {\r\n        syncSection.style.display = 'block';\r\n        debug.log('\uD83E\uDDEA DiceCloud sync section shown (experimental build)');\r\n      }\r\n    }\r\n  }).catch(err => {\r\n    debug.log('\uD83D\uDCE6 Not experimental build, hiding sync section');\r\n  });\r\n\r\n  if (syncButton) {\r\n    syncButton.addEventListener('click', async () => {\r\n      try {\r\n        debug.log('\uD83D\uDD04 Manual sync button clicked');\r\n\r\n        // Disable button during sync\r\n        syncButton.disabled = true;\r\n        syncButton.textContent = '\uD83D\uDD04 Syncing...';\r\n\r\n        // Show status\r\n        if (syncStatus) {\r\n          syncStatus.style.display = 'block';\r\n          syncStatus.style.background = 'var(--accent-info)';\r\n          syncStatus.style.color = 'white';\r\n          syncStatus.textContent = '\u23F3 Syncing to DiceCloud...';\r\n        }\r\n\r\n        // Collect all character data\r\n        if (!characterData) {\r\n          throw new Error('No character data available');\r\n        }\r\n\r\n        // Extract Channel Divinity from resources if it exists\r\n        const channelDivinityResource = characterData.resources?.find(r =>\r\n          r.name === 'Channel Divinity' ||\r\n          r.variableName === 'channelDivinityCleric' ||\r\n          r.variableName === 'channelDivinityPaladin' ||\r\n          r.variableName === 'channelDivinity'\r\n        );\r\n\r\n        // Build comprehensive sync message\r\n        const syncMessage = {\r\n          type: 'characterDataUpdate',\r\n          characterData: {\r\n            name: characterData.name,\r\n            hp: characterData.hitPoints.current,\r\n            tempHp: characterData.temporaryHP || 0,\r\n            maxHp: characterData.hitPoints.max,\r\n            spellSlots: characterData.spellSlots || {},\r\n            channelDivinity: channelDivinityResource ? {\r\n              current: channelDivinityResource.current,\r\n              max: channelDivinityResource.max\r\n            } : undefined,\r\n            resources: characterData.resources || [],\r\n            actions: characterData.actions || [],\r\n            deathSaves: characterData.deathSaves,\r\n            inspiration: characterData.inspiration,\r\n            lastRoll: characterData.lastRoll\r\n          }\r\n        };\r\n\r\n        debug.log('\uD83D\uDD04 Sending manual sync message:', syncMessage);\r\n\r\n        // Send to Roll20 content script (which will forward to DiceCloud sync)\r\n        if (window.opener && !window.opener.closed) {\r\n          window.opener.postMessage(syncMessage, '*');\r\n          debug.log('\u2705 Sync message sent via opener');\r\n        } else {\r\n          // Also try posting to self (in case we're in a popup)\r\n          window.postMessage(syncMessage, '*');\r\n          debug.log('\u2705 Sync message sent to self');\r\n        }\r\n\r\n        // Wait a bit for sync to complete\r\n        await new Promise(resolve => setTimeout(resolve, 1000));\r\n\r\n        // Show success\r\n        if (syncStatus) {\r\n          syncStatus.style.background = 'var(--accent-success)';\r\n          syncStatus.textContent = '\u2705 Synced successfully!';\r\n        }\r\n        showNotification('\u2705 Character data synced to DiceCloud!', 'success');\r\n        debug.log('\u2705 Manual sync completed');\r\n\r\n        // Reset button\r\n        setTimeout(() => {\r\n          syncButton.disabled = false;\r\n          syncButton.textContent = '\uD83D\uDD04 Sync to DiceCloud Now';\r\n          if (syncStatus) {\r\n            syncStatus.style.display = 'none';\r\n          }\r\n        }, 2000);\r\n\r\n      } catch (error) {\r\n        debug.error('\u274C Manual sync failed:', error);\r\n\r\n        if (syncStatus) {\r\n          syncStatus.style.display = 'block';\r\n          syncStatus.style.background = 'var(--accent-danger)';\r\n          syncStatus.style.color = 'white';\r\n          syncStatus.textContent = '\u274C Sync failed: ' + error.message;\r\n        }\r\n        showNotification('\u274C Sync failed: ' + error.message, 'error');\r\n\r\n        // Reset button\r\n        syncButton.disabled = false;\r\n        syncButton.textContent = '\uD83D\uDD04 Sync to DiceCloud Now';\r\n      }\r\n    });\r\n\r\n    debug.log('\u2705 Manual sync button initialized');\r\n  } else {\r\n    debug.warn('\u26A0\uFE0F Manual sync button not found in settings');\r\n  }\r\n}\r\n\r\n// ===== TURN MANAGEMENT =====\r\n\r\n/**\r\n * Turn state tracking\r\n * When false, action economy indicators should be disabled/grayed out\r\n */\r\nlet isMyTurn = false;\r\n\r\n/**\r\n * Activate turn - enable action economy indicators\r\n * Called when GM panel sends 'activateTurn' message\r\n */\r\nfunction activateTurn() {\r\n  isMyTurn = true;\r\n  const actionIndicators = document.querySelectorAll('.action-economy-item');\r\n\r\n  actionIndicators.forEach(indicator => {\r\n    indicator.style.opacity = '1';\r\n    indicator.style.pointerEvents = 'auto';\r\n    indicator.style.cursor = 'pointer';\r\n  });\r\n\r\n  debug.log('\u2705 Turn activated - action economy enabled');\r\n}\r\n\r\n/**\r\n * Deactivate turn - disable action economy indicators\r\n * Called when GM panel sends 'deactivateTurn' message\r\n */\r\nfunction deactivateTurn() {\r\n  isMyTurn = false;\r\n  const actionIndicators = document.querySelectorAll('.action-economy-item');\r\n\r\n  actionIndicators.forEach(indicator => {\r\n    indicator.style.opacity = '0.3';\r\n    indicator.style.pointerEvents = 'none';\r\n    indicator.style.cursor = 'not-allowed';\r\n  });\r\n\r\n  debug.log('\u23F8\uFE0F Turn deactivated - action economy disabled');\r\n}\r\n\r\n// Listen for messages from GM panel (when it's your turn)\r\nwindow.addEventListener('message', (event) => {\r\n  if (event.data && event.data.action === 'activateTurn') {\r\n    debug.log('\uD83C\uDFAF Your turn! Activating action economy...');\r\n    debug.log('\uD83C\uDFAF Received activateTurn event:', event.data);\r\n\r\n    // Activate turn state\r\n    activateTurn();\r\n\r\n    // Reset action economy for new turn (only reset actions, don't announce)\r\n    const actionIndicator = document.getElementById('action-indicator');\r\n    const bonusActionIndicator = document.getElementById('bonus-action-indicator');\r\n    const movementIndicator = document.getElementById('movement-indicator');\r\n    \r\n    [actionIndicator, bonusActionIndicator, movementIndicator].forEach(indicator => {\r\n      if (indicator) {\r\n        indicator.dataset.used = 'false';\r\n        debug.log(`\uD83D\uDD04 Reset ${indicator.id} to unused`);\r\n      }\r\n    });\r\n    \r\n    debug.log('\uD83D\uDD04 Turn reset: Action, Bonus Action, Movement restored (automatic)');\r\n\r\n    showNotification('\u2694\uFE0F Your turn!', 'success');\r\n  } else if (event.data && event.data.action === 'deactivateTurn') {\r\n    debug.log('\u23F8\uFE0F Turn ended. Deactivating action economy...');\r\n    debug.log('\u23F8\uFE0F Received deactivateTurn event:', event.data);\r\n\r\n    // Deactivate turn state\r\n    deactivateTurn();\r\n  } else if (event.data && event.data.action === 'rollResult') {\r\n    // Handle roll results from content script for racial traits checking\r\n    debug.log('\uD83E\uDDEC Received rollResult message:', event.data);\r\n    \r\n    if (event.data.checkRacialTraits && (activeRacialTraits.length > 0 || activeFeatTraits.length > 0)) {\r\n      const { rollResult, baseRoll, rollType, rollName } = event.data;\r\n      debug.log(`\uD83E\uDDEC Checking racial traits for roll: ${baseRoll} (${rollType}) - ${rollName}`);\r\n      debug.log(`\uD83E\uDDEC Active racial traits count: ${activeRacialTraits.length}`);\r\n      debug.log(`\uD83C\uDF96\uFE0F Active feat traits count: ${activeFeatTraits.length}`);\r\n      debug.log(`\uD83E\uDDEC Roll details - Total: ${rollResult}, Base: ${baseRoll}`);\r\n      \r\n      // Check if any racial traits trigger (use baseRoll for the actual d20 roll)\r\n      const racialTraitTriggered = checkRacialTraits(baseRoll, rollType, rollName);\r\n      const triggeredRacialTraits = [];\r\n      \r\n      // Check if any feat traits trigger (use baseRoll for the actual d20 roll)\r\n      const featTraitTriggered = checkFeatTraits(baseRoll, rollType, rollName);\r\n      const triggeredFeatTraits = [];\r\n      \r\n      // Collect triggered traits\r\n      if (racialTraitTriggered) {\r\n        triggeredRacialTraits.push(...activeRacialTraits.filter(trait => {\r\n          // Check if this trait would trigger for this roll\r\n          const testResult = trait.onRoll(baseRoll, rollType, rollName);\r\n          return testResult === true;\r\n        }));\r\n        debug.log(`\uD83E\uDDEC Racial trait triggered for roll: ${baseRoll}`);\r\n      }\r\n      \r\n      if (featTraitTriggered) {\r\n        triggeredFeatTraits.push(...activeFeatTraits.filter(trait => {\r\n          // Check if this trait would trigger for this roll\r\n          const testResult = trait.onRoll(baseRoll, rollType, rollName);\r\n          return testResult === true;\r\n        }));\r\n        debug.log(`\uD83C\uDF96\uFE0F Feat trait triggered for roll: ${baseRoll}`);\r\n      }\r\n      \r\n      // Show appropriate popup\r\n      if (triggeredRacialTraits.length > 0 || triggeredFeatTraits.length > 0) {\r\n        const allTriggeredTraits = [...triggeredRacialTraits, ...triggeredFeatTraits];\r\n        \r\n        if (allTriggeredTraits.length === 1) {\r\n          // Single trait triggered - show its specific popup\r\n          const trait = allTriggeredTraits[0];\r\n          if (trait.name === 'Halfling Luck') {\r\n            showHalflingLuckPopup({\r\n              rollResult: baseRoll,\r\n              baseRoll: baseRoll,\r\n              rollType: rollType,\r\n              rollName: rollName\r\n            });\r\n          } else if (trait.name === 'Lucky') {\r\n            const luckyResource = getLuckyResource();\r\n            showLuckyPopup({\r\n              rollResult: baseRoll,\r\n              baseRoll: baseRoll,\r\n              rollType: rollType,\r\n              rollName: rollName,\r\n              luckPointsRemaining: luckyResource?.current || 0\r\n            });\r\n          }\r\n        } else {\r\n          // Multiple traits triggered - show choice popup\r\n          showTraitChoicePopup({\r\n            rollResult: baseRoll,\r\n            baseRoll: baseRoll,\r\n            rollType: rollType,\r\n            rollName: rollName,\r\n            racialTraits: triggeredRacialTraits,\r\n            featTraits: triggeredFeatTraits\r\n          });\r\n        }\r\n      }\r\n      \r\n      if (!racialTraitTriggered && !featTraitTriggered) {\r\n        debug.log(`\uD83E\uDDEC\uD83C\uDF96\uFE0F No traits triggered for roll: ${baseRoll}`);\r\n      }\r\n    } else {\r\n      debug.log(`\uD83E\uDDEC Skipping traits check - checkRacialTraits: ${event.data.checkRacialTraits}, racialTraits: ${activeRacialTraits.length}, featTraits: ${activeFeatTraits.length}`);\r\n    }\r\n  } else if (event.data && event.data.action === 'showHalflingLuckPopup') {\r\n    // Show Halfling Luck reroll popup\r\n    showHalflingLuckPopup(event.data.rollData);\r\n  }\r\n});\r\n\r\n// Initialize combat mechanics when sheet loads\r\nsetTimeout(() => {\r\n  initConditionsManager();  // from effects-manager.js\r\n  initConcentrationTracker();\r\n}, 100);\r\n\r\n// Local character cache to preserve state changes\r\n\r\n// ============================================================================\r\n\r\n// Check if opened from GM panel and request character data\r\nif (window.opener && !characterData) {\r\n  // Request character data from parent window\r\n  window.opener.postMessage({ action: 'requestCharacterData' }, '*');\r\n  debug.log('\uD83D\uDCCB Requested character data from parent window');\r\n}\r\n\r\n// Initialize macros and UI components when DOM is ready\r\nif (domReady) {\r\n  initCustomMacros();\r\n  initSettingsButton();\r\n  initStatusBarButton();\r\n  initGMMode();\r\n  initShowToGM();\r\n} else {\r\n  pendingOperations.push(initCustomMacros);\r\n  pendingOperations.push(initSettingsButton);\r\n  pendingOperations.push(initStatusBarButton);\r\n  pendingOperations.push(initGMMode);\r\n  pendingOperations.push(initShowToGM);\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
