<form class="{{cssClass}} foundcloud-sheet-simple" data-theme="{{theme}}" autocomplete="off">
  <!-- Systems Bar -->
  <div class="systems-bar">
    <div class="theme-switcher">
      <button type="button" class="theme-btn {{#if isLightTheme}}active{{/if}}" data-theme="light">Light</button>
      <button type="button" class="theme-btn {{#unless isLightTheme}}active{{/unless}}" data-theme="dark">Dark</button>
    </div>
    <button type="button" class="settings-btn" id="settings-btn" title="Settings">âš™ï¸</button>
    <button type="button" class="close-btn" id="close-btn">âœ•</button>
  </div>

  <!-- Content Area -->
  <div class="content-area">
    <div class="header">
      <!-- Character Portrait -->
      <div class="char-portrait-container">
        <img id="char-portrait" class="draggable-portrait" src="{{actor.img}}" alt="Character Portrait" draggable="true" {{#unless actor.img}}style="display: none;"{{/unless}}>
        <div class="player-color-picker">
          <label for="player-color" title="Player Color (appears in chat and around token)">
            <span class="color-icon">ğŸ¨</span>
          </label>
          <input type="color" id="player-color" name="player-color" value="{{playerColor}}" title="Player Color">
        </div>
      </div>

      <!-- Character Name -->
      <div class="char-name-section">
        {{actor.name}}
      </div>

      <!-- Layer 1: Class, Level, Race, Hit Dice -->
      <div class="char-info-layer layer-1">
        <div><strong>Class:</strong> <span>{{characterClass}}</span></div>
        <div><strong>Level:</strong> <span>{{characterLevel}}</span></div>
        <div><strong>Race:</strong> <span>{{characterRace}}</span></div>
        <div><strong>Hit Dice:</strong> <span>{{hitDice}}</span></div>
      </div>

      <!-- Layer 2: AC, Speed, Proficiency, Death Saves, Inspiration -->
      <div class="char-info-layer layer-2">
        <div class="stat-box">
          <div class="stat-label">Armor Class</div>
          <div class="stat-value">{{armorClass}}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Speed</div>
          <div class="stat-value">{{speed}} ft</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Proficiency</div>
          <div class="stat-value">+{{proficiencyBonus}}</div>
        </div>
        <div class="stat-box clickable" id="death-saves-display">
          <div class="stat-label">Death Saves</div>
          <div style="font-size: 0.9em; font-weight: bold;">
            <span style="color: var(--fc-accent-success);">âœ“{{deathSaves.successes}}</span> /
            <span style="color: var(--fc-accent-danger);">âœ—{{deathSaves.failures}}</span>
          </div>
        </div>
        <div class="stat-box clickable" id="inspiration-display">
          <div class="stat-label">Inspiration</div>
          <div style="font-size: 1.1em; font-weight: bold;">{{#if inspiration}}â˜… Yes{{else}}â˜† None{{/if}}</div>
        </div>
      </div>

      <!-- Layer 3: Hit Points, Initiative -->
      <div class="layer-3">
        <div class="hp-box clickable" id="hp-display">
          <div style="font-size: 0.8em; margin-bottom: 5px;">Hit Points</div>
          <div style="font-size: 1.5em;">{{hp.current}} / {{hp.max}}</div>
          {{#if hp.temp}}
          <div style="font-size: 0.9em; margin-top: 5px;">+{{hp.temp}} temp</div>
          {{/if}}
        </div>
        <div class="initiative-box clickable" id="initiative-button">
          <div style="font-size: 0.8em; margin-bottom: 5px;">Initiative</div>
          <div style="font-size: 1.5em;">{{initiative}}</div>
        </div>
      </div>

      <!-- Layer 4: Rest Buttons & Advantage Toggle -->
      <div class="rest-buttons">
        <button type="button" class="rest-btn short" id="short-rest-btn">â˜• Short Rest</button>
        <button type="button" class="rest-btn long" id="long-rest-btn">ğŸŒ™ Long Rest</button>
      </div>

      <!-- Advantage Toggle -->
      <div style="display: flex; gap: 8px; margin-top: 12px; justify-content: center;">
        <button type="button" id="advantage-btn" class="advantage-toggle {{#if isAdvantage}}active{{/if}}" data-state="advantage">
          âš¡ Advantage
        </button>
        <button type="button" id="normal-btn" class="advantage-toggle {{#if isNormal}}active{{/if}}" data-state="normal">
          âš–ï¸ Normal
        </button>
        <button type="button" id="disadvantage-btn" class="advantage-toggle {{#if isDisadvantage}}active{{/if}}" data-state="disadvantage">
          âš ï¸ Disadvantage
        </button>
      </div>
    </div>

    <!-- Combat Mechanics Section -->
    <div class="combat-section">
      <!-- Action Economy Tracker -->
      <div class="action-economy">
        <div class="action-economy-item" id="action-indicator" data-used="{{combatState.actionUsed}}">
          <div class="action-icon">âš”ï¸</div>
          <div class="action-label">Action</div>
        </div>
        <div class="action-economy-item" id="bonus-action-indicator" data-used="{{combatState.bonusActionUsed}}">
          <div class="action-icon">âš¡</div>
          <div class="action-label">Bonus</div>
        </div>
        <div class="action-economy-item" id="movement-indicator" data-used="{{combatState.movementUsed}}">
          <div class="action-icon">ğŸ‘Ÿ</div>
          <div class="action-label">Movement</div>
        </div>
        <div class="action-economy-item" id="reaction-indicator" data-used="{{combatState.reactionUsed}}">
          <div class="action-icon">ğŸ›¡ï¸</div>
          <div class="action-label">Reaction</div>
        </div>
      </div>

      <!-- Conditions & Concentration Row -->
      <div class="combat-status-row">
        <!-- Concentration Indicator -->
        {{#if combatState.concentration}}
        <div class="concentration-indicator" id="concentration-indicator">
          <span class="concentration-icon">ğŸ§ </span>
          <span class="concentration-text">Concentrating on: <strong>{{combatState.concentration}}</strong></span>
          <button type="button" class="concentration-drop-btn" id="drop-concentration-btn" title="Drop concentration">âœ•</button>
        </div>
        {{/if}}

        <!-- Conditions Manager -->
        <div class="conditions-manager">
          <button type="button" class="conditions-btn" id="add-condition-btn">
            <span>ğŸ­</span> Add Effect
          </button>
          <div class="conditions-dropdown" id="conditions-dropdown" style="display: none;">
            {{#each conditionsList}}
            <div class="condition-option" data-condition="{{this.id}}">
              <span class="condition-icon">{{{this.icon}}}</span>
              <span class="condition-name">{{this.name}}</span>
            </div>
            {{/each}}
          </div>
          <div class="active-conditions" id="active-conditions">
            {{#each combatState.conditions}}
            <span class="condition-badge" data-condition="{{this}}">
              {{this}} <span class="condition-badge-remove">âœ•</span>
            </span>
            {{/each}}
          </div>
        </div>
      </div>
    </div>

    <!-- Resources & Spell Slots -->
    <div class="section">
      <h3>ğŸ’ Resources</h3>
      <div class="section-content">
        <div id="resources-container" class="resources-grid">
          {{#if resources.length}}
          {{#each resources}}
          <div class="resource-card" data-resource-id="{{this.id}}">
            <div class="resource-name">{{this.name}}</div>
            <div class="resource-uses">{{this.current}} / {{this.max}}</div>
            <div class="resource-recovery">{{this.recovery}}</div>
            <div class="resource-buttons">
              <button type="button" class="resource-use-btn" data-resource-id="{{this.id}}" title="Use">âˆ’</button>
              <button type="button" class="resource-restore-btn" data-resource-id="{{this.id}}" title="Restore">+</button>
            </div>
          </div>
          {{/each}}
          {{else}}
          <div style="text-align: center; color: var(--fc-text-muted); padding: 20px;">No resources</div>
          {{/if}}
        </div>
      </div>
    </div>

    <div class="section">
      <h3>âœ¨ Spell Slots</h3>
      <div class="section-content">
        <div class="spell-slots-grid" id="spell-slots-container">
          {{#each spellSlots}}
          <div class="spell-slot-card {{#if this.isEmpty}}empty{{/if}}" data-level="{{this.level}}">
            <div class="spell-slot-level">{{this.levelLabel}}</div>
            <div class="spell-slot-count">{{this.current}} / {{this.max}}</div>
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    <!-- Abilities, Saves, Skills -->
    <div class="section">
      <h3>âš¡ Abilities</h3>
      <div class="section-content">
        <div class="grid" id="abilities-grid">
          {{#each abilities}}
          <div class="card ability-card" data-ability="{{this.key}}">
            <div style="font-weight: bold; font-size: 0.9em;">{{this.abbr}}</div>
            <div style="font-size: 0.85em; color: var(--fc-text-secondary);">{{this.value}}</div>
            <div class="bonus">{{this.mod}}</div>
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    <div class="section">
      <h3>ğŸ›¡ï¸ Saving Throws</h3>
      <div class="section-content">
        <div class="grid" id="saves-grid">
          {{#each saves}}
          <div class="card save-card {{#if this.proficient}}proficient{{/if}}" data-ability="{{this.key}}">
            <div style="font-weight: bold; font-size: 0.9em;">{{this.abbr}}</div>
            <div class="bonus">{{this.mod}}</div>
            {{#if this.proficient}}<div style="position: absolute; top: 4px; right: 4px; color: var(--fc-accent-success);">â—</div>{{/if}}
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    <div class="section">
      <h3>ğŸ¯ Skills</h3>
      <div class="section-content">
        <div class="grid" id="skills-grid">
          {{#each skills}}
          <div class="card skill-card {{#if this.proficient}}proficient{{/if}} {{#if this.expertise}}expertise{{/if}}" data-skill="{{this.key}}">
            <div style="font-weight: bold; font-size: 0.85em;">{{this.name}}</div>
            <div style="font-size: 0.75em; color: var(--fc-text-secondary);">({{this.ability}})</div>
            <div class="bonus">{{this.mod}}</div>
            {{#if this.expertise}}<div style="position: absolute; top: 4px; right: 4px; color: var(--fc-accent-warning);">â˜…</div>{{/if}}
            {{#if this.proficient}}<div style="position: absolute; top: 4px; right: 4px; color: var(--fc-accent-success);">â—</div>{{/if}}
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    <!-- Actions & Spells -->
    <div class="section">
      <h3>âš”ï¸ Actions & Attacks</h3>
      <div class="section-content">
        <div id="actions-filters" style="margin-bottom: 15px;">
          <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px;">
            <input type="text" id="actions-search" placeholder="ğŸ” Search actions..." style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button type="button" class="filter-btn active" data-filter="all" data-type="action-type">All</button>
            <button type="button" class="filter-btn" data-filter="action" data-type="action-type">âš”ï¸ Action</button>
            <button type="button" class="filter-btn" data-filter="bonus" data-type="action-type">âš¡ Bonus</button>
            <button type="button" class="filter-btn" data-filter="reaction" data-type="action-type">ğŸ›¡ï¸ Reaction</button>
            <button type="button" class="filter-btn" data-filter="free" data-type="action-type">ğŸ†“ Free</button>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
            <button type="button" class="filter-btn active" data-filter="all" data-type="action-category">All Types</button>
            <button type="button" class="filter-btn" data-filter="damage" data-type="action-category">ğŸ’¥ Damage</button>
            <button type="button" class="filter-btn" data-filter="healing" data-type="action-category">ğŸ’š Healing</button>
            <button type="button" class="filter-btn" data-filter="utility" data-type="action-category">ğŸ”§ Utility</button>
          </div>
        </div>
        <div id="actions-container">
          {{#each actions}}
          <div class="action-card" data-item-id="{{this.id}}" data-name="{{this.name}}" data-action-type="{{this.actionType}}" data-category="{{this.category}}">
            <div class="action-header">
              <div class="action-name">{{this.name}}</div>
              <div class="action-buttons">
                {{#if this.hasAttack}}
                <button type="button" class="attack-btn" data-item-id="{{this.id}}">ğŸ² {{this.attackBonus}}</button>
                {{/if}}
                {{#if this.hasDamage}}
                <button type="button" class="damage-btn" data-item-id="{{this.id}}">ğŸ’¥ {{this.damage}}</button>
                {{/if}}
                {{#unless this.hasAttack}}
                {{#unless this.hasDamage}}
                <button type="button" class="use-btn" data-item-id="{{this.id}}">Use</button>
                {{/unless}}
                {{/unless}}
              </div>
            </div>
            <div class="action-description" data-item-id="{{this.id}}">
              {{{this.description}}}
            </div>
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    <div class="section">
      <h3>ğŸ”® Spells</h3>
      <div class="section-content">
        <div id="spells-filters" style="margin-bottom: 15px;">
          <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px;">
            <input type="text" id="spells-search" placeholder="ğŸ” Search spells..." style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button type="button" class="filter-btn active" data-filter="all" data-type="spell-level">All Levels</button>
            <button type="button" class="filter-btn" data-filter="0" data-type="spell-level">Cantrips</button>
            <button type="button" class="filter-btn" data-filter="1" data-type="spell-level">1st</button>
            <button type="button" class="filter-btn" data-filter="2" data-type="spell-level">2nd</button>
            <button type="button" class="filter-btn" data-filter="3" data-type="spell-level">3rd</button>
            <button type="button" class="filter-btn" data-filter="4" data-type="spell-level">4th</button>
            <button type="button" class="filter-btn" data-filter="5" data-type="spell-level">5th</button>
            <button type="button" class="filter-btn" data-filter="6" data-type="spell-level">6th</button>
            <button type="button" class="filter-btn" data-filter="7" data-type="spell-level">7th</button>
            <button type="button" class="filter-btn" data-filter="8" data-type="spell-level">8th</button>
            <button type="button" class="filter-btn" data-filter="9" data-type="spell-level">9th</button>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
            <button type="button" class="filter-btn active" data-filter="all" data-type="spell-category">All Types</button>
            <button type="button" class="filter-btn" data-filter="damage" data-type="spell-category">ğŸ’¥ Damage</button>
            <button type="button" class="filter-btn" data-filter="healing" data-type="spell-category">ğŸ’š Healing</button>
            <button type="button" class="filter-btn" data-filter="utility" data-type="spell-category">ğŸ”§ Utility</button>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
            <button type="button" class="filter-btn active" data-filter="all" data-type="spell-casting-time">All Times</button>
            <button type="button" class="filter-btn" data-filter="action" data-type="spell-casting-time">âš”ï¸ Action</button>
            <button type="button" class="filter-btn" data-filter="bonus" data-type="spell-casting-time">âš¡ Bonus Action</button>
            <button type="button" class="filter-btn" data-filter="reaction" data-type="spell-casting-time">ğŸ›¡ï¸ Reaction</button>
          </div>
        </div>
        <div id="spells-container">
          {{#each spells}}
          <div class="spell-card" data-item-id="{{this.id}}" data-name="{{this.name}}" data-level="{{this.level}}" data-category="{{this.category}}" data-casting-time="{{this.castingTime}}">
            <div class="spell-header">
              <div>
                <strong>{{this.name}}</strong>
                {{#if this.concentration}}<span class="concentration-tag">ğŸ§  C</span>{{/if}}
                {{#if this.ritual}}<span class="ritual-tag">ğŸ“– R</span>{{/if}}
              </div>
              <div class="action-buttons">
                <button type="button" class="cast-btn" data-item-id="{{this.id}}">Cast</button>
                {{#if this.hasAttack}}
                <button type="button" class="attack-btn" data-item-id="{{this.id}}">ğŸ² Attack</button>
                {{/if}}
                {{#if this.hasDamage}}
                <button type="button" class="damage-btn" data-item-id="{{this.id}}">ğŸ’¥ {{this.damage}}</button>
                {{/if}}
              </div>
            </div>
            <div class="spell-description" data-item-id="{{this.id}}">
              {{{this.description}}}
            </div>
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    <!-- Inventory & Equipment -->
    <div class="section" id="inventory-section">
      <h3>ğŸ’ Inventory & Equipment</h3>
      <div class="section-content">
        <div id="inventory-filters" style="margin-bottom: 15px;">
          <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px;">
            <input type="text" id="inventory-search" placeholder="ğŸ” Search inventory..." style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button type="button" class="filter-btn" data-filter="all" data-type="inventory-filter">All Items</button>
            <button type="button" class="filter-btn active" data-filter="equipped" data-type="inventory-filter">âš”ï¸ Equipped</button>
            <button type="button" class="filter-btn" data-filter="attuned" data-type="inventory-filter">âœ¨ Attuned</button>
            <button type="button" class="filter-btn" data-filter="container" data-type="inventory-filter">ğŸ“¦ Containers</button>
          </div>
        </div>
        <div id="inventory-container">
          {{#each inventory}}
          <div class="inventory-item" data-item-id="{{this.id}}" data-name="{{this.name}}" data-equipped="{{this.equipped}}" data-attuned="{{this.attuned}}">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px;">
              <div>
                <strong>{{this.name}}</strong>
                {{#if this.equipped}}<span style="color: var(--fc-accent-success); margin-left: 8px;">âš”ï¸</span>{{/if}}
                {{#if this.attuned}}<span style="color: var(--fc-accent-warning); margin-left: 8px;">âœ¨</span>{{/if}}
                <div style="font-size: 0.85em; color: var(--fc-text-secondary);">Qty: {{this.quantity}}</div>
              </div>
            </div>
          </div>
          {{/each}}
        </div>
      </div>
    </div>
  </div>

  <!-- Status Bar (sticky bottom) -->
  <div class="status-bar">
    <!-- HP Progress Bar -->
    <div class="status-hp-section">
      <span class="status-hp-icon">â¤ï¸</span>
      <div class="status-hp-bar">
        <div class="status-hp-fill {{hpClass}}" style="width: {{hpPercent}}%"></div>
        <div class="status-hp-text">{{hp.current}}/{{hp.max}}{{#if hp.temp}} +{{hp.temp}}t{{/if}}</div>
      </div>
    </div>

    <!-- Advantage Toggle (compact) -->
    <div class="status-adv-section">
      <button type="button" class="status-adv-btn adv {{#if isAdvantage}}active{{/if}}" data-adv="advantage" title="Advantage">â¬†ï¸</button>
      <button type="button" class="status-adv-btn norm {{#if isNormal}}active{{/if}}" data-adv="normal" title="Normal">ğŸ²</button>
      <button type="button" class="status-adv-btn dis {{#if isDisadvantage}}active{{/if}}" data-adv="disadvantage" title="Disadvantage">â¬‡ï¸</button>
    </div>

    <!-- Initiative -->
    <div class="status-init-section">
      <span>âš¡</span> Init {{initiative}}
    </div>

    <!-- Concentration -->
    {{#if combatState.concentration}}
    <div class="status-conc-section">
      <span>ğŸ§ </span>
      <span class="status-conc-spell">{{combatState.concentration}}</span>
    </div>
    {{/if}}

    <!-- Spell Slots Summary -->
    {{#if spellSlotsSummary}}
    <div class="status-slots-section">
      <span>âœ¨</span> Slots {{spellSlotsSummary}}
    </div>
    {{/if}}

    <!-- Active Conditions -->
    {{#if combatState.conditions.length}}
    <div class="status-conditions">
      {{#each combatState.conditions}}
      <span class="status-condition-badge">{{this}}</span>
      {{/each}}
    </div>
    {{/if}}
  </div>
</form>
