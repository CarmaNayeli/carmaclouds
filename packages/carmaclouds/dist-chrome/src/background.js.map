{
  "version": 3,
  "sources": ["../../src/background.js"],
  "sourcesContent": ["/**\r\n * CarmaClouds Unified Background Service Worker\r\n * Handles cross-platform character sync and messaging\r\n */\r\n\r\n// Detect browser API (Firefox uses 'browser', Chrome uses 'chrome')\r\nconst browserAPI = (typeof browser !== 'undefined' && browser.runtime) ? browser : chrome;\r\n\r\nconsole.log('CarmaClouds background service worker initialized');\r\n\r\n// Supabase configuration for direct API calls\r\nconst SUPABASE_URL = 'https://luiesmfjdcmpywavvfqm.supabase.co';\r\nconst SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1aWVzbWZqZGNtcHl3YXZ2ZnFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODYxNDksImV4cCI6MjA4NTQ2MjE0OX0.oqjHFf2HhCLcanh0HVryoQH7iSV7E9dHHZJdYehxZ0U';\r\n\r\n// Keep service worker alive (Manifest V3 requirement)\r\nlet keepAliveInterval;\r\n\r\nfunction keepAlive() {\r\n  if (keepAliveInterval) {\r\n    clearInterval(keepAliveInterval);\r\n  }\r\n\r\n  keepAliveInterval = setInterval(() => {\r\n    if (browserAPI.runtime?.id) {\r\n      console.log('\uD83D\uDD04 Keep-alive ping');\r\n    } else {\r\n      clearInterval(keepAliveInterval);\r\n    }\r\n  }, 20000); // Every 20 seconds\r\n}\r\n\r\n// Start keep-alive immediately\r\nkeepAlive();\r\n\r\n// Listen for messages from content scripts\r\nbrowserAPI.runtime.onMessage.addListener((message, sender, sendResponse) => {\r\n  // Restart keep-alive on every message\r\n  keepAlive();\r\n  console.log('\uD83D\uDD14 Background received message:', message.type || message.action);\r\n\r\n  // Handle action-based messages (from Roll20 content scripts)\r\n  if (message.action === 'getCharacterData') {\r\n    console.log('\uD83D\uDCCB Getting character data for Roll20...');\r\n    handleGetCharacterData(message.characterId)\r\n      .then(result => {\r\n        console.log('\u2705 Character data retrieved:', result);\r\n        sendResponse(result);\r\n      })\r\n      .catch(error => {\r\n        console.error('\u274C Failed to get character data:', error);\r\n        sendResponse({ success: false, error: error.message });\r\n      });\r\n    return true; // Keep channel open for async response\r\n  }\r\n\r\n  // Handle getAllCharacterProfiles for RollCloud adapter compatibility\r\n  if (message.action === 'getAllCharacterProfiles') {\r\n    console.log('\uD83D\uDCCB Getting all character profiles...');\r\n    handleGetAllCharacterProfiles(message.supabaseUserId)\r\n      .then(result => {\r\n        console.log('\u2705 Character profiles retrieved:', result);\r\n        sendResponse(result);\r\n      })\r\n      .catch(error => {\r\n        console.error('\u274C Failed to get character profiles:', error);\r\n        sendResponse({ success: false, error: error.message });\r\n      });\r\n    return true; // Keep channel open for async response\r\n  }\r\n\r\n  // Handle setActiveCharacter for RollCloud adapter compatibility\r\n  if (message.action === 'setActiveCharacter') {\r\n    console.log('\uD83D\uDCCB Setting active character:', message.characterId);\r\n    handleSetActiveCharacter(message.characterId)\r\n      .then(result => {\r\n        console.log('\u2705 Active character set:', result);\r\n        sendResponse(result);\r\n      })\r\n      .catch(error => {\r\n        console.error('\u274C Failed to set active character:', error);\r\n        sendResponse({ success: false, error: error.message });\r\n      });\r\n    return true; // Keep channel open for async response\r\n  }\r\n\r\n  // Handle requestPreparedData from character sheet popup\r\n  if (message.action === 'requestPreparedData') {\r\n    console.log('\uD83D\uDCE4 Character sheet requesting prepared data');\r\n    handleRequestPreparedData()\r\n      .then(result => {\r\n        console.log('\u2705 Prepared data request completed:', result.success ? 'success' : 'failed');\r\n        sendResponse(result);\r\n      })\r\n      .catch(error => {\r\n        console.error('\u274C Failed to handle prepared data request:', error);\r\n        sendResponse({ success: false, error: error.message });\r\n      });\r\n    return true; // Keep channel open for async response\r\n  }\r\n\r\n  // Handle notifyPopupUpdate - notify open popup sheets of updated character data\r\n  if (message.action === 'notifyPopupUpdate') {\r\n    console.log('\uD83D\uDD14 Notifying popup sheets of character data update');\r\n    browserAPI.runtime.sendMessage({\r\n      type: 'UPDATE_CHARACTER_DATA',\r\n      data: message.data\r\n    }).catch(() => {\r\n      console.log('\u2139\uFE0F No popup open to notify');\r\n    });\r\n    sendResponse({ success: true });\r\n    return false;\r\n  }\r\n\r\n  // Handle storeCharacterData - store parsed character data to local storage\r\n  if (message.action === 'storeCharacterData') {\r\n    console.log('\uD83D\uDCBE Storing character data to local storage:', message.data?.name);\r\n    handleStoreCharacterData(message.data, message.slotId)\r\n      .then(result => {\r\n        console.log('\u2705 Character data stored successfully');\r\n        sendResponse(result);\r\n      })\r\n      .catch(error => {\r\n        console.error('\u274C Failed to store character data:', error);\r\n        sendResponse({ success: false, error: error.message });\r\n      });\r\n    return true; // Keep channel open for async response\r\n  }\r\n\r\n  // Handle clearAllCloudData - delete all character data from Supabase\r\n  // Relay messages from popup sheet to Roll20 content script tabs\r\n  // This is the fallback path when window.opener is not available\r\n  if (message.action === 'relayToRoll20') {\r\n    const roll20Patterns = ['*://app.roll20.net/*'];\r\n    browserAPI.tabs.query({ url: roll20Patterns }).then(tabs => {\r\n      if (tabs.length === 0) {\r\n        console.warn('\u26A0\uFE0F No Roll20 tabs found to relay message to');\r\n        sendResponse({ success: false, error: 'No Roll20 tabs found' });\r\n        return;\r\n      }\r\n      for (const tab of tabs) {\r\n        browserAPI.tabs.sendMessage(tab.id, message.data).catch(err => {\r\n          console.warn(`\u26A0\uFE0F Failed to relay to tab ${tab.id}:`, err);\r\n        });\r\n      }\r\n      console.log(`\uD83D\uDCE8 Relayed ${message.data.action} to ${tabs.length} Roll20 tab(s)`);\r\n      sendResponse({ success: true });\r\n    }).catch(err => {\r\n      console.error('\u274C Failed to query Roll20 tabs:', err);\r\n      sendResponse({ success: false, error: err.message });\r\n    });\r\n    return true; // Keep channel open for async response\r\n  }\r\n\r\n  if (message.action === 'clearAllCloudData') {\r\n    console.log('\uD83D\uDDD1\uFE0F Clearing all cloud character data...');\r\n    handleClearAllCloudData()\r\n      .then(result => {\r\n        console.log('\u2705 Cloud data cleared successfully');\r\n        sendResponse(result);\r\n      })\r\n      .catch(error => {\r\n        console.error('\u274C Failed to clear cloud data:', error);\r\n        sendResponse({ success: false, error: error.message });\r\n      });\r\n    return true; // Keep channel open for async response\r\n  }\r\n\r\n  // Handle different message types\r\n  switch (message.type) {\r\n    case 'CHARACTER_UPDATED':\r\n      handleCharacterUpdate(message.data);\r\n      return false; // No async response needed\r\n    case 'SYNC_REQUEST':\r\n      handleSyncRequest(message.data);\r\n      return false; // No async response needed\r\n    case 'SYNC_CHARACTER_TO_CARMACLOUDS':\r\n      console.log('\uD83D\uDD04 Starting SYNC_CHARACTER_TO_CARMACLOUDS handler...');\r\n      // Handle async response properly for Manifest V3\r\n      handleSyncToCarmaClouds(message.data)\r\n        .then(result => {\r\n          console.log('\u2705 Sync completed, sending response:', result);\r\n          sendResponse(result);\r\n        })\r\n        .catch(error => {\r\n          console.error('\u274C Sync failed:', error);\r\n          sendResponse({ success: false, error: error.message });\r\n        });\r\n      return true; // Keep channel open for async response\r\n    default:\r\n      console.warn('Unknown message type:', message.type);\r\n      return false; // No async response for unknown messages\r\n  }\r\n});\r\n\r\n// Handle get character data request\r\nasync function handleGetCharacterData(requestedCharacterId) {\r\n  try {\r\n    const result = await browserAPI.storage.local.get(['carmaclouds_characters', 'activeCharacterId']);\r\n    const characters = result.carmaclouds_characters || [];\r\n    const activeCharacterId = requestedCharacterId || result.activeCharacterId;\r\n\r\n    // Try to find requested/active character\r\n    let activeCharacter = null;\r\n    if (activeCharacterId) {\r\n      // Check if it's a slot-based ID (slot-1, slot-2, etc.)\r\n      if (activeCharacterId.startsWith('slot-')) {\r\n        const slotIndex = parseInt(activeCharacterId.replace('slot-', '')) - 1;\r\n        if (slotIndex >= 0 && slotIndex < characters.length) {\r\n          activeCharacter = characters[slotIndex];\r\n        }\r\n      } else {\r\n        // Find by DiceCloud character ID\r\n        activeCharacter = characters.find(char => char.id === activeCharacterId);\r\n      }\r\n    }\r\n\r\n    // Fall back to first character if no active character found\r\n    if (!activeCharacter && characters.length > 0) {\r\n      activeCharacter = characters[0];\r\n    }\r\n\r\n    if (activeCharacter) {\r\n      // Return the rollcloud parsed format (for sheet-builder)\r\n      // If not yet parsed, return character with raw data\r\n      let characterData = activeCharacter.rollcloud || activeCharacter;\r\n      \r\n      // Ensure the returned data always has the id field from the parent character\r\n      if (activeCharacter.rollcloud && !characterData.id) {\r\n        characterData = {\r\n          ...characterData,\r\n          id: activeCharacter.id\r\n        };\r\n      }\r\n\r\n      console.log('\uD83D\uDCE4 Returning character data:', activeCharacter.name);\r\n      console.log('   Using rollcloud format:', !!activeCharacter.rollcloud);\r\n      console.log('   Character data keys:', Object.keys(characterData).slice(0, 25));\r\n      console.log('   Has hitPoints:', !!characterData.hitPoints, '=', characterData.hitPoints);\r\n      console.log('   Has name:', !!characterData.name, '=', characterData.name);\r\n      console.log('   Has id:', !!characterData.id, '=', characterData.id);\r\n      console.log('   Has spells:', Array.isArray(characterData.spells), characterData.spells?.length);\r\n      console.log('   Has actions:', Array.isArray(characterData.actions), characterData.actions?.length);\r\n\r\n      return {\r\n        success: true,\r\n        data: characterData\r\n      };\r\n    } else {\r\n      console.log('\u274C No character data found in storage');\r\n      console.log('   Characters array length:', characters.length);\r\n      console.log('   Active character ID:', activeCharacterId);\r\n      return {\r\n        success: false,\r\n        error: 'No character data found'\r\n      };\r\n    }\r\n  } catch (error) {\r\n    console.error('Error getting character data:', error);\r\n    return {\r\n      success: false,\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n// Handle store character data - update character in local storage\r\nasync function handleStoreCharacterData(characterData, slotId) {\r\n  try {\r\n    console.log('\uD83D\uDCBE Storing character to slot:', slotId || 'default');\r\n\r\n    // Get current characters array\r\n    const result = await browserAPI.storage.local.get('carmaclouds_characters');\r\n    const characters = result.carmaclouds_characters || [];\r\n\r\n    // Find character by ID - use slotId as fallback if no character ID is set\r\n    const characterId = characterData.id || characterData.dicecloud_character_id || slotId;\r\n    if (!characterId) {\r\n      throw new Error('Character data missing ID and no slotId provided');\r\n    }\r\n\r\n    const existingIndex = characters.findIndex(char => char.id === characterId);\r\n\r\n    if (existingIndex >= 0) {\r\n      // Update existing character - merge with existing to preserve raw data\r\n      console.log('\u2705 Updating existing character:', characterData.name);\r\n      console.log('   Has hitPoints:', !!characterData.hitPoints);\r\n      console.log('   Has spells:', Array.isArray(characterData.spells));\r\n      console.log('   Has actions:', Array.isArray(characterData.actions));\r\n\r\n      // Preserve the original raw DiceCloud data when updating with parsed data\r\n      const existingCharacter = characters[existingIndex];\r\n      characters[existingIndex] = {\r\n        ...characterData,\r\n        id: characterId, // Ensure ID is always set\r\n        raw: existingCharacter.raw || characterData.raw, // Keep raw if it exists\r\n        preview: existingCharacter.preview || characterData.preview // Keep preview if it exists\r\n      };\r\n      console.log('   Preserved raw data:', !!characters[existingIndex].raw);\r\n    } else {\r\n      // Add new character\r\n      console.log('\u2705 Adding new character:', characterData.name);\r\n      characters.push({\r\n        ...characterData,\r\n        id: characterId // Ensure ID is always set\r\n      });\r\n    }\r\n\r\n    // Save back to storage\r\n    await browserAPI.storage.local.set({ carmaclouds_characters: characters });\r\n    console.log('\u2705 Character data stored successfully to carmaclouds_characters');\r\n    console.log('   Total characters in array:', characters.length);\r\n\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error('\u274C Error storing character data:', error);\r\n    return { success: false, error: error.message };\r\n  }\r\n}\r\n\r\n// Handle get all character profiles (RollCloud adapter compatibility)\r\n// Converts carmaclouds storage format to old rollcloud format\r\nasync function handleGetAllCharacterProfiles(supabaseUserId) {\r\n  try {\r\n    const result = await browserAPI.storage.local.get('carmaclouds_characters');\r\n    let characters = result.carmaclouds_characters || [];\r\n\r\n    console.log('\uD83D\uDD0D getAllCharacterProfiles - Total characters in storage:', characters.length);\r\n\r\n    // Also fetch from Supabase if authenticated\r\n    if (supabaseUserId) {\r\n      console.log('\uD83D\uDD0D Fetching characters from Supabase for user:', supabaseUserId);\r\n      try {\r\n        const dbResponse = await fetch(\r\n          `${SUPABASE_URL}/rest/v1/clouds_characters?select=*&supabase_user_id=eq.${supabaseUserId}`,\r\n          {\r\n            headers: {\r\n              'apikey': SUPABASE_ANON_KEY,\r\n              'Content-Type': 'application/json'\r\n            }\r\n          }\r\n        );\r\n\r\n        if (dbResponse.ok) {\r\n          const dbCharacters = await dbResponse.json();\r\n          console.log('   Found', dbCharacters.length, 'characters from Supabase');\r\n\r\n          // Merge database characters with local storage\r\n          dbCharacters.forEach(dbChar => {\r\n            const existingIndex = characters.findIndex(c => c.id === dbChar.dicecloud_character_id);\r\n\r\n            // Parse raw_dicecloud_data if it's a JSON string\r\n            let rawData = dbChar.raw_dicecloud_data || {};\r\n            if (typeof rawData === 'string') {\r\n              try {\r\n                rawData = JSON.parse(rawData);\r\n              } catch (e) {\r\n                console.warn('   Failed to parse raw_dicecloud_data for:', dbChar.character_name);\r\n                rawData = {};\r\n              }\r\n            }\r\n\r\n            // Convert database format to local storage format with VTT-specific fields\r\n            const characterEntry = {\r\n              id: dbChar.dicecloud_character_id,\r\n              name: dbChar.character_name || 'Unknown',\r\n              level: dbChar.level || '?',\r\n              class: dbChar.class || 'No Class',\r\n              race: dbChar.race || 'Unknown',\r\n              raw: rawData,\r\n              lastSynced: dbChar.updated_at || new Date().toISOString(),\r\n              rollcloud: null,  // Parsed on-demand when RollCloud tab is used\r\n              owlcloud: null,   // Parsed on-demand when OwlCloud tab is used\r\n              foundcloud: null  // Parsed on-demand when FoundCloud tab is used\r\n            };\r\n\r\n            if (existingIndex >= 0) {\r\n              characters[existingIndex] = characterEntry;\r\n            } else {\r\n              characters.push(characterEntry);\r\n            }\r\n          });\r\n\r\n          console.log('   Merged: now have', characters.length, 'total characters');\r\n\r\n          // Save merged list back to local storage\r\n          await browserAPI.storage.local.set({ carmaclouds_characters: characters });\r\n          console.log('   \u2705 Saved merged characters to local storage');\r\n        }\r\n      } catch (dbError) {\r\n        console.error('   \u274C Error fetching from Supabase:', dbError);\r\n        // Continue with local storage characters only\r\n      }\r\n    }\r\n\r\n    characters.forEach((char, index) => {\r\n      console.log(`   Character ${index}:`, {\r\n        id: char.id,\r\n        name: char.name,\r\n        class: char.class || char.preview?.class,\r\n        level: char.level || char.preview?.level,\r\n        race: char.race || char.preview?.race,\r\n        hasRaw: !!char.raw\r\n      });\r\n    });\r\n\r\n    // Convert carmaclouds array format to rollcloud object format\r\n    // Old format: { [characterId]: { name, class, level, race, ...raw data } }\r\n    const profiles = {};\r\n\r\n    characters.forEach((char, index) => {\r\n      if (char.id) {\r\n        // Assign to regular slot numbers (slot-1, slot-2, etc.)\r\n        const profileKey = `slot-${index + 1}`;\r\n        profiles[profileKey] = {\r\n          id: char.id,\r\n          name: char.name || 'Unknown',\r\n          character_name: char.name || 'Unknown',\r\n          class: char.class || char.preview?.class || 'Unknown',\r\n          level: char.level || char.preview?.level || 1,\r\n          race: char.race || char.preview?.race || 'Unknown',\r\n          raw: char.raw, // Include raw data for parsing\r\n          preview: char.preview // Pass through preview for adapters\r\n        };\r\n        console.log(`   \u2705 Created ${profileKey}:`, profiles[profileKey].name);\r\n      } else {\r\n        console.log(`   \u26A0\uFE0F Skipped character at index ${index} - no ID`);\r\n      }\r\n    });\r\n\r\n    console.log('\uD83D\uDCCB Returning profiles:', Object.keys(profiles));\r\n    return {\r\n      success: true,\r\n      profiles: profiles\r\n    };\r\n  } catch (error) {\r\n    console.error('Error getting character profiles:', error);\r\n    return {\r\n      success: false,\r\n      error: error.message,\r\n      profiles: {}\r\n    };\r\n  }\r\n}\r\n\r\n// Handle set active character (RollCloud adapter compatibility)\r\nasync function handleSetActiveCharacter(characterId) {\r\n  try {\r\n    // Verify character exists\r\n    const result = await browserAPI.storage.local.get('carmaclouds_characters');\r\n    const characters = result.carmaclouds_characters || [];\r\n    const character = characters.find(char => char.id === characterId);\r\n\r\n    if (!character) {\r\n      return {\r\n        success: false,\r\n        error: 'Character not found'\r\n      };\r\n    }\r\n\r\n    // Set active character ID\r\n    await browserAPI.storage.local.set({ activeCharacterId: characterId });\r\n\r\n    return {\r\n      success: true,\r\n      characterId: characterId\r\n    };\r\n  } catch (error) {\r\n    console.error('Error setting active character:', error);\r\n    return {\r\n      success: false,\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n// Handle request for prepared character data from popup\r\nasync function handleRequestPreparedData() {\r\n  try {\r\n    // Find Roll20 tab\r\n    const tabs = await browserAPI.tabs.query({ url: '*://app.roll20.net/*' });\r\n    \r\n    if (tabs.length === 0) {\r\n      return {\r\n        success: false,\r\n        error: 'No Roll20 tab found. Please open Roll20 first.'\r\n      };\r\n    }\r\n\r\n    // Request prepared data from Roll20 content script\r\n    const response = await browserAPI.tabs.sendMessage(tabs[0].id, {\r\n      type: 'REQUEST_PREPARED_DATA'\r\n    });\r\n\r\n    if (response && response.success) {\r\n      return {\r\n        success: true,\r\n        data: response.data,\r\n        timestamp: response.timestamp,\r\n        age: response.age\r\n      };\r\n    } else {\r\n      return {\r\n        success: false,\r\n        error: response?.error || 'No prepared character data available. Please use \"Push to Roll20\" first.'\r\n      };\r\n    }\r\n  } catch (error) {\r\n    console.error('Error requesting prepared data:', error);\r\n    return {\r\n      success: false,\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n// Helper functions to extract character info from DiceCloud raw data\r\nfunction extractClass(rawData) {\r\n  if (!rawData || !rawData.variables || !Array.isArray(rawData.variables)) return 'Unknown';\r\n  for (const variable of rawData.variables) {\r\n    if (variable.variableName === 'class') {\r\n      return variable.value || 'Unknown';\r\n    }\r\n  }\r\n  return 'Unknown';\r\n}\r\n\r\nfunction extractLevel(rawData) {\r\n  if (!rawData || !rawData.variables || !Array.isArray(rawData.variables)) return 1;\r\n  for (const variable of rawData.variables) {\r\n    if (variable.variableName === 'level') {\r\n      return variable.value || 1;\r\n    }\r\n  }\r\n  return 1;\r\n}\r\n\r\nfunction extractRace(rawData) {\r\n  if (!rawData || !rawData.variables || !Array.isArray(rawData.variables)) return 'Unknown';\r\n  for (const variable of rawData.variables) {\r\n    if (variable.variableName === 'race') {\r\n      return variable.value || 'Unknown';\r\n    }\r\n  }\r\n  return 'Unknown';\r\n}\r\n\r\n// Handle character updates\r\nasync function handleCharacterUpdate(data) {\r\n  console.log('Character updated:', data);\r\n  // TODO: Sync to Supabase\r\n}\r\n\r\n// Handle sync requests\r\nasync function handleSyncRequest(data) {\r\n  console.log('Sync requested:', data);\r\n  // TODO: Fetch from Supabase\r\n}\r\n\r\n// Handle sync to CarmaClouds from DiceCloud\r\nasync function handleSyncToCarmaClouds(characterData) {\r\n  try {\r\n    console.log('\uD83D\uDCBE Step 1: Starting sync for character:', characterData.name);\r\n\r\n    // Store character data in browserAPI.storage.local\r\n    const storageKey = `carmaclouds_character_${characterData.name || 'unknown'}`;\r\n    console.log('\uD83D\uDCBE Step 2: Saving individual character with key:', storageKey);\r\n\r\n    await browserAPI.storage.local.set({\r\n      [storageKey]: {\r\n        ...characterData,\r\n        syncedAt: new Date().toISOString(),\r\n        platforms: ['dicecloud'] // Mark as available from DiceCloud\r\n      }\r\n    });\r\n    console.log('\u2705 Step 2: Individual character saved');\r\n\r\n    // Also update the characters list\r\n    console.log('\uD83D\uDCBE Step 3: Getting characters list...');\r\n    const result = await browserAPI.storage.local.get('carmaclouds_characters');\r\n    const characters = result.carmaclouds_characters || [];\r\n    console.log('\u2705 Step 3: Found', characters.length, 'existing characters');\r\n\r\n    // Add or update character in the list\r\n    console.log('\uD83D\uDCBE Step 4: Updating characters list...');\r\n    const existingIndex = characters.findIndex(c => c.id === characterData.id);\r\n    if (existingIndex >= 0) {\r\n      console.log('\uD83D\uDCDD Updating existing character at index', existingIndex);\r\n      characters[existingIndex] = {\r\n        ...characters[existingIndex],\r\n        ...characterData,\r\n        syncedAt: new Date().toISOString(),\r\n        platforms: [...(characters[existingIndex].platforms || []), 'dicecloud']\r\n      };\r\n    } else {\r\n      console.log('\u2795 Adding new character to list');\r\n      characters.push({\r\n        ...characterData,\r\n        syncedAt: new Date().toISOString(),\r\n        platforms: ['dicecloud']\r\n      });\r\n    }\r\n\r\n    console.log('\uD83D\uDCBE Step 5: Saving updated characters list...');\r\n    await browserAPI.storage.local.set({ carmaclouds_characters: characters });\r\n    console.log('\u2705 Step 5: Characters list saved');\r\n\r\n    // Set the synced character as active (always update to the most recently synced)\r\n    if (characterData.id) {\r\n      console.log('\uD83D\uDCBE Step 6: Setting as active character:', characterData.id);\r\n      await browserAPI.storage.local.set({ activeCharacterId: characterData.id });\r\n      console.log('\u2705 Step 6: Active character ID set');\r\n    }\r\n\r\n    console.log('\uD83C\uDF89 Character successfully synced to CarmaClouds storage');\r\n\r\n    // Sync to Supabase database\r\n    try {\r\n      console.log('\uD83D\uDCBE Step 7: Syncing to Supabase database...');\r\n\r\n      // Get auth info to include user_id_dicecloud and username\r\n      const authResult = await browserAPI.storage.local.get(['diceCloudUserId', 'username']);\r\n\r\n      // Prepare character data for Supabase - only raw data at sync time\r\n      // VTT-specific parsed data (roll20_data, owlbear_data, foundry_data) is added when pushing to VTT\r\n      const payload = {\r\n        user_id_dicecloud: authResult.diceCloudUserId || null,\r\n        dicecloud_character_id: characterData.id,\r\n        character_name: characterData.name || 'Unknown',\r\n        raw_dicecloud_data: characterData.raw || characterData, // Store the DiceCloud API structure { creature, variables, properties }\r\n        platform: ['dicecloud', 'foundcloud', 'rollcloud', 'owlcloud'], // Mark as available on all platforms\r\n        supabase_user_id: null, // Auth-based sync happens through FoundCloud tab\r\n        updated_at: new Date().toISOString()\r\n      };\r\n\r\n      console.log('\uD83D\uDCE4 Sending character to Supabase:', payload.character_name);\r\n\r\n      // Check if character already exists\r\n      const checkResponse = await fetch(\r\n        `${SUPABASE_URL}/rest/v1/clouds_characters?dicecloud_character_id=eq.${characterData.id}`,\r\n        {\r\n          method: 'GET',\r\n          headers: {\r\n            'apikey': SUPABASE_ANON_KEY,\r\n            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\r\n          }\r\n        }\r\n      );\r\n\r\n      let response;\r\n      if (checkResponse.ok) {\r\n        const existing = await checkResponse.json();\r\n        \r\n        if (existing && existing.length > 0) {\r\n          // Character exists - update it\r\n          console.log('\uD83D\uDCDD Updating existing character in Supabase...');\r\n          response = await fetch(\r\n            `${SUPABASE_URL}/rest/v1/clouds_characters?dicecloud_character_id=eq.${characterData.id}`,\r\n            {\r\n              method: 'PATCH',\r\n              headers: {\r\n                'apikey': SUPABASE_ANON_KEY,\r\n                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\r\n                'Content-Type': 'application/json',\r\n                'Prefer': 'return=representation'\r\n              },\r\n              body: JSON.stringify(payload)\r\n            }\r\n          );\r\n        } else {\r\n          // Character doesn't exist - insert it\r\n          console.log('\u2795 Inserting new character to Supabase...');\r\n          response = await fetch(\r\n            `${SUPABASE_URL}/rest/v1/clouds_characters`,\r\n            {\r\n              method: 'POST',\r\n              headers: {\r\n                'apikey': SUPABASE_ANON_KEY,\r\n                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\r\n                'Content-Type': 'application/json',\r\n                'Prefer': 'return=representation'\r\n              },\r\n              body: JSON.stringify(payload)\r\n            }\r\n          );\r\n        }\r\n\r\n        if (response.ok) {\r\n          const result = await response.json();\r\n          console.log('\u2705 Step 7: Character synced to Supabase:', result);\r\n        } else {\r\n          const errorText = await response.text();\r\n          console.error('\u274C Supabase sync failed:', response.status, errorText);\r\n        }\r\n      } else {\r\n        console.error('\u274C Failed to check if character exists:', checkResponse.status);\r\n      }\r\n    } catch (supabaseError) {\r\n      console.error('\u274C Failed to sync to Supabase (non-fatal):', supabaseError);\r\n      // Don't fail the entire sync if Supabase fails\r\n    }\r\n\r\n    // Send message to popup to notify about the sync\r\n    try {\r\n      const tabs = await browserAPI.tabs.query({ active: true, currentWindow: true });\r\n      if (tabs.length > 0) {\r\n        await browserAPI.tabs.sendMessage(tabs[0].id, {\r\n          action: 'dataSynced',\r\n          characterName: characterData.name\r\n        });\r\n        console.log('\uD83D\uDCE4 Sent dataSynced message to popup');\r\n      }\r\n    } catch (tabError) {\r\n      console.log('\u26A0\uFE0F Could not send sync notification to popup:', tabError);\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      message: 'Character synced successfully',\r\n      characterCount: characters.length\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error('\u274C Error syncing character to CarmaClouds:', error);\r\n    return {\r\n      success: false,\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Clear all character data from Supabase cloud storage\r\n */\r\nasync function handleClearAllCloudData() {\r\n  try {\r\n    // Get the user's DiceCloud user ID\r\n    const result = await browserAPI.storage.local.get(['diceCloudUserId']);\r\n    const userId = result.diceCloudUserId;\r\n    \r\n    if (!userId) {\r\n      throw new Error('No DiceCloud user ID found. Please log in first.');\r\n    }\r\n    \r\n    console.log('\uD83D\uDDD1\uFE0F Deleting all characters for user:', userId);\r\n    \r\n    // Delete all characters for this user from Supabase\r\n    const response = await fetch(`${SUPABASE_URL}/rest/v1/clouds_characters?user_id_dicecloud=eq.${userId}`, {\r\n      method: 'DELETE',\r\n      headers: {\r\n        'apikey': SUPABASE_ANON_KEY,\r\n        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\r\n        'Content-Type': 'application/json',\r\n        'Prefer': 'return=representation'\r\n      }\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      throw new Error(`Failed to delete cloud data: ${response.status} - ${errorText}`);\r\n    }\r\n    \r\n    const deletedChars = await response.json();\r\n    const count = Array.isArray(deletedChars) ? deletedChars.length : 0;\r\n    \r\n    console.log(`\u2705 Deleted ${count} characters from cloud`);\r\n    \r\n    return {\r\n      success: true,\r\n      message: `Deleted ${count} character(s) from cloud storage.`\r\n    };\r\n  } catch (error) {\r\n    console.error('\u274C Error clearing cloud data:', error);\r\n    return {\r\n      success: false,\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n// Export functions for testing\r\nif (typeof module !== 'undefined' && module.exports) {\r\n  module.exports = {\r\n    handleGetCharacterData,\r\n    handleStoreCharacterData,\r\n    handleClearAllCloudData\r\n  };\r\n}\r\n\r\n// Handle extension installation\r\nbrowserAPI.runtime.onInstalled.addListener((details) => {\r\n  console.log('CarmaClouds extension installed/updated:', details.reason);\r\n  \r\n  if (details.reason === 'install') {\r\n    console.log('CarmaClouds: First time installation');\r\n  } else if (details.reason === 'update') {\r\n    console.log('CarmaClouds: Extension updated');\r\n  }\r\n});\r\n"],
  "mappings": "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",
  "names": ["result"]
}
