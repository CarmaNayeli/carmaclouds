{
  "version": 3,
  "sources": ["../../../src/content/roll20.js"],
  "sourcesContent": ["/**\r\n * Roll20 Content Script\r\n * Handles roll announcements and character sheet overlay\r\n */\r\n\r\n(function() {\r\n  'use strict';\r\n\r\n  debug.log('RollCloud: Roll20 content script loaded');\r\n\r\n  /**\r\n   * Posts a message to Roll20 chat\r\n   * Uses Firefox-compatible event handling to avoid CSP/security issues\r\n   */\r\n  function postChatMessage(message) {\r\n    try {\r\n      // Find the chat input textarea\r\n      const chatInput = document.querySelector('#textchat-input textarea');\r\n      if (!chatInput) {\r\n        debug.error('\u274C Could not find Roll20 chat input textarea (#textchat-input textarea)');\r\n        return false;\r\n      }\r\n\r\n      debug.log('\uD83D\uDCDD Setting chat input value:', message.substring(0, 80) + (message.length > 80 ? '...' : ''));\r\n      chatInput.focus();\r\n\r\n      // Use native property descriptor to set value (more compatible with frameworks)\r\n      const nativeInputValueSetter = Object.getOwnPropertyDescriptor(\r\n        window.HTMLTextAreaElement.prototype,\r\n        'value'\r\n      ).set;\r\n      nativeInputValueSetter.call(chatInput, message);\r\n\r\n      // Firefox-compatible event dispatch using cloneInto if available\r\n      // This properly transfers event options to the page's context\r\n      try {\r\n        if (typeof cloneInto === 'function') {\r\n          // Firefox: Use cloneInto to create events in page context\r\n          const eventInit = cloneInto({ bubbles: true, cancelable: true }, window);\r\n          chatInput.dispatchEvent(new window.wrappedJSObject.Event('input', eventInit));\r\n          chatInput.dispatchEvent(new window.wrappedJSObject.Event('change', eventInit));\r\n        } else {\r\n          // Chrome/other browsers: Standard event dispatch\r\n          chatInput.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));\r\n          chatInput.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));\r\n        }\r\n      } catch (eventError) {\r\n        // If event dispatch fails entirely, log but continue - button click should still work\r\n        debug.warn('\u26A0\uFE0F Event dispatch encountered an error (non-fatal):', eventError.message);\r\n      }\r\n\r\n      // Find and click the send button\r\n      const sendButton = document.querySelector('#textchat-input .btn');\r\n      if (!sendButton) {\r\n        debug.error('\u274C Could not find Roll20 chat send button (#textchat-input .btn)');\r\n        return false;\r\n      }\r\n\r\n      sendButton.click();\r\n      debug.log('\u2705 Message posted to Roll20 chat');\r\n      return true;\r\n    } catch (error) {\r\n      debug.error('\u274C Error posting to Roll20 chat:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles roll messages from Dice Cloud\r\n   * Wrapped in try-catch to ensure one failure doesn't break subsequent rolls\r\n   */\r\n  function handleDiceCloudRoll(rollData) {\r\n    try {\r\n      debug.log('\uD83C\uDFB2 Handling roll:', rollData);\r\n      debug.log('\uD83C\uDFB2 Roll data keys:', Object.keys(rollData || {}));\r\n      if (rollData && rollData.source === 'discord') {\r\n        debug.log('\uD83D\uDCE1 Roll originated from Discord command');\r\n      }\r\n\r\n      // Validate rollData exists\r\n      if (!rollData) {\r\n        debug.error('\u274C No roll data provided');\r\n        return { success: false, error: 'No roll data provided' };\r\n      }\r\n\r\n      // Use pre-formatted message if it exists (for spells, actions, etc.)\r\n      // Otherwise format the roll data\r\n      let formattedMessage;\r\n      try {\r\n        formattedMessage = rollData.message || formatRollForRoll20(rollData);\r\n      } catch (formatError) {\r\n        debug.error('\u274C Error formatting roll:', formatError);\r\n        formattedMessage = `&{template:default} {{name=${rollData.name || 'Roll'}}} {{Roll=[[${rollData.formula || '1d20'}]]}}`;\r\n      }\r\n      debug.log('\uD83C\uDFB2 Formatted message:', formattedMessage);\r\n\r\n      const success = postChatMessage(formattedMessage);\r\n\r\n      if (success) {\r\n        debug.log('\u2705 Roll successfully posted to Roll20');\r\n\r\n        // Wait for Roll20 to process the roll and add it to chat\r\n        // Then parse the actual Roll20 result (not DiceCloud's roll)\r\n        try {\r\n          observeNextRollResult(rollData);\r\n        } catch (observeError) {\r\n          // Non-fatal - roll was posted, just couldn't observe result\r\n          debug.warn('\u26A0\uFE0F Could not set up roll observer:', observeError.message);\r\n        }\r\n        return { success: true };\r\n      } else {\r\n        debug.error('\u274C Failed to post roll to Roll20 - chat input or send button not found');\r\n        return { success: false, error: 'Roll20 chat not ready. Make sure you are in a Roll20 game.' };\r\n      }\r\n    } catch (error) {\r\n      debug.error('\u274C Unexpected error in handleDiceCloudRoll:', error);\r\n      return { success: false, error: 'Unexpected error: ' + error.message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Observes Roll20 chat for the next roll result and checks for natural 1s/20s\r\n   */\r\n  function observeNextRollResult(originalRollData) {\r\n    debug.log('\uD83D\uDC40 Setting up observer for Roll20 roll result...');\r\n\r\n    const chatLog = document.querySelector('#textchat .content');\r\n    if (!chatLog) {\r\n      debug.error('\u274C Could not find Roll20 chat log');\r\n      return;\r\n    }\r\n\r\n    // Create observer to watch for new messages\r\n    const observer = new MutationObserver((mutations) => {\r\n      for (const mutation of mutations) {\r\n        for (const node of mutation.addedNodes) {\r\n          if (node.nodeType === Node.ELEMENT_NODE) {\r\n            // Check if this is a message with an inline roll\r\n            const inlineRoll = node.querySelector('.inlinerollresult');\r\n            if (inlineRoll) {\r\n              debug.log('\uD83C\uDFB2 Found new Roll20 inline roll:', inlineRoll);\r\n\r\n              // Parse the roll result from Roll20's display\r\n              const rollResult = parseRoll20InlineRoll(inlineRoll, originalRollData);\r\n\r\n              if (rollResult) {\r\n                debug.log('\uD83C\uDFB2 Parsed Roll20 roll result:', rollResult);\r\n\r\n                // Check for natural 1s or 20s\r\n                if (rollResult.baseRoll === 1 || rollResult.baseRoll === 20) {\r\n                  const rollType = rollResult.baseRoll === 1 ? 'Natural 1' : 'Natural 20';\r\n                  debug.log(`\uD83C\uDFAF ${rollType} detected in Roll20 roll!`);\r\n\r\n                  // Send to popup for racial trait checking\r\n                  browserAPI.runtime.sendMessage({\r\n                    action: 'rollResult',\r\n                    rollResult: rollResult.total.toString(),\r\n                    baseRoll: rollResult.baseRoll.toString(),\r\n                    rollType: originalRollData.formula,\r\n                    rollName: originalRollData.name,\r\n                    checkRacialTraits: true\r\n                  });\r\n\r\n                  debug.log(`\uD83E\uDDEC Sent ${rollType} result to popup`);\r\n                }\r\n              }\r\n\r\n              // Disconnect after processing first roll\r\n              observer.disconnect();\r\n              break;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    // Start observing\r\n    observer.observe(chatLog, { childList: true, subtree: true });\r\n    debug.log('\u2705 Observer set up for Roll20 chat');\r\n\r\n    // Auto-disconnect after 5 seconds to prevent memory leaks\r\n    setTimeout(() => {\r\n      observer.disconnect();\r\n      debug.log('\u23F1\uFE0F Roll observer timed out and disconnected');\r\n    }, 5000);\r\n  }\r\n\r\n  /**\r\n   * Parses Roll20's inline roll result to extract the base d20 roll\r\n   */\r\n  function parseRoll20InlineRoll(inlineRollElement, originalRollData) {\r\n    try {\r\n      // Roll20 inline rolls have a title attribute with the full roll breakdown\r\n      // e.g., \"Rolling 1d20+5 = (<span class=\"basicdiceroll\">17</span>)+5\"\r\n      const title = inlineRollElement.getAttribute('title') || '';\r\n      debug.log('\uD83D\uDCCA Roll20 inline roll title:', title);\r\n\r\n      // Strip HTML tags from the title to get plain text\r\n      const plainTitle = title.replace(/<[^>]*>/g, '');\r\n      debug.log('\uD83D\uDCCA Plain title:', plainTitle);\r\n\r\n      // Extract the base roll from parentheses in the title\r\n      // Format after stripping HTML: \"Rolling 1d20+5 = (17)+5\" or \"Rolling 1d20 = (1)\"\r\n      const baseRollMatch = plainTitle.match(/=\\s*\\(\\s*(\\d+)\\s*\\)/);\r\n      const baseRoll = baseRollMatch ? parseInt(baseRollMatch[1]) : null;\r\n\r\n      // Get the total from the visible text\r\n      const totalText = inlineRollElement.textContent?.trim() || '';\r\n      const total = parseInt(totalText);\r\n\r\n      debug.log(`\uD83D\uDCCA Extracted: baseRoll=${baseRoll}, total=${total}`);\r\n\r\n      // Only return if we successfully extracted a d20 roll (1-20)\r\n      if (baseRoll && baseRoll >= 1 && baseRoll <= 20) {\r\n        return {\r\n          baseRoll: baseRoll,\r\n          total: total,\r\n          formula: originalRollData.formula,\r\n          name: originalRollData.name\r\n        };\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      debug.error('\u274C Error parsing Roll20 inline roll:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calculates the base d20 roll from formula and final result\r\n   */\r\n  function calculateBaseRoll(formula, result) {\r\n    try {\r\n      debug.log(`\uD83E\uDDEE Calculating base roll - Formula: \"${formula}\", Result: \"${result}\"`);\r\n      \r\n      // Parse the formula to extract the modifier\r\n      // Formula format: \"1d20+X\" or \"1d20-X\"\r\n      const modifierMatch = formula.match(/1d20([+-]\\d+)/i);\r\n      \r\n      if (modifierMatch) {\r\n        const modifier = parseInt(modifierMatch[1]);\r\n        const totalResult = parseInt(result);\r\n        const baseRoll = totalResult - modifier;\r\n        \r\n        debug.log(`\uD83E\uDDEE Calculation: ${totalResult} - (${modifier}) = ${baseRoll}`);\r\n        \r\n        // Ensure the base roll is within valid d20 range (1-20)\r\n        if (baseRoll >= 1 && baseRoll <= 20) {\r\n          return baseRoll;\r\n        } else {\r\n          debug.warn(`\u26A0\uFE0F Calculated base roll ${baseRoll} is outside valid d20 range (1-20)`);\r\n          return baseRoll; // Still return it, but log warning\r\n        }\r\n      } else {\r\n        // No modifier found, assume the result is the base roll\r\n        debug.log(`\uD83E\uDDEE No modifier found in formula, using result as base roll: ${result}`);\r\n        return parseInt(result);\r\n      }\r\n    } catch (error) {\r\n      debug.error('\u274C Error calculating base roll:', error);\r\n      return parseInt(result); // Fallback to using the result directly\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Checks Roll20's inline roll elements for natural 1s\r\n   */\r\n  function checkRoll20InlineRolls(characterName) {\r\n    debug.log('\uD83D\uDD0D Checking Roll20 inline rolls for natural 1s for:', characterName);\r\n    \r\n    // Find all inline roll elements\r\n    const inlineRolls = document.querySelectorAll('.inlinerollresult, .rollresult');\r\n    debug.log(`\uD83D\uDD0D Found ${inlineRolls.length} inline roll elements`);\r\n    \r\n    inlineRolls.forEach((rollElement, index) => {\r\n      try {\r\n        // Get the roll data from Roll20's inline roll system\r\n        const rollData = getRoll20RollData(rollElement);\r\n        debug.log(`\uD83D\uDD0D Checking inline roll ${index + 1}:`, rollData);\r\n        \r\n        if (rollData && rollData.baseRoll === 1 && rollData.name.includes(characterName)) {\r\n          debug.log('\uD83C\uDF40 Natural 1 detected in Roll20 inline roll!');\r\n          debug.log('\uD83C\uDF40 Roll data:', rollData);\r\n          \r\n          // Send message to popup for Halfling Luck\r\n          browserAPI.runtime.sendMessage({\r\n            action: 'rollResult',\r\n            rollResult: rollData.total.toString(),\r\n            baseRoll: rollData.baseRoll.toString(),\r\n            rollType: rollData.formula,\r\n            rollName: rollData.name,\r\n            checkRacialTraits: true\r\n          });\r\n          \r\n          debug.log('\uD83E\uDDEC Sent natural 1 result to popup for Halfling Luck');\r\n        }\r\n      } catch (error) {\r\n        debug.warn('\u26A0\uFE0F Error checking inline roll:', error);\r\n      }\r\n    });\r\n    \r\n    debug.log('\uD83D\uDD0D Finished checking inline rolls');\r\n  }\r\n\r\n  /**\r\n   * Extracts roll data from Roll20's inline roll elements\r\n   */\r\n  function getRoll20RollData(rollElement) {\r\n    try {\r\n      // Roll20 stores roll data in the element's dataset or in a script tag\r\n      const rollName = rollElement.closest('.message')?.querySelector('.message-name')?.textContent || \r\n                     rollElement.closest('.message')?.textContent?.split('\\n')[0]?.trim() || '';\r\n      \r\n      // Try to get the roll formula from the inline roll\r\n      const formulaElement = rollElement.querySelector('.formula') || rollElement;\r\n      const formula = formulaElement.textContent?.trim() || '';\r\n      \r\n      // Look for the base roll value in the roll details\r\n      const rollDetails = rollElement.textContent || rollElement.innerText || '';\r\n      const baseRollMatch = rollDetails.match(/^(\\d+)/);\r\n      const baseRoll = baseRollMatch ? parseInt(baseRollMatch[1]) : null;\r\n      \r\n      // Look for the total result\r\n      const totalMatch = rollDetails.match(/(\\d+)\\s*$/);\r\n      const total = totalMatch ? parseInt(totalMatch[1]) : baseRoll;\r\n      \r\n      debug.log(`\uD83D\uDD0D Extracted roll data - Name: ${rollName}, Formula: ${formula}, Base: ${baseRoll}, Total: ${total}`);\r\n      \r\n      return {\r\n        name: rollName,\r\n        formula: formula,\r\n        baseRoll: baseRoll,\r\n        total: total\r\n      };\r\n    } catch (error) {\r\n      debug.warn('\u26A0\uFE0F Error extracting roll data:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if a character belongs to this tab's user\r\n   * Used to filter Discord commands to prevent cross-user contamination\r\n   */\r\n  function isOurCharacter(characterName) {\r\n    if (!characterName) return false;\r\n\r\n    // Check if character is in our registered popups\r\n    if (characterPopups && characterPopups[characterName]) {\r\n      return true;\r\n    }\r\n\r\n    // Check if character is in our player data (GM panel)\r\n    if (playerData && playerData[characterName]) {\r\n      return true;\r\n    }\r\n\r\n    // If we have no characters registered yet, allow it through\r\n    // (first-time setup or user hasn't opened sheets yet)\r\n    const hasAnyCharacters = (characterPopups && Object.keys(characterPopups).length > 0) ||\r\n                           (playerData && Object.keys(playerData).length > 0);\r\n\r\n    if (!hasAnyCharacters) {\r\n      debug.log(`\u2705 Allowing ${characterName} (no characters registered yet)`);\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Get color emoji for character notification color (matches popup-sheet getColoredBanner)\r\n   */\r\n  function getColorEmoji(color) {\r\n    const colorEmojiMap = {\r\n      '#3498db': '\uD83D\uDD35', // Blue\r\n      '#e74c3c': '\uD83D\uDD34', // Red\r\n      '#c2185b': '\uD83D\uDFE2', // Green\r\n      '#9b59b6': '\uD83D\uDFE3', // Purple\r\n      '#e67e22': '\uD83D\uDFE0', // Orange\r\n      '#f1c40f': '\uD83D\uDFE1', // Yellow\r\n      '#95a5a6': '\u26AA', // Grey\r\n      '#34495e': '\u26AB', // Black\r\n      '#8b4513': '\uD83D\uDFE4'  // Brown\r\n    };\r\n    return colorEmojiMap[color] || '\uD83D\uDD35';\r\n  }\r\n\r\n  /**\r\n   * Formats roll data for Roll20 chat display with fancy template\r\n   */\r\n  function formatRollForRoll20(rollData) {\r\n    const { name, formula, characterName, advantage, disadvantage, checkType, prerolledResult, color } = rollData;\r\n\r\n    // Handle advantage/disadvantage for d20 rolls\r\n    let rollFormula = formula;\r\n    let rollType = '';\r\n\r\n    if ((advantage || disadvantage) && formula.includes('d20')) {\r\n      if (advantage && !disadvantage) {\r\n        rollFormula = formula.replace('1d20', '2d20kh1'); // 2d20 keep highest\r\n        rollType = ' (Advantage)';\r\n      } else if (disadvantage && !advantage) {\r\n        rollFormula = formula.replace('1d20', '2d20kl1'); // 2d20 keep lowest\r\n        rollType = ' (Disadvantage)';\r\n      }\r\n    }\r\n\r\n    // Get color emoji for character\r\n    const colorEmoji = color ? getColorEmoji(color) : '';\r\n    const colorPrefix = colorEmoji ? `${colorEmoji} ` : '';\r\n\r\n    // Build character display name\r\n    let displayName = name;\r\n    if (characterName && !name.includes(characterName)) {\r\n      displayName = `${colorPrefix}${characterName} - ${name}`;\r\n    } else {\r\n      displayName = `${colorPrefix}${name}`;\r\n    }\r\n\r\n    // If we have a prerolled result (e.g., from death saves), use it instead of rolling again\r\n    if (prerolledResult !== null && prerolledResult !== undefined) {\r\n      debug.log(`\uD83C\uDFB2 Using prerolled result: ${prerolledResult} instead of rolling ${rollFormula}`);\r\n      return `&{template:default} {{name=${displayName}${rollType}}} {{Roll=${prerolledResult}}}`;\r\n    }\r\n\r\n    // Use Roll20's template system with inline rolls for fancy formatting\r\n    // [[formula]] creates an inline roll that Roll20 will calculate\r\n    return `&{template:default} {{name=${displayName}${rollType}}} {{Roll=[[${rollFormula}]]}}`;\r\n  }\r\n\r\n  /**\r\n   * Normalizes popup/character sheet spell data into a common format for posting to Roll20\r\n   * @param {Object} eventData - Raw spell data from popup sheet postMessage event\r\n   * @returns {Object} Normalized spell data\r\n   */\r\n  function normalizePopupSpellData(eventData) {\r\n    const spell = eventData.spellData || {};\r\n    // Extract numeric level from \"pact:X\" format if needed\r\n    let castLevel = eventData.castLevel || parseInt(spell.level) || 0;\r\n    if (typeof castLevel === 'string' && castLevel.startsWith('pact:')) {\r\n      castLevel = parseInt(castLevel.split(':')[1]) || 0;\r\n    } else {\r\n      castLevel = parseInt(castLevel) || 0;\r\n    }\r\n    const spellLevel = parseInt(spell.level) || 0;\r\n    const characterName = eventData.characterName || 'Character';\r\n    const notificationColor = eventData.color || eventData.notificationColor || '#3498db';\r\n\r\n    return {\r\n      // Basic spell info\r\n      name: spell.name || eventData.spellName || 'Unknown Spell',\r\n      characterName: characterName,\r\n      level: spellLevel,\r\n      castLevel: castLevel,\r\n      school: spell.school,\r\n\r\n      // Spell details\r\n      castingTime: spell.castingTime,\r\n      range: spell.range,\r\n      duration: spell.duration,\r\n      components: spell.components,\r\n      source: spell.source,\r\n      summary: spell.summary,\r\n      description: spell.description,\r\n\r\n      // Tags and modifiers\r\n      concentration: spell.concentration,\r\n      ritual: spell.ritual,\r\n      isCantrip: spellLevel === 0,\r\n      isFreecast: false,\r\n      isUpcast: castLevel > spellLevel,\r\n\r\n      // Metamagic and effects (popup doesn't send these yet, but prepared for future)\r\n      metamagicUsed: eventData.metamagicUsed || [],\r\n      effects: eventData.effects || [],\r\n\r\n      // Resource usage (popup doesn't send these yet, but prepared for future)\r\n      slotUsed: eventData.slotUsed,\r\n      resourceChanges: eventData.resourceChanges || [],\r\n\r\n      // Rolls (popup sends these separately via roll() function, but prepared for future)\r\n      attackRoll: spell.attackRoll,\r\n      damageRolls: spell.damageRolls || [],\r\n      fallbackDamage: spell.damage,\r\n      fallbackDamageType: spell.damageType,\r\n\r\n      // Visual\r\n      notificationColor: notificationColor\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Normalizes Discord spell data into a common format for posting to Roll20\r\n   * @param {Object} spellData - Raw spell data from Discord command\r\n   * @returns {Object} Normalized spell data\r\n   */\r\n  function normalizeDiscordSpellData(spellData) {\r\n    const spell = spellData.spell_data || spellData.spell || {};\r\n    const castLevel = parseInt(spellData.cast_level) || parseInt(spell.level) || 0;\r\n    const spellLevel = parseInt(spell.level) || 0;\r\n\r\n    return {\r\n      // Basic spell info\r\n      name: spell.name || 'Unknown Spell',\r\n      characterName: spellData.character_name || 'Character',\r\n      level: spellLevel,\r\n      castLevel: castLevel,\r\n      school: spell.school,\r\n\r\n      // Spell details\r\n      castingTime: spell.castingTime || spell.casting_time,\r\n      range: spell.range,\r\n      duration: spell.duration,\r\n      components: spell.components,\r\n      source: spell.source,\r\n      summary: spell.summary || spellData.summary,\r\n      description: spell.description || spellData.description,\r\n\r\n      // Tags and modifiers\r\n      concentration: spell.concentration,\r\n      ritual: spell.ritual,\r\n      isCantrip: spellData.isCantrip || spellLevel === 0,\r\n      isFreecast: spellData.isFreecast || false,\r\n      isUpcast: spellData.isUpcast || castLevel > spellLevel,\r\n\r\n      // Metamagic and effects\r\n      metamagicUsed: spellData.metamagicUsed || [],\r\n      effects: spellData.effects || [],\r\n\r\n      // Resource usage\r\n      slotUsed: spellData.slotUsed,\r\n      resourceChanges: spellData.resourceChanges || [],\r\n\r\n      // Rolls\r\n      attackRoll: spell.attackRoll || spell.attack_roll,\r\n      damageRolls: spellData.damageRolls || spellData.damage_rolls || [],\r\n      fallbackDamage: spell.damage,\r\n      fallbackDamageType: spell.damageType || spell.damage_type,\r\n\r\n      // Visual - check multiple possible field names\r\n      notificationColor: spellData.notification_color || spellData.notificationColor ||\r\n                        spell.notification_color || spell.notificationColor || '#3498db'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Posts a spell to Roll20 chat with full formatting\r\n   * Unified function that works regardless of source (Discord, character sheet, etc.)\r\n   * @param {Object} normalizedSpellData - Normalized spell data from normalizeDiscordSpellData() or similar\r\n   */\r\n  function postSpellToRoll20(normalizedSpellData) {\r\n    const {\r\n      name,\r\n      characterName,\r\n      level,\r\n      castLevel,\r\n      school,\r\n      castingTime,\r\n      range,\r\n      duration,\r\n      components,\r\n      source,\r\n      summary,\r\n      description,\r\n      concentration,\r\n      ritual,\r\n      isCantrip,\r\n      isFreecast,\r\n      isUpcast,\r\n      metamagicUsed,\r\n      effects,\r\n      slotUsed,\r\n      resourceChanges,\r\n      attackRoll,\r\n      damageRolls,\r\n      fallbackDamage,\r\n      fallbackDamageType,\r\n      notificationColor\r\n    } = normalizedSpellData;\r\n\r\n    // Get color emoji banner\r\n    const colorEmoji = getColorEmoji(notificationColor);\r\n\r\n    // Build tags string\r\n    let tags = '';\r\n    if (concentration) tags += ' \uD83E\uDDE0 Concentration';\r\n    if (ritual) tags += ' \uD83D\uDCD6 Ritual';\r\n    if (metamagicUsed && metamagicUsed.length > 0) {\r\n      const metamagicNames = metamagicUsed.map(m => m.name).join(', ');\r\n      tags += ` \u2728 ${metamagicNames}`;\r\n    }\r\n    if (isCantrip) tags += ' \uD83C\uDFAF Cantrip';\r\n    if (isFreecast) tags += ' \uD83C\uDD93 Free Cast';\r\n    if (isUpcast) tags += ` \u2B06\uFE0F Upcast to Level ${castLevel}`;\r\n\r\n    // Build announcement message\r\n    let announcement = `&{template:default} {{name=${colorEmoji} ${characterName} casts ${name}!${tags}}}`;\r\n\r\n    // Add spell level and school\r\n    if (level > 0) {\r\n      let levelText = `Level ${level}`;\r\n      if (school) levelText += ` ${school}`;\r\n      if (isUpcast) {\r\n        levelText += ` (Upcast to Level ${castLevel})`;\r\n      }\r\n      announcement += ` {{Level=${levelText}}}`;\r\n    } else if (school) {\r\n      announcement += ` {{Level=${school} cantrip}}`;\r\n    }\r\n\r\n    // Add spell details\r\n    if (castingTime) announcement += ` {{Casting Time=${castingTime}}}`;\r\n    if (range) announcement += ` {{Range=${range}}}`;\r\n    if (duration) announcement += ` {{Duration=${duration}}}`;\r\n    if (components) announcement += ` {{Components=${components}}}`;\r\n    if (source) announcement += ` {{Source=${source}}}`;\r\n\r\n    // Add slot usage\r\n    if (slotUsed && !isCantrip && !isFreecast) {\r\n      announcement += ` {{Slot Used=${slotUsed.level} (${slotUsed.remaining}/${slotUsed.total} remaining)}}`;\r\n    }\r\n\r\n    // Add resource changes\r\n    if (resourceChanges && resourceChanges.length > 0) {\r\n      const resourceText = resourceChanges.map(change =>\r\n        `${change.resource}: ${change.current}/${change.max}`\r\n      ).join(', ');\r\n      announcement += ` {{Resources=${resourceText}}}`;\r\n    }\r\n\r\n    // Add effects\r\n    if (effects && effects.length > 0) {\r\n      const effectsText = effects.map(effect => effect.description || effect.type).join(', ');\r\n      announcement += ` {{Effects=${effectsText}}}`;\r\n    }\r\n\r\n    // Add summary and description\r\n    if (summary) {\r\n      announcement += ` {{Summary=${summary}}}`;\r\n    }\r\n    if (description) {\r\n      announcement += ` {{Description=${description}}}`;\r\n    }\r\n\r\n    // Post the announcement\r\n    postChatMessage(announcement);\r\n\r\n    // Helper function to scale damage formula for upcasting\r\n    const scaleFormulaForUpcast = (formula, baseLevel, actualCastLevel) => {\r\n      if (!formula || baseLevel <= 0 || actualCastLevel <= baseLevel) return formula;\r\n\r\n      // Replace slotLevel placeholder if present\r\n      let scaledFormula = formula.replace(/slotLevel/gi, actualCastLevel);\r\n\r\n      // If formula doesn't have slotLevel, try to scale it automatically\r\n      if (scaledFormula === formula) {\r\n        const levelDiff = actualCastLevel - baseLevel;\r\n        const diceMatch = formula.match(/^(\\d+)d(\\d+)/);\r\n        if (diceMatch && levelDiff > 0) {\r\n          const baseDice = parseInt(diceMatch[1]);\r\n          const dieSize = parseInt(diceMatch[2]);\r\n          const scaledDice = baseDice + levelDiff;\r\n          scaledFormula = formula.replace(/^(\\d+)d(\\d+)/, `${scaledDice}d${dieSize}`);\r\n          debug.log(`\uD83D\uDCC8 Scaled formula from ${formula} to ${scaledFormula} (upcast by ${levelDiff} levels)`);\r\n        }\r\n      }\r\n\r\n      return scaledFormula;\r\n    };\r\n\r\n    // Roll attack if spell has attack roll\r\n    if (attackRoll && attackRoll !== '(none)') {\r\n      setTimeout(() => {\r\n        try {\r\n          const attackMsg = formatRollForRoll20({\r\n            name: `${name} - Attack`,\r\n            formula: attackRoll,\r\n            characterName: characterName\r\n          });\r\n          postChatMessage(attackMsg);\r\n        } catch (attackError) {\r\n          debug.error(`\u274C Failed to roll attack for ${name}:`, attackError);\r\n          postChatMessage(`&{template:default} {{name=\u26A0\uFE0F Roll Failed}} {{error=Attack roll for ${name} failed: ${attackError.message}}}`);\r\n        }\r\n      }, 100);\r\n    }\r\n\r\n    // Roll damage(s) from damageRolls array - scale for upcasting\r\n    if (damageRolls && Array.isArray(damageRolls) && damageRolls.length > 0) {\r\n      damageRolls.forEach((roll, index) => {\r\n        if (roll.damage) {\r\n          setTimeout(() => {\r\n            try {\r\n              const damageType = roll.damageType || 'damage';\r\n              const isHealing = damageType.toLowerCase() === 'healing';\r\n              const isTempHP = damageType.toLowerCase().includes('temp');\r\n              let rollName;\r\n              if (isHealing) {\r\n                rollName = `${name} - Healing`;\r\n              } else if (isTempHP) {\r\n                rollName = `${name} - Temp HP`;\r\n              } else {\r\n                rollName = roll.name || `${name} - ${damageType}`;\r\n              }\r\n\r\n              // Scale formula for upcasting\r\n              const scaledFormula = scaleFormulaForUpcast(roll.damage, level, castLevel);\r\n\r\n              const damageMsg = formatRollForRoll20({\r\n                name: rollName,\r\n                formula: scaledFormula,\r\n                characterName: characterName\r\n              });\r\n              postChatMessage(damageMsg);\r\n            } catch (damageError) {\r\n              debug.error(`\u274C Failed to roll damage for ${name}:`, damageError);\r\n              postChatMessage(`&{template:default} {{name=\u26A0\uFE0F Roll Failed}} {{error=Damage roll ${index + 1} for ${name} failed: ${damageError.message}}}`);\r\n            }\r\n          }, 200 + (index * 100));\r\n        }\r\n      });\r\n    } else if (fallbackDamage) {\r\n      // Fallback to single damage field for backward compatibility\r\n      setTimeout(() => {\r\n        try {\r\n          const damageType = fallbackDamageType || 'damage';\r\n          const isHealing = damageType.toLowerCase() === 'healing';\r\n          const rollName = isHealing ? `${name} - Healing` : `${name} - ${damageType}`;\r\n\r\n          // Scale formula for upcasting\r\n          const scaledFormula = scaleFormulaForUpcast(fallbackDamage, level, castLevel);\r\n\r\n          const damageMsg = formatRollForRoll20({\r\n            name: rollName,\r\n            formula: scaledFormula,\r\n            characterName: characterName\r\n          });\r\n          postChatMessage(damageMsg);\r\n        } catch (damageError) {\r\n          debug.error(`\u274C Failed to roll damage for ${name}:`, damageError);\r\n          postChatMessage(`&{template:default} {{name=\u26A0\uFE0F Roll Failed}} {{error=Damage roll for ${name} failed: ${damageError.message}}}`);\r\n        }\r\n      }, 200);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Listen for messages from other parts of the extension\r\n   * Wrapped in try-catch to prevent one error from breaking subsequent message handling\r\n   */\r\n  browserAPI.runtime.onMessage.addListener(async (request, sender, sendResponse) => {\r\n    try {\r\n      debug.log('\uD83D\uDCE8 Roll20 content script received message:', request.action, request);\r\n\r\n      if (request.action === 'postRollToChat') {\r\n        try {\r\n          const result = handleDiceCloudRoll(request.roll);\r\n          sendResponse(result || { success: true });\r\n        } catch (rollError) {\r\n          debug.error('\u274C Error handling postRollToChat:', rollError);\r\n          sendResponse({ success: false, error: rollError.message });\r\n        }\r\n        return true; // Keep message channel open\r\n      } else if (request.action === 'sendRollToRoll20') {\r\n      // Handle the message that Dice Cloud is actually sending\r\n      debug.log('\uD83C\uDFB2 Received sendRollToRoll20 message:', request.roll);\r\n      try {\r\n        const result = handleDiceCloudRoll(request.roll);\r\n        sendResponse(result || { success: true });\r\n      } catch (rollError) {\r\n        debug.error('\u274C Error handling sendRollToRoll20:', rollError);\r\n        sendResponse({ success: false, error: rollError.message || 'Failed to process roll' });\r\n      }\r\n      return true; // Keep message channel open\r\n    } else if (request.action === 'rollFromPopout') {\r\n      // Check if this is actually an announcement wrapped in rollFromPopout (Firefox relay path)\r\n      if (request.roll && request.roll.action === 'announceSpell') {\r\n        debug.log('\u2728 Detected announceSpell wrapped in rollFromPopout, routing to announcement handler');\r\n        if (request.roll.message) {\r\n          postChatMessage(request.roll.message);\r\n          sendResponse({ success: true });\r\n        } else if (request.roll.spellData) {\r\n          const normalizedSpellData = normalizePopupSpellData(request.roll);\r\n          postSpellToRoll20(normalizedSpellData);\r\n          sendResponse({ success: true });\r\n        }\r\n        return true;\r\n      }\r\n\r\n      // Post roll directly to Roll20 - no DiceCloud needed!\r\n      debug.log('\uD83C\uDFB2 Received roll request from popup:', request);\r\n\r\n      const rollData = {\r\n        name: request.name || request.roll?.name,\r\n        formula: request.formula || request.roll?.formula,\r\n        characterName: request.characterName || request.roll?.characterName,\r\n        color: request.color || request.roll?.color\r\n      };\r\n\r\n      // Check if silent rolls mode is enabled - if so, hide the roll instead of posting\r\n      if (silentRollsEnabled) {\r\n        debug.log('\uD83D\uDD07 Silent rolls active - hiding roll instead of posting');\r\n        const hiddenRoll = {\r\n          id: Date.now() + Math.random(), // Unique ID\r\n          name: rollData.name,\r\n          formula: rollData.formula,\r\n          characterName: rollData.characterName,\r\n          timestamp: new Date().toLocaleTimeString(),\r\n          result: null // Will be filled when revealed\r\n        };\r\n        hiddenRolls.push(hiddenRoll);\r\n        updateHiddenRollsDisplay();\r\n        sendResponse({ success: true, hidden: true });\r\n      } else {\r\n        // Normal flow - post to Roll20 chat\r\n        const formattedMessage = formatRollForRoll20(rollData);\r\n        const success = postChatMessage(formattedMessage);\r\n\r\n        if (success) {\r\n          debug.log('\u2705 Roll posted directly to Roll20 (no DiceCloud!)');\r\n          // Observe Roll20's result for natural 1s/20s\r\n          observeNextRollResult(rollData);\r\n        }\r\n\r\n        sendResponse({ success: success });\r\n      }\r\n    } else if (request.action === 'announceSpell') {\r\n      // Handle spell announcements relayed from background script (Firefox)\r\n      if (request.spellData) {\r\n        // New pathway: structured spell data from popup-sheet\r\n        debug.log('\uD83D\uDD2E Received structured spell data from background script:', request);\r\n        const normalizedSpellData = normalizePopupSpellData(request);\r\n        postSpellToRoll20(normalizedSpellData);\r\n      } else if (request.message) {\r\n        // Legacy pathway: pre-formatted message (for non-spell announcements)\r\n        postChatMessage(request.message);\r\n      } else {\r\n        handleDiceCloudRoll(request);\r\n      }\r\n      sendResponse({ success: true });\r\n    } else if (request.action === 'postChatMessageFromPopup') {\r\n      // Handle character broadcast messages from popup\r\n      if (request.message) {\r\n        debug.log('\uD83D\uDCE8 Received postChatMessageFromPopup:', request.message);\r\n        const success = postChatMessage(request.message);\r\n        sendResponse({ success: success });\r\n      } else {\r\n        debug.warn('\u26A0\uFE0F postChatMessageFromPopup missing message');\r\n        sendResponse({ success: false, error: 'No message provided' });\r\n      }\r\n    } else if (request.action === 'testRoll20Connection') {\r\n      // Test if we can access Roll20 chat\r\n      const chatInput = document.querySelector('#textchat-input textarea');\r\n      sendResponse({\r\n        success: !!chatInput,\r\n        message: chatInput ? 'Roll20 chat accessible' : 'Roll20 chat not found'\r\n      });\r\n    } else if (request.action === 'showCharacterSheet') {\r\n      debug.log('\uD83D\uDD0D showCharacterSheet called, checking playerData:', playerData);\r\n      debug.log('\uD83D\uDD0D playerData keys:', Object.keys(playerData || {}));\r\n\r\n      // Check if there's any character data synced\r\n      if (!playerData || Object.keys(playerData).length === 0) {\r\n        debug.log('\u26A0\uFE0F No character data found - asking user about GM mode');\r\n\r\n        // Ask user if they want to open GM mode\r\n        const userConfirmed = confirm('No character data found.\\n\\nWould you like to open GM mode instead?');\r\n\r\n        if (userConfirmed) {\r\n          // User clicked \"Yes\" - open GM panel\r\n          try {\r\n            postChatMessage('\uD83D\uDC51 Opening GM mode...');\r\n            debug.log('\u2705 Chat message posted successfully');\r\n          } catch (error) {\r\n            debug.error('\u274C Error posting chat message:', error);\r\n          }\r\n\r\n          try {\r\n            toggleGMMode(true);\r\n            debug.log('\u2705 GM panel opened successfully');\r\n          } catch (error) {\r\n            debug.error('\u274C Error opening GM panel:', error);\r\n          }\r\n\r\n          sendResponse({ success: true, message: 'GM mode opened' });\r\n        } else {\r\n          // User clicked \"Cancel\" - do nothing\r\n          debug.log('\u2139\uFE0F User cancelled GM mode opening');\r\n          sendResponse({ success: false, error: 'No character data found' });\r\n        }\r\n        return;\r\n      }\r\n\r\n      // Show the character sheet overlay\r\n      try {\r\n        // Try to access the character sheet overlay script\r\n        // This will work if the overlay is already loaded\r\n        const overlayElement = document.getElementById('rollcloud-character-overlay');\r\n        if (overlayElement) {\r\n          overlayElement.style.display = 'block';\r\n          sendResponse({ success: true });\r\n        } else {\r\n          // Try to trigger the overlay creation\r\n          const event = new CustomEvent('showRollCloudSheet');\r\n          document.dispatchEvent(event);\r\n          sendResponse({ success: true });\r\n        }\r\n      } catch (error) {\r\n        debug.error('Error showing character sheet:', error);\r\n        sendResponse({ success: false, error: error.message });\r\n      }\r\n    } else if (request.action === 'forwardToPopup') {\r\n      // Forward roll result to popup for racial traits checking\r\n      debug.log('\uD83E\uDDEC Forwarding roll result to popup:', request);\r\n      debug.log('\uD83E\uDDEC Available popups:', Object.keys(characterPopups));\r\n      \r\n      // Send to all registered popup windows\r\n      Object.keys(characterPopups).forEach(characterName => {\r\n        const popup = characterPopups[characterName];\r\n        try {\r\n          if (popup && !popup.closed) {\r\n            debug.log(`\uD83E\uDDEC Sending to popup for ${characterName}:`, popup);\r\n            popup.postMessage({\r\n              action: 'rollResult',\r\n              rollResult: request.rollResult,\r\n              baseRoll: request.baseRoll,\r\n              rollType: request.rollType,\r\n              rollName: request.rollName,\r\n              checkRacialTraits: request.checkRacialTraits\r\n            }, '*');\r\n            \r\n            debug.log(`\uD83D\uDCE4 Sent rollResult to popup for ${characterName}`);\r\n          } else {\r\n            // Clean up closed popups\r\n            delete characterPopups[characterName];\r\n            debug.log(`\uD83D\uDDD1\uFE0F Removed closed popup for ${characterName}`);\r\n          }\r\n        } catch (error) {\r\n          debug.warn(`\u26A0\uFE0F Error sending rollResult to popup \"${characterName}\":`, error);\r\n          delete characterPopups[characterName];\r\n        }\r\n      });\r\n\r\n      sendResponse({ success: true });\r\n    } else if (request.action === 'setAutoBackwardsSync') {\r\n      // Handle auto backwards sync toggle from popup\r\n      debug.log('\uD83D\uDD04 Setting auto backwards sync:', request.enabled);\r\n\r\n      // Check if diceCloudSync exists (experimental build)\r\n      if (window.diceCloudSync) {\r\n        if (request.enabled) {\r\n          window.diceCloudSync.enable();\r\n          debug.log('\u2705 Auto backwards sync enabled');\r\n        } else {\r\n          window.diceCloudSync.disable();\r\n          debug.log('\u274C Auto backwards sync disabled');\r\n        }\r\n        sendResponse({ success: true });\r\n      } else {\r\n        debug.warn('\u26A0\uFE0F diceCloudSync not available (not experimental build?)');\r\n        sendResponse({ success: false, error: 'Sync not available' });\r\n      }\r\n    } else if (request.action === 'useActionFromDiscord') {\r\n      try {\r\n        debug.log('\u2694\uFE0F Received useActionFromDiscord:', request);\r\n        const actionName = request.actionName || 'Unknown Action';\r\n        const commandData = request.commandData || {};\r\n        const charName = commandData.character_name || 'Character';\r\n\r\n        // SECURITY: Only process if this character belongs to this tab's user\r\n        if (!isOurCharacter(charName)) {\r\n          debug.log(`\u23ED\uFE0F Ignoring Discord action for ${charName} (not our character)`);\r\n          sendResponse({ success: true, ignored: true });\r\n          return true;\r\n        }\r\n\r\n        // Get action data - check multiple possible locations\r\n        const actionData = commandData.action_data || commandData || {};\r\n        debug.log('\u2694\uFE0F Action data:', actionData);\r\n\r\n        // Build announcement message\r\n        let announcement = `&{template:default} {{name=${charName} uses ${actionData.name || actionName}!}}`;\r\n\r\n        // Add action type if available\r\n        if (actionData.actionType) {\r\n          announcement += ` {{Type=${actionData.actionType}}}`;\r\n        }\r\n\r\n        // Add description if available\r\n        if (actionData.description) {\r\n          announcement += ` {{Description=${actionData.description}}}`;\r\n        }\r\n\r\n        // Post the announcement first\r\n        postChatMessage(announcement);\r\n\r\n        // Roll attack if action has attack roll (check both field names for compatibility)\r\n        const attackRoll = actionData.attackRoll || actionData.attackBonus;\r\n        if (attackRoll) {\r\n          setTimeout(() => {\r\n            // If it's just a number (bonus), format as d20+bonus\r\n            const attackFormula = attackRoll.includes('d') ? attackRoll : `1d20+${attackRoll}`;\r\n            const attackMsg = formatRollForRoll20({\r\n              name: `${actionData.name || actionName} - Attack`,\r\n              formula: attackFormula,\r\n              characterName: charName\r\n            });\r\n            postChatMessage(attackMsg);\r\n          }, 100);\r\n        }\r\n\r\n        // Roll damage if available (check both field names for compatibility)\r\n        const damageRoll = actionData.damage || actionData.damageRoll;\r\n        if (damageRoll) {\r\n          setTimeout(() => {\r\n            const damageType = actionData.damageType || 'damage';\r\n            const damageMsg = formatRollForRoll20({\r\n              name: `${actionData.name || actionName} - ${damageType}`,\r\n              formula: damageRoll,\r\n              characterName: charName\r\n            });\r\n            postChatMessage(damageMsg);\r\n          }, 200);\r\n        }\r\n\r\n        sendResponse({ success: true });\r\n      } catch (useActionError) {\r\n        debug.error('\u274C Error in useActionFromDiscord:', useActionError);\r\n        sendResponse({ success: false, error: useActionError.message });\r\n      }\r\n    } else if (request.action === 'castSpellFromDiscord') {\r\n      try {\r\n        debug.log('\uD83D\uDD2E Received castSpellFromDiscord:', request);\r\n\r\n        // SECURITY: Only process if this character belongs to this tab's user\r\n        const characterName = request.spellData?.character_name;\r\n        if (characterName && !isOurCharacter(characterName)) {\r\n          debug.log(`\u23ED\uFE0F Ignoring Discord spell for ${characterName} (not our character)`);\r\n          sendResponse({ success: true, ignored: true });\r\n          return true;\r\n        }\r\n\r\n        // Normalize the Discord spell data into common format\r\n        const normalizedSpellData = normalizeDiscordSpellData(request.spellData || {});\r\n\r\n        // Use the unified function to post to Roll20\r\n        postSpellToRoll20(normalizedSpellData);\r\n\r\n        sendResponse({ success: true });\r\n      } catch (castError) {\r\n        debug.error('\u274C Error in castSpellFromDiscord:', castError);\r\n        sendResponse({ success: false, error: castError.message });\r\n      }\r\n    } else if (request.action === 'useAbilityFromDiscord') {\r\n      try {\r\n        debug.log('\u2728 Received useAbilityFromDiscord:', request);\r\n      const abilityName = request.abilityName || 'Unknown Ability';\r\n      const abilityData = request.abilityData || {};\r\n      const charName = abilityData.character_name || 'Character';\r\n\r\n      // SECURITY: Only process if this character belongs to this tab's user\r\n      if (!isOurCharacter(charName)) {\r\n        debug.log(`\u23ED\uFE0F Ignoring Discord ability for ${charName} (not our character)`);\r\n        sendResponse({ success: true, ignored: true });\r\n        return true;\r\n      }\r\n\r\n      const action = abilityData.action_data || abilityData.action || {};\r\n      const notificationColor = abilityData.notification_color || '#3498db';\r\n\r\n      // Get color emoji banner (matches popup-sheet getColoredBanner)\r\n      const colorEmoji = getColorEmoji(notificationColor);\r\n\r\n      // Build action announcement (matches popup-sheet announceAction)\r\n      let announcement = `&{template:default} {{name=${colorEmoji} ${charName} uses ${action.name || abilityName}!}}`;\r\n\r\n      // Add action type\r\n      if (action.actionType) {\r\n        announcement += ` {{Type=${action.actionType}}}`;\r\n      }\r\n\r\n      // Add range if available\r\n      if (action.range) {\r\n        announcement += ` {{Range=${action.range}}}`;\r\n      }\r\n\r\n      // Add description if available\r\n      if (action.description) {\r\n        announcement += ` {{Description=${action.description}}}`;\r\n      }\r\n\r\n      // Post the announcement\r\n      postChatMessage(announcement);\r\n\r\n      // Roll attack if action has attack roll\r\n      if (action.attackRoll || action.attackBonus) {\r\n        setTimeout(() => {\r\n          try {\r\n            const attackFormula = action.attackRoll || `1d20+${action.attackBonus}`;\r\n            const attackMsg = formatRollForRoll20({\r\n              name: `${action.name || abilityName} - Attack`,\r\n              formula: attackFormula,\r\n              characterName: charName\r\n            });\r\n            postChatMessage(attackMsg);\r\n          } catch (attackError) {\r\n            debug.error(`\u274C Failed to roll attack for ${action.name || abilityName}:`, attackError);\r\n            postChatMessage(`&{template:default} {{name=\u26A0\uFE0F Roll Failed}} {{error=Attack roll for ${action.name || abilityName} failed: ${attackError.message}}}`);\r\n          }\r\n        }, 100);\r\n      }\r\n\r\n      // Roll damage if available\r\n      if (action.damageRoll || action.damage) {\r\n        setTimeout(() => {\r\n          try {\r\n            const damageFormula = action.damageRoll || action.damage;\r\n            const damageType = action.damageType || 'damage';\r\n            const isHealing = damageType.toLowerCase() === 'healing';\r\n            const rollName = isHealing ? `${action.name || abilityName} - Healing` : `${action.name || abilityName} - ${damageType}`;\r\n            const damageMsg = formatRollForRoll20({\r\n              name: rollName,\r\n              formula: damageFormula,\r\n              characterName: charName\r\n            });\r\n            postChatMessage(damageMsg);\r\n          } catch (damageError) {\r\n            debug.error(`\u274C Failed to roll damage for ${action.name || abilityName}:`, damageError);\r\n            postChatMessage(`&{template:default} {{name=\u26A0\uFE0F Roll Failed}} {{error=Damage roll for ${action.name || abilityName} failed: ${damageError.message}}}`);\r\n          }\r\n        }, 200);\r\n      }\r\n\r\n        sendResponse({ success: true });\r\n      } catch (abilityError) {\r\n        debug.error('\u274C Error in useAbilityFromDiscord:', abilityError);\r\n        sendResponse({ success: false, error: abilityError.message });\r\n      }\r\n    } else if (request.action === 'healFromDiscord') {\r\n      try {\r\n        debug.log('\uD83D\uDC9A Received healFromDiscord:', request);\r\n        const amount = request.amount || 0;\r\n        const isTemp = request.isTemp || false;\r\n        const charName = request.characterName || 'Character';\r\n\r\n        // SECURITY: Only process if this character belongs to this tab's user\r\n        if (!isOurCharacter(charName)) {\r\n          debug.log(`\u23ED\uFE0F Ignoring Discord heal for ${charName} (not our character)`);\r\n          sendResponse({ success: true, ignored: true });\r\n          return true;\r\n        }\r\n\r\n        // Post announcement to Roll20 chat\r\n        const healType = isTemp ? 'Temporary HP' : 'HP';\r\n        const emoji = isTemp ? '\uD83D\uDEE1\uFE0F' : '\uD83D\uDC9A';\r\n        const announcement = `&{template:default} {{name=${emoji} ${charName} ${isTemp ? 'gains' : 'is healed'}}} {{${healType}=+${amount}}}`;\r\n\r\n        postChatMessage(announcement);\r\n        sendResponse({ success: true });\r\n      } catch (healError) {\r\n        debug.error('\u274C Error in healFromDiscord:', healError);\r\n        sendResponse({ success: false, error: healError.message });\r\n      }\r\n    } else if (request.action === 'takeDamageFromDiscord') {\r\n      try {\r\n        debug.log('\uD83D\uDC94 Received takeDamageFromDiscord:', request);\r\n        const amount = request.amount || 0;\r\n        const damageType = request.damageType || 'untyped';\r\n        const charName = request.characterName || 'Character';\r\n\r\n        // SECURITY: Only process if this character belongs to this tab's user\r\n        if (!isOurCharacter(charName)) {\r\n          debug.log(`\u23ED\uFE0F Ignoring Discord damage for ${charName} (not our character)`);\r\n          sendResponse({ success: true, ignored: true });\r\n          return true;\r\n        }\r\n\r\n        // Post announcement to Roll20 chat\r\n        const damageTypeDisplay = damageType !== 'untyped' ? ` (${damageType})` : '';\r\n        const announcement = `&{template:default} {{name=\uD83D\uDC94 ${charName} takes damage}} {{Damage=${amount}${damageTypeDisplay}}}`;\r\n\r\n        postChatMessage(announcement);\r\n        sendResponse({ success: true });\r\n      } catch (damageError) {\r\n        debug.error('\u274C Error in takeDamageFromDiscord:', damageError);\r\n        sendResponse({ success: false, error: damageError.message });\r\n      }\r\n    } else if (request.action === 'restFromDiscord') {\r\n      try {\r\n        debug.log('\uD83D\uDECF\uFE0F Received restFromDiscord:', request);\r\n        const restType = request.restType || 'short';\r\n        const charName = request.characterName || 'Character';\r\n\r\n        // SECURITY: Only process if this character belongs to this tab's user\r\n        if (!isOurCharacter(charName)) {\r\n          debug.log(`\u23ED\uFE0F Ignoring Discord rest for ${charName} (not our character)`);\r\n          sendResponse({ success: true, ignored: true });\r\n          return true;\r\n        }\r\n\r\n        // Post announcement to Roll20 chat\r\n        const emoji = restType === 'short' ? '\u2615' : '\uD83D\uDECF\uFE0F';\r\n        const restName = restType === 'short' ? 'Short Rest' : 'Long Rest';\r\n        const announcement = `&{template:default} {{name=${emoji} ${charName} takes a ${restName}}} {{Rest Type=${restName}}}`;\r\n\r\n        postChatMessage(announcement);\r\n        sendResponse({ success: true });\r\n      } catch (restError) {\r\n        debug.error('\u274C Error in restFromDiscord:', restError);\r\n        sendResponse({ success: false, error: restError.message });\r\n      }\r\n    } else if (request.action === 'endTurnFromDiscord') {\r\n      try {\r\n        debug.log('\u23ED\uFE0F Received endTurnFromDiscord');\r\n        postChatMessage('/e ends their turn.');\r\n        sendResponse({ success: true });\r\n      } catch (endTurnError) {\r\n        debug.error('\u274C Error in endTurnFromDiscord:', endTurnError);\r\n        sendResponse({ success: false, error: endTurnError.message });\r\n      }\r\n    }\r\n    } catch (outerError) {\r\n      // Catch any unexpected errors to prevent breaking the message listener\r\n      debug.error('\u274C Unexpected error in message listener:', outerError);\r\n      try {\r\n        sendResponse({ success: false, error: 'Unexpected error: ' + outerError.message });\r\n      } catch (e) {\r\n        // sendResponse may have already been called or channel closed\r\n      }\r\n      return true; // Keep channel open since we sent an error response\r\n    }\r\n    // Don't return true here - only specific handlers should keep the channel open\r\n  });\r\n\r\n  /**\r\n   * Listen for messages from popup windows\r\n   */\r\n  window.addEventListener('message', (event) => {\r\n    if (event.data.action === 'postRollToChat') {\r\n      handleDiceCloudRoll(event.data.roll);\r\n    } else if (event.data.action === 'postChat') {\r\n      // Handle general chat messages (like spell descriptions)\r\n      postChatMessage(event.data.message);\r\n    } else if (event.data.action === 'rollFromPopout') {\r\n      // Post roll directly to Roll20 - no DiceCloud needed!\r\n      debug.log('\uD83C\uDFB2 Received roll request from popup via postMessage:', event.data);\r\n\r\n      const rollData = {\r\n        name: event.data.name,\r\n        formula: event.data.formula,\r\n        characterName: event.data.characterName\r\n      };\r\n\r\n      // Check if silent rolls mode is enabled - if so, hide the roll instead of posting\r\n      if (silentRollsEnabled) {\r\n        debug.log('\uD83D\uDD07 Silent rolls active - hiding roll instead of posting');\r\n        const hiddenRoll = {\r\n          id: Date.now() + Math.random(), // Unique ID\r\n          name: rollData.name,\r\n          formula: rollData.formula,\r\n          characterName: rollData.characterName,\r\n          timestamp: new Date().toLocaleTimeString(),\r\n          result: null // Will be filled when revealed\r\n        };\r\n        hiddenRolls.push(hiddenRoll);\r\n        updateHiddenRollsDisplay();\r\n\r\n        // Send confirmation back to popup\r\n        if (event.source) {\r\n          event.source.postMessage({\r\n            action: 'rollHidden',\r\n            roll: hiddenRoll\r\n          }, '*');\r\n        }\r\n      } else {\r\n        // Normal flow - post to Roll20 chat\r\n        const formattedMessage = formatRollForRoll20(rollData);\r\n        const success = postChatMessage(formattedMessage);\r\n\r\n        if (success) {\r\n          debug.log('\u2705 Roll posted directly to Roll20 (no DiceCloud!)');\r\n          // Observe Roll20's result for natural 1s/20s\r\n          observeNextRollResult(rollData);\r\n        }\r\n      }\r\n    } else if (event.data.action === 'announceSpell') {\r\n      // Handle spell announcements - check if we have structured spell data or just a message\r\n      if (event.data.spellData) {\r\n        // New pathway: structured spell data from popup-sheet\r\n        debug.log('\uD83D\uDD2E Received structured spell data from popup:', event.data);\r\n        const normalizedSpellData = normalizePopupSpellData(event.data);\r\n        postSpellToRoll20(normalizedSpellData);\r\n      } else if (event.data.message) {\r\n        // Legacy pathway: pre-formatted message (for non-spell announcements like initiative, saves, etc.)\r\n        postChatMessage(event.data.message);\r\n      } else {\r\n        handleDiceCloudRoll(event.data);\r\n      }\r\n    }\r\n  });\r\n\r\n  // ============================================================================\r\n  // GM INITIATIVE TRACKER\r\n  // ============================================================================\r\n\r\n  let gmModeEnabled = false; // Start disabled - GM panel is a popup when toggled on\r\n  let silentRollsEnabled = false; // Separate toggle for silent rolls\r\n  let gmPanel = null;\r\n  const characterPopups = {}; // Track popup windows by character name\r\n  let combatStarted = false; // Track if combat has been initiated\r\n  let initiativeTracker = {\r\n    combatants: [],\r\n    currentTurnIndex: 0,\r\n    round: 1,\r\n    delayedCombatants: [] // Track combatants who have delayed their turn\r\n  };\r\n  let hiddenRolls = []; // Store hidden GM rolls\r\n  let turnHistory = []; // Store turn history for logging\r\n  let playerData = {}; // Store player overview data { characterName: { hp, maxHp, ac, etc } }\r\n\r\n  /**\r\n   * Create GM Initiative Tracker Panel\r\n   */\r\n  function createGMPanel() {\r\n    if (gmPanel) return gmPanel;\r\n\r\n    // Create panel\r\n    gmPanel = document.createElement('div');\r\n    gmPanel.id = 'gm-panel';\r\n    gmPanel.style.cssText = `\r\n      position: fixed;\r\n      top: 20px;\r\n      right: 20px;\r\n      width: 500px;\r\n      height: 600px;\r\n      min-width: 400px;\r\n      min-height: 400px;\r\n      max-width: 90vw;\r\n      max-height: 90vh;\r\n      background: #1e1e1e;\r\n      border: 2px solid #FC57F9;\r\n      border-radius: 12px;\r\n      z-index: 999998;\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\r\n      font-size: 14px;\r\n      color: #fff;\r\n      box-shadow: 0 8px 32px rgba(0,0,0,0.5);\r\n      display: none;\r\n      flex-direction: column;\r\n      overflow: hidden;\r\n      resize: both;\r\n      visibility: visible;\r\n      opacity: 1;\r\n    `;\r\n\r\n    // Create tab content containers\r\n    const initiativeTab = document.createElement('div');\r\n    initiativeTab.className = 'gm-tab-content';\r\n    initiativeTab.dataset.tab = 'initiative';\r\n    initiativeTab.style.display = 'block';\r\n\r\n    const hiddenRollsTab = document.createElement('div');\r\n    hiddenRollsTab.className = 'gm-tab-content';\r\n    hiddenRollsTab.dataset.tab = 'hidden-rolls';\r\n    hiddenRollsTab.style.display = 'none';\r\n\r\n    const playersTab = document.createElement('div');\r\n    playersTab.className = 'gm-tab-content';\r\n    playersTab.dataset.tab = 'players';\r\n    playersTab.style.display = 'none';\r\n\r\n    const historyTab = document.createElement('div');\r\n    historyTab.className = 'gm-tab-content';\r\n    historyTab.dataset.tab = 'history';\r\n    historyTab.style.display = 'none';\r\n\r\n    // ===== INITIATIVE TAB CONTENT =====\r\n    const controls = document.createElement('div');\r\n    controls.style.cssText = `\r\n      display: grid;\r\n      grid-template-columns: 1fr 1fr;\r\n      gap: 8px;\r\n      margin-bottom: 15px;\r\n    `;\r\n    controls.innerHTML = `\r\n      <button id=\"start-combat-btn\" style=\"padding: 12px; background: #c2185b; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; grid-column: span 2; box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);\">\u2694\uFE0F Start Combat</button>\r\n      <button id=\"prev-turn-btn\" style=\"padding: 8px 12px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em; display: none;\">\u2190 Prev</button>\r\n      <button id=\"next-turn-btn\" style=\"padding: 8px 12px; background: #FC57F9; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em; display: none;\">Next \u2192</button>\r\n      <button id=\"clear-all-btn\" style=\"padding: 8px 12px; background: #e74c3c; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em; grid-column: span 2;\">\uD83D\uDDD1\uFE0F Clear All</button>\r\n    `;\r\n\r\n    const roundDisplay = document.createElement('div');\r\n    roundDisplay.id = 'round-display';\r\n    roundDisplay.style.cssText = `\r\n      text-align: center;\r\n      padding: 8px;\r\n      background: #34495e;\r\n      border-radius: 6px;\r\n      margin-bottom: 15px;\r\n      font-weight: bold;\r\n    `;\r\n    roundDisplay.textContent = 'Round 1';\r\n\r\n    const initiativeList = document.createElement('div');\r\n    initiativeList.id = 'initiative-list';\r\n    initiativeList.style.cssText = `\r\n      display: flex;\r\n      flex-direction: column;\r\n      gap: 8px;\r\n      margin-bottom: 15px;\r\n    `;\r\n\r\n    const addFormSection = document.createElement('div');\r\n    addFormSection.style.cssText = `\r\n      margin-top: 15px;\r\n      padding-top: 15px;\r\n      border-top: 2px solid #34495e;\r\n    `;\r\n\r\n    const addFormHeader = document.createElement('div');\r\n    addFormHeader.style.cssText = `\r\n      cursor: pointer;\r\n      user-select: none;\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      padding: 8px;\r\n      margin-bottom: 10px;\r\n      background: #34495e;\r\n      border-radius: 6px;\r\n      font-weight: bold;\r\n      transition: background 0.2s;\r\n    `;\r\n    addFormHeader.innerHTML = `\r\n      <span>\u2795 Add Combatant</span>\r\n      <span id=\"add-form-toggle\" style=\"transition: transform 0.3s; transform: rotate(-90deg);\">\u25BC</span>\r\n    `;\r\n\r\n    const addForm = document.createElement('div');\r\n    addForm.id = 'add-combatant-form';\r\n    addForm.style.cssText = `\r\n      display: block;\r\n      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;\r\n      overflow: hidden;\r\n      max-height: 0;\r\n      opacity: 0;\r\n    `;\r\n    addForm.innerHTML = `\r\n      <input type=\"text\" id=\"combatant-name-input\" placeholder=\"Combatant name\" style=\"width: 100%; padding: 8px; margin-bottom: 8px; border: 2px solid #34495e; border-radius: 4px; background: #34495e; color: #fff; font-size: 0.9em;\" />\r\n      <input type=\"number\" id=\"combatant-init-input\" placeholder=\"Initiative\" style=\"width: 100%; padding: 8px; margin-bottom: 8px; border: 2px solid #34495e; border-radius: 4px; background: #34495e; color: #fff; font-size: 0.9em;\" />\r\n      <button id=\"add-combatant-btn\" style=\"width: 100%; padding: 8px 12px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\u2795 Add</button>\r\n    `;\r\n\r\n    addFormSection.appendChild(addFormHeader);\r\n    addFormSection.appendChild(addForm);\r\n\r\n    // Add initiative content to initiative tab\r\n    initiativeTab.appendChild(controls);\r\n    initiativeTab.appendChild(roundDisplay);\r\n    initiativeTab.appendChild(initiativeList);\r\n    initiativeTab.appendChild(addFormSection);\r\n\r\n    // ===== HIDDEN ROLLS TAB CONTENT =====\r\n    hiddenRollsTab.innerHTML = `\r\n      <div style=\"text-align: center; padding: 20px; color: #888;\">\r\n        <div style=\"font-size: 3em; margin-bottom: 10px;\">\uD83C\uDFB2</div>\r\n        <p style=\"margin: 0;\">No hidden rolls yet</p>\r\n        <p style=\"font-size: 0.85em; margin-top: 8px;\">Rolls made while GM Mode is active will appear here</p>\r\n      </div>\r\n      <div id=\"hidden-rolls-list\" style=\"display: flex; flex-direction: column; gap: 8px;\"></div>\r\n    `;\r\n\r\n    // ===== PLAYER OVERVIEW TAB CONTENT =====\r\n    playersTab.innerHTML = `\r\n      <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;\">\r\n        <h3 style=\"margin: 0; font-size: 1.2em; color: #FC57F9;\">Party Overview</h3>\r\n        <div style=\"display: flex; gap: 8px;\">\r\n          <button id=\"import-players-btn\" style=\"padding: 8px 14px; background: #c2185b; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: bold;\">\uD83D\uDCE5 Import</button>\r\n          <button id=\"refresh-players-btn\" style=\"padding: 8px 14px; background: #9b59b6; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: bold;\">\uD83D\uDD04 Refresh</button>\r\n        </div>\r\n      </div>\r\n      <div style=\"text-align: center; padding: 20px; color: #888;\">\r\n        <div style=\"font-size: 3em; margin-bottom: 10px;\">\uD83D\uDC65</div>\r\n        <p style=\"margin: 0; font-size: 1.1em;\">No players tracked yet</p>\r\n        <p style=\"font-size: 1em; margin-top: 8px;\">Click Import to load character data from storage</p>\r\n      </div>\r\n      <div id=\"player-overview-list\" style=\"display: flex; flex-direction: column; gap: 10px;\"></div>\r\n    `;\r\n\r\n    // ===== TURN HISTORY TAB CONTENT =====\r\n    historyTab.innerHTML = `\r\n      <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;\">\r\n        <h3 style=\"margin: 0; font-size: 1em; color: #FC57F9;\">Last 10 Turns</h3>\r\n        <button id=\"export-history-btn\" style=\"padding: 6px 12px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8em;\">\uD83D\uDCCB Copy</button>\r\n      </div>\r\n      <div id=\"turn-history-empty-state\" style=\"text-align: center; padding: 20px; color: #888;\">\r\n        <div style=\"font-size: 3em; margin-bottom: 10px;\">\uD83D\uDCDC</div>\r\n        <p style=\"margin: 0;\">No turn history yet</p>\r\n        <p style=\"font-size: 0.85em; margin-top: 8px;\">Combat actions will be logged here</p>\r\n      </div>\r\n      <div id=\"turn-history-list\" style=\"display: flex; flex-direction: column; gap: 8px;\"></div>\r\n    `;\r\n\r\n    // ===== CREATE HEADER =====\r\n    const header = document.createElement('div');\r\n    header.style.cssText = `\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      padding: 15px;\r\n      background: #1e1e1e;\r\n      border-bottom: 2px solid #FC57F9;\r\n      cursor: move;\r\n      user-select: none;\r\n    `;\r\n    header.innerHTML = `\r\n      <div>\r\n        <h2 style=\"margin: 0; font-size: 1.2em; color: #FC57F9;\">\uD83D\uDC51 GM Panel</h2>\r\n        <div style=\"display: flex; align-items: center; gap: 15px; margin-top: 8px;\">\r\n          <label style=\"display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: #aaa; cursor: pointer;\">\r\n            <input type=\"checkbox\" id=\"silent-rolls-toggle\" style=\"width: 16px; height: 16px; cursor: pointer;\" />\r\n            <span>\uD83D\uDD07 Silent Rolls</span>\r\n          </label>\r\n        </div>\r\n      </div>\r\n      <button id=\"gm-panel-close\" style=\"background: #e74c3c; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em;\">\u2716</button>\r\n    `;\r\n\r\n    // ===== CREATE TAB NAVIGATION =====\r\n    const tabNav = document.createElement('div');\r\n    tabNav.style.cssText = `\r\n      display: flex;\r\n      gap: 0;\r\n      background: #1e1e1e;\r\n      border-bottom: 1px solid #34495e;\r\n    `;\r\n    tabNav.innerHTML = `\r\n      <button class=\"gm-tab-btn\" data-tab=\"initiative\" style=\"flex: 1; padding: 12px; background: #2a2a2a; color: #FC57F9; border: none; border-bottom: 3px solid #FC57F9; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: all 0.2s;\">\u2694\uFE0F Initiative</button>\r\n      <button class=\"gm-tab-btn\" data-tab=\"history\" style=\"flex: 1; padding: 12px; background: transparent; color: #888; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: all 0.2s;\">\uD83D\uDCDC History</button>\r\n      <button class=\"gm-tab-btn\" data-tab=\"hidden-rolls\" style=\"flex: 1; padding: 12px; background: transparent; color: #888; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: all 0.2s;\">\uD83C\uDFB2 Hidden Rolls</button>\r\n      <button class=\"gm-tab-btn\" data-tab=\"players\" style=\"flex: 1; padding: 12px; background: transparent; color: #888; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: all 0.2s;\">\uD83D\uDC65 Players</button>\r\n    `;\r\n\r\n    // ===== CREATE CONTENT WRAPPER =====\r\n    const contentWrapper = document.createElement('div');\r\n    contentWrapper.style.cssText = `\r\n      padding: 15px;\r\n      background: #2a2a2a;\r\n      color: #fff;\r\n      border-radius: 0 0 12px 12px;\r\n      overflow-y: auto;\r\n      flex: 1;\r\n    `;\r\n\r\n    // Assemble all tabs into content wrapper\r\n    contentWrapper.appendChild(initiativeTab);\r\n    contentWrapper.appendChild(hiddenRollsTab);\r\n    contentWrapper.appendChild(playersTab);\r\n    contentWrapper.appendChild(historyTab);\r\n\r\n    // Assemble panel\r\n    gmPanel.appendChild(header);\r\n    gmPanel.appendChild(tabNav);\r\n    gmPanel.appendChild(contentWrapper);\r\n    document.body.appendChild(gmPanel);\r\n\r\n    // Make draggable\r\n    makeDraggable(gmPanel, header);\r\n\r\n    // Start listening for character broadcasts\r\n    startCharacterBroadcastListener();\r\n\r\n    // Load player data from storage\r\n    loadPlayerDataFromStorage();\r\n    \r\n    // Test storage functionality immediately\r\n    debug.log('\uD83E\uDDEA Testing storage functionality...');\r\n    \r\n    // Test 1: Promise-based API\r\n    if (browserAPI.storage.local.get instanceof Function) {\r\n      browserAPI.storage.local.get(['characterProfiles']).then(result => {\r\n        debug.log('\uD83E\uDDEA Promise storage test result:', result);\r\n        if (result.characterProfiles) {\r\n          debug.log('\uD83E\uDDEA Found characterProfiles:', Object.keys(result.characterProfiles));\r\n          Object.keys(result.characterProfiles).forEach(key => {\r\n            debug.log(`\uD83E\uDDEA Profile ${key}:`, result.characterProfiles[key].type);\r\n          });\r\n        } else {\r\n          debug.log('\uD83E\uDDEA No characterProfiles found in storage (Promise)');\r\n        }\r\n      }).catch(error => {\r\n        debug.error('\uD83E\uDDEA Promise storage error:', error);\r\n      });\r\n    }\r\n    \r\n    // Test 2: Callback-based API (fallback)\r\n    try {\r\n      browserAPI.storage.local.get(['characterProfiles'], (result) => {\r\n        debug.log('\uD83E\uDDEA Callback storage test result:', result);\r\n        if (browserAPI.runtime.lastError) {\r\n          debug.error('\uD83E\uDDEA Callback storage error:', browserAPI.runtime.lastError);\r\n        } else if (result.characterProfiles) {\r\n          debug.log('\uD83E\uDDEA Found characterProfiles (callback):', Object.keys(result.characterProfiles));\r\n        } else {\r\n          debug.log('\uD83E\uDDEA No characterProfiles found in storage (callback)');\r\n        }\r\n      });\r\n    } catch (error) {\r\n      debug.error('\uD83E\uDDEA Callback storage test failed:', error);\r\n    }\r\n\r\n    // Attach event listeners\r\n    attachGMPanelListeners();\r\n\r\n    debug.log('\u2705 GM Panel created');\r\n    return gmPanel;\r\n  }\r\n\r\n  /**\r\n   * Start listening for character broadcasts from players\r\n   */\r\n  function startCharacterBroadcastListener() {\r\n    // Monitor chat for character broadcasts\r\n    const chatObserver = new MutationObserver((mutations) => {\r\n      mutations.forEach((mutation) => {\r\n        mutation.addedNodes.forEach((node) => {\r\n          if (node.nodeType === Node.ELEMENT_NODE) {\r\n            // Check for character broadcast messages\r\n            const messageContent = node.textContent || node.innerText || '';\r\n            debug.log('\uD83D\uDD0D Chat message detected:', messageContent.substring(0, 100));\r\n            if (messageContent.includes('\uD83D\uDC51[ROLLCLOUD:CHARACTER:') && messageContent.includes(']\uD83D\uDC51')) {\r\n              debug.log('\uD83D\uDC51 Detected character broadcast in chat');\r\n              parseCharacterBroadcast(messageContent);\r\n            }\r\n          }\r\n        });\r\n      });\r\n    });\r\n\r\n    // Find the chat container and observe it\r\n    const chatContainer = document.querySelector('.chat-content') || \r\n                         document.querySelector('.chatlog') || \r\n                         document.querySelector('#textchat') ||\r\n                         document.querySelector('.chat');\r\n\r\n    if (chatContainer) {\r\n      chatObserver.observe(chatContainer, {\r\n        childList: true,\r\n        subtree: true\r\n      });\r\n      debug.log('\uD83D\uDC51 Started listening for character broadcasts in chat');\r\n    } else {\r\n      debug.warn('\u26A0\uFE0F Could not find chat container for character broadcast listener');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parse character broadcast message and import data\r\n   */\r\n  function parseCharacterBroadcast(message) {\r\n    try {\r\n      // Extract the encoded data\r\n      const match = message.match(/\uD83D\uDC51\\[ROLLCLOUD:CHARACTER:(.+?)\\]\uD83D\uDC51/);\r\n      if (!match) {\r\n        debug.warn('\u26A0\uFE0F Invalid character broadcast format');\r\n        return;\r\n      }\r\n\r\n      const encodedData = match[1];\r\n      const decodedData = JSON.parse(decodeURIComponent(escape(atob(encodedData))));\r\n      \r\n      if (decodedData.type !== 'ROLLCLOUD_CHARACTER_BROADCAST') {\r\n        debug.warn('\u26A0\uFE0F Not a character broadcast message');\r\n        return;\r\n      }\r\n\r\n      const character = decodedData.character;\r\n      const fullSheet = decodedData.fullSheet || character; // Use full sheet if available\r\n      debug.log('\uD83D\uDC51 Received character broadcast:', character.name);\r\n      debug.log('\uD83D\uDD0D Full sheet data keys:', fullSheet ? Object.keys(fullSheet) : 'null');\r\n      debug.log('\uD83D\uDD0D Full sheet sample:', fullSheet ? JSON.stringify(fullSheet, null, 2).substring(0, 500) + '...' : 'null');\r\n\r\n      // Import COMPLETE character data to GM panel\r\n      updatePlayerData(character.name, fullSheet);\r\n      \r\n      // Show notification to GM\r\n      debug.log(`\u2705 ${character.name} shared their character sheet! \uD83D\uDC51`);\r\n      \r\n    } catch (error) {\r\n      debug.error('\u274C Error parsing character broadcast:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Make element draggable with boundary constraints\r\n   */\r\n  function makeDraggable(element, handle) {\r\n    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;\r\n    handle.onmousedown = dragMouseDown;\r\n\r\n    function dragMouseDown(e) {\r\n      e.preventDefault();\r\n      pos3 = e.clientX;\r\n      pos4 = e.clientY;\r\n      document.onmouseup = closeDragElement;\r\n      document.onmousemove = elementDrag;\r\n    }\r\n\r\n    function elementDrag(e) {\r\n      e.preventDefault();\r\n      pos1 = pos3 - e.clientX;\r\n      pos2 = pos4 - e.clientY;\r\n      pos3 = e.clientX;\r\n      pos4 = e.clientY;\r\n\r\n      // Use requestAnimationFrame to avoid forced reflow\r\n      requestAnimationFrame(() => {\r\n        // Read layout properties first (batched reads)\r\n        const offsetTop = element.offsetTop;\r\n        const offsetLeft = element.offsetLeft;\r\n        const offsetWidth = element.offsetWidth;\r\n        const offsetHeight = element.offsetHeight;\r\n        const viewportWidth = window.innerWidth;\r\n        const viewportHeight = window.innerHeight;\r\n\r\n        // Calculate new position\r\n        let newTop = offsetTop - pos2;\r\n        let newLeft = offsetLeft - pos1;\r\n\r\n        // Apply boundary constraints\r\n        const minTop = 0;\r\n        const minLeft = 0;\r\n        const maxLeft = viewportWidth - offsetWidth;\r\n        const maxTop = viewportHeight - offsetHeight;\r\n\r\n        // Constrain within viewport\r\n        newTop = Math.max(minTop, Math.min(newTop, maxTop));\r\n        newLeft = Math.max(minLeft, Math.min(newLeft, maxLeft));\r\n\r\n        // Batch all style writes together\r\n        element.style.top = newTop + \"px\";\r\n        element.style.left = newLeft + \"px\";\r\n        element.style.right = 'auto';\r\n      });\r\n    }\r\n\r\n    function closeDragElement() {\r\n      document.onmouseup = null;\r\n      document.onmousemove = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Attach event listeners to GM panel controls\r\n   */\r\n  function attachGMPanelListeners() {\r\n    // Silent rolls toggle\r\n    const silentRollsToggle = document.getElementById('silent-rolls-toggle');\r\n    if (silentRollsToggle) {\r\n      silentRollsToggle.addEventListener('change', (e) => {\r\n        silentRollsEnabled = e.target.checked;\r\n        debug.log(`\uD83D\uDD07 Silent rolls ${silentRollsEnabled ? 'enabled' : 'disabled'}`);\r\n        \r\n        // Update hidden rolls tab description\r\n        const hiddenRollsTab = gmPanel.querySelector('[data-tab=\"hidden-rolls\"]');\r\n        if (hiddenRollsTab) {\r\n          const description = hiddenRollsTab.querySelector('p:nth-child(2)');\r\n          if (description) {\r\n            description.textContent = silentRollsEnabled \r\n              ? 'Rolls made while silent rolls is enabled will appear here'\r\n              : 'Rolls made while GM Mode is active will appear here';\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    // Tab switching\r\n    const tabButtons = gmPanel.querySelectorAll('.gm-tab-btn');\r\n    const tabContents = gmPanel.querySelectorAll('.gm-tab-content');\r\n\r\n    tabButtons.forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        const targetTab = btn.dataset.tab;\r\n\r\n        // Update button styles\r\n        tabButtons.forEach(b => {\r\n          if (b.dataset.tab === targetTab) {\r\n            b.style.background = '#2a2a2a';\r\n            b.style.color = '#FC57F9';\r\n            b.style.borderBottom = '3px solid #FC57F9';\r\n          } else {\r\n            b.style.background = 'transparent';\r\n            b.style.color = '#888';\r\n            b.style.borderBottom = '3px solid transparent';\r\n          }\r\n        });\r\n\r\n        // Show target tab content, hide others\r\n        tabContents.forEach(content => {\r\n          content.style.display = content.dataset.tab === targetTab ? 'block' : 'none';\r\n        });\r\n\r\n        debug.log(`\uD83D\uDCD1 Switched to GM tab: ${targetTab}`);\r\n      });\r\n    });\r\n\r\n    // Close button\r\n    const closeBtn = document.getElementById('gm-panel-close');\r\n    if (closeBtn) {\r\n      closeBtn.addEventListener('click', () => toggleGMMode(false));\r\n    }\r\n\r\n    // Turn controls\r\n    const startCombatBtn = document.getElementById('start-combat-btn');\r\n    const nextBtn = document.getElementById('next-turn-btn');\r\n    const prevBtn = document.getElementById('prev-turn-btn');\r\n    const clearAllBtn = document.getElementById('clear-all-btn');\r\n\r\n    debug.log('\uD83D\uDD0D GM Panel controls found:', {\r\n      startCombatBtn: !!startCombatBtn,\r\n      nextBtn: !!nextBtn,\r\n      prevBtn: !!prevBtn,\r\n      clearAllBtn: !!clearAllBtn\r\n    });\r\n\r\n    if (startCombatBtn) startCombatBtn.addEventListener('click', startCombat);\r\n    if (nextBtn) nextBtn.addEventListener('click', nextTurn);\r\n    if (prevBtn) prevBtn.addEventListener('click', prevTurn);\r\n    if (clearAllBtn) clearAllBtn.addEventListener('click', clearAllCombatants);\r\n\r\n    // Collapsible add form toggle\r\n    const addFormHeader = gmPanel.querySelector('div[style*=\"cursor: pointer\"]');\r\n    const addForm = document.getElementById('add-combatant-form');\r\n    const addFormToggle = document.getElementById('add-form-toggle');\r\n    let isFormCollapsed = true; // Start collapsed\r\n\r\n    if (addFormHeader && addForm && addFormToggle) {\r\n      addFormHeader.addEventListener('click', () => {\r\n        isFormCollapsed = !isFormCollapsed;\r\n        if (isFormCollapsed) {\r\n          addForm.style.maxHeight = '0';\r\n          addForm.style.opacity = '0';\r\n          addFormToggle.style.transform = 'rotate(-90deg)';\r\n        } else {\r\n          addForm.style.maxHeight = '500px';\r\n          addForm.style.opacity = '1';\r\n          addFormToggle.style.transform = 'rotate(0deg)';\r\n        }\r\n      });\r\n    }\r\n\r\n    // Add combatant form\r\n    const addBtn = document.getElementById('add-combatant-btn');\r\n    const nameInput = document.getElementById('combatant-name-input');\r\n    const initInput = document.getElementById('combatant-init-input');\r\n\r\n    if (addBtn && nameInput && initInput) {\r\n      addBtn.addEventListener('click', () => {\r\n        const name = nameInput.value.trim();\r\n        const initiative = parseInt(initInput.value);\r\n        if (name && !isNaN(initiative)) {\r\n          addCombatant(name, initiative, 'manual');\r\n          nameInput.value = '';\r\n          initInput.value = '';\r\n        }\r\n      });\r\n\r\n      // Enter key to add\r\n      initInput.addEventListener('keypress', (e) => {\r\n        if (e.key === 'Enter') {\r\n          addBtn.click();\r\n        }\r\n      });\r\n    }\r\n\r\n    // Export turn history button\r\n    const exportHistoryBtn = document.getElementById('export-history-btn');\r\n    if (exportHistoryBtn) {\r\n      exportHistoryBtn.addEventListener('click', exportTurnHistory);\r\n    }\r\n\r\n    // Import players button\r\n    const importPlayersBtn = document.getElementById('import-players-btn');\r\n    if (importPlayersBtn) {\r\n      importPlayersBtn.addEventListener('click', importPlayerData);\r\n    }\r\n\r\n    // Refresh players button\r\n    const refreshPlayersBtn = document.getElementById('refresh-players-btn');\r\n    if (refreshPlayersBtn) {\r\n      refreshPlayersBtn.addEventListener('click', () => {\r\n        updatePlayerOverviewDisplay();\r\n        debug.log('\uD83D\uDD04 Refreshed player overview');\r\n      });\r\n    }\r\n\r\n    debug.log('\u2705 GM Panel listeners attached');\r\n  }\r\n\r\n  /**\r\n   * Update Hidden Rolls Display\r\n   */\r\n  function updateHiddenRollsDisplay() {\r\n    const hiddenRollsList = document.getElementById('hidden-rolls-list');\r\n    if (!hiddenRollsList) return;\r\n\r\n    if (hiddenRolls.length === 0) {\r\n      hiddenRollsList.innerHTML = '';\r\n      // Show empty state if tab content exists\r\n      const tabContent = gmPanel.querySelector('[data-tab=\"hidden-rolls\"]');\r\n      if (tabContent) {\r\n        const emptyState = tabContent.querySelector('div[style*=\"text-align: center\"]');\r\n        if (emptyState) emptyState.style.display = 'block';\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Hide empty state\r\n    const tabContent = gmPanel.querySelector('[data-tab=\"hidden-rolls\"]');\r\n    if (tabContent) {\r\n      const emptyState = tabContent.querySelector('div[style*=\"text-align: center\"]');\r\n      if (emptyState) emptyState.style.display = 'none';\r\n    }\r\n\r\n    hiddenRollsList.innerHTML = hiddenRolls.map((roll, index) => `\r\n      <div style=\"background: #34495e; padding: 12px; border-radius: 8px; border-left: 4px solid #f39c12;\">\r\n        <div style=\"display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;\">\r\n          <div style=\"flex: 1;\">\r\n            <div style=\"font-weight: bold; color: #f39c12; margin-bottom: 4px;\">${roll.characterName}</div>\r\n            <div style=\"font-size: 0.9em; color: #ccc;\">${roll.name}</div>\r\n            <div style=\"font-size: 0.85em; color: #888; margin-top: 4px;\">${roll.timestamp}</div>\r\n          </div>\r\n          <div style=\"font-size: 1.2em; color: #f39c12;\">\uD83D\uDD12</div>\r\n        </div>\r\n        <div style=\"background: #2c3e50; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 0.9em; margin-bottom: 10px;\">\r\n          ${roll.formula}\r\n        </div>\r\n        <div style=\"display: flex; gap: 8px;\">\r\n          <button class=\"reveal-roll-btn\" data-roll-id=\"${roll.id}\" style=\"flex: 1; padding: 8px; background: #c2185b; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em;\">\r\n            \uD83D\uDCE2 Publish Roll\r\n          </button>\r\n          <button class=\"delete-roll-btn\" data-roll-id=\"${roll.id}\" style=\"padding: 8px 12px; background: #e74c3c; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em;\">\r\n            \uD83D\uDDD1\uFE0F\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `).join('');\r\n\r\n    // Add event listeners to reveal and delete roll buttons\r\n    const revealRollBtns = hiddenRollsList.querySelectorAll('.reveal-roll-btn');\r\n    const deleteRollBtns = hiddenRollsList.querySelectorAll('.delete-roll-btn');\r\n\r\n    revealRollBtns.forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        const rollId = btn.dataset.rollId;\r\n        revealHiddenRoll(rollId);\r\n      });\r\n    });\r\n\r\n    deleteRollBtns.forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        const rollId = btn.dataset.rollId;\r\n        deleteHiddenRoll(rollId);\r\n      });\r\n    });\r\n\r\n    debug.log(`\uD83D\uDCCB Updated hidden rolls display: ${hiddenRolls.length} rolls`);\r\n  }\r\n\r\n  /**\r\n   * Reveal a hidden roll (post it to Roll20 chat)\r\n   */\r\n  window.revealHiddenRoll = function(rollId) {\r\n    const rollIndex = hiddenRolls.findIndex(r => r.id === rollId);\r\n    if (rollIndex === -1) return;\r\n\r\n    const roll = hiddenRolls[rollIndex];\r\n    debug.log('\uD83D\uDD13 Revealing hidden roll:', roll);\r\n\r\n    // Format the message as \"GM roll: [Name] rolled [roll name]! **[calculated value]**\"\r\n    // Use Roll20's inline roll syntax [[formula]] to evaluate the roll\r\n    const formattedMessage = `GM roll: **${roll.characterName}** rolled ${roll.name}! **[[${roll.formula}]]**`;\r\n    const success = postChatMessage(formattedMessage);\r\n\r\n    if (success) {\r\n      debug.log('\u2705 Hidden roll revealed to Roll20');\r\n      // Remove from hidden rolls\r\n      hiddenRolls.splice(rollIndex, 1);\r\n      updateHiddenRollsDisplay();\r\n    } else {\r\n      debug.error('\u274C Failed to reveal hidden roll');\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Delete a hidden roll without revealing\r\n   */\r\n  window.deleteHiddenRoll = function(rollId) {\r\n    const rollIndex = hiddenRolls.findIndex(r => r.id === rollId);\r\n    if (rollIndex === -1) return;\r\n\r\n    hiddenRolls.splice(rollIndex, 1);\r\n    updateHiddenRollsDisplay();\r\n    debug.log('\uD83D\uDDD1\uFE0F Deleted hidden roll');\r\n  };\r\n\r\n  /**\r\n   * Create player header HTML\r\n   */\r\n  function createPlayerHeader(name, player, playerId) {\r\n    const hpPercent = player.maxHp > 0 ? (player.hp / player.maxHp) * 100 : 0;\r\n    const hpColor = hpPercent > 50 ? '#c2185b' : hpPercent > 25 ? '#f39c12' : '#e74c3c';\r\n    \r\n    return `\r\n      <div style=\"background: #34495e; border-radius: 8px; border-left: 4px solid ${hpColor}; overflow: hidden;\">\r\n        <!-- Player Header (always visible) -->\r\n        <div class=\"player-header-btn\" data-player-name=\"${name}\" style=\"padding: 12px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;\" onmouseover=\"this.style.background='#3d5a6e'\" onmouseout=\"this.style.background='transparent'\">\r\n          <div style=\"flex: 1;\">\r\n            <div style=\"font-weight: bold; font-size: 1.1em; color: #FC57F9; margin-bottom: 4px;\">${name}</div>\r\n            <div style=\"display: flex; gap: 12px; font-size: 0.95em; color: #ccc;\">\r\n              <span>HP: ${player.hp}/${player.maxHp}</span>\r\n              <span>AC: ${player.ac || '\u2014'}</span>\r\n              <span>Init: ${player.initiative || '\u2014'}</span>\r\n            </div>\r\n          </div>\r\n          <div style=\"display: flex; align-items: center; gap: 8px;\">\r\n            <span id=\"${playerId}-toggle\" style=\"transition: transform 0.3s; transform: rotate(-90deg); color: #888; font-size: 1.1em;\">\u25BC</span>\r\n            <button class=\"player-delete-btn\" data-player-name=\"${name}\" style=\"padding: 4px 8px; background: #e74c3c; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: bold;\" title=\"Remove player\">\uD83D\uDDD1\uFE0F</button>\r\n          </div>\r\n        </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Update Player Overview Display\r\n   */\r\n  function updatePlayerOverviewDisplay() {\r\n    const playerOverviewList = document.getElementById('player-overview-list');\r\n    if (!playerOverviewList) return;\r\n\r\n    const players = Object.keys(playerData);\r\n\r\n    if (players.length === 0) {\r\n      playerOverviewList.innerHTML = '';\r\n      // Show empty state\r\n      const tabContent = gmPanel.querySelector('[data-tab=\"players\"]');\r\n      if (tabContent) {\r\n        const emptyState = tabContent.querySelector('div[style*=\"text-align: center\"]');\r\n        if (emptyState) emptyState.style.display = 'block';\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Hide empty state\r\n    const tabContent = gmPanel.querySelector('[data-tab=\"players\"]');\r\n    if (tabContent) {\r\n      const emptyState = tabContent.querySelector('div[style*=\"text-align: center\"]');\r\n      if (emptyState) emptyState.style.display = 'none';\r\n    }\r\n\r\n    playerOverviewList.innerHTML = players.map((name, index) => {\r\n      const player = playerData[name];\r\n      const playerId = `player-${index}`;\r\n      const hpPercent = player.maxHp > 0 ? (player.hp / player.maxHp) * 100 : 0;\r\n      const hpColor = hpPercent > 50 ? '#c2185b' : hpPercent > 25 ? '#f39c12' : '#e74c3c';\r\n\r\n      return createPlayerHeader(name, player, playerId) + `\r\n\r\n          <!-- Detailed View (collapsible) -->\r\n          <div id=\"${playerId}-details\" style=\"max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.3s ease-out;\">\r\n            <div style=\"padding: 0 12px 12px 12px;\">\r\n              <!-- Character Sub-tabs -->\r\n              <div style=\"display: flex; gap: 4px; margin-bottom: 10px; border-bottom: 1px solid #2c3e50;\">\r\n                <button class=\"player-subtab-btn\" data-player=\"${playerId}\" data-subtab=\"overview\" style=\"padding: 8px 12px; background: transparent; color: #FC57F9; border: none; border-bottom: 2px solid #FC57F9; cursor: pointer; font-size: 0.9em; font-weight: bold;\">Overview</button>\r\n                <button class=\"player-subtab-btn\" data-player=\"${playerId}\" data-subtab=\"combat\" style=\"padding: 8px 12px; background: transparent; color: #888; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 0.9em;\">Combat</button>\r\n                <button class=\"player-subtab-btn\" data-player=\"${playerId}\" data-subtab=\"status\" style=\"padding: 8px 12px; background: transparent; color: #888; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 0.9em;\">Status</button>\r\n              </div>\r\n\r\n              <!-- Overview Tab -->\r\n              <div class=\"player-subtab-content\" data-player=\"${playerId}\" data-subtab=\"overview\" style=\"display: block;\">\r\n                <!-- HP Bar -->\r\n                <div style=\"margin-bottom: 10px;\">\r\n                  <div style=\"display: flex; justify-content: space-between; font-size: 0.95em; color: #ccc; margin-bottom: 4px;\">\r\n                    <span>Hit Points</span>\r\n                    <span>${player.hp}/${player.maxHp}</span>\r\n                  </div>\r\n                  <div style=\"width: 100%; height: 12px; background: #2c3e50; border-radius: 5px; overflow: hidden;\">\r\n                    <div style=\"width: ${hpPercent}%; height: 100%; background: ${hpColor}; transition: width 0.3s;\"></div>\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- Stats Grid -->\r\n                <div style=\"display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;\">\r\n                  <div style=\"background: #2c3e50; padding: 8px; border-radius: 4px; text-align: center;\">\r\n                    <div style=\"font-size: 0.85em; color: #888;\">Armor Class</div>\r\n                    <div style=\"font-weight: bold; color: #fff; font-size: 1.3em;\">${player.ac || '\u2014'}</div>\r\n                  </div>\r\n                  <div style=\"background: #2c3e50; padding: 8px; border-radius: 4px; text-align: center;\">\r\n                    <div style=\"font-size: 0.85em; color: #888;\">Passive Perception</div>\r\n                    <div style=\"font-weight: bold; color: #fff; font-size: 1.3em;\">${player.passivePerception || '\u2014'}</div>\r\n                  </div>\r\n                  <div style=\"background: #2c3e50; padding: 8px; border-radius: 4px; text-align: center;\">\r\n                    <div style=\"font-size: 0.85em; color: #888;\">Initiative</div>\r\n                    <div style=\"font-weight: bold; color: #fff; font-size: 1.3em;\">${player.initiative || '\u2014'}</div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <!-- Combat Tab -->\r\n              <div class=\"player-subtab-content\" data-player=\"${playerId}\" data-subtab=\"combat\" style=\"display: none;\">\r\n                <div style=\"background: #2c3e50; padding: 10px; border-radius: 4px; margin-bottom: 8px;\">\r\n                  <div style=\"font-size: 0.95em; color: #888; margin-bottom: 6px;\">Attack Roll</div>\r\n                  <div style=\"font-size: 0.9em; color: #ccc;\">Click character sheet to make attacks</div>\r\n                </div>\r\n                <div style=\"background: #2c3e50; padding: 10px; border-radius: 4px;\">\r\n                  <div style=\"font-size: 0.95em; color: #888; margin-bottom: 6px;\">Combat Stats</div>\r\n                  <div style=\"display: flex; justify-content: space-between; margin-bottom: 4px;\">\r\n                    <span style=\"font-size: 0.9em; color: #ccc;\">AC:</span>\r\n                    <span style=\"font-size: 0.9em; color: #fff; font-weight: bold;\">${player.ac || '\u2014'}</span>\r\n                  </div>\r\n                  <div style=\"display: flex; justify-content: space-between;\">\r\n                    <span style=\"font-size: 0.9em; color: #ccc;\">Initiative:</span>\r\n                    <span style=\"font-size: 0.9em; color: #fff; font-weight: bold;\">${player.initiative || '\u2014'}</span>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <!-- Status Tab -->\r\n              <div class=\"player-subtab-content\" data-player=\"${playerId}\" data-subtab=\"status\" style=\"display: none;\">\r\n                <!-- Conditions -->\r\n                ${player.conditions && player.conditions.length > 0 ? `\r\n                  <div style=\"margin-bottom: 10px;\">\r\n                    <div style=\"font-size: 0.95em; color: #888; margin-bottom: 6px;\">Active Conditions</div>\r\n                    <div style=\"display: flex; flex-wrap: wrap; gap: 6px;\">\r\n                      ${player.conditions.map(c => `<span style=\"background: #e74c3c; padding: 5px 12px; border-radius: 4px; font-size: 0.9em; font-weight: bold;\">${c}</span>`).join('')}\r\n                    </div>\r\n                  </div>\r\n                ` : '<div style=\"padding: 10px; text-align: center; color: #888; font-size: 0.95em;\">No active conditions</div>'}\r\n\r\n                <!-- Concentration -->\r\n                ${player.concentrationSpell ? `\r\n                  <div style=\"background: #9b59b6; padding: 10px; border-radius: 4px; margin-bottom: 10px;\">\r\n                    <div style=\"font-size: 0.95em; font-weight: bold; margin-bottom: 4px;\">\uD83E\uDDE0 Concentrating</div>\r\n                    <div style=\"font-size: 0.9em;\">${player.concentrationSpell}</div>\r\n                  </div>\r\n                ` : ''}\r\n\r\n                <!-- Death Saves (if unconscious) -->\r\n                ${player.deathSaves ? `\r\n                  <div style=\"background: #c0392b; padding: 10px; border-radius: 4px;\">\r\n                    <div style=\"font-size: 0.95em; font-weight: bold; margin-bottom: 6px;\">\uD83D\uDC80 Death Saving Throws</div>\r\n                    <div style=\"display: flex; justify-content: space-around; font-size: 0.9em;\">\r\n                      <div>\r\n                        <div style=\"color: #c2185b; font-weight: bold;\">Successes</div>\r\n                        <div style=\"font-size: 1.3em; text-align: center;\">\u2713 ${player.deathSaves.successes || 0}</div>\r\n                      </div>\r\n                      <div>\r\n                        <div style=\"color: #e74c3c; font-weight: bold;\">Failures</div>\r\n                        <div style=\"font-size: 1.3em; text-align: center;\">\u2717 ${player.deathSaves.failures || 0}</div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                ` : ''}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      `;\r\n    }).join('');\r\n\r\n    debug.log(`\uD83D\uDC65 Updated player overview: ${players.length} players`);\r\n\r\n    // Add event listeners for player header buttons\r\n    document.querySelectorAll('.player-header-btn').forEach(btn => {\r\n      btn.addEventListener('click', (e) => {\r\n        const playerName = btn.dataset.playerName;\r\n        showFullCharacterModal(playerName);\r\n      });\r\n    });\r\n\r\n    // Add event listeners for delete buttons\r\n    document.querySelectorAll('.player-delete-btn').forEach(btn => {\r\n      btn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        const playerName = btn.dataset.playerName;\r\n        deletePlayerFromGM(playerName);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update player data from character sheet\r\n   */\r\n  function updatePlayerData(characterName, data) {\r\n    if (!playerData[characterName]) {\r\n      playerData[characterName] = {};\r\n    }\r\n\r\n    // Merge new data\r\n    Object.assign(playerData[characterName], data);\r\n\r\n    // Save to storage\r\n    savePlayerDataToStorage();\r\n\r\n    // Update display if GM panel is open\r\n    if (gmModeEnabled) {\r\n      updatePlayerOverviewDisplay();\r\n    }\r\n\r\n    debug.log(`\uD83D\uDC64 Updated player data for ${characterName}:`, playerData[characterName]);\r\n  }\r\n\r\n  /**\r\n   * Save player data to storage\r\n   */\r\n  function savePlayerDataToStorage() {\r\n    debug.log('\uD83D\uDCBE Attempting to save player data:', Object.keys(playerData));\r\n\r\n    // First, load existing characterProfiles to avoid overwriting synced character data\r\n    return browserAPI.storage.local.get(['characterProfiles']).then(result => {\r\n      const existingProfiles = result.characterProfiles || {};\r\n\r\n      // Remove old rollcloudPlayer entries first\r\n      Object.keys(existingProfiles).forEach(key => {\r\n        if (existingProfiles[key].type === 'rollcloudPlayer') {\r\n          delete existingProfiles[key];\r\n        }\r\n      });\r\n\r\n      // Add current player data to existing profiles\r\n      Object.keys(playerData).forEach(playerName => {\r\n        existingProfiles[playerName] = {\r\n          ...playerData[playerName],\r\n          type: 'rollcloudPlayer',\r\n          lastUpdated: new Date().toISOString()\r\n        };\r\n        debug.log(`\uD83D\uDCBE Preparing to save player: ${playerName}, type: rollcloudPlayer`);\r\n      });\r\n\r\n      // Save merged data back to storage (convert callback-based to Promise-based)\r\n      return new Promise((resolve, reject) => {\r\n        browserAPI.storage.local.set({\r\n          characterProfiles: existingProfiles\r\n        }, () => {\r\n          if (browserAPI.runtime.lastError) {\r\n            debug.error('\u274C Error saving to storage:', browserAPI.runtime.lastError);\r\n            reject(browserAPI.runtime.lastError);\r\n          } else {\r\n            debug.log('\u2705 Successfully saved player data to characterProfiles storage');\r\n            debug.log('\uD83D\uDCBE Total profiles in storage:', Object.keys(existingProfiles).length);\r\n            resolve();\r\n          }\r\n        });\r\n      });\r\n    }).catch(error => {\r\n      debug.error('\u274C Error reading existing profiles before save:', error);\r\n      throw error;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Load player data from storage\r\n   */\r\n  function loadPlayerDataFromStorage() {\r\n    return browserAPI.storage.local.get(['characterProfiles']).then(result => {\r\n      if (result.characterProfiles) {\r\n        // Load only rollcloudPlayer entries from characterProfiles\r\n        playerData = {};\r\n        Object.keys(result.characterProfiles).forEach(key => {\r\n          const profile = result.characterProfiles[key];\r\n          if (profile.type === 'rollcloudPlayer') {\r\n            playerData[key] = profile;\r\n          }\r\n        });\r\n\r\n        debug.log(`\uD83D\uDCC2 Loaded ${Object.keys(playerData).length} GM players from storage`);\r\n\r\n        // Update display if GM panel is open\r\n        if (gmModeEnabled) {\r\n          updatePlayerOverviewDisplay();\r\n        }\r\n      }\r\n    }).catch(error => {\r\n      debug.error('\u274C Error loading player data from storage:', error);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Delete player data\r\n   */\r\n  function deletePlayerData(characterName) {\r\n    if (playerData[characterName]) {\r\n      delete playerData[characterName];\r\n      \r\n      // Save to storage\r\n      savePlayerDataToStorage();\r\n      \r\n      // Update display if GM panel is open\r\n      if (gmModeEnabled) {\r\n        updatePlayerOverviewDisplay();\r\n      }\r\n      \r\n      debug.log(`\uD83D\uDDD1\uFE0F Deleted player data for ${characterName}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete player from GM panel\r\n   */\r\n  window.deletePlayerFromGM = function(characterName) {\r\n    if (confirm(`Remove ${characterName} from GM Panel?`)) {\r\n      deletePlayerData(characterName);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Toggle player details expansion\r\n   */\r\n  window.togglePlayerDetails = function(playerId) {\r\n    const details = document.getElementById(`${playerId}-details`);\r\n    const toggle = document.getElementById(`${playerId}-toggle`);\r\n\r\n    if (!details || !toggle) return;\r\n\r\n    const isExpanded = details.style.maxHeight && details.style.maxHeight !== '0px';\r\n\r\n    if (isExpanded) {\r\n      // Collapse\r\n      details.style.maxHeight = '0';\r\n      details.style.opacity = '0';\r\n      toggle.style.transform = 'rotate(-90deg)';\r\n    } else {\r\n      // Expand\r\n      details.style.maxHeight = '1000px';\r\n      details.style.opacity = '1';\r\n      toggle.style.transform = 'rotate(0deg)';\r\n\r\n      // Attach sub-tab listeners for this player\r\n      attachPlayerSubtabListeners(playerId);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Show full character sheet as popout window\r\n   */\r\n  window.showFullCharacterModal = function(playerName) {\r\n    const player = playerData[playerName];\r\n    if (!player) {\r\n      debug.warn(`\u26A0\uFE0F No data found for player: ${playerName}`);\r\n      return;\r\n    }\r\n\r\n    // Check if ANY popup is currently open (enforce single popup limit)\r\n    const openPopups = Object.entries(characterPopups).filter(([name, popup]) => popup && !popup.closed);\r\n\r\n    if (openPopups.length > 0) {\r\n      const [existingPlayerName, existingPopup] = openPopups[0];\r\n\r\n      // If the same character is already open, just focus it\r\n      if (existingPlayerName === playerName) {\r\n        existingPopup.focus();\r\n        debug.log(`\uD83D\uDC41\uFE0F Focused existing character popup for ${playerName}`);\r\n        return;\r\n      }\r\n\r\n      // Different character - close the existing popup and open the new one\r\n      debug.log(`\uD83D\uDD04 Closing popup for ${existingPlayerName} to open ${playerName}`);\r\n      existingPopup.close();\r\n      delete characterPopups[existingPlayerName];\r\n    }\r\n\r\n    // Create popout window and load the EXISTING popup-sheet.html file\r\n    const popup = window.open(browserAPI.runtime.getURL('src/popup-sheet.html'), `character-${playerName}`, 'width=900,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no');\r\n\r\n    if (!popup) {\r\n      debug.error('\u274C Failed to open popup window - please allow popups for this site');\r\n      return;\r\n    }\r\n\r\n    // Track the popup\r\n    characterPopups[playerName] = popup;\r\n\r\n    // Store player data for the popup to request\r\n    window.currentPopoutPlayer = player;\r\n    window.currentPopoutPlayerName = playerName;\r\n\r\n    // Listen for data requests from the popup\r\n    window.addEventListener('message', function(event) {\r\n      if (event.data && event.data.action === 'requestCharacterData') {\r\n        // Send the character data to the popup\r\n        popup.postMessage({\r\n          action: 'loadCharacterData',\r\n          characterData: window.currentPopoutPlayer\r\n        }, '*');\r\n      }\r\n    });\r\n\r\n    debug.log(`\uD83E\uDE9F Opened character popup for ${playerName}`);\r\n  };\r\n\r\n  /**\r\n   * Attach event listeners for player sub-tabs\r\n   */\r\n  function attachPlayerSubtabListeners(playerId) {\r\n    const subtabBtns = document.querySelectorAll(`.player-subtab-btn[data-player=\"${playerId}\"]`);\r\n    const subtabContents = document.querySelectorAll(`.player-subtab-content[data-player=\"${playerId}\"]`);\r\n\r\n    subtabBtns.forEach(btn => {\r\n      // Remove existing listener if any\r\n      btn.replaceWith(btn.cloneNode(true));\r\n    });\r\n\r\n    // Re-query after replacing\r\n    const newSubtabBtns = document.querySelectorAll(`.player-subtab-btn[data-player=\"${playerId}\"]`);\r\n\r\n    newSubtabBtns.forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        const targetSubtab = btn.dataset.subtab;\r\n\r\n        // Update button styles\r\n        newSubtabBtns.forEach(b => {\r\n          if (b.dataset.subtab === targetSubtab) {\r\n            b.style.color = '#FC57F9';\r\n            b.style.borderBottom = '2px solid #FC57F9';\r\n          } else {\r\n            b.style.color = '#888';\r\n            b.style.borderBottom = '2px solid transparent';\r\n          }\r\n        });\r\n\r\n        // Show target content, hide others\r\n        subtabContents.forEach(content => {\r\n          content.style.display = content.dataset.subtab === targetSubtab ? 'block' : 'none';\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Import player data from chrome storage\r\n   */\r\n  function importPlayerData() {\r\n    debug.log('\uD83D\uDCE5 Importing player data from storage...');\r\n\r\n    chrome.storage.local.get(['characterProfiles'], (result) => {\r\n      if (chrome.runtime.lastError) {\r\n        debug.error('\u274C Failed to import player data:', chrome.runtime.lastError);\r\n        postChatMessage('\u274C Failed to import character data');\r\n        return;\r\n      }\r\n\r\n      const characterProfiles = result.characterProfiles || {};\r\n      const profileKeys = Object.keys(characterProfiles);\r\n\r\n      if (profileKeys.length === 0) {\r\n        debug.log('\u26A0\uFE0F No character profiles found in storage');\r\n        postChatMessage('\u26A0\uFE0F No character data found. Please sync a character from Dice Cloud first.');\r\n        return;\r\n      }\r\n\r\n      // Clear existing player data\r\n      playerData = {};\r\n\r\n      // Import each character profile\r\n      profileKeys.forEach(profileId => {\r\n        const character = characterProfiles[profileId];\r\n\r\n        if (!character || !character.name) {\r\n          debug.warn(`\u26A0\uFE0F Skipping invalid character profile: ${profileId}`);\r\n          return;\r\n        }\r\n\r\n        // Import complete character data\r\n        playerData[character.name] = {\r\n          // Basic stats\r\n          hp: character.hp?.current ?? character.hitPoints?.current ?? 0,\r\n          maxHp: character.hp?.max ?? character.hitPoints?.max ?? 0,\r\n          ac: character.armorClass ?? character.ac ?? 10,\r\n          initiative: character.initiative ?? 0,\r\n          passivePerception: character.passivePerception ?? 10,\r\n          proficiency: character.proficiency ?? 0,\r\n          speed: character.speed ?? '30 ft',\r\n          \r\n          // Character info\r\n          name: character.name,\r\n          class: character.class || 'Unknown',\r\n          level: character.level || 1,\r\n          race: character.race || 'Unknown',\r\n          hitDice: character.hitDice || '10',\r\n          \r\n          // Abilities\r\n          attributes: character.attributes || {\r\n            strength: 10,\r\n            dexterity: 10,\r\n            constitution: 10,\r\n            intelligence: 10,\r\n            wisdom: 10,\r\n            charisma: 10\r\n          },\r\n          \r\n          // Skills\r\n          skills: character.skills || [],\r\n          \r\n          // Actions\r\n          actions: character.actions || [],\r\n          \r\n          // Combat status\r\n          conditions: character.conditions || [],\r\n          concentration: character.concentration || null,\r\n          deathSaves: character.deathSaves || null,\r\n          \r\n          // Type marking for storage\r\n          type: 'rollcloudPlayer',\r\n          lastUpdated: new Date().toISOString()\r\n        };\r\n\r\n        debug.log(`\u2705 Imported player: ${character.name} (HP: ${character.hp?.current ?? character.hitPoints?.current ?? 0}/${character.hp?.max ?? character.hitPoints?.max ?? 0}, AC: ${character.armorClass ?? character.ac ?? 10})`);\r\n      });\r\n\r\n      // Update display\r\n      updatePlayerOverviewDisplay();\r\n\r\n      const playerCount = Object.keys(playerData).length;\r\n      debug.log(`\u2705 Successfully imported ${playerCount} player(s)`);\r\n      postChatMessage(`\u2705 GM imported ${playerCount} character(s) to party overview`);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Export player data to clipboard\r\n   */\r\n  function exportPlayerData() {\r\n    if (Object.keys(playerData).length === 0) {\r\n      debug.log('\u26A0\uFE0F No player data to export');\r\n      return;\r\n    }\r\n\r\n    const exportText = Object.keys(playerData).map(name => {\r\n      const player = playerData[name];\r\n      return `**${name}**\r\nHP: ${player.hp}/${player.maxHp}\r\nAC: ${player.ac || '\u2014'}\r\nInitiative: ${player.initiative || '\u2014'}\r\nPassive Perception: ${player.passivePerception || '\u2014'}\r\n${player.conditions && player.conditions.length > 0 ? `Conditions: ${player.conditions.join(', ')}` : ''}\r\n${player.concentration ? `Concentrating: ${player.concentration}` : ''}\r\n${player.deathSaves ? `Death Saves: \u2713${player.deathSaves.successes || 0} / \u2717${player.deathSaves.failures || 0}` : ''}\r\n`;\r\n    }).join('\\n---\\n\\n');\r\n\r\n    // Copy to clipboard\r\n    navigator.clipboard.writeText(exportText).then(() => {\r\n      debug.log('\u2705 Player data copied to clipboard');\r\n      postChatMessage('\uD83D\uDCCB GM exported party overview to clipboard');\r\n    }).catch(err => {\r\n      debug.error('\u274C Failed to copy player data:', err);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Log turn action to history\r\n   */\r\n  function logTurnAction(action) {\r\n    const historyEntry = {\r\n      timestamp: new Date().toLocaleTimeString(),\r\n      round: initiativeTracker.round,\r\n      turnIndex: initiativeTracker.currentTurnIndex,\r\n      combatant: getCurrentCombatant()?.name || 'Unknown',\r\n      ...action\r\n    };\r\n\r\n    turnHistory.unshift(historyEntry); // Add to beginning\r\n    if (turnHistory.length > 10) {\r\n      turnHistory = turnHistory.slice(0, 10); // Keep only last 10\r\n    }\r\n\r\n    updateTurnHistoryDisplay();\r\n    debug.log('\uD83D\uDCDC Logged turn action:', historyEntry);\r\n  }\r\n\r\n  /**\r\n   * Update Turn History Display\r\n   */\r\n  function updateTurnHistoryDisplay() {\r\n    const turnHistoryList = document.getElementById('turn-history-list');\r\n    const emptyState = document.getElementById('turn-history-empty-state');\r\n    if (!turnHistoryList) return;\r\n\r\n    if (turnHistory.length === 0) {\r\n      turnHistoryList.innerHTML = '';\r\n      // Show empty state\r\n      if (emptyState) emptyState.style.display = 'block';\r\n      return;\r\n    }\r\n\r\n    // Hide empty state\r\n    if (emptyState) emptyState.style.display = 'none';\r\n\r\n    turnHistoryList.innerHTML = turnHistory.map((entry, index) => {\r\n      const actionIcon = entry.action === 'attack' ? '\u2694\uFE0F' :\r\n                        entry.action === 'spell' ? '\u2728' :\r\n                        entry.action === 'damage' ? '\uD83D\uDC94' :\r\n                        entry.action === 'healing' ? '\uD83D\uDC9A' :\r\n                        entry.action === 'condition' ? '\uD83C\uDFAF' :\r\n                        entry.action === 'turn' ? '\uD83D\uDD04' : '\uD83D\uDCDD';\r\n\r\n      return `\r\n        <div style=\"background: #34495e; padding: 10px; border-radius: 6px; border-left: 4px solid #3498db;\">\r\n          <div style=\"display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;\">\r\n            <div>\r\n              <span style=\"font-weight: bold; color: #FC57F9;\">${entry.combatant}</span>\r\n              <span style=\"font-size: 0.75em; color: #888; margin-left: 8px;\">Round ${entry.round}</span>\r\n            </div>\r\n            <span style=\"font-size: 0.75em; color: #888;\">${entry.timestamp}</span>\r\n          </div>\r\n          <div style=\"display: flex; align-items: center; gap: 8px; font-size: 0.9em;\">\r\n            <span style=\"font-size: 1.2em;\">${actionIcon}</span>\r\n            <span style=\"color: #ccc;\">${entry.description}</span>\r\n          </div>\r\n          ${entry.damage ? `<div style=\"margin-top: 4px; font-size: 0.85em; color: #e74c3c;\">Damage: ${entry.damage}</div>` : ''}\r\n          ${entry.healing ? `<div style=\"margin-top: 4px; font-size: 0.85em; color: #c2185b;\">Healing: ${entry.healing}</div>` : ''}\r\n          ${entry.condition ? `<div style=\"margin-top: 4px; font-size: 0.85em; color: #f39c12;\">Condition: ${entry.condition}</div>` : ''}\r\n        </div>\r\n      `;\r\n    }).join('');\r\n\r\n    debug.log(`\uD83D\uDCDC Updated turn history: ${turnHistory.length} entries`);\r\n  }\r\n\r\n  /**\r\n   * Export turn history to clipboard\r\n   */\r\n  function exportTurnHistory() {\r\n    const historyText = turnHistory.map(entry => {\r\n      let text = `[Round ${entry.round}] ${entry.combatant} - ${entry.description}`;\r\n      if (entry.damage) text += ` (Damage: ${entry.damage})`;\r\n      if (entry.healing) text += ` (Healing: ${entry.healing})`;\r\n      if (entry.condition) text += ` (Condition: ${entry.condition})`;\r\n      return text;\r\n    }).join('\\n');\r\n\r\n    navigator.clipboard.writeText(historyText).then(() => {\r\n      postChatMessage('\uD83D\uDCCB Turn history copied to clipboard');\r\n      debug.log('\uD83D\uDCCB Turn history exported to clipboard');\r\n    }).catch(err => {\r\n      debug.error('\u274C Failed to copy turn history:', err);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Toggle GM Mode\r\n   */\r\n  function toggleGMMode(enabled) {\r\n    const previousState = gmModeEnabled;\r\n    gmModeEnabled = enabled !== undefined ? enabled : !gmModeEnabled;\r\n\r\n    debug.log(`\uD83D\uDC51 toggleGMMode called with enabled=${enabled}, previousState=${previousState}, newState=${gmModeEnabled}`);\r\n\r\n    if (!gmPanel) {\r\n      debug.log('\uD83D\uDC51 Creating GM panel...');\r\n      createGMPanel();\r\n    }\r\n\r\n    if (!gmPanel) {\r\n      debug.error('\u274C Failed to create GM panel!');\r\n      return;\r\n    }\r\n\r\n    // Use 'flex' not 'block' to maintain flexbox layout\r\n    gmPanel.style.display = gmModeEnabled ? 'flex' : 'none';\r\n\r\n    // Debug: Check if panel is actually visible\r\n    if (gmModeEnabled) {\r\n      debug.log('\uD83D\uDD0D GM Panel display set to flex');\r\n      debug.log('\uD83D\uDD0D GM Panel offsetWidth:', gmPanel.offsetWidth);\r\n      debug.log('\uD83D\uDD0D GM Panel offsetHeight:', gmPanel.offsetHeight);\r\n      debug.log('\uD83D\uDD0D GM Panel computed display:', window.getComputedStyle(gmPanel).display);\r\n      debug.log('\uD83D\uDD0D GM Panel parent:', gmPanel.parentElement);\r\n      debug.log('\uD83D\uDD0D GM Panel style:', gmPanel.style.cssText);\r\n\r\n      // Check if panel is in viewport\r\n      const rect = gmPanel.getBoundingClientRect();\r\n      debug.log('\uD83D\uDD0D GM Panel bounding rect:', rect);\r\n      debug.log('\uD83D\uDD0D Is panel in viewport:', rect.width > 0 && rect.height > 0);\r\n\r\n      // Force visibility check (especially for Firefox)\r\n      setTimeout(() => {\r\n        debug.log('\uD83D\uDD0D Delayed check - GM Panel display:', window.getComputedStyle(gmPanel).display);\r\n        debug.log('\uD83D\uDD0D Delayed check - GM Panel visible:', gmPanel.offsetWidth > 0);\r\n\r\n        // Try to force visibility if needed\r\n        if (gmPanel.offsetWidth === 0) {\r\n          debug.warn('\u26A0\uFE0F GM Panel has zero width, trying to force visibility...');\r\n          gmPanel.style.visibility = 'visible';\r\n          gmPanel.style.opacity = '1';\r\n          gmPanel.style.display = 'flex';\r\n          // Firefox sometimes needs explicit dimensions\r\n          gmPanel.style.width = '500px';\r\n          gmPanel.style.height = '600px';\r\n          debug.log('\uD83D\uDD0D Forced visibility styles applied');\r\n        }\r\n      }, 100);\r\n    }\r\n\r\n    // Visual feedback - enhance glow when active\r\n    if (gmModeEnabled) {\r\n      gmPanel.style.borderColor = '#FC57F9'; // Cyan border\r\n      gmPanel.style.boxShadow = '0 8px 32px rgba(78, 205, 196, 0.6)'; // Enhanced cyan glow when active\r\n    } else {\r\n      gmPanel.style.borderColor = '#FC57F9'; // Cyan border\r\n      gmPanel.style.boxShadow = '0 8px 32px rgba(0,0,0,0.5)'; // Default shadow\r\n    }\r\n\r\n    // Start/stop chat monitoring\r\n    if (gmModeEnabled) {\r\n      startChatMonitoring();\r\n    } else {\r\n      stopChatMonitoring();\r\n\r\n      // Close all shared character sheet popups when GM panel closes\r\n      // (but NOT the GM's own main character sheet)\r\n      Object.keys(characterPopups).forEach(characterName => {\r\n        const popup = characterPopups[characterName];\r\n        try {\r\n          if (popup && !popup.closed) {\r\n            popup.close();\r\n            debug.log(`\uD83D\uDD12 Closed shared character sheet for: ${characterName}`);\r\n          }\r\n        } catch (error) {\r\n          debug.warn(`\u26A0\uFE0F Error closing popup for ${characterName}:`, error);\r\n        }\r\n        delete characterPopups[characterName];\r\n      });\r\n      debug.log('\uD83D\uDD12 All shared character sheets closed');\r\n    }\r\n\r\n    // Post chat announcement only when state actually changes\r\n    if (previousState !== gmModeEnabled) {\r\n      const message = gmModeEnabled\r\n        ? '\uD83D\uDC51 GM Panel is now active'\r\n        : '\uD83D\uDC51 GM Panel deactivated';\r\n\r\n      // Use setTimeout to ensure the chat is ready\r\n      setTimeout(() => {\r\n        postChatMessage(message);\r\n      }, 100);\r\n    }\r\n\r\n    debug.log(`\uD83D\uDC51 GM Mode ${gmModeEnabled ? 'enabled' : 'disabled'}`);\r\n  }\r\n\r\n  /**\r\n   * Add combatant to initiative tracker\r\n   */\r\n  function addCombatant(name, initiative, source = 'chat') {\r\n    // Check if already exists\r\n    const exists = initiativeTracker.combatants.find(c => c.name === name);\r\n    if (exists) {\r\n      debug.log(`\u26A0\uFE0F Combatant ${name} already in tracker, updating initiative`);\r\n      exists.initiative = initiative;\r\n      updateInitiativeDisplay();\r\n      return;\r\n    }\r\n\r\n    initiativeTracker.combatants.push({\r\n      name,\r\n      initiative,\r\n      source\r\n    });\r\n\r\n    // Sort by initiative (highest first)\r\n    initiativeTracker.combatants.sort((a, b) => b.initiative - a.initiative);\r\n\r\n    updateInitiativeDisplay();\r\n    debug.log(`\u2705 Added combatant: ${name} (Init: ${initiative})`);\r\n  }\r\n\r\n  /**\r\n   * Remove combatant from tracker\r\n   */\r\n  function removeCombatant(name) {\r\n    const index = initiativeTracker.combatants.findIndex(c => c.name === name);\r\n    if (index !== -1) {\r\n      initiativeTracker.combatants.splice(index, 1);\r\n\r\n      // Adjust current turn index if necessary\r\n      if (initiativeTracker.currentTurnIndex >= initiativeTracker.combatants.length) {\r\n        initiativeTracker.currentTurnIndex = 0;\r\n      }\r\n\r\n      updateInitiativeDisplay();\r\n      debug.log(`\uD83D\uDDD1\uFE0F Removed combatant: ${name}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all combatants\r\n   */\r\n  function clearAllCombatants() {\r\n    if (confirm('Clear all combatants from initiative tracker?')) {\r\n      initiativeTracker.combatants = [];\r\n      initiativeTracker.currentTurnIndex = 0;\r\n      initiativeTracker.round = 1;\r\n      combatStarted = false;\r\n\r\n      // Show Start Combat button again\r\n      const startBtn = document.getElementById('start-combat-btn');\r\n      const prevBtn = document.getElementById('prev-turn-btn');\r\n      const nextBtn = document.getElementById('next-turn-btn');\r\n\r\n      if (startBtn) startBtn.style.display = 'block';\r\n      if (prevBtn) prevBtn.style.display = 'none';\r\n      if (nextBtn) nextBtn.style.display = 'none';\r\n\r\n      updateInitiativeDisplay();\r\n      postChatMessage('\uD83D\uDED1 Combat ended. Initiative tracker cleared.');\r\n      debug.log('\uD83D\uDDD1\uFE0F All combatants cleared');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start combat - initialize first turn\r\n   */\r\n  function startCombat() {\r\n    if (initiativeTracker.combatants.length === 0) {\r\n      debug.warn('\u26A0\uFE0F Cannot start combat with no combatants');\r\n      return;\r\n    }\r\n\r\n    // Reset to beginning\r\n    initiativeTracker.currentTurnIndex = 0;\r\n    initiativeTracker.round = 1;\r\n    combatStarted = true;\r\n\r\n    // Update UI\r\n    document.getElementById('round-display').textContent = 'Round 1';\r\n    const startBtn = document.getElementById('start-combat-btn');\r\n    const prevBtn = document.getElementById('prev-turn-btn');\r\n    const nextBtn = document.getElementById('next-turn-btn');\r\n\r\n    if (startBtn) {\r\n      startBtn.style.display = 'none';\r\n    }\r\n    if (prevBtn) prevBtn.style.display = 'block';\r\n    if (nextBtn) nextBtn.style.display = 'block';\r\n\r\n    updateInitiativeDisplay();\r\n    notifyCurrentTurn();\r\n\r\n    // Announce combat start\r\n    postChatMessage('\u2694\uFE0F Combat has begun! Round 1 starts!');\r\n    announceTurn();\r\n\r\n    debug.log('\u2694\uFE0F Combat started!');\r\n  }\r\n\r\n  /**\r\n   * Next turn\r\n   */\r\n  function nextTurn() {\r\n    if (initiativeTracker.combatants.length === 0) return;\r\n\r\n    initiativeTracker.currentTurnIndex++;\r\n    if (initiativeTracker.currentTurnIndex >= initiativeTracker.combatants.length) {\r\n      initiativeTracker.currentTurnIndex = 0;\r\n      initiativeTracker.round++;\r\n      document.getElementById('round-display').textContent = `Round ${initiativeTracker.round}`;\r\n      // Announce new round\r\n      postChatMessage(`\u2694\uFE0F Round ${initiativeTracker.round} begins!`);\r\n      // Notify Discord of round change\r\n      postRoundChangeToDiscord(initiativeTracker.round);\r\n    }\r\n\r\n    updateInitiativeDisplay();\r\n    notifyCurrentTurn();\r\n    announceTurn();\r\n\r\n    // Log turn change\r\n    const current = getCurrentCombatant();\r\n    if (current) {\r\n      logTurnAction({\r\n        action: 'turn',\r\n        description: `${current.name}'s turn begins`\r\n      });\r\n    }\r\n\r\n    debug.log(`\u23ED\uFE0F Next turn: ${getCurrentCombatant()?.name}`);\r\n  }\r\n\r\n  /**\r\n   * Previous turn\r\n   */\r\n  function prevTurn() {\r\n    if (initiativeTracker.combatants.length === 0) return;\r\n\r\n    initiativeTracker.currentTurnIndex--;\r\n    if (initiativeTracker.currentTurnIndex < 0) {\r\n      initiativeTracker.currentTurnIndex = initiativeTracker.combatants.length - 1;\r\n      initiativeTracker.round = Math.max(1, initiativeTracker.round - 1);\r\n      document.getElementById('round-display').textContent = `Round ${initiativeTracker.round}`;\r\n    }\r\n\r\n    updateInitiativeDisplay();\r\n    notifyCurrentTurn();\r\n    announceTurn();\r\n    debug.log(`\u23EE\uFE0F Prev turn: ${getCurrentCombatant()?.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get current combatant\r\n   */\r\n  function getCurrentCombatant() {\r\n    return initiativeTracker.combatants[initiativeTracker.currentTurnIndex];\r\n  }\r\n\r\n  /**\r\n   * Delay current turn\r\n   */\r\n  function delayTurn(combatantIndex) {\r\n    const combatant = initiativeTracker.combatants[combatantIndex];\r\n    if (!combatant) return;\r\n\r\n    debug.log(`\u23F8\uFE0F Delaying turn for: ${combatant.name}`);\r\n\r\n    // Add to delayed list\r\n    initiativeTracker.delayedCombatants.push({\r\n      name: combatant.name,\r\n      initiative: combatant.initiative,\r\n      originalIndex: combatantIndex\r\n    });\r\n\r\n    // Log the action\r\n    logTurnAction({\r\n      action: 'turn',\r\n      description: `${combatant.name} delays their turn`\r\n    });\r\n\r\n    // Announce delay\r\n    postChatMessage(`\u23F8\uFE0F ${combatant.name} delays their turn`);\r\n\r\n    // Move to next turn\r\n    nextTurn();\r\n\r\n    updateInitiativeDisplay();\r\n  }\r\n\r\n  /**\r\n   * Undelay a combatant (cancel their delay)\r\n   */\r\n  function undelayTurn(combatantName) {\r\n    const delayedIndex = initiativeTracker.delayedCombatants.findIndex(d => d.name === combatantName);\r\n    if (delayedIndex === -1) return;\r\n\r\n    debug.log(`\u25B6\uFE0F Undelaying: ${combatantName}`);\r\n\r\n    // Remove from delayed list\r\n    initiativeTracker.delayedCombatants.splice(delayedIndex, 1);\r\n\r\n    // Log the action\r\n    logTurnAction({\r\n      action: 'turn',\r\n      description: `${combatantName} resumes their turn`\r\n    });\r\n\r\n    // Announce\r\n    postChatMessage(`\u25B6\uFE0F ${combatantName} resumes their turn`);\r\n\r\n    updateInitiativeDisplay();\r\n  }\r\n\r\n  /**\r\n   * Insert a delayed combatant's turn now\r\n   */\r\n  function insertDelayedTurn(combatantName) {\r\n    const delayedIndex = initiativeTracker.delayedCombatants.findIndex(d => d.name === combatantName);\r\n    if (delayedIndex === -1) return;\r\n\r\n    const delayed = initiativeTracker.delayedCombatants[delayedIndex];\r\n    debug.log(`\u25B6\uFE0F Inserting delayed turn for: ${delayed.name}`);\r\n\r\n    // Remove from delayed list\r\n    initiativeTracker.delayedCombatants.splice(delayedIndex, 1);\r\n\r\n    // Log the action\r\n    logTurnAction({\r\n      action: 'turn',\r\n      description: `${delayed.name} acts on delayed turn`\r\n    });\r\n\r\n    // Announce\r\n    postChatMessage(`\u25B6\uFE0F ${delayed.name} acts now (delayed turn)`);\r\n\r\n    // Notify the character sheet\r\n    notifyCurrentTurn();\r\n\r\n    updateInitiativeDisplay();\r\n  }\r\n\r\n  /**\r\n   * Update initiative display\r\n   */\r\n  function updateInitiativeDisplay() {\r\n    const list = document.getElementById('initiative-list');\r\n    if (!list) return;\r\n\r\n    if (initiativeTracker.combatants.length === 0) {\r\n      list.innerHTML = '<div style=\"text-align: center; color: #7f8c8d; padding: 20px;\">No combatants yet. Add manually or roll initiative in Roll20 chat!</div>';\r\n      return;\r\n    }\r\n\r\n    list.innerHTML = initiativeTracker.combatants.map((combatant, index) => {\r\n      const isActive = index === initiativeTracker.currentTurnIndex;\r\n      const isDelayed = initiativeTracker.delayedCombatants.some(d => d.name === combatant.name);\r\n\r\n      return `\r\n        <div style=\"padding: 10px; background: ${isActive ? '#FC57F9' : isDelayed ? '#9b59b6' : '#34495e'}; border: 2px solid ${isActive ? '#FC57F9' : isDelayed ? '#8e44ad' : '#2c3e50'}; border-radius: 6px; ${isActive ? 'box-shadow: 0 0 15px rgba(78, 205, 196, 0.4);' : ''}\">\r\n          <div style=\"display: flex; align-items: center; gap: 10px; margin-bottom: ${isActive ? '8px' : '0'};\">\r\n            <div style=\"font-weight: bold; font-size: 1.2em; min-width: 30px; text-align: center;\">${combatant.initiative}</div>\r\n            <div style=\"flex: 1; font-weight: bold;\">\r\n              ${combatant.name}\r\n              ${isDelayed ? '<span style=\"font-size: 0.85em; color: #f39c12; margin-left: 8px;\">\u23F8\uFE0F Delayed</span>' : ''}\r\n            </div>\r\n            <button class=\"rollcloud-remove-combatant\" data-combatant-name=\"${combatant.name}\" style=\"background: #e74c3c; color: #fff; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;\">\u2715</button>\r\n          </div>\r\n          ${isActive && !isDelayed ? `\r\n            <button class=\"rollcloud-delay-turn\" data-combatant-index=\"${index}\" style=\"width: 100%; background: #f39c12; color: #fff; border: none; border-radius: 4px; padding: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em;\">\u23F8\uFE0F Delay Turn</button>\r\n          ` : ''}\r\n          ${isActive && isDelayed ? `\r\n            <button class=\"rollcloud-undelay-turn\" data-combatant-name=\"${combatant.name}\" style=\"width: 100%; background: #c2185b; color: #fff; border: none; border-radius: 4px; padding: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em;\">\u25B6\uFE0F Resume Turn</button>\r\n          ` : ''}\r\n        </div>\r\n      `;\r\n    }).join('');\r\n\r\n    // Show delayed combatants section if any exist\r\n    if (initiativeTracker.delayedCombatants.length > 0) {\r\n      list.innerHTML += `\r\n        <div style=\"margin-top: 15px; padding-top: 15px; border-top: 2px solid #34495e;\">\r\n          <div style=\"font-weight: bold; color: #f39c12; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;\">\r\n            <span>\u23F8\uFE0F</span> Delayed Actions\r\n          </div>\r\n          ${initiativeTracker.delayedCombatants.map(delayed => `\r\n            <div style=\"padding: 8px; background: #9b59b6; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;\">\r\n              <div style=\"flex: 1;\">\r\n                <div style=\"font-weight: bold;\">${delayed.name}</div>\r\n                <div style=\"font-size: 0.75em; opacity: 0.8;\">Initiative: ${delayed.initiative}</div>\r\n              </div>\r\n              <button class=\"rollcloud-insert-delayed\" data-delayed-name=\"${delayed.name}\" style=\"background: #c2185b; color: #fff; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-weight: bold; font-size: 0.85em;\">\u25B6\uFE0F Act Now</button>\r\n            </div>\r\n          `).join('')}\r\n        </div>\r\n      `;\r\n    }\r\n\r\n    // Attach event listeners (CSP-compliant)\r\n    const removeButtons = list.querySelectorAll('.rollcloud-remove-combatant');\r\n    removeButtons.forEach(button => {\r\n      button.addEventListener('click', () => {\r\n        const name = button.getAttribute('data-combatant-name');\r\n        removeCombatant(name);\r\n      });\r\n    });\r\n\r\n    const delayButtons = list.querySelectorAll('.rollcloud-delay-turn');\r\n    delayButtons.forEach(button => {\r\n      button.addEventListener('click', () => {\r\n        const index = parseInt(button.getAttribute('data-combatant-index'));\r\n        delayTurn(index);\r\n      });\r\n    });\r\n\r\n    const undelayButtons = list.querySelectorAll('.rollcloud-undelay-turn');\r\n    undelayButtons.forEach(button => {\r\n      button.addEventListener('click', () => {\r\n        const name = button.getAttribute('data-combatant-name');\r\n        undelayTurn(name);\r\n      });\r\n    });\r\n\r\n    const insertDelayedButtons = list.querySelectorAll('.rollcloud-insert-delayed');\r\n    insertDelayedButtons.forEach(button => {\r\n      button.addEventListener('click', () => {\r\n        const name = button.getAttribute('data-delayed-name');\r\n        insertDelayedTurn(name);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Notify current turn to character sheet and Discord\r\n   */\r\n  function notifyCurrentTurn() {\r\n    const current = getCurrentCombatant();\r\n    if (!current) return;\r\n\r\n    debug.log(`\uD83C\uDFAF Notifying turn for: \"${current.name}\"`);\r\n    debug.log(`\uD83D\uDCCB Registered popups: ${Object.keys(characterPopups).map(n => `\"${n}\"`).join(', ')}`);\r\n\r\n    // Helper function to normalize names for comparison\r\n    // Removes emoji prefixes, \"It's\", \"'s turn\", and trims\r\n    function normalizeName(name) {\r\n      return name\r\n        .replace(/^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)\\s*/, '') // Remove emoji prefixes\r\n        .replace(/^It's\\s+/i, '') // Remove \"It's\" prefix\r\n        .replace(/'s\\s+turn.*$/i, '') // Remove \"'s turn\" suffix\r\n        .trim();\r\n    }\r\n\r\n    const normalizedCurrentName = normalizeName(current.name);\r\n    debug.log(`\uD83D\uDD0D Normalized current combatant: \"${normalizedCurrentName}\"`);\r\n\r\n    // Send activateTurn/deactivateTurn to all popup windows\r\n    Object.keys(characterPopups).forEach(characterName => {\r\n      const popup = characterPopups[characterName];\r\n      try {\r\n        if (popup && !popup.closed) {\r\n          const normalizedCharName = normalizeName(characterName);\r\n\r\n          // Strict match: names must be exactly equal after normalization\r\n          const isTheirTurn = normalizedCharName === normalizedCurrentName;\r\n\r\n          debug.log(`\uD83D\uDD0D Comparing: \"${characterName}\" (normalized: \"${normalizedCharName}\") vs \"${current.name}\" (normalized: \"${normalizedCurrentName}\") \u2192 ${isTheirTurn ? 'ACTIVATE' : 'DEACTIVATE'}`);\r\n          debug.log(`\uD83D\uDD0D Raw comparison: \"${characterName}\" === \"${current.name}\" \u2192 ${characterName === current.name}`);\r\n\r\n          popup.postMessage({\r\n            action: isTheirTurn ? 'activateTurn' : 'deactivateTurn',\r\n            combatant: current.name\r\n          }, '*');\r\n\r\n          debug.log(`\uD83D\uDCE4 Sent ${isTheirTurn ? 'activateTurn' : 'deactivateTurn'} to \"${characterName}\"`);\r\n        } else {\r\n          // Clean up closed popups\r\n          delete characterPopups[characterName];\r\n          debug.log(`\uD83D\uDDD1\uFE0F Removed closed popup for ${characterName}`);\r\n        }\r\n      } catch (error) {\r\n        debug.warn(`\u26A0\uFE0F Error sending message to popup \"${characterName}\":`, error);\r\n        delete characterPopups[characterName];\r\n      }\r\n    });\r\n\r\n    // Post to Discord webhook\r\n    postTurnToDiscord(current);\r\n  }\r\n\r\n  /**\r\n   * Post turn notification to Discord webhook\r\n   */\r\n  function postTurnToDiscord(combatant) {\r\n    if (!combatant) return;\r\n\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'postToDiscord',\r\n      payload: {\r\n        type: 'turnStart',\r\n        characterName: combatant.name,\r\n        combatant: combatant.name,\r\n        initiative: combatant.initiative,\r\n        round: initiativeTracker.round\r\n      }\r\n    }).then(response => {\r\n      if (response && response.success) {\r\n        debug.log(`\uD83C\uDFAE Discord: Posted turn for ${combatant.name}`);\r\n      }\r\n    }).catch(err => {\r\n      // Webhook might not be configured - that's fine\r\n      debug.log('Discord webhook not configured or failed:', err.message);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Post round change to Discord webhook\r\n   */\r\n  function postRoundChangeToDiscord(round) {\r\n    const current = getCurrentCombatant();\r\n\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'postToDiscord',\r\n      payload: {\r\n        type: 'roundChange',\r\n        round: round,\r\n        combatant: current ? current.name : null\r\n      }\r\n    }).then(response => {\r\n      if (response && response.success) {\r\n        debug.log(`\uD83C\uDFAE Discord: Posted round ${round} change`);\r\n      }\r\n    }).catch(err => {\r\n      debug.log('Discord webhook not configured or failed:', err.message);\r\n    });\r\n  }\r\n\r\n  function announceTurn() {\r\n    const current = getCurrentCombatant();\r\n    if (!current) return;\r\n\r\n    postChatMessage(`\uD83C\uDFAF It's ${current.name}'s turn! (Initiative: ${current.initiative})`);\r\n  }\r\n\r\n  /**\r\n   * Chat monitoring for initiative rolls\r\n   */\r\n  let chatObserver = null;\r\n\r\n  function startChatMonitoring() {\r\n    const chatLog = document.getElementById('textchat');\r\n    if (!chatLog) {\r\n      debug.warn('\u26A0\uFE0F Roll20 chat not found, cannot monitor for initiative');\r\n      return;\r\n    }\r\n\r\n    // Watch for new messages\r\n    chatObserver = new MutationObserver((mutations) => {\r\n      mutations.forEach((mutation) => {\r\n        mutation.addedNodes.forEach((node) => {\r\n          if (node.nodeType === 1 && node.classList && node.classList.contains('message')) {\r\n            checkForInitiativeRoll(node);\r\n            checkForPlayerRoll(node); // Track any character roll for player overview\r\n          }\r\n        });\r\n      });\r\n    });\r\n\r\n    chatObserver.observe(chatLog, {\r\n      childList: true,\r\n      subtree: true\r\n    });\r\n\r\n    debug.log('\uD83D\uDC40 Monitoring Roll20 chat for initiative rolls and player tracking');\r\n  }\r\n\r\n  function stopChatMonitoring() {\r\n    if (chatObserver) {\r\n      chatObserver.disconnect();\r\n      chatObserver = null;\r\n      debug.log('\uD83D\uDED1 Stopped monitoring chat');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check message for initiative roll\r\n   */\r\n  function checkForInitiativeRoll(messageNode) {\r\n    const text = messageNode.textContent || '';\r\n    const innerHTML = messageNode.innerHTML || '';\r\n\r\n    // Debug: Log the message to see format\r\n    debug.log('\uD83D\uDCE8 Chat message (text):', text);\r\n    debug.log('\uD83D\uDCE8 Chat message (html):', innerHTML);\r\n\r\n    // Skip our own announcements (turn changes, round starts, GM mode toggles)\r\n    // These start with specific emojis and should not be parsed as initiative rolls\r\n    const ownAnnouncementPrefixes = ['\uD83C\uDFAF', '\u2694\uFE0F', '\uD83D\uDC51'];\r\n    const trimmedText = text.trim();\r\n    for (const prefix of ownAnnouncementPrefixes) {\r\n      if (trimmedText.includes(prefix)) {\r\n        debug.log('\u23ED\uFE0F Skipping own announcement message');\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Check for Roll20's inline roll format in HTML\r\n    // Look for dice rolls with \"inlinerollresult\" class\r\n    const inlineRolls = messageNode.querySelectorAll('.inlinerollresult');\r\n    if (inlineRolls.length > 0) {\r\n      // Check if message contains \"initiative\" keyword\r\n      const lowerText = text.toLowerCase();\r\n      if (lowerText.includes('initiative') || lowerText.includes('init')) {\r\n        let characterName = null;\r\n\r\n        // Try to extract from roll template caption first\r\n        const rollTemplate = messageNode.querySelector('.sheet-rolltemplate-default, .sheet-rolltemplate-custom');\r\n        if (rollTemplate) {\r\n          const caption = rollTemplate.querySelector('caption, .sheet-template-name, .charname');\r\n          if (caption) {\r\n            const captionText = caption.textContent.trim();\r\n            // Extract name from patterns like \"\uD83D\uDD35 Test 2 rolls Initiative\" or \"Name: Initiative\"\r\n            const nameMatch = captionText.match(/^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)?\\s*(.+?)\\s+(?:rolls?\\s+)?[Ii]nitiative/i);\r\n            if (nameMatch) {\r\n              characterName = nameMatch[1].trim();\r\n            }\r\n          }\r\n        }\r\n\r\n        // Fallback: Extract character name from .by element (regular chat messages)\r\n        if (!characterName) {\r\n          const byElement = messageNode.querySelector('.by');\r\n          characterName = byElement ? byElement.textContent.trim().replace(/:/g, '') : null;\r\n        }\r\n\r\n        // Get the roll result from the last inline roll\r\n        const lastRoll = inlineRolls[inlineRolls.length - 1];\r\n        const rollResult = lastRoll.textContent.trim();\r\n        const initiative = parseInt(rollResult);\r\n\r\n        if (characterName && !isNaN(initiative) && initiative >= 0 && initiative <= 50) {\r\n          debug.log(`\uD83C\uDFB2 Detected initiative roll (inline): ${characterName} = ${initiative}`);\r\n          addCombatant(characterName, initiative, 'chat');\r\n          return;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Look for patterns like:\r\n    // \"Grey rolls Initiative Roll 21\"\r\n    // \"Test 1 rolls Initiative Roll 22\"\r\n    // \"CharacterName rolled a 15 for initiative\"\r\n    // \"Initiative: 18\"\r\n    const initiativePatterns = [\r\n      // Pattern 1: \"Name rolls Initiative Roll 21\" or \"Name: rolls Initiative 21\"\r\n      /^(.+?)(?::)?\\s+rolls?\\s+[Ii]nitiative.*?(\\d+)/,\r\n      // Pattern 2: \"Name rolled 15 for initiative\"\r\n      /^(.+?)\\s+rolled?\\s+(?:a\\s+)?(\\d+)\\s+for\\s+[Ii]nitiative/,\r\n      // Pattern 3: Generic \"Name ... initiative ... 15\" (case insensitive)\r\n      /^(.+?).*?[Ii]nitiative.*?(\\d+)/,\r\n      // Pattern 4: \"Name ... Init ... 15\"\r\n      /^(.+?).*?[Ii]nit.*?(\\d+)/\r\n    ];\r\n\r\n    for (const pattern of initiativePatterns) {\r\n      const match = text.match(pattern);\r\n      if (match) {\r\n        let name = match[1].trim();\r\n        // Remove trailing colons and \"rolls\" text\r\n        name = name.replace(/\\s*:?\\s*rolls?$/i, '').trim();\r\n        const initiative = parseInt(match[2]);\r\n\r\n        if (name && !isNaN(initiative) && initiative >= 0 && initiative <= 50) {\r\n          debug.log(`\uD83C\uDFB2 Detected initiative roll (text): ${name} = ${initiative}`);\r\n          addCombatant(name, initiative, 'chat');\r\n          return;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check message for any character roll and track player\r\n   */\r\n  function checkForPlayerRoll(messageNode) {\r\n    const text = messageNode.textContent || '';\r\n\r\n    // Skip our own announcements\r\n    const ownAnnouncementPrefixes = ['\uD83C\uDFAF', '\u2694\uFE0F', '\uD83D\uDC51', '\uD83D\uDD13', '\u23F8\uFE0F', '\u25B6\uFE0F', '\uD83D\uDCCB'];\r\n    const trimmedText = text.trim();\r\n    for (const prefix of ownAnnouncementPrefixes) {\r\n      if (trimmedText.includes(prefix)) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Skip system messages\r\n    if (text.includes('created the character') ||\r\n        text.includes('Welcome to Roll20') ||\r\n        text.includes('has joined the game')) {\r\n      return;\r\n    }\r\n\r\n    // Skip initiative rolls (handled separately in initiative tracker)\r\n    if (/\\binitiative\\b/i.test(text) || /\\binit\\b/i.test(text)) {\r\n      debug.log('\u23ED\uFE0F Skipping initiative roll for player tracking');\r\n      return;\r\n    }\r\n\r\n    // Check for inline rolls (indicates a character is rolling)\r\n    const inlineRolls = messageNode.querySelectorAll('.inlinerollresult');\r\n    if (inlineRolls.length === 0) {\r\n      return; // No rolls, skip\r\n    }\r\n\r\n    let characterName = null;\r\n\r\n    // Try to extract character name from roll template\r\n    const rollTemplate = messageNode.querySelector('.sheet-rolltemplate-default, .sheet-rolltemplate-custom, [class*=\"rolltemplate\"]');\r\n    if (rollTemplate) {\r\n      const caption = rollTemplate.querySelector('caption, .sheet-template-name, .charname, [class*=\"charname\"]');\r\n      if (caption) {\r\n        const captionText = caption.textContent.trim();\r\n        // Extract name from patterns like \"\uD83D\uDD35 Character Name rolls Attack\" or \"Character Name: Attack\"\r\n        const nameMatch = captionText.match(/^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)?\\s*(.+?)\\s*(?:rolls?\\s+|\\s*:\\s*|$)/i);\r\n        if (nameMatch) {\r\n          characterName = nameMatch[1].trim();\r\n        }\r\n      }\r\n    }\r\n\r\n    // Fallback: Try to extract from message structure\r\n    if (!characterName) {\r\n      const byElement = messageNode.querySelector('.by');\r\n      if (byElement) {\r\n        characterName = byElement.textContent.trim();\r\n      }\r\n    }\r\n\r\n    // Fallback: Parse from message text\r\n    if (!characterName) {\r\n      // Pattern: \"Character Name: roll result\" or \"Character Name rolls\"\r\n      const patterns = [\r\n        /^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)?\\s*(.+?)\\s*:/,\r\n        /^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)?\\s*(.+?)\\s+rolls?/i\r\n      ];\r\n\r\n      for (const pattern of patterns) {\r\n        const match = text.match(pattern);\r\n        if (match) {\r\n          characterName = match[1].trim();\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // If we got a character name, track them\r\n    if (characterName && characterName.length > 0) {\r\n      // Skip obviously non-player names\r\n      const skipNames = ['gm', 'dm', 'roll20', 'system', 'the', 'a ', 'an '];\r\n      const lowerName = characterName.toLowerCase();\r\n      if (skipNames.some(skip => lowerName === skip || lowerName.startsWith(skip + ' '))) {\r\n        return;\r\n      }\r\n\r\n      // Add to player tracking if not already tracked\r\n      if (!playerData[characterName]) {\r\n        debug.log(`\uD83D\uDC65 New player detected from roll: ${characterName}`);\r\n\r\n        playerData[characterName] = {\r\n          hp: null, // Will be updated when popup sends data\r\n          maxHp: null,\r\n          ac: null,\r\n          passivePerception: null,\r\n          initiative: null,\r\n          conditions: [],\r\n          concentration: null,\r\n          deathSaves: null\r\n        };\r\n\r\n        updatePlayerOverviewDisplay();\r\n\r\n        // Log to turn history\r\n        logTurnAction({\r\n          action: 'turn',\r\n          description: `${characterName} detected in combat`\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Register a character popup window\r\n   * Called by character-sheet-overlay when opening a popup\r\n   */\r\n  window.rollcloudRegisterPopup = function(characterName, popupWindow) {\r\n    if (characterName && popupWindow) {\r\n      characterPopups[characterName] = popupWindow;\r\n      debug.log(`\u2705 Registered popup for: ${characterName}`);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Check recent chat messages to see if it's currently this character's turn\r\n   */\r\n  function checkRecentChatForCurrentTurn(characterName, popupWindow) {\r\n    try {\r\n      const chatLog = document.getElementById('textchat');\r\n      if (!chatLog) {\r\n        debug.warn('\u26A0\uFE0F Roll20 chat not found for turn check');\r\n        return;\r\n      }\r\n\r\n      // Get recent messages (last 20 or so)\r\n      const messages = chatLog.querySelectorAll('.message');\r\n      const recentMessages = Array.from(messages).slice(-20);\r\n      \r\n      debug.log(`\uD83D\uDD0D Checking recent ${recentMessages.length} messages for current turn of: ${characterName}`);\r\n\r\n      // Helper function to normalize names\r\n      function normalizeName(name) {\r\n        return name\r\n          .replace(/^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)\\s*/, '') // Remove emoji prefixes\r\n          .replace(/^It's\\s+/i, '') // Remove \"It's\" prefix\r\n          .replace(/'s\\s+turn.*$/i, '') // Remove \"'s turn\" suffix\r\n          .trim();\r\n      }\r\n\r\n      const normalizedCharacterName = normalizeName(characterName);\r\n\r\n      // Look for recent turn announcement\r\n      for (let i = recentMessages.length - 1; i >= 0; i--) {\r\n        const message = recentMessages[i];\r\n        const text = message.textContent || '';\r\n        \r\n        // Check for turn announcement pattern\r\n        const turnMatch = text.match(/\uD83C\uDFAF It's (.+?)'s turn! \\(Initiative: (\\d+)\\)/);\r\n        if (turnMatch) {\r\n          const announcedCharacter = normalizeName(turnMatch[1]);\r\n          const initiative = parseInt(turnMatch[2]);\r\n          \r\n          debug.log(`\uD83D\uDD0D Found turn announcement: \"${turnMatch[1]}\" (normalized: \"${announcedCharacter}\") vs \"${characterName}\" (normalized: \"${normalizedCharacterName}\")`);\r\n          \r\n          if (announcedCharacter === normalizedCharacterName) {\r\n            debug.log(`\u2705 It's ${characterName}'s turn! Activating action economy...`);\r\n            \r\n            // Send activateTurn to this popup\r\n            popupWindow.postMessage({\r\n              action: 'activateTurn',\r\n              combatant: characterName\r\n            }, '*');\r\n            \r\n            return;\r\n          } else {\r\n            debug.log(`\u23F8\uFE0F It's ${turnMatch[1]}'s turn, not ${characterName}. Deactivating...`);\r\n            \r\n            // Send deactivateTurn to this popup\r\n            popupWindow.postMessage({\r\n              action: 'deactivateTurn',\r\n              combatant: characterName\r\n            }, '*');\r\n            \r\n            return;\r\n          }\r\n        }\r\n      }\r\n      \r\n      debug.log(`\uD83D\uDD0D No recent turn announcement found for ${characterName}`);\r\n      \r\n    } catch (error) {\r\n      debug.error('Error checking recent chat for current turn:', error);\r\n    }\r\n  }\r\n\r\n  // Listen for messages to toggle GM mode and post chat messages\r\n  window.addEventListener('message', (event) => {\r\n    debug.log('\uD83D\uDCE8 Received message:', event.data);\r\n\r\n    if (event.data && event.data.action === 'toggleGMMode') {\r\n      debug.log('\uD83D\uDC51 Processing toggleGMMode message:', event.data.enabled);\r\n      toggleGMMode(event.data.enabled);\r\n    } else if (event.data && event.data.action === 'shareCharacterWithGM') {\r\n      debug.log('\uD83D\uDC51 Processing shareCharacterWithGM message');\r\n      try {\r\n        postChatMessage(event.data.message);\r\n        debug.log('\u2705 Character broadcast posted to chat');\r\n      } catch (error) {\r\n        debug.error('\u274C Error posting character broadcast:', error);\r\n      }\r\n    } else if (event.data && event.data.action === 'registerPopup') {\r\n      // Register popup window for turn notifications\r\n      if (event.data.characterName && event.source) {\r\n        window.rollcloudRegisterPopup(event.data.characterName, event.source);\r\n        debug.log(`\u2705 Registered popup via message for: ${event.data.characterName}`);\r\n      }\r\n    } else if (event.data && event.data.action === 'postChatMessageFromPopup') {\r\n      // Post message from character sheet popup to Roll20 chat\r\n      postChatMessage(event.data.message);\r\n    } else if (event.data && event.data.action === 'checkCurrentTurn') {\r\n      // Check if it's currently this character's turn by examining recent chat\r\n      if (event.data.characterName) {\r\n        checkRecentChatForCurrentTurn(event.data.characterName, event.source);\r\n      }\r\n    } else if (event.data && event.data.action === 'updatePlayerData') {\r\n      // Receive player data updates for GM overview\r\n      if (event.data.characterName && event.data.data) {\r\n        updatePlayerData(event.data.characterName, event.data.data);\r\n      }\r\n    } else if (event.data && event.data.action === 'postToDiscordFromPopup') {\r\n      // Forward Discord webhook post from popup to background script\r\n      if (event.data.payload) {\r\n        browserAPI.runtime.sendMessage({\r\n          action: 'postToDiscord',\r\n          payload: event.data.payload\r\n        }).then(response => {\r\n          if (response && response.success) {\r\n            debug.log(`\uD83C\uDFAE Discord: Forwarded action update from popup`);\r\n          }\r\n        }).catch(err => {\r\n          debug.log('Discord webhook not configured or failed:', err.message);\r\n        });\r\n      }\r\n    }\r\n  });\r\n\r\n  browserAPI.runtime.onMessage.addListener((request, sender, sendResponse) => {\r\n    if (request.action === 'toggleGMMode') {\r\n      toggleGMMode(request.enabled);\r\n      sendResponse({ success: true });\r\n    }\r\n\r\n  });\r\n\r\n  /**\r\n   * Start monitoring for character selection changes in Roll20\r\n   * This detects when a character is selected and marks them as active\r\n   */\r\n  function startCharacterSelectionMonitor() {\r\n    debug.log('\uD83D\uDD0D Starting character selection monitor...');\r\n    \r\n    let lastSelectedCharacter = null;\r\n    \r\n    // Function to check for currently selected character\r\n    function checkSelectedCharacter() {\r\n      try {\r\n        // Try multiple methods to detect selected character\r\n        let selectedCharacter = null;\r\n        \r\n        // Method 1: Check for selected token in Roll20\r\n        const selectedTokens = document.querySelectorAll('.token.selected, .token.selected-token');\r\n        if (selectedTokens.length > 0) {\r\n          // Get character name from token\r\n          const token = selectedTokens[0];\r\n          const tokenName = token.getAttribute('data-name') || \r\n                           token.getAttribute('title') || \r\n                           token.querySelector('.token-name')?.textContent ||\r\n                           token.textContent;\r\n          \r\n          if (tokenName && tokenName.trim()) {\r\n            selectedCharacter = tokenName.trim();\r\n            debug.log(`\uD83C\uDFAF Detected selected token: ${selectedCharacter}`);\r\n          }\r\n        }\r\n        \r\n        // Method 2: Check for active character in Roll20's UI\r\n        if (!selectedCharacter) {\r\n          const activeCharElement = document.querySelector('.character-item.active, .character.active, [data-character-id].active');\r\n          if (activeCharElement) {\r\n            selectedCharacter = activeCharElement.textContent?.trim() || \r\n                               activeCharElement.getAttribute('data-character-name');\r\n            debug.log(`\uD83C\uDFAF Detected active character in UI: ${selectedCharacter}`);\r\n          }\r\n        }\r\n        \r\n        // Method 3: Check Roll20's window object for current character\r\n        if (!selectedCharacter && typeof window !== 'undefined' && window.Campaign) {\r\n          try {\r\n            const activeCharacter = window.Campaign.activeCharacter();\r\n            if (activeCharacter && activeCharacter.attributes && activeCharacter.attributes.name) {\r\n              selectedCharacter = activeCharacter.attributes.name;\r\n              debug.log(`\uD83C\uDFAF Detected active character from Campaign: ${selectedCharacter}`);\r\n            }\r\n          } catch (e) {\r\n            // Campaign API might not be available\r\n          }\r\n        }\r\n        \r\n        // If we found a selected character and it's different from last time\r\n        if (selectedCharacter && selectedCharacter !== lastSelectedCharacter) {\r\n          debug.log(`\u2705 Character selection changed: \"${lastSelectedCharacter}\" \u2192 \"${selectedCharacter}\"`);\r\n          lastSelectedCharacter = selectedCharacter;\r\n          \r\n          // Mark this character as active in Supabase\r\n          markCharacterAsActive(selectedCharacter);\r\n        }\r\n        \r\n      } catch (error) {\r\n        debug.warn('\u26A0\uFE0F Error checking selected character:', error);\r\n      }\r\n    }\r\n    \r\n    // Check immediately\r\n    checkSelectedCharacter();\r\n    \r\n    // Set up periodic checking (every 2 seconds)\r\n    const checkInterval = setInterval(checkSelectedCharacter, 2000);\r\n    \r\n    // Also check when user clicks on the page (likely to select a token)\r\n    document.addEventListener('click', () => {\r\n      setTimeout(checkSelectedCharacter, 100); // Small delay to allow UI to update\r\n    });\r\n    \r\n    // Clean up on page unload\r\n    window.addEventListener('beforeunload', () => {\r\n      clearInterval(checkInterval);\r\n    });\r\n    \r\n    debug.log('\u2705 Character selection monitor started');\r\n  }\r\n  \r\n  /**\r\n   * Mark a character as active in Supabase\r\n   */\r\n  async function markCharacterAsActive(characterName) {\r\n    try {\r\n      debug.log(`\uD83C\uDFAF Marking character as active: ${characterName}`);\r\n      \r\n      // Get current character profiles from storage\r\n      const result = await browserAPI.storage.local.get(['characterProfiles']);\r\n      const characterProfiles = result.characterProfiles || {};\r\n      \r\n      // Find the character ID that matches this name\r\n      let characterId = null;\r\n      for (const [id, profile] of Object.entries(characterProfiles)) {\r\n        if (profile.name === characterName || profile.character_name === characterName) {\r\n          characterId = id;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      if (characterId) {\r\n        // Send message to background script to update active status\r\n        const response = await browserAPI.runtime.sendMessage({\r\n          action: 'setActiveCharacter',\r\n          characterId: characterId\r\n        });\r\n        \r\n        if (response && response.success) {\r\n          debug.log(`\u2705 Successfully marked ${characterName} as active`);\r\n        } else {\r\n          debug.warn(`\u26A0\uFE0F Failed to mark ${characterName} as active:`, response);\r\n        }\r\n      } else {\r\n        debug.warn(`\u26A0\uFE0F Could not find character ID for ${characterName} in local storage`);\r\n      }\r\n      \r\n    } catch (error) {\r\n      debug.error(`\u274C Error marking character as active:`, error);\r\n    }\r\n  }\r\n\r\n  // Listen for openGMMode custom event from character-sheet-overlay.js\r\n  document.addEventListener('openGMMode', () => {\r\n    debug.log('\u2705 Received openGMMode event - opening GM panel');\r\n    try {\r\n      postChatMessage('\uD83D\uDC51 Opening GM mode...');\r\n    } catch (error) {\r\n      debug.error(' Error posting chat message:', error);\r\n    }\r\n    toggleGMMode(true);\r\n  });\r\n\r\n  // Load player data from storage on initialization to ensure it's available\r\n  // for checks before GM panel is created\r\n  loadPlayerDataFromStorage();\r\n\r\n  // Start monitoring for character selection changes\r\n  startCharacterSelectionMonitor();\r\n\r\n  debug.log('\u2705 Roll20 script ready - listening for roll announcements and GM mode');\r\n\r\n  /**\r\n   * Refresh character data from storage\r\n   */\r\n  async function refreshCharacterData() {\r\n    try {\r\n      const result = await browserAPI.storage.local.get('carmaclouds_characters');\r\n      const characters = result.carmaclouds_characters || [];\r\n      \r\n      if (characters.length === 0) {\r\n        return null;\r\n      }\r\n      \r\n      // Return the most recent character\r\n      return characters[0];\r\n    } catch (error) {\r\n      debug.error('\u274C Error refreshing character data:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n})();\r\n"],
  "mappings": "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",
  "names": ["chatObserver", "tabContent", "popup"]
}
