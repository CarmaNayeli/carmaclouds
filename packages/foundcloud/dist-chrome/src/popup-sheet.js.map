{
  "version": 3,
  "sources": ["../../../core/src/common/theme-manager.js", "../../../core/src/common/browser-polyfill.js", "../../src/popup-sheet.js"],
  "sourcesContent": ["/**\r\n * Theme Manager Utility\r\n * Handles light/dark/system theme switching with persistence\r\n * Configurable for different projects (owlcloud, rollcloud, etc.)\r\n */\r\n\r\n/**\r\n * Create a configured theme manager instance\r\n * @param {Object} config - Configuration object\r\n * @param {string} config.storageKey - LocalStorage key for theme persistence\r\n * @param {string} config.eventName - Custom event name for theme changes\r\n * @returns {Object} Configured theme manager instance\r\n */\r\nfunction createThemeManager(config = {}) {\r\n  const storageKey = config.storageKey || 'theme';\r\n  const eventName = config.eventName || 'theme-changed';\r\n\r\n  return {\r\n    THEMES: {\r\n      LIGHT: 'light',\r\n      DARK: 'dark',\r\n      SYSTEM: 'system'\r\n    },\r\n\r\n    currentTheme: 'system',\r\n    systemPrefersDark: false,\r\n\r\n    /**\r\n     * Initialize theme manager\r\n     */\r\n    async init() {\r\n      // Check system preference FIRST before loading saved preference\r\n      debug.log('\uD83C\uDFA8 ThemeManager.init() starting...');\r\n      try {\r\n        if (typeof window === 'undefined' || !window.matchMedia) {\r\n          debug.warn('\u26A0\uFE0F window.matchMedia not available, defaulting to light theme');\r\n          this.systemPrefersDark = false;\r\n        } else {\r\n          const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');\r\n          this.systemPrefersDark = darkModeQuery.matches;\r\n\r\n          debug.log('\uD83C\uDFA8 System dark mode query result:', {\r\n            matches: darkModeQuery.matches,\r\n            media: darkModeQuery.media,\r\n            systemPrefersDark: this.systemPrefersDark\r\n          });\r\n          console.log('\uD83C\uDFA8 THEME DEBUG: Dark mode query matches:', darkModeQuery.matches);\r\n          console.log('\uD83C\uDFA8 THEME DEBUG: systemPrefersDark set to:', this.systemPrefersDark);\r\n\r\n          // Verify the media query is valid\r\n          if (darkModeQuery.media === 'not all') {\r\n            debug.warn('\u26A0\uFE0F Dark mode media query not supported, defaulting to light theme');\r\n            this.systemPrefersDark = false;\r\n          }\r\n\r\n          // Listen for system theme changes\r\n          try {\r\n            darkModeQuery.addEventListener('change', (e) => {\r\n              this.systemPrefersDark = e.matches;\r\n              debug.log('\uD83C\uDFA8 System dark mode preference changed:', this.systemPrefersDark);\r\n              if (this.currentTheme === this.THEMES.SYSTEM) {\r\n                this.applyTheme(this.THEMES.SYSTEM);\r\n              }\r\n            });\r\n          } catch (listenerError) {\r\n            debug.warn('\u26A0\uFE0F Could not add dark mode change listener:', listenerError);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        debug.error('\u274C Error detecting system theme preference:', error);\r\n        this.systemPrefersDark = false;\r\n      }\r\n\r\n      // Load saved theme preference\r\n      await this.loadThemePreference();\r\n\r\n      // Apply initial theme\r\n      this.applyTheme(this.currentTheme);\r\n\r\n      debug.log('\uD83C\uDFA8 Theme Manager initialized:', {\r\n        currentTheme: this.currentTheme,\r\n        effectiveTheme: this.getEffectiveTheme(this.currentTheme),\r\n        systemPrefersDark: this.systemPrefersDark\r\n      });\r\n    },\r\n\r\n    /**\r\n     * Load theme preference from storage\r\n     */\r\n    async loadThemePreference() {\r\n      try {\r\n        if (typeof browserAPI !== 'undefined' && browserAPI.storage) {\r\n          const result = await browserAPI.storage.local.get(['theme']);\r\n          if (result.theme) {\r\n            this.currentTheme = result.theme;\r\n          }\r\n        } else if (typeof localStorage !== 'undefined') {\r\n          // Fallback to localStorage for popup windows\r\n          const saved = localStorage.getItem(storageKey);\r\n          if (saved) {\r\n            this.currentTheme = saved;\r\n          }\r\n        }\r\n      } catch (error) {\r\n        debug.error('Failed to load theme preference:', error);\r\n      }\r\n    },\r\n\r\n    /**\r\n     * Save theme preference to storage\r\n     */\r\n    async saveThemePreference(theme) {\r\n      try {\r\n        this.currentTheme = theme;\r\n\r\n        if (typeof browserAPI !== 'undefined' && browserAPI.storage) {\r\n          await browserAPI.storage.local.set({ theme: theme });\r\n        } else if (typeof localStorage !== 'undefined') {\r\n          localStorage.setItem(storageKey, theme);\r\n        }\r\n\r\n        debug.log('\uD83D\uDCBE Theme preference saved:', theme);\r\n      } catch (error) {\r\n        debug.error('Failed to save theme preference:', error);\r\n      }\r\n    },\r\n\r\n    /**\r\n     * Apply theme to document\r\n     */\r\n    applyTheme(theme) {\r\n      const effectiveTheme = this.getEffectiveTheme(theme);\r\n\r\n      debug.log('\uD83C\uDFA8 Applying theme:', {\r\n        requested: theme,\r\n        effective: effectiveTheme,\r\n        systemPrefersDark: this.systemPrefersDark\r\n      });\r\n      console.log('\uD83C\uDFA8 THEME DEBUG: Applying theme - requested:', theme, 'effective:', effectiveTheme, 'systemPrefersDark:', this.systemPrefersDark);\r\n\r\n      // Remove existing theme classes\r\n      document.documentElement.classList.remove('theme-light', 'theme-dark');\r\n\r\n      // Add new theme class\r\n      document.documentElement.classList.add(`theme-${effectiveTheme}`);\r\n\r\n      // Set data attribute for CSS targeting\r\n      document.documentElement.setAttribute('data-theme', effectiveTheme);\r\n\r\n      console.log('\uD83C\uDFA8 THEME DEBUG: Applied class:', `theme-${effectiveTheme}`, 'to document element');\r\n      console.log('\uD83C\uDFA8 THEME DEBUG: Document classes:', document.documentElement.className);\r\n\r\n      debug.log('\uD83C\uDFA8 Theme applied successfully:', effectiveTheme);\r\n    },\r\n\r\n    /**\r\n     * Get the effective theme (resolves 'system' to light/dark)\r\n     */\r\n    getEffectiveTheme(theme) {\r\n      if (theme === this.THEMES.SYSTEM) {\r\n        return this.systemPrefersDark ? this.THEMES.DARK : this.THEMES.LIGHT;\r\n      }\r\n      return theme;\r\n    },\r\n\r\n    /**\r\n     * Set theme and save preference\r\n     */\r\n    async setTheme(theme) {\r\n      if (!Object.values(this.THEMES).includes(theme)) {\r\n        debug.error('Invalid theme:', theme);\r\n        return;\r\n      }\r\n\r\n      await this.saveThemePreference(theme);\r\n      this.applyTheme(theme);\r\n\r\n      // Notify other parts of the extension about theme change\r\n      this.notifyThemeChange(theme);\r\n    },\r\n\r\n    /**\r\n     * Notify about theme change (for communication between popup/content scripts)\r\n     */\r\n    notifyThemeChange(theme) {\r\n      // Send message to background script\r\n      if (typeof browserAPI !== 'undefined' && browserAPI.runtime) {\r\n        browserAPI.runtime.sendMessage({\r\n          action: 'themeChanged',\r\n          theme: theme\r\n        }).catch(() => {\r\n          // Ignore errors if background script isn't listening\r\n        });\r\n      }\r\n\r\n      // Dispatch custom event for same-page listeners\r\n      window.dispatchEvent(new CustomEvent(eventName, {\r\n        detail: { theme: theme }\r\n      }));\r\n    },\r\n\r\n    /**\r\n     * Get current theme\r\n     */\r\n    getCurrentTheme() {\r\n      return this.currentTheme;\r\n    },\r\n\r\n    /**\r\n     * Get effective theme (with system resolved)\r\n     */\r\n    getEffectiveCurrentTheme() {\r\n      return this.getEffectiveTheme(this.currentTheme);\r\n    },\r\n\r\n    /**\r\n     * Force refresh system preference detection\r\n     * Call this if system theme detection seems incorrect\r\n     */\r\n    refreshSystemPreference() {\r\n      try {\r\n        if (window.matchMedia) {\r\n          const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');\r\n          const oldValue = this.systemPrefersDark;\r\n          this.systemPrefersDark = darkModeQuery.matches;\r\n\r\n          debug.log('\uD83D\uDD04 Refreshed system preference:', {\r\n            oldValue: oldValue,\r\n            newValue: this.systemPrefersDark,\r\n            mediaQuery: darkModeQuery.media,\r\n            matches: darkModeQuery.matches\r\n          });\r\n\r\n          // Re-apply theme if using system preference\r\n          if (this.currentTheme === this.THEMES.SYSTEM) {\r\n            this.applyTheme(this.THEMES.SYSTEM);\r\n          }\r\n\r\n          return this.systemPrefersDark;\r\n        }\r\n      } catch (error) {\r\n        debug.error('\u274C Error refreshing system preference:', error);\r\n      }\r\n      return this.systemPrefersDark;\r\n    }\r\n  };\r\n}\r\n\r\n// Export for use in other modules\r\nif (typeof module !== 'undefined' && module.exports) {\r\n  module.exports = { createThemeManager };\r\n}\r\n\r\n// Make factory available globally\r\nif (typeof window !== 'undefined') {\r\n  window.createThemeManager = createThemeManager;\r\n  \r\n  // Create default instance for carmaclouds\r\n  if (!window.ThemeManager) {\r\n    window.ThemeManager = createThemeManager({\r\n      storageKey: 'carmaclouds-theme',\r\n      eventName: 'carmaclouds-theme-changed'\r\n    });\r\n  }\r\n}\r\n", "/**\r\n * Browser API Compatibility Layer - Chrome & Firefox Support\r\n *\r\n * This provides a consistent browserAPI interface across Chrome and Firefox.\r\n * Firefox uses the 'browser' namespace (Promise-based), while Chrome uses 'chrome' (callback-based).\r\n */\r\n\r\nconsole.log('\uD83C\uDF10 Loading browser polyfill...');\r\n\r\n// Use 'self' for service workers, 'window' for content scripts/popups\r\nconst globalScope = typeof window !== 'undefined' ? window : self;\r\n\r\n// Detect browser and use appropriate API\r\nlet browserAPI;\r\n\r\nif (typeof browser !== 'undefined' && browser.runtime) {\r\n  // Firefox - uses native Promise-based API\r\n  console.log('\uD83E\uDD8A Detected Firefox');\r\n  browserAPI = browser;\r\n} else if (typeof chrome !== 'undefined' && chrome.runtime) {\r\n  // Chrome - wrap callback-based API to be consistent with Firefox\r\n  console.log('\uD83C\uDF10 Detected Chrome');\r\n  // Helper to check if Chrome extension context is valid\r\n  const isChromeContextValid = () => {\r\n    try {\r\n      return chrome && chrome.runtime && chrome.runtime.id;\r\n    } catch (error) {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  browserAPI = {\r\n    runtime: {\r\n      sendMessage: (message, callback) => {\r\n        // If callback is provided, use callback-based API\r\n        if (typeof callback === 'function') {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              console.error('\u274C Extension context invalidated');\r\n              callback(null);\r\n              return;\r\n            }\r\n            chrome.runtime.sendMessage(message, callback);\r\n          } catch (error) {\r\n            // Handle \"Extension context invalidated\" error in Chrome\r\n            console.error('\u274C Extension context error:', error.message);\r\n            callback(null);\r\n          }\r\n          return;\r\n        }\r\n        // Otherwise return a Promise\r\n        return new Promise((resolve, reject) => {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              reject(new Error('Extension context invalidated'));\r\n              return;\r\n            }\r\n            chrome.runtime.sendMessage(message, (response) => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n              } else {\r\n                resolve(response);\r\n              }\r\n            });\r\n          } catch (error) {\r\n            // Handle \"Extension context invalidated\" error in Chrome\r\n            console.error('\u274C Extension context error:', error.message);\r\n            reject(error);\r\n          }\r\n        });\r\n      },\r\n      onMessage: chrome.runtime.onMessage,\r\n      getURL: (path) => {\r\n        try {\r\n          if (!isChromeContextValid()) return null;\r\n          return chrome.runtime.getURL(path);\r\n        } catch (error) {\r\n          console.error('\u274C Extension context error:', error.message);\r\n          return null;\r\n        }\r\n      },\r\n      getManifest: () => {\r\n        try {\r\n          if (!isChromeContextValid()) return null;\r\n          return chrome.runtime.getManifest();\r\n        } catch (error) {\r\n          console.error('\u274C Extension context error:', error.message);\r\n          return null;\r\n        }\r\n      },\r\n      get id() {\r\n        try {\r\n          if (!isChromeContextValid()) return null;\r\n          return chrome.runtime.id;\r\n        } catch (error) {\r\n          console.error('\u274C Extension context error:', error.message);\r\n          return null;\r\n        }\r\n      },\r\n      get lastError() {\r\n        try {\r\n          if (!isChromeContextValid()) return null;\r\n          return chrome.runtime.lastError;\r\n        } catch (error) {\r\n          return null;\r\n        }\r\n      },\r\n      connectNative: (application) => {\r\n        try {\r\n          if (!isChromeContextValid()) {\r\n            console.error('\u274C Extension context invalidated');\r\n            return null;\r\n          }\r\n          const port = chrome.runtime.connectNative(application);\r\n          // Check for immediate errors\r\n          if (chrome.runtime.lastError) {\r\n            console.warn('\u26A0\uFE0F Native messaging error:', chrome.runtime.lastError.message);\r\n            return null;\r\n          }\r\n          return port;\r\n        } catch (error) {\r\n          console.error('\u274C Native messaging error:', error.message);\r\n          return null;\r\n        }\r\n      }\r\n    },\r\n    storage: {\r\n      local: {\r\n        get: (keys) => {\r\n          return new Promise((resolve, reject) => {\r\n            try {\r\n              if (!isChromeContextValid()) {\r\n                reject(new Error('Extension context invalidated'));\r\n                return;\r\n              }\r\n              chrome.storage.local.get(keys, (result) => {\r\n                if (chrome.runtime.lastError) {\r\n                  reject(new Error(chrome.runtime.lastError.message));\r\n                } else {\r\n                  resolve(result);\r\n                }\r\n              });\r\n            } catch (error) {\r\n              reject(new Error('Extension context invalidated'));\r\n            }\r\n          });\r\n        },\r\n        set: (items) => {\r\n          return new Promise((resolve, reject) => {\r\n            try {\r\n              if (!isChromeContextValid()) {\r\n                reject(new Error('Extension context invalidated'));\r\n                return;\r\n              }\r\n              chrome.storage.local.set(items, () => {\r\n                if (chrome.runtime.lastError) {\r\n                  reject(new Error(chrome.runtime.lastError.message));\r\n                } else {\r\n                  resolve();\r\n                }\r\n              });\r\n            } catch (error) {\r\n              reject(new Error('Extension context invalidated'));\r\n            }\r\n          });\r\n        },\r\n        remove: (keys) => {\r\n          return new Promise((resolve, reject) => {\r\n            try {\r\n              if (!isChromeContextValid()) {\r\n                reject(new Error('Extension context invalidated'));\r\n                return;\r\n              }\r\n              chrome.storage.local.remove(keys, () => {\r\n                if (chrome.runtime.lastError) {\r\n                  reject(new Error(chrome.runtime.lastError.message));\r\n                } else {\r\n                  resolve();\r\n                }\r\n              });\r\n            } catch (error) {\r\n              reject(new Error('Extension context invalidated'));\r\n            }\r\n          });\r\n        },\r\n        clear: () => {\r\n          return new Promise((resolve, reject) => {\r\n            try {\r\n              if (!isChromeContextValid()) {\r\n                reject(new Error('Extension context invalidated'));\r\n                return;\r\n              }\r\n              chrome.storage.local.clear(() => {\r\n                if (chrome.runtime.lastError) {\r\n                  reject(new Error(chrome.runtime.lastError.message));\r\n                } else {\r\n                  resolve();\r\n                }\r\n              });\r\n            } catch (error) {\r\n              reject(new Error('Extension context invalidated'));\r\n            }\r\n          });\r\n        }\r\n      }\r\n    },\r\n    tabs: {\r\n      query: (queryInfo) => {\r\n        return new Promise((resolve, reject) => {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              reject(new Error('Extension context invalidated'));\r\n              return;\r\n            }\r\n            chrome.tabs.query(queryInfo, (tabs) => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n              } else {\r\n                resolve(tabs);\r\n              }\r\n            });\r\n          } catch (error) {\r\n            reject(new Error('Extension context invalidated'));\r\n          }\r\n        });\r\n      },\r\n      sendMessage: (tabId, message, callback) => {\r\n        // If callback is provided, use callback-based API\r\n        if (typeof callback === 'function') {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              console.error('\u274C Extension context invalidated');\r\n              callback(null);\r\n              return;\r\n            }\r\n            chrome.tabs.sendMessage(tabId, message, callback);\r\n          } catch (error) {\r\n            // Handle \"Extension context invalidated\" error in Chrome\r\n            console.error('\u274C Extension context error:', error.message);\r\n            callback(null);\r\n          }\r\n          return;\r\n        }\r\n        // Otherwise return a Promise\r\n        return new Promise((resolve, reject) => {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              reject(new Error('Extension context invalidated'));\r\n              return;\r\n            }\r\n            chrome.tabs.sendMessage(tabId, message, (response) => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n              } else {\r\n                resolve(response);\r\n              }\r\n            });\r\n          } catch (error) {\r\n            // Handle \"Extension context invalidated\" error in Chrome\r\n            console.error('\u274C Extension context error:', error.message);\r\n            reject(error);\r\n          }\r\n        });\r\n      },\r\n      create: (createProperties) => {\r\n        return new Promise((resolve, reject) => {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              reject(new Error('Extension context invalidated'));\r\n              return;\r\n            }\r\n            chrome.tabs.create(createProperties, (tab) => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n              } else {\r\n                resolve(tab);\r\n              }\r\n            });\r\n          } catch (error) {\r\n            reject(new Error('Extension context invalidated'));\r\n          }\r\n        });\r\n      },\r\n      update: (tabId, updateProperties) => {\r\n        return new Promise((resolve, reject) => {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              reject(new Error('Extension context invalidated'));\r\n              return;\r\n            }\r\n            chrome.tabs.update(tabId, updateProperties, (tab) => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n              } else {\r\n                resolve(tab);\r\n              }\r\n            });\r\n          } catch (error) {\r\n            reject(new Error('Extension context invalidated'));\r\n          }\r\n        });\r\n      }\r\n    }\r\n  };\r\n} else {\r\n  console.error('\u274C FATAL: No browser API available!');\r\n  throw new Error('No browser API available');\r\n}\r\n\r\n// Expose as browserAPI for consistent naming\r\nglobalScope.browserAPI = browserAPI;\r\n\r\n// Verify API is available\r\nif (!globalScope.browserAPI || !globalScope.browserAPI.runtime) {\r\n  console.error('\u274C FATAL: Browser API not available!');\r\n  throw new Error('Browser API not available');\r\n}\r\n\r\nconsole.log('\u2705 Browser API ready:', (typeof browser !== 'undefined' && browserAPI === browser) ? 'Firefox' : 'Chrome');\r\n", "// Import browser polyfill for cross-browser compatibility\r\nimport '@carmaclouds/core/common/browser-polyfill.js';\r\n\r\n// Import theme manager\r\nimport ThemeManager from '@carmaclouds/core/common/theme-manager.js';\r\n\r\n// Define debug for popup-sheet context\r\nconst debug = window.debug || {\r\n  log: console.log.bind(console),\r\n  warn: console.warn.bind(console),\r\n  error: console.error.bind(console),\r\n  info: console.info.bind(console),\r\n  group: console.group.bind(console),\r\n  groupEnd: console.groupEnd.bind(console),\r\n  table: console.table.bind(console),\r\n  time: console.time.bind(console),\r\n  timeEnd: console.timeEnd.bind(console),\r\n  isEnabled: () => true\r\n};\r\n\r\ndebug.log('\u2705 Popup HTML loaded');\r\n\r\n// Import all D&D logic from centralized action executor (from core)\r\n// Note: FoundCloud doesn't currently use the action executor from core,\r\n// so we'll comment this out for now and handle it if needed\r\n// import {\r\n//   // Spell edge cases\r\n//   SPELL_EDGE_CASES, isEdgeCase, getEdgeCase, applyEdgeCaseModifications, isReuseableSpell, isTooComplicatedSpell,\r\n//   // Class feature edge cases\r\n//   CLASS_FEATURE_EDGE_CASES, isClassFeatureEdgeCase, getClassFeatureEdgeCase, applyClassFeatureEdgeCaseModifications,\r\n//   // Racial feature edge cases\r\n//   RACIAL_FEATURE_EDGE_CASES, isRacialFeatureEdgeCase, getRacialFeatureEdgeCase, applyRacialFeatureEdgeCaseModifications,\r\n//   // Combat maneuver edge cases\r\n//   COMBAT_MANEUVER_EDGE_CASES, isCombatManeuverEdgeCase, getCombatManeuverEdgeCase, applyCombatManeuverEdgeCaseModifications,\r\n//   // Metamagic & resource logic\r\n//   METAMAGIC_COSTS,\r\n//   calculateMetamagicCost as executorCalculateMetamagicCost,\r\n//   getAvailableMetamagic as executorGetAvailableMetamagic,\r\n//   getSorceryPointsResource as executorGetSorceryPointsResource,\r\n//   isMagicItemSpell, isFreeSpell,\r\n//   detectClassResources as executorDetectClassResources,\r\n//   // Execution functions\r\n//   resolveSpellCast, resolveActionUse\r\n// } from '@carmaclouds/core/modules/action-executor.js';\r\n\r\n// Initialize theme manager\r\nif (typeof ThemeManager !== 'undefined') {\r\n  ThemeManager.init().then(() => {\r\n    debug.log('\uD83C\uDFA8 Theme system initialized');\r\n\r\n    // Set up theme button click handlers\r\n    // Note: Don't wrap in DOMContentLoaded since this script runs after the DOM is loaded\r\n    const themeButtons = document.querySelectorAll('.theme-btn');\r\n    themeButtons.forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        const theme = btn.dataset.theme;\r\n        ThemeManager.setTheme(theme);\r\n\r\n        // Update active state\r\n        themeButtons.forEach(b => b.classList.remove('active'));\r\n        btn.classList.add('active');\r\n      });\r\n    });\r\n\r\n    // Set initial active button based on current theme\r\n    const currentTheme = ThemeManager.getCurrentTheme();\r\n    const activeBtn = document.querySelector(`[data-theme=\"${currentTheme}\"]`);\r\n    if (activeBtn) {\r\n      themeButtons.forEach(b => b.classList.remove('active'));\r\n      activeBtn.classList.add('active');\r\n    }\r\n  });\r\n} else {\r\n  debug.warn('\u26A0\uFE0F ThemeManager not available');\r\n}\r\n\r\n// Store character data globally so we can update it\r\nlet characterData = null;\r\n\r\n// Track current character slot ID (e.g., \"slot-1\") for persistence\r\nlet currentSlotId = null;\r\n\r\n// Track Feline Agility usage\r\nlet felineAgilityUsed = false;\r\n\r\n// Setting: Show custom macro gear buttons on spells (disabled by default)\r\nlet showCustomMacroButtons = false;\r\n\r\n// Track if DOM is ready\r\nlet domReady = false;\r\n\r\n// Queue for operations waiting for DOM\r\nlet pendingOperations = [];\r\n\r\n/**\r\n * Hide GM controls when opened from GM panel (read-only mode)\r\n */\r\nfunction hideGMControls() {\r\n  // Hide GM mode toggle\r\n  const gmModeContainer = document.querySelector('.gm-mode-container');\r\n  if (gmModeContainer) {\r\n    gmModeContainer.style.display = 'none';\r\n    debug.log('\uD83D\uDC51 Hidden GM mode toggle');\r\n  }\r\n  \r\n  // Hide settings button\r\n  const settingsBtn = document.getElementById('settings-btn');\r\n  if (settingsBtn) {\r\n    settingsBtn.style.display = 'none';\r\n    debug.log('\uD83D\uDC51 Hidden settings button');\r\n  }\r\n  \r\n  // Hide color picker\r\n  const colorPickerContainer = document.querySelector('.color-picker-container');\r\n  if (colorPickerContainer) {\r\n    colorPickerContainer.style.display = 'none';\r\n    debug.log('\uD83D\uDC51 Hidden color picker');\r\n  }\r\n  \r\n  // Update title to indicate read-only mode\r\n  const titleElement = document.querySelector('.char-name-section');\r\n  if (titleElement) {\r\n    titleElement.innerHTML = titleElement.innerHTML.replace('\uD83C\uDFB2 Character Sheet', '\uD83C\uDFB2 Character Sheet (Read Only)');\r\n  }\r\n}\r\n\r\n// Listen for character data from parent window via postMessage\r\nwindow.addEventListener('message', async (event) => {\r\n  debug.log('\u2705 Received message in popup:', event.data);\r\n\r\n  if (event.data && event.data.action === 'initCharacterSheet') {\r\n    debug.log('\u2705 Initializing character sheet with data:', event.data.data.name);\r\n    \r\n    // Check if this is opened from GM panel (read-only mode)\r\n    const isFromGMPanel = event.data.source === 'gm-panel';\r\n    if (isFromGMPanel) {\r\n      debug.log('\uD83D\uDC51 Popup opened from GM panel - hiding GM controls');\r\n      hideGMControls();\r\n    }\r\n    \r\n    // Function to initialize the sheet\r\n    const initSheet = async () => {\r\n      characterData = event.data.data;  // Store globally\r\n\r\n      // Get and store current slot ID for persistence\r\n      currentSlotId = await getActiveCharacterId();\r\n      debug.log('\uD83D\uDCCB Current slot ID set to:', currentSlotId);\r\n\r\n      // Build tabs first (need to load profiles from storage)\r\n      await loadAndBuildTabs();\r\n\r\n      // Then build the sheet with character data\r\n      buildSheet(characterData);\r\n      \r\n      // Initialize racial traits based on character data\r\n      initRacialTraits();\r\n\r\n      // Initialize feat traits based on character data\r\n      initFeatTraits();\r\n\r\n      // Initialize class features based on character data\r\n      initClassFeatures();\r\n\r\n      // Initialize character cache with current data\r\n      if (characterData && characterData.id) {\r\n        characterCache.set(characterData.id, JSON.parse(JSON.stringify(characterData)));\r\n        debug.log(`\uD83D\uDCC2 Initialized cache for character: ${characterData.name}`);\r\n      }\r\n\r\n      // Register this character with GM Initiative Tracker (if it exists)\r\n      // Use postMessage to avoid CORS issues - send character name only\r\n      if (window.opener) {\r\n        window.opener.postMessage({\r\n          action: 'registerPopup',\r\n          characterName: event.data.data.name\r\n        }, '*');\r\n        debug.log(`\u2705 Sent registration message for: ${event.data.data.name}`);\r\n        \r\n        // Check if it's currently this character's turn by reading recent chat\r\n        // Add a small delay to ensure combat system has processed start of combat\r\n        setTimeout(() => {\r\n          checkCurrentTurnFromChat(event.data.data.name);\r\n        }, 500);\r\n      } else {\r\n        debug.warn(`\u26A0\uFE0F No window.opener available for: ${event.data.data.name}`);\r\n      }\r\n    };\r\n\r\n    // Only initialize if DOM is ready, otherwise queue it\r\n    if (domReady) {\r\n      await initSheet();\r\n    } else {\r\n      debug.log('\u23F3 DOM not ready yet, queuing initialization...');\r\n      pendingOperations.push(initSheet);\r\n    }\r\n  } else if (event.data && event.data.action === 'loadCharacterData') {\r\n    debug.log('\uD83D\uDCCB Loading character data from GM panel:', event.data.characterData.name);\r\n    \r\n    // This is from GM panel - hide GM controls\r\n    hideGMControls();\r\n    \r\n    // Load the character data using the same initialization process\r\n    characterData = event.data.characterData;\r\n    \r\n    // Function to initialize the sheet with GM panel data\r\n    const initSheetFromGM = async () => {\r\n      // Build tabs first (need to load profiles from storage)\r\n      await loadAndBuildTabs();\r\n\r\n      // Then build the sheet with character data\r\n      buildSheet(characterData);\r\n      \r\n      // Initialize racial traits based on character data\r\n      initRacialTraits();\r\n\r\n      // Initialize feat traits based on character data\r\n      initFeatTraits();\r\n\r\n      // Initialize class features based on character data\r\n      initClassFeatures();\r\n\r\n      // Initialize character cache with current data\r\n      if (characterData && characterData.id) {\r\n        characterCache.set(characterData.id, JSON.parse(JSON.stringify(characterData)));\r\n        debug.log(`\uD83D\uDCC2 Initialized cache for character: ${characterData.name}`);\r\n      }\r\n    };\r\n\r\n    // Only initialize if DOM is ready, otherwise queue it\r\n    if (domReady) {\r\n      await initSheetFromGM();\r\n    } else {\r\n      debug.log('\u23F3 DOM not ready yet, queuing GM panel initialization...');\r\n      pendingOperations.push(initSheetFromGM);\r\n    }\r\n  }\r\n});\r\n\r\n// Tell parent window we're ready - wait for DOM to be fully loaded\r\n// This prevents race conditions in Firefox\r\nfunction notifyParentReady() {\r\n  try {\r\n    if (window.opener && !window.opener.closed) {\r\n      debug.log('\u2705 Sending ready message to parent window...');\r\n      window.opener.postMessage({ action: 'popupReady' }, '*');\r\n    } else {\r\n      debug.warn('\u26A0\uFE0F No parent window available, waiting for postMessage...');\r\n    }\r\n  } catch (error) {\r\n    debug.warn('\u26A0\uFE0F Could not notify parent (this is normal):', error.message);\r\n  }\r\n}\r\n\r\n// Wait for DOM to be ready before doing anything\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', async () => {\r\n    debug.log('\u2705 DOM is ready');\r\n    domReady = true;\r\n    \r\n    // Send ready message to parent\r\n    notifyParentReady();\r\n    \r\n    // Execute any pending operations\r\n    for (const operation of pendingOperations) {\r\n      await operation();\r\n    }\r\n    pendingOperations = [];\r\n  });\r\n} else {\r\n  // DOM is already ready\r\n  debug.log('\u2705 DOM already ready');\r\n  domReady = true;\r\n  notifyParentReady();\r\n}\r\n\r\ndebug.log('\u2705 Waiting for character data via postMessage...');\r\n\r\n// Fallback: If we don't receive data via postMessage within 1.5 seconds,\r\n// load directly from storage (Firefox sometimes blocks postMessage between windows)\r\nsetTimeout(() => {\r\n  if (!characterData && domReady) {\r\n    debug.log('\u23F1\uFE0F No data received via postMessage, loading from storage...');\r\n    loadCharacterWithTabs();\r\n  } else if (!characterData && !domReady) {\r\n    debug.log('\u23F3 DOM not ready yet, will retry fallback...');\r\n    setTimeout(() => {\r\n      if (!characterData) {\r\n        debug.log('\u23F1\uFE0F Retry: Loading from storage...');\r\n        loadCharacterWithTabs();\r\n      }\r\n    }, 500);\r\n  }\r\n}, 1500);\r\n\r\n// Load profiles and build tabs (without building sheet)\r\nasync function loadAndBuildTabs() {\r\n  try {\r\n    debug.log('\uD83D\uDCCB Loading character profiles for tabs...');\r\n\r\n    // Get all character profiles\r\n    const profilesResponse = await browserAPI.runtime.sendMessage({ action: 'getAllCharacterProfiles' });\r\n    const profiles = profilesResponse.success ? profilesResponse.profiles : {};\r\n    debug.log('\uD83D\uDCCB Profiles loaded:', Object.keys(profiles));\r\n\r\n    // Get active character ID (this is the slotId like \"slot-1\")\r\n    const activeCharacterId = await getActiveCharacterId();\r\n    debug.log('\uD83D\uDCCB Active character ID:', activeCharacterId);\r\n\r\n    // Build character tabs\r\n    buildCharacterTabs(profiles, activeCharacterId);\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to load and build tabs:', error);\r\n  }\r\n}\r\n\r\n// Load character data and build tabs\r\nasync function loadCharacterWithTabs() {\r\n  // Wait for DOM to be ready\r\n  if (!domReady) {\r\n    debug.log('\u23F3 DOM not ready, queuing loadCharacterWithTabs...');\r\n    pendingOperations.push(loadCharacterWithTabs);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    // Build tabs first\r\n    await loadAndBuildTabs();\r\n\r\n    // Get and store current slot ID for persistence\r\n    currentSlotId = await getActiveCharacterId();\r\n    debug.log('\uD83D\uDCCB Current slot ID set to:', currentSlotId);\r\n\r\n    // Get active character data\r\n    let activeCharacter = null;\r\n    \r\n    // Check if this is a database character\r\n    if (currentSlotId && currentSlotId.startsWith('db-')) {\r\n      // Load from database\r\n      const characterId = currentSlotId.replace('db-', '');\r\n      try {\r\n        const dbResponse = await browserAPI.runtime.sendMessage({ \r\n          action: 'getCharacterDataFromDatabase', \r\n          characterId: characterId \r\n        });\r\n        if (dbResponse.success) {\r\n          activeCharacter = dbResponse.data;\r\n          debug.log('\u2705 Loaded character from database:', activeCharacter.name);\r\n        }\r\n      } catch (dbError) {\r\n        debug.warn('\u26A0\uFE0F Failed to load database character:', dbError);\r\n      }\r\n    } else {\r\n      // Load from local storage\r\n      const activeResponse = await browserAPI.runtime.sendMessage({ action: 'getCharacterData' });\r\n      activeCharacter = activeResponse.success ? activeResponse.data : null;\r\n    }\r\n\r\n    // Load active character\r\n    if (activeCharacter) {\r\n      characterData = activeCharacter;\r\n      buildSheet(characterData);\r\n      \r\n      // Initialize racial traits based on character data\r\n      initRacialTraits();\r\n\r\n      // Initialize feat traits based on character data\r\n      initFeatTraits();\r\n\r\n      // Initialize class features based on character data\r\n      initClassFeatures();\r\n    } else {\r\n      debug.error('\u274C No character data found');\r\n    }\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to load characters:', error);\r\n  }\r\n}\r\n\r\n// Get the active character ID from storage\r\nasync function getActiveCharacterId() {\r\n  // Use Promise-based API (works in both Chrome and Firefox with our polyfill)\r\n  const result = await browserAPI.storage.local.get(['activeCharacterId']);\r\n  return result.activeCharacterId || null;\r\n}\r\n\r\n// Build character tabs UI\r\nfunction buildCharacterTabs(profiles, activeCharacterId) {\r\n  const tabsContainer = document.getElementById('character-tabs');\r\n  if (!tabsContainer) {\r\n    debug.warn('\u26A0\uFE0F character-tabs container not found!');\r\n    return;\r\n  }\r\n\r\n  debug.log(`\uD83C\uDFF7\uFE0F Building character tabs. Active: ${activeCharacterId}`);\r\n  debug.log(`\uD83D\uDCCB Profiles:`, Object.keys(profiles));\r\n\r\n  tabsContainer.innerHTML = '';\r\n  const maxSlots = 10; // Support up to 10 character slots (matches main's implementation)\r\n\r\n  // First, add database characters\r\n  const databaseCharacters = Object.entries(profiles).filter(([slotId, profile]) => \r\n    slotId.startsWith('db-') && profile.source === 'database'\r\n  );\r\n  \r\n  // Add database character tabs\r\n  databaseCharacters.forEach(([slotId, charInSlot], index) => {\r\n    const isActive = slotId === activeCharacterId;\r\n    \r\n    debug.log(`\uD83C\uDF10 DB Character: ${charInSlot.name} (active: ${isActive})`);\r\n    \r\n    const tab = document.createElement('div');\r\n    tab.className = 'character-tab database-tab';\r\n    if (isActive) {\r\n      tab.classList.add('active');\r\n    }\r\n    tab.dataset.slotId = slotId;\r\n    \r\n    // Create special styling for database characters\r\n    tab.innerHTML = `\r\n      <span class=\"slot-number\">\uD83C\uDF10</span>\r\n      <span class=\"char-name\">${charInSlot.name || 'Unknown'}</span>\r\n      <span class=\"char-details\">${charInSlot.level || 1} ${charInSlot.class || 'Unknown'}</span>\r\n    `;\r\n    \r\n    // Add click handler\r\n    tab.addEventListener('click', (e) => {\r\n      debug.log(`\uD83D\uDDB1\uFE0F Database tab clicked for ${slotId}`, charInSlot.name);\r\n      switchToCharacter(slotId);\r\n    });\r\n    \r\n    tabsContainer.appendChild(tab);\r\n  });\r\n\r\n  // Add separator if we have both database and local characters\r\n  if (databaseCharacters.length > 0) {\r\n    const separator = document.createElement('div');\r\n    separator.className = 'tab-separator';\r\n    separator.innerHTML = '<span style=\"color: var(--text-secondary); font-size: 0.8em;\">Local Characters</span>';\r\n    tabsContainer.appendChild(separator);\r\n  }\r\n\r\n  // Create tabs for local slots\r\n  for (let slotNum = 1; slotNum <= maxSlots; slotNum++) {\r\n    const slotId = `slot-${slotNum}`;\r\n    // Find character in this slot using slotId as key\r\n    const charInSlot = profiles[slotId];\r\n\r\n    if (charInSlot) {\r\n      debug.log(`  \uD83D\uDCCC Slot ${slotNum}: ${charInSlot.name} (active: ${slotId === activeCharacterId})`);\r\n    }\r\n\r\n    const tab = document.createElement('div');\r\n    tab.className = 'character-tab';\r\n    tab.dataset.slotId = slotId;\r\n\r\n    if (charInSlot) {\r\n      const isActive = slotId === activeCharacterId;\r\n\r\n      if (isActive) {\r\n        tab.classList.add('active');\r\n      }\r\n\r\n      tab.innerHTML = `\r\n        <span class=\"slot-number\">${slotNum}</span>\r\n        <span class=\"char-name\">${charInSlot.name || 'Unknown'}</span>\r\n        <span class=\"close-tab\" title=\"Clear slot\">\u2715</span>\r\n      `;\r\n\r\n      // Click to switch character\r\n      tab.addEventListener('click', (e) => {\r\n        debug.log(`\uD83D\uDDB1\uFE0F Tab clicked for ${slotId}`, charInSlot.name);\r\n        if (!e.target.classList.contains('close-tab')) {\r\n          switchToCharacter(slotId);\r\n        }\r\n      });\r\n\r\n      // Close button\r\n      const closeBtn = tab.querySelector('.close-tab');\r\n      closeBtn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        clearCharacterSlot(slotId, slotNum);\r\n      });\r\n    } else {\r\n      // Empty slot\r\n      tab.classList.add('empty');\r\n      tab.innerHTML = `\r\n        <span class=\"slot-number\">${slotNum}</span>\r\n        <span class=\"char-name\">Empty Slot</span>\r\n      `;\r\n    }\r\n\r\n    tabsContainer.appendChild(tab);\r\n  }\r\n}\r\n\r\n/**\r\n * Check recent chat messages to see if it's currently this character's turn\r\n * This handles the case where a character tab is switched after turn notifications were sent\r\n */\r\nfunction checkCurrentTurnFromChat(characterName) {\r\n  try {\r\n    if (!window.opener) {\r\n      debug.warn('\u26A0\uFE0F No window.opener available for turn check');\r\n      return;\r\n    }\r\n\r\n    // Request recent chat messages from parent window\r\n    window.opener.postMessage({\r\n      action: 'checkCurrentTurn',\r\n      characterName: characterName\r\n    }, '*');\r\n    \r\n    debug.log(`\uD83D\uDD0D Requested turn check for: ${characterName}`);\r\n  } catch (error) {\r\n    debug.warn('\u26A0\uFE0F Error checking current turn:', error);\r\n  }\r\n}\r\n\r\n// Switch to a different character\r\nasync function switchToCharacter(characterId) {\r\n  try {\r\n    debug.log(`\uD83D\uDD04 Switching to character: ${characterId}`);\r\n\r\n    // Save current character data before switching to preserve local state\r\n    // CRITICAL: Save to BOTH cache AND browser storage to persist through refresh\r\n    if (characterData && currentSlotId && currentSlotId !== characterId) {\r\n      debug.log('\uD83D\uDCBE Saving current character data before switching');\r\n      const dataToSave = JSON.parse(JSON.stringify(characterData));\r\n      \r\n      // Save to cache for immediate access\r\n      if (typeof characterCache !== 'undefined') {\r\n        characterCache.set(currentSlotId, dataToSave);\r\n        debug.log(`\u2705 Cached current character data: ${characterData.name}`);\r\n      }\r\n\r\n      // Save to browser storage (persists through refresh/close) WITH slotId\r\n      await browserAPI.runtime.sendMessage({\r\n        action: 'storeCharacterData',\r\n        data: dataToSave,\r\n        slotId: currentSlotId\r\n      });\r\n      debug.log(`\u2705 Saved current character data to storage: ${characterData.name}`);\r\n    }\r\n\r\n    // Set as active character\r\n    await setActiveCharacter(characterId);\r\n    currentSlotId = characterId;\r\n\r\n    // Load the new character data\r\n    let newCharacterData = null;\r\n    \r\n    // Check if this is a database character\r\n    if (characterId.startsWith('db-')) {\r\n      // Load from database\r\n      const dbCharacterId = characterId.replace('db-', '');\r\n      try {\r\n        const dbResponse = await browserAPI.runtime.sendMessage({ \r\n          action: 'getCharacterDataFromDatabase', \r\n          characterId: dbCharacterId \r\n        });\r\n        if (dbResponse.success) {\r\n          newCharacterData = dbResponse.data;\r\n          debug.log('\u2705 Loaded database character:', newCharacterData.name);\r\n        } else {\r\n          throw new Error(dbResponse.error || 'Failed to load database character');\r\n        }\r\n      } catch (dbError) {\r\n        debug.error('\u274C Failed to load database character:', dbError);\r\n        showNotification('\u274C Failed to load character from database', 'error');\r\n        return;\r\n      }\r\n    } else {\r\n      // Load from local storage\r\n      const response = await browserAPI.runtime.sendMessage({ \r\n        action: 'getCharacterData', \r\n        characterId: characterId \r\n      });\r\n      \r\n      if (response.success) {\r\n        newCharacterData = response.data;\r\n        debug.log('\u2705 Loaded local character:', newCharacterData.name);\r\n      } else {\r\n        throw new Error(response.error || 'Failed to load local character');\r\n      }\r\n    }\r\n\r\n    if (newCharacterData) {\r\n      characterData = newCharacterData;\r\n      \r\n      // Cache the loaded character data\r\n      if (typeof characterCache !== 'undefined') {\r\n        characterCache.set(characterId, characterData);\r\n      }\r\n\r\n      // Build the character sheet\r\n      buildSheet(characterData);\r\n      \r\n      // Initialize racial traits based on character data\r\n      initRacialTraits();\r\n\r\n      // Initialize feat traits based on character data\r\n      initFeatTraits();\r\n\r\n      // Initialize class features based on character data\r\n      initClassFeatures();\r\n\r\n      // Send sync message to DiceCloud if experimental sync is available\r\n      // Always send sync messages in experimental build - they'll be handled by Roll20 content script\r\n      debug.log('\uD83D\uDD04 Sending character data update to DiceCloud sync...');\r\n\r\n      // Extract Channel Divinity from resources if it exists\r\n      const channelDivinityResource = characterData.resources?.find(r =>\r\n        r.name && r.name.toLowerCase().includes('channel divinity')\r\n      );\r\n\r\n      const syncMessage = {\r\n        action: 'characterUpdate',\r\n        characterId: characterData.id,\r\n        characterName: characterData.name,\r\n        hitPoints: characterData.hitPoints,\r\n        temporaryHP: characterData.temporaryHP,\r\n        spellSlots: characterData.spellSlots,\r\n        channelDivinity: channelDivinityResource ? {\r\n          current: channelDivinityResource.current,\r\n          max: channelDivinityResource.max,\r\n          variableName: channelDivinityResource.variableName || channelDivinityResource.varName\r\n        } : null,\r\n        resources: characterData.resources || [],\r\n        actions: characterData.actions || [],\r\n        deathSaves: characterData.deathSaves,\r\n        inspiration: characterData.inspiration,\r\n        conditions: characterData.conditions || [],\r\n        source: characterData.source || 'local'\r\n      };\r\n\r\n      // Send to all Roll20 tabs\r\n      try {\r\n        const tabs = await browserAPI.tabs.query({ url: '*://app.roll20.net/*' });\r\n        for (const tab of tabs) {\r\n          browserAPI.tabs.sendMessage(tab.id, syncMessage).catch(err => {\r\n            debug.warn(`Failed to send sync to tab ${tab.id}:`, err);\r\n          });\r\n        }\r\n        debug.log(`\uD83D\uDCE4 Sent character update to ${tabs.length} Roll20 tabs`);\r\n      } catch (syncError) {\r\n        debug.warn('Failed to send sync to Roll20 tabs:', syncError);\r\n      }\r\n\r\n      // Update tabs to show new active character\r\n      await loadAndBuildTabs();\r\n      \r\n      // Show success notification\r\n      const source = characterData.source || 'local';\r\n      const sourceText = source === 'database' ? '\uD83C\uDF10' : '\uD83D\uDCBE';\r\n      showNotification(`${sourceText} Switched to ${characterData.name}`, 'success');\r\n      \r\n      debug.log(`\u2705 Successfully switched to character: ${characterData.name}`);\r\n    } else {\r\n      throw new Error('No character data available');\r\n    }\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to switch character:', error);\r\n    showNotification('\u274C Failed to switch character', 'error');\r\n  }\r\n}\r\n\r\n// Clear a character slot\r\nasync function clearCharacterSlot(slotId, slotNum) {\r\n  if (!confirm(`Clear slot ${slotNum}? This will remove this character from the slot.`)) {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await browserAPI.runtime.sendMessage({\r\n      action: 'clearCharacterData',\r\n      characterId: slotId\r\n    });\r\n\r\n    showNotification(`\u2705 Slot ${slotNum} cleared`);\r\n\r\n    // Reload tabs\r\n    loadCharacterWithTabs();\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to clear slot:', error);\r\n    showNotification('\u274C Failed to clear slot', 'error');\r\n  }\r\n}\r\n\r\n// Global advantage state\r\nlet advantageState = 'normal'; // 'advantage', 'normal', or 'disadvantage'\r\n\r\n// Add event listeners for rest buttons and advantage toggle\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  const shortRestBtn = document.getElementById('short-rest-btn');\r\n  const longRestBtn = document.getElementById('long-rest-btn');\r\n\r\n  if (shortRestBtn) {\r\n    shortRestBtn.addEventListener('click', takeShortRest);\r\n  }\r\n\r\n  if (longRestBtn) {\r\n    longRestBtn.addEventListener('click', takeLongRest);\r\n  }\r\n\r\n  // Advantage toggle buttons\r\n  const advantageBtn = document.getElementById('advantage-btn');\r\n  const normalBtn = document.getElementById('normal-btn');\r\n  const disadvantageBtn = document.getElementById('disadvantage-btn');\r\n\r\n  if (advantageBtn) {\r\n    advantageBtn.addEventListener('click', () => setAdvantageState('advantage'));\r\n  }\r\n\r\n  if (normalBtn) {\r\n    normalBtn.addEventListener('click', () => setAdvantageState('normal'));\r\n  }\r\n\r\n  if (disadvantageBtn) {\r\n    disadvantageBtn.addEventListener('click', () => setAdvantageState('disadvantage'));\r\n  }\r\n});\r\n\r\n// Helper function for setting active character (backup if runtime message fails)\r\nasync function setActiveCharacter(characterId) {\r\n  try {\r\n    await browserAPI.storage.local.set({ \r\n      activeCharacterId: characterId \r\n    });\r\n    console.log(`\u2705 Set active character: ${characterId}`);\r\n  } catch (error) {\r\n    console.error('\u274C Failed to set active character:', error);\r\n  }\r\n}\r\n\r\nfunction setAdvantageState(state) {\r\n  advantageState = state;\r\n\r\n  const advantageBtn = document.getElementById('advantage-btn');\r\n  const normalBtn = document.getElementById('normal-btn');\r\n  const disadvantageBtn = document.getElementById('disadvantage-btn');\r\n\r\n  // Reset all buttons\r\n  [advantageBtn, normalBtn, disadvantageBtn].forEach(btn => {\r\n    if (btn) {\r\n      btn.classList.remove('active');\r\n      const color = btn.id.includes('advantage') ? 'var(--accent-success)' :\r\n                   btn.id.includes('normal') ? '#3498db' :\r\n                   'var(--accent-danger)';\r\n      btn.style.background = 'transparent';\r\n      btn.style.color = color;\r\n      btn.style.borderColor = color;\r\n    }\r\n  });\r\n\r\n  // Highlight active button\r\n  const activeBtn = state === 'advantage' ? advantageBtn :\r\n                   state === 'normal' ? normalBtn :\r\n                   disadvantageBtn;\r\n\r\n  if (activeBtn) {\r\n    activeBtn.classList.add('active');\r\n    const color = state === 'advantage' ? 'var(--accent-success)' :\r\n                 state === 'normal' ? '#3498db' :\r\n                 'var(--accent-danger)';\r\n    activeBtn.style.background = color;\r\n    activeBtn.style.color = 'white';\r\n  }\r\n\r\n  debug.log(`\uD83C\uDFB2 Advantage state set to: ${state}`);\r\n  showNotification(`\uD83C\uDFB2 ${state === 'advantage' ? 'Advantage' : state === 'disadvantage' ? 'Disadvantage' : 'Normal'} rolls selected`);\r\n}\r\n\r\nfunction buildSheet(data) {\r\n  debug.log('Building character sheet...');\r\n  debug.log('\uD83D\uDCCA Character data received:', data);\r\n  debug.log('\u2728 Spell slots data:', data.spellSlots);\r\n\r\n  // Safety check: Ensure critical DOM elements exist before building\r\n  const charNameEl = document.getElementById('char-name');\r\n  if (!charNameEl) {\r\n    debug.error('\u274C Critical DOM elements not found! DOM may not be ready yet.');\r\n    debug.log('\u23F3 Queuing buildSheet for when DOM is ready...');\r\n    if (!domReady) {\r\n      pendingOperations.push(() => buildSheet(data));\r\n    } else {\r\n      // DOM claims to be ready but elements aren't there - retry after a short delay\r\n      debug.log('\u23F1\uFE0F DOM ready but elements missing - retrying in 100ms...');\r\n      setTimeout(() => buildSheet(data), 100);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Initialize concentration from saved data\r\n  if (data.concentration) {\r\n    concentratingSpell = data.concentration;\r\n    updateConcentrationDisplay();\r\n    debug.log(`\uD83E\uDDE0 Restored concentration: ${concentratingSpell}`);\r\n  } else {\r\n    concentratingSpell = null;\r\n    updateConcentrationDisplay();\r\n  }\r\n\r\n  // Character name\r\n  charNameEl.textContent = data.name || 'Character';\r\n\r\n  // Update color picker emoji in systems bar\r\n  const currentColorEmoji = getColorEmoji(data.notificationColor || '#3498db');\r\n  const colorEmojiEl = document.getElementById('color-emoji');\r\n  if (colorEmojiEl) {\r\n    colorEmojiEl.textContent = currentColorEmoji;\r\n  }\r\n\r\n  // Populate color palette in systems bar (but keep it hidden initially)\r\n  const colorPaletteEl = document.getElementById('color-palette');\r\n  if (colorPaletteEl) {\r\n    colorPaletteEl.innerHTML = createColorPalette(data.notificationColor || '#3498db');\r\n    colorPaletteEl.style.display = 'none'; // Start hidden - user must click to show\r\n    colorPaletteEl.style.gridTemplateColumns = 'repeat(4, 1fr)';\r\n    colorPaletteEl.style.gap = '10px';\r\n    colorPaletteEl.style.width = '180px';\r\n  }\r\n\r\n  // Initialize hit dice if needed\r\n  initializeHitDice();\r\n\r\n  // Initialize temporary HP if needed\r\n  if (data.temporaryHP === undefined) {\r\n    data.temporaryHP = 0;\r\n  }\r\n\r\n  // Initialize inspiration if needed\r\n  if (data.inspiration === undefined) {\r\n    data.inspiration = false;\r\n  }\r\n\r\n  // Initialize last roll tracking for heroic inspiration\r\n  if (data.lastRoll === undefined) {\r\n    data.lastRoll = null;\r\n  }\r\n\r\n  // Capitalize race name - handle both string and object formats\r\n  let raceName = 'Unknown';\r\n  if (data.race) {\r\n    if (typeof data.race === 'string') {\r\n      raceName = data.race.charAt(0).toUpperCase() + data.race.slice(1);\r\n    } else if (typeof data.race === 'object') {\r\n      // If race is an object, try to extract the value from various possible properties\r\n      let raceValue = data.race.value || data.race.name || data.race.text ||\r\n                      data.race.variableName || data.race.displayName;\r\n\r\n      // If still no value, try to get something useful from the object\r\n      if (!raceValue) {\r\n        // Check if it has a tags property that might indicate race type\r\n        if (data.race.tags && Array.isArray(data.race.tags)) {\r\n          const raceTags = data.race.tags.filter(tag =>\r\n            !tag.toLowerCase().includes('class') &&\r\n            !tag.toLowerCase().includes('level')\r\n          );\r\n          if (raceTags.length > 0) {\r\n            raceValue = raceTags[0];\r\n          }\r\n        }\r\n\r\n        // Last resort: look for any string property that seems like a race name\r\n        if (!raceValue) {\r\n          const keys = Object.keys(data.race);\r\n          for (const key of keys) {\r\n            if (typeof data.race[key] === 'string' && data.race[key].length > 0 && data.race[key].length < 50) {\r\n              raceValue = data.race[key];\r\n              break;\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // If we found something, capitalize it; otherwise use \"Unknown\"\r\n      if (raceValue && typeof raceValue === 'string') {\r\n        raceName = raceValue.charAt(0).toUpperCase() + raceValue.slice(1);\r\n      } else {\r\n        debug.warn('Could not extract race name from object:', data.race);\r\n        raceName = 'Unknown Race';\r\n      }\r\n    }\r\n  }\r\n\r\n  // Layer 1: Class, Level, Race, Hit Dice\r\n  document.getElementById('char-class').textContent = data.class || 'Unknown';\r\n  document.getElementById('char-level').textContent = data.level || 1;\r\n  document.getElementById('char-race').textContent = raceName;\r\n  // Defensive initialization for hitDice\r\n  if (!data.hitDice) {\r\n    data.hitDice = { current: 0, max: 0, type: 'd6' };\r\n  }\r\n  \r\n  document.getElementById('char-hit-dice').textContent = `${data.hitDice.current || 0}/${data.hitDice.max || 0} ${data.hitDice.type || 'd6'}`;\r\n\r\n  // Layer 2: AC, Speed, Proficiency, Death Saves, Inspiration\r\n  document.getElementById('char-ac').textContent = calculateTotalAC();\r\n  document.getElementById('char-speed').textContent = `${data.speed || 30} ft`;\r\n  document.getElementById('char-proficiency').textContent = `+${data.proficiencyBonus || 0}`;\r\n\r\n  // Death Saves\r\n  const deathSavesDisplay = document.getElementById('death-saves-display');\r\n  const deathSavesValue = document.getElementById('death-saves-value');\r\n  \r\n  // Defensive initialization for deathSaves\r\n  if (!data.deathSaves) {\r\n    data.deathSaves = { successes: 0, failures: 0 };\r\n  }\r\n  \r\n  deathSavesValue.innerHTML = `\r\n    <span style=\"color: var(--accent-success);\">\u2713${data.deathSaves.successes || 0}</span> /\r\n    <span style=\"color: var(--accent-danger);\">\u2717${data.deathSaves.failures || 0}</span>\r\n  `;\r\n  if (data.deathSaves.successes > 0 || data.deathSaves.failures > 0) {\r\n    deathSavesDisplay.style.background = 'var(--bg-action)';\r\n  } else {\r\n    deathSavesDisplay.style.background = 'var(--bg-tertiary)';\r\n  }\r\n\r\n  // Inspiration\r\n  const inspirationDisplay = document.getElementById('inspiration-display');\r\n  const inspirationValue = document.getElementById('inspiration-value');\r\n  if (data.inspiration) {\r\n    inspirationValue.textContent = '\u2B50 Active';\r\n    inspirationValue.style.color = '#f57f17';\r\n    inspirationDisplay.style.background = '#fff9c4';\r\n  } else {\r\n    inspirationValue.textContent = '\u2606 None';\r\n    inspirationValue.style.color = 'var(--text-muted)';\r\n    inspirationDisplay.style.background = 'var(--bg-tertiary)';\r\n  }\r\n\r\n  // Layer 3: Hit Points\r\n  const hpValue = document.getElementById('hp-value');\r\n  \r\n  // Defensive initialization for hitPoints\r\n  if (!data.hitPoints) {\r\n    data.hitPoints = { current: 0, max: 0, temporaryHP: 0 };\r\n  }\r\n  \r\n  hpValue.textContent = `${data.hitPoints.current}${data.temporaryHP > 0 ? `+${data.temporaryHP}` : ''} / ${data.hitPoints.max}`;\r\n\r\n  // Initiative\r\n  const initiativeValue = document.getElementById('initiative-value');\r\n  initiativeValue.textContent = `+${data.initiative || 0}`;\r\n\r\n  // Remove old event listeners by cloning and replacing elements\r\n  // This prevents duplicate listeners when buildSheet() is called multiple times\r\n  const hpDisplayOld = document.getElementById('hp-display');\r\n  const hpDisplayNew = hpDisplayOld.cloneNode(true);\r\n  hpDisplayOld.parentNode.replaceChild(hpDisplayNew, hpDisplayOld);\r\n\r\n  const initiativeOld = document.getElementById('initiative-button');\r\n  const initiativeNew = initiativeOld.cloneNode(true);\r\n  initiativeOld.parentNode.replaceChild(initiativeNew, initiativeOld);\r\n\r\n  const deathSavesOld = document.getElementById('death-saves-display');\r\n  const deathSavesNew = deathSavesOld.cloneNode(true);\r\n  deathSavesOld.parentNode.replaceChild(deathSavesNew, deathSavesOld);\r\n\r\n  const inspirationOld = document.getElementById('inspiration-display');\r\n  const inspirationNew = inspirationOld.cloneNode(true);\r\n  inspirationOld.parentNode.replaceChild(inspirationNew, inspirationOld);\r\n\r\n  // Add click handler for HP display\r\n  hpDisplayNew.addEventListener('click', showHPModal);\r\n\r\n  // Add click handler for initiative button\r\n  initiativeNew.addEventListener('click', () => {\r\n    const initiativeBonus = data.initiative || 0;\r\n    roll('Initiative', `1d20+${initiativeBonus}`);\r\n  });\r\n\r\n  // Add click handler for death saves display\r\n  deathSavesNew.addEventListener('click', showDeathSavesModal);\r\n\r\n  // Add click handler for inspiration display\r\n  inspirationNew.addEventListener('click', toggleInspiration);\r\n\r\n  // Update HP display color based on percentage\r\n  const hpPercent = data.hitPoints && data.hitPoints.max > 0 ? (data.hitPoints.current / data.hitPoints.max) * 100 : 0;\r\n  // Use the new hpDisplayNew element we just created above\r\n  if (hpPercent > 50) {\r\n    hpDisplayNew.style.background = 'var(--accent-success)';\r\n  } else if (hpPercent > 25) {\r\n    hpDisplayNew.style.background = 'var(--accent-warning)';\r\n  } else {\r\n    hpDisplayNew.style.background = 'var(--accent-danger)';\r\n  }\r\n\r\n  // Resources\r\n  buildResourcesDisplay();\r\n\r\n  // Spell Slots\r\n  buildSpellSlotsDisplay();\r\n\r\n  // Abilities\r\n  const abilitiesGrid = document.getElementById('abilities-grid');\r\n  abilitiesGrid.innerHTML = ''; // Clear existing\r\n  const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];\r\n  abilities.forEach(ability => {\r\n    const score = data.attributes?.[ability] || 10;\r\n    const mod = data.attributeMods?.[ability] || 0;\r\n    const card = createCard(ability.substring(0, 3).toUpperCase(), score, `+${mod}`, () => {\r\n      roll(`${ability.charAt(0).toUpperCase() + ability.slice(1)} Check`, `1d20+${mod}`);\r\n    });\r\n    abilitiesGrid.appendChild(card);\r\n  });\r\n\r\n  // Saves\r\n  const savesGrid = document.getElementById('saves-grid');\r\n  savesGrid.innerHTML = ''; // Clear existing\r\n  abilities.forEach(ability => {\r\n    const bonus = data.savingThrows?.[ability] || 0;\r\n    const card = createCard(`${ability.substring(0, 3).toUpperCase()}`, `+${bonus}`, '', () => {\r\n      roll(`${ability.toUpperCase()} Save`, `1d20+${bonus}`);\r\n    });\r\n    savesGrid.appendChild(card);\r\n  });\r\n\r\n  // Skills - deduplicate and show unique skills only\r\n  const skillsGrid = document.getElementById('skills-grid');\r\n  skillsGrid.innerHTML = ''; // Clear existing\r\n\r\n  // Create a map to deduplicate skills (in case data has duplicates)\r\n  const uniqueSkills = new Map();\r\n  Object.entries(data.skills || {}).forEach(([skill, bonus]) => {\r\n    const normalizedSkill = skill.toLowerCase().trim();\r\n    // Only keep the skill if we haven't seen it, or if this bonus is higher\r\n    if (!uniqueSkills.has(normalizedSkill) || bonus > uniqueSkills.get(normalizedSkill).bonus) {\r\n      uniqueSkills.set(normalizedSkill, { skill, bonus });\r\n    }\r\n  });\r\n\r\n  // Sort skills alphabetically and display\r\n  const sortedSkills = Array.from(uniqueSkills.values()).sort((a, b) =>\r\n    a.skill.localeCompare(b.skill)\r\n  );\r\n\r\n  sortedSkills.forEach(({ skill, bonus }) => {\r\n    const displayName = skill.charAt(0).toUpperCase() + skill.slice(1).replace(/-/g, ' ');\r\n    const card = createCard(displayName, `${bonus >= 0 ? '+' : ''}${bonus}`, '', () => {\r\n      roll(displayName, `1d20${bonus >= 0 ? '+' : ''}${bonus}`);\r\n    });\r\n    skillsGrid.appendChild(card);\r\n  });\r\n\r\n  // Actions & Attacks\r\n  const actionsContainer = document.getElementById('actions-container');\r\n  if (data.actions && Array.isArray(data.actions) && data.actions.length > 0) {\r\n    buildActionsDisplay(actionsContainer, data.actions);\r\n  } else {\r\n    actionsContainer.innerHTML = '<p style=\"text-align: center; color: #666;\">No actions available</p>';\r\n  }\r\n\r\n  // Companions (Animal Companions, Familiars, Summons, etc.)\r\n  if (data.companions && Array.isArray(data.companions) && data.companions.length > 0) {\r\n    buildCompanionsDisplay(data.companions);\r\n  } else {\r\n    // Hide companions section if character has no companions\r\n    const companionsSection = document.getElementById('companions-container');\r\n    if (companionsSection) {\r\n      companionsSection.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  // Inventory & Equipment\r\n  const inventoryContainer = document.getElementById('inventory-container');\r\n  if (data.inventory && Array.isArray(data.inventory) && data.inventory.length > 0) {\r\n    buildInventoryDisplay(inventoryContainer, data.inventory);\r\n  } else {\r\n    inventoryContainer.innerHTML = '<p style=\"text-align: center; color: var(--text-secondary);\">No items in inventory</p>';\r\n  }\r\n\r\n  // Spells - organized by source then level\r\n  const spellsContainer = document.getElementById('spells-container');\r\n  if (data.spells && Array.isArray(data.spells) && data.spells.length > 0) {\r\n    buildSpellsBySource(spellsContainer, data.spells);\r\n    expandSectionByContainerId('spells-container');\r\n  } else {\r\n    spellsContainer.innerHTML = '<p style=\"text-align: center; color: var(--text-secondary);\">No spells prepared</p>';\r\n    // Collapse the section when empty\r\n    collapseSectionByContainerId('spells-container');\r\n  }\r\n\r\n  // Restore active effects from character data\r\n  if (data.activeEffects) {\r\n    activeBuffs = data.activeEffects.buffs || [];\r\n    activeConditions = data.activeEffects.debuffs || [];\r\n    debug.log('\u2705 Restored active effects:', { buffs: activeBuffs, debuffs: activeConditions });\r\n  } else {\r\n    activeBuffs = [];\r\n    activeConditions = [];\r\n  }\r\n  \r\n  // Sync conditions from Dicecloud (if any were detected as active)\r\n  if (data.conditions && Array.isArray(data.conditions) && data.conditions.length > 0) {\r\n    debug.log('\u2728 Syncing conditions from Dicecloud:', data.conditions);\r\n    data.conditions.forEach(condition => {\r\n      // Map Dicecloud condition names to our effect names\r\n      const conditionName = condition.name;\r\n      const isPositive = POSITIVE_EFFECTS.some(e => e.name === conditionName);\r\n      const isNegative = NEGATIVE_EFFECTS.some(e => e.name === conditionName);\r\n      \r\n      if (isPositive && !activeBuffs.includes(conditionName)) {\r\n        activeBuffs.push(conditionName);\r\n        debug.log(`  \u2705 Added buff from Dicecloud: ${conditionName}`);\r\n      } else if (isNegative && !activeConditions.includes(conditionName)) {\r\n        activeConditions.push(conditionName);\r\n        debug.log(`  \u2705 Added debuff from Dicecloud: ${conditionName}`);\r\n      }\r\n    });\r\n  }\r\n  \r\n  updateEffectsDisplay();\r\n\r\n  // Initialize color palette after sheet is built\r\n  initColorPalette();\r\n\r\n  // Initialize filter event listeners\r\n  initializeFilters();\r\n\r\n  debug.log('\u2705 Sheet built successfully');\r\n}\r\n\r\nfunction buildSpellsBySource(container, spells) {\r\n  debug.log(`\uD83D\uDCDA buildSpellsBySource called with ${spells.length} spells`);\r\n  debug.log(`\uD83D\uDCDA Spell names: ${spells.map(s => s.name).join(', ')}`);\r\n\r\n  // Debug: Check for Eldritch Blast damageRolls\r\n  const eldritchBlast = spells.find(s => s.name && s.name.toLowerCase().includes('eldritch blast'));\r\n  if (eldritchBlast) {\r\n    console.log('\u26A1 ELDRITCH BLAST DATA IN POPUP:', {\r\n      name: eldritchBlast.name,\r\n      attackRoll: eldritchBlast.attackRoll,\r\n      damageRolls: eldritchBlast.damageRolls,\r\n      damageRollsLength: eldritchBlast.damageRolls ? eldritchBlast.damageRolls.length : 'undefined',\r\n      damageRollsJSON: JSON.stringify(eldritchBlast.damageRolls)\r\n    });\r\n  }\r\n\r\n  // Apply filters first\r\n  let filteredSpells = spells.filter(spell => {\r\n    // Filter out duplicate Divine Smite entries - keep only the main one\r\n    const spellName = (spell.name || '').toLowerCase();\r\n    if (spellName.includes('divine smite')) {\r\n      // Skip variants like \"Divine Smite Level 1\", \"Divine Smite (Against Fiends, Critical) Level 1\", etc.\r\n      // Keep only the base \"Divine Smite\" entry\r\n      if (spellName !== 'divine smite' && !spellName.match(/^divine smite$/)) {\r\n        debug.log(`\u23ED\uFE0F Filtering out duplicate Divine Smite spell: ${spell.name}`);\r\n        return false;\r\n      } else {\r\n        debug.log(`\u2705 Keeping main Divine Smite spell: ${spell.name}`);\r\n      }\r\n    }\r\n    \r\n    // Filter by spell level\r\n    if (spellFilters.level !== 'all') {\r\n      const spellLevel = parseInt(spell.level) || 0;\r\n      if (spellLevel.toString() !== spellFilters.level) {\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    // Filter by category\r\n    if (spellFilters.category !== 'all') {\r\n      const category = categorizeSpell(spell);\r\n      if (category !== spellFilters.category) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    // Filter by casting time\r\n    if (spellFilters.castingTime !== 'all') {\r\n      const castingTime = (spell.castingTime || '').toLowerCase();\r\n      if (spellFilters.castingTime === 'action') {\r\n        // Match \"action\" but exclude \"bonus action\" and \"reaction\"\r\n        if (!castingTime.includes('action') || castingTime.includes('bonus') || castingTime.includes('reaction')) {\r\n          return false;\r\n        }\r\n      }\r\n      if (spellFilters.castingTime === 'bonus' && !castingTime.includes('bonus')) {\r\n        return false;\r\n      }\r\n      if (spellFilters.castingTime === 'reaction' && !castingTime.includes('reaction')) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    // Filter by search term\r\n    if (spellFilters.search) {\r\n      const searchLower = spellFilters.search;\r\n      const name = (spell.name || '').toLowerCase();\r\n      const desc = (spell.description || '').toLowerCase();\r\n      if (!name.includes(searchLower) && !desc.includes(searchLower)) {\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    return true;\r\n  });\r\n\r\n  debug.log(`\uD83D\uDD0D Filtered ${spells.length} spells to ${filteredSpells.length} spells`);\r\n\r\n  // Group spells by actual spell level (not source)\r\n  const spellsByLevel = {};\r\n\r\n  filteredSpells.forEach((spell, index) => {\r\n    // Add index to spell for tracking\r\n    spell.index = index;\r\n\r\n    // Use spell level for grouping\r\n    const spellLevel = parseInt(spell.level) || 0;\r\n    const levelKey = spellLevel === 0 ? 'Cantrips' : `Level ${spellLevel} Spells`;\r\n\r\n    if (!spellsByLevel[levelKey]) {\r\n      spellsByLevel[levelKey] = [];\r\n    }\r\n    spellsByLevel[levelKey].push(spell);\r\n  });\r\n\r\n  // Clear container\r\n  container.innerHTML = '';\r\n\r\n  // Sort by spell level (cantrips first, then 1-9)\r\n  const sortedLevels = Object.keys(spellsByLevel).sort((a, b) => {\r\n    if (a === 'Cantrips') return -1;\r\n    if (b === 'Cantrips') return 1;\r\n    return a.localeCompare(b, undefined, { numeric: true });\r\n  });\r\n\r\n  sortedLevels.forEach(levelKey => {\r\n    // Create level section\r\n    const levelSection = document.createElement('div');\r\n    levelSection.style.cssText = 'margin-bottom: 20px;';\r\n\r\n    const levelHeader = document.createElement('h4');\r\n    levelHeader.textContent = `\uD83D\uDCDA ${levelKey}`;\r\n    levelHeader.style.cssText = 'color: #2c3e50; margin-bottom: 10px; padding: 5px; background: #ecf0f1; border-radius: 4px;';\r\n    levelSection.appendChild(levelHeader);\r\n\r\n    // Sort spells alphabetically within level\r\n    const sortedSpells = spellsByLevel[levelKey].sort((a, b) => {\r\n      return (a.name || '').localeCompare(b.name || '');\r\n    });\r\n\r\n    // Deduplicate spells by name and combine sources\r\n    const deduplicatedSpells = [];\r\n    const spellsByName = {};\r\n\r\n    debug.log(`\uD83D\uDCDA Deduplicating ${sortedSpells.length} spells in ${levelKey}`);\r\n    sortedSpells.forEach(spell => {\r\n      const spellName = spell.name || 'Unnamed Spell';\r\n\r\n      if (!spellsByName[spellName]) {\r\n        // First occurrence of this spell\r\n        spellsByName[spellName] = spell;\r\n        deduplicatedSpells.push(spell);\r\n        debug.log(`\uD83D\uDCDA First occurrence: \"${spellName}\"`);\r\n      } else {\r\n        // Duplicate spell - combine sources\r\n        const existingSpell = spellsByName[spellName];\r\n        debug.log(`\uD83D\uDCDA Found duplicate: \"${spellName}\" - combining sources`);\r\n        if (spell.source && !existingSpell.source.includes(spell.source)) {\r\n          existingSpell.source += '; ' + spell.source;\r\n          debug.log(`\uD83D\uDCDA Combined duplicate spell \"${spellName}\": ${existingSpell.source}`);\r\n        }\r\n      }\r\n    });\r\n    debug.log(`\uD83D\uDCDA After deduplication: ${deduplicatedSpells.length} unique spells in ${levelKey}`);\r\n\r\n    // Add deduplicated spells\r\n    deduplicatedSpells.forEach(spell => {\r\n      const spellCard = createSpellCard(spell, spell.index);\r\n      levelSection.appendChild(spellCard);\r\n    });\r\n\r\n    container.appendChild(levelSection);\r\n  });\r\n}\r\n\r\n// Store Sneak Attack toggle state (independent from DiceCloud - controlled only by our sheet)\r\nlet sneakAttackEnabled = false;  // Always starts unchecked - user manually enables when needed\r\nlet sneakAttackDamage = '';\r\n\r\n// Store Elemental Weapon toggle state (independent from DiceCloud - controlled only by our sheet)\r\nlet elementalWeaponEnabled = false;  // Always starts unchecked - user manually enables when needed\r\nlet elementalWeaponDamage = '1d4';  // Default to level 3 (base damage)\r\n\r\n// Filter state for actions\r\nlet actionFilters = {\r\n  actionType: 'all',\r\n  category: 'all',\r\n  search: ''\r\n};\r\n\r\n// Filter state for spells\r\nlet spellFilters = {\r\n  level: 'all',\r\n  category: 'all',\r\n  castingTime: 'all',\r\n  search: ''\r\n};\r\n\r\n// Filter state for inventory (default to equipped only)\r\nlet inventoryFilters = {\r\n  filter: 'equipped', // all, equipped, attuned, container\r\n  search: ''\r\n};\r\n\r\n// Helper function to categorize an action\r\nfunction categorizeAction(action) {\r\n  const name = (action.name || '').toLowerCase();\r\n  const damageType = (action.damageType || '').toLowerCase();\r\n\r\n  // Check for healing based on damage type or name\r\n  if (damageType.includes('heal') || name.includes('heal') || name.includes('cure')) {\r\n    return 'healing';\r\n  }\r\n\r\n  // Check for damage based on actual damage formula\r\n  if (action.damage && action.damage.includes('d')) {\r\n    return 'damage';\r\n  }\r\n\r\n  // Everything else is utility\r\n  return 'utility';\r\n}\r\n\r\n// Helper function to categorize a spell\r\nfunction categorizeSpell(spell) {\r\n  // Use actual spell data instead of string matching in description\r\n  // Check damageRolls array to determine if it's damage or healing\r\n  if (spell.damageRolls && Array.isArray(spell.damageRolls) && spell.damageRolls.length > 0) {\r\n    // Check if any damage roll is healing\r\n    const hasHealing = spell.damageRolls.some(roll =>\r\n      roll.damageType && roll.damageType.toLowerCase() === 'healing'\r\n    );\r\n\r\n    // Check if any damage roll is actual damage (not healing)\r\n    const hasDamage = spell.damageRolls.some(roll =>\r\n      !roll.damageType || roll.damageType.toLowerCase() !== 'healing'\r\n    );\r\n\r\n    // Categorize based on what the spell actually does\r\n    if (hasHealing && !hasDamage) {\r\n      return 'healing';\r\n    } else if (hasDamage) {\r\n      return 'damage';\r\n    }\r\n  }\r\n\r\n  // Check for attack roll (attack spells are damage)\r\n  if (spell.attackRoll && spell.attackRoll !== '(none)') {\r\n    return 'damage';\r\n  }\r\n\r\n  // Everything else is utility (no damage rolls, no attack roll)\r\n  return 'utility';\r\n}\r\n\r\n// Initialize filter event listeners\r\nfunction initializeFilters() {\r\n  // Actions filters\r\n  const actionsSearch = document.getElementById('actions-search');\r\n  if (actionsSearch) {\r\n    actionsSearch.addEventListener('input', (e) => {\r\n      actionFilters.search = e.target.value.toLowerCase();\r\n      rebuildActions();\r\n    });\r\n  }\r\n  \r\n  // Action type filters\r\n  document.querySelectorAll('[data-type=\"action-type\"]').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      actionFilters.actionType = btn.dataset.filter;\r\n      document.querySelectorAll('[data-type=\"action-type\"]').forEach(b => b.classList.remove('active'));\r\n      btn.classList.add('active');\r\n      rebuildActions();\r\n    });\r\n  });\r\n  \r\n  // Action category filters\r\n  document.querySelectorAll('[data-type=\"action-category\"]').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      actionFilters.category = btn.dataset.filter;\r\n      document.querySelectorAll('[data-type=\"action-category\"]').forEach(b => b.classList.remove('active'));\r\n      btn.classList.add('active');\r\n      rebuildActions();\r\n    });\r\n  });\r\n  \r\n  // Spells filters\r\n  const spellsSearch = document.getElementById('spells-search');\r\n  if (spellsSearch) {\r\n    spellsSearch.addEventListener('input', (e) => {\r\n      spellFilters.search = e.target.value.toLowerCase();\r\n      rebuildSpells();\r\n    });\r\n  }\r\n  \r\n  // Spell level filters\r\n  document.querySelectorAll('[data-type=\"spell-level\"]').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      spellFilters.level = btn.dataset.filter;\r\n      document.querySelectorAll('[data-type=\"spell-level\"]').forEach(b => b.classList.remove('active'));\r\n      btn.classList.add('active');\r\n      rebuildSpells();\r\n    });\r\n  });\r\n  \r\n  // Spell category filters\r\n  document.querySelectorAll('[data-type=\"spell-category\"]').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      spellFilters.category = btn.dataset.filter;\r\n      document.querySelectorAll('[data-type=\"spell-category\"]').forEach(b => b.classList.remove('active'));\r\n      btn.classList.add('active');\r\n      rebuildSpells();\r\n    });\r\n  });\r\n\r\n  // Spell casting time filters\r\n  document.querySelectorAll('[data-type=\"spell-casting-time\"]').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      spellFilters.castingTime = btn.dataset.filter;\r\n      document.querySelectorAll('[data-type=\"spell-casting-time\"]').forEach(b => b.classList.remove('active'));\r\n      btn.classList.add('active');\r\n      rebuildSpells();\r\n    });\r\n  });\r\n\r\n  // Inventory filters\r\n  const inventorySearch = document.getElementById('inventory-search');\r\n  if (inventorySearch) {\r\n    inventorySearch.addEventListener('input', (e) => {\r\n      inventoryFilters.search = e.target.value.toLowerCase();\r\n      rebuildInventory();\r\n    });\r\n  }\r\n\r\n  // Inventory type filters\r\n  document.querySelectorAll('[data-type=\"inventory-filter\"]').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      inventoryFilters.filter = btn.dataset.filter;\r\n      document.querySelectorAll('[data-type=\"inventory-filter\"]').forEach(b => b.classList.remove('active'));\r\n      btn.classList.add('active');\r\n      rebuildInventory();\r\n    });\r\n  });\r\n}\r\n\r\n// Rebuild actions with current filters\r\nfunction rebuildActions() {\r\n  if (!characterData || !characterData.actions) return;\r\n  const container = document.getElementById('actions-container');\r\n  buildActionsDisplay(container, characterData.actions);\r\n}\r\n\r\n// Rebuild spells with current filters\r\nfunction rebuildSpells() {\r\n  if (!characterData || !characterData.spells) return;\r\n  const container = document.getElementById('spells-container');\r\n  buildSpellsBySource(container, characterData.spells);\r\n}\r\n\r\n// Rebuild inventory with current filters\r\nfunction rebuildInventory() {\r\n  if (!characterData || !characterData.inventory) return;\r\n  const container = document.getElementById('inventory-container');\r\n  buildInventoryDisplay(container, characterData.inventory);\r\n}\r\n\r\n/**\r\n * Get available action options (attack/damage rolls) with edge case modifications\r\n */\r\nfunction getActionOptions(action) {\r\n  const options = [];\r\n\r\n  // Check for attack\r\n  if (action.attackRoll) {\r\n    // Convert to full formula if it's just a number (legacy data)\r\n    let formula = action.attackRoll;\r\n    if (typeof formula === 'number' || !formula.includes('d20')) {\r\n      const bonus = parseInt(formula);\r\n      formula = bonus >= 0 ? `1d20+${bonus}` : `1d20${bonus}`;\r\n    }\r\n\r\n    options.push({\r\n      type: 'attack',\r\n      label: '\uD83C\uDFAF Attack',\r\n      formula: formula,\r\n      icon: '\uD83C\uDFAF',\r\n      color: '#e74c3c'\r\n    });\r\n  }\r\n\r\n  // Check for damage/healing rolls\r\n  const isValidDiceFormula = action.damage && (/\\d*d\\d+/.test(action.damage) || /\\d*d\\d+/.test(action.damage.replace(/\\s*\\+\\s*/g, '+')));\r\n  debug.log(`\uD83C\uDFB2 Action \"${action.name}\" damage check:`, {\r\n    damage: action.damage,\r\n    isValid: isValidDiceFormula,\r\n    attackRoll: action.attackRoll\r\n  });\r\n  if (isValidDiceFormula) {\r\n    const isHealing = action.damageType && action.damageType.toLowerCase().includes('heal');\r\n    const isTempHP = action.damageType && (\r\n      action.damageType.toLowerCase() === 'temphp' ||\r\n      action.damageType.toLowerCase() === 'temporary' ||\r\n      action.damageType.toLowerCase().includes('temp')\r\n    );\r\n\r\n    // Use different text for healing vs damage vs features\r\n    let btnText;\r\n    if (isHealing) {\r\n      btnText = '\uD83D\uDC9A Heal';\r\n    } else if (action.actionType === 'feature' || !action.attackRoll) {\r\n      btnText = '\uD83C\uDFB2 Roll';\r\n    } else {\r\n      btnText = '\uD83D\uDCA5 Damage';\r\n    }\r\n\r\n    options.push({\r\n      type: isHealing ? 'healing' : (isTempHP ? 'temphp' : 'damage'),\r\n      label: btnText,\r\n      formula: action.damage,\r\n      icon: isTempHP ? '\uD83D\uDEE1\uFE0F' : (isHealing ? '\uD83D\uDC9A' : '\uD83D\uDCA5'),\r\n      color: isTempHP ? '#3498db' : (isHealing ? '#27ae60' : '#e67e22')\r\n    });\r\n  }\r\n\r\n  // Apply edge case modifications\r\n  let edgeCaseResult;\r\n  \r\n  // Check class feature edge cases first\r\n  if (isClassFeatureEdgeCase(action.name)) {\r\n    edgeCaseResult = applyClassFeatureEdgeCaseModifications(action, options);\r\n    debug.log(`\uD83D\uDD0D Edge case applied for \"${action.name}\": skipNormalButtons = ${edgeCaseResult.skipNormalButtons}`);\r\n  }\r\n  // Check racial feature edge cases\r\n  else if (isRacialFeatureEdgeCase(action.name)) {\r\n    edgeCaseResult = applyRacialFeatureEdgeCaseModifications(action, options);\r\n    debug.log(`\uD83D\uDD0D Edge case applied for \"${action.name}\": skipNormalButtons = ${edgeCaseResult.skipNormalButtons}`);\r\n  }\r\n  // Check combat maneuver edge cases\r\n  else if (isCombatManeuverEdgeCase(action.name)) {\r\n    edgeCaseResult = applyCombatManeuverEdgeCaseModifications(action, options);\r\n    debug.log(`\uD83D\uDD0D Edge case applied for \"${action.name}\": skipNormalButtons = ${edgeCaseResult.skipNormalButtons}`);\r\n  }\r\n  // Default - no edge cases\r\n  else {\r\n    edgeCaseResult = { options, skipNormalButtons: false };\r\n    debug.log(`\uD83D\uDD0D No edge case for \"${action.name}\": skipNormalButtons = false`);\r\n  }\r\n\r\n  return edgeCaseResult;\r\n}\r\n\r\nfunction buildActionsDisplay(container, actions) {\r\n  // Clear container\r\n  container.innerHTML = '';\r\n\r\n  // DEBUG: Log all actions to see what we have\r\n  debug.log('\uD83D\uDD0D buildActionsDisplay called with actions:', actions.map(a => ({ name: a.name, damage: a.damage, actionType: a.actionType })));\r\n\r\n  // Deduplicate actions by name and combine sources (similar to spells)\r\n  const deduplicatedActions = [];\r\n  const actionsByName = {};\r\n\r\n  // Sort actions by name for consistent processing\r\n  const sortedActions = [...actions].sort((a, b) => (a.name || '').localeCompare(b.name || ''));\r\n\r\n  sortedActions.forEach(action => {\r\n    const actionName = (action.name || '').trim();\r\n    \r\n    if (!actionName) {\r\n      debug.log('\u26A0\uFE0F Skipping action with no name');\r\n      return;\r\n    }\r\n\r\n    if (!actionsByName[actionName]) {\r\n      // First occurrence of this action\r\n      actionsByName[actionName] = action;\r\n      deduplicatedActions.push(action);\r\n      debug.log(`\uD83D\uDCDD First occurrence of action: \"${actionName}\"`);\r\n    } else {\r\n      // Duplicate action - combine sources and other properties\r\n      const existingAction = actionsByName[actionName];\r\n      \r\n      // Combine sources if they exist\r\n      if (action.source && !existingAction.source.includes(action.source)) {\r\n        existingAction.source = existingAction.source \r\n          ? existingAction.source + '; ' + action.source \r\n          : action.source;\r\n        debug.log(`\uD83D\uDCDD Combined duplicate action \"${actionName}\": ${existingAction.source}`);\r\n      }\r\n      \r\n      // Combine descriptions if they exist and are different\r\n      if (action.description && action.description !== existingAction.description) {\r\n        existingAction.description = existingAction.description \r\n          ? existingAction.description + '\\n\\n' + action.description \r\n          : action.description;\r\n        debug.log(`\uD83D\uDCDD Combined descriptions for \"${actionName}\"`);\r\n      }\r\n      \r\n      // Merge other useful properties\r\n      if (action.uses && !existingAction.uses) {\r\n        existingAction.uses = action.uses;\r\n        debug.log(`\uD83D\uDCDD Added uses to \"${actionName}\"`);\r\n      }\r\n      \r\n      if (action.damage && !existingAction.damage) {\r\n        existingAction.damage = action.damage;\r\n        debug.log(`\uD83D\uDCDD Added damage to \"${actionName}\"`);\r\n      }\r\n      \r\n      if (action.attackRoll && !existingAction.attackRoll) {\r\n        existingAction.attackRoll = action.attackRoll;\r\n        debug.log(`\uD83D\uDCDD Added attackRoll to \"${actionName}\"`);\r\n      }\r\n      \r\n      debug.log(`\uD83D\uDD04 Merged duplicate action: \"${actionName}\"`);\r\n    }\r\n  });\r\n\r\n  debug.log(`\uD83D\uDCCA Deduplicated ${actions.length} actions to ${deduplicatedActions.length} unique actions`);\r\n\r\n  // Apply filters\r\n  let filteredActions = deduplicatedActions.filter(action => {\r\n    const actionName = (action.name || '').toLowerCase();\r\n    \r\n    // Filter out duplicate Divine Smite entries - keep only the main one\r\n    if (actionName.includes('divine smite')) {\r\n      // Skip variants like \"Divine Smite Level 1\", \"Divine Smite (Against Fiends, Critical) Level 1\", etc.\r\n      // Keep only the base \"Divine Smite\" entry\r\n      if (actionName !== 'divine smite' && !actionName.match(/^divine smite$/)) {\r\n        debug.log(`\u23ED\uFE0F Filtering out duplicate Divine Smite entry: ${action.name}`);\r\n        return false;\r\n      } else {\r\n        debug.log(`\u2705 Keeping main Divine Smite entry: ${action.name}`);\r\n      }\r\n    }\r\n    \r\n    // Debug: Log all Lay on Hands related actions\r\n    if (actionName.includes('lay on hands')) {\r\n      const normalizedActionName = action.name.toLowerCase()\r\n        .replace(/[^a-z0-9\\s:]/g, '') // Remove special chars except colon and space\r\n        .replace(/\\s+/g, ' ') // Normalize spaces\r\n        .trim();\r\n      const normalizedSearch = 'lay on hands: heal';\r\n      \r\n      debug.log(`\uD83D\uDD0D Found Lay on Hands action: \"${action.name}\"`);\r\n      debug.log(`\uD83D\uDD0D Normalized action name: \"${normalizedActionName}\"`);\r\n      debug.log(`\uD83D\uDD0D Normalized search term: \"${normalizedSearch}\"`);\r\n      debug.log(`\uD83D\uDD0D Do they match? ${normalizedActionName === normalizedSearch}`);\r\n      debug.log(`\uD83D\uDD0D Action object:`, action);\r\n    }\r\n    \r\n    // Filter by action type\r\n    if (actionFilters.actionType !== 'all') {\r\n      const actionType = (action.actionType || '').toLowerCase();\r\n      if (actionType !== actionFilters.actionType) {\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    // Filter by category\r\n    if (actionFilters.category !== 'all') {\r\n      const category = categorizeAction(action);\r\n      if (category !== actionFilters.category) {\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    // Filter by search term\r\n    if (actionFilters.search) {\r\n      const searchLower = actionFilters.search;\r\n      const name = (action.name || '').toLowerCase();\r\n      const desc = (action.description || '').toLowerCase();\r\n      if (!name.includes(searchLower) && !desc.includes(searchLower)) {\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    return true;\r\n  });\r\n\r\n  debug.log(`\uD83D\uDD0D Filtered ${deduplicatedActions.length} actions to ${filteredActions.length} actions`);\r\n\r\n  // Check if character has Sneak Attack available (from DiceCloud)\r\n  // We only check if it EXISTS, not whether it's enabled on DiceCloud\r\n  // The toggle state on our sheet is independent and user-controlled\r\n  // Use flexible matching in case the name has slight variations\r\n  const sneakAttackAction = deduplicatedActions.find(a =>\r\n    a.name === 'Sneak Attack' ||\r\n    a.name.toLowerCase().includes('sneak attack')\r\n  );\r\n  debug.log('\uD83C\uDFAF Sneak Attack search result:', sneakAttackAction);\r\n  if (sneakAttackAction && sneakAttackAction.damage) {\r\n    sneakAttackDamage = sneakAttackAction.damage;\r\n\r\n    // Resolve variables in the damage formula for display\r\n    const resolvedDamage = resolveVariablesInFormula(sneakAttackDamage);\r\n    debug.log(`\uD83C\uDFAF Sneak Attack damage: \"${sneakAttackDamage}\" resolved to \"${resolvedDamage}\"`);\r\n\r\n    // Add toggle section at the top of actions\r\n    const toggleSection = document.createElement('div');\r\n    toggleSection.style.cssText = 'background: #2c3e50; color: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;';\r\n\r\n    const toggleLabel = document.createElement('label');\r\n    toggleLabel.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: bold;';\r\n\r\n    const checkbox = document.createElement('input');\r\n    checkbox.type = 'checkbox';\r\n    checkbox.id = 'sneak-attack-toggle';\r\n    checkbox.checked = sneakAttackEnabled;  // Always starts false - IGNORES DiceCloud toggle state\r\n    checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';\r\n    checkbox.addEventListener('change', (e) => {\r\n      sneakAttackEnabled = e.target.checked;\r\n      debug.log(`\uD83C\uDFAF Sneak Attack toggle on our sheet: ${sneakAttackEnabled ? 'ON' : 'OFF'} (independent of DiceCloud)`);\r\n    });\r\n\r\n    const labelText = document.createElement('span');\r\n    labelText.textContent = `Add Sneak Attack (${resolvedDamage}) to weapon damage`;\r\n\r\n    toggleLabel.appendChild(checkbox);\r\n    toggleLabel.appendChild(labelText);\r\n    toggleSection.appendChild(toggleLabel);\r\n    container.appendChild(toggleSection);\r\n  }\r\n\r\n  // Check if character has Elemental Weapon spell prepared (check spells list)\r\n  // We only check if it EXISTS, the toggle is user-controlled\r\n  const hasElementalWeapon = characterData.spells && characterData.spells.some(s =>\r\n    s.name === 'Elemental Weapon' || (s.spell && s.spell.name === 'Elemental Weapon')\r\n  );\r\n\r\n  if (hasElementalWeapon) {\r\n    debug.log(`\u2694\uFE0F Elemental Weapon spell found, adding toggle`);\r\n\r\n    // Add toggle section for Elemental Weapon\r\n    const elementalToggleSection = document.createElement('div');\r\n    elementalToggleSection.style.cssText = 'background: #8b4513; color: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;';\r\n\r\n    const elementalToggleLabel = document.createElement('label');\r\n    elementalToggleLabel.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: bold;';\r\n\r\n    const elementalCheckbox = document.createElement('input');\r\n    elementalCheckbox.type = 'checkbox';\r\n    elementalCheckbox.id = 'elemental-weapon-toggle';\r\n    elementalCheckbox.checked = elementalWeaponEnabled;  // Always starts false\r\n    elementalCheckbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';\r\n    elementalCheckbox.addEventListener('change', (e) => {\r\n      elementalWeaponEnabled = e.target.checked;\r\n      debug.log(`\u2694\uFE0F Elemental Weapon toggle: ${elementalWeaponEnabled ? 'ON' : 'OFF'}`);\r\n    });\r\n\r\n    const elementalLabelText = document.createElement('span');\r\n    elementalLabelText.textContent = `Add Elemental Weapon (${elementalWeaponDamage}) to weapon damage`;\r\n\r\n    elementalToggleLabel.appendChild(elementalCheckbox);\r\n    elementalToggleLabel.appendChild(elementalLabelText);\r\n    elementalToggleSection.appendChild(elementalToggleLabel);\r\n    container.appendChild(elementalToggleSection);\r\n  }\r\n\r\n  // Check if character has Lucky feat\r\n  const hasLuckyFeat = characterData.features && characterData.features.some(f =>\r\n    f.name && f.name.toLowerCase().includes('lucky')\r\n  );\r\n\r\n  if (hasLuckyFeat) {\r\n    debug.log(`\uD83C\uDF96\uFE0F Lucky feat found, adding action button`);\r\n\r\n    // Add action button for Lucky feat\r\n    const luckyActionSection = document.createElement('div');\r\n    luckyActionSection.style.cssText = 'background: #f39c12; color: white; padding: 12px; border-radius: 5px; margin-bottom: 10px;';\r\n\r\n    const luckyButton = document.createElement('button');\r\n    luckyButton.id = 'lucky-action-button';\r\n    luckyButton.style.cssText = `\r\n      background: #e67e22;\r\n      color: white;\r\n      border: none;\r\n      padding: 10px 16px;\r\n      border-radius: 5px;\r\n      cursor: pointer;\r\n      font-size: 14px;\r\n      font-weight: bold;\r\n      width: 100%;\r\n      transition: background 0.2s;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      gap: 8px;\r\n    `;\r\n    luckyButton.onmouseover = () => luckyButton.style.background = '#d35400';\r\n    luckyButton.onmouseout = () => luckyButton.style.background = '#e67e22';\r\n\r\n    // Update button text based on available luck points\r\n    const luckyResource = getLuckyResource();\r\n    const luckPointsAvailable = luckyResource ? luckyResource.current : 0;\r\n    luckyButton.innerHTML = `\r\n      <span style=\"font-size: 16px;\">\uD83C\uDF96\uFE0F</span>\r\n      <span>Use Lucky Point (${luckPointsAvailable}/3)</span>\r\n    `;\r\n\r\n    luckyButton.addEventListener('click', () => {\r\n      const currentLuckyResource = getLuckyResource();\r\n      if (!currentLuckyResource || currentLuckyResource.current <= 0) {\r\n        showNotification('\u274C No luck points available!', 'error');\r\n        return;\r\n      }\r\n\r\n      // Show simple Lucky modal like metamagic\r\n      showLuckyModal();\r\n    });\r\n\r\n    luckyActionSection.appendChild(luckyButton);\r\n    container.appendChild(luckyActionSection);\r\n  }\r\n\r\n  filteredActions.forEach((action, index) => {\r\n    // Skip rendering standalone Sneak Attack button if it exists\r\n    if ((action.name === 'Sneak Attack' || action.name.toLowerCase().includes('sneak attack')) && action.actionType === 'feature') {\r\n      debug.log('\u23ED\uFE0F Skipping standalone Sneak Attack button (using toggle instead)');\r\n      return;\r\n    }\r\n\r\n    // Clean up weapon damage to remove sneak attack if it was auto-added\r\n    // Pattern: remove any multi-dice formulas like \"+3d6\", \"+4d6\", etc. that come after the base damage\r\n    if (action.damage && action.attackRoll && sneakAttackDamage) {\r\n      // Remove the sneak attack damage pattern from weapon damage\r\n      const sneakPattern = new RegExp(`\\\\+?${sneakAttackDamage.replace(/[+\\-]/g, '')}`, 'g');\r\n      const cleanedDamage = action.damage.replace(sneakPattern, '');\r\n      if (cleanedDamage !== action.damage) {\r\n        debug.log(`\uD83E\uDDF9 Cleaned weapon damage: \"${action.damage}\" -> \"${cleanedDamage}\"`);\r\n        action.damage = cleanedDamage;\r\n      }\r\n    }\r\n\r\n    const actionCard = document.createElement('div');\r\n    actionCard.className = 'action-card';\r\n\r\n    const actionHeader = document.createElement('div');\r\n    actionHeader.className = 'action-header';\r\n\r\n    const nameDiv = document.createElement('div');\r\n    nameDiv.className = 'action-name';\r\n\r\n    // Show uses if available\r\n    let nameText = action.name;\r\n\r\n    // Rename \"Recover Spell Slot\" to \"Harness Divine Power\" (Cleric feature)\r\n    if (nameText === 'Recover Spell Slot') {\r\n      nameText = 'Harness Divine Power';\r\n    }\r\n\r\n    if (action.uses) {\r\n      const usesTotal = action.uses.total || action.uses.value || action.uses;\r\n      // Prefer usesLeft from DiceCloud if available, otherwise calculate from usesUsed\r\n      const usesRemaining = action.usesLeft !== undefined ? action.usesLeft : (usesTotal - (action.usesUsed || 0));\r\n      nameText += ` <span class=\"uses-badge\">${usesRemaining}/${usesTotal} uses</span>`;\r\n    }\r\n    nameDiv.innerHTML = nameText;\r\n\r\n    const buttonsDiv = document.createElement('div');\r\n    buttonsDiv.className = 'action-buttons';\r\n\r\n    // Get action options with edge case modifications\r\n    const actionOptionsResult = getActionOptions(action);\r\n    const actionOptions = actionOptionsResult.options;\r\n\r\n    // Check if this is a \"utility only\" action that should just announce\r\n    if (actionOptionsResult.skipNormalButtons) {\r\n      // Create simple action button for utility-only actions\r\n      const actionBtn = document.createElement('button');\r\n      actionBtn.className = 'action-btn';\r\n      actionBtn.textContent = '\u2728 Use';\r\n      actionBtn.style.cssText = `\r\n        background: #9b59b6;\r\n        color: white;\r\n        border: none;\r\n        padding: 8px 12px;\r\n        border-radius: 4px;\r\n        cursor: pointer;\r\n        font-size: 12px;\r\n        font-weight: bold;\r\n      `;\r\n      actionBtn.addEventListener('click', () => {\r\n        // Check for Divine Smite special handling\r\n        if (action.name.toLowerCase().includes('divine smite')) {\r\n          showDivineSmiteModal(action);\r\n          return;\r\n        }\r\n        \r\n        // Check for Lay on Hands: Heal special handling\r\n        const normalizedActionName = action.name.toLowerCase()\r\n          .replace(/[^a-z0-9\\s:]/g, '') // Remove special chars except colon and space\r\n          .replace(/\\s+/g, ' ') // Normalize spaces\r\n          .trim();\r\n        const normalizedSearch = 'lay on hands: heal';\r\n        \r\n        if (normalizedActionName === normalizedSearch) {\r\n          debug.log(`\uD83D\uDC9A Lay on Hands: Heal action clicked: ${action.name}, showing custom modal`);\r\n          debug.log(`\uD83D\uDC9A Normalized match: \"${normalizedActionName}\" === \"${normalizedSearch}\"`);\r\n          const layOnHandsPool = getLayOnHandsResource();\r\n          if (layOnHandsPool) {\r\n            showLayOnHandsModal(layOnHandsPool);\r\n          } else {\r\n            showNotification('\u274C No Lay on Hands pool resource found', 'error');\r\n          }\r\n          return;\r\n        }\r\n        \r\n        // Fallback: Catch ANY Lay on Hands action for debugging\r\n        if (action.name.toLowerCase().includes('lay on hands')) {\r\n          debug.log(`\uD83D\uDEA8 FALLBACK: Caught Lay on Hands action: \"${action.name}\"`);\r\n          debug.log(`\uD83D\uDEA8 This action didn't match 'lay on hands: heal' but contains 'lay on hands'`);\r\n          debug.log(`\uD83D\uDEA8 Showing modal anyway for debugging`);\r\n          const layOnHandsPool = getLayOnHandsResource();\r\n          if (layOnHandsPool) {\r\n            showLayOnHandsModal(layOnHandsPool);\r\n          } else {\r\n            showNotification('\u274C No Lay on Hands pool resource found', 'error');\r\n          }\r\n          return;\r\n        }\r\n        \r\n        // Check and decrement uses BEFORE announcing (so announcement shows correct count)\r\n        if (action.uses && !decrementActionUses(action)) {\r\n          return; // No uses remaining\r\n        }\r\n\r\n        // Check and decrement other resources\r\n        if (!decrementActionResources(action)) {\r\n          return; // Not enough resources\r\n        }\r\n\r\n        // Announce the action with description AFTER decrements\r\n        announceAction(action);\r\n      });\r\n      buttonsDiv.appendChild(actionBtn);\r\n    } else {\r\n      // Create buttons for each action option\r\n      actionOptions.forEach((option, optionIndex) => {\r\n        const actionBtn = document.createElement('button');\r\n        actionBtn.className = `${option.type}-btn`;\r\n\r\n        // Add edge case note if present\r\n        const edgeCaseNote = option.edgeCaseNote ? `<div style=\"font-size: 0.7em; color: #666; margin-top: 1px;\">${option.edgeCaseNote}</div>` : '';\r\n        actionBtn.innerHTML = `${option.label}${edgeCaseNote}`;\r\n\r\n        actionBtn.style.cssText = `\r\n          background: ${option.color};\r\n          color: white;\r\n          border: none;\r\n          padding: 8px 12px;\r\n          border-radius: 4px;\r\n          cursor: pointer;\r\n          font-size: 12px;\r\n          font-weight: bold;\r\n          margin-right: 4px;\r\n          margin-bottom: 4px;\r\n        `;\r\n\r\n        actionBtn.addEventListener('click', () => {\r\n          // Check for Divine Smite special handling\r\n          if (action.name.toLowerCase().includes('divine smite')) {\r\n            showDivineSmiteModal(action);\r\n            return;\r\n          }\r\n          \r\n          // Check for Lay on Hands: Heal special handling\r\n          const normalizedActionName = action.name.toLowerCase()\r\n            .replace(/[^a-z0-9\\s:]/g, '') // Remove special chars except colon and space\r\n            .replace(/\\s+/g, ' ') // Normalize spaces\r\n            .trim();\r\n          const normalizedSearch = 'lay on hands: heal';\r\n          \r\n          if (normalizedActionName === normalizedSearch) {\r\n            debug.log(`\uD83D\uDC9A Lay on Hands: Heal action clicked: ${action.name}, showing custom modal`);\r\n            debug.log(`\uD83D\uDC9A Normalized match: \"${normalizedActionName}\" === \"${normalizedSearch}\"`);\r\n            const layOnHandsPool = getLayOnHandsResource();\r\n            if (layOnHandsPool) {\r\n              showLayOnHandsModal(layOnHandsPool);\r\n            } else {\r\n              showNotification('\u274C No Lay on Hands pool resource found', 'error');\r\n            }\r\n            return;\r\n          }\r\n          \r\n          // Fallback: Catch ANY Lay on Hands action for debugging\r\n          if (action.name.toLowerCase().includes('lay on hands')) {\r\n            debug.log(`\uD83D\uDEA8 FALLBACK: Caught Lay on Hands action: \"${action.name}\"`);\r\n            debug.log(`\uD83D\uDEA8 This action didn't match 'lay on hands: heal' but contains 'lay on hands'`);\r\n            debug.log(`\uD83D\uDEA8 Showing modal anyway for debugging`);\r\n            const layOnHandsPool = getLayOnHandsResource();\r\n            if (layOnHandsPool) {\r\n              showLayOnHandsModal(layOnHandsPool);\r\n            } else {\r\n              showNotification('\u274C No Lay on Hands pool resource found', 'error');\r\n            }\r\n            return;\r\n          }\r\n          \r\n          // Handle different option types\r\n          if (option.type === 'attack') {\r\n            // Mark action as used for attacks\r\n            markActionAsUsed('action');\r\n\r\n            // Add Sneak Attack if toggle is enabled and this is a weapon attack\r\n            let attackFormula = option.formula;\r\n            if (sneakAttackEnabled && sneakAttackDamage && action.attackRoll) {\r\n              attackFormula += `+${sneakAttackDamage}`;\r\n              debug.log(`\uD83C\uDFAF Adding Sneak Attack to ${action.name}: ${attackFormula}`);\r\n            }\r\n\r\n            // Add Elemental Weapon if toggle is enabled and this is a weapon attack\r\n            if (elementalWeaponEnabled && elementalWeaponDamage && action.attackRoll) {\r\n              attackFormula += `+${elementalWeaponDamage}`;\r\n              debug.log(`\u2694\uFE0F Adding Elemental Weapon to ${action.name}: ${attackFormula}`);\r\n            }\r\n            \r\n            roll(`${action.name} Attack`, attackFormula);\r\n          } else if (option.type === 'healing' || option.type === 'temphp' || option.type === 'damage') {\r\n            // Check and decrement uses before rolling\r\n            if (action.uses && !decrementActionUses(action)) {\r\n              return; // No uses remaining\r\n            }\r\n\r\n            // Check and decrement Ki points if action costs Ki\r\n            const kiCost = getKiCostFromAction(action);\r\n            if (kiCost > 0) {\r\n              const kiResource = getKiPointsResource();\r\n              if (!kiResource) {\r\n                showNotification(`\u274C No Ki Points resource found`, 'error');\r\n                return;\r\n              }\r\n              if (kiResource.current < kiCost) {\r\n                showNotification(`\u274C Not enough Ki Points! Need ${kiCost}, have ${kiResource.current}`, 'error');\r\n                return;\r\n              }\r\n              kiResource.current -= kiCost;\r\n              saveCharacterData();\r\n              debug.log(`\u2728 Used ${kiCost} Ki points for ${action.name}. Remaining: ${kiResource.current}/${kiResource.max}`);\r\n              showNotification(`\u2728 ${action.name}! (${kiResource.current}/${kiResource.max} Ki left)`);\r\n              buildSheet(characterData); // Refresh display\r\n            }\r\n\r\n            // Check and decrement Sorcery Points if action costs them\r\n            const sorceryCost = getSorceryPointCostFromAction(action);\r\n            if (sorceryCost > 0) {\r\n              const sorceryResource = getSorceryPointsResource();\r\n              if (!sorceryResource) {\r\n                showNotification(`\u274C No Sorcery Points resource found`, 'error');\r\n                return;\r\n              }\r\n              if (sorceryResource.current < sorceryCost) {\r\n                showNotification(`\u274C Not enough Sorcery Points! Need ${sorceryCost}, have ${sorceryResource.current}`, 'error');\r\n                return;\r\n              }\r\n              sorceryResource.current -= sorceryCost;\r\n              saveCharacterData();\r\n              debug.log(`\u2728 Used ${sorceryCost} Sorcery Points for ${action.name}. Remaining: ${sorceryResource.current}/${sorceryResource.max}`);\r\n              showNotification(`\u2728 ${action.name}! (${sorceryResource.current}/${sorceryResource.max} SP left)`);\r\n              buildSheet(characterData); // Refresh display\r\n            }\r\n\r\n            // Check and decrement other resources (Wild Shape, Breath Weapon, etc.)\r\n            if (!decrementActionResources(action)) {\r\n              return; // Not enough resources\r\n            }\r\n\r\n            // Only announce if this action has no attack roll (description was already announced on attack)\r\n            if (action.description && !action.attackRoll) {\r\n              announceAction(action);\r\n            }\r\n\r\n            // Roll the damage/healing\r\n            const rollType = option.type === 'healing' ? 'Healing' : (option.type === 'temphp' ? 'Temp HP' : 'Damage');\r\n            roll(`${action.name} ${rollType}`, option.formula);\r\n          }\r\n        });\r\n\r\n        buttonsDiv.appendChild(actionBtn);\r\n      });\r\n    }\r\n\r\n    // Add \"Use\" button for actions with no attack/damage options\r\n    // Show for any action that should be usable (has description OR is a valid action type)\r\n    if (actionOptions.length === 0 && !actionOptionsResult.skipNormalButtons) {\r\n      const useBtn = document.createElement('button');\r\n      useBtn.className = 'use-btn';\r\n      useBtn.textContent = '\u2728 Use';\r\n      useBtn.style.cssText = `\r\n        background: #9b59b6;\r\n        color: white;\r\n        border: none;\r\n        padding: 8px 12px;\r\n        border-radius: 4px;\r\n        cursor: pointer;\r\n        font-size: 12px;\r\n        font-weight: bold;\r\n      `;\r\n      useBtn.addEventListener('click', () => {\r\n        // Special handling for Divine Spark\r\n        if (action.name === 'Divine Spark') {\r\n          // Find Channel Divinity resource from the resources array\r\n          const channelDivinityResource = characterData.resources?.find(r =>\r\n            r.name === 'Channel Divinity' ||\r\n            r.variableName === 'channelDivinityCleric' ||\r\n            r.variableName === 'channelDivinityPaladin' ||\r\n            r.variableName === 'channelDivinity'\r\n          );\r\n\r\n          if (!channelDivinityResource) {\r\n            showNotification('\u274C No Channel Divinity resource found', 'error');\r\n            return;\r\n          }\r\n\r\n          if (channelDivinityResource.current <= 0) {\r\n            showNotification('\u274C No Channel Divinity uses remaining!', 'error');\r\n            return;\r\n          }\r\n\r\n          // Show the Divine Spark choice modal\r\n          showDivineSparkModal(action, channelDivinityResource);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Harness Divine Power\r\n        if (action.name === 'Harness Divine Power' || action.name === 'Recover Spell Slot') {\r\n          // Find Channel Divinity resource from the resources array\r\n          const channelDivinityResource = characterData.resources?.find(r =>\r\n            r.name === 'Channel Divinity' ||\r\n            r.variableName === 'channelDivinityCleric' ||\r\n            r.variableName === 'channelDivinityPaladin' ||\r\n            r.variableName === 'channelDivinity'\r\n          );\r\n\r\n          if (!channelDivinityResource) {\r\n            showNotification('\u274C No Channel Divinity resource found', 'error');\r\n            return;\r\n          }\r\n\r\n          if (channelDivinityResource.current <= 0) {\r\n            showNotification('\u274C No Channel Divinity uses remaining!', 'error');\r\n            return;\r\n          }\r\n\r\n          // Show the Harness Divine Power choice modal\r\n          showHarnessDivinePowerModal(action, channelDivinityResource);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Elemental Weapon\r\n        if (action.name === 'Elemental Weapon') {\r\n          // Show the Elemental Weapon choice modal\r\n          showElementalWeaponModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Divine Intervention\r\n        if (action.name === 'Divine Intervention') {\r\n          // Show the Divine Intervention modal\r\n          showDivineInterventionModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Wild Shape\r\n        if (action.name === 'Wild Shape' || action.name === 'Combat Wild Shape') {\r\n          // Show the Wild Shape choice modal\r\n          showWildShapeModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Shapechange\r\n        if (action.name === 'Shapechange') {\r\n          // Show the Shapechange choice modal\r\n          showShapechangeModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for True Polymorph\r\n        if (action.name === 'True Polymorph') {\r\n          // Show the True Polymorph choice modal\r\n          showTruePolymorphModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Conjure Animals/Elementals/Fey/Celestial\r\n        if (action.name && (\r\n          action.name.includes('Conjure Animals') ||\r\n          action.name.includes('Conjure Elemental') ||\r\n          action.name.includes('Conjure Fey') ||\r\n          action.name.includes('Conjure Celestial')\r\n        )) {\r\n          // Show the Conjure choice modal\r\n          showConjureModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Planar Binding\r\n        if (action.name === 'Planar Binding') {\r\n          // Show the Planar Binding choice modal\r\n          showPlanarBindingModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Teleport\r\n        if (action.name === 'Teleport') {\r\n          // Show the Teleport choice modal\r\n          showTeleportModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Word of Recall\r\n        if (action.name === 'Word of Recall') {\r\n          // Show the Word of Recall choice modal\r\n          showWordOfRecallModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Contingency\r\n        if (action.name === 'Contingency') {\r\n          // Show the Contingency choice modal\r\n          showContingencyModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Glyph of Warding\r\n        if (action.name === 'Glyph of Warding') {\r\n          // Show the Glyph of Warding choice modal\r\n          showGlyphOfWardingModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Symbol\r\n        if (action.name === 'Symbol') {\r\n          // Show the Symbol choice modal\r\n          showSymbolModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Programmed Illusion\r\n        if (action.name === 'Programmed Illusion') {\r\n          // Show the Programmed Illusion choice modal\r\n          showProgrammedIllusionModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Sequester\r\n        if (action.name === 'Sequester') {\r\n          // Show the Sequester choice modal\r\n          showSequesterModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Clone\r\n        if (action.name === 'Clone') {\r\n          // Show the Clone choice modal\r\n          showCloneModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Astral Projection\r\n        if (action.name === 'Astral Projection') {\r\n          // Show the Astral Projection choice modal\r\n          showAstralProjectionModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Etherealness\r\n        if (action.name === 'Etherealness') {\r\n          // Show the Etherealness choice modal\r\n          showEtherealnessModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Magic Jar\r\n        if (action.name === 'Magic Jar') {\r\n          // Show the Magic Jar choice modal\r\n          showMagicJarModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Imprisonment\r\n        if (action.name === 'Imprisonment') {\r\n          // Show the Imprisonment choice modal\r\n          showImprisonmentModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Time Stop\r\n        if (action.name === 'Time Stop') {\r\n          // Show the Time Stop choice modal\r\n          showTimeStopModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Mirage Arcane\r\n        if (action.name === 'Mirage Arcane') {\r\n          // Show the Mirage Arcane choice modal\r\n          showMirageArcaneModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Forcecage\r\n        if (action.name === 'Forcecage') {\r\n          // Show the Forcecage choice modal\r\n          showForcecageModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Maze\r\n        if (action.name === 'Maze') {\r\n          // Show the Maze choice modal\r\n          showMazeModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Wish\r\n        if (action.name === 'Wish') {\r\n          // Show the Wish choice modal\r\n          showWishModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Simulacrum\r\n        if (action.name === 'Simulacrum') {\r\n          // Show the Simulacrum choice modal\r\n          showSimulacrumModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Gate\r\n        if (action.name === 'Gate') {\r\n          // Show the Gate choice modal\r\n          showGateModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Legend Lore\r\n        if (action.name === 'Legend Lore') {\r\n          // Show the Legend Lore choice modal\r\n          showLegendLoreModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Commune\r\n        if (action.name === 'Commune') {\r\n          // Show the Commune choice modal\r\n          showCommuneModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Augury\r\n        if (action.name === 'Augury') {\r\n          // Show the Augury choice modal\r\n          showAuguryModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Divination\r\n        if (action.name === 'Divination') {\r\n          // Show the Divination choice modal\r\n          showDivinationModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Contact Other Plane\r\n        if (action.name === 'Contact Other Plane') {\r\n          // Show the Contact Other Plane choice modal\r\n          showContactOtherPlaneModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Find the Path\r\n        if (action.name === 'Find the Path') {\r\n          // Show the Find the Path choice modal\r\n          showFindThePathModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Speak with Dead\r\n        if (action.name === 'Speak with Dead') {\r\n          // Show the Speak with Dead choice modal\r\n          showSpeakWithDeadModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Speak with Animals\r\n        if (action.name === 'Speak with Animals') {\r\n          // Show the Speak with Animals choice modal\r\n          showSpeakWithAnimalsModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Speak with Plants\r\n        if (action.name === 'Speak with Plants') {\r\n          // Show the Speak with Plants choice modal\r\n          showSpeakWithPlantsModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Zone of Truth\r\n        if (action.name === 'Zone of Truth') {\r\n          // Show the Zone of Truth choice modal\r\n          showZoneOfTruthModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Sending\r\n        if (action.name === 'Sending') {\r\n          // Show the Sending choice modal\r\n          showSendingModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Dream\r\n        if (action.name === 'Dream') {\r\n          // Show the Dream choice modal\r\n          showDreamModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Scrying\r\n        if (action.name === 'Scrying') {\r\n          // Show the Scrying choice modal\r\n          showScryingModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Dispel Evil and Good\r\n        if (action.name === 'Dispel Evil and Good') {\r\n          // Show the Dispel Evil and Good choice modal\r\n          showDispelEvilAndGoodModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Freedom of Movement\r\n        if (action.name === 'Freedom of Movement') {\r\n          // Show the Freedom of Movement choice modal\r\n          showFreedomOfMovementModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Nondetection\r\n        if (action.name === 'Nondetection') {\r\n          // Show the Nondetection choice modal\r\n          showNondetectionModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Protection from Energy\r\n        if (action.name === 'Protection from Energy') {\r\n          // Show the Protection from Energy choice modal\r\n          showProtectionFromEnergyModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Protection from Evil and Good\r\n        if (action.name === 'Protection from Evil and Good') {\r\n          // Show the Protection from Evil and Good choice modal\r\n          showProtectionFromEvilAndGoodModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Sanctuary\r\n        if (action.name === 'Sanctuary') {\r\n          // Show the Sanctuary choice modal\r\n          showSanctuaryModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Silence\r\n        if (action.name === 'Silence') {\r\n          // Show the Silence choice modal\r\n          showSilenceModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Magic Circle\r\n        if (action.name === 'Magic Circle') {\r\n          // Show the Magic Circle choice modal\r\n          showMagicCircleModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Greater Restoration\r\n        if (action.name === 'Greater Restoration') {\r\n          // Show the Greater Restoration choice modal\r\n          showGreaterRestorationModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Remove Curse\r\n        if (action.name === 'Remove Curse') {\r\n          // Show the Remove Curse choice modal\r\n          showRemoveCurseModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Revivify\r\n        if (action.name === 'Revivify') {\r\n          // Show the Revivify choice modal\r\n          showRevivifyModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Raise Dead\r\n        if (action.name === 'Raise Dead') {\r\n          // Show the Raise Dead choice modal\r\n          showRaiseDeadModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Resurrection\r\n        if (action.name === 'Resurrection') {\r\n          // Show the Resurrection choice modal\r\n          showResurrectionModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for True Resurrection\r\n        if (action.name === 'True Resurrection') {\r\n          // Show the True Resurrection choice modal\r\n          showTrueResurrectionModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Detect Magic\r\n        if (action.name === 'Detect Magic') {\r\n          // Show the Detect Magic choice modal\r\n          showDetectMagicModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Identify\r\n        if (action.name === 'Identify') {\r\n          // Show the Identify choice modal\r\n          showIdentifyModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Dispel Magic\r\n        if (action.name === 'Dispel Magic') {\r\n          // Show the Dispel Magic choice modal\r\n          showDispelMagicModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Feather Fall\r\n        if (action.name === 'Feather Fall') {\r\n          // Show the Feather Fall choice modal\r\n          showFeatherFallModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Hellish Rebuke\r\n        if (action.name === 'Hellish Rebuke') {\r\n          // Show the Hellish Rebuke choice modal\r\n          showHellishRebukeModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Shield\r\n        if (action.name === 'Shield') {\r\n          // Show the Shield choice modal\r\n          showShieldModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Absorb Elements\r\n        if (action.name === 'Absorb Elements') {\r\n          // Show the Absorb Elements choice modal\r\n          showAbsorbElementsModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Counterspell\r\n        if (action.name === 'Counterspell') {\r\n          // Show the Counterspell choice modal\r\n          showCounterspellModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Fire Shield\r\n        if (action.name === 'Fire Shield') {\r\n          // Show the Fire Shield choice modal\r\n          showFireShieldModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Armor of Agathys\r\n        if (action.name === 'Armor of Agathys') {\r\n          // Show the Armor of Agathys choice modal\r\n          showArmorOfAgathysModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Meld into Stone\r\n        if (action.name === 'Meld into Stone') {\r\n          // Show the Meld into Stone choice modal\r\n          showMeldIntoStoneModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Vampiric Touch\r\n        if (action.name === 'Vampiric Touch') {\r\n          // Show the Vampiric Touch choice modal\r\n          showVampiricTouchModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Life Transference\r\n        if (action.name === 'Life Transference') {\r\n          // Show the Life Transference choice modal\r\n          showLifeTransferenceModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Geas\r\n        if (action.name === 'Geas') {\r\n          // Show the Geas choice modal\r\n          showGeasModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Symbol\r\n        if (action.name === 'Symbol') {\r\n          // Show the Symbol choice modal\r\n          showSymbolModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Spiritual Weapon\r\n        if (action.name === 'Spiritual Weapon') {\r\n          // Show the Spiritual Weapon choice modal\r\n          showSpiritualWeaponModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Flaming Sphere\r\n        if (action.name === 'Flaming Sphere') {\r\n          // Show the Flaming Sphere choice modal\r\n          showFlamingSphereModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Bigby's Hand\r\n        if (action.name === 'Bigby\\'s Hand') {\r\n          // Show the Bigby's Hand choice modal\r\n          showBigbysHandModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Animate Objects\r\n        if (action.name === 'Animate Objects') {\r\n          // Show the Animate Objects choice modal\r\n          showAnimateObjectsModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Moonbeam\r\n        if (action.name === 'Moonbeam') {\r\n          // Show the Moonbeam choice modal\r\n          showMoonbeamModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Healing Spirit\r\n        if (action.name === 'Healing Spirit') {\r\n          // Show the Healing Spirit choice modal\r\n          showHealingSpiritModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Bless\r\n        if (action.name === 'Bless') {\r\n          // Show the Bless choice modal\r\n          showBlessModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Bane\r\n        if (action.name === 'Bane') {\r\n          // Show the Bane choice modal\r\n          showBaneModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Guidance\r\n        if (action.name === 'Guidance') {\r\n          // Show the Guidance choice modal\r\n          showGuidanceModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Resistance\r\n        if (action.name === 'Resistance') {\r\n          // Show the Resistance choice modal\r\n          showResistanceModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Hex\r\n        if (action.name === 'Hex') {\r\n          // Show the Hex choice modal\r\n          showHexModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Hunter's Mark\r\n        if (action.name === 'Hunter\\'s Mark') {\r\n          // Show the Hunter's Mark choice modal\r\n          showHuntersMarkModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Magic Missile\r\n        if (action.name === 'Magic Missile') {\r\n          // Show the Magic Missile choice modal\r\n          showMagicMissileModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Scorching Ray\r\n        if (action.name === 'Scorching Ray') {\r\n          // Show the Scorching Ray choice modal\r\n          showScorchingRayModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Aid\r\n        if (action.name === 'Aid') {\r\n          // Show the Aid choice modal\r\n          showAidModal(action);\r\n          return;\r\n        }\r\n\r\n        // Note: Eldritch Blast uses standard attack/damage buttons, no special modal needed\r\n\r\n        // Special handling for Spirit Guardians\r\n        if (action.name === 'Spirit Guardians') {\r\n          // Show the Spirit Guardians choice modal\r\n          showSpiritGuardiansModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Cloud of Daggers\r\n        if (action.name === 'Cloud of Daggers') {\r\n          // Show the Cloud of Daggers choice modal\r\n          showCloudOfDaggersModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Spike Growth\r\n        if (action.name === 'Spike Growth') {\r\n          // Show the Spike Growth choice modal\r\n          showSpikeGrowthModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Wall of Fire\r\n        if (action.name === 'Wall of Fire') {\r\n          // Show the Wall of Fire choice modal\r\n          showWallOfFireModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Haste\r\n        if (action.name === 'Haste') {\r\n          // Show the Haste choice modal\r\n          showHasteModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Booming Blade\r\n        if (action.name === 'Booming Blade') {\r\n          // Show the Booming Blade choice modal\r\n          showBoomingBladeModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Green-Flame Blade\r\n        if (action.name === 'Green-Flame Blade') {\r\n          // Show the Green-Flame Blade choice modal\r\n          showGreenFlameBladeModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Chromatic Orb\r\n        if (action.name === 'Chromatic Orb') {\r\n          // Show the Chromatic Orb choice modal\r\n          showChromaticOrbModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Dragon's Breath\r\n        if (action.name === 'Dragon\\'s Breath') {\r\n          // Show the Dragons Breath choice modal\r\n          showDragonsBreathModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Chaos Bolt\r\n        if (action.name === 'Chaos Bolt') {\r\n          // Show the Chaos Bolt choice modal\r\n          showChaosBoltModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Delayed Blast Fireball\r\n        if (action.name === 'Delayed Blast Fireball') {\r\n          // Show the Delayed Blast Fireball choice modal\r\n          showDelayedBlastFireballModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for Polymorph\r\n        if (action.name === 'Polymorph') {\r\n          // Show the Polymorph choice modal\r\n          showPolymorphModal(action);\r\n          return;\r\n        }\r\n\r\n        // Special handling for True Polymorph\r\n        if (action.name === 'True Polymorph') {\r\n          // Show the True Polymorph choice modal\r\n          showTruePolymorphModal(action);\r\n          return;\r\n        }\r\n\r\n        // Default handling for other actions\r\n\r\n        // Check and decrement uses BEFORE announcing (so announcement shows correct count)\r\n        if (action.uses && !decrementActionUses(action)) {\r\n          return; // No uses remaining\r\n        }\r\n\r\n        // Check and decrement Ki points if action costs Ki\r\n        const kiCost = getKiCostFromAction(action);\r\n        if (kiCost > 0) {\r\n          const kiResource = getKiPointsResource();\r\n          if (!kiResource) {\r\n            showNotification(`\u274C No Ki Points resource found`, 'error');\r\n            return;\r\n          }\r\n          if (kiResource.current < kiCost) {\r\n            showNotification(`\u274C Not enough Ki Points! Need ${kiCost}, have ${kiResource.current}`, 'error');\r\n            return;\r\n          }\r\n          kiResource.current -= kiCost;\r\n          saveCharacterData();\r\n          debug.log(`\u2728 Used ${kiCost} Ki points for ${action.name}. Remaining: ${kiResource.current}/${kiResource.max}`);\r\n          showNotification(`\u2728 ${action.name}! (${kiResource.current}/${kiResource.max} Ki left)`);\r\n          buildSheet(characterData); // Refresh display\r\n        }\r\n\r\n        // Check and decrement Sorcery Points if action costs them\r\n        const sorceryCost = getSorceryPointCostFromAction(action);\r\n        if (sorceryCost > 0) {\r\n          const sorceryResource = getSorceryPointsResource();\r\n          if (!sorceryResource) {\r\n            showNotification(`\u274C No Sorcery Points resource found`, 'error');\r\n            return;\r\n          }\r\n          if (sorceryResource.current < sorceryCost) {\r\n            showNotification(`\u274C Not enough Sorcery Points! Need ${sorceryCost}, have ${sorceryResource.current}`, 'error');\r\n            return;\r\n          }\r\n          sorceryResource.current -= sorceryCost;\r\n          saveCharacterData();\r\n          debug.log(`\u2728 Used ${sorceryCost} Sorcery Points for ${action.name}. Remaining: ${sorceryResource.current}/${sorceryResource.max}`);\r\n          showNotification(`\u2728 ${action.name}! (${sorceryResource.current}/${sorceryResource.max} SP left)`);\r\n          buildSheet(characterData); // Refresh display\r\n        }\r\n\r\n        // Check and decrement other resources (Wild Shape, Breath Weapon, etc.)\r\n        if (!decrementActionResources(action)) {\r\n          return; // Not enough resources\r\n        }\r\n\r\n        // Announce the action AFTER all decrements (so announcement shows correct counts)\r\n        announceAction(action);\r\n\r\n        // Mark action as used based on action type\r\n        const actionType = action.actionType || 'action';\r\n        debug.log(`\uD83C\uDFAF Action type for \"${action.name}\": \"${actionType}\"`);\r\n\r\n        if (actionType === 'bonus action' || actionType === 'bonus' || actionType === 'Bonus Action' || actionType === 'Bonus') {\r\n          markActionAsUsed('bonus action');\r\n        } else if (actionType === 'reaction' || actionType === 'Reaction') {\r\n          markActionAsUsed('reaction');\r\n        } else {\r\n          markActionAsUsed('action');\r\n        }\r\n      });\r\n      buttonsDiv.appendChild(useBtn);\r\n    }\r\n\r\n    // Add Details button if there's a description\r\n    if (action.description) {\r\n      const detailsBtn = document.createElement('button');\r\n      detailsBtn.className = 'details-btn';\r\n      detailsBtn.textContent = '\uD83D\uDCCB Details';\r\n      detailsBtn.style.cssText = `\r\n        background: #34495e;\r\n        color: white;\r\n        border: none;\r\n        padding: 8px 12px;\r\n        border-radius: 4px;\r\n        cursor: pointer;\r\n        font-size: 12px;\r\n        font-weight: bold;\r\n        margin-right: 4px;\r\n        margin-bottom: 4px;\r\n      `;\r\n      detailsBtn.addEventListener('click', () => {\r\n        const descDiv = actionCard.querySelector('.action-description');\r\n        if (descDiv) {\r\n          descDiv.style.display = descDiv.style.display === 'none' ? 'block' : 'none';\r\n          detailsBtn.textContent = descDiv.style.display === 'none' ? '\uD83D\uDCCB Details' : '\uD83D\uDCCB Hide';\r\n        }\r\n      });\r\n      buttonsDiv.appendChild(detailsBtn);\r\n    }\r\n\r\n    // Append nameDiv and buttonsDiv to actionHeader\r\n    actionHeader.appendChild(nameDiv);\r\n    actionHeader.appendChild(buttonsDiv);\r\n\r\n    // Append actionHeader to actionCard\r\n    actionCard.appendChild(actionHeader);\r\n\r\n    // Add description if available (hidden by default, toggled by Details button)\r\n    if (action.description) {\r\n      const descDiv = document.createElement('div');\r\n      descDiv.className = 'action-description';\r\n      descDiv.style.display = 'none'; // Hidden by default\r\n      // Resolve any variables in the description (like {bardicInspirationDie})\r\n      const resolvedDescription = resolveVariablesInFormula(action.description);\r\n      descDiv.innerHTML = `\r\n        <div style=\"margin-top: 10px; padding: 10px; background: var(--bg-secondary, #f5f5f5); border-radius: 4px; font-size: 0.9em;\">${resolvedDescription}</div>\r\n      `;\r\n\r\n      actionCard.appendChild(descDiv);\r\n    }\r\n\r\n    container.appendChild(actionCard);\r\n  });\r\n}\r\n\r\n/*\r\n// Calculate total currency from inventory items\r\nfunction calculateTotalCurrency(inventory) {\r\n  console.log('\uD83D\uDCB0\uD83D\uDCB0\uD83D\uDCB0 calculateTotalCurrency called, inventory length:', inventory ? inventory.length : 0);\r\n\r\n  if (!inventory || inventory.length === 0) {\r\n    console.log('\uD83D\uDCB0 No inventory, returning zeros');\r\n    return { pp: 0, gp: 0, sp: 0, cp: 0 };\r\n  }\r\n\r\n  let pp = 0;\r\n  let gp = 0;\r\n  let sp = 0;\r\n  let cp = 0;\r\n\r\n  // Build a map of item IDs to names for parent lookup\r\n  const itemMap = new Map();\r\n  inventory.forEach(item => {\r\n    if (item._id) {\r\n      itemMap.set(item._id, item.name);\r\n    }\r\n  });\r\n\r\n  inventory.forEach(item => {\r\n    const itemName = (item.name || '').toLowerCase();\r\n    const quantity = item.quantity;\r\n    const parentId = item.parent && item.parent.id ? item.parent.id : null;\r\n    const parentName = parentId ? itemMap.get(parentId) || 'Unknown' : 'None';\r\n\r\n    console.log(`\uD83D\uDCB0 Item: \"${item.name}\" | qty: ${quantity} | parent: ${parentName} (${parentId})`);\r\n\r\n    // Skip items with no quantity or quantity of 0\r\n    if (!quantity || quantity <= 0) {\r\n      console.log(`\uD83D\uDCB0 \u274C SKIPPED - quantity is ${quantity}`);\r\n      return;\r\n    }\r\n\r\n    // Check if this is currency\r\n    const isCurrency = (itemName.includes('platinum') || itemName.includes('gold') ||\r\n                       itemName.includes('silver') || itemName.includes('copper')) &&\r\n                       (itemName.includes('piece') || itemName.includes('coin'));\r\n\r\n    if (!isCurrency) return;\r\n\r\n    // ONLY count currency that's inside ANY container (has a parent)\r\n    // Skip root-level currency items (no parent)\r\n    if (!parentId) {\r\n      console.log(`\uD83D\uDCB0 \u274C SKIPPED CURRENCY - no parent (root-level item)`);\r\n      return;\r\n    }\r\n\r\n    // Count currency by type (inside containers only)\r\n    if (itemName.includes('platinum')) {\r\n      console.log(`\uD83D\uDCB0\uD83D\uDCB0 \u2705 MATCHED PLATINUM in \"${parentName}\" - adding ${quantity}`, item);\r\n      pp += quantity;\r\n    } else if (itemName.includes('gold')) {\r\n      console.log(`\uD83D\uDCB0\uD83D\uDCB0 \u2705 MATCHED GOLD in \"${parentName}\" - adding ${quantity}`, item);\r\n      gp += quantity;\r\n    } else if (itemName.includes('silver')) {\r\n      console.log(`\uD83D\uDCB0\uD83D\uDCB0 \u2705 MATCHED SILVER in \"${parentName}\" - adding ${quantity}`, item);\r\n      sp += quantity;\r\n    } else if (itemName.includes('copper')) {\r\n      console.log(`\uD83D\uDCB0\uD83D\uDCB0 \u2705 MATCHED COPPER in \"${parentName}\" - adding ${quantity}`, item);\r\n      cp += quantity;\r\n    }\r\n  });\r\n\r\n  console.log(`\uD83D\uDCB0\uD83D\uDCB0\uD83D\uDCB0 FINAL CURRENCY TOTALS: pp=${pp}, gp=${gp}, sp=${sp}, cp=${cp}`);\r\n  return { pp, gp, sp, cp };\r\n}\r\n*/\r\n\r\n/*\r\n// Update currency display in inventory section header\r\nfunction updateInventoryCurrencyDisplay(inventory) {\r\n  const headerElement = document.querySelector('#inventory-section h3');\r\n  if (!headerElement) return;\r\n\r\n  const currency = calculateTotalCurrency(inventory);\r\n\r\n  // Remove existing currency display if any\r\n  const existingDisplay = headerElement.querySelector('.currency-display');\r\n  if (existingDisplay) {\r\n    existingDisplay.remove();\r\n  }\r\n\r\n  // Create currency display\r\n  const currencyDisplay = document.createElement('span');\r\n  currencyDisplay.className = 'currency-display';\r\n  currencyDisplay.style.cssText = 'margin-left: 12px; display: inline-flex; gap: 8px; font-size: 0.85em; font-weight: normal;';\r\n\r\n  // Add currency circles (only if value > 0)\r\n  if (currency.pp > 0) {\r\n    const ppCircle = document.createElement('span');\r\n    ppCircle.style.cssText = 'display: inline-flex; align-items: center; gap: 4px;';\r\n    ppCircle.innerHTML = `<span style=\"display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #e8e8e8; border: 1px solid #ccc;\"></span><span>${currency.pp}</span>`;\r\n    currencyDisplay.appendChild(ppCircle);\r\n  }\r\n\r\n  if (currency.gp > 0) {\r\n    const gpCircle = document.createElement('span');\r\n    gpCircle.style.cssText = 'display: inline-flex; align-items: center; gap: 4px;';\r\n    gpCircle.innerHTML = `<span style=\"display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ffd700; border: 1px solid #daa520;\"></span><span>${currency.gp}</span>`;\r\n    currencyDisplay.appendChild(gpCircle);\r\n  }\r\n\r\n  if (currency.sp > 0) {\r\n    const spCircle = document.createElement('span');\r\n    spCircle.style.cssText = 'display: inline-flex; align-items: center; gap: 4px;';\r\n    spCircle.innerHTML = `<span style=\"display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #c0c0c0; border: 1px solid #999;\"></span><span>${currency.sp}</span>`;\r\n    currencyDisplay.appendChild(spCircle);\r\n  }\r\n\r\n  if (currency.cp > 0) {\r\n    const cpCircle = document.createElement('span');\r\n    cpCircle.style.cssText = 'display: inline-flex; align-items: center; gap: 4px;';\r\n    cpCircle.innerHTML = `<span style=\"display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #8b4513; border: 1px solid #654321;\"></span><span>${currency.cp}</span>`;\r\n    currencyDisplay.appendChild(cpCircle);\r\n  }\r\n\r\n  // Only add if there's any currency\r\n  if (currency.pp > 0 || currency.gp > 0 || currency.sp > 0 || currency.cp > 0) {\r\n    headerElement.appendChild(currencyDisplay);\r\n  }\r\n}\r\n*/\r\n\r\n// Build and display inventory with filtering\r\nfunction buildInventoryDisplay(container, inventory) {\r\n  // Clear container\r\n  container.innerHTML = '';\r\n\r\n  // Update currency display in header\r\n  // updateInventoryCurrencyDisplay(inventory); // Commented out currency viewer\r\n\r\n  if (!inventory || inventory.length === 0) {\r\n    container.innerHTML = '<p style=\"color: var(--text-secondary); text-align: center; padding: 20px;\">No items in inventory</p>';\r\n    return;\r\n  }\r\n\r\n  debug.log(`\uD83C\uDF92 Building inventory display with ${inventory.length} items`);\r\n\r\n  // Apply filters\r\n  let filteredInventory = inventory.filter(item => {\r\n    // Filter out coins (currency) - they're tracked separately\r\n    const lowerName = (item.name || '').toLowerCase();\r\n    const coinPatterns = ['platinum piece', 'gold piece', 'silver piece', 'copper piece', 'electrum piece',\r\n                          'platinum coin', 'gold coin', 'silver coin', 'copper coin', 'electrum coin',\r\n                          'pp', 'gp', 'sp', 'cp', 'ep'];\r\n    // Check for exact matches or plurals\r\n    const isCoin = coinPatterns.some(pattern => {\r\n      if (pattern.length <= 2) {\r\n        // Short patterns (pp, gp, etc.) - match exactly or with quantity prefix\r\n        return lowerName === pattern || lowerName === pattern + 's' || lowerName.match(new RegExp(`^\\\\d+\\\\s*${pattern}s?$`));\r\n      }\r\n      // Longer patterns - match if name contains it\r\n      return lowerName.includes(pattern);\r\n    });\r\n    if (isCoin) {\r\n      return false;\r\n    }\r\n\r\n    // Filter by type\r\n    if (inventoryFilters.filter === 'equipped' && !item.equipped) {\r\n      return false;\r\n    }\r\n    if (inventoryFilters.filter === 'attuned' && !item.attuned) {\r\n      return false;\r\n    }\r\n    if (inventoryFilters.filter === 'container' && item.type !== 'container') {\r\n      return false;\r\n    }\r\n\r\n    // Filter by search term\r\n    if (inventoryFilters.search) {\r\n      const searchLower = inventoryFilters.search;\r\n      const name = (item.name || '').toLowerCase();\r\n      const desc = (item.description || '').toLowerCase();\r\n      const tagsString = (item.tags || []).join(' ').toLowerCase();\r\n      if (!name.includes(searchLower) && !desc.includes(searchLower) && !tagsString.includes(searchLower)) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  });\r\n\r\n  if (filteredInventory.length === 0) {\r\n    container.innerHTML = '<p style=\"color: var(--text-secondary); text-align: center; padding: 20px;\">No items match filters</p>';\r\n    return;\r\n  }\r\n\r\n  // Sort inventory: equipped first, then by name\r\n  filteredInventory.sort((a, b) => {\r\n    if (a.equipped && !b.equipped) return -1;\r\n    if (!a.equipped && b.equipped) return 1;\r\n    return (a.name || '').localeCompare(b.name || '');\r\n  });\r\n\r\n  // Group items by category/container\r\n  filteredInventory.forEach(item => {\r\n    const itemCard = createInventoryCard(item);\r\n    container.appendChild(itemCard);\r\n  });\r\n\r\n  debug.log(`\uD83C\uDF92 Displayed ${filteredInventory.length} items`);\r\n}\r\n\r\n// Create individual inventory item card\r\nfunction createInventoryCard(item) {\r\n  const card = document.createElement('div');\r\n  card.className = 'action-card'; // Reuse action card styling\r\n  card.style.cssText = `\r\n    background: var(--bg-card);\r\n    border-left: 4px solid ${item.equipped ? '#27ae60' : item.attuned ? '#9b59b6' : '#95a5a6'};\r\n    padding: 15px;\r\n    margin-bottom: 10px;\r\n    border-radius: 6px;\r\n    cursor: pointer;\r\n    transition: all 0.2s;\r\n    ${item.equipped ? 'box-shadow: 0 0 10px rgba(39, 174, 96, 0.3);' : ''}\r\n  `;\r\n\r\n  card.onmouseover = () => {\r\n    card.style.background = 'var(--bg-card-hover)';\r\n    card.style.transform = 'translateX(2px)';\r\n  };\r\n  card.onmouseout = () => {\r\n    card.style.background = 'var(--bg-card)';\r\n    card.style.transform = 'translateX(0)';\r\n  };\r\n\r\n  // Header with name and quantity\r\n  const header = document.createElement('div');\r\n  header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';\r\n\r\n  const nameSection = document.createElement('div');\r\n  nameSection.style.cssText = 'display: flex; align-items: center; gap: 8px;';\r\n\r\n  const itemName = document.createElement('strong');\r\n  itemName.textContent = item.name || 'Unnamed Item';\r\n  itemName.style.cssText = 'color: var(--text-primary); font-size: 1.1em;';\r\n  nameSection.appendChild(itemName);\r\n\r\n  // Add badges for equipped/attuned\r\n  if (item.equipped) {\r\n    const equippedBadge = document.createElement('span');\r\n    equippedBadge.textContent = '\u2694\uFE0F Equipped';\r\n    equippedBadge.style.cssText = 'background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold;';\r\n    nameSection.appendChild(equippedBadge);\r\n  }\r\n\r\n  if (item.attuned) {\r\n    const attunedBadge = document.createElement('span');\r\n    attunedBadge.textContent = '\u2728 Attuned';\r\n    attunedBadge.style.cssText = 'background: #9b59b6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold;';\r\n    nameSection.appendChild(attunedBadge);\r\n  }\r\n\r\n  if (item.requiresAttunement && !item.attuned) {\r\n    const requiresBadge = document.createElement('span');\r\n    requiresBadge.textContent = '(Requires Attunement)';\r\n    requiresBadge.style.cssText = 'color: var(--text-muted); font-size: 0.85em; font-style: italic;';\r\n    nameSection.appendChild(requiresBadge);\r\n  }\r\n\r\n  header.appendChild(nameSection);\r\n\r\n  // Quantity display\r\n  const metaSection = document.createElement('div');\r\n  metaSection.style.cssText = 'display: flex; flex-direction: column; align-items: flex-end; gap: 4px;';\r\n\r\n  if (item.quantity > 1 || item.showIncrement) {\r\n    const quantitySpan = document.createElement('span');\r\n    quantitySpan.textContent = `\u00D7${item.quantity}`;\r\n    quantitySpan.style.cssText = 'color: var(--text-secondary); font-weight: bold; font-size: 1.1em;';\r\n    metaSection.appendChild(quantitySpan);\r\n  }\r\n\r\n  header.appendChild(metaSection);\r\n  card.appendChild(header);\r\n\r\n  // Weight\r\n  if (item.weight && item.weight > 0) {\r\n    const weightDiv = document.createElement('div');\r\n    const totalWeight = item.weight * item.quantity;\r\n    weightDiv.textContent = `\u2696\uFE0F ${totalWeight} lb${totalWeight !== 1 ? 's' : ''}`;\r\n    weightDiv.style.cssText = 'color: var(--text-secondary); font-size: 0.85em; margin-bottom: 4px;';\r\n    card.appendChild(weightDiv);\r\n  }\r\n\r\n  // Tags\r\n  if (item.tags && item.tags.length > 0) {\r\n    const tagsDiv = document.createElement('div');\r\n    tagsDiv.style.cssText = 'display: flex; gap: 6px; flex-wrap: wrap; margin: 6px 0;';\r\n    item.tags.forEach(tag => {\r\n      const tagSpan = document.createElement('span');\r\n      tagSpan.textContent = tag;\r\n      tagSpan.style.cssText = 'background: var(--bg-tertiary); color: var(--text-secondary); padding: 2px 6px; border-radius: 8px; font-size: 0.75em;';\r\n      tagsDiv.appendChild(tagSpan);\r\n    });\r\n    card.appendChild(tagsDiv);\r\n  }\r\n\r\n  // Description (collapsed by default, click to expand)\r\n  if (item.description && item.description.trim()) {\r\n    const descDiv = document.createElement('div');\r\n    descDiv.style.cssText = 'color: var(--text-secondary); font-size: 0.9em; margin-top: 8px; border-top: 1px solid var(--border-color); padding-top: 8px; line-height: 1.4; max-height: 0; overflow: hidden; transition: max-height 0.3s;';\r\n    descDiv.innerHTML = item.description.replace(/\\n/g, '<br>');\r\n\r\n    card.addEventListener('click', () => {\r\n      if (descDiv.style.maxHeight === '0px' || !descDiv.style.maxHeight) {\r\n        descDiv.style.maxHeight = '500px';\r\n        descDiv.style.paddingTop = '8px';\r\n      } else {\r\n        descDiv.style.maxHeight = '0px';\r\n        descDiv.style.paddingTop = '0px';\r\n      }\r\n    });\r\n\r\n    card.appendChild(descDiv);\r\n  }\r\n\r\n  return card;\r\n}\r\n\r\nfunction buildCompanionsDisplay(companions) {\r\n  const container = document.getElementById('companions-container');\r\n  const section = document.getElementById('companions-section');\r\n\r\n  // Show the companions section\r\n  section.style.display = 'block';\r\n\r\n  container.innerHTML = '';\r\n\r\n  companions.forEach(companion => {\r\n    debug.log('\uD83D\uDD0D DEBUG: Companion object in popup:', companion);\r\n    debug.log('\uD83D\uDD0D DEBUG: Companion abilities:', companion.abilities);\r\n    debug.log('\uD83D\uDD0D DEBUG: Companion abilities keys:', Object.keys(companion.abilities));\r\n\r\n    const companionCard = document.createElement('div');\r\n    companionCard.className = 'action-card';\r\n    companionCard.style.background = 'var(--bg-card)';\r\n    companionCard.style.borderColor = 'var(--border-card)';\r\n\r\n    // Header with name and basic info\r\n    const header = document.createElement('div');\r\n    header.className = 'action-header';\r\n    header.style.cursor = 'pointer';\r\n\r\n    const nameDiv = document.createElement('div');\r\n    nameDiv.innerHTML = `\r\n      <div class=\"action-name\">\uD83D\uDC3E ${companion.name}</div>\r\n      <div style=\"font-size: 0.85em; color: var(--text-secondary); font-style: italic;\">\r\n        ${companion.size} ${companion.type}${companion.alignment ? ', ' + companion.alignment : ''}\r\n      </div>\r\n    `;\r\n\r\n    header.appendChild(nameDiv);\r\n    companionCard.appendChild(header);\r\n\r\n    // Stats block\r\n    const statsDiv = document.createElement('div');\r\n    statsDiv.className = 'action-description expanded';\r\n    statsDiv.style.display = 'block';\r\n    statsDiv.style.background = 'var(--bg-secondary)';\r\n    statsDiv.style.padding = '12px';\r\n    statsDiv.style.borderRadius = '4px';\r\n    statsDiv.style.marginTop = '10px';\r\n\r\n    let statsHTML = '<div style=\"display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;\">';\r\n\r\n    // AC, HP, Speed\r\n    if (companion.ac) statsHTML += `<div><strong>AC:</strong> ${companion.ac}</div>`;\r\n    if (companion.hp) statsHTML += `<div><strong>HP:</strong> ${companion.hp}</div>`;\r\n    if (companion.speed) statsHTML += `<div style=\"grid-column: span 3;\"><strong>Speed:</strong> ${companion.speed}</div>`;\r\n\r\n    statsHTML += '</div>';\r\n\r\n    // Abilities\r\n    if (Object.keys(companion.abilities).length > 0) {\r\n      statsHTML += '<div style=\"display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; text-align: center; margin: 10px 0; padding: 8px; background: var(--bg-tertiary); border-radius: 4px;\">';\r\n      ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(ability => {\r\n        if (companion.abilities[ability]) {\r\n          const abil = companion.abilities[ability];\r\n          statsHTML += `\r\n            <div>\r\n              <div style=\"font-weight: bold; font-size: 0.75em; color: var(--text-secondary);\">${ability.toUpperCase()}</div>\r\n              <div style=\"font-size: 1.1em; color: var(--text-primary);\">${abil.score}</div>\r\n              <div style=\"font-size: 0.9em; color: var(--accent-success);\">(${abil.modifier >= 0 ? '+' : ''}${abil.modifier})</div>\r\n            </div>\r\n          `;\r\n        }\r\n      });\r\n      statsHTML += '</div>';\r\n    }\r\n\r\n    // Senses, Languages, PB\r\n    if (companion.senses) statsHTML += `<div style=\"margin: 5px 0; color: var(--text-primary);\"><strong>Senses:</strong> ${companion.senses}</div>`;\r\n    if (companion.languages) statsHTML += `<div style=\"margin: 5px 0; color: var(--text-primary);\"><strong>Languages:</strong> ${companion.languages}</div>`;\r\n    if (companion.proficiencyBonus) statsHTML += `<div style=\"margin: 5px 0; color: var(--text-primary);\"><strong>Proficiency Bonus:</strong> +${companion.proficiencyBonus}</div>`;\r\n\r\n    // Features\r\n    if (companion.features && companion.features.length > 0) {\r\n      statsHTML += '<div style=\"margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);\">';\r\n      companion.features.forEach(feature => {\r\n        statsHTML += `<div style=\"margin: 8px 0; color: var(--text-primary);\"><strong>${feature.name}.</strong> ${feature.description}</div>`;\r\n      });\r\n      statsHTML += '</div>';\r\n    }\r\n\r\n    // Actions with attack buttons\r\n    if (companion.actions && companion.actions.length > 0) {\r\n      statsHTML += '<div style=\"margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); color: var(--text-primary);\"><strong>Actions</strong></div>';\r\n      companion.actions.forEach(action => {\r\n        statsHTML += `\r\n          <div style=\"margin: 10px 0; padding: 8px; background: var(--bg-action); border: 1px solid var(--accent-danger); border-radius: 4px;\">\r\n            <div style=\"display: flex; justify-content: space-between; align-items: center;\">\r\n              <div style=\"color: var(--text-primary);\">\r\n                <strong>${action.name}.</strong> Melee Weapon Attack: +${action.attackBonus} to hit, ${action.reach}. <em>Hit:</em> ${action.damage}\r\n              </div>\r\n              <div style=\"display: flex; gap: 8px;\">\r\n                <button class=\"attack-btn companion-attack-btn\" data-name=\"${companion.name} - ${action.name}\" data-bonus=\"${action.attackBonus}\">\u2694\uFE0F Attack</button>\r\n                <button class=\"damage-btn companion-damage-btn\" data-name=\"${companion.name} - ${action.name}\" data-damage=\"${action.damage}\">\uD83D\uDCA5 Damage</button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        `;\r\n      });\r\n    }\r\n\r\n    statsDiv.innerHTML = statsHTML;\r\n    companionCard.appendChild(statsDiv);\r\n\r\n    // Add event listeners for attack/damage buttons\r\n    companionCard.querySelectorAll('.companion-attack-btn').forEach(btn => {\r\n      btn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        const name = btn.dataset.name;\r\n        const bonus = parseInt(btn.dataset.bonus);\r\n        roll(`${name} - Attack`, `1d20+${bonus}`);\r\n      });\r\n    });\r\n\r\n    companionCard.querySelectorAll('.companion-damage-btn').forEach(btn => {\r\n      btn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        const name = btn.dataset.name;\r\n        const damage = btn.dataset.damage;\r\n        roll(`${name} - Damage`, damage);\r\n      });\r\n    });\r\n\r\n    container.appendChild(companionCard);\r\n  });\r\n}\r\n\r\nfunction decrementActionUses(action) {\r\n  if (!action.uses) {\r\n    return true; // No uses to track, allow action\r\n  }\r\n\r\n  const usesTotal = action.uses.total || action.uses.value || action.uses;\r\n  const usesUsed = action.usesUsed || 0;\r\n  const usesRemaining = action.usesLeft !== undefined ? action.usesLeft : (usesTotal - usesUsed);\r\n\r\n  if (usesRemaining <= 0) {\r\n    showNotification(`\u274C No uses remaining for ${action.name}`, 'error');\r\n    return false;\r\n  }\r\n\r\n  // Increment usesUsed and decrement usesLeft\r\n  action.usesUsed = usesUsed + 1;\r\n  if (action.usesLeft !== undefined) {\r\n    action.usesLeft = usesRemaining - 1;\r\n  }\r\n  const newRemaining = action.usesLeft !== undefined ? action.usesLeft : (usesTotal - action.usesUsed);\r\n\r\n  // Update character data and save\r\n  saveCharacterData();\r\n\r\n  // Show notification\r\n  showNotification(`\u2705 Used ${action.name} (${newRemaining}/${usesTotal} remaining)`);\r\n\r\n  // Rebuild the actions display to show updated count\r\n  const actionsContainer = document.getElementById('actions-container');\r\n  buildActionsDisplay(actionsContainer, characterData.actions);\r\n\r\n  return true;\r\n}\r\n\r\nfunction buildResourcesDisplay() {\r\n  const container = document.getElementById('resources-container');\r\n\r\n  if (!characterData || !characterData.resources || characterData.resources.length === 0) {\r\n    container.innerHTML = '<p style=\"text-align: center; color: #666;\">No class resources available</p>';\r\n    debug.log('\u26A0\uFE0F No resources in character data');\r\n    // Collapse the section when empty\r\n    collapseSectionByContainerId('resources-container');\r\n    return;\r\n  }\r\n\r\n  // Expand the section when it has content\r\n  expandSectionByContainerId('resources-container');\r\n\r\n  debug.log(`\uD83D\uDCCA Building resources display with ${characterData.resources.length} resources:`, \r\n    characterData.resources.map(r => `${r.name} (${r.current}/${r.max})`));\r\n\r\n  const resourcesGrid = document.createElement('div');\r\n  resourcesGrid.className = 'spell-slots-grid'; // Reuse spell slot styling\r\n\r\n  characterData.resources.forEach(resource => {\r\n    // Skip resources with MAX = 0 (useless paladin amount resources)\r\n    if (resource.max === 0) {\r\n      debug.log(`\u23ED\uFE0F Skipping resource with MAX = 0: ${resource.name}`);\r\n      return;\r\n    }\r\n    \r\n    // Skip Lucky resources since they have their own action button\r\n    const lowerName = resource.name.toLowerCase().trim();\r\n    if (lowerName.includes('lucky point') || lowerName.includes('luck point') || lowerName === 'lucky points' || lowerName === 'lucky') {\r\n      debug.log(`\u23ED\uFE0F Skipping Lucky resource from display: ${resource.name}`);\r\n      return;\r\n    }\r\n    \r\n    debug.log(`\uD83D\uDCCA Displaying resource: ${resource.name} (${resource.current}/${resource.max})`);\r\n    \r\n    const resourceCard = document.createElement('div');\r\n    resourceCard.className = resource.current > 0 ? 'spell-slot-card' : 'spell-slot-card empty';\r\n    resourceCard.innerHTML = `\r\n      <div class=\"spell-slot-level\">${resource.name}</div>\r\n      <div class=\"spell-slot-count\">${resource.current}/${resource.max}</div>\r\n    `;\r\n\r\n    // Add click to manually adjust resource\r\n    resourceCard.addEventListener('click', () => {\r\n      adjustResource(resource);\r\n    });\r\n    resourceCard.style.cursor = 'pointer';\r\n\r\n    resourcesGrid.appendChild(resourceCard);\r\n  });\r\n\r\n  container.innerHTML = '';\r\n  container.appendChild(resourcesGrid);\r\n\r\n  const note = document.createElement('p');\r\n  note.style.cssText = 'text-align: center; color: #95a5a6; font-size: 0.85em; margin-top: 10px;';\r\n  note.textContent = 'Click a resource to manually adjust';\r\n  container.appendChild(note);\r\n}\r\n\r\nfunction adjustResource(resource) {\r\n  const newValue = prompt(`Adjust ${resource.name}\\n\\nCurrent: ${resource.current}/${resource.max}\\n\\nEnter new current value (0-${resource.max}):`);\r\n\r\n  if (newValue === null) return; // Cancelled\r\n\r\n  const parsed = parseInt(newValue);\r\n  if (isNaN(parsed) || parsed < 0 || parsed > resource.max) {\r\n    alert(`Please enter a number between 0 and ${resource.max}`);\r\n    return;\r\n  }\r\n\r\n  resource.current = parsed;\r\n\r\n  // Also update otherVariables to keep data in sync\r\n  if (characterData.otherVariables && resource.varName) {\r\n    characterData.otherVariables[resource.varName] = resource.current;\r\n  }\r\n\r\n  saveCharacterData();\r\n  buildSheet(characterData);\r\n\r\n  showNotification(`\u2705 ${resource.name} updated to ${resource.current}/${resource.max}`);\r\n}\r\n\r\nfunction showSpellSlotRestorationModal(channelDivinityResource, maxSlotLevel) {\r\n  // Create modal overlay\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  // Create modal content\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); min-width: 400px; max-width: 500px;';\r\n\r\n  // Build spell slot buttons\r\n  let slotButtonsHTML = '';\r\n  const spellSlots = characterData.spellSlots || {};\r\n\r\n  for (let level = 1; level <= maxSlotLevel; level++) {\r\n    const slotVar = `level${level}SpellSlots`;\r\n    const slotMaxVar = `level${level}SpellSlotsMax`;\r\n    const current = spellSlots[slotVar] || 0;\r\n    const max = spellSlots[slotMaxVar] || 0;\r\n\r\n    const isAvailable = max > 0 && current < max;\r\n    const disabled = !isAvailable ? 'disabled' : '';\r\n    const bgColor = isAvailable ? '#9b59b6' : '#bdc3c7';\r\n    const cursor = isAvailable ? 'pointer' : 'not-allowed';\r\n    const opacity = isAvailable ? '1' : '0.6';\r\n\r\n    slotButtonsHTML += `\r\n      <button\r\n        class=\"spell-slot-restore-btn\"\r\n        data-level=\"${level}\"\r\n        ${disabled}\r\n        style=\"width: 100%; padding: 15px; background: ${bgColor}; color: white; border: none; border-radius: 8px; cursor: ${cursor}; font-weight: bold; margin-bottom: 10px; opacity: ${opacity};\">\r\n        <div style=\"display: flex; justify-content: space-between; align-items: center;\">\r\n          <span>Level ${level} Spell Slot</span>\r\n          <span style=\"font-size: 0.9em;\">${current}/${max}</span>\r\n        </div>\r\n      </button>\r\n    `;\r\n  }\r\n\r\n  modalContent.innerHTML = `\r\n    <h3 style=\"margin: 0 0 15px 0; color: #2c3e50; text-align: center;\">\uD83D\uDD2E Harness Divine Power</h3>\r\n    <p style=\"text-align: center; margin-bottom: 20px; color: #555; font-size: 0.95em;\">\r\n      Choose which spell slot to restore (max level ${maxSlotLevel})\r\n    </p>\r\n    <div style=\"margin-bottom: 20px;\">\r\n      ${slotButtonsHTML}\r\n    </div>\r\n    <button id=\"cancel-restore-modal\" style=\"width: 100%; padding: 12px; background: #7f8c8d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n      Cancel\r\n    </button>\r\n  `;\r\n\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  // Add click handlers to spell slot buttons\r\n  const slotButtons = modal.querySelectorAll('.spell-slot-restore-btn:not([disabled])');\r\n  slotButtons.forEach(button => {\r\n    button.addEventListener('click', () => {\r\n      const level = parseInt(button.getAttribute('data-level'));\r\n      restoreSpellSlot(level, channelDivinityResource);\r\n      modal.remove();\r\n    });\r\n  });\r\n\r\n  // Cancel button\r\n  document.getElementById('cancel-restore-modal').addEventListener('click', () => {\r\n    modal.remove();\r\n  });\r\n\r\n  // Click outside to close\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      modal.remove();\r\n    }\r\n  });\r\n}\r\n\r\nfunction restoreSpellSlot(level, channelDivinityResource) {\r\n  const slotVar = `level${level}SpellSlots`;\r\n  const slotMaxVar = `level${level}SpellSlotsMax`;\r\n\r\n  if (!characterData.spellSlots) {\r\n    showNotification('\u274C No spell slots available!', 'error');\r\n    return;\r\n  }\r\n\r\n  const current = characterData.spellSlots[slotVar] || 0;\r\n  const max = characterData.spellSlots[slotMaxVar] || 0;\r\n\r\n  if (max === 0) {\r\n    showNotification('\u274C No spell slots at that level!', 'error');\r\n    return;\r\n  }\r\n\r\n  if (current >= max) {\r\n    showNotification(`\u274C Level ${level} spell slots already full!`, 'error');\r\n    return;\r\n  }\r\n\r\n  // Restore the spell slot\r\n  characterData.spellSlots[slotVar] = Math.min(current + 1, max);\r\n\r\n  // Expend Channel Divinity use\r\n  channelDivinityResource.current = Math.max(0, channelDivinityResource.current - 1);\r\n\r\n  // Update character data - sync with otherVariables using the correct variable name\r\n  if (characterData.otherVariables && channelDivinityResource.variableName) {\r\n    characterData.otherVariables[channelDivinityResource.variableName] = channelDivinityResource.current;\r\n  } else if (characterData.otherVariables && channelDivinityResource.varName) {\r\n    characterData.otherVariables[channelDivinityResource.varName] = channelDivinityResource.current;\r\n  }\r\n\r\n  saveCharacterData();\r\n  buildSheet(characterData);\r\n\r\n  // Announce to Roll20\r\n  const colorBanner = getColoredBanner();\r\n  const newCurrent = characterData.spellSlots[slotVar];\r\n  const messageData = {\r\n    action: 'announceSpell',\r\n    message: `&{template:default} {{name=${colorBanner}${characterData.name} uses Harness Divine Power}} {{\uD83D\uDD2E=Restored a Level ${level} spell slot! (${newCurrent}/${max})}}`,\r\n    color: characterData.notificationColor\r\n  };\r\n\r\n  // Send to Roll20\r\n  if (window.opener && !window.opener.closed) {\r\n    try {\r\n      window.opener.postMessage(messageData, '*');\r\n    } catch (error) {\r\n      debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n      browserAPI.runtime.sendMessage({\r\n        action: 'relayRollToRoll20',\r\n        roll: messageData\r\n      });\r\n    }\r\n  } else {\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'relayRollToRoll20',\r\n      roll: messageData\r\n    });\r\n  }\r\n\r\n  showNotification(`\uD83D\uDD2E Harness Divine Power! Restored Level ${level} spell slot. Channel Divinity: ${channelDivinityResource.current}/${channelDivinityResource.max}`);\r\n  debug.log(`\u2728 Harness Divine Power used to restore Level ${level} spell slot`);\r\n}\r\n\r\n/**\r\n * Show modal for Divine Spark choice (Heal, Necrotic, or Radiant)\r\n * @param {Object} action - The Divine Spark action\r\n * @param {Object} channelDivinityResource - The Channel Divinity resource\r\n */\r\nfunction showDivineSparkModal(action, channelDivinityResource) {\r\n  // Create modal overlay\r\n  const modal = document.createElement('div');\r\n  modal.className = 'modal-overlay';\r\n  modal.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    background: rgba(0, 0, 0, 0.7);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10000;\r\n  `;\r\n\r\n  // Get cleric level for damage calculation\r\n  const clericLevel = characterData.otherVariables?.clericLevel || characterData.otherVariables?.cleric?.level || 1;\r\n  const wisdomMod = characterData.abilityScores?.wisdom?.modifier || 0;\r\n\r\n  // Calculate number of d8 dice based on cleric level\r\n  const diceArray = [1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,4,4,4];\r\n  const numDice = diceArray[Math.min(clericLevel, 20) - 1] || 1;\r\n\r\n  // Create modal content\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = `\r\n    background: #2a2a2a;\r\n    border-radius: 8px;\r\n    padding: 24px;\r\n    max-width: 400px;\r\n    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);\r\n    color: #fff;\r\n  `;\r\n\r\n  modalContent.innerHTML = `\r\n    <h3 style=\"margin-top: 0; margin-bottom: 16px; color: #ffd700; text-align: center;\">\r\n      \u2728 Divine Spark\r\n    </h3>\r\n    <p style=\"margin-bottom: 8px; text-align: center; color: #ccc;\">\r\n      Roll: ${numDice}d8 + ${wisdomMod}\r\n    </p>\r\n    <p style=\"margin-bottom: 20px; text-align: center; font-size: 14px; color: #aaa;\">\r\n      Channel Divinity: ${channelDivinityResource.current}/${channelDivinityResource.max}\r\n    </p>\r\n    <p style=\"margin-bottom: 20px; text-align: center; color: #fff;\">\r\n      Choose the effect:\r\n    </p>\r\n    <div style=\"display: flex; flex-direction: column; gap: 12px;\">\r\n      <button id=\"divine-spark-heal\" style=\"\r\n        padding: 12px 20px;\r\n        font-size: 16px;\r\n        border: 2px solid #4ade80;\r\n        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);\r\n        color: white;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        transition: all 0.2s;\r\n      \">\uD83D\uDC9A Heal Target</button>\r\n      <button id=\"divine-spark-necrotic\" style=\"\r\n        padding: 12px 20px;\r\n        font-size: 16px;\r\n        border: 2px solid #a78bfa;\r\n        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);\r\n        color: white;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        transition: all 0.2s;\r\n      \">\uD83D\uDDA4 Necrotic Damage</button>\r\n      <button id=\"divine-spark-radiant\" style=\"\r\n        padding: 12px 20px;\r\n        font-size: 16px;\r\n        border: 2px solid #fbbf24;\r\n        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);\r\n        color: white;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        transition: all 0.2s;\r\n      \">\u2728 Radiant Damage</button>\r\n      <button id=\"divine-spark-cancel\" style=\"\r\n        padding: 10px 20px;\r\n        font-size: 14px;\r\n        background: #444;\r\n        color: white;\r\n        border: 1px solid #666;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        margin-top: 8px;\r\n      \">Cancel</button>\r\n    </div>\r\n  `;\r\n\r\n  modal.appendChild(modalContent);\r\n\r\n  // Add hover effects\r\n  const buttons = modalContent.querySelectorAll('button:not(#divine-spark-cancel)');\r\n  buttons.forEach(btn => {\r\n    btn.addEventListener('mouseenter', () => {\r\n      btn.style.transform = 'scale(1.05)';\r\n      btn.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';\r\n    });\r\n    btn.addEventListener('mouseleave', () => {\r\n      btn.style.transform = 'scale(1)';\r\n      btn.style.boxShadow = 'none';\r\n    });\r\n  });\r\n\r\n  // Helper function to execute Divine Spark\r\n  const executeDivineSpark = (type, color, damageType = null) => {\r\n    // Consume Channel Divinity use\r\n    channelDivinityResource.current -= 1;\r\n    saveCharacterData();\r\n\r\n    // Set the Divine Spark Choice variable in DiceCloud\r\n    const choiceValue = type === 'heal' ? 1 : (type === 'necrotic' ? 2 : 3);\r\n    if (characterData.otherVariables) {\r\n      characterData.otherVariables.divineSparkChoice = choiceValue;\r\n    }\r\n\r\n    // Build the roll formula\r\n    const rollFormula = `${numDice}d8 + ${wisdomMod}`;\r\n\r\n    // Create roll description\r\n    const effectText = type === 'heal' ? 'Healing' : `${damageType} Damage`;\r\n    const colorBanner = `<span style=\"color: ${color}; font-weight: bold;\">`;\r\n\r\n    // Send the roll to Roll20\r\n    const messageData = {\r\n      action: 'sendRoll20Message',\r\n      message: `&{template:default} {{name=${colorBanner}${characterData.name} uses Divine Spark}} {{Effect=${effectText}}} {{Roll=[[${rollFormula}]]}} {{Channel Divinity=${channelDivinityResource.current}/${channelDivinityResource.max}}}`,\r\n      color: color\r\n    };\r\n\r\n    if (window.opener && !window.opener.closed) {\r\n      try {\r\n        window.opener.postMessage(messageData, '*');\r\n      } catch (error) {\r\n        debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n        browserAPI.runtime.sendMessage({\r\n          action: 'relayRollToRoll20',\r\n          roll: messageData\r\n        });\r\n      }\r\n    } else {\r\n      browserAPI.runtime.sendMessage({\r\n        action: 'relayRollToRoll20',\r\n        roll: messageData\r\n      });\r\n    }\r\n\r\n    // Show notification\r\n    showNotification(`\u2728 Divine Spark (${effectText})! Channel Divinity: ${channelDivinityResource.current}/${channelDivinityResource.max}`, 'success');\r\n    debug.log(`\u2728 Divine Spark used: ${effectText}`);\r\n\r\n    // Rebuild sheet to show updated Channel Divinity count\r\n    buildSheet(characterData);\r\n\r\n    // Remove modal\r\n    modal.remove();\r\n  };\r\n\r\n  // Add button click handlers\r\n  document.getElementById('divine-spark-heal')?.addEventListener('click', () => {\r\n    executeDivineSpark('heal', '#22c55e');\r\n  });\r\n\r\n  document.getElementById('divine-spark-necrotic')?.addEventListener('click', () => {\r\n    executeDivineSpark('necrotic', '#8b5cf6', 'Necrotic');\r\n  });\r\n\r\n  document.getElementById('divine-spark-radiant')?.addEventListener('click', () => {\r\n    executeDivineSpark('radiant', '#f59e0b', 'Radiant');\r\n  });\r\n\r\n  document.getElementById('divine-spark-cancel')?.addEventListener('click', () => {\r\n    modal.remove();\r\n  });\r\n\r\n  // Close on overlay click\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      modal.remove();\r\n    }\r\n  });\r\n\r\n  // Add to document\r\n  document.body.appendChild(modal);\r\n\r\n  // Wait for modal to be in DOM before adding event listeners\r\n  requestAnimationFrame(() => {\r\n    const healBtn = document.getElementById('divine-spark-heal');\r\n    const necroticBtn = document.getElementById('divine-spark-necrotic');\r\n    const radiantBtn = document.getElementById('divine-spark-radiant');\r\n    const cancelBtn = document.getElementById('divine-spark-cancel');\r\n\r\n    healBtn?.addEventListener('click', () => executeDivineSpark('heal', '#22c55e'));\r\n    necroticBtn?.addEventListener('click', () => executeDivineSpark('necrotic', '#8b5cf6', 'Necrotic'));\r\n    radiantBtn?.addEventListener('click', () => executeDivineSpark('radiant', '#f59e0b', 'Radiant'));\r\n    cancelBtn?.addEventListener('click', () => modal.remove());\r\n  });\r\n}\r\n\r\nfunction buildSpellSlotsDisplay() {\r\n  const container = document.getElementById('spell-slots-container');\r\n\r\n  if (!characterData || !characterData.spellSlots) {\r\n    container.innerHTML = '<p style=\"text-align: center; color: #666;\">No spell slots available</p>';\r\n    debug.log('\u26A0\uFE0F No spell slots in character data');\r\n    // Collapse the section when empty\r\n    collapseSectionByContainerId('spell-slots-container');\r\n    return;\r\n  }\r\n\r\n  const slotsGrid = document.createElement('div');\r\n  slotsGrid.className = 'spell-slots-grid';\r\n\r\n  let hasAnySlots = false;\r\n  let totalCurrentSlots = 0;\r\n  let totalMaxSlots = 0;\r\n\r\n  // Check for Pact Magic (Warlock) - stored separately from regular slots\r\n  // Check both spellSlots and otherVariables since data may come from either source\r\n  // DiceCloud uses various variable names: pactSlot, pactMagicSlots, pactSlotLevelVisible, etc.\r\n  const pactMagicSlotLevel = characterData.spellSlots?.pactMagicSlotLevel ||\r\n                             characterData.otherVariables?.pactMagicSlotLevel ||\r\n                             characterData.otherVariables?.pactSlotLevelVisible ||\r\n                             characterData.otherVariables?.pactSlotLevel ||\r\n                             characterData.otherVariables?.slotLevel;\r\n  const pactMagicSlots = characterData.spellSlots?.pactMagicSlots ??\r\n                         characterData.otherVariables?.pactMagicSlots ??\r\n                         characterData.otherVariables?.pactSlot ?? 0;\r\n  const pactMagicSlotsMax = characterData.spellSlots?.pactMagicSlotsMax ??\r\n                            characterData.otherVariables?.pactMagicSlotsMax ??\r\n                            characterData.otherVariables?.pactSlotMax ?? 0;\r\n  const hasPactMagic = pactMagicSlotsMax > 0;\r\n  // Default slot level to 5 (max pact level) if we have slots but couldn't detect level\r\n  const effectivePactLevel = pactMagicSlotLevel || (hasPactMagic ? 5 : 0);\r\n\r\n  debug.log(`\uD83D\uDD2E Spell slots display - Pact Magic: level=${pactMagicSlotLevel} (effective=${effectivePactLevel}), slots=${pactMagicSlots}/${pactMagicSlotsMax}, hasPact=${hasPactMagic}`);\r\n\r\n  // Add Pact Magic slots first if present\r\n  if (hasPactMagic) {\r\n    hasAnySlots = true;\r\n    totalCurrentSlots += pactMagicSlots;\r\n    totalMaxSlots += pactMagicSlotsMax;\r\n\r\n    const slotCard = document.createElement('div');\r\n    slotCard.className = pactMagicSlots > 0 ? 'spell-slot-card pact-magic' : 'spell-slot-card pact-magic empty';\r\n    slotCard.style.cssText = 'background: linear-gradient(135deg, #6b3fa0, #9b59b6); border: 2px solid #8e44ad;';\r\n\r\n    slotCard.innerHTML = `\r\n      <div class=\"spell-slot-level\">Pact (${effectivePactLevel})</div>\r\n      <div class=\"spell-slot-count\">${pactMagicSlots}/${pactMagicSlotsMax}</div>\r\n    `;\r\n\r\n    // Add click to manually adjust Pact Magic slots\r\n    slotCard.addEventListener('click', () => {\r\n      adjustSpellSlot(`pact:${effectivePactLevel}`, pactMagicSlots, pactMagicSlotsMax, true);\r\n    });\r\n    slotCard.style.cursor = 'pointer';\r\n    slotCard.title = 'Click to adjust Pact Magic slots (recharge on short rest)';\r\n\r\n    slotsGrid.appendChild(slotCard);\r\n  }\r\n\r\n  // Check each level (1-9) for regular spell slots\r\n  for (let level = 1; level <= 9; level++) {\r\n    const slotVar = `level${level}SpellSlots`;\r\n    const slotMaxVar = `level${level}SpellSlotsMax`;\r\n\r\n    const maxSlots = characterData.spellSlots[slotMaxVar] || 0;\r\n\r\n    // Only show if character has regular slots at this level\r\n    if (maxSlots > 0) {\r\n      hasAnySlots = true;\r\n      const currentSlots = characterData.spellSlots[slotVar] || 0;\r\n\r\n      // Track totals\r\n      totalCurrentSlots += currentSlots;\r\n      totalMaxSlots += maxSlots;\r\n\r\n      const slotCard = document.createElement('div');\r\n      slotCard.className = currentSlots > 0 ? 'spell-slot-card' : 'spell-slot-card empty';\r\n\r\n      slotCard.innerHTML = `\r\n        <div class=\"spell-slot-level\">Level ${level}</div>\r\n        <div class=\"spell-slot-count\">${currentSlots}/${maxSlots}</div>\r\n      `;\r\n\r\n      // Add click to manually adjust slots with hover effect\r\n      slotCard.addEventListener('click', () => {\r\n        adjustSpellSlot(level, currentSlots, maxSlots);\r\n      });\r\n      slotCard.style.cursor = 'pointer';\r\n      slotCard.title = 'Click to adjust spell slots';\r\n\r\n      slotsGrid.appendChild(slotCard);\r\n    }\r\n  }\r\n\r\n  if (hasAnySlots) {\r\n    container.innerHTML = '';\r\n    \r\n    // Add total slots summary\r\n    const summaryCard = document.createElement('div');\r\n    summaryCard.className = 'spell-slots-summary';\r\n    summaryCard.style.cssText = `\r\n      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);\r\n      color: white;\r\n      padding: 12px;\r\n      border-radius: 8px;\r\n      text-align: center;\r\n      margin-bottom: 15px;\r\n      font-weight: bold;\r\n      box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3);\r\n    `;\r\n    \r\n    const totalPercent = totalMaxSlots > 0 ? (totalCurrentSlots / totalMaxSlots) * 100 : 0;\r\n    summaryCard.innerHTML = `\r\n      <div style=\"font-size: 14px; opacity: 0.9;\">Total Spell Slots</div>\r\n      <div style=\"font-size: 20px; margin: 4px 0;\">${totalCurrentSlots}/${totalMaxSlots}</div>\r\n      <div style=\"font-size: 12px; opacity: 0.8;\">${Math.round(totalPercent)}% remaining</div>\r\n    `;\r\n    \r\n    container.appendChild(summaryCard);\r\n    container.appendChild(slotsGrid);\r\n\r\n    // Add a small note\r\n    const note = document.createElement('p');\r\n    note.style.cssText = 'text-align: center; color: #666; font-size: 0.85em; margin-top: 8px;';\r\n    note.textContent = 'Click a slot to manually adjust';\r\n    container.appendChild(note);\r\n    \r\n    debug.log(`\u2728 Spell slots display: ${totalCurrentSlots}/${totalMaxSlots} total slots across ${Math.max(...Array.from({length: 9}, (_, i) => i + 1).filter(level => characterData.spellSlots[`level${level}SpellSlotsMax`] > 0))} levels`);\r\n    // Expand the section when it has content\r\n    expandSectionByContainerId('spell-slots-container');\r\n  } else {\r\n    container.innerHTML = '<p style=\"text-align: center; color: #666;\">No spell slots available</p>';\r\n    debug.log('\u26A0\uFE0F Character has 0 max slots for all levels');\r\n    // Collapse the section when empty\r\n    collapseSectionByContainerId('spell-slots-container');\r\n  }\r\n}\r\n\r\nfunction adjustSpellSlot(level, current, max, isPactMagic = false) {\r\n  // Check if this is a Pact Magic slot (format: \"pact:${level}\")\r\n  const isPact = isPactMagic || (typeof level === 'string' && level.startsWith('pact:'));\r\n  const actualLevel = isPact ? parseInt(level.toString().split(':')[1] || level) : level;\r\n\r\n  const slotLabel = isPact ? `Pact Magic (Level ${actualLevel})` : `Level ${actualLevel}`;\r\n  const newValue = prompt(`Adjust ${slotLabel} Spell Slots\\n\\nCurrent: ${current}/${max}\\n\\nEnter new current value (0-${max}):`);\r\n\r\n  if (newValue === null) return; // Cancelled\r\n\r\n  const parsed = parseInt(newValue);\r\n  if (isNaN(parsed) || parsed < 0 || parsed > max) {\r\n    showNotification('\u274C Invalid value', 'error');\r\n    return;\r\n  }\r\n\r\n  if (isPact) {\r\n    characterData.spellSlots.pactMagicSlots = parsed;\r\n  } else {\r\n    const slotVar = `level${actualLevel}SpellSlots`;\r\n    characterData.spellSlots[slotVar] = parsed;\r\n  }\r\n  saveCharacterData();\r\n  buildSheet(characterData);\r\n\r\n  showNotification(`\u2705 ${slotLabel} slots set to ${parsed}/${max}`);\r\n}\r\n\r\nfunction showHPModal() {\r\n  // Create modal overlay\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  // Create modal content\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); min-width: 300px;';\r\n\r\n  const currentHP = characterData.hitPoints.current;\r\n  const maxHP = characterData.hitPoints.max;\r\n  const tempHP = characterData.temporaryHP || 0;\r\n\r\n  modalContent.innerHTML = `\r\n    <h3 style=\"margin: 0 0 20px 0; color: #2c3e50; text-align: center;\">Adjust Hit Points</h3>\r\n    <div style=\"text-align: center; font-size: 1.2em; margin-bottom: 20px; color: #7f8c8d;\">\r\n      Current: <strong>${currentHP}${tempHP > 0 ? `+${tempHP}` : ''} / ${maxHP}</strong>\r\n    </div>\r\n\r\n    <div style=\"margin-bottom: 20px;\">\r\n      <label style=\"display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50;\">Amount:</label>\r\n      <input type=\"number\" id=\"hp-amount\" min=\"1\" value=\"1\" style=\"width: 100%; padding: 10px; font-size: 1.1em; border: 2px solid #bdc3c7; border-radius: 6px; box-sizing: border-box;\">\r\n    </div>\r\n\r\n    <div style=\"margin-bottom: 25px;\">\r\n      <label style=\"display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50;\">Action:</label>\r\n      <div style=\"display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;\">\r\n        <button id=\"hp-toggle-heal\" style=\"padding: 12px; font-size: 0.9em; font-weight: bold; border: 2px solid #27ae60; background: #27ae60; color: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;\">\r\n          \uD83D\uDC9A Heal\r\n        </button>\r\n        <button id=\"hp-toggle-damage\" style=\"padding: 12px; font-size: 0.9em; font-weight: bold; border: 2px solid #bdc3c7; background: white; color: #7f8c8d; border-radius: 6px; cursor: pointer; transition: all 0.2s;\">\r\n          \uD83D\uDC94 Damage\r\n        </button>\r\n        <button id=\"hp-toggle-temp\" style=\"padding: 12px; font-size: 0.9em; font-weight: bold; border: 2px solid #bdc3c7; background: white; color: #7f8c8d; border-radius: 6px; cursor: pointer; transition: all 0.2s;\">\r\n          \uD83D\uDEE1\uFE0F Temp HP\r\n        </button>\r\n      </div>\r\n    </div>\r\n\r\n    <div style=\"display: flex; gap: 10px;\">\r\n      <button id=\"hp-cancel\" style=\"flex: 1; padding: 12px; font-size: 1em; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n        Cancel\r\n      </button>\r\n      <button id=\"hp-confirm\" style=\"flex: 1; padding: 12px; font-size: 1em; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n        Confirm\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  // Toggle state: 'heal', 'damage', or 'temp'\r\n  let actionType = 'heal';\r\n\r\n  const healBtn = document.getElementById('hp-toggle-heal');\r\n  const damageBtn = document.getElementById('hp-toggle-damage');\r\n  const tempBtn = document.getElementById('hp-toggle-temp');\r\n  const amountInput = document.getElementById('hp-amount');\r\n\r\n  // Helper function to reset all buttons\r\n  const resetButtons = () => {\r\n    healBtn.style.background = 'white';\r\n    healBtn.style.color = '#7f8c8d';\r\n    healBtn.style.borderColor = '#bdc3c7';\r\n    damageBtn.style.background = 'white';\r\n    damageBtn.style.color = '#7f8c8d';\r\n    damageBtn.style.borderColor = '#bdc3c7';\r\n    tempBtn.style.background = 'white';\r\n    tempBtn.style.color = '#7f8c8d';\r\n    tempBtn.style.borderColor = '#bdc3c7';\r\n  };\r\n\r\n  // Toggle button handlers\r\n  healBtn.addEventListener('click', () => {\r\n    actionType = 'heal';\r\n    resetButtons();\r\n    healBtn.style.background = '#27ae60';\r\n    healBtn.style.color = 'white';\r\n    healBtn.style.borderColor = '#27ae60';\r\n  });\r\n\r\n  damageBtn.addEventListener('click', () => {\r\n    actionType = 'damage';\r\n    resetButtons();\r\n    damageBtn.style.background = '#e74c3c';\r\n    damageBtn.style.color = 'white';\r\n    damageBtn.style.borderColor = '#e74c3c';\r\n  });\r\n\r\n  tempBtn.addEventListener('click', () => {\r\n    actionType = 'temp';\r\n    resetButtons();\r\n    tempBtn.style.background = '#3498db';\r\n    tempBtn.style.color = 'white';\r\n    tempBtn.style.borderColor = '#3498db';\r\n  });\r\n\r\n  // Cancel button\r\n  document.getElementById('hp-cancel').addEventListener('click', () => {\r\n    modal.remove();\r\n  });\r\n\r\n  // Confirm button\r\n  document.getElementById('hp-confirm').addEventListener('click', () => {\r\n    const amount = parseInt(amountInput.value);\r\n\r\n    if (isNaN(amount) || amount <= 0) {\r\n      showNotification('\u274C Please enter a valid amount', 'error');\r\n      return;\r\n    }\r\n\r\n    const oldHP = characterData.hitPoints.current;\r\n    const oldTempHP = characterData.temporaryHP || 0;\r\n    const colorBanner = getColoredBanner();\r\n    let messageData;\r\n\r\n    if (actionType === 'heal') {\r\n      // Healing: increase current HP (up to max), doesn't affect temp HP (RAW)\r\n      characterData.hitPoints.current = Math.min(currentHP + amount, maxHP);\r\n      const actualHealing = characterData.hitPoints.current - oldHP;\r\n\r\n      // Reset death saves on healing\r\n      if (actualHealing > 0 && characterData.deathSaves && (characterData.deathSaves.successes > 0 || characterData.deathSaves.failures > 0)) {\r\n        characterData.deathSaves.successes = 0;\r\n        characterData.deathSaves.failures = 0;\r\n        debug.log('\u267B\uFE0F Death saves reset due to healing');\r\n      }\r\n\r\n      showNotification(`\uD83D\uDC9A Healed ${actualHealing} HP! (${characterData.hitPoints.current}${characterData.temporaryHP > 0 ? `+${characterData.temporaryHP}` : ''}/${maxHP})`);\r\n\r\n      messageData = {\r\n        action: 'announceSpell',\r\n        message: `&{template:default} {{name=${colorBanner}${characterData.name} regains HP}} {{\uD83D\uDC9A Healing=${actualHealing} HP}} {{Current HP=${characterData.hitPoints.current}${characterData.temporaryHP > 0 ? `+${characterData.temporaryHP}` : ''}/${maxHP}}}`,\r\n        color: characterData.notificationColor\r\n      };\r\n    } else if (actionType === 'damage') {\r\n      // Damage: deplete temp HP first, then current HP (RAW)\r\n      let remainingDamage = amount;\r\n      let tempHPLost = 0;\r\n      let actualDamage = 0;\r\n\r\n      if (characterData.temporaryHP > 0) {\r\n        tempHPLost = Math.min(characterData.temporaryHP, remainingDamage);\r\n        characterData.temporaryHP -= tempHPLost;\r\n        remainingDamage -= tempHPLost;\r\n      }\r\n\r\n      if (remainingDamage > 0) {\r\n        characterData.hitPoints.current = Math.max(currentHP - remainingDamage, 0);\r\n        actualDamage = oldHP - characterData.hitPoints.current;\r\n      }\r\n\r\n      const damageMsg = tempHPLost > 0\r\n        ? `\uD83D\uDC94 Took ${amount} damage! (${tempHPLost} temp HP${actualDamage > 0 ? ` + ${actualDamage} HP` : ''})`\r\n        : `\uD83D\uDC94 Took ${actualDamage} damage!`;\r\n\r\n      showNotification(`${damageMsg} (${characterData.hitPoints.current}${characterData.temporaryHP > 0 ? `+${characterData.temporaryHP}` : ''}/${maxHP})`);\r\n\r\n      const damageDetails = tempHPLost > 0\r\n        ? `{{Temp HP Lost=${tempHPLost}}}${actualDamage > 0 ? ` {{HP Lost=${actualDamage}}}` : ''}`\r\n        : `{{HP Lost=${actualDamage}}}`;\r\n\r\n      messageData = {\r\n        action: 'announceSpell',\r\n        message: `&{template:default} {{name=${colorBanner}${characterData.name} takes damage}} {{\uD83D\uDC94 Total Damage=${amount}}} ${damageDetails} {{Current HP=${characterData.hitPoints.current}${characterData.temporaryHP > 0 ? `+${characterData.temporaryHP}` : ''}/${maxHP}}}`,\r\n        color: characterData.notificationColor\r\n      };\r\n    } else if (actionType === 'temp') {\r\n      // Temp HP: RAW rules - new temp HP replaces old if higher, otherwise keep old\r\n      const newTempHP = amount;\r\n      if (newTempHP > oldTempHP) {\r\n        characterData.temporaryHP = newTempHP;\r\n        showNotification(`\uD83D\uDEE1\uFE0F Gained ${newTempHP} temp HP! (${characterData.hitPoints.current}+${characterData.temporaryHP}/${maxHP})`);\r\n\r\n        messageData = {\r\n          action: 'announceSpell',\r\n          message: `&{template:default} {{name=${colorBanner}${characterData.name} gains temp HP}} {{\uD83D\uDEE1\uFE0F Temp HP=${newTempHP}}} {{Current HP=${characterData.hitPoints.current}+${characterData.temporaryHP}/${maxHP}}}`,\r\n          color: characterData.notificationColor\r\n        };\r\n      } else {\r\n        showNotification(`\u26A0\uFE0F Kept ${oldTempHP} temp HP (higher than ${newTempHP})`);\r\n        modal.remove();\r\n        return; // Don't send message if temp HP wasn't gained\r\n      }\r\n    }\r\n\r\n    // Send message to Roll20\r\n    if (messageData) {\r\n      // Try window.opener first (Chrome)\r\n      if (window.opener && !window.opener.closed) {\r\n        try {\r\n          window.opener.postMessage(messageData, '*');\r\n        } catch (error) {\r\n          debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n          // Fallback to background script relay\r\n          browserAPI.runtime.sendMessage({\r\n            action: 'relayRollToRoll20',\r\n            roll: messageData\r\n          });\r\n        }\r\n      } else {\r\n        // Fallback: Use background script to relay to Roll20 (Firefox)\r\n        browserAPI.runtime.sendMessage({\r\n          action: 'relayRollToRoll20',\r\n          roll: messageData\r\n        });\r\n      }\r\n    }\r\n\r\n    saveCharacterData();\r\n    buildSheet(characterData);\r\n    modal.remove();\r\n  });\r\n\r\n  // Focus on input\r\n  amountInput.focus();\r\n  amountInput.select();\r\n\r\n  // Allow Enter key to confirm\r\n  amountInput.addEventListener('keypress', (e) => {\r\n    if (e.key === 'Enter') {\r\n      document.getElementById('hp-confirm').click();\r\n    }\r\n  });\r\n\r\n  // Click outside to close\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      modal.remove();\r\n    }\r\n  });\r\n}\r\n\r\nfunction toggleInspiration() {\r\n  if (!characterData) return;\r\n\r\n  if (!characterData.inspiration) {\r\n    // Show modal to gain inspiration\r\n    showGainInspirationModal();\r\n  } else {\r\n    // Show modal to choose how to use inspiration (2014 vs 2024)\r\n    showUseInspirationModal();\r\n  }\r\n}\r\n\r\nfunction showGainInspirationModal() {\r\n  // Create modal overlay\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  // Create modal content\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); min-width: 350px; max-width: 450px;';\r\n\r\n  modalContent.innerHTML = `\r\n    <h3 style=\"margin: 0 0 20px 0; color: #2c3e50; text-align: center;\">\u2B50 Gain Inspiration</h3>\r\n    <p style=\"text-align: center; margin-bottom: 25px; color: #555;\">\r\n      You're about to gain Inspiration! This can be used for:\r\n    </p>\r\n    <div style=\"margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px;\">\r\n      <div style=\"margin-bottom: 12px;\">\r\n        <strong style=\"color: #3498db;\">\uD83D\uDCD6 D&D 2014:</strong> Gain advantage on an attack roll, saving throw, or ability check\r\n      </div>\r\n      <div>\r\n        <strong style=\"color: #e74c3c;\">\uD83D\uDCD6 D&D 2024:</strong> Reroll any die immediately after rolling it\r\n      </div>\r\n    </div>\r\n    <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 10px;\">\r\n      <button id=\"gain-inspiration\" style=\"padding: 15px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n        \u2B50 Gain It\r\n      </button>\r\n      <button id=\"cancel-modal\" style=\"padding: 15px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n        Cancel\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  // Gain inspiration button\r\n  document.getElementById('gain-inspiration').addEventListener('click', () => {\r\n    characterData.inspiration = true;\r\n    const emoji = '\u2B50';\r\n\r\n    debug.log(`${emoji} Inspiration gained`);\r\n    showNotification(`${emoji} Inspiration gained!`);\r\n\r\n    // Announce to Roll20\r\n    const colorBanner = getColoredBanner();\r\n    const messageData = {\r\n      action: 'announceSpell',\r\n      message: `&{template:default} {{name=${colorBanner}${characterData.name} gains Inspiration}} {{${emoji}=You now have Inspiration!}}`,\r\n      color: characterData.notificationColor\r\n    };\r\n\r\n    // Send to Roll20\r\n    if (window.opener && !window.opener.closed) {\r\n      try {\r\n        window.opener.postMessage(messageData, '*');\r\n      } catch (error) {\r\n        debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n        browserAPI.runtime.sendMessage({\r\n          action: 'relayRollToRoll20',\r\n          roll: messageData\r\n        });\r\n      }\r\n    } else {\r\n      browserAPI.runtime.sendMessage({\r\n        action: 'relayRollToRoll20',\r\n        roll: messageData\r\n      });\r\n    }\r\n\r\n    saveCharacterData();\r\n    buildSheet(characterData);\r\n    modal.remove();\r\n  });\r\n\r\n  // Cancel button\r\n  document.getElementById('cancel-modal').addEventListener('click', () => {\r\n    modal.remove();\r\n  });\r\n\r\n  // Click outside to close\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      modal.remove();\r\n    }\r\n  });\r\n}\r\n\r\nfunction showUseInspirationModal() {\r\n  // Create modal overlay\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  // Create modal content\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); min-width: 400px; max-width: 500px;';\r\n\r\n  const lastRollInfo = characterData.lastRoll\r\n    ? `<div style=\"margin-bottom: 20px; padding: 12px; background: #e8f5e9; border-left: 4px solid #27ae60; border-radius: 4px;\">\r\n         <strong>Last Roll:</strong> ${characterData.lastRoll.name}\r\n       </div>`\r\n    : `<div style=\"margin-bottom: 20px; padding: 12px; background: #ffebee; border-left: 4px solid #e74c3c; border-radius: 4px;\">\r\n         <strong>\u26A0\uFE0F No previous roll to reroll</strong>\r\n       </div>`;\r\n\r\n  modalContent.innerHTML = `\r\n    <h3 style=\"margin: 0 0 20px 0; color: #2c3e50; text-align: center;\">\u2728 Use Inspiration</h3>\r\n    <p style=\"text-align: center; margin-bottom: 20px; color: #555;\">\r\n      How do you want to use your Inspiration?\r\n    </p>\r\n    ${lastRollInfo}\r\n    <div style=\"display: grid; gap: 12px; margin-bottom: 20px;\">\r\n      <button id=\"use-2014\" style=\"padding: 18px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-align: left;\">\r\n        <div style=\"font-size: 1.1em; margin-bottom: 5px;\">\uD83D\uDCD6 D&D 2014 - Advantage</div>\r\n        <div style=\"font-size: 0.85em; opacity: 0.9;\">Gain advantage on your next attack roll, saving throw, or ability check</div>\r\n      </button>\r\n      <button id=\"use-2024\" ${!characterData.lastRoll ? 'disabled' : ''} style=\"padding: 18px; background: ${!characterData.lastRoll ? '#95a5a6' : '#e74c3c'}; color: white; border: none; border-radius: 8px; cursor: ${!characterData.lastRoll ? 'not-allowed' : 'pointer'}; font-weight: bold; text-align: left;\">\r\n        <div style=\"font-size: 1.1em; margin-bottom: 5px;\">\uD83D\uDCD6 D&D 2024 - Reroll</div>\r\n        <div style=\"font-size: 0.85em; opacity: 0.9;\">Reroll your last roll and use the new result</div>\r\n      </button>\r\n    </div>\r\n    <button id=\"cancel-use-modal\" style=\"width: 100%; padding: 12px; background: #7f8c8d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n      Cancel\r\n    </button>\r\n  `;\r\n\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  // 2014 Advantage button\r\n  document.getElementById('use-2014').addEventListener('click', () => {\r\n    characterData.inspiration = false;\r\n    const emoji = '\u2728';\r\n\r\n    debug.log(`${emoji} Inspiration spent (2014 - Advantage)`);\r\n    showNotification(`${emoji} Inspiration used! Gain advantage on your next roll.`);\r\n\r\n    // Announce to Roll20\r\n    const colorBanner = getColoredBanner();\r\n    const messageData = {\r\n      action: 'announceSpell',\r\n      message: `&{template:default} {{name=${colorBanner}${characterData.name} uses Inspiration (2014)}} {{${emoji}=Gain advantage on your next attack roll, saving throw, or ability check!}}`,\r\n      color: characterData.notificationColor\r\n    };\r\n\r\n    // Send to Roll20\r\n    if (window.opener && !window.opener.closed) {\r\n      try {\r\n        window.opener.postMessage(messageData, '*');\r\n      } catch (error) {\r\n        debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n        browserAPI.runtime.sendMessage({\r\n          action: 'relayRollToRoll20',\r\n          roll: messageData\r\n        });\r\n      }\r\n    } else {\r\n      browserAPI.runtime.sendMessage({\r\n        action: 'relayRollToRoll20',\r\n        roll: messageData\r\n      });\r\n    }\r\n\r\n    saveCharacterData();\r\n    buildSheet(characterData);\r\n    modal.remove();\r\n  });\r\n\r\n  // 2024 Reroll button\r\n  if (characterData.lastRoll) {\r\n    document.getElementById('use-2024').addEventListener('click', () => {\r\n      characterData.inspiration = false;\r\n      const emoji = '\u2728';\r\n\r\n      debug.log(`${emoji} Inspiration spent (2024 - Reroll): ${characterData.lastRoll.name}`);\r\n      showNotification(`${emoji} Inspiration used! Rerolling ${characterData.lastRoll.name}...`);\r\n\r\n      // Announce to Roll20\r\n      const colorBanner = getColoredBanner();\r\n      const messageData = {\r\n        action: 'announceSpell',\r\n        message: `&{template:default} {{name=${colorBanner}${characterData.name} uses Inspiration (2024)}} {{${emoji}=Rerolling: ${characterData.lastRoll.name}}}`,\r\n        color: characterData.notificationColor\r\n      };\r\n\r\n      // Send to Roll20\r\n      if (window.opener && !window.opener.closed) {\r\n        try {\r\n          window.opener.postMessage(messageData, '*');\r\n        } catch (error) {\r\n          debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n          browserAPI.runtime.sendMessage({\r\n            action: 'relayRollToRoll20',\r\n            roll: messageData\r\n          });\r\n        }\r\n      } else {\r\n        browserAPI.runtime.sendMessage({\r\n          action: 'relayRollToRoll20',\r\n          roll: messageData\r\n        });\r\n      }\r\n\r\n      // Execute the reroll\r\n      const lastRoll = characterData.lastRoll;\r\n      executeRoll(lastRoll.name, lastRoll.formula, lastRoll.effectNotes || []);\r\n\r\n      saveCharacterData();\r\n      buildSheet(characterData);\r\n      modal.remove();\r\n    });\r\n  }\r\n\r\n  // Cancel button\r\n  document.getElementById('cancel-use-modal').addEventListener('click', () => {\r\n    modal.remove();\r\n  });\r\n\r\n  // Click outside to close\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      modal.remove();\r\n    }\r\n  });\r\n}\r\n\r\nfunction showDeathSavesModal() {\r\n  // Create modal overlay\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  // Create modal content\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); min-width: 300px;';\r\n\r\n  // Defensive initialization for death saves\r\n  const deathSaves = characterData.deathSaves || { successes: 0, failures: 0 };\r\n  const successes = deathSaves.successes || 0;\r\n  const failures = deathSaves.failures || 0;\r\n\r\n  modalContent.innerHTML = `\r\n    <h3 style=\"margin: 0 0 20px 0; color: #2c3e50; text-align: center;\">Death Saves</h3>\r\n    <div style=\"text-align: center; font-size: 1.2em; margin-bottom: 20px;\">\r\n      <div style=\"margin-bottom: 10px;\">\r\n        <span style=\"color: #27ae60; font-weight: bold;\">Successes: ${successes}/3</span>\r\n      </div>\r\n      <div>\r\n        <span style=\"color: #e74c3c; font-weight: bold;\">Failures: ${failures}/3</span>\r\n      </div>\r\n    </div>\r\n\r\n    <div style=\"margin-bottom: 20px;\">\r\n      <button id=\"roll-death-save\" style=\"width: 100%; padding: 15px; font-size: 1.1em; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 15px;\">\r\n        \uD83C\uDFB2 Roll Death Save\r\n      </button>\r\n    </div>\r\n\r\n    <div style=\"margin-bottom: 20px; border-top: 1px solid #ecf0f1; padding-top: 20px;\">\r\n      <label style=\"display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50;\">Manual Adjustment:</label>\r\n      <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;\">\r\n        <button id=\"add-success\" style=\"padding: 10px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n          + Success\r\n        </button>\r\n        <button id=\"add-failure\" style=\"padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n          + Failure\r\n        </button>\r\n      </div>\r\n      <button id=\"reset-death-saves\" style=\"width: 100%; padding: 10px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n        Reset All\r\n      </button>\r\n    </div>\r\n\r\n    <button id=\"close-modal\" style=\"width: 100%; padding: 12px; font-size: 1em; background: #7f8c8d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n      Close\r\n    </button>\r\n  `;\r\n\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  // Roll death save button\r\n  document.getElementById('roll-death-save').addEventListener('click', () => {\r\n    // Roll 1d20 locally to determine outcome\r\n    const rollResult = Math.floor(Math.random() * 20) + 1;\r\n    debug.log(`\uD83C\uDFB2 Death Save rolled: ${rollResult}`);\r\n\r\n    // Determine outcome based on D&D 5e rules\r\n    let message = '';\r\n    let isSuccess = false;\r\n\r\n    if (rollResult === 20) {\r\n      // Natural 20: regain 1 HP (represented as 2 successes in death saves)\r\n      if (!characterData.deathSaves) characterData.deathSaves = { successes: 0, failures: 0 };\r\n      if (characterData.deathSaves.successes < 3) {\r\n        characterData.deathSaves.successes += 2;\r\n        if (characterData.deathSaves.successes > 3) characterData.deathSaves.successes = 3;\r\n      }\r\n      message = `\uD83D\uDC9A NAT 20! Death Save Success x2 (${characterData.deathSaves.successes}/3)`;\r\n      isSuccess = true;\r\n    } else if (rollResult === 1) {\r\n      // Natural 1: counts as 2 failures\r\n      if (!characterData.deathSaves) characterData.deathSaves = { successes: 0, failures: 0 };\r\n      if (characterData.deathSaves.failures < 3) {\r\n        characterData.deathSaves.failures += 2;\r\n        if (characterData.deathSaves.failures > 3) characterData.deathSaves.failures = 3;\r\n      }\r\n      message = `\uD83D\uDC80 NAT 1! Death Save Failure x2 (${characterData.deathSaves.failures}/3)`;\r\n    } else if (rollResult >= 10) {\r\n      // Success\r\n      if (!characterData.deathSaves) characterData.deathSaves = { successes: 0, failures: 0 };\r\n      if (characterData.deathSaves.successes < 3) {\r\n        characterData.deathSaves.successes++;\r\n      }\r\n      message = `\u2713 Death Save Success (${characterData.deathSaves.successes}/3)`;\r\n      isSuccess = true;\r\n    } else {\r\n      // Failure\r\n      if (!characterData.deathSaves) characterData.deathSaves = { successes: 0, failures: 0 };\r\n      if (characterData.deathSaves.failures < 3) {\r\n        characterData.deathSaves.failures++;\r\n      }\r\n      message = `\u2717 Death Save Failure (${characterData.deathSaves.failures}/3)`;\r\n    }\r\n\r\n    // Save updated death saves\r\n    saveCharacterData();\r\n    showNotification(message);\r\n\r\n    // Send roll result to Roll20 (show result in name since we rolled locally)\r\n    roll(`Death Save: ${rollResult}`, '1d20', rollResult);\r\n\r\n    // Rebuild sheet to show updated death saves\r\n    buildSheet(characterData);\r\n    modal.remove();\r\n  });\r\n\r\n  // Add success button\r\n  document.getElementById('add-success').addEventListener('click', () => {\r\n    if (!characterData.deathSaves) characterData.deathSaves = { successes: 0, failures: 0 };\r\n    if (characterData.deathSaves.successes < 3) {\r\n      characterData.deathSaves.successes++;\r\n      saveCharacterData();\r\n      showNotification(`\u2713 Death Save Success (${characterData.deathSaves.successes}/3)`);\r\n      buildSheet(characterData);\r\n      modal.remove();\r\n    }\r\n  });\r\n\r\n  // Add failure button\r\n  document.getElementById('add-failure').addEventListener('click', () => {\r\n    if (!characterData.deathSaves) characterData.deathSaves = { successes: 0, failures: 0 };\r\n    if (characterData.deathSaves.failures < 3) {\r\n      characterData.deathSaves.failures++;\r\n      saveCharacterData();\r\n      showNotification(`\u2717 Death Save Failure (${characterData.deathSaves.failures}/3)`);\r\n      buildSheet(characterData);\r\n      modal.remove();\r\n    }\r\n  });\r\n\r\n  // Reset button\r\n  document.getElementById('reset-death-saves').addEventListener('click', () => {\r\n    characterData.deathSaves = { successes: 0, failures: 0 };\r\n    saveCharacterData();\r\n    showNotification('\u267B\uFE0F Death saves reset');\r\n    buildSheet(characterData);\r\n    modal.remove();\r\n  });\r\n\r\n  // Close button\r\n  document.getElementById('close-modal').addEventListener('click', () => {\r\n    modal.remove();\r\n  });\r\n\r\n  // Click outside to close\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      modal.remove();\r\n    }\r\n  });\r\n}\r\n\r\n// ===== CARD CREATION =====\r\n// Moved to modules/card-creator.js - using wrapper for compatibility\r\nfunction createCard(title, main, sub, onClick) {\r\n  return window.CardCreator.createCard(title, main, sub, onClick);\r\n}\r\n\r\nfunction createSpellCard(spell, index) {\r\n  const card = document.createElement('div');\r\n  card.className = 'spell-card';\r\n\r\n  const header = document.createElement('div');\r\n  header.className = 'spell-header';\r\n\r\n  // Build tags string\r\n  let tags = '';\r\n  if (spell.concentration) {\r\n    tags += '<span class=\"concentration-tag\">\uD83E\uDDE0 Concentration</span>';\r\n  }\r\n  if (spell.ritual) {\r\n    tags += '<span class=\"ritual-tag\">\uD83D\uDCD6 Ritual</span>';\r\n  }\r\n\r\n  // All spells get a single Cast button that opens a modal with options\r\n  const castButtonHTML = `<button class=\"cast-spell-modal-btn\" data-spell-index=\"${index}\" style=\"padding: 6px 12px; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;\">\u2728 Cast</button>`;\r\n\r\n  // Custom macro override button (for magic items and custom spells) - only shown if setting is enabled\r\n  const overrideButtonHTML = showCustomMacroButtons\r\n    ? `<button class=\"custom-macro-btn\" data-spell-index=\"${index}\" style=\"padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;\" title=\"Configure custom macros for this spell\">\u2699\uFE0F</button>`\r\n    : '';\r\n\r\n  header.innerHTML = `\r\n    <div>\r\n      <span style=\"font-weight: bold;\">${spell.name}</span>\r\n      ${spell.level ? `<span style=\"margin-left: 10px; color: #666;\">Level ${spell.level}</span>` : ''}\r\n      ${tags}\r\n    </div>\r\n    <div style=\"display: flex; gap: 8px;\">\r\n      ${castButtonHTML}\r\n      ${overrideButtonHTML}\r\n      <button class=\"toggle-btn\">\u25BC Details</button>\r\n    </div>\r\n  `;\r\n\r\n  const desc = document.createElement('div');\r\n  desc.className = 'spell-description';\r\n  desc.id = `spell-desc-${index}`;\r\n\r\n  // Debug spell data\r\n  if (spell.attackRoll || spell.damage) {\r\n    debug.log(`\uD83D\uDCDD Spell \"${spell.name}\" has attack/damage:`, { attackRoll: spell.attackRoll, damage: spell.damage, damageType: spell.damageType });\r\n  }\r\n\r\n  desc.innerHTML = `\r\n    ${spell.castingTime ? `<div><strong>Casting Time:</strong> ${spell.castingTime}</div>` : ''}\r\n    ${spell.range ? `<div><strong>Range:</strong> ${spell.range}</div>` : ''}\r\n    ${spell.components ? `<div><strong>Components:</strong> ${spell.components}</div>` : ''}\r\n    ${spell.duration ? `<div><strong>Duration:</strong> ${spell.duration}</div>` : ''}\r\n    ${spell.school ? `<div><strong>School:</strong> ${spell.school}</div>` : ''}\r\n    ${spell.source ? `<div><strong>Source:</strong> ${spell.source}</div>` : ''}\r\n    ${spell.description ? `<div style=\"margin-top: 10px;\">${spell.description}</div>` : ''}\r\n    ${spell.formula ? `<button class=\"roll-btn\">\uD83C\uDFB2 Roll ${spell.formula}</button>` : ''}\r\n  `;\r\n\r\n  // Toggle functionality\r\n  const toggleBtn = header.querySelector('.toggle-btn');\r\n  header.addEventListener('click', (e) => {\r\n    if (!e.target.classList.contains('roll-btn') && !e.target.classList.contains('cast-spell-modal-btn')) {\r\n      desc.classList.toggle('expanded');\r\n      toggleBtn.textContent = desc.classList.contains('expanded') ? '\u25B2 Hide' : '\u25BC Details';\r\n    }\r\n  });\r\n\r\n  // Roll button\r\n  const rollBtn = desc.querySelector('.roll-btn');\r\n  if (rollBtn && spell.formula) {\r\n    rollBtn.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      roll(spell.name, spell.formula);\r\n    });\r\n  }\r\n\r\n  // Cast spell modal button\r\n  const castModalBtn = header.querySelector('.cast-spell-modal-btn');\r\n  if (castModalBtn) {\r\n    castModalBtn.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      \r\n      // Check for Divine Smite special handling\r\n      if (spell.name.toLowerCase().includes('divine smite')) {\r\n        debug.log(`\u26A1 Divine Smite cast button clicked: ${spell.name}, showing custom modal`);\r\n        announceSpellDescription(spell);\r\n        showDivineSmiteModal(spell);\r\n        return;\r\n      }\r\n      \r\n      // Check for Lay on Hands: Heal special handling\r\n      const normalizedSpellName = spell.name.toLowerCase()\r\n        .replace(/[^a-z0-9\\s:]/g, '') // Remove special chars except colon and space\r\n        .replace(/\\s+/g, ' ') // Normalize spaces\r\n        .trim();\r\n      const normalizedSearch = 'lay on hands: heal';\r\n      \r\n      if (normalizedSpellName === normalizedSearch) {\r\n        debug.log(`\uD83D\uDC9A Lay on Hands: Heal cast button clicked: ${spell.name}, showing custom modal`);\r\n        debug.log(`\uD83D\uDC9A Normalized match: \"${normalizedSpellName}\" === \"${normalizedSearch}\"`);\r\n        announceSpellDescription(spell);\r\n        const layOnHandsPool = getLayOnHandsResource();\r\n        if (layOnHandsPool) {\r\n          showLayOnHandsModal(layOnHandsPool);\r\n        } else {\r\n          showNotification('\u274C No Lay on Hands pool resource found', 'error');\r\n        }\r\n        return;\r\n      }\r\n      \r\n      // Fallback: Catch ANY Lay on Hands action for debugging\r\n      if (spell.name.toLowerCase().includes('lay on hands')) {\r\n        debug.log(`\uD83D\uDEA8 FALLBACK: Caught Lay on Hands spell: \"${spell.name}\"`);\r\n        debug.log(`\uD83D\uDEA8 This spell didn't match 'lay on hands: heal' but contains 'lay on hands'`);\r\n        debug.log(`\uD83D\uDEA8 Showing modal anyway for debugging`);\r\n        announceSpellDescription(spell);\r\n        const layOnHandsPool = getLayOnHandsResource();\r\n        if (layOnHandsPool) {\r\n          showLayOnHandsModal(layOnHandsPool);\r\n        } else {\r\n          showNotification('\u274C No Lay on Hands pool resource found', 'error');\r\n        }\r\n        return;\r\n      }\r\n      \r\n      const spellOptionsResult = getSpellOptions(spell);\r\n      const options = spellOptionsResult.options;\r\n\r\n      // Check if this is a \"too complicated\" spell that should only announce\r\n      if (spellOptionsResult.skipNormalButtons) {\r\n        announceSpellDescription(spell);\r\n        castSpell(spell, index, null, null, [], false, true); // skipAnnouncement = true\r\n        return;\r\n      }\r\n\r\n      if (options.length === 0) {\r\n        // No rolls - announce description and cast immediately\r\n        announceSpellDescription(spell);\r\n        castSpell(spell, index, null, null, [], false, true); // skipAnnouncement = true\r\n      } else {\r\n        // Has rolls - show modal with options\r\n        // Check if concentration recast option will exist in modal\r\n        const hasConcentrationRecast = spell.concentration && concentratingSpell === spell.name;\r\n\r\n        if (!hasConcentrationRecast) {\r\n          // No concentration recast option - announce description immediately\r\n          announceSpellDescription(spell);\r\n          showSpellModal(spell, index, options, true); // descriptionAnnounced = true\r\n        } else {\r\n          // Has concentration recast - announce from modal button handlers\r\n          showSpellModal(spell, index, options, false); // descriptionAnnounced = false\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  // Custom macro override button\r\n  const customMacroBtn = header.querySelector('.custom-macro-btn');\r\n  if (customMacroBtn) {\r\n    customMacroBtn.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      showCustomMacroModal(spell, index);\r\n    });\r\n  }\r\n\r\n  card.appendChild(header);\r\n  card.appendChild(desc);\r\n  return card;\r\n}\r\n\r\n/**\r\n * Validate spell data and log any issues\r\n * Cross-checks parsed data against spell description\r\n */\r\nfunction validateSpellData(spell) {\r\n  const issues = [];\r\n  const warnings = [];\r\n\r\n  // Check if spell has children data\r\n  if (!spell.damageRolls && !spell.attackRoll) {\r\n    console.log(`\u2139\uFE0F Spell \"${spell.name}\" has no attack or damage data (utility spell)`);\r\n    return { valid: true, issues: [], warnings: [] };\r\n  }\r\n\r\n  // Validate attack roll\r\n  if (spell.attackRoll && spell.attackRoll !== '(none)') {\r\n    if (typeof spell.attackRoll !== 'string' || spell.attackRoll.trim() === '') {\r\n      issues.push(`Attack roll is invalid: ${spell.attackRoll}`);\r\n    }\r\n  }\r\n\r\n  // Validate damage rolls\r\n  if (spell.damageRolls && Array.isArray(spell.damageRolls)) {\r\n    spell.damageRolls.forEach((roll, index) => {\r\n      if (!roll.damage) {\r\n        issues.push(`Damage roll ${index} missing formula`);\r\n      } else if (typeof roll.damage !== 'string' || roll.damage.trim() === '') {\r\n        issues.push(`Damage roll ${index} has invalid formula: ${roll.damage}`);\r\n      }\r\n\r\n      if (!roll.damageType) {\r\n        warnings.push(`Damage roll ${index} missing damage type (will show as \"untyped\")`);\r\n      }\r\n\r\n      // Check for dice notation\r\n      const hasDice = /d\\d+/i.test(roll.damage);\r\n      if (!hasDice) {\r\n        warnings.push(`Damage roll \"${roll.damage}\" doesn't contain dice notation - might be a variable reference`);\r\n      }\r\n    });\r\n  }\r\n\r\n  // Cross-check against description\r\n  const description = (spell.description || '').toLowerCase();\r\n  const summary = (spell.summary || '').toLowerCase();\r\n  const fullText = `${summary} ${description}`;\r\n\r\n  if (fullText) {\r\n    // Check for attack mention (use word boundaries to avoid false positives like Shield's \"triggering attack\")\r\n    const hasAttackMention = /\\b(spell attack|attack roll)\\b/i.test(fullText);\r\n    const hasAttackData = spell.attackRoll && spell.attackRoll !== '(none)';\r\n\r\n    if (hasAttackMention && !hasAttackData) {\r\n      warnings.push(`Description mentions attack but no attack roll found`);\r\n    } else if (!hasAttackMention && hasAttackData) {\r\n      warnings.push(`Has attack roll but description doesn't mention attack`);\r\n    }\r\n\r\n    // Check for damage mention\r\n    const damageMentions = fullText.match(/(\\d+d\\d+)/g);\r\n    const hasDamageMention = damageMentions && damageMentions.length > 0;\r\n    const hasDamageData = spell.damageRolls && spell.damageRolls.length > 0;\r\n\r\n    if (hasDamageMention && !hasDamageData) {\r\n      warnings.push(`Description mentions ${damageMentions.join(', ')} but no damage rolls found`);\r\n    } else if (hasDamageData && !hasDamageMention) {\r\n      // This is fine - description might use variables like \"spell level\" instead of exact dice\r\n      console.log(`\u2139\uFE0F \"${spell.name}\" has ${spell.damageRolls.length} damage rolls but description doesn't show explicit dice`);\r\n    }\r\n  }\r\n\r\n  if (issues.length > 0) {\r\n    console.warn(`\u274C Validation issues for spell \"${spell.name}\":`, issues);\r\n  }\r\n\r\n  if (warnings.length > 0) {\r\n    console.warn(`\u26A0\uFE0F Validation warnings for spell \"${spell.name}\":`, warnings);\r\n  }\r\n\r\n  if (issues.length === 0 && warnings.length === 0) {\r\n    console.log(`\u2705 Spell \"${spell.name}\" validated successfully`);\r\n  }\r\n\r\n  return { valid: issues.length === 0, issues, warnings };\r\n}\r\n\r\n/**\r\n * Get available spell options (attack/damage rolls)\r\n */\r\nfunction getSpellOptions(spell) {\r\n  // Validate spell data first\r\n  const validation = validateSpellData(spell);\r\n\r\n  // Detailed debug logging to trace damage data\r\n  console.log(`\uD83D\uDD2E getSpellOptions for \"${spell.name}\":`, {\r\n    attackRoll: spell.attackRoll,\r\n    damageRolls: spell.damageRolls,\r\n    damageRollsLength: spell.damageRolls ? spell.damageRolls.length : 'undefined',\r\n    damageRollsContent: JSON.stringify(spell.damageRolls),\r\n    concentration: spell.concentration\r\n  });\r\n\r\n  const options = [];\r\n\r\n  // Check for attack (exclude Shield spell which should never have attack button)\r\n  const isShield = spell.name && spell.name.toLowerCase() === 'shield';\r\n  if (spell.attackRoll && spell.attackRoll !== '(none)' && !isShield) {\r\n    // Handle special flag from dicecloud.js that indicates we should use spell attack bonus\r\n    let attackFormula = spell.attackRoll;\r\n    if (attackFormula === 'use_spell_attack_bonus') {\r\n      const attackBonus = getSpellAttackBonus();\r\n      attackFormula = attackBonus >= 0 ? `1d20+${attackBonus}` : `1d20${attackBonus}`;\r\n    }\r\n\r\n    options.push({\r\n      type: 'attack',\r\n      label: '\u2694\uFE0F Spell Attack',\r\n      formula: attackFormula,\r\n      icon: '\u2694\uFE0F',\r\n      color: '#e74c3c'\r\n    });\r\n  }\r\n\r\n  // Check for damage/healing rolls\r\n  if (spell.damageRolls && spell.damageRolls.length > 0) {\r\n    // Handle lifesteal spells specially (damage + healing based on damage dealt)\r\n    if (spell.isLifesteal) {\r\n      const damageRoll = spell.damageRolls.find(r => r.damageType && r.damageType.toLowerCase() !== 'healing');\r\n      const healingRoll = spell.damageRolls.find(r => r.damageType && r.damageType.toLowerCase() === 'healing');\r\n\r\n      if (damageRoll && healingRoll) {\r\n        // Resolve formula for display\r\n        let displayFormula = damageRoll.damage;\r\n        if (displayFormula.includes('~target.level') && characterData.level) {\r\n          displayFormula = displayFormula.replace(/~target\\.level/g, characterData.level);\r\n        }\r\n        displayFormula = resolveVariablesInFormula(displayFormula);\r\n        displayFormula = evaluateMathInFormula(displayFormula);\r\n\r\n        // Format damage type\r\n        let damageTypeLabel = '';\r\n        if (damageRoll.damageType && damageRoll.damageType !== 'untyped') {\r\n          damageTypeLabel = damageRoll.damageType.charAt(0).toUpperCase() + damageRoll.damageType.slice(1);\r\n        }\r\n\r\n        // Check healing formula to determine healing ratio\r\n        const healingFormula = healingRoll.damage.toLowerCase();\r\n        let healingRatio = 'full';\r\n        if (healingFormula.includes('/ 2') || healingFormula.includes('*0.5') || healingFormula.includes('half')) {\r\n          healingRatio = 'half';\r\n        }\r\n\r\n        options.push({\r\n          type: 'lifesteal',\r\n          label: `${displayFormula} ${damageTypeLabel} + Heal (${healingRatio})`,\r\n          damageFormula: damageRoll.damage,\r\n          healingFormula: healingRoll.damage,\r\n          damageType: damageRoll.damageType,\r\n          healingRatio: healingRatio,\r\n          icon: '\uD83D\uDC89',\r\n          color: 'linear-gradient(135deg, #c0392b 0%, #27ae60 100%)'\r\n        });\r\n      }\r\n    } else {\r\n      // Normal spells - show separate buttons for each damage/healing type\r\n      spell.damageRolls.forEach((roll, index) => {\r\n        // Skip rolls that are part of an OR group (they'll be represented by the main roll)\r\n        if (roll.isOrGroupMember) {\r\n          return;\r\n        }\r\n\r\n        const isHealing = roll.damageType && roll.damageType.toLowerCase() === 'healing';\r\n        const isTempHP = roll.damageType && (\r\n          roll.damageType.toLowerCase() === 'temphp' ||\r\n          roll.damageType.toLowerCase() === 'temporary' ||\r\n          roll.damageType.toLowerCase().includes('temp')\r\n        );\r\n\r\n        // Resolve non-slot-dependent variables for display (character level, ability mods, etc.)\r\n        // Keep slotLevel as-is since we don't know what slot will be used yet\r\n        let displayFormula = roll.damage;\r\n\r\n        // Replace ~target.level with character level (for cantrips like Toll the Dead)\r\n        if (displayFormula.includes('~target.level') && characterData.level) {\r\n          displayFormula = displayFormula.replace(/~target\\.level/g, characterData.level);\r\n        }\r\n\r\n        displayFormula = resolveVariablesInFormula(displayFormula);\r\n        displayFormula = evaluateMathInFormula(displayFormula);\r\n\r\n        // If this roll has OR choices, create separate buttons for each choice\r\n        if (roll.orChoices && roll.orChoices.length > 1) {\r\n          roll.orChoices.forEach(choice => {\r\n            // Format damage type nicely\r\n            let damageTypeLabel = '';\r\n            if (choice.damageType && choice.damageType !== 'untyped') {\r\n              damageTypeLabel = choice.damageType.charAt(0).toUpperCase() + choice.damageType.slice(1);\r\n            }\r\n\r\n            const label = damageTypeLabel ? `${displayFormula} ${damageTypeLabel}` : displayFormula;\r\n\r\n            const choiceIsTempHP = choice.damageType === 'temphp' || choice.damageType === 'temporary' ||\r\n                                    (choice.damageType && choice.damageType.toLowerCase().includes('temp'));\r\n\r\n            options.push({\r\n              type: choiceIsTempHP ? 'temphp' : (isHealing ? 'healing' : 'damage'),\r\n              label: label,\r\n              formula: roll.damage,\r\n              damageType: choice.damageType,\r\n              index: index,\r\n              icon: choiceIsTempHP ? '\uD83D\uDEE1\uFE0F' : (isHealing ? '\uD83D\uDC9A' : '\uD83D\uDCA5'),\r\n              color: choiceIsTempHP ? '#3498db' : (isHealing ? '#27ae60' : '#e67e22')\r\n            });\r\n          });\r\n        } else {\r\n          // Single damage type - create one button\r\n          // Format damage type nicely\r\n          let damageTypeLabel = '';\r\n          if (roll.damageType && roll.damageType !== 'untyped') {\r\n            // Capitalize first letter\r\n            damageTypeLabel = roll.damageType.charAt(0).toUpperCase() + roll.damageType.slice(1);\r\n          }\r\n\r\n          // Build label: formula + damage type\r\n          const label = damageTypeLabel ? `${displayFormula} ${damageTypeLabel}` : displayFormula;\r\n\r\n          options.push({\r\n            type: isTempHP ? 'temphp' : (isHealing ? 'healing' : 'damage'),\r\n            label: label,\r\n            formula: roll.damage, // Keep original formula for actual rolling\r\n            damageType: roll.damageType,\r\n            index: index,\r\n            icon: isTempHP ? '\uD83D\uDEE1\uFE0F' : (isHealing ? '\uD83D\uDC9A' : '\uD83D\uDCA5'),\r\n            color: isTempHP ? '#3498db' : (isHealing ? '#27ae60' : '#e67e22')\r\n          });\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  // Log options before edge case modifications\r\n  console.log(`\uD83D\uDCCB getSpellOptions \"${spell.name}\" - options before edge cases:`, options.map(o => `${o.type}: ${o.label}`));\r\n\r\n  // Apply edge case modifications\r\n  const result = applyEdgeCaseModifications(spell, options);\r\n  console.log(`\uD83D\uDCCB getSpellOptions \"${spell.name}\" - final options:`, result.options?.map(o => `${o.type}: ${o.label}`), 'skipNormalButtons:', result.skipNormalButtons);\r\n  return result;\r\n}\r\n\r\n/**\r\n * Show spell casting modal with options\r\n * @param {boolean} descriptionAnnounced - Whether spell description was already announced\r\n */\r\nfunction showSpellModal(spell, spellIndex, options, descriptionAnnounced = false) {\r\n  // Get theme-aware colors\r\n  const colors = getPopupThemeColors();\r\n\r\n  // Check for custom macros\r\n  const customMacros = getCustomMacros(spell.name);\r\n  const hasCustomMacros = customMacros && customMacros.buttons && customMacros.buttons.length > 0;\r\n\r\n  // Create modal overlay\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'spell-modal-overlay';\r\n  overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  // Create modal content\r\n  const modal = document.createElement('div');\r\n  modal.className = 'spell-modal';\r\n  modal.style.cssText = `background: ${colors.background}; padding: 24px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);`;\r\n\r\n  // Modal header\r\n  const header = document.createElement('div');\r\n  header.style.cssText = `margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid ${colors.border};`;\r\n\r\n  // Format spell level text\r\n  let levelText = '';\r\n  if (spell.level === 0) {\r\n    levelText = `<div style=\"color: ${colors.infoText}; font-size: 14px;\">Cantrip</div>`;\r\n  } else if (spell.level) {\r\n    levelText = `<div style=\"color: ${colors.infoText}; font-size: 14px;\">Level ${spell.level} Spell</div>`;\r\n  }\r\n\r\n  header.innerHTML = `\r\n    <h2 style=\"margin: 0 0 8px 0; color: ${colors.heading};\">Cast ${spell.name}</h2>\r\n    ${levelText}\r\n  `;\r\n\r\n  modal.appendChild(header);\r\n\r\n  // Slot selection (for leveled spells)\r\n  let slotSelect = null;\r\n  if (spell.level && spell.level > 0) {\r\n    const slotSection = document.createElement('div');\r\n    slotSection.style.cssText = `margin-bottom: 16px; padding: 12px; background: ${colors.infoBox}; border-radius: 6px;`;\r\n\r\n    const slotLabel = document.createElement('label');\r\n    slotLabel.style.cssText = `display: block; margin-bottom: 8px; font-weight: bold; color: ${colors.text};`;\r\n    slotLabel.textContent = 'Cast at level:';\r\n\r\n    slotSelect = document.createElement('select');\r\n    slotSelect.style.cssText = `width: 100%; padding: 8px; border: 2px solid ${colors.border}; border-radius: 4px; font-size: 14px; background: ${colors.background}; color: ${colors.text};`;\r\n\r\n    // Check for Pact Magic slots (Warlock) - these are SEPARATE from regular spell slots\r\n    // Check both spellSlots and otherVariables since data may come from either source\r\n    // DiceCloud uses various variable names: pactSlot, pactMagicSlots, pactSlotLevelVisible, etc.\r\n    const pactMagicSlotLevel = characterData.spellSlots?.pactMagicSlotLevel ||\r\n                               characterData.otherVariables?.pactMagicSlotLevel ||\r\n                               characterData.otherVariables?.pactSlotLevelVisible ||\r\n                               characterData.otherVariables?.pactSlotLevel ||\r\n                               characterData.otherVariables?.slotLevel;\r\n    const pactMagicSlots = characterData.spellSlots?.pactMagicSlots ??\r\n                           characterData.otherVariables?.pactMagicSlots ??\r\n                           characterData.otherVariables?.pactSlot ?? 0;\r\n    const pactMagicSlotsMax = characterData.spellSlots?.pactMagicSlotsMax ??\r\n                              characterData.otherVariables?.pactMagicSlotsMax ??\r\n                              characterData.otherVariables?.pactSlotMax ?? 0;\r\n    const hasPactMagic = pactMagicSlotsMax > 0;\r\n    // Default slot level to 1 if we have slots but couldn't detect level\r\n    const effectivePactLevel = pactMagicSlotLevel || (hasPactMagic ? 5 : 0); // Default to max (5) if level unknown\r\n\r\n    debug.log(`\uD83D\uDD2E Pact Magic check: level=${pactMagicSlotLevel} (effective=${effectivePactLevel}), slots=${pactMagicSlots}/${pactMagicSlotsMax}, hasPact=${hasPactMagic}`);\r\n\r\n    // Add options for available spell slots (spell level and higher)\r\n    let hasAnySlots = false;\r\n    let firstValidOption = null;\r\n\r\n    // First, add Pact Magic slots if available and spell level is compatible\r\n    // Pact Magic slots can cast any spell from level 1 up to the pact slot level\r\n    if (hasPactMagic && spell.level <= effectivePactLevel) {\r\n      hasAnySlots = true;\r\n      const option = document.createElement('option');\r\n      option.value = `pact:${effectivePactLevel}`; // Special format to identify pact slots\r\n      option.textContent = `Level ${effectivePactLevel} - Pact Magic (${pactMagicSlots}/${pactMagicSlotsMax})`;\r\n      option.disabled = pactMagicSlots === 0;\r\n      slotSelect.appendChild(option);\r\n      if (!option.disabled && !firstValidOption) {\r\n        firstValidOption = option;\r\n      }\r\n      debug.log(`\uD83D\uDD2E Added Pact Magic slot option: Level ${effectivePactLevel} (${pactMagicSlots}/${pactMagicSlotsMax})`);\r\n    }\r\n\r\n    // Then add regular spell slots (excluding the pact magic level to avoid duplicates)\r\n    for (let level = spell.level; level <= 9; level++) {\r\n      const slotsProp = `level${level}SpellSlots`;\r\n      const maxSlotsProp = `level${level}SpellSlotsMax`;\r\n      let available = characterData.spellSlots?.[slotsProp] || characterData[slotsProp] || 0;\r\n      let max = characterData.spellSlots?.[maxSlotsProp] || characterData[maxSlotsProp] || 0;\r\n\r\n      // If this level has Pact Magic, subtract pact slots from the total (they're counted separately)\r\n      if (hasPactMagic && level === effectivePactLevel) {\r\n        available = Math.max(0, available - pactMagicSlots);\r\n        max = Math.max(0, max - pactMagicSlotsMax);\r\n      }\r\n\r\n      if (max > 0) {\r\n        hasAnySlots = true;\r\n        const option = document.createElement('option');\r\n        option.value = level; // Regular level number for normal slots\r\n        option.textContent = `Level ${level} (${available}/${max} slots)`;\r\n        option.disabled = available === 0;\r\n        slotSelect.appendChild(option);\r\n        if (!option.disabled && !firstValidOption) {\r\n          firstValidOption = option;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Select the first valid (non-disabled) option\r\n    if (firstValidOption) {\r\n      firstValidOption.selected = true;\r\n    }\r\n\r\n    // If no slots available at all, show a message\r\n    if (!hasAnySlots) {\r\n      const noSlotsOption = document.createElement('option');\r\n      noSlotsOption.value = spell.level;\r\n      noSlotsOption.textContent = 'No spell slots available';\r\n      noSlotsOption.disabled = true;\r\n      noSlotsOption.selected = true;\r\n      slotSelect.appendChild(noSlotsOption);\r\n    }\r\n\r\n    slotSection.appendChild(slotLabel);\r\n    slotSection.appendChild(slotSelect);\r\n    modal.appendChild(slotSection);\r\n\r\n    // Store reference to update button labels later\r\n    // (will be set after buttons are created)\r\n    slotSelect.updateButtonLabels = null;\r\n  }\r\n\r\n  // Concentration spell recast option OR special spells that allow reuse without slots\r\n  // (if already concentrating on this spell, or for spells like Spiritual Weapon, Meld into Stone)\r\n  // NOTE: Cantrips (level 0) never use slots, so don't show this checkbox for them\r\n  let skipSlotCheckbox = null;\r\n  const isCantrip = spell.level === 0;\r\n  const isConcentrationRecast = spell.concentration && concentratingSpell === spell.name;\r\n\r\n  // Spells that allow repeated use without consuming slots (non-concentration)\r\n  // Exclude cantrips since they never use slots anyway\r\n  const isReuseableSpellType = !isCantrip && isReuseableSpell(spell.name, characterData);\r\n\r\n  // Check if this spell was already cast (stored in localStorage or session)\r\n  const castSpellsKey = `castSpells_${characterData.name}`;\r\n  const castSpells = JSON.parse(localStorage.getItem(castSpellsKey) || '[]');\r\n  const wasAlreadyCast = castSpells.includes(spell.name);\r\n\r\n  // Show checkbox for concentration recasts OR for all reuseable spells (even on first cast)\r\n  // But NOT for cantrips since they never consume slots\r\n  if (!isCantrip && (isConcentrationRecast || isReuseableSpellType)) {\r\n    const recastSection = document.createElement('div');\r\n    recastSection.style.cssText = 'margin-bottom: 16px; padding: 12px; background: #fff3cd; border-radius: 6px; border: 2px solid #f39c12;';\r\n\r\n    const checkboxContainer = document.createElement('label');\r\n    checkboxContainer.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer;';\r\n\r\n    skipSlotCheckbox = document.createElement('input');\r\n    skipSlotCheckbox.type = 'checkbox';\r\n    // Default checked if concentration recast OR if reuseable spell was already cast\r\n    skipSlotCheckbox.checked = isConcentrationRecast || wasAlreadyCast;\r\n    skipSlotCheckbox.style.cssText = 'width: 20px; height: 20px;';\r\n\r\n    const checkboxLabel = document.createElement('span');\r\n    checkboxLabel.style.cssText = 'font-weight: bold; color: #856404;';\r\n    if (isConcentrationRecast) {\r\n      checkboxLabel.textContent = '\uD83E\uDDE0 Already concentrating - don\\'t consume spell slot';\r\n    } else if (wasAlreadyCast) {\r\n      checkboxLabel.textContent = '\u2694\uFE0F Spell already active - don\\'t consume spell slot';\r\n    } else {\r\n      checkboxLabel.textContent = '\u2694\uFE0F Reuse spell effect without consuming slot (first cast required)';\r\n    }\r\n\r\n    checkboxContainer.appendChild(skipSlotCheckbox);\r\n    checkboxContainer.appendChild(checkboxLabel);\r\n    recastSection.appendChild(checkboxContainer);\r\n\r\n    const helpText = document.createElement('div');\r\n    helpText.style.cssText = 'font-size: 0.85em; color: #856404; margin-top: 6px; margin-left: 28px;';\r\n    if (isConcentrationRecast) {\r\n      helpText.textContent = 'You can use this spell\\'s effect again while concentrating on it without recasting.';\r\n    } else {\r\n      helpText.textContent = 'You can use this spell\\'s effect again while it\\'s active without recasting.';\r\n    }\r\n    recastSection.appendChild(helpText);\r\n\r\n    modal.appendChild(recastSection);\r\n\r\n    // If skip slot is checked, disable slot selection\r\n    skipSlotCheckbox.addEventListener('change', () => {\r\n      if (slotSelect) {\r\n        slotSelect.disabled = skipSlotCheckbox.checked;\r\n        slotSelect.style.opacity = skipSlotCheckbox.checked ? '0.5' : '1';\r\n      }\r\n    });\r\n\r\n    // Initialize disabled state\r\n    if (slotSelect && skipSlotCheckbox.checked) {\r\n      slotSelect.disabled = true;\r\n      slotSelect.style.opacity = '0.5';\r\n    }\r\n  }\r\n\r\n  // Metamagic options (if character has metamagic features)\r\n  // Only the 8 official Sorcerer metamagic options from PHB\r\n  const metamagicCheckboxes = [];\r\n  const validMetamagicNames = [\r\n    'Careful Spell',\r\n    'Distant Spell',\r\n    'Empowered Spell',\r\n    'Extended Spell',\r\n    'Heightened Spell',\r\n    'Quickened Spell',\r\n    'Subtle Spell',\r\n    'Twinned Spell'\r\n  ];\r\n  const metamagicFeatures = characterData.features ? characterData.features.filter(f =>\r\n    f.name && validMetamagicNames.includes(f.name)\r\n  ) : [];\r\n\r\n  if (metamagicFeatures.length > 0) {\r\n    const metamagicSection = document.createElement('div');\r\n    metamagicSection.style.cssText = `margin-bottom: 16px; padding: 12px; background: ${colors.infoBox}; border-radius: 6px; border: 1px solid ${colors.border};`;\r\n\r\n    const metamagicTitle = document.createElement('div');\r\n    metamagicTitle.style.cssText = `font-weight: bold; margin-bottom: 8px; color: ${colors.text};`;\r\n    metamagicTitle.textContent = 'Metamagic:';\r\n    metamagicSection.appendChild(metamagicTitle);\r\n\r\n    metamagicFeatures.forEach(feature => {\r\n      const checkboxContainer = document.createElement('label');\r\n      checkboxContainer.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 4px; cursor: pointer;';\r\n\r\n      const checkbox = document.createElement('input');\r\n      checkbox.type = 'checkbox';\r\n      checkbox.value = feature.name;\r\n      checkbox.style.cssText = 'width: 18px; height: 18px;';\r\n\r\n      const label = document.createElement('span');\r\n      label.textContent = feature.name;\r\n      label.style.cssText = `font-size: 14px; color: ${colors.infoText};`;\r\n\r\n      checkboxContainer.appendChild(checkbox);\r\n      checkboxContainer.appendChild(label);\r\n      metamagicSection.appendChild(checkboxContainer);\r\n\r\n      metamagicCheckboxes.push(checkbox);\r\n    });\r\n\r\n    modal.appendChild(metamagicSection);\r\n  }\r\n\r\n  // Track whether spell has been cast (for attack spells)\r\n  let spellCast = false;\r\n  let usedSlot = null;\r\n\r\n  // Check if spell has both attack and damage options\r\n  const hasAttack = options.some(opt => opt.type === 'attack');\r\n  const hasDamage = options.some(opt => opt.type === 'damage' || opt.type === 'healing');\r\n\r\n  // Options container (spell action buttons)\r\n  const optionsContainer = document.createElement('div');\r\n  optionsContainer.style.cssText = 'display: flex; flex-direction: column; gap: 12px;';\r\n\r\n  // Helper function to get resolved label for an option based on slot level\r\n  function getResolvedLabel(option, selectedSlotLevel) {\r\n    if (option.type === 'attack') {\r\n      return option.label; // Attack doesn't change with slot level\r\n    }\r\n\r\n    // Get the formula for this option\r\n    let formula = option.type === 'lifesteal' ? option.damageFormula : option.formula;\r\n    debug.log(`\uD83C\uDFF7\uFE0F getResolvedLabel called with formula: \"${formula}\", slotLevel: ${selectedSlotLevel}`);\r\n\r\n    // Replace slotLevel with actual slot level (check for null/undefined, but allow 0)\r\n    // Use case-insensitive regex to handle slotLevel, slotlevel, SlotLevel, etc.\r\n    if (selectedSlotLevel != null && formula && /slotlevel/i.test(formula)) {\r\n      const originalFormula = formula;\r\n      formula = formula.replace(/slotlevel/gi, String(selectedSlotLevel));\r\n      debug.log(`  \u2705 Replaced slotLevel: \"${originalFormula}\" -> \"${formula}\"`);\r\n    }\r\n\r\n    // Replace ~target.level with character level\r\n    if (formula && formula.includes('~target.level') && characterData.level) {\r\n      formula = formula.replace(/~target\\.level/g, characterData.level);\r\n    }\r\n\r\n    // Resolve variables and evaluate math\r\n    formula = resolveVariablesInFormula(formula);\r\n    formula = evaluateMathInFormula(formula);\r\n    debug.log(`  \uD83D\uDCCA Final resolved formula: \"${formula}\"`);\r\n\r\n    // Build label based on option type\r\n    if (option.type === 'lifesteal') {\r\n      let damageTypeLabel = '';\r\n      if (option.damageType && option.damageType !== 'untyped') {\r\n        damageTypeLabel = option.damageType.charAt(0).toUpperCase() + option.damageType.slice(1);\r\n      }\r\n      return `${formula} ${damageTypeLabel} + Heal (${option.healingRatio})`;\r\n    } else if (option.type === 'damage' || option.type === 'healing' || option.type === 'temphp') {\r\n      let damageTypeLabel = '';\r\n      if (option.damageType && option.damageType !== 'untyped') {\r\n        damageTypeLabel = option.damageType.charAt(0).toUpperCase() + option.damageType.slice(1);\r\n      }\r\n      return damageTypeLabel ? `${formula} ${damageTypeLabel}` : formula;\r\n    }\r\n\r\n    return option.label;\r\n  }\r\n\r\n  // Add buttons for each option\r\n  const optionButtons = []; // Store buttons so we can update them when slot changes\r\n\r\n  // Add custom macro buttons if configured\r\n  if (hasCustomMacros) {\r\n    customMacros.buttons.forEach((customBtn, index) => {\r\n      const btn = document.createElement('button');\r\n      btn.className = 'spell-custom-macro-btn';\r\n      btn.style.cssText = `\r\n        padding: 12px 16px;\r\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n        color: white;\r\n        border: 2px solid rgba(255,255,255,0.3);\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 16px;\r\n        text-align: left;\r\n        transition: opacity 0.2s, transform 0.2s;\r\n        box-shadow: 0 4px 8px rgba(0,0,0,0.3);\r\n      `;\r\n      btn.innerHTML = customBtn.label;\r\n\r\n      btn.addEventListener('mouseenter', () => {\r\n        btn.style.opacity = '0.9';\r\n        btn.style.transform = 'translateY(-2px)';\r\n      });\r\n      btn.addEventListener('mouseleave', () => {\r\n        btn.style.opacity = '1';\r\n        btn.style.transform = 'translateY(0)';\r\n      });\r\n\r\n      btn.addEventListener('click', () => {\r\n        // Send custom macro to chat\r\n        const colorBanner = getColoredBanner();\r\n        const message = customBtn.macro;\r\n\r\n        const messageData = {\r\n          action: 'announceSpell',\r\n          message: message,\r\n          color: characterData.notificationColor\r\n        };\r\n\r\n        if (window.opener && !window.opener.closed) {\r\n          try {\r\n            window.opener.postMessage(messageData, '*');\r\n            debug.log('\u2705 Custom macro sent via window.opener');\r\n          } catch (error) {\r\n            debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n          }\r\n        } else {\r\n          browserAPI.runtime.sendMessage({\r\n            action: 'relayRollToRoll20',\r\n            roll: messageData\r\n          });\r\n        }\r\n\r\n        showNotification(`\u2728 ${spell.name} - Custom Macro Sent!`, 'success');\r\n        document.body.removeChild(overlay);\r\n      });\r\n\r\n      optionsContainer.appendChild(btn);\r\n    });\r\n\r\n    // If skipNormalButtons is true, don't add normal spell option buttons\r\n    if (customMacros.skipNormalButtons) {\r\n      debug.log(`\u2699\uFE0F Skipping normal spell buttons for \"${spell.name}\" (custom macros only)`);\r\n      // Skip the normal options.forEach below\r\n      options = [];\r\n    }\r\n  }\r\n\r\n  options.forEach(option => {\r\n    const btn = document.createElement('button');\r\n    btn.className = `spell-option-btn-${option.type}`;\r\n\r\n    // Special styling for lifesteal buttons to make them more visually distinct\r\n    const isLifesteal = option.type === 'lifesteal';\r\n    const boxShadow = isLifesteal ? 'box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 -2px 4px rgba(0,0,0,0.2);' : '';\r\n    const border = isLifesteal ? 'border: 2px solid rgba(255,255,255,0.3);' : 'border: none;';\r\n\r\n    btn.style.cssText = `\r\n      padding: 12px 16px;\r\n      background: ${option.color};\r\n      color: white;\r\n      ${border}\r\n      border-radius: 6px;\r\n      cursor: pointer;\r\n      font-weight: bold;\r\n      font-size: 16px;\r\n      text-align: left;\r\n      transition: opacity 0.2s, transform 0.2s;\r\n      ${boxShadow}\r\n    `;\r\n\r\n    // Set initial label (with default slot level)\r\n    const initialSlotLevel = spell.level || null;\r\n    const resolvedLabel = getResolvedLabel(option, initialSlotLevel);\r\n    const edgeCaseNote = option.edgeCaseNote ? `<div style=\"font-size: 0.8em; color: #666; margin-top: 2px;\">${option.edgeCaseNote}</div>` : '';\r\n    btn.innerHTML = `${option.icon} ${resolvedLabel}${edgeCaseNote}`;\r\n    btn.dataset.optionIndex = optionButtons.length; // Store index for later updates\r\n\r\n    btn.addEventListener('mouseenter', () => {\r\n      btn.style.opacity = '0.9';\r\n      if (isLifesteal) btn.style.transform = 'translateY(-2px)';\r\n    });\r\n    btn.addEventListener('mouseleave', () => {\r\n      btn.style.opacity = '1';\r\n      if (isLifesteal) btn.style.transform = 'translateY(0)';\r\n    });\r\n\r\n    optionButtons.push({ button: btn, option: option });\r\n\r\n    btn.addEventListener('click', () => {\r\n      // Get selected slot level\r\n      const selectedSlotLevel = slotSelect ? parseInt(slotSelect.value) : (spell.level || null);\r\n\r\n      // Get selected metamagic options\r\n      const selectedMetamagic = metamagicCheckboxes\r\n        .filter(cb => cb.checked)\r\n        .map(cb => cb.value);\r\n\r\n      // Check if we should skip slot consumption (concentration recast)\r\n      const skipSlot = skipSlotCheckbox ? skipSlotCheckbox.checked : false;\r\n\r\n      if (option.type === 'cast') {\r\n        // Cast spell only (for spells with conditional damage like Meld into Stone)\r\n        // Announce description only if not already announced AND not using concentration recast\r\n        if (!descriptionAnnounced && !skipSlot) {\r\n          announceSpellDescription(spell, selectedSlotLevel);\r\n        }\r\n\r\n        const afterCast = (spell, slot) => {\r\n          usedSlot = slot;\r\n          showNotification(`\u2728 ${spell.name} cast successfully!`, 'success');\r\n        };\r\n        // Description announced (if needed), don't announce again in castSpell\r\n        castSpell(spell, spellIndex, afterCast, selectedSlotLevel, selectedMetamagic, skipSlot, true);\r\n        spellCast = true;\r\n\r\n        // Disable cast button after casting\r\n        btn.disabled = true;\r\n        btn.style.opacity = '0.5';\r\n        btn.style.cursor = 'not-allowed';\r\n\r\n        // Don't close modal - allow rolling damage if needed\r\n\r\n      } else if (option.type === 'attack') {\r\n        // Cast spell + roll attack, but keep modal open\r\n        // Announce description only if not already announced AND not using concentration recast\r\n        if (!descriptionAnnounced && !skipSlot) {\r\n          announceSpellDescription(spell, selectedSlotLevel);\r\n        }\r\n\r\n        const afterCast = (spell, slot) => {\r\n          usedSlot = slot;\r\n          const attackBonus = getSpellAttackBonus();\r\n          const attackFormula = attackBonus >= 0 ? `1d20+${attackBonus}` : `1d20${attackBonus}`;\r\n          roll(`${spell.name} - Spell Attack`, attackFormula);\r\n        };\r\n        // Description announced (if needed), don't announce again in castSpell\r\n        castSpell(spell, spellIndex, afterCast, selectedSlotLevel, selectedMetamagic, skipSlot, true);\r\n        spellCast = true;\r\n\r\n        // Disable slot selection and metamagic after casting\r\n        if (slotSelect) slotSelect.disabled = true;\r\n        metamagicCheckboxes.forEach(cb => cb.disabled = true);\r\n\r\n        // Disable attack button after casting\r\n        btn.disabled = true;\r\n        btn.style.opacity = '0.5';\r\n        btn.style.cursor = 'not-allowed';\r\n\r\n      } else if (option.type === 'damage' || option.type === 'healing' || option.type === 'temphp') {\r\n        // If spell not cast yet (no attack roll), cast it first\r\n        if (!spellCast) {\r\n          // Announce description only if not already announced AND not using concentration recast\r\n          if (!descriptionAnnounced && !skipSlot) {\r\n            announceSpellDescription(spell, selectedSlotLevel);\r\n          }\r\n\r\n          const afterCast = (spell, slot) => {\r\n            usedSlot = slot;\r\n            let formula = option.formula;\r\n            const actualSlotLevel = selectedSlotLevel != null ? selectedSlotLevel : (slot && slot.level);\r\n            if (actualSlotLevel != null) {\r\n              formula = formula.replace(/slotlevel/gi, actualSlotLevel);\r\n            }\r\n            // Replace ~target.level with character level (for cantrips)\r\n            if (formula.includes('~target.level') && characterData.level) {\r\n              formula = formula.replace(/~target\\.level/g, characterData.level);\r\n            }\r\n            formula = resolveVariablesInFormula(formula);\r\n            formula = evaluateMathInFormula(formula);\r\n\r\n            const label = option.type === 'healing' ?\r\n              `${spell.name} - Healing` :\r\n              (option.type === 'temphp' ?\r\n                `${spell.name} - Temp HP` :\r\n                `${spell.name} - Damage (${option.damageType || ''})`);\r\n            roll(label, formula);\r\n          };\r\n          // Description announced (if needed), don't announce again in castSpell\r\n          castSpell(spell, spellIndex, afterCast, selectedSlotLevel, selectedMetamagic, skipSlot, true);\r\n        } else {\r\n          // Spell already cast (via attack), just roll damage\r\n          let formula = option.formula;\r\n          const actualSlotLevel = selectedSlotLevel != null ? selectedSlotLevel : (usedSlot && usedSlot.level);\r\n          if (actualSlotLevel != null) {\r\n            formula = formula.replace(/slotlevel/gi, actualSlotLevel);\r\n          }\r\n          // Replace ~target.level with character level (for cantrips)\r\n          if (formula.includes('~target.level') && characterData.level) {\r\n            formula = formula.replace(/~target\\.level/g, characterData.level);\r\n          }\r\n          formula = resolveVariablesInFormula(formula);\r\n          formula = evaluateMathInFormula(formula);\r\n\r\n          const label = option.type === 'healing' ?\r\n            `${spell.name} - Healing` :\r\n            (option.type === 'temphp' ?\r\n              `${spell.name} - Temp HP` :\r\n              `${spell.name} - Damage (${option.damageType || ''})`);\r\n          roll(label, formula);\r\n        }\r\n\r\n        // Close modal after rolling damage\r\n        document.body.removeChild(overlay);\r\n\r\n      } else if (option.type === 'lifesteal') {\r\n        // Lifesteal: Cast spell, roll damage, calculate and apply healing\r\n        // Announce description only if not already announced AND not using concentration recast\r\n        if (!descriptionAnnounced && !skipSlot) {\r\n          announceSpellDescription(spell, selectedSlotLevel);\r\n        }\r\n\r\n        const afterCast = (spell, slot) => {\r\n          let damageFormula = option.damageFormula;\r\n          const actualSlotLevel = selectedSlotLevel != null ? selectedSlotLevel : (slot && slot.level);\r\n          if (actualSlotLevel != null) {\r\n            damageFormula = damageFormula.replace(/slotlevel/gi, actualSlotLevel);\r\n          }\r\n          if (damageFormula.includes('~target.level') && characterData.level) {\r\n            damageFormula = damageFormula.replace(/~target\\.level/g, characterData.level);\r\n          }\r\n          damageFormula = resolveVariablesInFormula(damageFormula);\r\n          damageFormula = evaluateMathInFormula(damageFormula);\r\n\r\n          // Roll damage\r\n          roll(`${spell.name} - Lifesteal Damage (${option.damageType})`, damageFormula);\r\n\r\n          // After a short delay, prompt for damage dealt to calculate healing\r\n          setTimeout(() => {\r\n            const healingText = option.healingRatio === 'half' ? 'half' : 'the full amount';\r\n            const damageDealt = prompt(`\uD83D\uDC89 Lifesteal: Enter the damage dealt\\n\\nYou regain HP equal to ${healingText} of the damage.`);\r\n\r\n            if (damageDealt && !isNaN(damageDealt)) {\r\n              const damage = parseInt(damageDealt);\r\n              const healing = option.healingRatio === 'half' ? Math.floor(damage / 2) : damage;\r\n\r\n              // Apply healing\r\n              const oldHP = characterData.hitPoints.current;\r\n              const maxHP = characterData.hitPoints.max;\r\n              characterData.hitPoints.current = Math.min(oldHP + healing, maxHP);\r\n              const actualHealing = characterData.hitPoints.current - oldHP;\r\n\r\n              // Reset death saves if healing from 0 HP\r\n              if (oldHP === 0 && actualHealing > 0) {\r\n                characterData.deathSaves = { successes: 0, failures: 0 };\r\n                debug.log('\u267B\uFE0F Death saves reset due to healing');\r\n              }\r\n\r\n              saveCharacterData();\r\n              buildSheet(characterData);\r\n\r\n              // Announce healing\r\n              const colorBanner = getColoredBanner();\r\n              const message = `&{template:default} {{name=${colorBanner}${characterData.name} - Lifesteal}} {{\uD83D\uDC89 Damage Dealt=${damage}}} {{\uD83D\uDC9A HP Regained=${actualHealing}}} {{Current HP=${characterData.hitPoints.current}/${maxHP}}}`;\r\n\r\n              const messageData = {\r\n                action: 'announceSpell',\r\n                message: message,\r\n                color: characterData.notificationColor\r\n              };\r\n\r\n              if (window.opener && !window.opener.closed) {\r\n                try {\r\n                  window.opener.postMessage(messageData, '*');\r\n                } catch (error) {\r\n                  debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n                }\r\n              } else {\r\n                browserAPI.runtime.sendMessage({\r\n                  action: 'relayRollToRoll20',\r\n                  roll: messageData\r\n                });\r\n              }\r\n\r\n              showNotification(`\uD83D\uDC89 Lifesteal! Dealt ${damage} damage, regained ${actualHealing} HP`, 'success');\r\n            }\r\n          }, 500);\r\n        };\r\n        // Description announced (if needed), don't announce again in castSpell\r\n        castSpell(spell, spellIndex, afterCast, selectedSlotLevel, selectedMetamagic, skipSlot, true);\r\n\r\n        // Close modal after rolling\r\n        document.body.removeChild(overlay);\r\n      }\r\n    });\r\n\r\n    optionsContainer.appendChild(btn);\r\n  });\r\n\r\n  // Set up slot selection change handler to update button labels\r\n  if (slotSelect) {\r\n    const updateButtonLabels = () => {\r\n      const selectedSlotLevel = parseInt(slotSelect.value);\r\n      optionButtons.forEach(({ button, option }) => {\r\n        const resolvedLabel = getResolvedLabel(option, selectedSlotLevel);\r\n        const edgeCaseNote = option.edgeCaseNote ? `<div style=\"font-size: 0.8em; color: #666; margin-top: 2px;\">${option.edgeCaseNote}</div>` : '';\r\n        button.innerHTML = `${option.icon} ${resolvedLabel}${edgeCaseNote}`;\r\n      });\r\n    };\r\n\r\n    // Add change event listener\r\n    slotSelect.addEventListener('change', updateButtonLabels);\r\n\r\n    // Call initially to set correct labels for default selection\r\n    updateButtonLabels();\r\n  }\r\n\r\n  // Add \"Done\" button if spell has attack (to close modal after attacking without rolling damage)\r\n  if (hasAttack && hasDamage) {\r\n    const doneBtn = document.createElement('button');\r\n    doneBtn.style.cssText = 'padding: 10px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';\r\n    doneBtn.textContent = 'Done';\r\n    doneBtn.addEventListener('click', () => {\r\n      document.body.removeChild(overlay);\r\n    });\r\n    optionsContainer.appendChild(doneBtn);\r\n  }\r\n\r\n  modal.appendChild(optionsContainer);\r\n\r\n  // Cancel button\r\n  const cancelBtn = document.createElement('button');\r\n  cancelBtn.style.cssText = 'margin-top: 16px; padding: 10px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%;';\r\n  cancelBtn.textContent = 'Cancel';\r\n  cancelBtn.addEventListener('click', () => {\r\n    document.body.removeChild(overlay);\r\n  });\r\n\r\n  modal.appendChild(cancelBtn);\r\n  overlay.appendChild(modal);\r\n\r\n  // Close on overlay click\r\n  overlay.addEventListener('click', (e) => {\r\n    if (e.target === overlay) {\r\n      document.body.removeChild(overlay);\r\n    }\r\n  });\r\n\r\n  // Add to DOM\r\n  document.body.appendChild(overlay);\r\n}\r\n\r\n/**\r\n * Handle spell option click (attack or damage)\r\n */\r\nfunction handleSpellOption(spell, spellIndex, option) {\r\n  if (option.type === 'attack') {\r\n    // Cast spell + roll attack\r\n    const afterCast = (spell, slot) => {\r\n      const attackBonus = getSpellAttackBonus();\r\n      const attackFormula = attackBonus >= 0 ? `1d20+${attackBonus}` : `1d20${attackBonus}`;\r\n      roll(`${spell.name} - Spell Attack`, attackFormula);\r\n    };\r\n    castSpell(spell, spellIndex, afterCast);\r\n  } else if (option.type === 'damage' || option.type === 'healing') {\r\n    // Handle OR choices if present\r\n    let damageType = option.damageType;\r\n    if (option.orChoices && option.orChoices.length > 1) {\r\n      const choiceText = option.orChoices.map((c, i) => `${i + 1}. ${c.damageType}`).join('\\n');\r\n      const choice = prompt(`Choose damage type for ${spell.name}:\\n${choiceText}\\n\\nEnter number (1-${option.orChoices.length}):`);\r\n\r\n      if (choice === null) return; // User cancelled\r\n\r\n      const choiceIndex = parseInt(choice) - 1;\r\n      if (choiceIndex >= 0 && choiceIndex < option.orChoices.length) {\r\n        damageType = option.orChoices[choiceIndex].damageType;\r\n      } else {\r\n        alert(`Invalid choice. Please try again.`);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Cast spell + roll damage/healing\r\n    const afterCast = (spell, slot) => {\r\n      let formula = option.formula;\r\n      // Replace slotLevel with actual slot level (case-insensitive)\r\n      if (slot && slot.level) {\r\n        formula = formula.replace(/slotlevel/gi, slot.level);\r\n      }\r\n      // Resolve other DiceCloud variables\r\n      formula = resolveVariablesInFormula(formula);\r\n      // Evaluate simple math expressions\r\n      formula = evaluateMathInFormula(formula);\r\n\r\n      const label = option.type === 'healing' ?\r\n        `${spell.name} - Healing` :\r\n        (damageType ? `${spell.name} - Damage (${damageType})` : `${spell.name} - Damage`);\r\n      roll(label, formula);\r\n    };\r\n    castSpell(spell, spellIndex, afterCast);\r\n  }\r\n}\r\n\r\n// ===== CUSTOM MACRO SYSTEM =====\r\n\r\n/**\r\n * Get custom macros for a spell\r\n */\r\nfunction getCustomMacros(spellName) {\r\n  const key = `customMacros_${characterData.name}`;\r\n  const allMacros = JSON.parse(localStorage.getItem(key) || '{}');\r\n  return allMacros[spellName] || null;\r\n}\r\n\r\n/**\r\n * Save custom macros for a spell\r\n */\r\nfunction saveCustomMacros(spellName, macros) {\r\n  const key = `customMacros_${characterData.name}`;\r\n  const allMacros = JSON.parse(localStorage.getItem(key) || '{}');\r\n\r\n  if (macros && macros.buttons && macros.buttons.length > 0) {\r\n    allMacros[spellName] = macros;\r\n  } else {\r\n    delete allMacros[spellName]; // Remove if no macros defined\r\n  }\r\n\r\n  localStorage.setItem(key, JSON.stringify(allMacros));\r\n  debug.log(`\uD83D\uDCBE Saved custom macros for \"${spellName}\":`, macros);\r\n}\r\n\r\n/**\r\n * Show custom macro configuration modal\r\n */\r\nfunction showCustomMacroModal(spell, spellIndex) {\r\n  const overlay = document.createElement('div');\r\n  overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'background: white; padding: 24px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';\r\n\r\n  const existingMacros = getCustomMacros(spell.name);\r\n  const skipNormalButtons = existingMacros?.skipNormalButtons || false;\r\n\r\n  modal.innerHTML = `\r\n    <h2 style=\"margin: 0 0 16px 0; color: #333;\">Custom Macros: ${spell.name}</h2>\r\n    <p style=\"margin: 0 0 16px 0; color: #666; font-size: 14px;\">\r\n      Configure custom macro buttons for this spell. Use this for magic item spells or custom variants that don't work with the default buttons.\r\n    </p>\r\n\r\n    <div style=\"margin-bottom: 16px;\">\r\n      <label style=\"display: flex; align-items: center; gap: 8px; cursor: pointer;\">\r\n        <input type=\"checkbox\" id=\"skipNormalButtons\" ${skipNormalButtons ? 'checked' : ''} style=\"width: 18px; height: 18px;\">\r\n        <span style=\"font-weight: bold;\">Replace default buttons (hide attack/damage buttons)</span>\r\n      </label>\r\n      <p style=\"margin: 4px 0 0 26px; color: #666; font-size: 13px;\">\r\n        Check this to only show your custom macros, hiding the default spell buttons\r\n      </p>\r\n    </div>\r\n\r\n    <div id=\"macro-buttons-container\" style=\"margin-bottom: 16px;\">\r\n      <!-- Macro buttons will be added here -->\r\n    </div>\r\n\r\n    <button id=\"add-macro-btn\" style=\"padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 16px;\">\r\n      \u2795 Add Macro Button\r\n    </button>\r\n\r\n    <div style=\"margin-top: 24px; padding-top: 16px; border-top: 2px solid #eee; display: flex; gap: 12px; justify-content: flex-end;\">\r\n      <button id=\"clear-macros-btn\" style=\"padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n        \uD83D\uDDD1\uFE0F Clear All\r\n      </button>\r\n      <button id=\"cancel-macros-btn\" style=\"padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n        Cancel\r\n      </button>\r\n      <button id=\"save-macros-btn\" style=\"padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\r\n        \uD83D\uDCBE Save\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  overlay.appendChild(modal);\r\n  document.body.appendChild(overlay);\r\n\r\n  const container = modal.querySelector('#macro-buttons-container');\r\n  const addBtn = modal.querySelector('#add-macro-btn');\r\n  const clearBtn = modal.querySelector('#clear-macros-btn');\r\n  const cancelBtn = modal.querySelector('#cancel-macros-btn');\r\n  const saveBtn = modal.querySelector('#save-macros-btn');\r\n\r\n  let macroCounter = 0;\r\n\r\n  function addMacroButton(label = '', macro = '') {\r\n    const macroDiv = document.createElement('div');\r\n    macroDiv.className = 'macro-button-config';\r\n    macroDiv.style.cssText = 'padding: 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 12px; border: 2px solid #dee2e6;';\r\n    macroDiv.dataset.macroId = macroCounter++;\r\n\r\n    macroDiv.innerHTML = `\r\n      <div style=\"margin-bottom: 8px;\">\r\n        <label style=\"display: block; font-weight: bold; margin-bottom: 4px; color: #333;\">Button Label:</label>\r\n        <input type=\"text\" class=\"macro-label\" value=\"${label}\" placeholder=\"e.g., \u2694\uFE0F Attack, \uD83D\uDCA5 Damage, \u2728 Cast\" style=\"width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;\">\r\n      </div>\r\n      <div style=\"margin-bottom: 8px;\">\r\n        <label style=\"display: block; font-weight: bold; margin-bottom: 4px; color: #333;\">Macro Text:</label>\r\n        <textarea class=\"macro-text\" placeholder=\"&{template:default} {{name=My Spell}} {{effect=Custom effect}}\" style=\"width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 13px; font-family: monospace; min-height: 80px;\">${macro}</textarea>\r\n      </div>\r\n      <button class=\"remove-macro-btn\" style=\"padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;\">\r\n        \u274C Remove\r\n      </button>\r\n    `;\r\n\r\n    const removeBtn = macroDiv.querySelector('.remove-macro-btn');\r\n    removeBtn.addEventListener('click', () => {\r\n      macroDiv.remove();\r\n    });\r\n\r\n    container.appendChild(macroDiv);\r\n  }\r\n\r\n  // Add existing macros or one empty macro\r\n  if (existingMacros && existingMacros.buttons && existingMacros.buttons.length > 0) {\r\n    existingMacros.buttons.forEach(btn => {\r\n      addMacroButton(btn.label, btn.macro);\r\n    });\r\n  } else {\r\n    addMacroButton();\r\n  }\r\n\r\n  addBtn.addEventListener('click', () => addMacroButton());\r\n\r\n  clearBtn.addEventListener('click', () => {\r\n    if (confirm(`Clear all custom macros for \"${spell.name}\"?`)) {\r\n      saveCustomMacros(spell.name, null);\r\n      document.body.removeChild(overlay);\r\n      showNotification(`\uD83D\uDDD1\uFE0F Cleared custom macros for ${spell.name}`, 'success');\r\n    }\r\n  });\r\n\r\n  cancelBtn.addEventListener('click', () => {\r\n    document.body.removeChild(overlay);\r\n  });\r\n\r\n  saveBtn.addEventListener('click', () => {\r\n    const macroConfigs = Array.from(container.querySelectorAll('.macro-button-config'));\r\n    const buttons = macroConfigs.map(config => {\r\n      const label = config.querySelector('.macro-label').value.trim();\r\n      const macro = config.querySelector('.macro-text').value.trim();\r\n      return { label, macro };\r\n    }).filter(btn => btn.label && btn.macro); // Only save if both label and macro are provided\r\n\r\n    const skipNormalButtons = modal.querySelector('#skipNormalButtons').checked;\r\n\r\n    saveCustomMacros(spell.name, {\r\n      buttons,\r\n      skipNormalButtons\r\n    });\r\n\r\n    document.body.removeChild(overlay);\r\n    showNotification(`\uD83D\uDCBE Saved custom macros for ${spell.name}`, 'success');\r\n  });\r\n\r\n  // Close on overlay click\r\n  overlay.addEventListener('click', (e) => {\r\n    if (e.target === overlay) {\r\n      document.body.removeChild(overlay);\r\n    }\r\n  });\r\n}\r\n\r\n// ===== SPELL CASTING =====\r\n\r\nfunction castSpell(spell, index, afterCast = null, selectedSlotLevel = null, selectedMetamagic = [], skipSlotConsumption = false, skipAnnouncement = false) {\r\n  debug.log('\u2728 Attempting to cast:', spell.name, spell, 'at level:', selectedSlotLevel, 'with metamagic:', selectedMetamagic, 'skipSlot:', skipSlotConsumption, 'skipAnnouncement:', skipAnnouncement);\r\n\r\n  if (!characterData) {\r\n    showNotification('\u274C Character data not available', 'error');\r\n    return;\r\n  }\r\n\r\n  // Check if spell is from a magic item (doesn't consume spell slots)\r\n  const isMagicItemSpell = spell.source && (\r\n    spell.source.toLowerCase().includes('amulet') ||\r\n    spell.source.toLowerCase().includes('ring') ||\r\n    spell.source.toLowerCase().includes('wand') ||\r\n    spell.source.toLowerCase().includes('staff') ||\r\n    spell.source.toLowerCase().includes('rod') ||\r\n    spell.source.toLowerCase().includes('cloak') ||\r\n    spell.source.toLowerCase().includes('boots') ||\r\n    spell.source.toLowerCase().includes('bracers') ||\r\n    spell.source.toLowerCase().includes('gauntlets') ||\r\n    spell.source.toLowerCase().includes('helm') ||\r\n    spell.source.toLowerCase().includes('armor') ||\r\n    spell.source.toLowerCase().includes('weapon') ||\r\n    spell.source.toLowerCase().includes('talisman') ||\r\n    spell.source.toLowerCase().includes('orb') ||\r\n    spell.source.toLowerCase().includes('scroll') ||\r\n    spell.source.toLowerCase().includes('potion')\r\n  );\r\n\r\n  // Check if spell has resources field indicating it doesn't consume spell slots\r\n  // Only treat as free if resources.itemsConsumed is explicitly defined (magic items)\r\n  // Normal spells should NOT match this condition\r\n  const isFreeSpell = spell.resources &&\r\n                       spell.resources.itemsConsumed &&\r\n                       spell.resources.itemsConsumed.length > 0;\r\n\r\n  // Cantrips (level 0), magic item spells, free spells, or concentration recast don't need slots\r\n  if (!spell.level || spell.level === 0 || spell.level === '0' || isMagicItemSpell || isFreeSpell || skipSlotConsumption) {\r\n    const reason = skipSlotConsumption ? 'concentration recast' : (isMagicItemSpell ? 'magic item' : (isFreeSpell ? 'free spell' : 'cantrip'));\r\n    debug.log(`\u2728 Casting ${reason} (no spell slot needed)`);\r\n    if (!skipAnnouncement) {\r\n      announceSpellCast(spell, skipSlotConsumption ? 'concentration recast (no slot)' : ((isMagicItemSpell || isFreeSpell) ? `${spell.source} (no slot)` : null));\r\n    }\r\n    showNotification(`\u2728 ${skipSlotConsumption ? 'Using' : 'Cast'} ${spell.name}!`);\r\n\r\n    // Handle concentration\r\n    if (spell.concentration && !skipSlotConsumption) {\r\n      setConcentration(spell.name);\r\n    }\r\n\r\n    // Track reuseable spells (Spiritual Weapon, Meld into Stone, etc.)\r\n    const shouldTrackAsReusable = isReuseableSpell(spell.name, characterData);\r\n    if (shouldTrackAsReusable && !skipSlotConsumption) {\r\n      const castSpellsKey = `castSpells_${characterData.name}`;\r\n      const castSpells = JSON.parse(localStorage.getItem(castSpellsKey) || '[]');\r\n      if (!castSpells.includes(spell.name)) {\r\n        castSpells.push(spell.name);\r\n        localStorage.setItem(castSpellsKey, JSON.stringify(castSpells));\r\n        debug.log(`\u2705 Tracked reuseable spell: ${spell.name}`);\r\n      }\r\n    }\r\n\r\n    // Execute afterCast with a fake slot for magic items and free spells to allow formulas to work\r\n    if (afterCast && typeof afterCast === 'function') {\r\n      setTimeout(() => {\r\n        // For magic items, free spells, and concentration recasts, create a slot object with the appropriate level\r\n        const fakeSlotLevel = skipSlotConsumption && selectedSlotLevel ? selectedSlotLevel : spell.level;\r\n        const fakeSlot = ((isMagicItemSpell || isFreeSpell || skipSlotConsumption) && fakeSlotLevel) ? { level: parseInt(fakeSlotLevel) } : null;\r\n        afterCast(spell, fakeSlot);\r\n      }, 300);\r\n    }\r\n    return;\r\n  }\r\n\r\n  const spellLevel = parseInt(spell.level);\r\n\r\n  // If slot level was selected in modal, use it directly\r\n  if (selectedSlotLevel !== null) {\r\n    // Check if slots are nested in spellSlots object or at top level\r\n    const slotsObject = characterData.spellSlots || characterData;\r\n\r\n    // Check if this is a Pact Magic slot (format: \"pact:${level}\")\r\n    const isPactMagicSlot = typeof selectedSlotLevel === 'string' && selectedSlotLevel.startsWith('pact:');\r\n    let actualLevel, slotVar, currentSlots, slotLabel;\r\n\r\n    if (isPactMagicSlot) {\r\n      // Parse pact magic slot level\r\n      actualLevel = parseInt(selectedSlotLevel.split(':')[1]);\r\n      slotVar = 'pactMagicSlots';\r\n      // Check both spellSlots and otherVariables for Pact Magic\r\n      currentSlots = slotsObject.pactMagicSlots ?? characterData.otherVariables?.pactMagicSlots ?? 0;\r\n      slotLabel = `Pact Magic (level ${actualLevel})`;\r\n      debug.log(`\uD83D\uDD2E Using Pact Magic slot at level ${actualLevel}, current=${currentSlots}`);\r\n    } else {\r\n      // Regular spell slot\r\n      actualLevel = parseInt(selectedSlotLevel);\r\n      slotVar = `level${actualLevel}SpellSlots`;\r\n      currentSlots = slotsObject[slotVar] || 0;\r\n      slotLabel = `level ${actualLevel} slot`;\r\n    }\r\n\r\n    if (currentSlots <= 0) {\r\n      showNotification(`\u274C No ${slotLabel} remaining!`, 'error');\r\n      return;\r\n    }\r\n\r\n    // Consume the slot - update both spellSlots and otherVariables for Pact Magic\r\n    if (isPactMagicSlot) {\r\n      // Decrement pact magic in all locations where it might be stored\r\n      if (slotsObject.pactMagicSlots !== undefined) {\r\n        slotsObject.pactMagicSlots = currentSlots - 1;\r\n      }\r\n      if (characterData.otherVariables?.pactMagicSlots !== undefined) {\r\n        characterData.otherVariables.pactMagicSlots = currentSlots - 1;\r\n      }\r\n      debug.log(`\uD83D\uDD2E Consumed Pact Magic slot: ${currentSlots} -> ${currentSlots - 1}`);\r\n    } else {\r\n      slotsObject[slotVar] = currentSlots - 1;\r\n    }\r\n    saveCharacterData();\r\n    buildSheet(characterData);\r\n\r\n    // Apply metamagic costs\r\n    if (selectedMetamagic && selectedMetamagic.length > 0) {\r\n      // TODO: Deduct sorcery points based on selected metamagic\r\n      debug.log('Metamagic selected:', selectedMetamagic);\r\n    }\r\n\r\n    // Update selectedSlotLevel to actual level for formula resolution\r\n    selectedSlotLevel = actualLevel;\r\n\r\n    if (!skipAnnouncement) {\r\n      announceSpellCast(spell, slotLabel);\r\n    }\r\n    showNotification(`\u2728 Cast ${spell.name} using ${slotLabel}!`);\r\n\r\n    // Handle concentration\r\n    if (spell.concentration) {\r\n      setConcentration(spell.name);\r\n    }\r\n\r\n    // Track reuseable spells (Spiritual Weapon, Meld into Stone, etc.)\r\n    const shouldTrackAsReusable = isReuseableSpell(spell.name, characterData);\r\n    if (shouldTrackAsReusable) {\r\n      const castSpellsKey = `castSpells_${characterData.name}`;\r\n      const castSpells = JSON.parse(localStorage.getItem(castSpellsKey) || '[]');\r\n      if (!castSpells.includes(spell.name)) {\r\n        castSpells.push(spell.name);\r\n        localStorage.setItem(castSpellsKey, JSON.stringify(castSpells));\r\n        debug.log(`\u2705 Tracked reuseable spell: ${spell.name}`);\r\n      }\r\n    }\r\n\r\n    // Execute afterCast\r\n    if (afterCast && typeof afterCast === 'function') {\r\n      setTimeout(() => {\r\n        afterCast(spell, { level: selectedSlotLevel });\r\n      }, 300);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // No slot level selected - show upcast choice (legacy behavior)\r\n  // Check for Divine Smite special handling\r\n  if (spell.name.toLowerCase().includes('divine smite')) {\r\n    debug.log(`\u26A1 Divine Smite spell detected, showing custom modal instead of upcast`);\r\n    showDivineSmiteModal(spell);\r\n    return;\r\n  }\r\n  \r\n  showUpcastChoice(spell, spellLevel, afterCast);\r\n}\r\n\r\nfunction detectClassResources(spell) {\r\n  return executorDetectClassResources(characterData);\r\n}\r\n\r\nfunction showResourceChoice(spell, spellLevel, spellSlots, maxSlots, classResources) {\r\n  // Create modal overlay\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  // Create modal content\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 400px; width: 90%;';\r\n\r\n  let buttonsHTML = `\r\n    <h3 style=\"margin: 0 0 20px 0; color: #2c3e50; text-align: center;\">Cast ${spell.name}</h3>\r\n    <p style=\"text-align: center; color: #7f8c8d; margin-bottom: 25px;\">Choose a resource:</p>\r\n    <div style=\"display: flex; flex-direction: column; gap: 12px;\">\r\n  `;\r\n\r\n  // Add spell slot option if available\r\n  if (spellSlots > 0) {\r\n    buttonsHTML += `\r\n      <button class=\"resource-choice-btn\" data-type=\"spell-slot\" data-level=\"${spellLevel}\" style=\"padding: 15px; font-size: 1em; font-weight: bold; background: #9b59b6; color: white; border: 2px solid #9b59b6; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left;\">\r\n        <div style=\"display: flex; justify-content: space-between; align-items: center;\">\r\n          <span>Level ${spellLevel} Spell Slot</span>\r\n          <span style=\"background: rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 4px; font-size: 0.9em;\">${spellSlots}/${maxSlots}</span>\r\n        </div>\r\n      </button>\r\n    `;\r\n  }\r\n\r\n  // Add class resource options\r\n  classResources.forEach((resource, idx) => {\r\n    const colors = {\r\n      'Ki': { bg: '#f39c12', border: '#f39c12' },\r\n      'Sorcery Points': { bg: '#e74c3c', border: '#e74c3c' },\r\n      'Pact Magic': { bg: '#16a085', border: '#16a085' },\r\n      'Channel Divinity': { bg: '#3498db', border: '#3498db' }\r\n    };\r\n    const color = colors[resource.name] || { bg: '#95a5a6', border: '#95a5a6' };\r\n\r\n    buttonsHTML += `\r\n      <button class=\"resource-choice-btn\" data-type=\"class-resource\" data-index=\"${idx}\" style=\"padding: 15px; font-size: 1em; font-weight: bold; background: ${color.bg}; color: white; border: 2px solid ${color.border}; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left;\">\r\n        <div style=\"display: flex; justify-content: space-between; align-items: center;\">\r\n          <span>${resource.name}</span>\r\n          <span style=\"background: rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 4px; font-size: 0.9em;\">${resource.current}/${resource.max}</span>\r\n        </div>\r\n      </button>\r\n    `;\r\n  });\r\n\r\n  buttonsHTML += `\r\n    </div>\r\n    <button id=\"resource-cancel\" style=\"width: 100%; margin-top: 20px; padding: 12px; font-size: 1em; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;\">\r\n      Cancel\r\n    </button>\r\n  `;\r\n\r\n  modalContent.innerHTML = buttonsHTML;\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  // Add hover effects\r\n  const resourceBtns = modalContent.querySelectorAll('.resource-choice-btn');\r\n  resourceBtns.forEach(btn => {\r\n    btn.addEventListener('mouseenter', () => {\r\n      btn.style.transform = 'translateY(-2px)';\r\n      btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';\r\n    });\r\n    btn.addEventListener('mouseleave', () => {\r\n      btn.style.transform = 'translateY(0)';\r\n      btn.style.boxShadow = 'none';\r\n    });\r\n\r\n    btn.addEventListener('click', () => {\r\n      const type = btn.dataset.type;\r\n\r\n      if (type === 'spell-slot') {\r\n        const level = parseInt(btn.dataset.level);\r\n        modal.remove();\r\n        // Check if they want to upcast\r\n        showUpcastChoice(spell, level);\r\n      } else if (type === 'class-resource') {\r\n        const resourceIdx = parseInt(btn.dataset.index);\r\n        const resource = classResources[resourceIdx];\r\n        modal.remove();\r\n        if (useClassResource(resource, spell)) {\r\n          announceSpellCast(spell, resource.name);\r\n        }\r\n      }\r\n    });\r\n  });\r\n\r\n  // Cancel button\r\n  document.getElementById('resource-cancel').addEventListener('click', () => {\r\n    modal.remove();\r\n  });\r\n\r\n  // Click outside to close\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      modal.remove();\r\n    }\r\n  });\r\n}\r\n\r\nfunction showUpcastChoice(spell, originalLevel, afterCast = null) {\r\n  // Get all available spell slots at this level or higher\r\n  const availableSlots = [];\r\n\r\n  // Helper to extract numeric value from DiceCloud objects\r\n  const extractNum = (val) => {\r\n    if (val === null || val === undefined) return 0;\r\n    if (typeof val === 'number') return val;\r\n    if (typeof val === 'object') {\r\n      return val.value ?? val.total ?? val.currentValue ?? 0;\r\n    }\r\n    return parseInt(val) || 0;\r\n  };\r\n\r\n  // Check for Pact Magic slots (Warlock) - these are SEPARATE from regular spell slots\r\n  const rawPactLevel = characterData.spellSlots?.pactMagicSlotLevel ||\r\n                       characterData.otherVariables?.pactMagicSlotLevel ||\r\n                       characterData.otherVariables?.pactSlotLevelVisible ||\r\n                       characterData.otherVariables?.pactSlotLevel;\r\n  const rawPactSlots = characterData.spellSlots?.pactMagicSlots ??\r\n                       characterData.otherVariables?.pactMagicSlots ??\r\n                       characterData.otherVariables?.pactSlot;\r\n  const rawPactSlotsMax = characterData.spellSlots?.pactMagicSlotsMax ??\r\n                          characterData.otherVariables?.pactMagicSlotsMax;\r\n\r\n  // Extract numeric values (DiceCloud stores these as objects like {value: 2})\r\n  const pactMagicSlots = extractNum(rawPactSlots);\r\n  const pactMagicSlotsMax = extractNum(rawPactSlotsMax);\r\n  const effectivePactLevel = extractNum(rawPactLevel) || (pactMagicSlotsMax > 0 ? 5 : 0);\r\n\r\n  debug.log('\uD83D\uDD2E Pact Magic detection:', { rawPactLevel, rawPactSlots, rawPactSlotsMax, pactMagicSlots, pactMagicSlotsMax, effectivePactLevel });\r\n\r\n  // Add Pact Magic slots first if available and spell level is compatible\r\n  // Show even if depleted (current = 0) - user can still cast with GM permission\r\n  if (pactMagicSlotsMax > 0 && originalLevel <= effectivePactLevel) {\r\n    availableSlots.push({\r\n      level: effectivePactLevel,\r\n      current: pactMagicSlots,\r\n      max: pactMagicSlotsMax,\r\n      slotVar: 'pactMagicSlots',\r\n      slotMaxVar: 'pactMagicSlotsMax',\r\n      isPactMagic: true,\r\n      label: `Level ${effectivePactLevel} - Pact Magic`\r\n    });\r\n    debug.log(`\uD83D\uDD2E Added Pact Magic to upcast options: Level ${effectivePactLevel} (${pactMagicSlots}/${pactMagicSlotsMax})`);\r\n  }\r\n\r\n  // Then check regular spell slots - show all levels with max > 0 (even if depleted)\r\n  for (let level = originalLevel; level <= 9; level++) {\r\n    const slotVar = `level${level}SpellSlots`;\r\n    const slotMaxVar = `level${level}SpellSlotsMax`;\r\n    let current = characterData.spellSlots?.[slotVar] || 0;\r\n    let max = characterData.spellSlots?.[slotMaxVar] || 0;\r\n\r\n    // Skip if this level's slots are actually Pact Magic slots (avoid duplicates)\r\n    if (pactMagicSlotsMax > 0 && level === effectivePactLevel) {\r\n      // Pact Magic is already added separately above\r\n      continue;\r\n    }\r\n\r\n    // Show slot level if character has access to it (max > 0), even if depleted\r\n    if (max > 0) {\r\n      availableSlots.push({ level, current, max, slotVar, slotMaxVar });\r\n    }\r\n  }\r\n\r\n  // Check for metamagic options\r\n  const metamagicOptions = getAvailableMetamagic();\r\n  const sorceryPoints = getSorceryPointsResource();\r\n  debug.log('\uD83D\uDD2E Metamagic detection:', {\r\n    metamagicOptions,\r\n    sorceryPoints,\r\n    hasMetamagic: metamagicOptions.length > 0 && sorceryPoints && sorceryPoints.current > 0\r\n  });\r\n  const hasMetamagic = metamagicOptions.length > 0 && sorceryPoints && sorceryPoints.current > 0;\r\n\r\n  debug.log('\uD83D\uDD2E Available slots for casting:', availableSlots);\r\n\r\n  // Handle case where no spell slots are available - allow casting anyway with warning\r\n  if (availableSlots.length === 0) {\r\n    const noSlotsModal = document.createElement('div');\r\n    noSlotsModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n    const noSlotsContent = document.createElement('div');\r\n    noSlotsContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center;';\r\n    noSlotsContent.innerHTML = `\r\n      <h3 style=\"margin: 0 0 20px 0; color: #e67e22;\">No Spell Slots Available</h3>\r\n      <p style=\"color: #7f8c8d; margin-bottom: 20px;\">You don't have any spell slots of level ${originalLevel} or higher to cast ${spell.name}.</p>\r\n      <p style=\"color: #95a5a6; font-size: 0.9em; margin-bottom: 20px;\">You can still cast if your GM allows it - no slot will be decremented.</p>\r\n      <div style=\"display: flex; gap: 10px; justify-content: center;\">\r\n        <button id=\"no-slots-cancel\" style=\"padding: 12px 25px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em;\">Cancel</button>\r\n        <button id=\"no-slots-cast\" style=\"padding: 12px 25px; background: #e67e22; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em;\">Cast Anyway</button>\r\n      </div>\r\n    `;\r\n\r\n    noSlotsModal.appendChild(noSlotsContent);\r\n    document.body.appendChild(noSlotsModal);\r\n\r\n    document.getElementById('no-slots-cancel').onclick = () => noSlotsModal.remove();\r\n    document.getElementById('no-slots-cast').onclick = () => {\r\n      noSlotsModal.remove();\r\n      // Cast without decrementing a slot - pass a fake slot with noSlotUsed flag\r\n      castWithSlot(spell, {\r\n        level: originalLevel,\r\n        current: 0,\r\n        max: 0,\r\n        slotVar: null,\r\n        noSlotUsed: true\r\n      }, [], afterCast);\r\n    };\r\n    noSlotsModal.onclick = (e) => { if (e.target === noSlotsModal) noSlotsModal.remove(); };\r\n    return;\r\n  }\r\n\r\n  // Show upcast modal\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 400px; width: 90%;';\r\n\r\n  let dropdownHTML = `\r\n    <h3 style=\"margin: 0 0 20px 0; color: #2c3e50; text-align: center;\">Cast ${spell.name}</h3>\r\n    <p style=\"text-align: center; color: #7f8c8d; margin-bottom: 20px;\">Level ${originalLevel} spell</p>\r\n\r\n    <div style=\"margin-bottom: 25px;\">\r\n      <label style=\"display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50;\">Spell Slot Level:</label>\r\n      <select id=\"upcast-slot-select\" style=\"width: 100%; padding: 12px; font-size: 1.1em; border: 2px solid #bdc3c7; border-radius: 6px; box-sizing: border-box; background: white;\">\r\n  `;\r\n\r\n  availableSlots.forEach((slot, index) => {\r\n    let label;\r\n    const depleted = slot.current <= 0;\r\n    const depletedMarker = depleted ? ' [EMPTY]' : '';\r\n\r\n    if (slot.isPactMagic) {\r\n      label = `${slot.label} - ${slot.current}/${slot.max} remaining${depletedMarker}`;\r\n    } else if (slot.level === originalLevel) {\r\n      label = `Level ${slot.level} (Normal) - ${slot.current}/${slot.max} remaining${depletedMarker}`;\r\n    } else {\r\n      label = `Level ${slot.level} (Upcast) - ${slot.current}/${slot.max} remaining${depletedMarker}`;\r\n    }\r\n    // Store index so we can identify Pact Magic vs regular slots\r\n    dropdownHTML += `<option value=\"${index}\" data-level=\"${slot.level}\" data-pact=\"${slot.isPactMagic || false}\" data-current=\"${slot.current}\">${label}</option>`;\r\n  });\r\n\r\n  dropdownHTML += `\r\n      </select>\r\n    </div>\r\n  `;\r\n\r\n  // Add metamagic options if available\r\n  if (hasMetamagic) {\r\n    dropdownHTML += `\r\n      <div style=\"margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 2px solid #9b59b6;\">\r\n        <div style=\"display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 8px;\" onclick=\"document.getElementById('metamagic-container').style.display = document.getElementById('metamagic-container').style.display === 'none' ? 'flex' : 'none'; this.querySelector('.toggle-arrow').textContent = document.getElementById('metamagic-container').style.display === 'none' ? '\u25B6' : '\u25BC';\">\r\n          <label style=\"font-weight: bold; color: #9b59b6; cursor: pointer;\">\u2728 Metamagic (Sorcery Points: ${sorceryPoints.current}/${sorceryPoints.max})</label>\r\n          <span class=\"toggle-arrow\" style=\"color: #9b59b6; font-size: 0.8em;\">\u25BC</span>\r\n        </div>\r\n        <div id=\"metamagic-container\" style=\"display: flex; flex-direction: column; gap: 6px;\">\r\n    `;\r\n\r\n    metamagicOptions.forEach((meta, index) => {\r\n      const cost = meta.cost === 'variable' ? calculateMetamagicCost(meta.name, originalLevel) : meta.cost;\r\n      const canAfford = sorceryPoints.current >= cost;\r\n      const disabledStyle = !canAfford ? 'opacity: 0.5; cursor: not-allowed;' : '';\r\n\r\n      dropdownHTML += `\r\n          <label style=\"display: flex; align-items: center; padding: 8px; background: white; border-radius: 4px; cursor: pointer; ${disabledStyle}\" title=\"${meta.description || ''}\">\r\n            <input type=\"checkbox\" class=\"metamagic-option\" data-name=\"${meta.name}\" data-cost=\"${cost}\" ${!canAfford ? 'disabled' : ''} style=\"margin-right: 8px; width: 16px; height: 16px; cursor: pointer; flex-shrink: 0;\">\r\n            <span style=\"flex: 1; color: #2c3e50; font-size: 0.95em;\">${meta.name}</span>\r\n            <span style=\"color: #9b59b6; font-weight: bold; font-size: 0.9em;\">${cost} SP</span>\r\n          </label>\r\n      `;\r\n    });\r\n\r\n    dropdownHTML += `\r\n        </div>\r\n        <div id=\"metamagic-cost\" style=\"margin-top: 8px; text-align: right; font-weight: bold; color: #2c3e50; font-size: 0.9em;\">Total Cost: 0 SP</div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  dropdownHTML += `\r\n    <div style=\"display: flex; gap: 10px;\">\r\n      <button id=\"upcast-cancel\" style=\"flex: 1; padding: 12px; font-size: 1em; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;\">\r\n        Cancel\r\n      </button>\r\n      <button id=\"upcast-confirm\" style=\"flex: 1; padding: 12px; font-size: 1em; background: #9b59b6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;\">\r\n        Cast Spell\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  modalContent.innerHTML = dropdownHTML;\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  const selectElement = document.getElementById('upcast-slot-select');\r\n  const confirmBtn = document.getElementById('upcast-confirm');\r\n  const cancelBtn = document.getElementById('upcast-cancel');\r\n\r\n  // Track metamagic selections\r\n  let selectedMetamagic = [];\r\n\r\n  if (hasMetamagic) {\r\n    const metamagicCheckboxes = document.querySelectorAll('.metamagic-option');\r\n    const costDisplay = document.getElementById('metamagic-cost');\r\n\r\n    // Update selected spell level when it changes (affects Twinned Spell cost)\r\n    selectElement.addEventListener('change', () => {\r\n      const selectedIndex = parseInt(selectElement.value);\r\n      const selectedLevel = availableSlots[selectedIndex]?.level || originalLevel;\r\n\r\n      // Recalculate costs for variable-cost metamagic\r\n      metamagicCheckboxes.forEach(checkbox => {\r\n        const metaName = checkbox.dataset.name;\r\n        const metaOption = metamagicOptions.find(m => m.name === metaName);\r\n        if (metaOption && metaOption.cost === 'variable') {\r\n          const newCost = calculateMetamagicCost(metaName, selectedLevel);\r\n          checkbox.dataset.cost = newCost;\r\n\r\n          // Update display\r\n          const label = checkbox.closest('label');\r\n          const costSpan = label.querySelector('span:last-child');\r\n          costSpan.textContent = `${newCost} SP`;\r\n\r\n          // Check if still affordable\r\n          if (sorceryPoints.current < newCost && checkbox.checked) {\r\n            checkbox.checked = false;\r\n          }\r\n        }\r\n      });\r\n\r\n      // Update total cost\r\n      updateMetamagicCost();\r\n    });\r\n\r\n    function updateMetamagicCost() {\r\n      let totalCost = 0;\r\n      selectedMetamagic = [];\r\n\r\n      metamagicCheckboxes.forEach(checkbox => {\r\n        if (checkbox.checked) {\r\n          const cost = parseInt(checkbox.dataset.cost);\r\n          totalCost += cost;\r\n          selectedMetamagic.push({\r\n            name: checkbox.dataset.name,\r\n            cost: cost\r\n          });\r\n        }\r\n      });\r\n\r\n      costDisplay.textContent = `Total Cost: ${totalCost} SP`;\r\n\r\n      // Disable confirm if not enough sorcery points\r\n      if (totalCost > sorceryPoints.current) {\r\n        confirmBtn.disabled = true;\r\n        confirmBtn.style.opacity = '0.5';\r\n        confirmBtn.style.cursor = 'not-allowed';\r\n      } else {\r\n        confirmBtn.disabled = false;\r\n        confirmBtn.style.opacity = '1';\r\n        confirmBtn.style.cursor = 'pointer';\r\n      }\r\n    }\r\n\r\n    metamagicCheckboxes.forEach(checkbox => {\r\n      checkbox.addEventListener('change', updateMetamagicCost);\r\n    });\r\n  }\r\n\r\n  confirmBtn.addEventListener('click', () => {\r\n    const selectedIndex = parseInt(selectElement.value);\r\n    const selectedSlot = availableSlots[selectedIndex];\r\n    debug.log(`\uD83D\uDD2E Selected slot from upcast modal:`, selectedSlot);\r\n\r\n    // Check if slot is depleted\r\n    if (selectedSlot.current <= 0) {\r\n      // Show warning modal\r\n      modal.remove();\r\n\r\n      const warnModal = document.createElement('div');\r\n      warnModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;';\r\n\r\n      const warnContent = document.createElement('div');\r\n      warnContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center;';\r\n      warnContent.innerHTML = `\r\n        <h3 style=\"margin: 0 0 20px 0; color: #e67e22;\">No Slots Remaining</h3>\r\n        <p style=\"color: #7f8c8d; margin-bottom: 20px;\">You have no ${selectedSlot.isPactMagic ? 'Pact Magic' : `Level ${selectedSlot.level}`} spell slots remaining.</p>\r\n        <p style=\"color: #95a5a6; font-size: 0.9em; margin-bottom: 20px;\">You can still cast if your GM allows it - no slot will be decremented.</p>\r\n        <div style=\"display: flex; gap: 10px; justify-content: center;\">\r\n          <button id=\"warn-cancel\" style=\"padding: 12px 25px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em;\">Cancel</button>\r\n          <button id=\"warn-cast\" style=\"padding: 12px 25px; background: #e67e22; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em;\">Cast Anyway</button>\r\n        </div>\r\n      `;\r\n\r\n      warnModal.appendChild(warnContent);\r\n      document.body.appendChild(warnModal);\r\n\r\n      document.getElementById('warn-cancel').onclick = () => warnModal.remove();\r\n      document.getElementById('warn-cast').onclick = () => {\r\n        warnModal.remove();\r\n        // Cast with noSlotUsed flag\r\n        castWithSlot(spell, { ...selectedSlot, noSlotUsed: true }, selectedMetamagic, afterCast);\r\n      };\r\n      warnModal.onclick = (e) => { if (e.target === warnModal) warnModal.remove(); };\r\n      return;\r\n    }\r\n\r\n    modal.remove();\r\n    castWithSlot(spell, selectedSlot, selectedMetamagic, afterCast);\r\n  });\r\n\r\n  cancelBtn.addEventListener('click', () => {\r\n    modal.remove();\r\n  });\r\n\r\n  // Click outside to close\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      modal.remove();\r\n    }\r\n  });\r\n}\r\n\r\nfunction castWithSlot(spell, slot, metamagicOptions = [], afterCast = null) {\r\n  // Deduct spell slot (unless casting without a slot)\r\n  if (!slot.noSlotUsed && slot.slotVar) {\r\n    characterData.spellSlots[slot.slotVar] = slot.current - 1;\r\n\r\n    // Also update otherVariables for Pact Magic to keep in sync\r\n    if (slot.isPactMagic && characterData.otherVariables?.pactMagicSlots !== undefined) {\r\n      characterData.otherVariables.pactMagicSlots = slot.current - 1;\r\n    }\r\n  }\r\n\r\n  // Deduct sorcery points for metamagic\r\n  let totalMetamagicCost = 0;\r\n  let metamagicNames = [];\r\n\r\n  if (metamagicOptions && metamagicOptions.length > 0) {\r\n    const sorceryPoints = getSorceryPointsResource();\r\n    if (sorceryPoints) {\r\n      metamagicOptions.forEach(meta => {\r\n        totalMetamagicCost += meta.cost;\r\n        metamagicNames.push(meta.name);\r\n      });\r\n\r\n      // Deduct sorcery points\r\n      sorceryPoints.current = Math.max(0, sorceryPoints.current - totalMetamagicCost);\r\n      debug.log(`\u2728 Used ${totalMetamagicCost} sorcery points for metamagic. Remaining: ${sorceryPoints.current}/${sorceryPoints.max}`);\r\n    }\r\n  }\r\n\r\n  // Don't call markActionAsUsed - announceSpellCast already announces to chat\r\n\r\n  saveCharacterData();\r\n\r\n  let resourceText;\r\n  let notificationText;\r\n\r\n  if (slot.noSlotUsed) {\r\n    // Casting without a spell slot (GM override)\r\n    resourceText = `Level ${slot.level} (NO SLOT USED - slot not decremented)`;\r\n    notificationText = `\u2728 Cast ${spell.name}! (no spell slot decremented)`;\r\n    debug.log(`\u26A0\uFE0F Cast without slot - no slot decremented`);\r\n  } else if (slot.isPactMagic) {\r\n    resourceText = `Pact Magic (Level ${slot.level})`;\r\n    debug.log(`\u2705 Used Pact Magic slot. Remaining: ${characterData.spellSlots[slot.slotVar]}/${slot.max}`);\r\n    notificationText = `\u2728 Cast ${spell.name}! (${characterData.spellSlots[slot.slotVar]}/${slot.max} Pact slots left)`;\r\n  } else if (slot.level > parseInt(spell.level)) {\r\n    resourceText = `Level ${slot.level} slot (upcast from ${spell.level})`;\r\n    debug.log(`\u2705 Used spell slot. Remaining: ${characterData.spellSlots[slot.slotVar]}/${slot.max}`);\r\n    notificationText = `\u2728 Cast ${spell.name}! (${characterData.spellSlots[slot.slotVar]}/${slot.max} slots left)`;\r\n  } else {\r\n    resourceText = `Level ${slot.level} slot`;\r\n    debug.log(`\u2705 Used spell slot. Remaining: ${characterData.spellSlots[slot.slotVar]}/${slot.max}`);\r\n    notificationText = `\u2728 Cast ${spell.name}! (${characterData.spellSlots[slot.slotVar]}/${slot.max} slots left)`;\r\n  }\r\n\r\n  // Add metamagic to resource text\r\n  if (metamagicNames.length > 0) {\r\n    resourceText += ` + ${metamagicNames.join(', ')} (${totalMetamagicCost} SP)`;\r\n  }\r\n  if (metamagicNames.length > 0) {\r\n    const sorceryPoints = getSorceryPointsResource();\r\n    notificationText += ` with ${metamagicNames.join(', ')}! (${sorceryPoints.current}/${sorceryPoints.max} SP left)`;\r\n  }\r\n\r\n  announceSpellCast(spell, resourceText);\r\n  showNotification(notificationText);\r\n\r\n  // Handle concentration\r\n  if (spell.concentration) {\r\n    setConcentration(spell.name);\r\n  }\r\n\r\n  // Track reuseable spells (Spiritual Weapon, Meld into Stone, etc.)\r\n  const shouldTrackAsReusable = isReuseableSpell(spell.name, characterData);\r\n  if (shouldTrackAsReusable) {\r\n    const castSpellsKey = `castSpells_${characterData.name}`;\r\n    const castSpells = JSON.parse(localStorage.getItem(castSpellsKey) || '[]');\r\n    if (!castSpells.includes(spell.name)) {\r\n      castSpells.push(spell.name);\r\n      localStorage.setItem(castSpellsKey, JSON.stringify(castSpells));\r\n      debug.log(`\u2705 Tracked reuseable spell: ${spell.name}`);\r\n    }\r\n  }\r\n\r\n  // Update the display\r\n  buildSheet(characterData);\r\n\r\n  // Execute after-cast callback (for rolling attack/damage/healing)\r\n  if (afterCast && typeof afterCast === 'function') {\r\n    setTimeout(() => {\r\n      afterCast(spell, slot);\r\n    }, 300); // Small delay to ensure chat message is sent first\r\n  }\r\n}\r\n\r\nfunction useClassResource(resource, spell) {\r\n  if (resource.current <= 0) {\r\n    showNotification(`\u274C No ${resource.name} remaining!`, 'error');\r\n    return false;\r\n  }\r\n\r\n  characterData.otherVariables[resource.varName] = resource.current - 1;\r\n\r\n  // Don't call markActionAsUsed - announceSpellCast already announces to chat\r\n\r\n  saveCharacterData();\r\n\r\n  debug.log(`\u2705 Used ${resource.name}. Remaining: ${characterData.otherVariables[resource.varName]}/${resource.max}`);\r\n  showNotification(`\u2728 Cast ${spell.name}! (${characterData.otherVariables[resource.varName]}/${resource.max} ${resource.name} left)`);\r\n\r\n  // Handle concentration\r\n  if (spell.concentration) {\r\n    setConcentration(spell.name);\r\n  }\r\n\r\n  // Track reuseable spells (Spiritual Weapon, Meld into Stone, etc.)\r\n  const shouldTrackAsReusable = isReuseableSpell(spell.name, characterData);\r\n  if (shouldTrackAsReusable) {\r\n    const castSpellsKey = `castSpells_${characterData.name}`;\r\n    const castSpells = JSON.parse(localStorage.getItem(castSpellsKey) || '[]');\r\n    if (!castSpells.includes(spell.name)) {\r\n      castSpells.push(spell.name);\r\n      localStorage.setItem(castSpellsKey, JSON.stringify(castSpells));\r\n      debug.log(`\u2705 Tracked reuseable spell: ${spell.name}`);\r\n    }\r\n  }\r\n\r\n  buildSheet(characterData);\r\n  return true;\r\n}\r\n\r\n// ===== COLOR UTILITIES =====\r\n// Moved to modules/color-utils.js - using wrapper functions for compatibility\r\nfunction getColorEmoji(color) {\r\n  return window.ColorUtils.getColorEmoji(color);\r\n}\r\n\r\nfunction getColoredBanner() {\r\n  return window.ColorUtils.getColoredBanner(characterData);\r\n}\r\n\r\nfunction getColorName(hexColor) {\r\n  return window.ColorUtils.getColorName(hexColor);\r\n}\r\n\r\n// Get the spellcasting ability modifier based on character class\r\nfunction getSpellcastingAbilityMod() {\r\n  if (!characterData || !characterData.abilityMods) {\r\n    return 0;\r\n  }\r\n\r\n  const charClass = (characterData.class || '').toLowerCase();\r\n\r\n  // Map classes to their spellcasting abilities\r\n  // Wisdom-based: Cleric, Druid, Ranger, Monk\r\n  if (charClass.includes('cleric') || charClass.includes('druid') ||\r\n      charClass.includes('ranger') || charClass.includes('monk')) {\r\n    return characterData.abilityMods.wisdomMod || 0;\r\n  }\r\n  // Intelligence-based: Wizard, Artificer, Eldritch Knight, Arcane Trickster\r\n  else if (charClass.includes('wizard') || charClass.includes('artificer') ||\r\n           charClass.includes('eldritch knight') || charClass.includes('arcane trickster')) {\r\n    return characterData.abilityMods.intelligenceMod || 0;\r\n  }\r\n  // Charisma-based: Sorcerer, Bard, Warlock, Paladin\r\n  else if (charClass.includes('sorcerer') || charClass.includes('bard') ||\r\n           charClass.includes('warlock') || charClass.includes('paladin')) {\r\n    return characterData.abilityMods.charismaMod || 0;\r\n  }\r\n\r\n  // Default to highest mental stat\r\n  const intMod = characterData.abilityMods.intelligenceMod || 0;\r\n  const wisMod = characterData.abilityMods.wisdomMod || 0;\r\n  const chaMod = characterData.abilityMods.charismaMod || 0;\r\n  return Math.max(intMod, wisMod, chaMod);\r\n}\r\n\r\n// Calculate spell attack bonus\r\nfunction getSpellAttackBonus() {\r\n  const spellMod = getSpellcastingAbilityMod();\r\n  const profBonus = characterData.proficiencyBonus || 0;\r\n  return spellMod + profBonus;\r\n}\r\n\r\n// Calculate total AC including active effects\r\nfunction calculateTotalAC() {\r\n  const baseAC = characterData.armorClass || 10;\r\n  let totalAC = baseAC;\r\n\r\n  // Combine all active effects\r\n  const allEffects = [\r\n    ...activeBuffs.map(name => ({ ...POSITIVE_EFFECTS.find(e => e.name === name), type: 'buff' })),\r\n    ...activeConditions.map(name => ({ ...NEGATIVE_EFFECTS.find(e => e.name === name), type: 'debuff' }))\r\n  ].filter(e => e && e.autoApply && e.modifier && e.modifier.ac);\r\n\r\n  // Apply AC modifiers from active effects\r\n  for (const effect of allEffects) {\r\n    const acMod = effect.modifier.ac;\r\n    if (typeof acMod === 'number') {\r\n      totalAC += acMod;\r\n      debug.log(`\uD83D\uDEE1\uFE0F Applied AC modifier: ${acMod} from ${effect.name} (${effect.type})`);\r\n    }\r\n  }\r\n\r\n  debug.log(`\uD83D\uDEE1\uFE0F Total AC calculation: ${baseAC} (base) + modifiers = ${totalAC}`);\r\n  return totalAC;\r\n}\r\n\r\n/**\r\n * Announce spell description to chat\r\n * Called immediately when Cast button is clicked, before any modal\r\n */\r\nfunction announceSpellDescription(spell, castLevel = null) {\r\n  // Build a fancy formatted message using Roll20 template syntax with custom color\r\n  const colorBanner = getColoredBanner();\r\n\r\n  // Build concentration/ritual tags\r\n  let tags = '';\r\n  if (spell.concentration) tags += ' \uD83E\uDDE0 Concentration';\r\n  if (spell.ritual) tags += ' \uD83D\uDCD6 Ritual';\r\n\r\n  let message = `&{template:default} {{name=${colorBanner}${characterData.name} casts ${spell.name}!${tags}}}`;\r\n\r\n  // Add spell level and school - show upcast level if different\r\n  const spellLevel = parseInt(spell.level) || 0;\r\n  const actualCastLevel = castLevel ? parseInt(castLevel) : spellLevel;\r\n\r\n  if (spellLevel > 0) {\r\n    let levelText = actualCastLevel > spellLevel\r\n      ? `Level ${actualCastLevel} (upcast from ${spellLevel})`\r\n      : `Level ${spellLevel}`;\r\n    if (spell.school) {\r\n      levelText += ` ${spell.school}`;\r\n    }\r\n    message += ` {{Level=${levelText}}}`;\r\n  } else if (spell.school) {\r\n    message += ` {{Level=${spell.school} cantrip}}`;\r\n  }\r\n\r\n  // Add casting details\r\n  if (spell.castingTime) {\r\n    message += ` {{Casting Time=${spell.castingTime}}}`;\r\n  }\r\n  if (spell.range) {\r\n    message += ` {{Range=${spell.range}}}`;\r\n  }\r\n  if (spell.duration) {\r\n    message += ` {{Duration=${spell.duration}}}`;\r\n  }\r\n\r\n  // Add components if available\r\n  if (spell.components) {\r\n    message += ` {{Components=${spell.components}}}`;\r\n  }\r\n\r\n  // Add source if available\r\n  if (spell.source) {\r\n    message += ` {{Source=${spell.source}}}`;\r\n  }\r\n\r\n  // Add description\r\n  if (spell.description) {\r\n    message += ` {{Description=${spell.description}}}`;\r\n  }\r\n\r\n  // Send to Roll20 chat\r\n  const messageData = {\r\n    action: 'announceSpell',\r\n    spellName: spell.name,\r\n    characterName: characterData.name,\r\n    message: message,\r\n    color: characterData.notificationColor\r\n  };\r\n\r\n  // Try window.opener first (Chrome)\r\n  if (window.opener && !window.opener.closed) {\r\n    try {\r\n      window.opener.postMessage(messageData, '*');\r\n      debug.log('\u2705 Spell description announced via window.opener');\r\n    } catch (error) {\r\n      debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n      // Fall through to background script relay\r\n    }\r\n  } else {\r\n    // Fallback: Use background script to relay to Roll20 (Firefox)\r\n    debug.log('\uD83D\uDCE1 Using background script to relay spell announcement to Roll20...');\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'relayRollToRoll20',\r\n      roll: messageData\r\n    }, (response) => {\r\n      if (browserAPI.runtime.lastError) {\r\n        debug.error('\u274C Error relaying spell announcement:', browserAPI.runtime.lastError);\r\n      } else if (response && response.success) {\r\n        debug.log('\u2705 Spell description announced to Roll20');\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Legacy function kept for backward compatibility with utility spells\r\n * For attack/damage spells, use announceSpellDescription() instead\r\n */\r\nfunction announceSpellCast(spell, resourceUsed) {\r\n  // For spells with attack/damage, description was already announced\r\n  // This just announces resource usage\r\n  if (resourceUsed) {\r\n    const colorBanner = getColoredBanner();\r\n    let message = `&{template:default} {{name=${colorBanner}${spell.name}}}`;\r\n    message += ` {{Resource Used=${resourceUsed}}}`;\r\n\r\n    const messageData = {\r\n      action: 'announceSpell',\r\n      spellName: spell.name,\r\n      characterName: characterData.name,\r\n      message: message,\r\n      color: characterData.notificationColor\r\n    };\r\n\r\n    // Try window.opener first (Chrome)\r\n    if (window.opener && !window.opener.closed) {\r\n      try {\r\n        window.opener.postMessage(messageData, '*');\r\n        debug.log('\u2705 Spell resource usage sent via window.opener');\r\n      } catch (error) {\r\n        debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n      }\r\n    } else {\r\n      browserAPI.runtime.sendMessage({\r\n        action: 'relayRollToRoll20',\r\n        roll: messageData\r\n      }, (response) => {\r\n        if (browserAPI.runtime.lastError) {\r\n          debug.error('\u274C Error relaying spell announcement:', browserAPI.runtime.lastError);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  // Also roll if there's a formula (utility spells)\r\n  if (spell.formula) {\r\n    setTimeout(() => {\r\n      roll(spell.name, spell.formula);\r\n    }, 500);\r\n  }\r\n}\r\n\r\n// ===== METAMAGIC SYSTEM =====\r\n// Core logic lives in modules/action-executor.js; these are thin wrappers\r\n// that pass the global characterData.\r\n\r\nfunction getAvailableMetamagic() {\r\n  const options = executorGetAvailableMetamagic(characterData);\r\n  debug.log('\uD83D\uDD2E Found metamagic options:', options.map(m => m.name));\r\n  return options;\r\n}\r\n\r\nfunction getSorceryPointsResource() {\r\n  return executorGetSorceryPointsResource(characterData);\r\n}\r\n\r\nfunction getKiPointsResource() {\r\n  if (!characterData || !characterData.resources) return null;\r\n\r\n  // Find ki points in resources\r\n  const kiResource = characterData.resources.find(r => {\r\n    const lowerName = r.name.toLowerCase();\r\n    return lowerName.includes('ki point') || lowerName === 'ki points' || lowerName === 'ki';\r\n  });\r\n\r\n  return kiResource || null;\r\n}\r\n\r\nfunction getLayOnHandsResource() {\r\n  if (!characterData || !characterData.resources) return null;\r\n\r\n  // Find Lay on Hands pool in resources\r\n  const layOnHandsResource = characterData.resources.find(r => {\r\n    const lowerName = r.name.toLowerCase();\r\n    return lowerName.includes('lay on hands') || lowerName === 'lay on hands pool';\r\n  });\r\n\r\n  return layOnHandsResource || null;\r\n}\r\n\r\n// Theme-aware modal helper\r\nfunction createThemedModal() {\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n  \r\n  const modalContent = document.createElement('div');\r\n  modalContent.className = 'rollcloud-modal-content';\r\n  \r\n  // Check for system theme preference\r\n  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;\r\n  const isDarkTheme = document.body.classList.contains('dark-theme') || \r\n                      document.body.classList.contains('theme-dark') || \r\n                      prefersDark;\r\n  \r\n  // Apply theme class\r\n  if (isDarkTheme) {\r\n    modalContent.classList.add('theme-dark');\r\n  } else {\r\n    modalContent.classList.add('theme-light');\r\n  }\r\n  \r\n  // Base styling (theme-specific colors will be in CSS)\r\n  modalContent.style.cssText = 'padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid #e1e8ed;';\r\n  \r\n  return { modal, modalContent, isDarkTheme };\r\n}\r\n\r\nfunction showDivineSmiteModal(spell) {\r\n  // Get all available spell slots (like upcast modal)\r\n  const availableSlots = [];\r\n\r\n  // Helper to extract numeric value from DiceCloud objects\r\n  const extractNum = (val) => {\r\n    if (val === null || val === undefined) return 0;\r\n    if (typeof val === 'number') return val;\r\n    if (typeof val === 'object') {\r\n      return val.value ?? val.total ?? val.currentValue ?? 0;\r\n    }\r\n    return parseInt(val) || 0;\r\n  };\r\n\r\n  // Check for Pact Magic slots (Warlock) - these are SEPARATE from regular spell slots\r\n  const rawPactLevel = characterData.spellSlots?.pactMagicSlotLevel ||\r\n                       characterData.otherVariables?.pactMagicSlotLevel ||\r\n                       characterData.otherVariables?.pactSlotLevelVisible ||\r\n                       characterData.otherVariables?.pactSlotLevel;\r\n  const rawPactSlots = characterData.spellSlots?.pactMagicSlots ??\r\n                       characterData.otherVariables?.pactMagicSlots ??\r\n                       characterData.otherVariables?.pactSlot;\r\n  const rawPactSlotsMax = characterData.spellSlots?.pactMagicSlotsMax ??\r\n                          characterData.otherVariables?.pactMagicSlotsMax;\r\n\r\n  // Extract numeric values (DiceCloud stores these as objects like {value: 2})\r\n  const pactMagicSlots = extractNum(rawPactSlots);\r\n  const pactMagicSlotsMax = extractNum(rawPactSlotsMax);\r\n  const effectivePactLevel = extractNum(rawPactLevel) || (pactMagicSlotsMax > 0 ? 5 : 0);\r\n\r\n  debug.log('\uD83D\uDD2E Pact Magic detection for Divine Smite:', { rawPactLevel, rawPactSlots, rawPactSlotsMax, pactMagicSlots, pactMagicSlotsMax, effectivePactLevel });\r\n\r\n  // Add Pact Magic slots first if available\r\n  // Show even if depleted (current = 0) - user can still cast with GM permission\r\n  if (pactMagicSlotsMax > 0) {\r\n    availableSlots.push({\r\n      level: effectivePactLevel,\r\n      current: pactMagicSlots,\r\n      max: pactMagicSlotsMax,\r\n      slotVar: 'pactMagicSlots',\r\n      slotMaxVar: 'pactMagicSlotsMax',\r\n      isPactMagic: true,\r\n      label: `Level ${effectivePactLevel} - Pact Magic (${pactMagicSlots}/${pactMagicSlotsMax})`\r\n    });\r\n    debug.log(`\uD83D\uDD2E Added Pact Magic to Divine Smite options: Level ${effectivePactLevel} (${pactMagicSlots}/${pactMagicSlotsMax})`);\r\n  }\r\n\r\n  // Then check regular spell slots - show all levels with max > 0 (even if depleted)\r\n  for (let level = 1; level <= 5; level++) { // Divine Smite only works up to 5th level\r\n    const slotVar = `level${level}SpellSlots`;\r\n    const slotMaxVar = `level${level}SpellSlotsMax`;\r\n    let current = characterData.spellSlots?.[slotVar] || 0;\r\n    let max = characterData.spellSlots?.[slotMaxVar] || 0;\r\n\r\n    // Skip if this level's slots are actually Pact Magic slots (avoid duplicates)\r\n    if (pactMagicSlotsMax > 0 && level === effectivePactLevel) {\r\n      // Pact Magic is already added separately above\r\n      continue;\r\n    }\r\n\r\n    // Show slot level if character has access to it (max > 0), even if depleted\r\n    if (max > 0) {\r\n      availableSlots.push({ \r\n        level, \r\n        current, \r\n        max, \r\n        slotVar, \r\n        slotMaxVar,\r\n        isPactMagic: false,\r\n        label: `Level ${level} (${current}/${max})`\r\n      });\r\n      debug.log(`\uD83D\uDD2E Added Level ${level} to Divine Smite options: ${current}/${max}`);\r\n    }\r\n  }\r\n\r\n  debug.log('\uD83D\uDD2E Available slots for Divine Smite:', availableSlots);\r\n  \r\n  // Sort by level (lowest first)\r\n  availableSlots.sort((a, b) => a.level - b.level);\r\n  \r\n  // Create theme-aware modal\r\n  const { modal, modalContent, isDarkTheme } = createThemedModal();\r\n  \r\n  // Generate slot options\r\n  const slotOptions = availableSlots.map((slot, index) => \r\n    `<option value=\"${index}\" ${slot.current <= 0 ? 'disabled' : ''}>\r\n      ${slot.label} ${slot.current <= 0 ? '(No slots remaining)' : ''}\r\n    </option>`\r\n  ).join('');\r\n  \r\n  modalContent.innerHTML = `\r\n    <h2 style=\"margin: 0 0 20px 0; font-size: 1.5em;\">\u26A1 Divine Smite</h2>\r\n    <p style=\"margin: 0 0 20px 0; font-size: 0.95em;\">\r\n      Expend a spell slot to deal extra radiant damage on a melee weapon hit\r\n    </p>\r\n    \r\n    <div style=\"margin: 20px 0;\">\r\n      <label style=\"display: block; margin-bottom: 8px; font-size: 0.95em;\">Choose Spell Slot:</label>\r\n      <select id=\"spellSlotSelect\" style=\"width: 100%; padding: 8px; font-size: 1em; border: 2px solid var(--accent-info); border-radius: 6px;\">\r\n        ${slotOptions}\r\n      </select>\r\n    </div>\r\n    \r\n    <div style=\"margin: 20px 0; text-align: left;\">\r\n      <h3 style=\"margin: 0 0 15px 0; font-size: 1.1em;\">Damage Options:</h3>\r\n      \r\n      <label style=\"display: flex; align-items: center; margin: 10px 0; cursor: pointer;\">\r\n        <input type=\"checkbox\" id=\"critCheckbox\" style=\"margin-right: 10px; width: 18px; height: 18px;\">\r\n        <span>Critical Hit (double damage dice)</span>\r\n      </label>\r\n      \r\n      <label style=\"display: flex; align-items: center; margin: 10px 0; cursor: pointer;\">\r\n        <input type=\"checkbox\" id=\"fiendCheckbox\" style=\"margin-right: 10px; width: 18px; height: 18px;\">\r\n        <span>Against Fiend or Undead (+1d8)</span>\r\n      </label>\r\n    </div>\r\n    \r\n    <div id=\"damagePreview\" style=\"margin: 15px 0; padding: 10px; border-radius: 6px; font-weight: bold; display: none;\">\r\n      <!-- Hidden - damage shown only on button -->\r\n    </div>\r\n    \r\n    <div style=\"margin-top: 25px; display: flex; gap: 10px; justify-content: center;\">\r\n      <button id=\"confirmDivineSmite\" style=\"padding: 12px 24px; font-size: 1em; font-weight: bold; background: var(--accent-warning); color: white; border: none; border-radius: 6px; cursor: pointer;\" disabled>\r\n        Select Slot\r\n      </button>\r\n      <button id=\"cancelDivineSmite\" style=\"padding: 12px 24px; font-size: 1em; font-weight: bold; background: var(--accent-danger); color: white; border: none; border-radius: 6px; cursor: pointer;\">\r\n        Cancel\r\n      </button>\r\n    </div>\r\n  `;\r\n  \r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n  \r\n  // Get elements\r\n  const critCheckbox = document.getElementById('critCheckbox');\r\n  const fiendCheckbox = document.getElementById('fiendCheckbox');\r\n  const slotSelect = document.getElementById('spellSlotSelect');\r\n  const damagePreview = document.getElementById('damagePreview');\r\n  const confirmBtn = document.getElementById('confirmDivineSmite');\r\n  const cancelBtn = document.getElementById('cancelDivineSmite');\r\n  \r\n  // Update damage preview when options change\r\n  function updateDamagePreview() {\r\n    const selectedIndex = parseInt(slotSelect.value);\r\n    if (isNaN(selectedIndex) || !availableSlots[selectedIndex]) {\r\n      damagePreview.textContent = 'Select a spell slot';\r\n      confirmBtn.disabled = true;\r\n      confirmBtn.textContent = 'Select Slot';\r\n      return;\r\n    }\r\n    \r\n    const slot = availableSlots[selectedIndex];\r\n    if (slot.current <= 0) {\r\n      damagePreview.textContent = 'No slots remaining';\r\n      confirmBtn.disabled = true;\r\n      confirmBtn.textContent = 'No Slots';\r\n      return;\r\n    }\r\n    \r\n    const level = slot.level;\r\n    const baseDice = 1 + level; // 2d8 at level 1, +1d8 per level above\r\n    let damageFormula = `${baseDice}d8`;\r\n    \r\n    // Add +1d8 for fiends/undead FIRST (before crit doubling)\r\n    if (fiendCheckbox.checked) {\r\n      damageFormula += ` + 1d8`;\r\n    }\r\n    \r\n    // Apply critical hit doubling LAST (doubles the entire formula including +1d8)\r\n    if (critCheckbox.checked) {\r\n      damageFormula = `(${damageFormula}) * 2`;\r\n    }\r\n    \r\n    damagePreview.textContent = `Damage: ${damageFormula} radiant`;\r\n    \r\n    // Update the confirm button with parsed damage formula\r\n    updateConfirmButton(damageFormula, slot);\r\n  }\r\n  \r\n  function updateConfirmButton(damageFormula, slot) {\r\n    let buttonText = '\u26A1 ';\r\n    let modifiers = [];\r\n    \r\n    // Parse the damage formula for readable display\r\n    if (damageFormula.includes('* 2')) {\r\n      // Critical hit - extract base formula and double it\r\n      const baseMatch = damageFormula.match(/\\(([^)]+)\\) \\* 2/);\r\n      if (baseMatch) {\r\n        const baseFormula = baseMatch[1];\r\n        // Extract just the base dice (without +1d8)\r\n        const baseParts = baseFormula.split(' + ').map(part => part.trim());\r\n        const mainDice = baseParts.find(part => part.includes('d8') && !part.includes('1d8'));\r\n        if (mainDice) {\r\n          buttonText += parseDamageFormula(mainDice);\r\n        } else {\r\n          buttonText += parseDamageFormula(baseFormula);\r\n        }\r\n        modifiers.push('(CRIT)');\r\n      }\r\n    } else {\r\n      // Extract just the base dice (without +1d8)\r\n      const baseParts = damageFormula.split(' + ').map(part => part.trim());\r\n      const mainDice = baseParts.find(part => part.includes('d8') && !part.includes('1d8'));\r\n      if (mainDice) {\r\n        buttonText += parseDamageFormula(mainDice);\r\n      } else {\r\n        buttonText += parseDamageFormula(damageFormula);\r\n      }\r\n    }\r\n    \r\n    // Check if +1d8 is included (fiend/undead bonus)\r\n    if (damageFormula.includes('+ 1d8')) {\r\n      modifiers.unshift('+1d8'); // Add +1d8 first\r\n    }\r\n    \r\n    // Add modifiers to button text\r\n    if (modifiers.length > 0) {\r\n      buttonText += ' ' + modifiers.join(' ');\r\n    }\r\n    \r\n    buttonText += ` Damage (Lvl ${slot.level})`;\r\n    \r\n    confirmBtn.innerHTML = buttonText;\r\n    confirmBtn.disabled = false;\r\n  }\r\n  \r\n  function parseDamageFormula(formula) {\r\n    // Parse formulas like \"2d8\", \"3d8 + 1d8\", \"4d8 + 1d8\" etc.\r\n    const parts = formula.split(' + ').map(part => part.trim());\r\n    let result = '';\r\n    \r\n    parts.forEach((part, index) => {\r\n      if (part.includes('d8')) {\r\n        const diceMatch = part.match(/(\\d+)d8/);\r\n        if (diceMatch) {\r\n          const numDice = parseInt(diceMatch[1]);\r\n          if (numDice === 1) {\r\n            result += '1d8';\r\n          } else {\r\n            result += `${numDice}d8`;\r\n          }\r\n        }\r\n      }\r\n      \r\n      if (index < parts.length - 1) {\r\n        result += ' + ';\r\n      }\r\n    });\r\n    \r\n    return result;\r\n  }\r\n  \r\n  critCheckbox.addEventListener('change', updateDamagePreview);\r\n  fiendCheckbox.addEventListener('change', updateDamagePreview);\r\n  slotSelect.addEventListener('change', updateDamagePreview);\r\n  \r\n  // Handle confirm\r\n  confirmBtn.addEventListener('click', () => {\r\n    const selectedIndex = parseInt(slotSelect.value);\r\n    const slot = availableSlots[selectedIndex];\r\n    \r\n    if (slot.current <= 0) {\r\n      showNotification(`\u274C No Level ${slot.level} spell slot available!`, 'error');\r\n      return;\r\n    }\r\n    \r\n    // Calculate damage\r\n    const level = slot.level;\r\n    const baseDice = 1 + level;\r\n    let damageFormula = `${baseDice}d8`;\r\n    \r\n    // Add +1d8 for fiends/undead FIRST (before crit doubling)\r\n    if (fiendCheckbox.checked) {\r\n      damageFormula += ` + 1d8`;\r\n    }\r\n    \r\n    // Apply critical hit doubling LAST (doubles the entire formula including +1d8)\r\n    if (critCheckbox.checked) {\r\n      damageFormula = `(${damageFormula}) * 2`;\r\n    }\r\n    \r\n    // Consume the spell slot\r\n    if (slot.isPactMagic) {\r\n      characterData.spellSlots[slot.slotVar] = Math.max(0, characterData.spellSlots[slot.slotVar] - 1);\r\n    } else {\r\n      characterData.spellSlots[slot.slotVar] = Math.max(0, characterData.spellSlots[slot.slotVar] - 1);\r\n    }\r\n    saveCharacterData();\r\n    \r\n    // Build description\r\n    let description = `Divine Smite (Level ${level}`;\r\n    if (critCheckbox.checked) description += ', Critical';\r\n    if (fiendCheckbox.checked) description += ', vs Fiend/Undead';\r\n    description += ')';\r\n    \r\n    // Announce and roll the damage\r\n    announceAction({\r\n      name: 'Divine Smite',\r\n      description: description\r\n    });\r\n    \r\n    roll('Divine Smite', damageFormula);\r\n    \r\n    // Show notification\r\n    const remaining = slot.isPactMagic ? \r\n      characterData.spellSlots[slot.slotVar] : \r\n      characterData.spellSlots[slot.slotVar];\r\n    showNotification(`\u26A1 Divine Smite! Used Level ${slot.level} slot (${remaining}/${slot.max} left)`);\r\n    \r\n    // Remove modal and refresh display\r\n    document.body.removeChild(modal);\r\n    buildSheet(characterData);\r\n  });\r\n  \r\n  // Handle cancel\r\n  cancelBtn.addEventListener('click', () => {\r\n    document.body.removeChild(modal);\r\n  });\r\n  \r\n  // Handle escape key\r\n  const handleEscape = (e) => {\r\n    if (e.key === 'Escape') {\r\n      document.body.removeChild(modal);\r\n      document.removeEventListener('keydown', handleEscape);\r\n    }\r\n  };\r\n  document.addEventListener('keydown', handleEscape);\r\n  \r\n  // Initialize the damage preview\r\n  updateDamagePreview();\r\n}\r\n\r\nfunction handleLayOnHands(action) {\r\n  const layOnHandsPool = getLayOnHandsResource();\r\n\r\n  if (!layOnHandsPool) {\r\n    showNotification(`\u274C No Lay on Hands pool resource found`, 'error');\r\n    return;\r\n  }\r\n\r\n  if (layOnHandsPool.current <= 0) {\r\n    showNotification(`\u274C No Lay on Hands points remaining!`, 'error');\r\n    return;\r\n  }\r\n\r\n  // Show modal for Lay on Hands\r\n  showLayOnHandsModal(layOnHandsPool);\r\n}\r\n\r\nfunction showLayOnHandsModal(layOnHandsPool) {\r\n  // Create theme-aware modal\r\n  const { modal, modalContent, isDarkTheme } = createThemedModal();\r\n  \r\n  modalContent.innerHTML = `\r\n    <h2 style=\"margin: 0 0 20px 0; font-size: 1.5em;\">\uD83D\uDC9A Lay on Hands</h2>\r\n    <p style=\"margin: 0 0 15px 0; font-size: 1.1em;\">\r\n      Available Points: <strong>${layOnHandsPool.current}/${layOnHandsPool.max}</strong>\r\n    </p>\r\n    <p style=\"margin: 0 0 20px 0; font-size: 0.95em;\">\r\n      How many points do you want to spend?\r\n    </p>\r\n    <div style=\"margin: 20px 0;\">\r\n      <input type=\"number\" id=\"layOnHandsAmount\" min=\"1\" max=\"${layOnHandsPool.current}\" value=\"1\" \r\n             style=\"width: 80px; padding: 8px; font-size: 1.1em; text-align: center; border: 2px solid var(--accent-info); border-radius: 6px;\">\r\n      <span style=\"margin-left: 10px; font-weight: bold;\" id=\"healingDisplay\">1 HP healed</span>\r\n    </div>\r\n    <div style=\"margin-top: 25px; display: flex; gap: 10px; justify-content: center;\">\r\n      <button id=\"confirmLayOnHands\" style=\"padding: 12px 24px; font-size: 1em; font-weight: bold; background: var(--accent-success); color: white; border: none; border-radius: 6px; cursor: pointer;\">\r\n        Heal\r\n      </button>\r\n      <button id=\"cancelLayOnHands\" style=\"padding: 12px 24px; font-size: 1em; font-weight: bold; background: var(--accent-danger); color: white; border: none; border-radius: 6px; cursor: pointer;\">\r\n        Cancel\r\n      </button>\r\n    </div>\r\n  `;\r\n  \r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n  \r\n  // Get elements\r\n  const amountInput = document.getElementById('layOnHandsAmount');\r\n  const healingDisplay = document.getElementById('healingDisplay');\r\n  const confirmBtn = document.getElementById('confirmLayOnHands');\r\n  const cancelBtn = document.getElementById('cancelLayOnHands');\r\n  \r\n  // Update healing display when amount changes\r\n  function updateHealingDisplay() {\r\n    const amount = parseInt(amountInput.value) || 0;\r\n    healingDisplay.textContent = `${amount} HP healed`;\r\n    healingDisplay.style.color = '#3498db';\r\n  }\r\n  \r\n  amountInput.addEventListener('input', updateHealingDisplay);\r\n  \r\n  // Handle confirm\r\n  confirmBtn.addEventListener('click', () => {\r\n    const amount = parseInt(amountInput.value);\r\n    \r\n    if (isNaN(amount) || amount < 1 || amount > layOnHandsPool.current) {\r\n      showNotification(`\u274C Please enter a number between 1 and ${layOnHandsPool.current}`, 'error');\r\n      return;\r\n    }\r\n    \r\n    // Deduct points\r\n    layOnHandsPool.current -= amount;\r\n    saveCharacterData();\r\n    \r\n    // Announce the healing\r\n    debug.log(`\uD83D\uDC9A Used ${amount} Lay on Hands points. Remaining: ${layOnHandsPool.current}/${layOnHandsPool.max}`);\r\n    \r\n    if (amount === 5) {\r\n      announceAction({\r\n        name: 'Lay on Hands',\r\n        description: `Cured disease/poison`\r\n      });\r\n      showNotification(`\uD83D\uDC9A Lay on Hands: Cured disease/poison (${layOnHandsPool.current}/${layOnHandsPool.max} points left)`);\r\n    } else {\r\n      announceAction({\r\n        name: 'Lay on Hands',\r\n        description: `Restored ${amount} HP`\r\n      });\r\n      showNotification(`\uD83D\uDC9A Lay on Hands: Restored ${amount} HP (${layOnHandsPool.current}/${layOnHandsPool.max} points left)`);\r\n    }\r\n    \r\n    // Remove modal and refresh display\r\n    document.body.removeChild(modal);\r\n    buildSheet(characterData);\r\n  });\r\n  \r\n  // Handle cancel\r\n  cancelBtn.addEventListener('click', () => {\r\n    document.body.removeChild(modal);\r\n  });\r\n  \r\n  // Handle escape key\r\n  const handleEscape = (e) => {\r\n    if (e.key === 'Escape') {\r\n      document.body.removeChild(modal);\r\n      document.removeEventListener('keydown', handleEscape);\r\n    }\r\n  };\r\n  document.addEventListener('keydown', handleEscape);\r\n  \r\n  // Focus input\r\n  amountInput.focus();\r\n  amountInput.select();\r\n}\r\n\r\nfunction handleRecoverSpellSlot(action) {\r\n  // Calculate max recoverable level from proficiency bonus\r\n  const profBonus = characterData.proficiencyBonus || 2;\r\n  const maxLevel = Math.ceil(profBonus / 2);\r\n  \r\n  debug.log(`\uD83D\uDD2E Recover Spell Slot: proficiencyBonus=${profBonus}, maxLevel=${maxLevel}`);\r\n  \r\n  // Find available spell slots of eligible levels\r\n  const eligibleSlots = [];\r\n  for (let level = 1; level <= maxLevel && level <= 9; level++) {\r\n    const slotKey = `level${level}SpellSlots`;\r\n    const maxKey = `level${level}SpellSlotsMax`;\r\n    \r\n    if (characterData[slotKey] !== undefined && characterData[maxKey] !== undefined) {\r\n      const current = characterData[slotKey];\r\n      const max = characterData[maxKey];\r\n      \r\n      if (current < max) {\r\n        eligibleSlots.push({ level, current, max, slotKey, maxKey });\r\n      }\r\n    }\r\n  }\r\n  \r\n  if (eligibleSlots.length === 0) {\r\n    showNotification(`\u274C No spell slots to recover (max level: ${maxLevel})`, 'error');\r\n    return;\r\n  }\r\n  \r\n  // If only one eligible slot, recover it automatically\r\n  if (eligibleSlots.length === 1) {\r\n    const slot = eligibleSlots[0];\r\n    recoverSpellSlot(slot, action, maxLevel);\r\n    return;\r\n  }\r\n  \r\n  // If multiple slots, let user choose\r\n  let message = `Recover Spell Slot (max level: ${maxLevel})\\n\\nChoose which spell slot to recover:\\n\\n`;\r\n  eligibleSlots.forEach((slot, index) => {\r\n    message += `${index + 1}. Level ${slot.level}: ${slot.current}/${slot.max}\\n`;\r\n  });\r\n  \r\n  const choice = prompt(message);\r\n  if (choice === null) return; // Cancelled\r\n  \r\n  const choiceIndex = parseInt(choice) - 1;\r\n  if (isNaN(choiceIndex) || choiceIndex < 0 || choiceIndex >= eligibleSlots.length) {\r\n    showNotification('\u274C Invalid choice', 'error');\r\n    return;\r\n  }\r\n  \r\n  const selectedSlot = eligibleSlots[choiceIndex];\r\n  recoverSpellSlot(selectedSlot, action, maxLevel);\r\n}\r\n\r\nfunction recoverSpellSlot(slot, action, maxLevel) {\r\n  // Increment the spell slot\r\n  characterData[slot.slotKey] = Math.min(characterData[slot.slotKey] + 1, characterData[slot.maxKey]);\r\n  saveCharacterData();\r\n  \r\n  // Create description with resolved formula\r\n  const description = `You expend a use of your Channel Divinity to fuel your spells. As a bonus action, you touch your holy symbol, utter a prayer, and regain one expended spell slot, the level of which can be no higher than ${maxLevel}.`;\r\n  \r\n  // Announce the action\r\n  announceAction({\r\n    name: action.name,\r\n    description: description,\r\n    actionType: action.actionType || 'bonus'\r\n  });\r\n  \r\n  showNotification(`\uD83D\uDD2E Recovered Level ${slot.level} Spell Slot (${characterData[slot.slotKey]}/${characterData[slot.maxKey]})`, 'success');\r\n  \r\n  // Refresh display\r\n  buildSheet(characterData);\r\n}\r\n\r\n// Helper function to find resources with flexible Channel Divinity matching\r\nfunction findResourceByVariableName(variableName) {\r\n  // Check for exact match first\r\n  let resource = characterData.resources?.find(r => r.variableName === variableName);\r\n\r\n  if (resource) {\r\n    return resource;\r\n  }\r\n\r\n  // Special handling for Channel Divinity - try all possible variable names\r\n  if (variableName === 'channelDivinity' ||\r\n      variableName === 'channelDivinityCleric' ||\r\n      variableName === 'channelDivinityPaladin') {\r\n    resource = characterData.resources?.find(r =>\r\n      r.name === 'Channel Divinity' ||\r\n      r.variableName === 'channelDivinityCleric' ||\r\n      r.variableName === 'channelDivinityPaladin' ||\r\n      r.variableName === 'channelDivinity'\r\n    );\r\n  }\r\n\r\n  return resource;\r\n}\r\n\r\nfunction getResourceCostsFromAction(action) {\r\n  // Use DiceCloud's structured resource consumption data instead of regex parsing\r\n  if (!action || !action.resources || !action.resources.attributesConsumed) {\r\n    return [];\r\n  }\r\n\r\n  const costs = action.resources.attributesConsumed.map(consumed => {\r\n    const quantity = consumed.quantity?.value || 0;\r\n    return {\r\n      name: consumed.statName || '',\r\n      variableName: consumed.variableName || '',\r\n      quantity: quantity\r\n    };\r\n  });\r\n\r\n  if (costs.length > 0) {\r\n    debug.log(`\uD83D\uDCB0 Resource costs for ${action.name}:`, costs);\r\n    // Debug: Log each cost with its variableName\r\n    costs.forEach(cost => {\r\n      debug.log(`   \uD83D\uDCCB Cost: ${cost.name || 'unnamed'}, variableName: \"${cost.variableName}\", quantity: ${cost.quantity}`);\r\n    });\r\n  }\r\n\r\n  return costs;\r\n}\r\n\r\n// Legacy functions for backwards compatibility (now use structured data)\r\nfunction getKiCostFromAction(action) {\r\n  const costs = getResourceCostsFromAction(action);\r\n  const kiCost = costs.find(c =>\r\n    c.variableName === 'kiPoints' ||\r\n    c.name.toLowerCase().includes('ki point')\r\n  );\r\n\r\n  if (kiCost) {\r\n    debug.log(`\uD83D\uDCA8 Ki cost for ${action.name}: ${kiCost.quantity} ki points`);\r\n    return kiCost.quantity;\r\n  }\r\n\r\n  return 0;\r\n}\r\n\r\nfunction getSorceryPointCostFromAction(action) {\r\n  const costs = getResourceCostsFromAction(action);\r\n  const sorceryCost = costs.find(c =>\r\n    c.variableName === 'sorceryPoints' ||\r\n    c.name.toLowerCase().includes('sorcery point')\r\n  );\r\n\r\n  if (sorceryCost) {\r\n    debug.log(`\u2728 Sorcery Point cost for ${action.name}: ${sorceryCost.quantity} SP`);\r\n    return sorceryCost.quantity;\r\n  }\r\n\r\n  return 0;\r\n}\r\n\r\nfunction decrementActionResources(action) {\r\n  // Decrement all resource costs for an action (Wild Shape uses, Breath Weapon uses, etc.)\r\n  const costs = getResourceCostsFromAction(action);\r\n\r\n  if (!costs || costs.length === 0) {\r\n    return true; // No resources to decrement\r\n  }\r\n\r\n  // Check all resources have sufficient quantities before decrementing any\r\n  for (const cost of costs) {\r\n    // Skip Ki and Sorcery Points as they're handled separately\r\n    if (cost.variableName === 'kiPoints' || cost.variableName === 'sorceryPoints') {\r\n      continue;\r\n    }\r\n\r\n    if (!cost.variableName) {\r\n      debug.log(`\u26A0\uFE0F Resource cost missing variableName for ${action.name}:`, cost);\r\n      continue;\r\n    }\r\n\r\n    // Find the resource in character data (with flexible Channel Divinity matching)\r\n    const resource = findResourceByVariableName(cost.variableName);\r\n\r\n    if (!resource) {\r\n      debug.log(`\u26A0\uFE0F Resource not found: ${cost.variableName} for ${action.name}`);\r\n      continue;\r\n    }\r\n\r\n    if (resource.current < cost.quantity) {\r\n      showNotification(`\u274C Not enough ${cost.name || cost.variableName}! Need ${cost.quantity}, have ${resource.current}`, 'error');\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // All checks passed, now decrement the resources\r\n  for (const cost of costs) {\r\n    // Skip Ki and Sorcery Points as they're handled separately\r\n    if (cost.variableName === 'kiPoints' || cost.variableName === 'sorceryPoints') {\r\n      continue;\r\n    }\r\n\r\n    if (!cost.variableName) {\r\n      continue;\r\n    }\r\n\r\n    // Find the resource (with flexible Channel Divinity matching)\r\n    const resource = findResourceByVariableName(cost.variableName);\r\n\r\n    if (resource) {\r\n      resource.current -= cost.quantity;\r\n\r\n      // Also update otherVariables to keep data in sync\r\n      if (characterData.otherVariables && resource.varName) {\r\n        characterData.otherVariables[resource.varName] = resource.current;\r\n      }\r\n\r\n      debug.log(`\u2705 Used ${cost.quantity} ${cost.name || cost.variableName} for ${action.name}. Remaining: ${resource.current}/${resource.max}`);\r\n      showNotification(`\u2705 Used ${action.name}! (${resource.current}/${resource.max} ${cost.name || cost.variableName} left)`);\r\n    }\r\n  }\r\n\r\n  saveCharacterData();\r\n  buildSheet(characterData); // Refresh display\r\n  return true;\r\n}\r\n\r\nfunction calculateMetamagicCost(metamagicName, spellLevel) {\r\n  return executorCalculateMetamagicCost(metamagicName, spellLevel);\r\n}\r\n\r\nfunction showConvertSlotToPointsModal() {\r\n  const sorceryPoints = getSorceryPointsResource();\r\n\r\n  if (!sorceryPoints) {\r\n    showNotification('\u274C No Sorcery Points resource found', 'error');\r\n    return;\r\n  }\r\n\r\n  // Get available spell slots\r\n  const availableSlots = [];\r\n  for (let level = 1; level <= 9; level++) {\r\n    const slotVar = `level${level}SpellSlots`;\r\n    const maxSlotVar = `level${level}SpellSlotsMax`;\r\n    const current = characterData.spellSlots?.[slotVar] || 0;\r\n    const max = characterData.spellSlots?.[maxSlotVar] || 0;\r\n\r\n    if (current > 0) {\r\n      availableSlots.push({ level, current, max, slotVar, maxSlotVar });\r\n    }\r\n  }\r\n\r\n  if (availableSlots.length === 0) {\r\n    showNotification('\u274C No spell slots available to convert!', 'error');\r\n    return;\r\n  }\r\n\r\n  // Create modal\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 400px; width: 90%;';\r\n\r\n  let optionsHTML = `\r\n    <h3 style=\"margin: 0 0 15px 0; color: #2c3e50; text-align: center;\">Convert Spell Slot to Sorcery Points</h3>\r\n    <p style=\"text-align: center; color: #e74c3c; margin-bottom: 20px; font-weight: bold;\">Current: ${sorceryPoints.current}/${sorceryPoints.max} SP</p>\r\n\r\n    <div style=\"margin-bottom: 25px;\">\r\n      <label style=\"display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50;\">Expend Spell Slot:</label>\r\n      <select id=\"slot-to-points-level\" style=\"width: 100%; padding: 12px; font-size: 1.1em; border: 2px solid #bdc3c7; border-radius: 6px; box-sizing: border-box; background: white;\">\r\n  `;\r\n\r\n  availableSlots.forEach(slot => {\r\n    optionsHTML += `<option value=\"${slot.level}\">Level ${slot.level} - Gain ${slot.level} SP (${slot.current}/${slot.max} slots)</option>`;\r\n  });\r\n\r\n  optionsHTML += `\r\n      </select>\r\n    </div>\r\n\r\n    <div style=\"display: flex; gap: 10px;\">\r\n      <button id=\"slot-cancel\" style=\"flex: 1; padding: 12px; font-size: 1em; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;\">\r\n        Cancel\r\n      </button>\r\n      <button id=\"slot-confirm\" style=\"flex: 1; padding: 12px; font-size: 1em; background: #9b59b6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;\">\r\n        Convert\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  modalContent.innerHTML = optionsHTML;\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  const selectElement = document.getElementById('slot-to-points-level');\r\n  const confirmBtn = document.getElementById('slot-confirm');\r\n  const cancelBtn = document.getElementById('slot-cancel');\r\n\r\n  cancelBtn.addEventListener('click', () => {\r\n    document.body.removeChild(modal);\r\n  });\r\n\r\n  confirmBtn.addEventListener('click', () => {\r\n    const selectedLevel = parseInt(selectElement.value);\r\n    const slotVar = `level${selectedLevel}SpellSlots`;\r\n    const currentSlots = characterData.spellSlots?.[slotVar] || 0;\r\n\r\n    if (currentSlots <= 0) {\r\n      showNotification(`\u274C No Level ${selectedLevel} spell slots available!`, 'error');\r\n      return;\r\n    }\r\n\r\n    // Remove spell slot\r\n    characterData.spellSlots[slotVar] -= 1;\r\n\r\n    // Gain sorcery points equal to slot level\r\n    const pointsGained = selectedLevel;\r\n    sorceryPoints.current = Math.min(sorceryPoints.current + pointsGained, sorceryPoints.max);\r\n\r\n    saveCharacterData();\r\n\r\n    const maxSlotVar = `level${selectedLevel}SpellSlotsMax`;\r\n    const newSlotCount = characterData.spellSlots[slotVar];\r\n    const maxSlots = characterData.spellSlots[maxSlotVar];\r\n    showNotification(`\u2728 Gained ${pointsGained} Sorcery Points! (${sorceryPoints.current}/${sorceryPoints.max} SP, ${newSlotCount}/${maxSlots} slots)`);\r\n\r\n    // Announce to Roll20\r\n    const colorBanner = getColoredBanner();\r\n    const message = `&{template:default} {{name=${colorBanner}${characterData.name} uses Font of Magic\u26A1}} {{Action=Convert Spell Slot to Sorcery Points}} {{Result=Expended Level ${selectedLevel} spell slot for ${pointsGained} SP}} {{Sorcery Points=${sorceryPoints.current}/${sorceryPoints.max}}}`;\r\n\r\n    if (window.opener && !window.opener.closed) {\r\n      window.opener.postMessage({\r\n        action: 'roll',\r\n        characterName: characterData.name,\r\n        message: message,\r\n        color: characterData.notificationColor\r\n      }, '*');\r\n    }\r\n\r\n    document.body.removeChild(modal);\r\n    buildSheet(characterData); // Refresh display\r\n  });\r\n}\r\n\r\nfunction showFontOfMagicModal() {\r\n  const sorceryPoints = getSorceryPointsResource();\r\n\r\n  if (!sorceryPoints) {\r\n    showNotification('\u274C No Sorcery Points resource found', 'error');\r\n    return;\r\n  }\r\n\r\n  // Font of Magic spell slot creation costs (D&D 5e rules)\r\n  const slotCosts = {\r\n    1: 2,\r\n    2: 3,\r\n    3: 5,\r\n    4: 6,\r\n    5: 7\r\n  };\r\n\r\n  // Create modal\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 400px; width: 90%;';\r\n\r\n  let optionsHTML = `\r\n    <h3 style=\"margin: 0 0 15px 0; color: #2c3e50; text-align: center;\">Convert Sorcery Points to Spell Slot</h3>\r\n    <p style=\"text-align: center; color: #e74c3c; margin-bottom: 20px; font-weight: bold;\">Current: ${sorceryPoints.current}/${sorceryPoints.max} SP</p>\r\n\r\n    <div style=\"margin-bottom: 25px;\">\r\n      <label style=\"display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50;\">Create Spell Slot Level:</label>\r\n      <select id=\"font-of-magic-slot\" style=\"width: 100%; padding: 12px; font-size: 1.1em; border: 2px solid #bdc3c7; border-radius: 6px; box-sizing: border-box; background: white;\">\r\n  `;\r\n\r\n  // Add options for each spell slot level\r\n  for (let level = 1; level <= 5; level++) {\r\n    const cost = slotCosts[level];\r\n    const canAfford = sorceryPoints.current >= cost;\r\n    const slotVar = `level${level}SpellSlots`;\r\n    const maxSlotVar = `level${level}SpellSlotsMax`;\r\n    const currentSlots = characterData.spellSlots?.[slotVar] || 0;\r\n    const maxSlots = characterData.spellSlots?.[maxSlotVar] || 0;\r\n\r\n    const disabledAttr = canAfford ? '' : 'disabled';\r\n    const affordText = canAfford ? '' : ' (not enough SP)';\r\n\r\n    optionsHTML += `<option value=\"${level}\" ${disabledAttr}>Level ${level} - ${cost} SP${affordText} (${currentSlots}/${maxSlots} slots)</option>`;\r\n  }\r\n\r\n  optionsHTML += `\r\n      </select>\r\n    </div>\r\n\r\n    <div style=\"display: flex; gap: 10px;\">\r\n      <button id=\"font-cancel\" style=\"flex: 1; padding: 12px; font-size: 1em; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;\">\r\n        Cancel\r\n      </button>\r\n      <button id=\"font-confirm\" style=\"flex: 1; padding: 12px; font-size: 1em; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;\">\r\n        Convert\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  modalContent.innerHTML = optionsHTML;\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  const selectElement = document.getElementById('font-of-magic-slot');\r\n  const confirmBtn = document.getElementById('font-confirm');\r\n  const cancelBtn = document.getElementById('font-cancel');\r\n\r\n  cancelBtn.addEventListener('click', () => {\r\n    document.body.removeChild(modal);\r\n  });\r\n\r\n  confirmBtn.addEventListener('click', () => {\r\n    const selectedLevel = parseInt(selectElement.value);\r\n    const cost = slotCosts[selectedLevel];\r\n\r\n    if (sorceryPoints.current < cost) {\r\n      showNotification(`\u274C Not enough Sorcery Points! Need ${cost}, have ${sorceryPoints.current}`, 'error');\r\n      return;\r\n    }\r\n\r\n    // Deduct sorcery points\r\n    sorceryPoints.current -= cost;\r\n\r\n    // Add spell slot\r\n    const slotVar = `level${selectedLevel}SpellSlots`;\r\n    const maxSlotVar = `level${selectedLevel}SpellSlotsMax`;\r\n    const maxSlots = characterData.spellSlots?.[maxSlotVar] || 0;\r\n\r\n    characterData.spellSlots[slotVar] = Math.min((characterData.spellSlots[slotVar] || 0) + 1, maxSlots);\r\n\r\n    saveCharacterData();\r\n\r\n    const currentSlots = characterData.spellSlots[slotVar];\r\n    showNotification(`\u2728 Created Level ${selectedLevel} spell slot! (${sorceryPoints.current}/${sorceryPoints.max} SP left, ${currentSlots}/${maxSlots} slots)`);\r\n\r\n    // Announce to Roll20\r\n    const colorBanner = getColoredBanner();\r\n    const message = `&{template:default} {{name=${colorBanner}${characterData.name} uses Font of Magic\u26A1}} {{Action=Convert Sorcery Points to Spell Slot}} {{Result=Created Level ${selectedLevel} spell slot for ${cost} SP}} {{Sorcery Points=${sorceryPoints.current}/${sorceryPoints.max}}}`;\r\n\r\n    if (window.opener && !window.opener.closed) {\r\n      window.opener.postMessage({\r\n        action: 'roll',\r\n        characterName: characterData.name,\r\n        message: message,\r\n        color: characterData.notificationColor\r\n      }, '*');\r\n    }\r\n\r\n    document.body.removeChild(modal);\r\n    buildSheet(characterData); // Refresh display\r\n  });\r\n}\r\n\r\nfunction announceAction(action) {\r\n  // Announce the use of an action (bonus action, reaction, etc.) to Roll20 chat\r\n  const colorBanner = getColoredBanner();\r\n\r\n  // Determine action type emoji\r\n  const actionTypeEmoji = {\r\n    'bonus': '\u26A1',\r\n    'reaction': '\uD83D\uDEE1\uFE0F',\r\n    'action': '\u2694\uFE0F',\r\n    'free': '\uD83D\uDCA8',\r\n    'legendary': '\uD83D\uDC51',\r\n    'lair': '\uD83C\uDFF0',\r\n    'other': '\u2728'\r\n  };\r\n\r\n  const emoji = actionTypeEmoji[action.actionType?.toLowerCase()] || '\u2728';\r\n  const actionTypeText = action.actionType ? ` (${action.actionType})` : '';\r\n\r\n  let message = `&{template:default} {{name=${colorBanner}${characterData.name} uses ${action.name}${emoji}}} {{Action Type=${action.actionType || 'Other'}}}`;\r\n\r\n  // Add description (resolve variables first)\r\n  if (action.description) {\r\n    const resolvedDescription = resolveVariablesInFormula(action.description);\r\n    message += ` {{Description=${resolvedDescription}}}`;\r\n  }\r\n\r\n  // Add uses if available\r\n  if (action.uses) {\r\n    const usesUsed = action.usesUsed || 0;\r\n    const usesTotal = action.uses.total || action.uses.value || action.uses;\r\n    // Prefer usesLeft from DiceCloud if available, otherwise calculate from usesUsed\r\n    const usesRemaining = action.usesLeft !== undefined ? action.usesLeft : (usesTotal - usesUsed);\r\n    const usesText = `${usesRemaining} / ${usesTotal}`;\r\n    message += ` {{Uses=${usesText}}}`;\r\n  }\r\n\r\n  // Send to Roll20 chat\r\n  const messageData = {\r\n    action: 'announceSpell',\r\n    message: message,\r\n    color: characterData.notificationColor\r\n  };\r\n\r\n  // Try window.opener first (Chrome)\r\n  if (window.opener && !window.opener.closed) {\r\n    try {\r\n      window.opener.postMessage(messageData, '*');\r\n      showNotification(`\u2728 ${action.name} used!`);\r\n      debug.log('\u2705 Action announcement sent via window.opener');\r\n      return;\r\n    } catch (error) {\r\n      debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n    }\r\n  }\r\n\r\n  // Fallback: Use background script to relay to Roll20 (Firefox)\r\n  debug.log('\uD83D\uDCE1 Using background script to relay action announcement to Roll20...');\r\n  browserAPI.runtime.sendMessage({\r\n    action: 'relayRollToRoll20',\r\n    roll: messageData\r\n  }, (response) => {\r\n    if (browserAPI.runtime.lastError) {\r\n      debug.error('\u274C Error relaying action announcement:', browserAPI.runtime.lastError);\r\n      showNotification('\u274C Failed to announce action');\r\n    } else if (response && response.success) {\r\n      debug.log('\u2705 Action announcement relayed to Roll20');\r\n      showNotification(`\u2728 ${action.name} used!`);\r\n    }\r\n  });\r\n}\r\n\r\nfunction createColorPalette(selectedColor) {\r\n  const colors = [\r\n    { name: 'Blue', value: '#3498db', emoji: '\uD83D\uDD35' },\r\n    { name: 'Red', value: '#e74c3c', emoji: '\uD83D\uDD34' },\r\n    { name: 'Green', value: '#27ae60', emoji: '\uD83D\uDFE2' },\r\n    { name: 'Purple', value: '#9b59b6', emoji: '\uD83D\uDFE3' },\r\n    { name: 'Orange', value: '#e67e22', emoji: '\uD83D\uDFE0' },\r\n    { name: 'Teal', value: '#1abc9c', emoji: '\uD83D\uDCA0' },\r\n    { name: 'Pink', value: '#e91e63', emoji: '\uD83D\uDC96' },\r\n    { name: 'Yellow', value: '#f1c40f', emoji: '\uD83D\uDFE1' },\r\n    { name: 'Grey', value: '#95a5a6', emoji: '\u26AA' },\r\n    { name: 'Black', value: '#34495e', emoji: '\u26AB' },\r\n    { name: 'Brown', value: '#8b4513', emoji: '\uD83D\uDFE4' }\r\n  ];\r\n\r\n  return colors.map(color => {\r\n    const isSelected = color.value === selectedColor;\r\n    return `\r\n      <div class=\"color-swatch\"\r\n           data-color=\"${color.value}\"\r\n           style=\"font-size: 1.5em; cursor: pointer; transition: all 0.2s; opacity: ${isSelected ? '1' : '0.85'}; transform: ${isSelected ? 'scale(1.15)' : 'scale(1)'}; filter: ${isSelected ? 'drop-shadow(0 0 4px white)' : 'none'}; text-align: center;\"\r\n           title=\"${color.name}\">${color.emoji}</div>\r\n    `;\r\n  }).join('');\r\n}\r\n\r\n// Global flag to track if document-level click listener has been added\r\nlet colorPaletteDocumentListenerAdded = false;\r\n\r\nfunction initColorPalette() {\r\n  // Set default color if not set\r\n  if (!characterData.notificationColor) {\r\n    characterData.notificationColor = '#3498db';\r\n  }\r\n\r\n  const toggleBtnOld = document.getElementById('color-toggle');\r\n  const palette = document.getElementById('color-palette');\r\n\r\n  if (!toggleBtnOld || !palette) return;\r\n\r\n  // Clone and replace toggle button to remove old listeners\r\n  const toggleBtn = toggleBtnOld.cloneNode(true);\r\n  toggleBtnOld.parentNode.replaceChild(toggleBtn, toggleBtnOld);\r\n\r\n  // Toggle palette visibility\r\n  toggleBtn.addEventListener('click', (e) => {\r\n    e.stopPropagation();\r\n    const isVisible = palette.style.display === 'grid';\r\n    palette.style.display = isVisible ? 'none' : 'grid';\r\n  });\r\n\r\n  // Add document-level click listener only once\r\n  if (!colorPaletteDocumentListenerAdded) {\r\n    // Close palette when clicking outside\r\n    document.addEventListener('click', (e) => {\r\n      const currentToggleBtn = document.getElementById('color-toggle');\r\n      const currentPalette = document.getElementById('color-palette');\r\n      if (currentPalette && currentToggleBtn) {\r\n        if (!currentPalette.contains(e.target) && e.target !== currentToggleBtn && !currentToggleBtn.contains(e.target)) {\r\n          currentPalette.style.display = 'none';\r\n        }\r\n      }\r\n    });\r\n    colorPaletteDocumentListenerAdded = true;\r\n    debug.log('\uD83C\uDFA8 Added document-level color palette click listener');\r\n  }\r\n\r\n  // Add click handlers to color swatches\r\n  document.querySelectorAll('.color-swatch').forEach(swatch => {\r\n    swatch.addEventListener('click', (e) => {\r\n      const newColor = e.target.dataset.color;\r\n      const oldColor = characterData.notificationColor;\r\n      characterData.notificationColor = newColor;\r\n\r\n      // Update all swatches appearance\r\n      document.querySelectorAll('.color-swatch').forEach(s => {\r\n        const isSelected = s.dataset.color === newColor;\r\n        s.style.opacity = isSelected ? '1' : '0.6';\r\n        s.style.transform = isSelected ? 'scale(1.2)' : 'scale(1)';\r\n        s.style.filter = isSelected ? 'drop-shadow(0 0 4px white)' : 'none';\r\n      });\r\n\r\n      // Update the toggle button emoji (using current element in DOM)\r\n      const newEmoji = getColorEmoji(newColor);\r\n      const colorEmojiEl = document.getElementById('color-emoji');\r\n      if (colorEmojiEl) {\r\n        colorEmojiEl.textContent = newEmoji;\r\n      }\r\n\r\n      // Close the palette\r\n      palette.style.display = 'none';\r\n\r\n      // Save to storage\r\n      saveCharacterData();\r\n      \r\n      // Sync to Supabase if available\r\n      syncColorToSupabase(newColor);\r\n      \r\n      showNotification(`\uD83C\uDFA8 Notification color changed to ${e.target.title}!`);\r\n    });\r\n  });\r\n}\r\n\r\n// Sync color selection to Supabase\r\nasync function syncColorToSupabase(color) {\r\n  try {\r\n    // Send message to background script to sync to Supabase\r\n    const response = await browserAPI.runtime.sendMessage({\r\n      action: 'syncCharacterColor',\r\n      characterId: characterData.id,\r\n      color: color\r\n    });\r\n    \r\n    if (response && response.success) {\r\n      debug.log('\uD83C\uDFA8 Color synced to Supabase successfully');\r\n    } else {\r\n      debug.warn('\u26A0\uFE0F Failed to sync color to Supabase:', response?.error);\r\n    }\r\n  } catch (error) {\r\n    debug.warn('\u26A0\uFE0F Error syncing color to Supabase:', error);\r\n  }\r\n}\r\n\r\n// Debounce timer for sync messages\r\nlet syncDebounceTimer = null;\r\n\r\nfunction saveCharacterData() {\r\n  // CRITICAL: Save to browser storage to persist through refresh/close\r\n  browserAPI.runtime.sendMessage({\r\n    action: 'storeCharacterData',\r\n    data: characterData,\r\n    slotId: currentSlotId  // CRITICAL: Pass slotId for proper persistence\r\n  }).then(() => {\r\n    debug.log(`\uD83D\uDCBE Saved character data to browser storage (slotId: ${currentSlotId})`);\r\n  }).catch(err => {\r\n    debug.error('\u274C Failed to save character data:', err);\r\n  });\r\n\r\n  // Debounce sync messages to prevent flickering\r\n  // Clear any pending sync\r\n  if (syncDebounceTimer) {\r\n    clearTimeout(syncDebounceTimer);\r\n  }\r\n\r\n  // Schedule sync after a short delay\r\n  syncDebounceTimer = setTimeout(() => {\r\n    sendSyncMessage();\r\n    syncDebounceTimer = null;\r\n  }, 300); // 300ms debounce delay\r\n}\r\n\r\nfunction sendSyncMessage() {\r\n  // Send sync message to DiceCloud if experimental sync is available\r\n  // Always send sync messages in experimental build - they'll be handled by Roll20 content script\r\n  debug.log('\uD83D\uDD04 Sending character data update to DiceCloud sync...');\r\n\r\n  // Extract Channel Divinity from characterData.resources array (this has the current values after use)\r\n  let channelDivinityForSync = null;\r\n  const channelDivinityResource = characterData.resources?.find(r =>\r\n    r.name === 'Channel Divinity' ||\r\n    r.variableName === 'channelDivinityCleric' ||\r\n    r.variableName === 'channelDivinityPaladin' ||\r\n    r.variableName === 'channelDivinity' ||\r\n    r.varName === 'channelDivinity'\r\n  );\r\n  if (channelDivinityResource) {\r\n    channelDivinityForSync = {\r\n      current: channelDivinityResource.current || 0,\r\n      max: channelDivinityResource.max || 0\r\n    };\r\n  }\r\n\r\n  // Use the existing resources array which contains current values\r\n  const resourcesForSync = characterData.resources || [];\r\n\r\n  // Debug logging to see what we're sending\r\n  console.log('[SYNC DEBUG] ========== SYNC MESSAGE DATA ==========');\r\n  console.log('[SYNC DEBUG] Character Name:', characterData.name);\r\n  console.log('[SYNC DEBUG] HP:', characterData.hitPoints?.current, '/', characterData.hitPoints?.max);\r\n  console.log('[SYNC DEBUG] Temp HP:', characterData.temporaryHP);\r\n  console.log('[SYNC DEBUG] Spell Slots:', characterData.spellSlots);\r\n  console.log('[SYNC DEBUG] Channel Divinity (extracted):', channelDivinityForSync);\r\n  console.log('[SYNC DEBUG] Channel Divinity (raw resource):', channelDivinityResource);\r\n  console.log('[SYNC DEBUG] Resources (count):', resourcesForSync?.length);\r\n  console.log('[SYNC DEBUG] Resources (full):', resourcesForSync);\r\n  console.log('[SYNC DEBUG] Actions (count):', characterData.actions?.length);\r\n  console.log('[SYNC DEBUG] Actions (full):', characterData.actions);\r\n  console.log('[SYNC DEBUG] Death Saves:', characterData.deathSaves);\r\n  console.log('[SYNC DEBUG] Inspiration:', characterData.inspiration);\r\n  console.log('[SYNC DEBUG] =========================================');\r\n\r\n  const syncMessage = {\r\n    type: 'characterDataUpdate',\r\n    characterData: {\r\n      name: characterData.name,\r\n      hp: characterData.hitPoints.current,\r\n      tempHp: characterData.temporaryHP || 0,\r\n      maxHp: characterData.hitPoints.max,\r\n      spellSlots: characterData.spellSlots || {},\r\n      channelDivinity: channelDivinityForSync,\r\n      resources: resourcesForSync,\r\n      actions: characterData.actions || [],\r\n      deathSaves: characterData.deathSaves,\r\n      inspiration: characterData.inspiration,\r\n      lastRoll: characterData.lastRoll\r\n    }\r\n  };\r\n  \r\n  // Try to send to Roll20 content script\r\n  window.postMessage(syncMessage, '*');\r\n  \r\n  // Also try to send via opener if available\r\n  if (window.opener && !window.opener.closed) {\r\n    window.opener.postMessage(syncMessage, '*');\r\n  }\r\n\r\n  // Also send to window opener if available (for backwards compatibility)\r\n  if (window.opener && !window.opener.closed) {\r\n    window.opener.postMessage({\r\n      action: 'updateCharacterData',\r\n      data: characterData\r\n    }, '*');\r\n    debug.log('\uD83D\uDCBE Sent character data update to parent window');\r\n\r\n    // Also send player data to GM Panel for overview tracking\r\n    window.opener.postMessage({\r\n      action: 'updatePlayerData',\r\n      characterName: characterData.name,\r\n      data: {\r\n        hp: characterData.hp,\r\n        maxHp: characterData.maxHp,\r\n        ac: characterData.ac,\r\n        passivePerception: characterData.passivePerception || (10 + (characterData.perception || 0)),\r\n        initiative: characterData.initiative,\r\n        conditions: characterData.conditions || [],\r\n        concentration: characterData.concentration || null,\r\n        deathSaves: characterData.deathSaves || null\r\n      }\r\n    }, '*');\r\n    debug.log('\uD83D\uDC65 Sent player data update to GM Panel');\r\n  }\r\n}\r\n\r\nfunction resolveVariablesInFormula(formula) {\r\n  if (!formula || typeof formula !== 'string') {\r\n    return formula;\r\n  }\r\n\r\n  debug.log(`\uD83D\uDD27 resolveVariablesInFormula called with: \"${formula}\"`);\r\n\r\n  // Check if characterData has otherVariables\r\n  if (!characterData.otherVariables || typeof characterData.otherVariables !== 'object') {\r\n    debug.log('\u26A0\uFE0F No otherVariables available for formula resolution');\r\n    return formula;\r\n  }\r\n\r\n  let resolvedFormula = formula;\r\n  let variablesResolved = [];\r\n\r\n  // Pattern 0: Check if the entire formula is just a bare variable name (e.g., \"breathWeaponDamage\")\r\n  // This must be checked BEFORE other patterns to handle cases like action.damage = \"breathWeaponDamage\"\r\n  const bareVariablePattern = /^[a-zA-Z_][a-zA-Z0-9_.]*$/;\r\n  if (bareVariablePattern.test(formula.trim())) {\r\n    const varName = formula.trim();\r\n    if (characterData.otherVariables.hasOwnProperty(varName)) {\r\n      const variableValue = characterData.otherVariables[varName];\r\n\r\n      // Extract the value\r\n      let value = null;\r\n      if (typeof variableValue === 'number') {\r\n        value = variableValue;\r\n      } else if (typeof variableValue === 'string') {\r\n        value = variableValue;\r\n      } else if (typeof variableValue === 'object' && variableValue.value !== undefined) {\r\n        value = variableValue.value;\r\n      }\r\n\r\n      if (value !== null && value !== undefined) {\r\n        debug.log(`\u2705 Resolved bare variable: ${varName} = ${value}`);\r\n        return String(value);\r\n      }\r\n    }\r\n    debug.log(`\u26A0\uFE0F Bare variable not found in otherVariables: ${varName}`);\r\n  }\r\n\r\n  // Helper function to get variable value (handles dot notation like \"bard.level\")\r\n  const getVariableValue = (varPath) => {\r\n    // Strip # prefix if present (DiceCloud reference notation)\r\n    const cleanPath = varPath.startsWith('#') ? varPath.substring(1) : varPath;\r\n\r\n    // Handle special DiceCloud spell references (e.g., \"spellList.abilityMod\")\r\n    // These reference the spellcasting ability modifier for the character's class\r\n    if (cleanPath === 'spellList.abilityMod' || cleanPath === 'spellList.ability') {\r\n      // Determine spellcasting ability based on character class\r\n      const charClass = (characterData.class || '').toLowerCase();\r\n      let spellcastingAbility = null;\r\n\r\n      // Map classes to their spellcasting abilities\r\n      if (charClass.includes('cleric') || charClass.includes('druid') || charClass.includes('ranger')) {\r\n        spellcastingAbility = 'wisdom';\r\n      } else if (charClass.includes('wizard') || charClass.includes('artificer')) {\r\n        spellcastingAbility = 'intelligence';\r\n      } else if (charClass.includes('bard') || charClass.includes('paladin') || charClass.includes('sorcerer') || charClass.includes('warlock')) {\r\n        spellcastingAbility = 'charisma';\r\n      }\r\n\r\n      // Return the modifier for the spellcasting ability\r\n      if (spellcastingAbility && characterData.attributeMods && characterData.attributeMods[spellcastingAbility] !== undefined) {\r\n        const modifier = characterData.attributeMods[spellcastingAbility];\r\n        debug.log(`\u2705 Resolved ${cleanPath} to ${spellcastingAbility} modifier: ${modifier}`);\r\n        return modifier;\r\n      }\r\n    }\r\n\r\n    // Handle spellList.dc (spell save DC)\r\n    if (cleanPath === 'spellList.dc') {\r\n      // Spell Save DC = 8 + proficiency bonus + spellcasting ability modifier\r\n      const profBonus = characterData.proficiencyBonus || 0;\r\n      const spellMod = getVariableValue('#spellList.abilityMod');\r\n      if (spellMod !== null) {\r\n        const spellDC = 8 + profBonus + spellMod;\r\n        debug.log(`\u2705 Calculated spell DC: 8 + ${profBonus} + ${spellMod} = ${spellDC}`);\r\n        return spellDC;\r\n      }\r\n    }\r\n\r\n    // Handle spellList.attackBonus (spell attack bonus)\r\n    if (cleanPath === 'spellList.attackBonus') {\r\n      // Spell Attack Bonus = proficiency bonus + spellcasting ability modifier\r\n      const profBonus = characterData.proficiencyBonus || 0;\r\n      const spellMod = getVariableValue('#spellList.abilityMod');\r\n      if (spellMod !== null) {\r\n        const attackBonus = profBonus + spellMod;\r\n        debug.log(`\u2705 Calculated spell attack bonus: ${profBonus} + ${spellMod} = ${attackBonus}`);\r\n        return attackBonus;\r\n      }\r\n    }\r\n\r\n    // Try direct lookup first\r\n    if (characterData.otherVariables.hasOwnProperty(cleanPath)) {\r\n      const val = characterData.otherVariables[cleanPath];\r\n      if (typeof val === 'number') return val;\r\n      if (typeof val === 'boolean') return val;\r\n      if (typeof val === 'object' && val.value !== undefined) return val.value;\r\n      if (typeof val === 'string') return val;\r\n    }\r\n\r\n    // Try converting dot notation (e.g., \"bard.level\" -> \"bardLevel\")\r\n    const camelCase = cleanPath.replace(/\\.([a-z])/g, (_, letter) => letter.toUpperCase());\r\n    if (characterData.otherVariables.hasOwnProperty(camelCase)) {\r\n      const val = characterData.otherVariables[camelCase];\r\n      if (typeof val === 'number') return val;\r\n      if (typeof val === 'boolean') return val;\r\n      if (typeof val === 'object' && val.value !== undefined) return val.value;\r\n    }\r\n\r\n    // Try other common patterns\r\n    const alternatives = [\r\n      cleanPath.replace(/\\./g, ''), // Remove dots\r\n      cleanPath.split('.').pop(), // Just the last part\r\n      cleanPath.replace(/\\./g, '_') // Underscores instead\r\n    ];\r\n\r\n    for (const alt of alternatives) {\r\n      if (characterData.otherVariables.hasOwnProperty(alt)) {\r\n        const val = characterData.otherVariables[alt];\r\n        if (typeof val === 'number') return val;\r\n        if (typeof val === 'boolean') return val;\r\n        if (typeof val === 'object' && val.value !== undefined) return val.value;\r\n      }\r\n    }\r\n\r\n    return null;\r\n  };\r\n\r\n  // Pattern 1a: Find DiceCloud references in parentheses like (#spellList.abilityMod)\r\n  const diceCloudRefPattern = /\\((#[a-zA-Z_][a-zA-Z0-9_.]*)\\)/g;\r\n  let match;\r\n\r\n  while ((match = diceCloudRefPattern.exec(formula)) !== null) {\r\n    const varRef = match[1]; // e.g., \"#spellList.abilityMod\"\r\n    const fullMatch = match[0]; // e.g., \"(#spellList.abilityMod)\"\r\n\r\n    // Use getVariableValue which handles # prefix and dot notation\r\n    const value = getVariableValue(varRef);\r\n\r\n    if (value !== null && typeof value === 'number') {\r\n      resolvedFormula = resolvedFormula.replace(fullMatch, value);\r\n      variablesResolved.push(`${varRef}=${value}`);\r\n      debug.log(`\u2705 Resolved DiceCloud reference: ${varRef} = ${value}`);\r\n    } else {\r\n      debug.log(`\u26A0\uFE0F Could not resolve DiceCloud reference: ${varRef}, value: ${value}`);\r\n    }\r\n  }\r\n\r\n  // Pattern 1b: Find simple variables in parentheses like (variableName)\r\n  const parenthesesPattern = /\\(([a-zA-Z_][a-zA-Z0-9_]*)\\)/g;\r\n\r\n  while ((match = parenthesesPattern.exec(formula)) !== null) {\r\n    const variableName = match[1];\r\n    const fullMatch = match[0]; // e.g., \"(sneakAttackDieAmount)\"\r\n\r\n    // Look up the variable value\r\n    if (characterData.otherVariables.hasOwnProperty(variableName)) {\r\n      const variableValue = characterData.otherVariables[variableName];\r\n\r\n      // Extract numeric value\r\n      let numericValue = null;\r\n      if (typeof variableValue === 'number') {\r\n        numericValue = variableValue;\r\n      } else if (typeof variableValue === 'object' && variableValue.value !== undefined) {\r\n        numericValue = variableValue.value;\r\n      }\r\n\r\n      if (numericValue !== null) {\r\n        resolvedFormula = resolvedFormula.replace(fullMatch, numericValue);\r\n        variablesResolved.push(`${variableName}=${numericValue}`);\r\n        debug.log(`\u2705 Resolved variable: ${variableName} = ${numericValue}`);\r\n      } else {\r\n        debug.log(`\u26A0\uFE0F Could not extract numeric value from variable: ${variableName}`, variableValue);\r\n      }\r\n    } else {\r\n      debug.log(`\u26A0\uFE0F Variable not found in otherVariables: ${variableName}`);\r\n    }\r\n  }\r\n\r\n  // Pattern 2: Handle math functions like ceil{expression}, floor{expression}, etc.\r\n  const mathFuncPattern = /(ceil|floor|round|abs)\\{([^}]+)\\}/gi;\r\n\r\n  while ((match = mathFuncPattern.exec(resolvedFormula)) !== null) {\r\n    const funcName = match[1].toLowerCase();\r\n    const expression = match[2];\r\n    const fullMatch = match[0]; // e.g., \"ceil{proficiencyBonus/2}\"\r\n\r\n    // Replace variables in the expression\r\n    let evalExpression = expression;\r\n    for (const varName in characterData.otherVariables) {\r\n      if (evalExpression.includes(varName)) {\r\n        const variableValue = characterData.otherVariables[varName];\r\n        let value = null;\r\n\r\n        if (typeof variableValue === 'number') {\r\n          value = variableValue;\r\n        } else if (typeof variableValue === 'object' && variableValue.value !== undefined) {\r\n          value = variableValue.value;\r\n        }\r\n\r\n        if (value !== null && typeof value === 'number') {\r\n          evalExpression = evalExpression.replace(new RegExp(varName, 'g'), value);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Evaluate the expression with the appropriate math function\r\n    try {\r\n      if (/^[\\d\\s+\\-*/().]+$/.test(evalExpression)) {\r\n        const evalResult = eval(evalExpression);\r\n        let result;\r\n\r\n        switch (funcName) {\r\n          case 'ceil':\r\n            result = Math.ceil(evalResult);\r\n            break;\r\n          case 'floor':\r\n            result = Math.floor(evalResult);\r\n            break;\r\n          case 'round':\r\n            result = Math.round(evalResult);\r\n            break;\r\n          case 'abs':\r\n            result = Math.abs(evalResult);\r\n            break;\r\n          default:\r\n            result = evalResult;\r\n        }\r\n\r\n        resolvedFormula = resolvedFormula.replace(fullMatch, result);\r\n        variablesResolved.push(`${funcName}{${expression}}=${result}`);\r\n        debug.log(`\u2705 Resolved math function: ${funcName}{${expression}} = ${result}`);\r\n      }\r\n    } catch (e) {\r\n      debug.log(`\u26A0\uFE0F Failed to evaluate ${funcName}{${expression}}`, e);\r\n    }\r\n  }\r\n\r\n  // Pattern 2.5: Handle max/min functions outside of curly braces (e.g., \"1d6+max(strengthModifier, dexterityModifier)\")\r\n  // Helper function to find matching closing parenthesis\r\n  function findMatchingParen(str, startIndex) {\r\n    let depth = 1;\r\n    for (let i = startIndex; i < str.length; i++) {\r\n      if (str[i] === '(') depth++;\r\n      else if (str[i] === ')') {\r\n        depth--;\r\n        if (depth === 0) return i;\r\n      }\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  // Helper function to split arguments respecting nested parentheses\r\n  function splitArgs(argsString) {\r\n    const args = [];\r\n    let currentArg = '';\r\n    let depth = 0;\r\n\r\n    for (let i = 0; i < argsString.length; i++) {\r\n      const char = argsString[i];\r\n      if (char === '(') {\r\n        depth++;\r\n        currentArg += char;\r\n      } else if (char === ')') {\r\n        depth--;\r\n        currentArg += char;\r\n      } else if (char === ',' && depth === 0) {\r\n        args.push(currentArg.trim());\r\n        currentArg = '';\r\n      } else {\r\n        currentArg += char;\r\n      }\r\n    }\r\n\r\n    if (currentArg) {\r\n      args.push(currentArg.trim());\r\n    }\r\n\r\n    return args;\r\n  }\r\n\r\n  debug.log(`\uD83D\uDD0D Looking for max/min in formula: \"${resolvedFormula}\"`);\r\n\r\n  const maxMinPattern = /(max|min)\\(/gi;\r\n\r\n  while ((match = maxMinPattern.exec(resolvedFormula)) !== null) {\r\n    const func = match[1].toLowerCase();\r\n    const funcStart = match.index;\r\n    const argsStart = funcStart + match[0].length;\r\n\r\n    // Find the matching closing parenthesis\r\n    const closingParen = findMatchingParen(resolvedFormula, argsStart);\r\n    if (closingParen === -1) {\r\n      debug.log(`\u26A0\uFE0F No matching closing parenthesis for ${func} at position ${funcStart}`);\r\n      continue;\r\n    }\r\n\r\n    const argsString = resolvedFormula.substring(argsStart, closingParen);\r\n    const fullMatch = resolvedFormula.substring(funcStart, closingParen + 1);\r\n    debug.log(`\uD83D\uDD0D Found max/min match: ${func}(${argsString})`)\r\n\r\n    try {\r\n      const args = splitArgs(argsString).map(arg => {\r\n        const trimmed = arg;\r\n        debug.log(`\uD83D\uDD0D Resolving arg: \"${trimmed}\"`);\r\n\r\n        // Try to parse as number first\r\n        const num = parseFloat(trimmed);\r\n        if (!isNaN(num)) {\r\n          debug.log(`  \u2705 Parsed as number: ${num}`);\r\n          return num;\r\n        }\r\n\r\n        // Try to resolve as simple variable\r\n        const varVal = getVariableValue(trimmed);\r\n        debug.log(`  \uD83D\uDD0D Variable lookup result: ${varVal}`);\r\n        if (varVal !== null && typeof varVal === 'number') {\r\n          debug.log(`  \u2705 Resolved as variable: ${varVal}`);\r\n          return varVal;\r\n        }\r\n\r\n        // Try to evaluate as expression (e.g., \"strength.modifier\")\r\n        let evalExpression = trimmed;\r\n        const varPattern = /[a-zA-Z_][a-zA-Z0-9_.]*/g;\r\n        let varMatch;\r\n        const replacements = [];\r\n\r\n        while ((varMatch = varPattern.exec(trimmed)) !== null) {\r\n          const varName = varMatch[0];\r\n          const value = getVariableValue(varName);\r\n          if (value !== null && typeof value === 'number') {\r\n            replacements.push({ name: varName, value: value });\r\n          }\r\n        }\r\n\r\n        // Sort by length (longest first) to avoid partial replacements\r\n        replacements.sort((a, b) => b.name.length - a.name.length);\r\n\r\n        for (const {name, value} of replacements) {\r\n          evalExpression = evalExpression.replace(new RegExp(name.replace(/\\./g, '\\\\.'), 'g'), value);\r\n        }\r\n\r\n        // Handle math functions (ceil, floor, round, abs) in the expression\r\n        evalExpression = evalExpression.replace(/ceil\\(/g, 'Math.ceil(');\r\n        evalExpression = evalExpression.replace(/floor\\(/g, 'Math.floor(');\r\n        evalExpression = evalExpression.replace(/round\\(/g, 'Math.round(');\r\n        evalExpression = evalExpression.replace(/abs\\(/g, 'Math.abs(');\r\n\r\n        // Try to evaluate\r\n        try {\r\n          if (/^[\\d\\s+\\-*/().Math]+$/.test(evalExpression)) {\r\n            const result = eval(evalExpression);\r\n            debug.log(`  \u2705 Evaluated expression \"${trimmed}\" = ${result}`);\r\n            return result;\r\n          }\r\n        } catch (e) {\r\n          debug.log(`  \u274C Failed to evaluate: \"${trimmed}\"`, e);\r\n        }\r\n\r\n        debug.log(`  \u274C Could not resolve: \"${trimmed}\"`);\r\n        return null;\r\n      }).filter(v => v !== null);\r\n\r\n      if (args.length > 0) {\r\n        const result = func === 'max' ? Math.max(...args) : Math.min(...args);\r\n        resolvedFormula = resolvedFormula.replace(fullMatch, result);\r\n        variablesResolved.push(`${func}(...)=${result}`);\r\n        debug.log(`\u2705 Resolved ${func} function: ${fullMatch} = ${result}`);\r\n        // Reset regex lastIndex since we modified the string\r\n        maxMinPattern.lastIndex = 0;\r\n      }\r\n    } catch (e) {\r\n      debug.log(`\u26A0\uFE0F Failed to resolve ${func} function: ${fullMatch}`, e);\r\n    }\r\n  }\r\n\r\n  // Pattern 2.5: Handle ternary conditionals in parentheses for dice formulas like (condition?value1:value2)d6\r\n  const parenTernaryPattern = /\\(([^)]+\\?[^)]+:[^)]+)\\)/g;\r\n\r\n  while ((match = parenTernaryPattern.exec(resolvedFormula)) !== null) {\r\n    const expression = match[1];\r\n    const fullMatch = match[0];\r\n\r\n    // Check if this is a ternary conditional\r\n    if (expression.includes('?') && expression.includes(':')) {\r\n      const ternaryParts = expression.match(/^(.+?)\\s*\\?\\s*(.+?)\\s*:\\s*(.+?)$/);\r\n      if (ternaryParts) {\r\n        const condition = ternaryParts[1].trim();\r\n        const trueValue = ternaryParts[2].trim();\r\n        const falseValue = ternaryParts[3].trim();\r\n\r\n        // Evaluate the condition\r\n        let conditionResult = false;\r\n        const varValue = getVariableValue(condition);\r\n        if (varValue !== null) {\r\n          conditionResult = Boolean(varValue);\r\n          debug.log(`\u2705 Evaluated parentheses ternary condition: ${condition} = ${conditionResult}`);\r\n        }\r\n\r\n        // Choose the appropriate value\r\n        const chosenValue = conditionResult ? trueValue : falseValue;\r\n\r\n        // Replace the entire match with the chosen value\r\n        resolvedFormula = resolvedFormula.replace(fullMatch, chosenValue);\r\n        variablesResolved.push(`(${condition}?${trueValue}:${falseValue}) = ${chosenValue}`);\r\n        debug.log(`\u2705 Resolved parentheses ternary: (${expression}) => ${chosenValue}`);\r\n\r\n        // Reset regex lastIndex since we modified the string\r\n        parenTernaryPattern.lastIndex = 0;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Pattern 3: Find variables/expressions in curly braces like {variableName} or {3*cleric.level}\r\n  const bracesPattern = /\\{([^}]+)\\}/g;\r\n\r\n  while ((match = bracesPattern.exec(resolvedFormula)) !== null) {\r\n    const expression = match[1];\r\n    const fullMatch = match[0];\r\n\r\n    // Strip markdown formatting\r\n    let cleanExpr = expression.replace(/\\*\\*/g, '');\r\n\r\n    // Handle ternary operators: {condition ? trueValue : falseValue}\r\n    // First try complex ternary with concatenation and functions: level >= 5 ? \"+ \" + floor((level+1)/6) + \"d8\" : \"\"\r\n    const complexTernaryPattern = /^(.+?)\\s*\\?\\s*(.+?)\\s*:\\s*(.+?)$/;\r\n    const complexTernaryMatch = cleanExpr.match(complexTernaryPattern);\r\n    if (complexTernaryMatch && cleanExpr.includes('?') && cleanExpr.includes(':')) {\r\n      const condition = complexTernaryMatch[1].trim();\r\n      const trueBranch = complexTernaryMatch[2].trim();\r\n      const falseBranch = complexTernaryMatch[3].trim();\r\n\r\n      // Evaluate the condition\r\n      let conditionResult = false;\r\n      try {\r\n        // Check if condition is just a simple variable name\r\n        const simpleVarPattern = /^[a-zA-Z_][a-zA-Z0-9_.]*$/;\r\n        if (simpleVarPattern.test(condition.trim())) {\r\n          const varValue = getVariableValue(condition.trim());\r\n          if (varValue !== null) {\r\n            // Convert to boolean: numbers, strings, booleans\r\n            conditionResult = Boolean(varValue);\r\n          } else {\r\n            // Variable doesn't exist, treat as false\r\n            conditionResult = false;\r\n          }\r\n          debug.log(`\u2705 Evaluated simple variable condition: ${condition} = ${conditionResult}`);\r\n        } else {\r\n          // Complex condition with operators\r\n          // Replace variables in condition\r\n          let evalCondition = condition;\r\n          const varPattern = /[a-zA-Z_][a-zA-Z0-9_.]*/g;\r\n          let varMatch;\r\n          const replacements = [];\r\n\r\n          while ((varMatch = varPattern.exec(condition)) !== null) {\r\n            const varName = varMatch[0];\r\n            // Skip reserved words\r\n            if (['true', 'false', 'null', 'undefined'].includes(varName.toLowerCase())) {\r\n              continue;\r\n            }\r\n            const value = getVariableValue(varName);\r\n            if (value !== null) {\r\n              // Handle numbers, strings, and booleans\r\n              if (typeof value === 'number') {\r\n                replacements.push({ name: varName, value: value });\r\n              } else if (typeof value === 'boolean') {\r\n                replacements.push({ name: varName, value: value });\r\n              } else if (typeof value === 'string') {\r\n                // Convert string to boolean for condition evaluation\r\n                const boolValue = value !== '' && value !== '0' && value.toLowerCase() !== 'false';\r\n                replacements.push({ name: varName, value: boolValue });\r\n              }\r\n            } else {\r\n              // Variable doesn't exist, replace with false\r\n              replacements.push({ name: varName, value: false });\r\n            }\r\n          }\r\n\r\n          // Sort by length (longest first) to avoid partial replacements\r\n          replacements.sort((a, b) => b.name.length - a.name.length);\r\n\r\n          for (const {name, value} of replacements) {\r\n            evalCondition = evalCondition.replace(new RegExp(name.replace(/\\./g, '\\\\.'), 'g'), value);\r\n          }\r\n\r\n          // Evaluate condition\r\n          if (/^[\\w\\s+\\-*/><=!&|()\\.]+$/.test(evalCondition)) {\r\n            conditionResult = eval(evalCondition);\r\n          }\r\n        }\r\n      } catch (e) {\r\n        debug.log(`\u26A0\uFE0F Failed to evaluate ternary condition: ${condition}`, e);\r\n      }\r\n\r\n      // Evaluate the chosen branch\r\n      const chosenBranch = conditionResult ? trueBranch : falseBranch;\r\n      let result = '';\r\n\r\n      try {\r\n        // Handle string concatenation with + operator\r\n        // Pattern: \"string\" + expression + \"string\"\r\n        if (chosenBranch.includes('+')) {\r\n          const parts = [];\r\n          let current = '';\r\n          let inString = false;\r\n          let i = 0;\r\n\r\n          while (i < chosenBranch.length) {\r\n            const char = chosenBranch[i];\r\n\r\n            if (char === '\"') {\r\n              if (inString) {\r\n                // End of string\r\n                parts.push({ type: 'string', value: current });\r\n                current = '';\r\n                inString = false;\r\n              } else {\r\n                // Start of string\r\n                inString = true;\r\n              }\r\n              i++;\r\n            } else if (char === '+' && !inString) {\r\n              // Operator outside string\r\n              if (current.trim()) {\r\n                parts.push({ type: 'expr', value: current.trim() });\r\n                current = '';\r\n              }\r\n              i++;\r\n            } else {\r\n              current += char;\r\n              i++;\r\n            }\r\n          }\r\n\r\n          // Add remaining part\r\n          if (current.trim()) {\r\n            if (inString) {\r\n              parts.push({ type: 'string', value: current });\r\n            } else {\r\n              parts.push({ type: 'expr', value: current.trim() });\r\n            }\r\n          }\r\n\r\n          // Evaluate each part and concatenate\r\n          for (const part of parts) {\r\n            if (part.type === 'string') {\r\n              result += part.value;\r\n            } else {\r\n              // Evaluate expression (may contain floor(), variables, etc.)\r\n              let exprResult = part.value;\r\n\r\n              // Handle floor() function\r\n              const floorMatch = exprResult.match(/floor\\(([^)]+)\\)/);\r\n              if (floorMatch) {\r\n                const floorExpr = floorMatch[1];\r\n                // Resolve variables in floor expression\r\n                let evalExpr = floorExpr;\r\n                const varPattern = /[a-zA-Z_][a-zA-Z0-9_.]*/g;\r\n                let varMatch;\r\n                const replacements = [];\r\n\r\n                while ((varMatch = varPattern.exec(floorExpr)) !== null) {\r\n                  const varName = varMatch[0];\r\n                  const value = getVariableValue(varName);\r\n                  if (value !== null && typeof value === 'number') {\r\n                    replacements.push({ name: varName, value: value });\r\n                  }\r\n                }\r\n\r\n                replacements.sort((a, b) => b.name.length - a.name.length);\r\n                for (const {name, value} of replacements) {\r\n                  evalExpr = evalExpr.replace(new RegExp(name.replace(/\\./g, '\\\\.'), 'g'), value);\r\n                }\r\n\r\n                if (/^[\\d\\s+\\-*/().]+$/.test(evalExpr)) {\r\n                  const floorResult = Math.floor(eval(evalExpr));\r\n                  exprResult = exprResult.replace(floorMatch[0], floorResult);\r\n                }\r\n              }\r\n\r\n              // Try to resolve as variable or evaluate\r\n              const varValue = getVariableValue(exprResult);\r\n              if (varValue !== null) {\r\n                result += varValue;\r\n              } else if (/^[\\d\\s+\\-*/().]+$/.test(exprResult)) {\r\n                result += eval(exprResult);\r\n              } else {\r\n                result += exprResult;\r\n              }\r\n            }\r\n          }\r\n        } else if (chosenBranch.startsWith('\"') && chosenBranch.endsWith('\"')) {\r\n          // Simple quoted string\r\n          result = chosenBranch.slice(1, -1);\r\n        } else {\r\n          // Try to evaluate as expression\r\n          result = chosenBranch;\r\n        }\r\n\r\n        resolvedFormula = resolvedFormula.replace(fullMatch, result);\r\n        variablesResolved.push(`${condition} ? ... : ... = \"${result}\"`);\r\n        debug.log(`\u2705 Resolved complex ternary: ${condition} (${conditionResult}) => \"${result}\"`);\r\n        continue;\r\n      } catch (e) {\r\n        debug.log(`\u26A0\uFE0F Failed to resolve ternary expression: ${cleanExpr}`, e);\r\n      }\r\n    }\r\n\r\n    // Try as simple variable first\r\n    let simpleValue = getVariableValue(cleanExpr);\r\n    if (simpleValue !== null) {\r\n      resolvedFormula = resolvedFormula.replace(fullMatch, simpleValue);\r\n      variablesResolved.push(`${cleanExpr}=${simpleValue}`);\r\n      debug.log(`\u2705 Resolved variable: ${cleanExpr} = ${simpleValue}`);\r\n      continue;\r\n    }\r\n\r\n    // Handle array indexing: [array][index]\r\n    const arrayPattern = /^\\[([^\\]]+)\\]\\[([^\\]]+)\\]$/;\r\n    const arrayMatch = cleanExpr.match(arrayPattern);\r\n    if (arrayMatch) {\r\n      try {\r\n        const arrayPart = arrayMatch[1];\r\n        const indexPart = arrayMatch[2];\r\n\r\n        // Parse array (handle both numbers and string values like \"N/A\")\r\n        const arrayValues = arrayPart.split(',').map(v => {\r\n          const trimmed = v.trim();\r\n          // Remove quotes if present\r\n          const unquoted = trimmed.replace(/^[\"']|[\"']$/g, '');\r\n          // Try to parse as number, otherwise keep as string\r\n          const num = parseFloat(unquoted);\r\n          return isNaN(num) ? unquoted : num;\r\n        });\r\n\r\n        // Resolve index variable\r\n        let indexValue = getVariableValue(indexPart);\r\n\r\n        if (indexValue !== null && !isNaN(indexValue)) {\r\n          // Try direct index first\r\n          let result = arrayValues[indexValue];\r\n\r\n          // If out of bounds and index > 0, try index-1 (for 1-based level arrays)\r\n          if (result === undefined && indexValue > 0) {\r\n            result = arrayValues[indexValue - 1];\r\n            if (result !== undefined) {\r\n              debug.log(`\uD83D\uDCCA Array index ${indexValue} out of bounds, using ${indexValue - 1} instead`);\r\n              indexValue = indexValue - 1;\r\n            }\r\n          }\r\n\r\n          if (result !== undefined) {\r\n            resolvedFormula = resolvedFormula.replace(fullMatch, result);\r\n            variablesResolved.push(`array[${indexValue}]=${result}`);\r\n            debug.log(`\u2705 Resolved array indexing: ${cleanExpr} = ${result}`);\r\n            continue;\r\n          } else {\r\n            debug.log(`\u26A0\uFE0F Array index ${indexValue} out of bounds (array length: ${arrayValues.length})`);\r\n          }\r\n        } else {\r\n          debug.log(`\u26A0\uFE0F Could not resolve index variable: ${indexPart}`);\r\n        }\r\n      } catch (e) {\r\n        debug.log(`\u26A0\uFE0F Failed to resolve array indexing: ${cleanExpr}`, e);\r\n      }\r\n    }\r\n\r\n    // Handle max/min functions (can be standalone or part of larger expression)\r\n    const maxMinPattern = /^(max|min)\\(([^)]+)\\)$/i;\r\n    const maxMinMatch = cleanExpr.match(maxMinPattern);\r\n    if (maxMinMatch) {\r\n      try {\r\n        const func = maxMinMatch[1].toLowerCase();\r\n        const args = maxMinMatch[2].split(',').map(arg => {\r\n          const trimmed = arg.trim();\r\n          // Try to parse as number first\r\n          const num = parseFloat(trimmed);\r\n          if (!isNaN(num)) return num;\r\n\r\n          // Try to resolve as variable\r\n          const varVal = getVariableValue(trimmed);\r\n          if (varVal !== null) return varVal;\r\n\r\n          return null;\r\n        }).filter(v => v !== null);\r\n\r\n        if (args.length > 0) {\r\n          const result = func === 'max' ? Math.max(...args) : Math.min(...args);\r\n          resolvedFormula = resolvedFormula.replace(fullMatch, result);\r\n          variablesResolved.push(`${func}(...)=${result}`);\r\n          debug.log(`\u2705 Resolved ${func} function: ${cleanExpr} = ${result}`);\r\n          continue;\r\n        }\r\n      } catch (e) {\r\n        debug.log(`\u26A0\uFE0F Failed to resolve ${cleanExpr}`, e);\r\n      }\r\n    }\r\n\r\n    // Handle ceil/floor/round/abs functions with parentheses: ceil(expr), floor(expr), etc.\r\n    const mathFuncParenPattern = /^(ceil|floor|round|abs)\\(([^)]+)\\)$/i;\r\n    const mathFuncParenMatch = cleanExpr.match(mathFuncParenPattern);\r\n    if (mathFuncParenMatch) {\r\n      try {\r\n        const funcName = mathFuncParenMatch[1].toLowerCase();\r\n        const expression = mathFuncParenMatch[2];\r\n\r\n        // Replace variables in the expression\r\n        let evalExpression = expression;\r\n        const varPattern = /[a-zA-Z_][a-zA-Z0-9_.]*/g;\r\n        let varMatch;\r\n        const replacements = [];\r\n\r\n        while ((varMatch = varPattern.exec(expression)) !== null) {\r\n          const varName = varMatch[0];\r\n          const value = getVariableValue(varName);\r\n          if (value !== null && typeof value === 'number') {\r\n            replacements.push({ name: varName, value: value });\r\n          }\r\n        }\r\n\r\n        // Sort by length (longest first) to avoid partial replacements\r\n        replacements.sort((a, b) => b.name.length - a.name.length);\r\n\r\n        for (const {name, value} of replacements) {\r\n          evalExpression = evalExpression.replace(new RegExp(name.replace(/\\./g, '\\\\.'), 'g'), value);\r\n        }\r\n\r\n        // Evaluate the expression\r\n        if (/^[\\d\\s+\\-*/().]+$/.test(evalExpression)) {\r\n          const evalResult = eval(evalExpression);\r\n          let result;\r\n\r\n          switch (funcName) {\r\n            case 'ceil':\r\n              result = Math.ceil(evalResult);\r\n              break;\r\n            case 'floor':\r\n              result = Math.floor(evalResult);\r\n              break;\r\n            case 'round':\r\n              result = Math.round(evalResult);\r\n              break;\r\n            case 'abs':\r\n              result = Math.abs(evalResult);\r\n              break;\r\n            default:\r\n              result = evalResult;\r\n          }\r\n\r\n          resolvedFormula = resolvedFormula.replace(fullMatch, result);\r\n          variablesResolved.push(`${funcName}(${expression})=${result}`);\r\n          debug.log(`\u2705 Resolved math function: ${funcName}(${expression}) = ${result}`);\r\n          continue;\r\n        }\r\n      } catch (e) {\r\n        debug.log(`\u26A0\uFE0F Failed to resolve ${cleanExpr}`, e);\r\n      }\r\n    }\r\n\r\n    // Try to evaluate as math expression\r\n    let evalExpression = cleanExpr;\r\n\r\n    // Replace all variable names with their values (sorted by length to avoid partial matches)\r\n    const varPattern = /[a-zA-Z_][a-zA-Z0-9_.]*/g;\r\n    let varMatch;\r\n    const replacements = [];\r\n\r\n    while ((varMatch = varPattern.exec(cleanExpr)) !== null) {\r\n      const varName = varMatch[0];\r\n      const value = getVariableValue(varName);\r\n      if (value !== null && typeof value === 'number') {\r\n        replacements.push({ name: varName, value: value });\r\n      }\r\n    }\r\n\r\n    // Sort by length (longest first) to avoid partial replacements\r\n    replacements.sort((a, b) => b.name.length - a.name.length);\r\n\r\n    for (const {name, value} of replacements) {\r\n      evalExpression = evalExpression.replace(new RegExp(name.replace(/\\./g, '\\\\.'), 'g'), value);\r\n    }\r\n\r\n    // Try to evaluate the expression\r\n    try {\r\n      if (/^[\\d\\s+\\-*/().]+$/.test(evalExpression)) {\r\n        const result = eval(evalExpression);\r\n        resolvedFormula = resolvedFormula.replace(fullMatch, Math.floor(result));\r\n        variablesResolved.push(`${cleanExpr}=${Math.floor(result)}`);\r\n        debug.log(`\u2705 Resolved expression: ${cleanExpr} = ${Math.floor(result)}`);\r\n      } else {\r\n        debug.log(`\u26A0\uFE0F Could not resolve expression: ${cleanExpr} (eval: ${evalExpression})`);\r\n      }\r\n    } catch (e) {\r\n      debug.log(`\u26A0\uFE0F Failed to evaluate expression: ${cleanExpr}`, e);\r\n    }\r\n  }\r\n\r\n  if (variablesResolved.length > 0) {\r\n    debug.log(`\uD83D\uDD27 Formula resolution: \"${formula}\" -> \"${resolvedFormula}\" (${variablesResolved.join(', ')})`);\r\n  }\r\n\r\n  // Strip remaining markdown formatting\r\n  resolvedFormula = resolvedFormula.replace(/\\*\\*/g, ''); // Remove bold markers\r\n\r\n  // Parse inline calculations in curly braces {expression}\r\n  // DiceCloud uses {varName} or {varName + 2} syntax in text\r\n  const inlineCalcPattern = /\\{([^}]+)\\}/g;\r\n  resolvedFormula = resolvedFormula.replace(inlineCalcPattern, (fullMatch, expression) => {\r\n    try {\r\n      // First try to resolve variables in the expression\r\n      let resolvedExpr = expression;\r\n\r\n      // Replace variable names with their values\r\n      const varPattern = /[a-zA-Z_][a-zA-Z0-9_.]*/g;\r\n      resolvedExpr = resolvedExpr.replace(varPattern, (varName) => {\r\n        const value = getVariableValue(varName);\r\n        return value !== null ? value : varName;\r\n      });\r\n\r\n      // Try to evaluate as math expression\r\n      // Only if it contains operators or is a number\r\n      if (/[\\d+\\-*\\/()]/.test(resolvedExpr)) {\r\n        try {\r\n          // Use Function constructor for safe evaluation (no external scope access)\r\n          const result = Function('\"use strict\"; return (' + resolvedExpr + ')')();\r\n          debug.log(`\u2705 Evaluated inline calculation: {${expression}} = ${result}`);\r\n          return result;\r\n        } catch (e) {\r\n          debug.log(`\u26A0\uFE0F Failed to evaluate inline calculation: {${expression}}`, e);\r\n        }\r\n      }\r\n\r\n      // If it's just a variable lookup that was resolved, return it\r\n      if (resolvedExpr !== expression && !/[a-zA-Z_]/.test(resolvedExpr)) {\r\n        return resolvedExpr;\r\n      }\r\n    } catch (e) {\r\n      debug.log(`\u26A0\uFE0F Error processing inline calculation: {${expression}}`, e);\r\n    }\r\n\r\n    // Return original if we couldn't resolve\r\n    return fullMatch;\r\n  });\r\n\r\n  return resolvedFormula;\r\n}\r\n\r\n/**\r\n * Safe math expression evaluator that doesn't use eval() or Function()\r\n * CSP-compliant parser for basic arithmetic and Math functions\r\n */\r\nfunction safeMathEval(expr) {\r\n  // Tokenize the expression\r\n  const tokens = [];\r\n  let i = 0;\r\n  expr = expr.replace(/\\s+/g, ''); // Remove whitespace\r\n\r\n  while (i < expr.length) {\r\n    // Check for Math functions\r\n    if (expr.substr(i, 10) === 'Math.floor') {\r\n      tokens.push({ type: 'function', value: 'floor' });\r\n      i += 10;\r\n    } else if (expr.substr(i, 9) === 'Math.ceil') {\r\n      tokens.push({ type: 'function', value: 'ceil' });\r\n      i += 9;\r\n    } else if (expr.substr(i, 10) === 'Math.round') {\r\n      tokens.push({ type: 'function', value: 'round' });\r\n      i += 10;\r\n    } else if (expr[i] >= '0' && expr[i] <= '9' || expr[i] === '.') {\r\n      // Parse number\r\n      let num = '';\r\n      while (i < expr.length && (expr[i] >= '0' && expr[i] <= '9' || expr[i] === '.')) {\r\n        num += expr[i];\r\n        i++;\r\n      }\r\n      tokens.push({ type: 'number', value: parseFloat(num) });\r\n    } else if ('+-*/()'.includes(expr[i])) {\r\n      tokens.push({ type: 'operator', value: expr[i] });\r\n      i++;\r\n    } else {\r\n      throw new Error(`Unexpected character: ${expr[i]}`);\r\n    }\r\n  }\r\n\r\n  // Parse and evaluate using recursive descent\r\n  let pos = 0;\r\n\r\n  function parseExpression() {\r\n    let left = parseTerm();\r\n\r\n    while (pos < tokens.length && tokens[pos].type === 'operator' && (tokens[pos].value === '+' || tokens[pos].value === '-')) {\r\n      const op = tokens[pos].value;\r\n      pos++;\r\n      const right = parseTerm();\r\n      left = op === '+' ? left + right : left - right;\r\n    }\r\n\r\n    return left;\r\n  }\r\n\r\n  function parseTerm() {\r\n    let left = parseFactor();\r\n\r\n    while (pos < tokens.length && tokens[pos].type === 'operator' && (tokens[pos].value === '*' || tokens[pos].value === '/')) {\r\n      const op = tokens[pos].value;\r\n      pos++;\r\n      const right = parseFactor();\r\n      left = op === '*' ? left * right : left / right;\r\n    }\r\n\r\n    return left;\r\n  }\r\n\r\n  function parseFactor() {\r\n    const token = tokens[pos];\r\n\r\n    // Handle numbers\r\n    if (token.type === 'number') {\r\n      pos++;\r\n      return token.value;\r\n    }\r\n\r\n    // Handle Math functions\r\n    if (token.type === 'function') {\r\n      const funcName = token.value;\r\n      pos++;\r\n      if (pos >= tokens.length || tokens[pos].value !== '(') {\r\n        throw new Error('Expected ( after function name');\r\n      }\r\n      pos++; // Skip (\r\n      const arg = parseExpression();\r\n      if (pos >= tokens.length || tokens[pos].value !== ')') {\r\n        throw new Error('Expected ) after function argument');\r\n      }\r\n      pos++; // Skip )\r\n\r\n      if (funcName === 'floor') return Math.floor(arg);\r\n      if (funcName === 'ceil') return Math.ceil(arg);\r\n      if (funcName === 'round') return Math.round(arg);\r\n      throw new Error(`Unknown function: ${funcName}`);\r\n    }\r\n\r\n    // Handle parentheses\r\n    if (token.type === 'operator' && token.value === '(') {\r\n      pos++;\r\n      const result = parseExpression();\r\n      if (pos >= tokens.length || tokens[pos].value !== ')') {\r\n        throw new Error('Mismatched parentheses');\r\n      }\r\n      pos++;\r\n      return result;\r\n    }\r\n\r\n    // Handle unary minus\r\n    if (token.type === 'operator' && token.value === '-') {\r\n      pos++;\r\n      return -parseFactor();\r\n    }\r\n\r\n    throw new Error(`Unexpected token: ${JSON.stringify(token)}`);\r\n  }\r\n\r\n  return parseExpression();\r\n}\r\n\r\n/**\r\n * Evaluate simple mathematical expressions in formulas\r\n * Converts things like \"5*5\" to \"25\" before sending to Roll20\r\n * CSP-compliant - does not use eval() or Function() constructor\r\n */\r\nfunction evaluateMathInFormula(formula) {\r\n  if (!formula || typeof formula !== 'string') {\r\n    return formula;\r\n  }\r\n\r\n  let currentFormula = formula;\r\n  let previousFormula = null;\r\n  let iterations = 0;\r\n  const maxIterations = 10; // Prevent infinite loops\r\n\r\n  // Keep simplifying until formula doesn't change or max iterations reached\r\n  while (currentFormula !== previousFormula && iterations < maxIterations) {\r\n    previousFormula = currentFormula;\r\n    iterations++;\r\n\r\n    // Replace floor() with Math.floor() for parsing\r\n    let processedFormula = currentFormula.replace(/floor\\(/g, 'Math.floor(');\r\n    processedFormula = processedFormula.replace(/ceil\\(/g, 'Math.ceil(');\r\n    processedFormula = processedFormula.replace(/round\\(/g, 'Math.round(');\r\n\r\n    // Check if the formula is just a simple math expression (no dice)\r\n    // Pattern: numbers and operators only (e.g., \"5*5\", \"10+5\", \"20/4\")\r\n    const simpleMathPattern = /^[\\d\\s+\\-*/().]+$/;\r\n\r\n    if (simpleMathPattern.test(processedFormula)) {\r\n      try {\r\n        const result = safeMathEval(processedFormula);\r\n        if (typeof result === 'number' && !isNaN(result)) {\r\n          debug.log(`\u2705 Evaluated simple math: ${currentFormula} = ${result} (iteration ${iterations})`);\r\n          currentFormula = String(result);\r\n          continue;\r\n        }\r\n      } catch (e) {\r\n        debug.log(`\u26A0\uFE0F Could not evaluate math expression: ${currentFormula}`, e);\r\n      }\r\n    }\r\n\r\n    // Handle formulas with dice notation like \"(floor((9 + 1) / 6) + 1)d8\" or \"(3 * 1)d6\"\r\n    // Extract math before the dice, evaluate it, then reconstruct\r\n    const dicePattern = /^(.+?)(d\\d+.*)$/i;\r\n    const match = processedFormula.match(dicePattern);\r\n\r\n    if (match) {\r\n      const mathPart = match[1]; // e.g., \"(Math.floor((9 + 1) / 6) + 1)\" or \"(3 * 1)\"\r\n      const dicePart = match[2]; // e.g., \"d8\" or \"d6\"\r\n\r\n      // Check if the math part is evaluable (allows numbers, operators, parens, and Math functions)\r\n      const mathOnlyPattern = /^[\\d\\s+\\-*/().\\w]+$/;\r\n      if (mathOnlyPattern.test(mathPart)) {\r\n        try {\r\n          const result = safeMathEval(mathPart);\r\n          if (typeof result === 'number' && !isNaN(result)) {\r\n            debug.log(`\u2705 Evaluated dice formula math: ${mathPart} = ${result} (iteration ${iterations})`);\r\n            currentFormula = String(result) + dicePart;\r\n            continue;\r\n          }\r\n        } catch (e) {\r\n          debug.log(`\u26A0\uFE0F Could not evaluate dice formula math: ${mathPart}`, e);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  if (iterations > 1) {\r\n    debug.log(`\uD83D\uDD04 Formula simplified in ${iterations} iterations: \"${formula}\" -> \"${currentFormula}\"`);\r\n  }\r\n\r\n  return currentFormula;\r\n}\r\n\r\n/**\r\n * Apply active effect modifiers to a roll\r\n * @param {string} rollName - Name of the roll (e.g., \"Attack\", \"Perception\", \"Strength Save\")\r\n * @param {string} formula - Original formula\r\n * @returns {object} - { modifiedFormula, effectNotes }\r\n */\r\nfunction applyEffectModifiers(rollName, formula) {\r\n  const rollLower = rollName.toLowerCase();\r\n  let modifiedFormula = formula;\r\n  const effectNotes = [];\r\n\r\n  // Combine all active effects\r\n  const allEffects = [\r\n    ...activeBuffs.map(name => ({ ...POSITIVE_EFFECTS.find(e => e.name === name), type: 'buff' })),\r\n    ...activeConditions.map(name => ({ ...NEGATIVE_EFFECTS.find(e => e.name === name), type: 'debuff' }))\r\n  ].filter(e => e && e.autoApply);\r\n\r\n  debug.log(`\uD83C\uDFB2 Checking effects for roll: ${rollName}`, allEffects);\r\n\r\n  for (const effect of allEffects) {\r\n    if (!effect.modifier) continue;\r\n\r\n    let applied = false;\r\n\r\n    // Check for attack roll modifiers\r\n    if (rollLower.includes('attack') && effect.modifier.attack) {\r\n      const mod = effect.modifier.attack;\r\n      if (mod === 'advantage') {\r\n        effectNotes.push(`[${effect.icon} ${effect.name}: Advantage]`);\r\n        applied = true;\r\n      } else if (mod === 'disadvantage') {\r\n        effectNotes.push(`[${effect.icon} ${effect.name}: Disadvantage]`);\r\n        applied = true;\r\n      } else {\r\n        modifiedFormula += ` + ${mod}`;\r\n        effectNotes.push(`[${effect.icon} ${effect.name}: ${mod}]`);\r\n        applied = true;\r\n      }\r\n    }\r\n\r\n    // Check for saving throw modifiers\r\n    if (rollLower.includes('save') && (effect.modifier.save || effect.modifier.strSave || effect.modifier.dexSave)) {\r\n      const mod = effect.modifier.save ||\r\n                 (rollLower.includes('strength') && effect.modifier.strSave) ||\r\n                 (rollLower.includes('dexterity') && effect.modifier.dexSave);\r\n\r\n      if (mod === 'advantage') {\r\n        effectNotes.push(`[${effect.icon} ${effect.name}: Advantage]`);\r\n        applied = true;\r\n      } else if (mod === 'disadvantage') {\r\n        effectNotes.push(`[${effect.icon} ${effect.name}: Disadvantage]`);\r\n        applied = true;\r\n      } else if (mod === 'fail') {\r\n        effectNotes.push(`[${effect.icon} ${effect.name}: Auto-fail]`);\r\n        applied = true;\r\n      } else if (mod) {\r\n        modifiedFormula += ` + ${mod}`;\r\n        effectNotes.push(`[${effect.icon} ${effect.name}: ${mod}]`);\r\n        applied = true;\r\n      }\r\n    }\r\n\r\n    // Check for skill check modifiers\r\n    if ((rollLower.includes('check') || rollLower.includes('perception') ||\r\n         rollLower.includes('stealth') || rollLower.includes('investigation') ||\r\n         rollLower.includes('insight') || rollLower.includes('persuasion') ||\r\n         rollLower.includes('deception') || rollLower.includes('intimidation') ||\r\n         rollLower.includes('athletics') || rollLower.includes('acrobatics')) &&\r\n        effect.modifier.skill) {\r\n      const mod = effect.modifier.skill;\r\n      if (mod === 'advantage') {\r\n        effectNotes.push(`[${effect.icon} ${effect.name}: Advantage]`);\r\n        applied = true;\r\n      } else if (mod === 'disadvantage') {\r\n        effectNotes.push(`[${effect.icon} ${effect.name}: Disadvantage]`);\r\n        applied = true;\r\n      } else {\r\n        modifiedFormula += ` + ${mod}`;\r\n        effectNotes.push(`[${effect.icon} ${effect.name}: ${mod}]`);\r\n        applied = true;\r\n      }\r\n    }\r\n\r\n    // Check for damage modifiers\r\n    if (rollLower.includes('damage') && effect.modifier.damage) {\r\n      modifiedFormula += ` + ${effect.modifier.damage}`;\r\n      effectNotes.push(`[${effect.icon} ${effect.name}: +${effect.modifier.damage}]`);\r\n      applied = true;\r\n    }\r\n\r\n    if (applied) {\r\n      debug.log(`\u2705 Applied ${effect.name} (${effect.type}) to ${rollName}`);\r\n    }\r\n  }\r\n\r\n  return { modifiedFormula, effectNotes };\r\n}\r\n\r\n/**\r\n * Check for optional effects that could apply to a roll and show popup if found\r\n * @param {string} rollName - Name of the roll\r\n * @param {string} formula - Original formula\r\n * @param {function} onApply - Callback function to apply the effect\r\n */\r\nfunction checkOptionalEffects(rollName, formula, onApply) {\r\n  const rollLower = rollName.toLowerCase();\r\n\r\n  // Combine all active effects that are NOT autoApply\r\n  const optionalEffects = [\r\n    ...activeBuffs.map(name => ({ ...POSITIVE_EFFECTS.find(e => e.name === name), type: 'buff' })),\r\n    ...activeConditions.map(name => ({ ...NEGATIVE_EFFECTS.find(e => e.name === name), type: 'debuff' }))\r\n  ].filter(e => e && !e.autoApply && e.modifier);\r\n\r\n  if (optionalEffects.length === 0) return;\r\n\r\n  debug.log(`\uD83C\uDFB2 Checking optional effects for roll: ${rollName}`, optionalEffects);\r\n\r\n  const applicableEffects = [];\r\n\r\n  for (const effect of optionalEffects) {\r\n    let applicable = false;\r\n\r\n    // Check for skill check modifiers (for Guidance) - ALL skills\r\n    const isSkillCheck = rollLower.includes('check') || \r\n                        rollLower.includes('acrobatics') || rollLower.includes('animal') ||\r\n                        rollLower.includes('arcana') || rollLower.includes('athletics') ||\r\n                        rollLower.includes('deception') || rollLower.includes('history') ||\r\n                        rollLower.includes('insight') || rollLower.includes('intimidation') ||\r\n                        rollLower.includes('investigation') || rollLower.includes('medicine') ||\r\n                        rollLower.includes('nature') || rollLower.includes('perception') ||\r\n                        rollLower.includes('performance') || rollLower.includes('persuasion') ||\r\n                        rollLower.includes('religion') || rollLower.includes('sleight') ||\r\n                        rollLower.includes('stealth') || rollLower.includes('survival');\r\n    \r\n    if (isSkillCheck && effect.modifier.skill) {\r\n      applicable = true;\r\n    }\r\n\r\n    // Check for attack roll modifiers\r\n    if (rollLower.includes('attack') && effect.modifier.attack) {\r\n      applicable = true;\r\n    }\r\n\r\n    // Check for saving throw modifiers\r\n    if (rollLower.includes('save') && effect.modifier.save) {\r\n      applicable = true;\r\n    }\r\n\r\n    // Special handling for Bardic Inspiration - applies to checks, attacks, and saves\r\n    if (effect.name.startsWith('Bardic Inspiration')) {\r\n      if (rollLower.includes('check') || rollLower.includes('perception') ||\r\n          rollLower.includes('stealth') || rollLower.includes('investigation') ||\r\n          rollLower.includes('insight') || rollLower.includes('persuasion') ||\r\n          rollLower.includes('deception') || rollLower.includes('intimidation') ||\r\n          rollLower.includes('athletics') || rollLower.includes('acrobatics') ||\r\n          rollLower.includes('attack') || rollLower.includes('save')) {\r\n        applicable = true;\r\n      }\r\n    }\r\n\r\n    if (applicable) {\r\n      applicableEffects.push(effect);\r\n    }\r\n  }\r\n\r\n  if (applicableEffects.length > 0) {\r\n    showOptionalEffectPopup(applicableEffects, rollName, formula, onApply);\r\n  }\r\n}\r\n\r\n/**\r\n * Show popup for optional effects\r\n */\r\nfunction showOptionalEffectPopup(effects, rollName, formula, onApply) {\r\n  debug.log('\uD83C\uDFAF Showing optional effect popup for:', effects);\r\n\r\n  if (!document.body) {\r\n    debug.error('\u274C document.body not available for optional effect popup');\r\n    return;\r\n  }\r\n\r\n  // Get theme-aware colors\r\n  const colors = getPopupThemeColors();\r\n\r\n  // Create modal overlay\r\n  const popupOverlay = document.createElement('div');\r\n  popupOverlay.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background: rgba(0, 0, 0, 0.6);\r\n    backdrop-filter: blur(2px);\r\n    z-index: 10000;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n  `;\r\n\r\n  // Create popup content\r\n  const popupContent = document.createElement('div');\r\n  popupContent.style.cssText = `\r\n    background: ${colors.background};\r\n    border-radius: 12px;\r\n    padding: 24px;\r\n    max-width: 400px;\r\n    width: 90%;\r\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\r\n    text-align: center;\r\n    border: 2px solid var(--accent-primary);\r\n  `;\r\n\r\n  // Build effects list\r\n  const effectsList = effects.map(effect => `\r\n    <div style=\"margin: 12px 0; padding: 12px; background: ${effect.color}20; border: 2px solid ${effect.color}; border-radius: 8px; cursor: pointer; transition: all 0.2s;\" \r\n         onmouseover=\"this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'\"\r\n         onmouseout=\"this.style.transform='translateY(0)'; this.style.boxShadow='none'\"\r\n         data-effect=\"${effect.name}\" data-type=\"${effect.type}\">\r\n      <div style=\"display: flex; align-items: center; gap: 8px;\">\r\n        <span style=\"font-size: 1.2em;\">${effect.icon}</span>\r\n        <div style=\"flex: 1; text-align: left;\">\r\n          <div style=\"font-weight: bold; color: var(--text-primary);\">${effect.name}</div>\r\n          <div style=\"font-size: 0.85em; color: var(--text-secondary); margin-top: 2px;\">${effect.description}</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `).join('');\r\n\r\n  popupContent.innerHTML = `\r\n    <div style=\"font-size: 24px; margin-bottom: 16px;\">\uD83C\uDFAF</div>\r\n    <h2 style=\"margin: 0 0 8px 0; color: ${colors.heading};\">Optional Effect Available!</h2>\r\n    <p style=\"margin: 0 0 16px 0; color: ${colors.text};\">\r\n      You can apply an optional effect to your <strong>${rollName}</strong> roll:\r\n    </p>\r\n    ${effectsList}\r\n    <div style=\"margin-top: 20px; display: flex; gap: 10px; justify-content: center;\">\r\n      <button id=\"skip-effect\" style=\"background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;\">\r\n        Skip\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  popupOverlay.appendChild(popupContent);\r\n  document.body.appendChild(popupOverlay);\r\n\r\n  // Add click handlers for effect options\r\n  popupContent.querySelectorAll('[data-effect]').forEach(effectDiv => {\r\n    effectDiv.addEventListener('click', () => {\r\n      const effectName = effectDiv.dataset.effect;\r\n      const effectType = effectDiv.dataset.type;\r\n      const effect = effects.find(e => e.name === effectName);\r\n      \r\n      if (effect && onApply) {\r\n        onApply(effect);\r\n      }\r\n      \r\n      document.body.removeChild(popupOverlay);\r\n    });\r\n  });\r\n\r\n  // Skip button\r\n  document.getElementById('skip-effect').addEventListener('click', () => {\r\n    document.body.removeChild(popupOverlay);\r\n  });\r\n\r\n  // Close on overlay click\r\n  popupOverlay.addEventListener('click', (e) => {\r\n    if (e.target === popupOverlay) {\r\n      document.body.removeChild(popupOverlay);\r\n    }\r\n  });\r\n\r\n  debug.log('\uD83C\uDFAF Optional effect popup displayed');\r\n}\r\n\r\nfunction roll(name, formula, prerolledResult = null) {\r\n  debug.log('\uD83C\uDFB2 Rolling:', name, formula, prerolledResult ? `(prerolled: ${prerolledResult})` : '');\r\n\r\n  // Resolve any variables in the formula\r\n  let resolvedFormula = resolveVariablesInFormula(formula);\r\n\r\n  // Check if there are any optional effects that could apply to this roll\r\n  const rollLower = name.toLowerCase();\r\n  const optionalEffects = [\r\n    ...activeBuffs.map(name => ({ ...POSITIVE_EFFECTS.find(e => e.name === name), type: 'buff' })),\r\n    ...activeConditions.map(name => ({ ...NEGATIVE_EFFECTS.find(e => e.name === name), type: 'debuff' }))\r\n  ].filter(e => e && !e.autoApply && e.modifier);\r\n\r\n  const hasApplicableOptionalEffects = optionalEffects.some(effect => {\r\n    // Check if this is a skill check (any skill name or the word \"check\")\r\n    const isSkillCheck = rollLower.includes('check') || \r\n                        rollLower.includes('acrobatics') || rollLower.includes('animal') ||\r\n                        rollLower.includes('arcana') || rollLower.includes('athletics') ||\r\n                        rollLower.includes('deception') || rollLower.includes('history') ||\r\n                        rollLower.includes('insight') || rollLower.includes('intimidation') ||\r\n                        rollLower.includes('investigation') || rollLower.includes('medicine') ||\r\n                        rollLower.includes('nature') || rollLower.includes('perception') ||\r\n                        rollLower.includes('performance') || rollLower.includes('persuasion') ||\r\n                        rollLower.includes('religion') || rollLower.includes('sleight') ||\r\n                        rollLower.includes('stealth') || rollLower.includes('survival');\r\n    \r\n    return (isSkillCheck && effect.modifier.skill) ||\r\n           (rollLower.includes('attack') && effect.modifier.attack);\r\n  });\r\n\r\n  // If there are applicable optional effects, show popup and wait for user choice\r\n  if (hasApplicableOptionalEffects) {\r\n    debug.log('\uD83C\uDFAF Found applicable optional effects, showing popup...');\r\n    checkOptionalEffects(name, resolvedFormula, (chosenEffect) => {\r\n      // Apply the chosen effect and then roll\r\n      const { modifiedFormula, effectNotes } = applyEffectModifiers(name, resolvedFormula);\r\n      let finalFormula = modifiedFormula;\r\n\r\n      // Check if this is a skill/ability check (same logic as popup detection)\r\n      const isSkillOrAbilityCheck = rollLower.includes('check') ||\r\n                        rollLower.includes('acrobatics') || rollLower.includes('animal') ||\r\n                        rollLower.includes('arcana') || rollLower.includes('athletics') ||\r\n                        rollLower.includes('deception') || rollLower.includes('history') ||\r\n                        rollLower.includes('insight') || rollLower.includes('intimidation') ||\r\n                        rollLower.includes('investigation') || rollLower.includes('medicine') ||\r\n                        rollLower.includes('nature') || rollLower.includes('perception') ||\r\n                        rollLower.includes('performance') || rollLower.includes('persuasion') ||\r\n                        rollLower.includes('religion') || rollLower.includes('sleight') ||\r\n                        rollLower.includes('stealth') || rollLower.includes('survival') ||\r\n                        rollLower.includes('strength') || rollLower.includes('dexterity') ||\r\n                        rollLower.includes('constitution') || rollLower.includes('intelligence') ||\r\n                        rollLower.includes('wisdom') || rollLower.includes('charisma');\r\n\r\n      debug.log(`\uD83C\uDFAF Applying chosen effect: ${chosenEffect.name}`, {\r\n        modifier: chosenEffect.modifier,\r\n        rollLower: rollLower,\r\n        hasSkillMod: !!chosenEffect.modifier?.skill,\r\n        isSkillOrAbilityCheck: isSkillOrAbilityCheck,\r\n        formulaBefore: finalFormula\r\n      });\r\n\r\n      // Add the chosen effect's modifier\r\n      if (chosenEffect.modifier?.skill && isSkillOrAbilityCheck) {\r\n        finalFormula += ` + ${chosenEffect.modifier.skill}`;\r\n        effectNotes.push(`[${chosenEffect.icon} ${chosenEffect.name}: ${chosenEffect.modifier.skill}]`);\r\n        debug.log(`\u2705 Added skill modifier: ${chosenEffect.modifier.skill}, formula now: ${finalFormula}`);\r\n      } else if (chosenEffect.modifier?.attack && rollLower.includes('attack')) {\r\n        finalFormula += ` + ${chosenEffect.modifier.attack}`;\r\n        effectNotes.push(`[${chosenEffect.icon} ${chosenEffect.name}: ${chosenEffect.modifier.attack}]`);\r\n        debug.log(`\u2705 Added attack modifier: ${chosenEffect.modifier.attack}, formula now: ${finalFormula}`);\r\n      } else {\r\n        debug.log(`\u26A0\uFE0F No modifier applied - skill: ${chosenEffect.modifier?.skill}, check: ${rollLower.includes('check')}, attack: ${chosenEffect.modifier?.attack}`);\r\n      }\r\n      \r\n      // Remove the chosen effect from active effects since it's been used\r\n      if (chosenEffect.type === 'buff') {\r\n        activeBuffs = activeBuffs.filter(e => e !== chosenEffect.name);\r\n        debug.log(`\uD83D\uDDD1\uFE0F Removed buff: ${chosenEffect.name}`);\r\n      } else if (chosenEffect.type === 'debuff') {\r\n        activeConditions = activeConditions.filter(e => e !== chosenEffect.name);\r\n        debug.log(`\uD83D\uDDD1\uFE0F Removed debuff: ${chosenEffect.name}`);\r\n      }\r\n      updateEffectsDisplay();\r\n\r\n      // Apply advantage/disadvantage state\r\n      const formulaWithAdvantage = applyAdvantageToFormula(finalFormula, effectNotes);\r\n\r\n      // Proceed with the roll\r\n      executeRoll(name, formulaWithAdvantage, effectNotes, prerolledResult);\r\n    });\r\n    // Return early - don't execute the roll yet, wait for popup response\r\n    return;\r\n  }\r\n\r\n  // No optional effects, proceed with normal roll\r\n  const { modifiedFormula, effectNotes } = applyEffectModifiers(name, resolvedFormula);\r\n\r\n  // Apply advantage/disadvantage state\r\n  const formulaWithAdvantage = applyAdvantageToFormula(modifiedFormula, effectNotes);\r\n\r\n  executeRoll(name, formulaWithAdvantage, effectNotes, prerolledResult);\r\n}\r\n\r\n/**\r\n * Apply advantage/disadvantage state to dice formula\r\n */\r\nfunction applyAdvantageToFormula(formula, effectNotes) {\r\n  if (advantageState === 'normal') {\r\n    return formula;\r\n  }\r\n\r\n  // Check if this is a d20 roll\r\n  if (!formula.includes('1d20') && !formula.includes('d20')) {\r\n    return formula; // Not a d20 roll, don't modify\r\n  }\r\n\r\n  let modifiedFormula = formula;\r\n\r\n  if (advantageState === 'advantage') {\r\n    // Replace 1d20 with 2d20kh1 (keep highest)\r\n    modifiedFormula = modifiedFormula.replace(/1d20/g, '2d20kh1');\r\n    modifiedFormula = modifiedFormula.replace(/(?<!\\d)d20/g, '2d20kh1');\r\n    effectNotes.push('[\u26A1 Advantage]');\r\n    debug.log('\u26A1 Applied advantage to roll');\r\n  } else if (advantageState === 'disadvantage') {\r\n    // Replace 1d20 with 2d20kl1 (keep lowest)\r\n    modifiedFormula = modifiedFormula.replace(/1d20/g, '2d20kl1');\r\n    modifiedFormula = modifiedFormula.replace(/(?<!\\d)d20/g, '2d20kl1');\r\n    effectNotes.push('[\u26A0\uFE0F Disadvantage]');\r\n    debug.log('\u26A0\uFE0F Applied disadvantage to roll');\r\n  }\r\n\r\n  // Reset advantage state after use\r\n  setTimeout(() => setAdvantageState('normal'), 100);\r\n\r\n  return modifiedFormula;\r\n}\r\n\r\n/**\r\n * Execute the roll after optional effects have been handled\r\n */\r\nfunction executeRoll(name, formula, effectNotes, prerolledResult = null) {\r\n  const colorBanner = getColoredBanner();\r\n  // Format: \"\uD83D\uDD35 CharacterName rolls Initiative\"\r\n  let rollName = `${colorBanner}${characterData.name} rolls ${name}`;\r\n\r\n  // Add effect notes to roll name if any\r\n  if (effectNotes.length > 0) {\r\n    rollName += ` ${effectNotes.join(' ')}`;\r\n  }\r\n\r\n  // Save this as the character's last roll (for heroic inspiration reroll)\r\n  if (characterData) {\r\n    characterData.lastRoll = {\r\n      name: name,\r\n      formula: formula,\r\n      effectNotes: effectNotes\r\n    };\r\n    saveCharacterData();\r\n  }\r\n\r\n  // If we have a prerolled result (e.g., from death saves), include it\r\n  const messageData = {\r\n    action: 'rollFromPopout',\r\n    name: rollName,\r\n    formula: formula,\r\n    color: characterData.notificationColor,\r\n    characterName: characterData.name\r\n  };\r\n\r\n  if (prerolledResult !== null) {\r\n    messageData.prerolledResult = prerolledResult;\r\n  }\r\n\r\n  // Try window.opener first (Chrome)\r\n  if (window.opener && !window.opener.closed) {\r\n    try {\r\n      window.opener.postMessage(messageData, '*');\r\n      showNotification(`\uD83C\uDFB2 Rolling ${name}...`);\r\n      debug.log('\u2705 Roll sent via window.opener');\r\n      return;\r\n    } catch (error) {\r\n      debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n    }\r\n  }\r\n\r\n  // Fallback: Use background script to relay to Roll20 (Firefox)\r\n  debug.log('\uD83D\uDCE1 Using background script to relay roll to Roll20...');\r\n  browserAPI.runtime.sendMessage({\r\n    action: 'relayRollToRoll20',\r\n    roll: messageData\r\n  }, (response) => {\r\n    if (browserAPI.runtime.lastError) {\r\n      debug.error('\u274C Error relaying roll:', browserAPI.runtime.lastError);\r\n      showNotification('Failed to send roll. Please try from Roll20 page.', 'error');\r\n    } else if (response && response.success) {\r\n      debug.log('\u2705 Roll relayed to Roll20 via background script');\r\n      showNotification(`\uD83C\uDFB2 Rolling ${name}...`);\r\n    } else {\r\n      debug.error('\u274C Failed to relay roll:', response?.error);\r\n      showNotification('Failed to send roll. Make sure Roll20 tab is open.', 'error');\r\n    }\r\n  });\r\n}\r\n\r\nfunction showNotification(message) {\r\n  const notif = document.createElement('div');\r\n  notif.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27AE60; color: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000;';\r\n  notif.textContent = message;\r\n  document.body.appendChild(notif);\r\n  setTimeout(() => notif.remove(), 2000);\r\n}\r\n\r\nfunction takeShortRest() {\r\n  if (!characterData) {\r\n    showNotification('\u274C Character data not available', 'error');\r\n    return;\r\n  }\r\n\r\n  const confirmed = confirm('Take a Short Rest?\\n\\nThis will:\\n- Allow you to spend Hit Dice to restore HP\\n- Restore Warlock spell slots\\n- Restore some class features');\r\n\r\n  if (!confirmed) return;\r\n\r\n  debug.log('\u2615 Taking short rest...');\r\n\r\n  // Clear temporary HP (RAW: temp HP doesn't persist through rest)\r\n  if (characterData.temporaryHP > 0) {\r\n    characterData.temporaryHP = 0;\r\n    debug.log('\u2705 Cleared temporary HP');\r\n  }\r\n\r\n  // Note: Inspiration is NOT restored on short rest (DM grants it)\r\n  debug.log(`\u2139\uFE0F Inspiration status unchanged (${characterData.inspiration ? 'active' : 'none'})`);\r\n\r\n  // Restore Warlock Pact Magic slots (they recharge on short rest)\r\n  // Check both spellSlots and otherVariables for Pact Magic\r\n  if (characterData.spellSlots && characterData.spellSlots.pactMagicSlotsMax !== undefined) {\r\n    characterData.spellSlots.pactMagicSlots = characterData.spellSlots.pactMagicSlotsMax;\r\n    debug.log(`\u2705 Restored Pact Magic slots (spellSlots): ${characterData.spellSlots.pactMagicSlots}/${characterData.spellSlots.pactMagicSlotsMax}`);\r\n  }\r\n  if (characterData.otherVariables) {\r\n    if (characterData.otherVariables.pactMagicSlotsMax !== undefined) {\r\n      characterData.otherVariables.pactMagicSlots = characterData.otherVariables.pactMagicSlotsMax;\r\n      debug.log('\u2705 Restored Pact Magic slots (otherVariables)');\r\n    }\r\n\r\n    // Restore Ki points for Monk (short rest feature)\r\n    if (characterData.otherVariables.kiMax !== undefined) {\r\n      characterData.otherVariables.ki = characterData.otherVariables.kiMax;\r\n      debug.log('\u2705 Restored Ki points');\r\n    } else if (characterData.otherVariables.kiPointsMax !== undefined) {\r\n      characterData.otherVariables.kiPoints = characterData.otherVariables.kiPointsMax;\r\n      debug.log('\u2705 Restored Ki points');\r\n    }\r\n\r\n    // Restore Action Surge, Second Wind (short rest features)\r\n    if (characterData.otherVariables.actionSurgeMax !== undefined) {\r\n      characterData.otherVariables.actionSurge = characterData.otherVariables.actionSurgeMax;\r\n    }\r\n    if (characterData.otherVariables.secondWindMax !== undefined) {\r\n      characterData.otherVariables.secondWind = characterData.otherVariables.secondWindMax;\r\n    }\r\n  }\r\n\r\n  // Handle Hit Dice spending for HP restoration\r\n  spendHitDice();\r\n\r\n  // Restore class resources that recharge on short rest\r\n  // Most resources restore on short rest (Ki, Channel Divinity, Action Surge, etc.)\r\n  // Notable exceptions: Sorcery Points and Rage restore on long rest only\r\n  if (characterData.resources && characterData.resources.length > 0) {\r\n    characterData.resources.forEach(resource => {\r\n      const lowerName = resource.name.toLowerCase();\r\n\r\n      // Long rest only resources\r\n      if (lowerName.includes('sorcery') || lowerName.includes('rage')) {\r\n        debug.log(`\u23ED\uFE0F Skipping ${resource.name} (long rest only)`);\r\n        return;\r\n      }\r\n\r\n      // Restore all other resources\r\n      resource.current = resource.max;\r\n\r\n      // Also update otherVariables to keep data in sync\r\n      if (characterData.otherVariables && resource.varName) {\r\n        characterData.otherVariables[resource.varName] = resource.current;\r\n      }\r\n\r\n      debug.log(`\u2705 Restored ${resource.name} (${resource.current}/${resource.max})`);\r\n    });\r\n  }\r\n\r\n  // Reset limited uses for short rest abilities\r\n  if (characterData.actions) {\r\n    characterData.actions.forEach(action => {\r\n      // Reset usesUsed for actions that recharge on short rest\r\n      // Most limited use abilities in D&D 5e recharge on short rest\r\n      if (action.uses && action.usesUsed > 0) {\r\n        action.usesUsed = 0;\r\n        debug.log(`\u2705 Reset uses for ${action.name}`);\r\n      }\r\n    });\r\n  }\r\n\r\n  saveCharacterData();\r\n  buildSheet(characterData);\r\n\r\n  showNotification('\u2615 Short Rest complete! Resources recharged.');\r\n  debug.log('\u2705 Short rest complete');\r\n\r\n  // Announce to Roll20 with fancy formatting\r\n  const colorBanner = getColoredBanner();\r\n  const messageData = {\r\n    action: 'announceSpell',\r\n    message: `&{template:default} {{name=${colorBanner}${characterData.name} takes a short rest}} {{=\u2615 Short rest complete. Resources recharged!}}`,\r\n    color: characterData.notificationColor\r\n  };\r\n\r\n  // Try window.opener first (Chrome)\r\n  if (window.opener && !window.opener.closed) {\r\n    try {\r\n      window.opener.postMessage(messageData, '*');\r\n    } catch (error) {\r\n      debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n      // Fallback to background script relay\r\n      browserAPI.runtime.sendMessage({\r\n        action: 'relayRollToRoll20',\r\n        roll: messageData\r\n      });\r\n    }\r\n  } else {\r\n    // Fallback: Use background script to relay to Roll20 (Firefox)\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'relayRollToRoll20',\r\n      roll: messageData\r\n    });\r\n  }\r\n}\r\n\r\nfunction getHitDieType() {\r\n  // Determine hit die based on class (D&D 5e)\r\n  const className = (characterData.class || '').toLowerCase();\r\n\r\n  const hitDiceMap = {\r\n    'barbarian': 'd12',\r\n    'fighter': 'd10',\r\n    'paladin': 'd10',\r\n    'ranger': 'd10',\r\n    'bard': 'd8',\r\n    'cleric': 'd8',\r\n    'druid': 'd8',\r\n    'monk': 'd8',\r\n    'rogue': 'd8',\r\n    'warlock': 'd8',\r\n    'sorcerer': 'd6',\r\n    'wizard': 'd6'\r\n  };\r\n\r\n  for (const [classKey, die] of Object.entries(hitDiceMap)) {\r\n    if (className.includes(classKey)) {\r\n      return die;\r\n    }\r\n  }\r\n\r\n  // Default to d8 if class not found\r\n  return 'd8';\r\n}\r\n\r\nfunction initializeHitDice() {\r\n  // Initialize hit dice if not already set\r\n  if (characterData.hitDice === undefined) {\r\n    const level = characterData.level || 1;\r\n    characterData.hitDice = {\r\n      current: level,\r\n      max: level,\r\n      type: getHitDieType()\r\n    };\r\n  }\r\n}\r\n\r\nfunction spendHitDice() {\r\n  initializeHitDice();\r\n\r\n  const conMod = characterData.attributeMods?.constitution || 0;\r\n  const hitDie = characterData.hitDice.type;\r\n  const maxDice = parseInt(hitDie.substring(1)); // Extract number from \"d8\" -> 8\r\n\r\n  if (characterData.hitDice.current <= 0) {\r\n    alert('You have no Hit Dice remaining to spend!');\r\n    return;\r\n  }\r\n\r\n  let totalHealed = 0;\r\n  let diceSpent = 0;\r\n\r\n  while (characterData.hitDice.current > 0 && characterData.hitPoints.current < characterData.hitPoints.max) {\r\n    const spend = confirm(\r\n      `Spend a Hit Die? (${characterData.hitDice.current}/${characterData.hitDice.max} remaining)\\n\\n` +\r\n      `Hit Die: ${hitDie}\\n` +\r\n      `CON Modifier: ${conMod >= 0 ? '+' : ''}${conMod}\\n` +\r\n      `Current HP: ${characterData.hitPoints.current}/${characterData.hitPoints.max}\\n` +\r\n      `HP Healed so far: ${totalHealed}`\r\n    );\r\n\r\n    if (!spend) break;\r\n\r\n    // Roll the hit die\r\n    const roll = Math.floor(Math.random() * maxDice) + 1;\r\n    const healing = Math.max(1, roll + conMod); // Minimum 1 HP restored\r\n\r\n    characterData.hitDice.current--;\r\n    diceSpent++;\r\n\r\n    const oldHP = characterData.hitPoints.current;\r\n    characterData.hitPoints.current = Math.min(\r\n      characterData.hitPoints.current + healing,\r\n      characterData.hitPoints.max\r\n    );\r\n    const actualHealing = characterData.hitPoints.current - oldHP;\r\n    totalHealed += actualHealing;\r\n\r\n    debug.log(`\uD83C\uDFB2 Rolled ${hitDie}: ${roll} + ${conMod} = ${healing} HP (restored ${actualHealing})`);\r\n\r\n    // Announce the roll with fancy formatting\r\n    if (window.opener && !window.opener.closed) {\r\n      const colorBanner = getColoredBanner();\r\n      window.opener.postMessage({\r\n        action: 'announceSpell',\r\n        message: `&{template:default} {{name=${colorBanner}${characterData.name} spends hit dice}} {{Roll=\uD83C\uDFB2 ${hitDie}: ${roll} + ${conMod} CON}} {{HP Restored=${healing}}} {{Current HP=${characterData.hitPoints.current}/${characterData.hitPoints.max}}}`,\r\n        color: characterData.notificationColor\r\n      }, '*');\r\n    }\r\n  }\r\n\r\n  if (diceSpent > 0) {\r\n    showNotification(`\uD83C\uDFB2 Spent ${diceSpent} Hit Dice and restored ${totalHealed} HP!`);\r\n  } else {\r\n    showNotification('No Hit Dice spent.');\r\n  }\r\n}\r\n\r\nfunction takeLongRest() {\r\n  if (!characterData) {\r\n    showNotification('\u274C Character data not available', 'error');\r\n    return;\r\n  }\r\n\r\n  const confirmed = confirm('Take a Long Rest?\\n\\nThis will:\\n- Fully restore HP\\n- Restore all spell slots\\n- Restore all class features\\n- Restore half your hit dice (minimum 1)');\r\n\r\n  if (!confirmed) return;\r\n\r\n  debug.log('\uD83C\uDF19 Taking long rest...');\r\n\r\n  // Initialize hit dice if needed\r\n  initializeHitDice();\r\n\r\n  // Restore all HP\r\n  characterData.hitPoints.current = characterData.hitPoints.max;\r\n  debug.log('\u2705 Restored HP to max');\r\n\r\n  // Clear temporary HP (RAW: temp HP doesn't persist through rest)\r\n  if (characterData.temporaryHP > 0) {\r\n    characterData.temporaryHP = 0;\r\n    debug.log('\u2705 Cleared temporary HP');\r\n  }\r\n\r\n  // Note: Inspiration is NOT automatically restored on long rest\r\n  // It must be granted by the DM, so we don't touch it here\r\n  debug.log(`\u2139\uFE0F Inspiration status unchanged (${characterData.inspiration ? 'active' : 'none'})`);\r\n\r\n  // Restore hit dice (half of max, minimum 1)\r\n  const hitDiceRestored = Math.max(1, Math.floor(characterData.hitDice.max / 2));\r\n  const oldHitDice = characterData.hitDice.current;\r\n  characterData.hitDice.current = Math.min(\r\n    characterData.hitDice.current + hitDiceRestored,\r\n    characterData.hitDice.max\r\n  );\r\n  debug.log(`\u2705 Restored ${characterData.hitDice.current - oldHitDice} hit dice (${characterData.hitDice.current}/${characterData.hitDice.max})`);\r\n\r\n  // Restore all spell slots\r\n  if (characterData.spellSlots) {\r\n    // Restore regular spell slots (levels 1-9)\r\n    for (let level = 1; level <= 9; level++) {\r\n      const slotVar = `level${level}SpellSlots`;\r\n      const slotMaxVar = `level${level}SpellSlotsMax`;\r\n\r\n      if (characterData.spellSlots[slotMaxVar] !== undefined) {\r\n        characterData.spellSlots[slotVar] = characterData.spellSlots[slotMaxVar];\r\n        debug.log(`\u2705 Restored level ${level} spell slots`);\r\n      }\r\n    }\r\n\r\n    // Also restore Pact Magic slots (Warlock)\r\n    if (characterData.spellSlots.pactMagicSlotsMax !== undefined) {\r\n      characterData.spellSlots.pactMagicSlots = characterData.spellSlots.pactMagicSlotsMax;\r\n      debug.log(`\u2705 Restored Pact Magic slots: ${characterData.spellSlots.pactMagicSlots}/${characterData.spellSlots.pactMagicSlotsMax}`);\r\n    }\r\n  }\r\n\r\n  // Restore all class resources (Ki, Sorcery Points, Rage, etc.)\r\n  if (characterData.resources && characterData.resources.length > 0) {\r\n    characterData.resources.forEach(resource => {\r\n      resource.current = resource.max;\r\n\r\n      // Also update otherVariables to keep data in sync\r\n      if (characterData.otherVariables && resource.varName) {\r\n        characterData.otherVariables[resource.varName] = resource.current;\r\n      }\r\n\r\n      debug.log(`\u2705 Restored ${resource.name} (${resource.current}/${resource.max})`);\r\n    });\r\n  }\r\n\r\n  // Restore all class resources\r\n  if (characterData.otherVariables) {\r\n    Object.keys(characterData.otherVariables).forEach(key => {\r\n      // If there's a Max variant, restore to max\r\n      if (key.endsWith('Max')) {\r\n        const baseKey = key.replace('Max', '');\r\n        if (characterData.otherVariables[baseKey] !== undefined) {\r\n          characterData.otherVariables[baseKey] = characterData.otherVariables[key];\r\n          debug.log(`\u2705 Restored ${baseKey}`);\r\n        }\r\n      }\r\n    });\r\n\r\n    // Also restore specific resources that might not follow the Max pattern\r\n    if (characterData.otherVariables.kiMax !== undefined) {\r\n      characterData.otherVariables.ki = characterData.otherVariables.kiMax;\r\n    } else if (characterData.otherVariables.kiPointsMax !== undefined) {\r\n      characterData.otherVariables.kiPoints = characterData.otherVariables.kiPointsMax;\r\n    }\r\n\r\n    if (characterData.otherVariables.sorceryPointsMax !== undefined) {\r\n      characterData.otherVariables.sorceryPoints = characterData.otherVariables.sorceryPointsMax;\r\n    }\r\n\r\n    if (characterData.otherVariables.pactMagicSlotsMax !== undefined) {\r\n      characterData.otherVariables.pactMagicSlots = characterData.otherVariables.pactMagicSlotsMax;\r\n    }\r\n\r\n    // Restore Channel Divinity (try all possible variable names)\r\n    if (characterData.otherVariables.channelDivinityClericMax !== undefined) {\r\n      characterData.otherVariables.channelDivinityCleric = characterData.otherVariables.channelDivinityClericMax;\r\n    } else if (characterData.otherVariables.channelDivinityPaladinMax !== undefined) {\r\n      characterData.otherVariables.channelDivinityPaladin = characterData.otherVariables.channelDivinityPaladinMax;\r\n    } else if (characterData.otherVariables.channelDivinityMax !== undefined) {\r\n      characterData.otherVariables.channelDivinity = characterData.otherVariables.channelDivinityMax;\r\n    }\r\n  }\r\n\r\n  // Reset limited uses for all abilities\r\n  if (characterData.actions) {\r\n    characterData.actions.forEach(action => {\r\n      if (action.uses && action.usesUsed > 0) {\r\n        action.usesUsed = 0;\r\n        debug.log(`\u2705 Reset uses for ${action.name}`);\r\n      }\r\n    });\r\n  }\r\n\r\n  saveCharacterData();\r\n  buildSheet(characterData);\r\n\r\n  showNotification('\uD83C\uDF19 Long Rest complete! All resources restored.');\r\n  debug.log('\u2705 Long rest complete');\r\n\r\n  // Announce to Roll20 with fancy formatting\r\n  const colorBanner = getColoredBanner();\r\n  const messageData = {\r\n    action: 'announceSpell',\r\n    message: `&{template:default} {{name=${colorBanner}${characterData.name} takes a long rest}} {{=\uD83C\uDF19 Long rest complete!}} {{HP=${characterData.hitPoints.current}/${characterData.hitPoints.max} (Fully Restored)}} {{=All spell slots and resources restored!}}`,\r\n    color: characterData.notificationColor\r\n  };\r\n\r\n  // Try window.opener first (Chrome)\r\n  if (window.opener && !window.opener.closed) {\r\n    try {\r\n      window.opener.postMessage(messageData, '*');\r\n    } catch (error) {\r\n      debug.warn('\u26A0\uFE0F Could not send via window.opener:', error.message);\r\n      // Fallback to background script relay\r\n      browserAPI.runtime.sendMessage({\r\n        action: 'relayRollToRoll20',\r\n        roll: messageData\r\n      });\r\n    }\r\n  } else {\r\n    // Fallback: Use background script to relay to Roll20 (Firefox)\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'relayRollToRoll20',\r\n      roll: messageData\r\n    });\r\n  }\r\n}\r\n\r\n// Initialize collapsible sections\r\nfunction initCollapsibleSections() {\r\n  const sections = document.querySelectorAll('.section h3');\r\n\r\n  sections.forEach(header => {\r\n    header.addEventListener('click', function() {\r\n      const section = this.parentElement;\r\n      const content = section.querySelector('.section-content');\r\n\r\n      // Toggle collapsed class\r\n      this.classList.toggle('collapsed');\r\n      content.classList.toggle('collapsed');\r\n    });\r\n  });\r\n}\r\n\r\n// Helper function to collapse a section by its container ID\r\nfunction collapseSectionByContainerId(containerId) {\r\n  const container = document.getElementById(containerId);\r\n  if (!container) return;\r\n\r\n  const section = container.closest('.section');\r\n  if (!section) return;\r\n\r\n  const header = section.querySelector('h3');\r\n  const content = section.querySelector('.section-content');\r\n\r\n  if (header && content) {\r\n    header.classList.add('collapsed');\r\n    content.classList.add('collapsed');\r\n  }\r\n}\r\n\r\n// Helper function to expand a section by its container ID\r\nfunction expandSectionByContainerId(containerId) {\r\n  const container = document.getElementById(containerId);\r\n  if (!container) return;\r\n\r\n  const section = container.closest('.section');\r\n  if (!section) return;\r\n\r\n  const header = section.querySelector('h3');\r\n  const content = section.querySelector('.section-content');\r\n\r\n  if (header && content) {\r\n    header.classList.remove('collapsed');\r\n    content.classList.remove('collapsed');\r\n  }\r\n}\r\n\r\n// Call collapsible initialization when DOM is ready\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', initCollapsibleSections);\r\n} else {\r\n  initCollapsibleSections();\r\n}\r\n\r\n// Add close button event listener (CSP-compliant, no inline onclick)\r\nfunction initCloseButton() {\r\n  const closeBtn = document.getElementById('close-btn');\r\n  if (closeBtn) {\r\n    closeBtn.addEventListener('click', () => {\r\n      window.close();\r\n    });\r\n  }\r\n}\r\n\r\n// Initialize close button when DOM is ready\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', initCloseButton);\r\n} else {\r\n  initCloseButton();\r\n}\r\n\r\n// Save character data when window is about to close/refresh\r\n// This ensures local modifications persist through browser refresh\r\nwindow.addEventListener('beforeunload', () => {\r\n  if (characterData && currentSlotId) {\r\n    debug.log('\uD83D\uDCBE Saving character data before window closes');\r\n    // Use sendMessage synchronously during unload\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'storeCharacterData',\r\n      data: characterData,\r\n      slotId: currentSlotId  // CRITICAL: Pass slotId for proper persistence\r\n    });\r\n    debug.log(`\u2705 Saved character data: ${characterData.name} (slotId: ${currentSlotId})`);\r\n  }\r\n});\r\n\r\n// ============================================================================\r\n// COMBAT MECHANICS\r\n// ============================================================================\r\n\r\n/**\r\n * Initialize combat mechanics (action economy, conditions, concentration)\r\n */\r\nfunction initCombatMechanics() {\r\n  debug.log('\uD83C\uDFAE Initializing combat mechanics...');\r\n\r\n  // Initialize action economy trackers\r\n  initActionEconomy();\r\n\r\n  // Initialize conditions manager\r\n  initConditionsManager();\r\n\r\n  // Initialize concentration tracker\r\n  initConcentrationTracker();\r\n\r\n  // Initialize GM mode toggle\r\n  initGMMode();\r\n\r\n  debug.log('\u2705 Combat mechanics initialized');\r\n}\r\n\r\n/**\r\n * Action Economy Tracker\r\n */\r\nlet isMyTurn = false; // Track if it's currently this character's turn\r\n\r\nfunction initActionEconomy() {\r\n  const actionIndicator = document.getElementById('action-indicator');\r\n  const bonusActionIndicator = document.getElementById('bonus-action-indicator');\r\n  const movementIndicator = document.getElementById('movement-indicator');\r\n  const reactionIndicator = document.getElementById('reaction-indicator');\r\n  const turnResetBtn = document.getElementById('turn-reset-btn');\r\n  const roundResetBtn = document.getElementById('round-reset-btn');\r\n\r\n  if (!actionIndicator) {\r\n    debug.warn('\u26A0\uFE0F Action economy elements not found');\r\n    return;\r\n  }\r\n\r\n  // Set initial state - only reaction available when not your turn\r\n  updateActionEconomyAvailability();\r\n\r\n  // Click to toggle used state (can only mark as used, not restore manually)\r\n  [actionIndicator, bonusActionIndicator, movementIndicator, reactionIndicator].forEach(indicator => {\r\n    if (indicator) {\r\n      indicator.addEventListener('click', () => {\r\n        // Check if action is disabled (not your turn)\r\n        if (indicator.dataset.disabled === 'true') {\r\n          showNotification('\u26A0\uFE0F Only reactions available when it\\'s not your turn!');\r\n          return;\r\n        }\r\n\r\n        const isUsed = indicator.dataset.used === 'true';\r\n        const actionLabel = indicator.querySelector('.action-label').textContent;\r\n\r\n        // Can only mark as used, not restore manually (use reset buttons for that)\r\n        if (!isUsed) {\r\n          indicator.dataset.used = 'true';\r\n          debug.log(`\uD83C\uDFAF ${actionLabel} used`);\r\n          postActionToChat(actionLabel, 'used');\r\n        } else {\r\n          showNotification(`\u26A0\uFE0F Use Turn/Round Reset to restore ${actionLabel}`);\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  // Turn reset (Action, Bonus Action, Movement)\r\n  if (turnResetBtn) {\r\n    turnResetBtn.addEventListener('click', () => {\r\n      [actionIndicator, bonusActionIndicator, movementIndicator].forEach(indicator => {\r\n        if (indicator) indicator.dataset.used = 'false';\r\n      });\r\n      debug.log('\uD83D\uDD04 Turn reset: Action, Bonus Action, Movement restored');\r\n      showNotification('\uD83D\uDD04 Turn reset!');\r\n\r\n      // Announce to Roll20 chat\r\n      postToChatIfOpener(`\uD83D\uDD04 ${characterData.name} resets turn actions!`);\r\n\r\n      // Update Discord\r\n      postActionEconomyToDiscord();\r\n    });\r\n  }\r\n\r\n  // Round reset (includes Reaction)\r\n  if (roundResetBtn) {\r\n    roundResetBtn.addEventListener('click', () => {\r\n      [actionIndicator, bonusActionIndicator, movementIndicator, reactionIndicator].forEach(indicator => {\r\n        if (indicator) indicator.dataset.used = 'false';\r\n      });\r\n      debug.log('\uD83D\uDD04 Round reset: All actions restored');\r\n      showNotification('\uD83D\uDD04 Round reset!');\r\n\r\n      // Announce to Roll20 chat\r\n      postToChatIfOpener(`\uD83D\uDD04 ${characterData.name} resets all actions!`);\r\n\r\n      // Update Discord\r\n      postActionEconomyToDiscord();\r\n    });\r\n  }\r\n\r\n  debug.log('\u2705 Action economy initialized');\r\n}\r\n\r\n/**\r\n * Update action economy availability based on turn state\r\n */\r\nfunction updateActionEconomyAvailability() {\r\n  const actionIndicator = document.getElementById('action-indicator');\r\n  const bonusActionIndicator = document.getElementById('bonus-action-indicator');\r\n  const movementIndicator = document.getElementById('movement-indicator');\r\n  const reactionIndicator = document.getElementById('reaction-indicator');\r\n\r\n  const turnBasedActions = [actionIndicator, bonusActionIndicator, movementIndicator];\r\n\r\n  if (isMyTurn) {\r\n    // Enable all actions on your turn - remove ALL inline styles to let CSS control everything\r\n    [...turnBasedActions, reactionIndicator].forEach(indicator => {\r\n      if (indicator) {\r\n        indicator.dataset.disabled = 'false';\r\n        // Remove all inline styles - let CSS [data-used] attribute fully control appearance\r\n        indicator.style.removeProperty('opacity');\r\n        indicator.style.removeProperty('cursor');\r\n        indicator.style.removeProperty('pointer-events');\r\n      }\r\n    });\r\n  } else {\r\n    // Disable turn-based actions, keep reaction available\r\n    turnBasedActions.forEach(indicator => {\r\n      if (indicator) {\r\n        indicator.dataset.disabled = 'true';\r\n        // Force disabled appearance with inline styles (overrides CSS)\r\n        indicator.style.opacity = '0.3';\r\n        indicator.style.cursor = 'not-allowed';\r\n        indicator.style.pointerEvents = 'auto'; // Still clickable for warning\r\n      }\r\n    });\r\n\r\n    // Keep reaction enabled\r\n    if (reactionIndicator) {\r\n      reactionIndicator.dataset.disabled = 'false';\r\n      // Remove all inline styles for reaction\r\n      reactionIndicator.style.removeProperty('opacity');\r\n      reactionIndicator.style.removeProperty('cursor');\r\n      reactionIndicator.style.removeProperty('pointer-events');\r\n    }\r\n  }\r\n\r\n  debug.log(`\uD83D\uDD04 Action economy updated: isMyTurn=${isMyTurn}, actions=${turnBasedActions.length > 0 ? 'enabled' : 'disabled'}, reaction=${reactionIndicator ? 'enabled' : 'N/A'}`);\r\n}\r\n\r\n/**\r\n * Activate turn for this character\r\n */\r\nfunction activateTurn() {\r\n  debug.log('\u2694\uFE0F Activating turn - setting isMyTurn = true');\r\n  isMyTurn = true;\r\n\r\n  // Reset reaction at the start of your turn (one reaction per round)\r\n  const reactionIndicator = document.getElementById('reaction-indicator');\r\n  if (reactionIndicator) {\r\n    reactionIndicator.dataset.used = 'false';\r\n    debug.log('\uD83D\uDD04 Reaction restored (one per round limit)');\r\n  }\r\n\r\n  updateActionEconomyAvailability();\r\n\r\n  // Add visual highlight effect\r\n  const actionEconomy = document.querySelector('.action-economy');\r\n  if (actionEconomy) {\r\n    actionEconomy.style.boxShadow = '0 0 20px rgba(78, 205, 196, 0.6)';\r\n    actionEconomy.style.border = '2px solid #4ECDC4';\r\n    debug.log('\u2694\uFE0F Added visual highlight to action economy');\r\n  }\r\n\r\n  // Send action economy state to Discord (with fresh actions available)\r\n  // Small delay to ensure action state is updated\r\n  setTimeout(() => postActionEconomyToDiscord(), 100);\r\n\r\n  debug.log('\u2694\uFE0F Turn activated! All actions available.');\r\n}\r\n\r\n/**\r\n * Deactivate turn for this character\r\n */\r\nfunction deactivateTurn() {\r\n  isMyTurn = false;\r\n  updateActionEconomyAvailability();\r\n\r\n  // Remove visual highlight\r\n  const actionEconomy = document.querySelector('.action-economy');\r\n  if (actionEconomy) {\r\n    actionEconomy.style.boxShadow = '';\r\n    actionEconomy.style.border = '';\r\n  }\r\n\r\n  debug.log('\u23F8\uFE0F Turn ended. Only reaction available.');\r\n}\r\n\r\n/**\r\n * Mark action as used based on casting time\r\n * This handles the action economy tracking for spells and abilities\r\n */\r\nfunction markActionAsUsed(castingTime) {\r\n  if (!castingTime) {\r\n    debug.warn('\u26A0\uFE0F No casting time provided to markActionAsUsed');\r\n    return;\r\n  }\r\n  \r\n  const actionIndicator = document.getElementById('action-indicator');\r\n  const bonusActionIndicator = document.getElementById('bonus-action-indicator');\r\n  const movementIndicator = document.getElementById('movement-indicator');\r\n  const reactionIndicator = document.getElementById('reaction-indicator');\r\n  \r\n  // Normalize casting time for comparison (case insensitive)\r\n  const normalizedTime = castingTime.toLowerCase().trim();\r\n  \r\n  debug.log(`\uD83C\uDFAF Marking action as used for casting time: \"${castingTime}\" (normalized: \"${normalizedTime}\")`);\r\n  debug.log(`\uD83C\uDFAF Available indicators: Action=${!!actionIndicator}, Bonus=${!!bonusActionIndicator}, Movement=${!!movementIndicator}, Reaction=${!!reactionIndicator}`);\r\n  \r\n  // Mark appropriate action as used based on casting time\r\n  if (normalizedTime.includes('bonus')) {\r\n    if (bonusActionIndicator && bonusActionIndicator.dataset.used !== 'true') {\r\n      bonusActionIndicator.dataset.used = 'true';\r\n      debug.log(`\uD83C\uDFAF Bonus Action used for casting`);\r\n      // Action usage is tracked visually, no need to announce to chat\r\n    } else {\r\n      debug.log(`\u26A0\uFE0F Bonus Action indicator not found or already used`);\r\n    }\r\n  } else if (normalizedTime.includes('movement') || normalizedTime.includes('move')) {\r\n    if (movementIndicator && movementIndicator.dataset.used !== 'true') {\r\n      movementIndicator.dataset.used = 'true';\r\n      debug.log(`\uD83C\uDFAF Movement used for casting`);\r\n      // Action usage is tracked visually, no need to announce to chat\r\n    } else {\r\n      debug.log(`\u26A0\uFE0F Movement indicator not found or already used`);\r\n    }\r\n  } else if (normalizedTime.includes('reaction')) {\r\n    // Reactions are limited to one per round\r\n    if (reactionIndicator && reactionIndicator.dataset.used !== 'true') {\r\n      reactionIndicator.dataset.used = 'true';\r\n      debug.log(`\uD83C\uDFAF Reaction used for casting (one per round limit)`);\r\n      // Action usage is tracked visually, no need to announce to chat\r\n    } else {\r\n      debug.log(`\u26A0\uFE0F Reaction indicator not found or already used this round`);\r\n    }\r\n  } else {\r\n    // Default to action for anything else\r\n    if (actionIndicator && actionIndicator.dataset.used !== 'true') {\r\n      actionIndicator.dataset.used = 'true';\r\n      debug.log(`\uD83C\uDFAF Action used for casting`);\r\n      // Action usage is tracked visually, no need to announce to chat\r\n    } else {\r\n      debug.log(`\u26A0\uFE0F Action indicator not found or already used`);\r\n    }\r\n  }\r\n  \r\n  // Update visual state\r\n  updateActionEconomyAvailability();\r\n}\r\n/**\r\n * Post action usage to chat\r\n */\r\nfunction postActionToChat(actionLabel, state) {\r\n  const emoji = state === 'used' ? '\u274C' : '\u2705';\r\n  const message = `${emoji} ${characterData.name} ${state === 'used' ? 'uses' : 'restores'} ${actionLabel}`;\r\n  postToChatIfOpener(message);\r\n\r\n  // Also post to Discord\r\n  postActionEconomyToDiscord();\r\n}\r\n\r\n/**\r\n * Get current action economy state\r\n */\r\nfunction getActionEconomyState() {\r\n  const actionIndicator = document.getElementById('action-indicator');\r\n  const bonusActionIndicator = document.getElementById('bonus-action-indicator');\r\n  const movementIndicator = document.getElementById('movement-indicator');\r\n  const reactionIndicator = document.getElementById('reaction-indicator');\r\n\r\n  return {\r\n    action: actionIndicator?.dataset.used === 'true',\r\n    bonus: bonusActionIndicator?.dataset.used === 'true',\r\n    movement: movementIndicator?.dataset.used === 'true',\r\n    reaction: reactionIndicator?.dataset.used === 'true'\r\n  };\r\n}\r\n\r\n/**\r\n * Post action economy state to Discord webhook\r\n */\r\nfunction postActionEconomyToDiscord() {\r\n  if (!characterData || !characterData.name) return;\r\n\r\n  const actions = getActionEconomyState();\r\n\r\n  // Send via the opener (Roll20 content script) which has access to browserAPI\r\n  if (window.opener && !window.opener.closed) {\r\n    window.opener.postMessage({\r\n      action: 'postToDiscordFromPopup',\r\n      payload: {\r\n        type: 'actionUpdate',\r\n        characterName: characterData.name,\r\n        actions: actions\r\n      }\r\n    }, '*');\r\n    debug.log(`\uD83C\uDFAE Discord: Posted action economy update for ${characterData.name}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Post a message to Roll20 chat if opener exists\r\n */\r\nfunction postToChatIfOpener(message) {\r\n  try {\r\n    if (window.opener && !window.opener.closed) {\r\n      window.opener.postMessage({\r\n        action: 'postChatMessageFromPopup',\r\n        message: message\r\n      }, '*');\r\n      debug.log(`\uD83D\uDCE4 Posted to chat: ${message}`);\r\n    }\r\n  } catch (error) {\r\n    debug.warn('\u26A0\uFE0F Could not post to chat:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Effects System - Buffs and Debuffs\r\n */\r\n\r\n// POSITIVE EFFECTS (Buffs/Spells)\r\nconst POSITIVE_EFFECTS = [\r\n  {\r\n    name: 'Bless',\r\n    icon: '\u2728',\r\n    color: '#f39c12',\r\n    description: '+1d4 to attack rolls and saving throws',\r\n    modifier: { attack: '1d4', save: '1d4' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Guidance',\r\n    icon: '\uD83D\uDE4F',\r\n    color: '#3498db',\r\n    description: '+1d4 to one ability check',\r\n    modifier: { skill: '1d4' },\r\n    autoApply: false // User choice required\r\n  },\r\n  {\r\n    name: 'Bardic Inspiration (d6)',\r\n    icon: '\uD83C\uDFB5',\r\n    color: '#9b59b6',\r\n    description: 'Bard levels 1-4: +d6 to ability check, attack, or save',\r\n    modifier: { attack: 'd6', skill: 'd6', save: 'd6' },\r\n    autoApply: false\r\n  },\r\n  {\r\n    name: 'Bardic Inspiration (d8)',\r\n    icon: '\uD83C\uDFB5',\r\n    color: '#9b59b6',\r\n    description: 'Bard levels 5-9: +d8 to ability check, attack, or save',\r\n    modifier: { attack: 'd8', skill: 'd8', save: 'd8' },\r\n    autoApply: false\r\n  },\r\n  {\r\n    name: 'Bardic Inspiration (d10)',\r\n    icon: '\uD83C\uDFB5',\r\n    color: '#9b59b6',\r\n    description: 'Bard levels 10-14: +d10 to ability check, attack, or save',\r\n    modifier: { attack: 'd10', skill: 'd10', save: 'd10' },\r\n    autoApply: false\r\n  },\r\n  {\r\n    name: 'Bardic Inspiration (d12)',\r\n    icon: '\uD83C\uDFB5',\r\n    color: '#9b59b6',\r\n    description: 'Bard levels 15-20: +d12 to ability check, attack, or save',\r\n    modifier: { attack: 'd12', skill: 'd12', save: 'd12' },\r\n    autoApply: false\r\n  },\r\n  {\r\n    name: 'Haste',\r\n    icon: '\u26A1',\r\n    color: '#3498db',\r\n    description: '+2 AC, advantage on DEX saves, extra action',\r\n    modifier: { ac: 2, dexSave: 'advantage' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Enlarge',\r\n    icon: '\u2B06\uFE0F',\r\n    color: '#27ae60',\r\n    description: '+1d4 weapon damage, advantage on STR checks/saves',\r\n    modifier: { damage: '1d4', strCheck: 'advantage', strSave: 'advantage' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Invisibility',\r\n    icon: '\uD83D\uDC7B',\r\n    color: '#ecf0f1',\r\n    description: 'Advantage on attack rolls, enemies have disadvantage',\r\n    modifier: { attack: 'advantage' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Shield of Faith',\r\n    icon: '\uD83D\uDEE1\uFE0F',\r\n    color: '#f39c12',\r\n    description: '+2 AC',\r\n    modifier: { ac: 2 },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Heroism',\r\n    icon: '\uD83E\uDDB8',\r\n    color: '#e67e22',\r\n    description: 'Immune to frightened, temp HP each turn',\r\n    modifier: { frightened: 'immune' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Enhance Ability',\r\n    icon: '\uD83D\uDCAA',\r\n    color: '#27ae60',\r\n    description: 'Advantage on ability checks with chosen ability',\r\n    modifier: { skill: 'advantage' },\r\n    autoApply: false\r\n  },\r\n  {\r\n    name: 'Aid',\r\n    icon: '\u2764\uFE0F',\r\n    color: '#e74c3c',\r\n    description: 'Max HP increased by 5',\r\n    modifier: { maxHp: 5 },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'True Strike',\r\n    icon: '\uD83C\uDFAF',\r\n    color: '#3498db',\r\n    description: 'Advantage on next attack roll',\r\n    modifier: { attack: 'advantage' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Faerie Fire',\r\n    icon: '\u2728',\r\n    color: '#9b59b6',\r\n    description: 'Attackers have advantage against target',\r\n    modifier: {},\r\n    autoApply: false\r\n  }\r\n];\r\n\r\n// NEGATIVE EFFECTS (Debuffs/Conditions)\r\nconst NEGATIVE_EFFECTS = [\r\n  {\r\n    name: 'Bane',\r\n    icon: '\uD83D\uDC80',\r\n    color: '#e74c3c',\r\n    description: '-1d4 to attack rolls and saving throws',\r\n    modifier: { attack: '-1d4', save: '-1d4' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Poisoned',\r\n    icon: '\u2620\uFE0F',\r\n    color: '#27ae60',\r\n    description: 'Disadvantage on attack rolls and ability checks',\r\n    modifier: { attack: 'disadvantage', skill: 'disadvantage' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Frightened',\r\n    icon: '\uD83D\uDE31',\r\n    color: '#e67e22',\r\n    description: 'Disadvantage on ability checks and attack rolls',\r\n    modifier: { attack: 'disadvantage', skill: 'disadvantage' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Stunned',\r\n    icon: '\uD83D\uDCAB',\r\n    color: '#9b59b6',\r\n    description: 'Incapacitated, auto-fail STR/DEX saves, attackers have advantage',\r\n    modifier: { strSave: 'fail', dexSave: 'fail' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Paralyzed',\r\n    icon: '\uD83E\uDDCA',\r\n    color: '#34495e',\r\n    description: 'Incapacitated, auto-fail STR/DEX saves, attacks within 5ft are crits',\r\n    modifier: { strSave: 'fail', dexSave: 'fail' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Restrained',\r\n    icon: '\u26D3\uFE0F',\r\n    color: '#7f8c8d',\r\n    description: 'Disadvantage on DEX saves and attack rolls',\r\n    modifier: { attack: 'disadvantage', dexSave: 'disadvantage' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Blinded',\r\n    icon: '\uD83D\uDE48',\r\n    color: '#34495e',\r\n    description: 'Auto-fail sight checks, disadvantage on attacks',\r\n    modifier: { attack: 'disadvantage', perception: 'disadvantage' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Deafened',\r\n    icon: '\uD83D\uDE49',\r\n    color: '#7f8c8d',\r\n    description: 'Auto-fail hearing checks',\r\n    modifier: { perception: 'disadvantage' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Charmed',\r\n    icon: '\uD83D\uDC96',\r\n    color: '#e91e63',\r\n    description: 'Cannot attack charmer, charmer has advantage on social checks',\r\n    modifier: {},\r\n    autoApply: false\r\n  },\r\n  {\r\n    name: 'Grappled',\r\n    icon: '\uD83E\uDD3C',\r\n    color: '#f39c12',\r\n    description: 'Speed becomes 0',\r\n    modifier: { speed: 0 },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Prone',\r\n    icon: '\u2B07\uFE0F',\r\n    color: '#95a5a6',\r\n    description: 'Disadvantage on attack rolls, melee attacks against you have advantage',\r\n    modifier: { attack: 'disadvantage' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Incapacitated',\r\n    icon: '\uD83D\uDE35',\r\n    color: '#c0392b',\r\n    description: 'Cannot take actions or reactions',\r\n    modifier: {},\r\n    autoApply: false\r\n  },\r\n  {\r\n    name: 'Unconscious',\r\n    icon: '\uD83D\uDE34',\r\n    color: '#34495e',\r\n    description: 'Incapacitated, drop everything, auto-fail STR/DEX saves',\r\n    modifier: { strSave: 'fail', dexSave: 'fail' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Petrified',\r\n    icon: '\uD83D\uDDFF',\r\n    color: '#95a5a6',\r\n    description: 'Incapacitated, auto-fail STR/DEX saves, resistance to all damage',\r\n    modifier: { strSave: 'fail', dexSave: 'fail' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Slowed',\r\n    icon: '\uD83D\uDC0C',\r\n    color: '#95a5a6',\r\n    description: 'Speed halved, -2 AC and DEX saves, no reactions',\r\n    modifier: { ac: -2, dexSave: '-2' },\r\n    autoApply: true\r\n  },\r\n  {\r\n    name: 'Hexed',\r\n    icon: '\uD83D\uDD2E',\r\n    color: '#9b59b6',\r\n    description: 'Disadvantage on ability checks with chosen ability, extra damage to caster',\r\n    modifier: { skill: 'disadvantage' },\r\n    autoApply: false\r\n  },\r\n  {\r\n    name: 'Cursed',\r\n    icon: '\uD83D\uDE08',\r\n    color: '#c0392b',\r\n    description: 'Disadvantage on attacks and saves against caster',\r\n    modifier: { attack: 'disadvantage', save: 'disadvantage' },\r\n    autoApply: true\r\n  }\r\n];\r\n\r\nlet activeConditions = [];\r\nlet activeBuffs = [];\r\n\r\nfunction initConditionsManager() {\r\n  const addConditionBtn = document.getElementById('add-condition-btn');\r\n\r\n  if (addConditionBtn) {\r\n    // Open modal when clicking conditions button\r\n    addConditionBtn.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      showEffectsModal();\r\n    });\r\n  }\r\n\r\n  debug.log('\u2705 Effects manager initialized (buffs + debuffs)');\r\n}\r\n\r\nfunction showEffectsModal() {\r\n  // Create modal overlay\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  // Create modal content\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden;';\r\n\r\n  // Modal header\r\n  const header = document.createElement('div');\r\n  header.style.cssText = 'padding: 20px; border-bottom: 2px solid #ecf0f1; background: #f8f9fa;';\r\n  header.innerHTML = `\r\n    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\r\n      <h3 style=\"margin: 0; color: #2c3e50;\">\uD83C\uDFAD Effects & Conditions</h3>\r\n      <button id=\"effects-modal-close\" style=\"background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold;\">\u2715</button>\r\n    </div>\r\n  `;\r\n\r\n  // Tab navigation\r\n  const tabNav = document.createElement('div');\r\n  tabNav.style.cssText = 'display: flex; background: #ecf0f1; border-bottom: 2px solid #bdc3c7;';\r\n  tabNav.innerHTML = `\r\n    <button class=\"effects-tab-btn\" data-tab=\"buffs\" style=\"flex: 1; padding: 15px; background: white; border: none; border-bottom: 3px solid #27ae60; cursor: pointer; font-weight: bold; font-size: 1em; color: #27ae60; transition: all 0.2s;\">\u2728 Buffs</button>\r\n    <button class=\"effects-tab-btn\" data-tab=\"debuffs\" style=\"flex: 1; padding: 15px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; font-size: 1em; color: #7f8c8d; transition: all 0.2s;\">\uD83D\uDC80 Debuffs</button>\r\n  `;\r\n\r\n  // Tab content container\r\n  const tabContent = document.createElement('div');\r\n  tabContent.style.cssText = 'padding: 20px; overflow-y: auto; flex: 1;';\r\n\r\n  // Buffs tab\r\n  const buffsTab = document.createElement('div');\r\n  buffsTab.className = 'effects-tab-content';\r\n  buffsTab.dataset.tab = 'buffs';\r\n  buffsTab.style.display = 'block';\r\n  buffsTab.innerHTML = POSITIVE_EFFECTS.map(effect => `\r\n    <div class=\"effect-option\" data-effect=\"${effect.name}\" data-type=\"positive\" style=\"padding: 12px; margin-bottom: 10px; border: 2px solid ${effect.color}40; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;\">\r\n      <div style=\"display: flex; align-items: center; gap: 12px;\">\r\n        <span class=\"effect-icon\" style=\"font-size: 1.5em;\">${effect.icon}</span>\r\n        <div style=\"flex: 1;\">\r\n          <div class=\"effect-name\" style=\"font-weight: bold; color: #2c3e50; margin-bottom: 4px;\">${effect.name}</div>\r\n          <div class=\"effect-description\" style=\"font-size: 0.85em; color: #7f8c8d;\">${effect.description}</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `).join('');\r\n\r\n  // Debuffs tab\r\n  const debuffsTab = document.createElement('div');\r\n  debuffsTab.className = 'effects-tab-content';\r\n  debuffsTab.dataset.tab = 'debuffs';\r\n  debuffsTab.style.display = 'none';\r\n  debuffsTab.innerHTML = NEGATIVE_EFFECTS.map(effect => `\r\n    <div class=\"effect-option\" data-effect=\"${effect.name}\" data-type=\"negative\" style=\"padding: 12px; margin-bottom: 10px; border: 2px solid ${effect.color}40; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;\">\r\n      <div style=\"display: flex; align-items: center; gap: 12px;\">\r\n        <span class=\"effect-icon\" style=\"font-size: 1.5em;\">${effect.icon}</span>\r\n        <div style=\"flex: 1;\">\r\n          <div class=\"effect-name\" style=\"font-weight: bold; color: #2c3e50; margin-bottom: 4px;\">${effect.name}</div>\r\n          <div class=\"effect-description\" style=\"font-size: 0.85em; color: #7f8c8d;\">${effect.description}</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `).join('');\r\n\r\n  tabContent.appendChild(buffsTab);\r\n  tabContent.appendChild(debuffsTab);\r\n\r\n  // Assemble modal\r\n  modalContent.appendChild(header);\r\n  modalContent.appendChild(tabNav);\r\n  modalContent.appendChild(tabContent);\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  // Tab switching\r\n  const tabButtons = tabNav.querySelectorAll('.effects-tab-btn');\r\n  const tabContents = modalContent.querySelectorAll('.effects-tab-content');\r\n\r\n  tabButtons.forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      const targetTab = btn.dataset.tab;\r\n\r\n      // Update button styles\r\n      tabButtons.forEach(b => {\r\n        if (b.dataset.tab === targetTab) {\r\n          b.style.background = 'white';\r\n          b.style.color = targetTab === 'buffs' ? '#27ae60' : '#e74c3c';\r\n          b.style.borderBottom = `3px solid ${targetTab === 'buffs' ? '#27ae60' : '#e74c3c'}`;\r\n        } else {\r\n          b.style.background = 'transparent';\r\n          b.style.color = '#7f8c8d';\r\n          b.style.borderBottom = '3px solid transparent';\r\n        }\r\n      });\r\n\r\n      // Show target tab content\r\n      tabContents.forEach(content => {\r\n        content.style.display = content.dataset.tab === targetTab ? 'block' : 'none';\r\n      });\r\n    });\r\n  });\r\n\r\n  // Add hover effects\r\n  modalContent.querySelectorAll('.effect-option').forEach(option => {\r\n    option.addEventListener('mouseenter', () => {\r\n      option.style.transform = 'translateX(5px)';\r\n      option.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';\r\n    });\r\n    option.addEventListener('mouseleave', () => {\r\n      option.style.transform = 'translateX(0)';\r\n      option.style.boxShadow = 'none';\r\n    });\r\n  });\r\n\r\n  // Add effect when clicking option\r\n  modalContent.querySelectorAll('.effect-option').forEach(option => {\r\n    option.addEventListener('click', () => {\r\n      const effectName = option.dataset.effect;\r\n      const type = option.dataset.type === 'positive' ? 'positive' : 'negative';\r\n      addEffect(effectName, type);\r\n      modal.remove();\r\n    });\r\n  });\r\n\r\n  // Close button\r\n  const closeBtn = modalContent.querySelector('#effects-modal-close');\r\n  closeBtn.addEventListener('click', () => modal.remove());\r\n\r\n  // Click outside to close\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      modal.remove();\r\n    }\r\n  });\r\n}\r\n\r\nfunction addEffect(effectName, type) {\r\n  const effectsList = type === 'positive' ? POSITIVE_EFFECTS : NEGATIVE_EFFECTS;\r\n  const activeList = type === 'positive' ? activeBuffs : activeConditions;\r\n\r\n  // Don't add if already active\r\n  if (activeList.includes(effectName)) {\r\n    showNotification(`\u26A0\uFE0F ${effectName} already active`);\r\n    return;\r\n  }\r\n\r\n  const effect = effectsList.find(e => e.name === effectName);\r\n  activeList.push(effectName);\r\n\r\n  // Update the correct array reference\r\n  if (type === 'positive') {\r\n    activeBuffs = activeList;\r\n  } else {\r\n    activeConditions = activeList;\r\n  }\r\n\r\n  updateEffectsDisplay();\r\n  showNotification(`${effect.icon} ${effectName} applied!`);\r\n  debug.log(`\u2705 Effect added: ${effectName} (${type})`);\r\n\r\n  // Announce to Roll20 chat\r\n  const message = type === 'positive'\r\n    ? `${effect.icon} ${characterData.name} gains ${effectName}!`\r\n    : `${effect.icon} ${characterData.name} is now ${effectName}!`;\r\n  postToChatIfOpener(message);\r\n\r\n  // Save to character data\r\n  if (!characterData.activeEffects) {\r\n    characterData.activeEffects = { buffs: [], debuffs: [] };\r\n  }\r\n  if (type === 'positive') {\r\n    characterData.activeEffects.buffs = activeBuffs;\r\n  } else {\r\n    characterData.activeEffects.debuffs = activeConditions;\r\n  }\r\n  saveCharacterData();\r\n}\r\n\r\nfunction removeEffect(effectName, type) {\r\n  const effectsList = type === 'positive' ? POSITIVE_EFFECTS : NEGATIVE_EFFECTS;\r\n  const effect = effectsList.find(e => e.name === effectName);\r\n\r\n  if (type === 'positive') {\r\n    activeBuffs = activeBuffs.filter(e => e !== effectName);\r\n  } else {\r\n    activeConditions = activeConditions.filter(e => e !== effectName);\r\n  }\r\n\r\n  updateEffectsDisplay();\r\n  showNotification(`\u2705 ${effectName} removed`);\r\n  debug.log(`\uD83D\uDDD1\uFE0F Effect removed: ${effectName} (${type})`);\r\n\r\n  // Announce to Roll20 chat\r\n  const message = type === 'positive'\r\n    ? `\u2705 ${characterData.name} loses ${effectName}`\r\n    : `\u2705 ${characterData.name} is no longer ${effectName}`;\r\n  postToChatIfOpener(message);\r\n\r\n  // Save to character data\r\n  if (!characterData.activeEffects) {\r\n    characterData.activeEffects = { buffs: [], debuffs: [] };\r\n  }\r\n  if (type === 'positive') {\r\n    characterData.activeEffects.buffs = activeBuffs;\r\n  } else {\r\n    characterData.activeEffects.debuffs = activeConditions;\r\n  }\r\n  saveCharacterData();\r\n}\r\n\r\n// Legacy function for backwards compatibility\r\nfunction addCondition(conditionName) {\r\n  addEffect(conditionName, 'negative');\r\n}\r\n\r\nfunction removeCondition(conditionName) {\r\n  removeEffect(conditionName, 'negative');\r\n}\r\n\r\nfunction updateEffectsDisplay() {\r\n  const container = document.getElementById('active-conditions');\r\n  if (!container) return;\r\n\r\n  let html = '';\r\n\r\n  // Show buffs section\r\n  if (activeBuffs.length > 0) {\r\n    html += '<div style=\"margin-bottom: 15px;\">';\r\n    html += '<div style=\"font-size: 0.85em; font-weight: bold; color: #27ae60; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;\"><span>\u2728</span> BUFFS</div>';\r\n    html += activeBuffs.map(effectName => {\r\n      const effect = POSITIVE_EFFECTS.find(e => e.name === effectName);\r\n      return `\r\n        <div class=\"effect-badge\" data-effect=\"${effectName}\" data-type=\"positive\" title=\"${effect.description} - Click to remove\" style=\"background: ${effect.color}20; border: 2px solid ${effect.color}; cursor: pointer; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; transition: all 0.2s;\">\r\n          <div style=\"display: flex; align-items: center; gap: 8px;\">\r\n            <span class=\"effect-badge-icon\" style=\"font-size: 1.2em;\">${effect.icon}</span>\r\n            <div style=\"flex: 1;\">\r\n              <div style=\"font-weight: bold; color: var(--text-primary);\">${effect.name}</div>\r\n              <div style=\"font-size: 0.75em; color: var(--text-secondary); margin-top: 2px;\">${effect.description}</div>\r\n            </div>\r\n            <span class=\"effect-badge-remove\" style=\"font-weight: bold; opacity: 0.7; color: #e74c3c;\">\u2715</span>\r\n          </div>\r\n        </div>\r\n      `;\r\n    }).join('');\r\n    html += '</div>';\r\n  }\r\n\r\n  // Show debuffs section\r\n  if (activeConditions.length > 0) {\r\n    html += '<div style=\"margin-bottom: 15px;\">';\r\n    html += '<div style=\"font-size: 0.85em; font-weight: bold; color: #e74c3c; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;\"><span>\uD83D\uDC80</span> DEBUFFS</div>';\r\n    html += activeConditions.map(effectName => {\r\n      const effect = NEGATIVE_EFFECTS.find(e => e.name === effectName);\r\n      return `\r\n        <div class=\"effect-badge\" data-effect=\"${effectName}\" data-type=\"negative\" title=\"${effect.description} - Click to remove\" style=\"background: ${effect.color}20; border: 2px solid ${effect.color}; cursor: pointer; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; transition: all 0.2s;\">\r\n          <div style=\"display: flex; align-items: center; gap: 8px;\">\r\n            <span class=\"effect-badge-icon\" style=\"font-size: 1.2em;\">${effect.icon}</span>\r\n            <div style=\"flex: 1;\">\r\n              <div style=\"font-weight: bold; color: var(--text-primary);\">${effect.name}</div>\r\n              <div style=\"font-size: 0.75em; color: var(--text-secondary); margin-top: 2px;\">${effect.description}</div>\r\n            </div>\r\n            <span class=\"effect-badge-remove\" style=\"font-weight: bold; opacity: 0.7; color: #e74c3c;\">\u2715</span>\r\n          </div>\r\n        </div>\r\n      `;\r\n    }).join('');\r\n    html += '</div>';\r\n  }\r\n\r\n  // Show empty state if no effects\r\n  if (activeBuffs.length === 0 && activeConditions.length === 0) {\r\n    html = '<div style=\"text-align: center; color: #888; padding: 15px; font-size: 0.9em;\">No active effects</div>';\r\n  }\r\n\r\n  container.innerHTML = html;\r\n\r\n  // Update AC display to reflect any changes\r\n  const acElement = document.getElementById('char-ac');\r\n  if (acElement) {\r\n    acElement.textContent = calculateTotalAC();\r\n  }\r\n\r\n  // Add click handlers to remove effects\r\n  container.querySelectorAll('.effect-badge').forEach(badge => {\r\n    const effectName = badge.dataset.effect;\r\n    const type = badge.dataset.type;\r\n\r\n    // Add hover effect\r\n    badge.addEventListener('mouseenter', () => {\r\n      badge.style.transform = 'translateX(3px)';\r\n      badge.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';\r\n    });\r\n    badge.addEventListener('mouseleave', () => {\r\n      badge.style.transform = 'translateX(0)';\r\n      badge.style.boxShadow = 'none';\r\n    });\r\n\r\n    // Remove on click\r\n    badge.addEventListener('click', () => {\r\n      removeEffect(effectName, type);\r\n    });\r\n  });\r\n}\r\n\r\n// Legacy function for backwards compatibility\r\nfunction updateConditionsDisplay() {\r\n  updateEffectsDisplay();\r\n}\r\n\r\n/**\r\n * Concentration Tracker\r\n */\r\nlet concentratingSpell = null;\r\n\r\nfunction initConcentrationTracker() {\r\n  const dropConcentrationBtn = document.getElementById('drop-concentration-btn');\r\n\r\n  if (dropConcentrationBtn) {\r\n    dropConcentrationBtn.addEventListener('click', () => {\r\n      dropConcentration();\r\n    });\r\n  }\r\n\r\n  debug.log('\u2705 Concentration tracker initialized');\r\n}\r\n\r\nfunction setConcentration(spellName) {\r\n  concentratingSpell = spellName;\r\n  if (characterData) {\r\n    characterData.concentration = spellName;\r\n    saveCharacterData();\r\n  }\r\n  updateConcentrationDisplay();\r\n  showNotification(`\uD83E\uDDE0 Concentrating on: ${spellName}`);\r\n  debug.log(`\uD83E\uDDE0 Concentration set: ${spellName}`);\r\n}\r\n\r\nfunction dropConcentration() {\r\n  if (!concentratingSpell) return;\r\n\r\n  const spellName = concentratingSpell;\r\n  concentratingSpell = null;\r\n  if (characterData) {\r\n    characterData.concentration = null;\r\n    saveCharacterData();\r\n  }\r\n  updateConcentrationDisplay();\r\n  showNotification(`\u2705 Dropped concentration on ${spellName}`);\r\n  debug.log(`\uD83D\uDDD1\uFE0F Concentration dropped: ${spellName}`);\r\n}\r\n\r\nfunction updateConcentrationDisplay() {\r\n  const concentrationIndicator = document.getElementById('concentration-indicator');\r\n  const concentrationSpell = document.getElementById('concentration-spell');\r\n\r\n  if (!concentrationIndicator) return;\r\n\r\n  if (concentratingSpell) {\r\n    concentrationIndicator.style.display = 'flex';\r\n    if (concentrationSpell) {\r\n      concentrationSpell.textContent = concentratingSpell;\r\n    }\r\n  } else {\r\n    concentrationIndicator.style.display = 'none';\r\n  }\r\n}\r\n\r\n/**\r\n * GM Mode Toggle\r\n */\r\nfunction initGMMode() {\r\n  const gmModeToggle = document.getElementById('gm-mode-toggle');\r\n\r\n  if (gmModeToggle) {\r\n    gmModeToggle.addEventListener('click', () => {\r\n      const isActive = gmModeToggle.classList.contains('active');\r\n\r\n      // Send message to Roll20 content script to toggle GM panel\r\n      if (window.opener && !window.opener.closed) {\r\n        window.opener.postMessage({\r\n          action: 'toggleGMMode',\r\n          enabled: !isActive\r\n        }, '*');\r\n        debug.log(`\uD83D\uDC51 GM Mode ${!isActive ? 'enabled' : 'disabled'}`);\r\n      } else {\r\n        // Try via background script\r\n        browserAPI.runtime.sendMessage({\r\n          action: 'toggleGMMode',\r\n          enabled: !isActive\r\n        });\r\n      }\r\n\r\n      // Toggle active state\r\n      gmModeToggle.classList.toggle('active');\r\n      showNotification(isActive ? '\uD83D\uDC51 GM Mode disabled' : '\uD83D\uDC51 GM Mode enabled!');\r\n    });\r\n\r\n    debug.log('\u2705 GM Mode toggle initialized');\r\n  }\r\n}\r\n\r\n/**\r\n * Show to GM Button - Broadcasts character data to GM\r\n */\r\nfunction initShowToGM() {\r\n  const showToGMBtn = document.getElementById('show-to-gm-btn');\r\n\r\n  if (showToGMBtn) {\r\n    showToGMBtn.addEventListener('click', () => {\r\n      if (!characterData) {\r\n        showNotification('\u26A0\uFE0F No character data to share', 'warning');\r\n        return;\r\n      }\r\n\r\n      try {\r\n        // Create character broadcast message with ENTIRE sheet data\r\n        const broadcastData = {\r\n          type: 'ROLLCLOUD_CHARACTER_BROADCAST',\r\n          character: characterData,\r\n          // Include ALL character data for complete sheet\r\n          fullSheet: {\r\n            ...characterData,\r\n            // Ensure all sections are included\r\n            attributes: characterData.attributes || {},\r\n            skills: characterData.skills || [],\r\n            savingThrows: characterData.savingThrows || {},\r\n            actions: characterData.actions || [],\r\n            spells: characterData.spells || [],\r\n            features: characterData.features || [],\r\n            equipment: characterData.equipment || [],\r\n            inventory: characterData.inventory || {},\r\n            resources: characterData.resources || {},\r\n            spellSlots: characterData.spellSlots || {},\r\n            companions: characterData.companions || [],\r\n            conditions: characterData.conditions || [],\r\n            notes: characterData.notes || '',\r\n            background: characterData.background || '',\r\n            personality: characterData.personality || {},\r\n            proficiencies: characterData.proficiencies || [],\r\n            languages: characterData.languages || [],\r\n            // Add simplified properties for popout compatibility\r\n            hp: characterData.hitPoints?.current || characterData.hp || 0,\r\n            maxHp: characterData.hitPoints?.max || characterData.maxHp || 0,\r\n            ac: characterData.armorClass || characterData.ac || 10,\r\n            initiative: characterData.initiative || 0,\r\n            passivePerception: characterData.passivePerception || 10,\r\n            proficiency: characterData.proficiencyBonus || characterData.proficiency || 0,\r\n            speed: characterData.speed || '30 ft'\r\n          },\r\n          timestamp: new Date().toISOString()\r\n        };\r\n\r\n        // Encode the data for safe transmission (handle UTF-8 properly)\r\n        const jsonString = JSON.stringify(broadcastData);\r\n        const encodedData = btoa(unescape(encodeURIComponent(jsonString)));\r\n        const broadcastMessage = `\uD83D\uDC51[ROLLCLOUD:CHARACTER:${encodedData}]\uD83D\uDC51`;\r\n\r\n        // Send to Roll20 chat via parent window\r\n        if (window.opener && !window.opener.closed) {\r\n          window.opener.postMessage({\r\n            action: 'postChatMessageFromPopup',\r\n            message: broadcastMessage\r\n          }, '*');\r\n          \r\n          showNotification(`\uD83D\uDC51 ${characterData.name} shared with GM!`, 'success');\r\n          debug.log('\uD83D\uDC51 Character broadcast sent to GM:', characterData.name);\r\n        } else {\r\n          // Try via background script\r\n          browserAPI.runtime.sendMessage({\r\n            action: 'postChatMessageFromPopup',\r\n            message: broadcastMessage\r\n          }).then(() => {\r\n            showNotification(`\uD83D\uDC51 ${characterData.name} shared with GM!`, 'success');\r\n            debug.log('\uD83D\uDC51 Character broadcast sent via background script:', characterData.name);\r\n          }).catch(err => {\r\n            debug.error('\u274C Failed to send character broadcast:', err);\r\n            showNotification('\u274C Failed to share with GM', 'error');\r\n          });\r\n        }\r\n      } catch (error) {\r\n        debug.error('\u274C Error creating character broadcast:', error);\r\n        showNotification('\u274C Failed to prepare character data', 'error');\r\n      }\r\n    });\r\n\r\n    debug.log('\u2705 Show to GM button initialized in settings');\r\n  } else {\r\n    debug.warn('\u26A0\uFE0F Show to GM button not found in settings');\r\n  }\r\n}\r\n\r\n/**\r\n * Initialize manual DiceCloud sync button in settings\r\n */\r\nfunction initManualSyncButton() {\r\n  const syncSection = document.getElementById('dicecloud-sync-section');\r\n  const syncButton = document.getElementById('manual-sync-btn');\r\n  const syncStatus = document.getElementById('sync-status');\r\n\r\n  // Only show in experimental builds\r\n  browserAPI.runtime.sendMessage({ action: 'getManifest' }).then(response => {\r\n    if (response && response.success && response.manifest &&\r\n        response.manifest.name && response.manifest.name.includes('EXPERIMENTAL')) {\r\n      if (syncSection) {\r\n        syncSection.style.display = 'block';\r\n        debug.log('\uD83E\uDDEA DiceCloud sync section shown (experimental build)');\r\n      }\r\n    }\r\n  }).catch(err => {\r\n    debug.log('\uD83D\uDCE6 Not experimental build, hiding sync section');\r\n  });\r\n\r\n  if (syncButton) {\r\n    syncButton.addEventListener('click', async () => {\r\n      try {\r\n        debug.log('\uD83D\uDD04 Manual sync button clicked');\r\n\r\n        // Disable button during sync\r\n        syncButton.disabled = true;\r\n        syncButton.textContent = '\uD83D\uDD04 Syncing...';\r\n\r\n        // Show status\r\n        if (syncStatus) {\r\n          syncStatus.style.display = 'block';\r\n          syncStatus.style.background = 'var(--accent-info)';\r\n          syncStatus.style.color = 'white';\r\n          syncStatus.textContent = '\u23F3 Syncing to DiceCloud...';\r\n        }\r\n\r\n        // Collect all character data\r\n        if (!characterData) {\r\n          throw new Error('No character data available');\r\n        }\r\n\r\n        // Extract Channel Divinity from resources if it exists\r\n        const channelDivinityResource = characterData.resources?.find(r =>\r\n          r.name === 'Channel Divinity' ||\r\n          r.variableName === 'channelDivinityCleric' ||\r\n          r.variableName === 'channelDivinityPaladin' ||\r\n          r.variableName === 'channelDivinity'\r\n        );\r\n\r\n        // Build comprehensive sync message\r\n        const syncMessage = {\r\n          type: 'characterDataUpdate',\r\n          characterData: {\r\n            name: characterData.name,\r\n            hp: characterData.hitPoints.current,\r\n            tempHp: characterData.temporaryHP || 0,\r\n            maxHp: characterData.hitPoints.max,\r\n            spellSlots: characterData.spellSlots || {},\r\n            channelDivinity: channelDivinityResource ? {\r\n              current: channelDivinityResource.current,\r\n              max: channelDivinityResource.max\r\n            } : undefined,\r\n            resources: characterData.resources || [],\r\n            actions: characterData.actions || [],\r\n            deathSaves: characterData.deathSaves,\r\n            inspiration: characterData.inspiration,\r\n            lastRoll: characterData.lastRoll\r\n          }\r\n        };\r\n\r\n        debug.log('\uD83D\uDD04 Sending manual sync message:', syncMessage);\r\n\r\n        // Send to Roll20 content script (which will forward to DiceCloud sync)\r\n        if (window.opener && !window.opener.closed) {\r\n          window.opener.postMessage(syncMessage, '*');\r\n          debug.log('\u2705 Sync message sent via opener');\r\n        } else {\r\n          // Also try posting to self (in case we're in a popup)\r\n          window.postMessage(syncMessage, '*');\r\n          debug.log('\u2705 Sync message sent to self');\r\n        }\r\n\r\n        // Wait a bit for sync to complete\r\n        await new Promise(resolve => setTimeout(resolve, 1000));\r\n\r\n        // Show success\r\n        if (syncStatus) {\r\n          syncStatus.style.background = 'var(--accent-success)';\r\n          syncStatus.textContent = '\u2705 Synced successfully!';\r\n        }\r\n        showNotification('\u2705 Character data synced to DiceCloud!', 'success');\r\n        debug.log('\u2705 Manual sync completed');\r\n\r\n        // Reset button\r\n        setTimeout(() => {\r\n          syncButton.disabled = false;\r\n          syncButton.textContent = '\uD83D\uDD04 Sync to DiceCloud Now';\r\n          if (syncStatus) {\r\n            syncStatus.style.display = 'none';\r\n          }\r\n        }, 2000);\r\n\r\n      } catch (error) {\r\n        debug.error('\u274C Manual sync failed:', error);\r\n\r\n        if (syncStatus) {\r\n          syncStatus.style.display = 'block';\r\n          syncStatus.style.background = 'var(--accent-danger)';\r\n          syncStatus.style.color = 'white';\r\n          syncStatus.textContent = '\u274C Sync failed: ' + error.message;\r\n        }\r\n        showNotification('\u274C Sync failed: ' + error.message, 'error');\r\n\r\n        // Reset button\r\n        syncButton.disabled = false;\r\n        syncButton.textContent = '\uD83D\uDD04 Sync to DiceCloud Now';\r\n      }\r\n    });\r\n\r\n    debug.log('\u2705 Manual sync button initialized');\r\n  } else {\r\n    debug.warn('\u26A0\uFE0F Manual sync button not found in settings');\r\n  }\r\n}\r\n\r\n// Listen for messages from GM panel (when it's your turn)\r\nwindow.addEventListener('message', (event) => {\r\n  if (event.data && event.data.action === 'activateTurn') {\r\n    debug.log('\uD83C\uDFAF Your turn! Activating action economy...');\r\n    debug.log('\uD83C\uDFAF Received activateTurn event:', event.data);\r\n\r\n    // Activate turn state\r\n    activateTurn();\r\n\r\n    // Reset action economy for new turn (only reset actions, don't announce)\r\n    const actionIndicator = document.getElementById('action-indicator');\r\n    const bonusActionIndicator = document.getElementById('bonus-action-indicator');\r\n    const movementIndicator = document.getElementById('movement-indicator');\r\n    \r\n    [actionIndicator, bonusActionIndicator, movementIndicator].forEach(indicator => {\r\n      if (indicator) {\r\n        indicator.dataset.used = 'false';\r\n        debug.log(`\uD83D\uDD04 Reset ${indicator.id} to unused`);\r\n      }\r\n    });\r\n    \r\n    debug.log('\uD83D\uDD04 Turn reset: Action, Bonus Action, Movement restored (automatic)');\r\n\r\n    showNotification('\u2694\uFE0F Your turn!', 'success');\r\n  } else if (event.data && event.data.action === 'deactivateTurn') {\r\n    debug.log('\u23F8\uFE0F Turn ended. Deactivating action economy...');\r\n    debug.log('\u23F8\uFE0F Received deactivateTurn event:', event.data);\r\n\r\n    // Deactivate turn state\r\n    deactivateTurn();\r\n  } else if (event.data && event.data.action === 'rollResult') {\r\n    // Handle roll results from content script for racial traits checking\r\n    debug.log('\uD83E\uDDEC Received rollResult message:', event.data);\r\n    \r\n    if (event.data.checkRacialTraits && (activeRacialTraits.length > 0 || activeFeatTraits.length > 0)) {\r\n      const { rollResult, baseRoll, rollType, rollName } = event.data;\r\n      debug.log(`\uD83E\uDDEC Checking racial traits for roll: ${baseRoll} (${rollType}) - ${rollName}`);\r\n      debug.log(`\uD83E\uDDEC Active racial traits count: ${activeRacialTraits.length}`);\r\n      debug.log(`\uD83C\uDF96\uFE0F Active feat traits count: ${activeFeatTraits.length}`);\r\n      debug.log(`\uD83E\uDDEC Roll details - Total: ${rollResult}, Base: ${baseRoll}`);\r\n      \r\n      // Check if any racial traits trigger (use baseRoll for the actual d20 roll)\r\n      const racialTraitTriggered = checkRacialTraits(baseRoll, rollType, rollName);\r\n      const triggeredRacialTraits = [];\r\n      \r\n      // Check if any feat traits trigger (use baseRoll for the actual d20 roll)\r\n      const featTraitTriggered = checkFeatTraits(baseRoll, rollType, rollName);\r\n      const triggeredFeatTraits = [];\r\n      \r\n      // Collect triggered traits\r\n      if (racialTraitTriggered) {\r\n        triggeredRacialTraits.push(...activeRacialTraits.filter(trait => {\r\n          // Check if this trait would trigger for this roll\r\n          const testResult = trait.onRoll(baseRoll, rollType, rollName);\r\n          return testResult === true;\r\n        }));\r\n        debug.log(`\uD83E\uDDEC Racial trait triggered for roll: ${baseRoll}`);\r\n      }\r\n      \r\n      if (featTraitTriggered) {\r\n        triggeredFeatTraits.push(...activeFeatTraits.filter(trait => {\r\n          // Check if this trait would trigger for this roll\r\n          const testResult = trait.onRoll(baseRoll, rollType, rollName);\r\n          return testResult === true;\r\n        }));\r\n        debug.log(`\uD83C\uDF96\uFE0F Feat trait triggered for roll: ${baseRoll}`);\r\n      }\r\n      \r\n      // Show appropriate popup\r\n      if (triggeredRacialTraits.length > 0 || triggeredFeatTraits.length > 0) {\r\n        const allTriggeredTraits = [...triggeredRacialTraits, ...triggeredFeatTraits];\r\n        \r\n        if (allTriggeredTraits.length === 1) {\r\n          // Single trait triggered - show its specific popup\r\n          const trait = allTriggeredTraits[0];\r\n          if (trait.name === 'Halfling Luck') {\r\n            showHalflingLuckPopup({\r\n              rollResult: baseRoll,\r\n              baseRoll: baseRoll,\r\n              rollType: rollType,\r\n              rollName: rollName\r\n            });\r\n          } else if (trait.name === 'Lucky') {\r\n            const luckyResource = getLuckyResource();\r\n            showLuckyPopup({\r\n              rollResult: baseRoll,\r\n              baseRoll: baseRoll,\r\n              rollType: rollType,\r\n              rollName: rollName,\r\n              luckPointsRemaining: luckyResource?.current || 0\r\n            });\r\n          }\r\n        } else {\r\n          // Multiple traits triggered - show choice popup\r\n          showTraitChoicePopup({\r\n            rollResult: baseRoll,\r\n            baseRoll: baseRoll,\r\n            rollType: rollType,\r\n            rollName: rollName,\r\n            racialTraits: triggeredRacialTraits,\r\n            featTraits: triggeredFeatTraits\r\n          });\r\n        }\r\n      }\r\n      \r\n      if (!racialTraitTriggered && !featTraitTriggered) {\r\n        debug.log(`\uD83E\uDDEC\uD83C\uDF96\uFE0F No traits triggered for roll: ${baseRoll}`);\r\n      }\r\n    } else {\r\n      debug.log(`\uD83E\uDDEC Skipping traits check - checkRacialTraits: ${event.data.checkRacialTraits}, racialTraits: ${activeRacialTraits.length}, featTraits: ${activeFeatTraits.length}`);\r\n    }\r\n  } else if (event.data && event.data.action === 'showHalflingLuckPopup') {\r\n    // Show Halfling Luck reroll popup\r\n    showHalflingLuckPopup(event.data.rollData);\r\n  }\r\n});\r\n\r\n// Initialize combat mechanics when sheet loads\r\nsetTimeout(() => {\r\n  initCombatMechanics();\r\n}, 100);\r\n\r\n// Local character cache to preserve state changes\r\nconst characterCache = new Map();\r\n\r\n// Initialize racial traits and feats\r\nlet activeRacialTraits = [];\r\nlet activeFeatTraits = [];\r\n\r\nfunction initRacialTraits() {\r\n  debug.log('\uD83E\uDDEC Initializing racial traits...');\r\n  debug.log('\uD83E\uDDEC Character data:', characterData);\r\n  debug.log('\uD83E\uDDEC Character race:', characterData?.race);\r\n\r\n  // Reset racial traits\r\n  activeRacialTraits = [];\r\n\r\n  if (!characterData || !characterData.race) {\r\n    debug.log('\uD83E\uDDEC No race data available');\r\n    return;\r\n  }\r\n\r\n  const race = characterData.race.toLowerCase();\r\n\r\n  // Halfling Luck\r\n  if (race.includes('halfling')) {\r\n    debug.log('\uD83E\uDDEC Halfling detected, adding Halfling Luck trait');\r\n    activeRacialTraits.push(HalflingLuck);\r\n  }\r\n\r\n  // Elven Accuracy (check for feat in features)\r\n  if (characterData.features && characterData.features.some(f =>\r\n    f.name && f.name.toLowerCase().includes('elven accuracy')\r\n  )) {\r\n    debug.log('\uD83E\uDDDD Elven Accuracy feat detected');\r\n    activeRacialTraits.push(ElvenAccuracy);\r\n  }\r\n\r\n  // Dwarven Resilience\r\n  if (race.includes('dwarf')) {\r\n    debug.log('\u26CF\uFE0F Dwarf detected, adding Dwarven Resilience trait');\r\n    activeRacialTraits.push(DwarvenResilience);\r\n  }\r\n\r\n  // Gnome Cunning\r\n  if (race.includes('gnome')) {\r\n    debug.log('\uD83C\uDFA9 Gnome detected, adding Gnome Cunning trait');\r\n    activeRacialTraits.push(GnomeCunning);\r\n  }\r\n\r\n  debug.log(`\uD83E\uDDEC Initialized ${activeRacialTraits.length} racial traits`);\r\n}\r\n\r\nfunction initFeatTraits() {\r\n  debug.log('\uD83C\uDF96\uFE0F Initializing feat traits...');\r\n  debug.log('\uD83C\uDF96\uFE0F Character features:', characterData?.features);\r\n\r\n  // Reset feat traits\r\n  activeFeatTraits = [];\r\n\r\n  if (!characterData || !characterData.features) {\r\n    debug.log('\uD83C\uDF96\uFE0F No features data available');\r\n    return;\r\n  }\r\n\r\n  // Lucky feat is now handled as an action, not a trait\r\n  debug.log('\uD83C\uDF96\uFE0F Lucky feat will be available as an action button');\r\n\r\n  debug.log(`\uD83C\uDF96\uFE0F Initialized ${activeFeatTraits.length} feat traits`);\r\n}\r\n\r\nfunction initClassFeatures() {\r\n  debug.log('\u2694\uFE0F Initializing class features...');\r\n  debug.log('\u2694\uFE0F Character class:', characterData?.class);\r\n  debug.log('\u2694\uFE0F Character level:', characterData?.level);\r\n\r\n  if (!characterData) {\r\n    debug.log('\u2694\uFE0F No character data available');\r\n    return;\r\n  }\r\n\r\n  const characterClass = (characterData.class || '').toLowerCase();\r\n  const level = characterData.level || 1;\r\n\r\n  // Reliable Talent (Rogue 11+)\r\n  if (characterClass.includes('rogue') && level >= 11) {\r\n    debug.log('\uD83C\uDFAF Rogue 11+ detected, adding Reliable Talent');\r\n    activeFeatTraits.push(ReliableTalent);\r\n  }\r\n\r\n  // Bardic Inspiration (Bard)\r\n  if (characterClass.includes('bard') && level >= 1) {\r\n    debug.log('\uD83C\uDFB5 Bard detected, adding Bardic Inspiration');\r\n    activeFeatTraits.push(BardicInspiration);\r\n  }\r\n\r\n  // Jack of All Trades (Bard)\r\n  if (characterClass.includes('bard') && level >= 2) {\r\n    debug.log('\uD83C\uDFB5 Bard detected, adding Jack of All Trades');\r\n    activeFeatTraits.push(JackOfAllTrades);\r\n  }\r\n\r\n  // Rage Damage Bonus (Barbarian)\r\n  if (characterClass.includes('barbarian')) {\r\n    debug.log('\uD83D\uDE21 Barbarian detected, adding Rage Damage Bonus');\r\n    activeFeatTraits.push(RageDamageBonus);\r\n  }\r\n\r\n  // Brutal Critical (Barbarian 9+)\r\n  if (characterClass.includes('barbarian') && level >= 9) {\r\n    debug.log('\uD83D\uDCA5 Barbarian 9+ detected, adding Brutal Critical');\r\n    activeFeatTraits.push(BrutalCritical);\r\n  }\r\n\r\n  // Portent (Divination Wizard 2+)\r\n  if (characterClass.includes('wizard') && level >= 2) {\r\n    // Check for Divination subclass in features\r\n    const isDivination = characterData.features && characterData.features.some(f =>\r\n      f.name && (f.name.toLowerCase().includes('divination') || f.name.toLowerCase().includes('portent'))\r\n    );\r\n    if (isDivination) {\r\n      debug.log('\uD83D\uDD2E Divination Wizard detected, adding Portent');\r\n      activeFeatTraits.push(PortentDice);\r\n      // Auto-roll portent dice\r\n      PortentDice.rollPortentDice();\r\n    }\r\n  }\r\n\r\n  // Wild Magic Surge (Wild Magic Sorcerer)\r\n  if (characterClass.includes('sorcerer')) {\r\n    // Check for Wild Magic subclass in features\r\n    const isWildMagic = characterData.features && characterData.features.some(f =>\r\n      f.name && f.name.toLowerCase().includes('wild magic')\r\n    );\r\n    if (isWildMagic) {\r\n      debug.log('\uD83C\uDF00 Wild Magic Sorcerer detected, adding Wild Magic Surge');\r\n      activeFeatTraits.push(WildMagicSurge);\r\n    }\r\n  }\r\n\r\n  debug.log(`\u2694\uFE0F Initialized ${activeFeatTraits.length} class feature traits`);\r\n}\r\n\r\nfunction checkRacialTraits(rollResult, rollType, rollName) {\r\n  debug.log(`\uD83E\uDDEC Checking racial traits for roll: ${rollResult} (${rollType}) - ${rollName}`);\r\n  debug.log(`\uD83E\uDDEC Active racial traits count: ${activeRacialTraits.length}`);\r\n  \r\n  let traitTriggered = false;\r\n  \r\n  for (const trait of activeRacialTraits) {\r\n    if (trait.onRoll && typeof trait.onRoll === 'function') {\r\n      const result = trait.onRoll(rollResult, rollType, rollName);\r\n      if (result) {\r\n        traitTriggered = true;\r\n        debug.log(`\uD83E\uDDEC ${trait.name} triggered!`);\r\n      }\r\n    }\r\n  }\r\n  \r\n  return traitTriggered;\r\n}\r\n\r\nfunction checkFeatTraits(rollResult, rollType, rollName) {\r\n  debug.log(`\uD83C\uDF96\uFE0F Checking feat traits for roll: ${rollResult} (${rollType}) - ${rollName}`);\r\n  debug.log(`\uD83C\uDF96\uFE0F Active feat traits count: ${activeFeatTraits.length}`);\r\n  \r\n  let traitTriggered = false;\r\n  \r\n  for (const trait of activeFeatTraits) {\r\n    if (trait.onRoll && typeof trait.onRoll === 'function') {\r\n      const result = trait.onRoll(rollResult, rollType, rollName);\r\n      if (result) {\r\n        traitTriggered = true;\r\n        debug.log(`\uD83C\uDF96\uFE0F ${trait.name} triggered!`);\r\n      }\r\n    }\r\n  }\r\n  \r\n  return traitTriggered;\r\n}\r\n\r\ndebug.log('\u2705 Popup script fully loaded');\r\n\r\n// Helper function to get theme-aware popup colors\r\nfunction getPopupThemeColors() {\r\n  const isDarkMode = document.documentElement.classList.contains('theme-dark') ||\r\n                     document.documentElement.getAttribute('data-theme') === 'dark';\r\n\r\n  return {\r\n    background: isDarkMode ? '#2d2d2d' : '#ffffff',\r\n    text: isDarkMode ? '#e0e0e0' : '#333333',\r\n    heading: isDarkMode ? '#ffffff' : '#2D8B83',\r\n    border: isDarkMode ? '#444444' : '#f0f8ff',\r\n    borderAccent: isDarkMode ? '#2D8B83' : '#2D8B83',\r\n    infoBox: isDarkMode ? '#1a1a1a' : '#f0f8ff',\r\n    infoText: isDarkMode ? '#b0b0b0' : '#666666'\r\n  };\r\n}\r\n\r\n// Halfling Luck Popup Functions\r\nfunction showHalflingLuckPopup(rollData) {\r\n  debug.log('\uD83C\uDF40 Halfling Luck popup called with:', rollData);\r\n\r\n  // Check if document.body exists\r\n  if (!document.body) {\r\n    debug.error('\u274C document.body not available for Halfling Luck popup');\r\n    showNotification('\uD83C\uDF40 Halfling Luck triggered! (Popup failed to display)', 'info');\r\n    return;\r\n  }\r\n\r\n  debug.log('\uD83C\uDF40 Creating popup overlay...');\r\n\r\n  // Get theme-aware colors\r\n  const colors = getPopupThemeColors();\r\n\r\n  // Create popup overlay\r\n  const popupOverlay = document.createElement('div');\r\n  popupOverlay.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background: rgba(0, 0, 0, 0.8);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10000;\r\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\r\n  `;\r\n\r\n  // Create popup content\r\n  const popupContent = document.createElement('div');\r\n  popupContent.style.cssText = `\r\n    background: ${colors.background};\r\n    border-radius: 12px;\r\n    padding: 24px;\r\n    max-width: 400px;\r\n    width: 90%;\r\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\r\n    text-align: center;\r\n  `;\r\n\r\n  debug.log('\uD83C\uDF40 Setting popup content HTML...');\r\n\r\n  popupContent.innerHTML = `\r\n    <div style=\"font-size: 24px; margin-bottom: 16px;\">\uD83C\uDF40</div>\r\n    <h2 style=\"margin: 0 0 8px 0; color: ${colors.heading};\">Halfling Luck!</h2>\r\n    <p style=\"margin: 0 0 16px 0; color: ${colors.text};\">\r\n      You rolled a natural 1! As a Halfling, you can reroll this d20.\r\n    </p>\r\n    <div style=\"margin: 0 0 16px 0; padding: 12px; background: ${colors.infoBox}; border-radius: 8px; border-left: 4px solid ${colors.borderAccent}; color: ${colors.text};\">\r\n      <strong>Original Roll:</strong> ${rollData.rollName}<br>\r\n      <strong>Result:</strong> ${rollData.baseRoll} (natural 1)<br>\r\n      <strong>Total:</strong> ${rollData.rollResult}\r\n    </div>\r\n    <div style=\"display: flex; gap: 12px; justify-content: center;\">\r\n      <button id=\"halflingRerollBtn\" style=\"\r\n        background: #2D8B83;\r\n        color: white;\r\n        border: none;\r\n        padding: 12px 24px;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 14px;\r\n      \">\uD83C\uDFB2 Reroll</button>\r\n      <button id=\"halflingKeepBtn\" style=\"\r\n        background: #e74c3c;\r\n        color: white;\r\n        border: none;\r\n        padding: 12px 24px;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 14px;\r\n      \">Keep Roll</button>\r\n    </div>\r\n  `;\r\n\r\n  debug.log('\uD83C\uDF40 Appending popup to document.body...');\r\n\r\n  popupOverlay.appendChild(popupContent);\r\n  document.body.appendChild(popupOverlay);\r\n  \r\n  // Add event listeners\r\n  document.getElementById('halflingRerollBtn').addEventListener('click', () => {\r\n    debug.log('\uD83C\uDF40 User chose to reroll');\r\n    performHalflingReroll(rollData);\r\n    document.body.removeChild(popupOverlay);\r\n  });\r\n  \r\n  document.getElementById('halflingKeepBtn').addEventListener('click', () => {\r\n    debug.log('\uD83C\uDF40 User chose to keep roll');\r\n    document.body.removeChild(popupOverlay);\r\n  });\r\n  \r\n  // Close on overlay click\r\n  popupOverlay.addEventListener('click', (e) => {\r\n    if (e.target === popupOverlay) {\r\n      debug.log('\uD83C\uDF40 User closed popup');\r\n      document.body.removeChild(popupOverlay);\r\n    }\r\n  });\r\n  \r\n  debug.log('\uD83C\uDF40 Halfling Luck popup displayed');\r\n}\r\n\r\n// Lucky Feat Popup Functions\r\nfunction showLuckyPopup(rollData) {\r\n  debug.log('\uD83C\uDF96\uFE0F Lucky popup called with:', rollData);\r\n\r\n  // Check if document.body exists\r\n  if (!document.body) {\r\n    debug.error('\u274C document.body not available for Lucky popup');\r\n    showNotification('\uD83C\uDF96\uFE0F Lucky triggered! (Popup failed to display)', 'info');\r\n    return;\r\n  }\r\n\r\n  debug.log('\uD83C\uDF96\uFE0F Creating Lucky popup overlay...');\r\n\r\n  // Get theme-aware colors\r\n  const colors = getPopupThemeColors();\r\n\r\n  // Create popup overlay\r\n  const popupOverlay = document.createElement('div');\r\n  popupOverlay.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    background: rgba(0, 0, 0, 0.8);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10000;\r\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\r\n  `;\r\n\r\n  // Create popup content\r\n  const popupContent = document.createElement('div');\r\n  popupContent.style.cssText = `\r\n    background: ${colors.background};\r\n    border-radius: 12px;\r\n    padding: 24px;\r\n    max-width: 400px;\r\n    width: 90%;\r\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\r\n    text-align: center;\r\n  `;\r\n\r\n  debug.log('\uD83C\uDF96\uFE0F Setting Lucky popup content HTML...');\r\n\r\n  popupContent.innerHTML = `\r\n    <div style=\"font-size: 24px; margin-bottom: 16px;\">\uD83C\uDF96\uFE0F</div>\r\n    <h2 style=\"margin: 0 0 8px 0; color: #f39c12;\">Lucky Feat!</h2>\r\n    <p style=\"margin: 0 0 16px 0; color: ${colors.text};\">\r\n      You rolled a ${rollData.baseRoll}! You have ${rollData.luckPointsRemaining} luck points remaining.\r\n    </p>\r\n    <div style=\"margin: 0 0 16px 0; padding: 12px; background: ${colors.infoBox}; border-radius: 8px; border-left: 4px solid #f39c12; color: ${colors.text};\">\r\n      <strong>Original Roll:</strong> ${rollData.rollName}<br>\r\n      <strong>Result:</strong> ${rollData.baseRoll}<br>\r\n      <strong>Luck Points:</strong> ${rollData.luckPointsRemaining}/3\r\n    </div>\r\n    <div style=\"display: flex; gap: 12px; justify-content: center;\">\r\n      <button id=\"luckyRerollBtn\" style=\"\r\n        background: #f39c12;\r\n        color: white;\r\n        border: none;\r\n        padding: 12px 24px;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-size: 16px;\r\n        font-weight: bold;\r\n        transition: background 0.2s;\r\n      \">\r\n        \uD83C\uDFB2 Reroll (Use Luck Point)\r\n      </button>\r\n      <button id=\"luckyKeepBtn\" style=\"\r\n        background: #95a5a6;\r\n        color: white;\r\n        border: none;\r\n        padding: 12px 24px;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-size: 16px;\r\n        font-weight: bold;\r\n        transition: background 0.2s;\r\n      \">\r\n        Keep Roll\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  popupOverlay.appendChild(popupContent);\r\n  document.body.appendChild(popupOverlay);\r\n\r\n  debug.log('\uD83C\uDF96\uFE0F Appending Lucky popup to document.body...');\r\n\r\n  // Add event listeners\r\n  const rerollBtn = document.getElementById('luckyRerollBtn');\r\n  const keepBtn = document.getElementById('luckyKeepBtn');\r\n\r\n  // Add hover effects via event listeners (CSP-compliant)\r\n  rerollBtn.addEventListener('mouseenter', () => rerollBtn.style.background = '#e67e22');\r\n  rerollBtn.addEventListener('mouseleave', () => rerollBtn.style.background = '#f39c12');\r\n  keepBtn.addEventListener('mouseenter', () => keepBtn.style.background = '#7f8c8d');\r\n  keepBtn.addEventListener('mouseleave', () => keepBtn.style.background = '#95a5a6');\r\n\r\n  rerollBtn.addEventListener('click', () => {\r\n    if (useLuckyPoint()) {\r\n      performLuckyReroll(rollData);\r\n      popupOverlay.remove();\r\n    } else {\r\n      alert('No luck points available!');\r\n    }\r\n  });\r\n\r\n  keepBtn.addEventListener('click', () => {\r\n    popupOverlay.remove();\r\n  });\r\n\r\n  // Close on overlay click\r\n  popupOverlay.addEventListener('click', (e) => {\r\n    if (e.target === popupOverlay) {\r\n      popupOverlay.remove();\r\n    }\r\n  });\r\n\r\n  debug.log('\uD83C\uDF96\uFE0F Lucky popup displayed');\r\n}\r\n\r\nfunction performLuckyReroll(originalRollData) {\r\n  debug.log('\uD83C\uDF96\uFE0F Performing Lucky reroll for:', originalRollData);\r\n  \r\n  // Extract base formula (remove modifiers for the reroll)\r\n  const baseFormula = originalRollData.rollType.replace(/[+-]\\d+$/i, '');\r\n  \r\n  // Create a new roll with just the d20\r\n  const rerollData = {\r\n    name: `\uD83C\uDF96\uFE0F ${originalRollData.rollName} (Lucky Reroll)`,\r\n    formula: baseFormula,\r\n    color: '#f39c12',\r\n    characterName: characterData.name\r\n  };\r\n\r\n  // Send the reroll request\r\n  if (window.opener && !window.opener.closed) {\r\n    window.opener.postMessage({\r\n      action: 'rollFromPopout',\r\n      ...rerollData\r\n    }, '*');\r\n    debug.log('\uD83C\uDF96\uFE0F Lucky reroll sent via window.opener');\r\n  } else {\r\n    // Fallback: send directly to Roll20 via background script\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'relayRollToRoll20',\r\n      roll: rerollData\r\n    });\r\n  }\r\n  \r\n  showNotification('\uD83C\uDF96\uFE0F Lucky reroll initiated!', 'success');\r\n}\r\n\r\n// Unified Trait Choice Popup\r\nfunction showTraitChoicePopup(rollData) {\r\n  debug.log('\uD83C\uDFAF Trait choice popup called with:', rollData);\r\n\r\n  // Check if document.body exists\r\n  if (!document.body) {\r\n    debug.error('\u274C document.body not available for trait choice popup');\r\n    showNotification('\uD83C\uDFAF Trait choice triggered! (Popup failed to display)', 'info');\r\n    return;\r\n  }\r\n\r\n  debug.log('\uD83C\uDFAF Creating trait choice overlay...');\r\n\r\n  // Get theme-aware colors\r\n  const colors = getPopupThemeColors();\r\n\r\n  // Create popup overlay\r\n  const popupOverlay = document.createElement('div');\r\n  popupOverlay.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    background: rgba(0, 0, 0, 0.8);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10000;\r\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\r\n  `;\r\n\r\n  // Create popup content\r\n  const popupContent = document.createElement('div');\r\n  popupContent.style.cssText = `\r\n    background: ${colors.background};\r\n    border-radius: 12px;\r\n    padding: 24px;\r\n    max-width: 450px;\r\n    width: 90%;\r\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\r\n    text-align: center;\r\n  `;\r\n\r\n  // Build trait options HTML\r\n  let traitOptionsHTML = '';\r\n  const allTraits = [...rollData.racialTraits, ...rollData.featTraits];\r\n  \r\n  allTraits.forEach((trait, index) => {\r\n    let icon = '';\r\n    let color = '';\r\n    let description = '';\r\n    \r\n    if (trait.name === 'Halfling Luck') {\r\n      icon = '\uD83C\uDF40';\r\n      color = '#2D8B83';\r\n      description = 'Reroll natural 1s (must use new roll)';\r\n    } else if (trait.name === 'Lucky') {\r\n      icon = '\uD83C\uDF96\uFE0F';\r\n      color = '#f39c12';\r\n      const luckyResource = getLuckyResource();\r\n      description = `Reroll any roll (${luckyResource?.current || 0}/3 points left)`;\r\n    }\r\n    \r\n    traitOptionsHTML += `\r\n      <button class=\"trait-option-btn\" data-trait-index=\"${index}\" data-trait-color=\"${color}\" style=\"\r\n        background: ${color};\r\n        color: white;\r\n        border: none;\r\n        padding: 16px;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-size: 16px;\r\n        font-weight: bold;\r\n        margin: 8px 0;\r\n        transition: transform 0.2s, background 0.2s;\r\n        width: 100%;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        gap: 12px;\r\n      \">\r\n        <span style=\"font-size: 20px;\">${icon}</span>\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"font-weight: bold;\">${trait.name}</div>\r\n          <div style=\"font-size: 12px; opacity: 0.9;\">${description}</div>\r\n        </div>\r\n      </button>\r\n    `;\r\n  });\r\n\r\n  debug.log('\uD83C\uDFAF Setting trait choice popup content HTML...');\r\n\r\n  popupContent.innerHTML = `\r\n    <div style=\"font-size: 24px; margin-bottom: 16px;\">\uD83C\uDFAF</div>\r\n    <h2 style=\"margin: 0 0 8px 0; color: ${colors.heading};\">Multiple Traits Available!</h2>\r\n    <p style=\"margin: 0 0 16px 0; color: ${colors.text};\">\r\n      You rolled a ${rollData.baseRoll}! Choose which trait to use:\r\n    </p>\r\n    <div style=\"margin: 0 0 16px 0; padding: 12px; background: ${colors.infoBox}; border-radius: 8px; border-left: 4px solid #3498db; color: ${colors.text};\">\r\n      <strong>Original Roll:</strong> ${rollData.rollName}<br>\r\n      <strong>Result:</strong> ${rollData.baseRoll}<br>\r\n      <strong>Total:</strong> ${rollData.rollResult}\r\n    </div>\r\n    <div style=\"display: flex; flex-direction: column; gap: 8px;\">\r\n      ${traitOptionsHTML}\r\n    </div>\r\n    <button id=\"cancelTraitBtn\" style=\"\r\n      background: #95a5a6;\r\n      color: white;\r\n      border: none;\r\n      padding: 12px 24px;\r\n      border-radius: 8px;\r\n      cursor: pointer;\r\n      font-size: 14px;\r\n      font-weight: bold;\r\n      margin-top: 8px;\r\n      transition: background 0.2s;\r\n    \">\r\n      Keep Original Roll\r\n    </button>\r\n  `;\r\n\r\n  popupOverlay.appendChild(popupContent);\r\n  document.body.appendChild(popupOverlay);\r\n\r\n  debug.log('\uD83C\uDFAF Appending trait choice popup to document.body...');\r\n\r\n  // Add event listeners\r\n  const traitButtons = document.querySelectorAll('.trait-option-btn');\r\n  const cancelBtn = document.getElementById('cancelTraitBtn');\r\n\r\n  // Add hover effects for trait buttons (CSP-compliant)\r\n  traitButtons.forEach((btn, index) => {\r\n    const originalColor = btn.dataset.traitColor;\r\n\r\n    btn.addEventListener('mouseenter', () => {\r\n      btn.style.transform = 'translateY(-2px)';\r\n      btn.style.background = originalColor + 'dd';\r\n    });\r\n\r\n    btn.addEventListener('mouseleave', () => {\r\n      btn.style.transform = 'translateY(0)';\r\n      btn.style.background = originalColor;\r\n    });\r\n\r\n    btn.addEventListener('click', () => {\r\n      const trait = allTraits[index];\r\n      debug.log(`\uD83C\uDFAF User chose trait: ${trait.name}`);\r\n\r\n      popupOverlay.remove();\r\n\r\n      // Execute the chosen trait's action\r\n      if (trait.name === 'Halfling Luck') {\r\n        showHalflingLuckPopup({\r\n          rollResult: rollData.baseRoll,\r\n          baseRoll: rollData.baseRoll,\r\n          rollType: rollData.rollType,\r\n          rollName: rollData.rollName\r\n        });\r\n      } else if (trait.name === 'Lucky') {\r\n        const luckyResource = getLuckyResource();\r\n        showLuckyPopup({\r\n          rollResult: rollData.baseRoll,\r\n          baseRoll: rollData.baseRoll,\r\n          rollType: rollData.rollType,\r\n          rollName: rollData.rollName,\r\n          luckPointsRemaining: luckyResource?.current || 0\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  // Add hover effects for cancel button (CSP-compliant)\r\n  cancelBtn.addEventListener('mouseenter', () => cancelBtn.style.background = '#7f8c8d');\r\n  cancelBtn.addEventListener('mouseleave', () => cancelBtn.style.background = '#95a5a6');\r\n\r\n  cancelBtn.addEventListener('click', () => {\r\n    popupOverlay.remove();\r\n  });\r\n\r\n  // Close on overlay click\r\n  popupOverlay.addEventListener('click', (e) => {\r\n    if (e.target === popupOverlay) {\r\n      popupOverlay.remove();\r\n    }\r\n  });\r\n\r\n  debug.log('\uD83C\uDFAF Trait choice popup displayed');\r\n}\r\n\r\n// Wild Magic Surge Popup\r\nfunction showWildMagicSurgePopup(d100Roll, effect) {\r\n  debug.log('\uD83C\uDF00 Wild Magic Surge popup called with:', d100Roll, effect);\r\n\r\n  if (!document.body) {\r\n    debug.error('\u274C document.body not available for Wild Magic Surge popup');\r\n    showNotification(`\uD83C\uDF00 Wild Magic Surge! d100: ${d100Roll}`, 'warning');\r\n    return;\r\n  }\r\n\r\n  const colors = getPopupThemeColors();\r\n\r\n  // Create popup overlay\r\n  const popupOverlay = document.createElement('div');\r\n  popupOverlay.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background: rgba(0, 0, 0, 0.8);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10000;\r\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\r\n  `;\r\n\r\n  // Create popup content\r\n  const popupContent = document.createElement('div');\r\n  popupContent.style.cssText = `\r\n    background: ${colors.background};\r\n    border-radius: 12px;\r\n    padding: 24px;\r\n    max-width: 500px;\r\n    width: 90%;\r\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\r\n    text-align: center;\r\n  `;\r\n\r\n  popupContent.innerHTML = `\r\n    <div style=\"font-size: 32px; margin-bottom: 16px;\">\uD83C\uDF00</div>\r\n    <h2 style=\"margin: 0 0 8px 0; color: #9b59b6;\">Wild Magic Surge!</h2>\r\n    <p style=\"margin: 0 0 16px 0; color: ${colors.text};\">\r\n      Your spell triggers a wild magic surge!\r\n    </p>\r\n    <div style=\"margin: 0 0 16px 0; padding: 16px; background: ${colors.infoBox}; border-radius: 8px; border-left: 4px solid #9b59b6; color: ${colors.text}; text-align: left;\">\r\n      <div style=\"text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 12px; color: #9b59b6;\">\r\n        d100 Roll: ${d100Roll}\r\n      </div>\r\n      <div style=\"font-size: 14px; line-height: 1.6;\">\r\n        ${effect}\r\n      </div>\r\n    </div>\r\n    <button id=\"closeWildMagicBtn\" style=\"\r\n      background: #9b59b6;\r\n      color: white;\r\n      border: none;\r\n      padding: 12px 32px;\r\n      border-radius: 8px;\r\n      cursor: pointer;\r\n      font-weight: bold;\r\n      font-size: 14px;\r\n      transition: background 0.2s;\r\n    \">Got it!</button>\r\n  `;\r\n\r\n  popupOverlay.appendChild(popupContent);\r\n  document.body.appendChild(popupOverlay);\r\n\r\n  // Add event listeners\r\n  const closeBtn = document.getElementById('closeWildMagicBtn');\r\n\r\n  closeBtn.addEventListener('mouseenter', () => closeBtn.style.background = '#8e44ad');\r\n  closeBtn.addEventListener('mouseleave', () => closeBtn.style.background = '#9b59b6');\r\n\r\n  closeBtn.addEventListener('click', () => {\r\n    document.body.removeChild(popupOverlay);\r\n  });\r\n\r\n  // Close on overlay click\r\n  popupOverlay.addEventListener('click', (e) => {\r\n    if (e.target === popupOverlay) {\r\n      document.body.removeChild(popupOverlay);\r\n    }\r\n  });\r\n\r\n  // Also announce to Roll20 chat\r\n  const colorBanner = getColoredBanner();\r\n  const message = `&{template:default} {{name=${colorBanner}${characterData.name} - Wild Magic Surge! \uD83C\uDF00}} {{d100 Roll=${d100Roll}}} {{Effect=${effect}}}`;\r\n\r\n  if (window.opener && !window.opener.closed) {\r\n    window.opener.postMessage({\r\n      action: 'announceSpell',\r\n      message: message\r\n    }, '*');\r\n  }\r\n\r\n  debug.log('\uD83C\uDF00 Wild Magic Surge popup displayed');\r\n}\r\n\r\n// Bardic Inspiration Popup Functions\r\nfunction showBardicInspirationPopup(rollData) {\r\n  debug.log('\uD83C\uDFB5 Bardic Inspiration popup called with:', rollData);\r\n\r\n  // Check if document.body exists\r\n  if (!document.body) {\r\n    debug.error('\u274C document.body not available for Bardic Inspiration popup');\r\n    showNotification('\uD83C\uDFB5 Bardic Inspiration available! (Popup failed to display)', 'info');\r\n    return;\r\n  }\r\n\r\n  debug.log('\uD83C\uDFB5 Creating Bardic Inspiration popup overlay...');\r\n\r\n  // Get theme-aware colors\r\n  const colors = getPopupThemeColors();\r\n\r\n  // Create popup overlay\r\n  const popupOverlay = document.createElement('div');\r\n  popupOverlay.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background: rgba(0, 0, 0, 0.8);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10000;\r\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\r\n  `;\r\n\r\n  // Create popup content\r\n  const popupContent = document.createElement('div');\r\n  popupContent.style.cssText = `\r\n    background: ${colors.background};\r\n    border-radius: 12px;\r\n    padding: 24px;\r\n    max-width: 450px;\r\n    width: 90%;\r\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\r\n    text-align: center;\r\n  `;\r\n\r\n  debug.log('\uD83C\uDFB5 Setting Bardic Inspiration popup content HTML...');\r\n\r\n  popupContent.innerHTML = `\r\n    <div style=\"font-size: 32px; margin-bottom: 16px;\">\uD83C\uDFB5</div>\r\n    <h2 style=\"margin: 0 0 8px 0; color: ${colors.heading};\">Bardic Inspiration!</h2>\r\n    <p style=\"margin: 0 0 16px 0; color: ${colors.text};\">\r\n      Add a <strong>${rollData.inspirationDie}</strong> to this roll?\r\n    </p>\r\n    <div style=\"margin: 0 0 16px 0; padding: 12px; background: ${colors.infoBox}; border-radius: 8px; border-left: 4px solid #9b59b6; color: ${colors.text};\">\r\n      <strong>Current Roll:</strong> ${rollData.rollName}<br>\r\n      <strong>Base Result:</strong> ${rollData.baseRoll}<br>\r\n      <strong>Inspiration Die:</strong> ${rollData.inspirationDie}<br>\r\n      <strong>Uses Left:</strong> ${rollData.usesRemaining}\r\n    </div>\r\n    <div style=\"margin-bottom: 16px; padding: 12px; background: ${colors.infoBox}; border-radius: 8px; color: ${colors.text}; font-size: 13px; text-align: left;\">\r\n      <strong>\uD83D\uDCA1 How it works:</strong><br>\r\n      \u2022 Roll the inspiration die and add it to your total<br>\r\n      \u2022 Can be used on ability checks, attack rolls, or saves<br>\r\n      \u2022 Only one inspiration die can be used per roll\r\n    </div>\r\n    <div style=\"display: flex; gap: 12px; justify-content: center;\">\r\n      <button id=\"bardicUseBtn\" style=\"\r\n        background: #9b59b6;\r\n        color: white;\r\n        border: none;\r\n        padding: 12px 24px;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 14px;\r\n        transition: background 0.2s;\r\n      \">\uD83C\uDFB2 Use Inspiration</button>\r\n      <button id=\"bardicDeclineBtn\" style=\"\r\n        background: #7f8c8d;\r\n        color: white;\r\n        border: none;\r\n        padding: 12px 24px;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 14px;\r\n        transition: background 0.2s;\r\n      \">Decline</button>\r\n    </div>\r\n  `;\r\n\r\n  debug.log('\uD83C\uDFB5 Appending Bardic Inspiration popup to document.body...');\r\n\r\n  popupOverlay.appendChild(popupContent);\r\n  document.body.appendChild(popupOverlay);\r\n\r\n  // Add hover effects\r\n  const useBtn = document.getElementById('bardicUseBtn');\r\n  const declineBtn = document.getElementById('bardicDeclineBtn');\r\n\r\n  useBtn.addEventListener('mouseenter', () => {\r\n    useBtn.style.background = '#8e44ad';\r\n  });\r\n  useBtn.addEventListener('mouseleave', () => {\r\n    useBtn.style.background = '#9b59b6';\r\n  });\r\n\r\n  declineBtn.addEventListener('mouseenter', () => {\r\n    declineBtn.style.background = '#95a5a6';\r\n  });\r\n  declineBtn.addEventListener('mouseleave', () => {\r\n    declineBtn.style.background = '#7f8c8d';\r\n  });\r\n\r\n  // Add event listeners\r\n  useBtn.addEventListener('click', () => {\r\n    debug.log('\uD83C\uDFB5 User chose to use Bardic Inspiration');\r\n    performBardicInspirationRoll(rollData);\r\n    document.body.removeChild(popupOverlay);\r\n  });\r\n\r\n  declineBtn.addEventListener('click', () => {\r\n    debug.log('\uD83C\uDFB5 User declined Bardic Inspiration');\r\n    showNotification('Bardic Inspiration declined', 'info');\r\n    document.body.removeChild(popupOverlay);\r\n  });\r\n\r\n  // Close on overlay click\r\n  popupOverlay.addEventListener('click', (e) => {\r\n    if (e.target === popupOverlay) {\r\n      debug.log('\uD83C\uDFB5 User closed Bardic Inspiration popup');\r\n      document.body.removeChild(popupOverlay);\r\n    }\r\n  });\r\n\r\n  debug.log('\uD83C\uDFB5 Bardic Inspiration popup displayed');\r\n}\r\n\r\nfunction performBardicInspirationRoll(rollData) {\r\n  debug.log('\uD83C\uDFB5 Performing Bardic Inspiration roll with data:', rollData);\r\n\r\n  // Use one Bardic Inspiration use\r\n  const success = useBardicInspiration();\r\n  if (!success) {\r\n    debug.error('\u274C Failed to use Bardic Inspiration (no uses left?)');\r\n    showNotification('\u274C Failed to use Bardic Inspiration', 'error');\r\n    return;\r\n  }\r\n\r\n  // Roll the inspiration die\r\n  const dieSize = parseInt(rollData.inspirationDie.substring(1)); // \"d6\" -> 6\r\n  const inspirationRoll = Math.floor(Math.random() * dieSize) + 1;\r\n\r\n  debug.log(`\uD83C\uDFB5 Rolled ${rollData.inspirationDie}: ${inspirationRoll}`);\r\n\r\n  // Create the roll message\r\n  const inspirationMessage = `/roll ${rollData.inspirationDie}`;\r\n  const chatMessage = `\uD83C\uDFB5 Bardic Inspiration for ${rollData.rollName}: [[${inspirationRoll}]] (${rollData.inspirationDie})`;\r\n\r\n  // Show notification\r\n  showNotification(`\uD83C\uDFB5 Bardic Inspiration: +${inspirationRoll}!`, 'success');\r\n\r\n  // Post to Roll20 chat\r\n  browserAPI.runtime.sendMessage({\r\n    action: 'rollDice',\r\n    rollData: {\r\n      message: chatMessage,\r\n      characterName: characterData.name || 'Character'\r\n    }\r\n  });\r\n\r\n  debug.log('\uD83C\uDFB5 Bardic Inspiration roll complete');\r\n}\r\n\r\n// Elven Accuracy Popup\r\nfunction showElvenAccuracyPopup(rollData) {\r\n  debug.log('\uD83E\uDDDD Elven Accuracy popup called with:', rollData);\r\n\r\n  if (!document.body) {\r\n    debug.error('\u274C document.body not available for Elven Accuracy popup');\r\n    showNotification('\uD83E\uDDDD Elven Accuracy triggered!', 'info');\r\n    return;\r\n  }\r\n\r\n  const colors = getPopupThemeColors();\r\n\r\n  // Create popup overlay\r\n  const popupOverlay = document.createElement('div');\r\n  popupOverlay.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background: rgba(0, 0, 0, 0.8);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10000;\r\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\r\n  `;\r\n\r\n  // Create popup content\r\n  const popupContent = document.createElement('div');\r\n  popupContent.style.cssText = `\r\n    background: ${colors.background};\r\n    border-radius: 12px;\r\n    padding: 24px;\r\n    max-width: 400px;\r\n    width: 90%;\r\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\r\n    text-align: center;\r\n  `;\r\n\r\n  popupContent.innerHTML = `\r\n    <div style=\"font-size: 24px; margin-bottom: 16px;\">\uD83E\uDDDD</div>\r\n    <h2 style=\"margin: 0 0 8px 0; color: #27ae60;\">Elven Accuracy!</h2>\r\n    <p style=\"margin: 0 0 16px 0; color: ${colors.text};\">\r\n      You have advantage! Would you like to reroll the lower die?\r\n    </p>\r\n    <div style=\"margin: 0 0 16px 0; padding: 12px; background: ${colors.infoBox}; border-radius: 8px; border-left: 4px solid #27ae60; color: ${colors.text};\">\r\n      <strong>Roll:</strong> ${rollData.rollName}<br>\r\n      <strong>Type:</strong> Advantage attack roll\r\n    </div>\r\n    <div style=\"display: flex; gap: 12px; justify-content: center;\">\r\n      <button id=\"elvenRerollBtn\" style=\"\r\n        background: #27ae60;\r\n        color: white;\r\n        border: none;\r\n        padding: 12px 24px;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 14px;\r\n      \">\uD83C\uDFB2 Reroll Lower Die</button>\r\n      <button id=\"elvenKeepBtn\" style=\"\r\n        background: #95a5a6;\r\n        color: white;\r\n        border: none;\r\n        padding: 12px 24px;\r\n        border-radius: 8px;\r\n        cursor: pointer;\r\n        font-weight: bold;\r\n        font-size: 14px;\r\n      \">Keep Rolls</button>\r\n    </div>\r\n  `;\r\n\r\n  popupOverlay.appendChild(popupContent);\r\n  document.body.appendChild(popupOverlay);\r\n\r\n  // Add event listeners\r\n  const rerollBtn = document.getElementById('elvenRerollBtn');\r\n  const keepBtn = document.getElementById('elvenKeepBtn');\r\n\r\n  rerollBtn.addEventListener('mouseenter', () => rerollBtn.style.background = '#229954');\r\n  rerollBtn.addEventListener('mouseleave', () => rerollBtn.style.background = '#27ae60');\r\n  keepBtn.addEventListener('mouseenter', () => keepBtn.style.background = '#7f8c8d');\r\n  keepBtn.addEventListener('mouseleave', () => keepBtn.style.background = '#95a5a6');\r\n\r\n  rerollBtn.addEventListener('click', () => {\r\n    debug.log('\uD83E\uDDDD User chose to reroll with Elven Accuracy');\r\n    performElvenAccuracyReroll(rollData);\r\n    document.body.removeChild(popupOverlay);\r\n  });\r\n\r\n  keepBtn.addEventListener('click', () => {\r\n    debug.log('\uD83E\uDDDD User chose to keep original advantage rolls');\r\n    document.body.removeChild(popupOverlay);\r\n  });\r\n\r\n  // Close on overlay click\r\n  popupOverlay.addEventListener('click', (e) => {\r\n    if (e.target === popupOverlay) {\r\n      document.body.removeChild(popupOverlay);\r\n    }\r\n  });\r\n\r\n  debug.log('\uD83E\uDDDD Elven Accuracy popup displayed');\r\n}\r\n\r\nfunction performElvenAccuracyReroll(originalRollData) {\r\n  debug.log('\uD83E\uDDDD Performing Elven Accuracy reroll for:', originalRollData);\r\n\r\n  // Roll a third d20\r\n  const thirdRoll = Math.floor(Math.random() * 20) + 1;\r\n\r\n  // Create reroll announcement\r\n  const rerollData = {\r\n    name: `\uD83E\uDDDD ${originalRollData.rollName} (Elven Accuracy - 3rd die)`,\r\n    formula: '1d20',\r\n    color: '#27ae60',\r\n    characterName: characterData.name\r\n  };\r\n\r\n  debug.log('\uD83E\uDDDD Third die roll:', thirdRoll);\r\n\r\n  // Announce the third die roll to Roll20\r\n  const colorBanner = getColoredBanner();\r\n  const message = `&{template:default} {{name=${colorBanner}${characterData.name} uses Elven Accuracy! \uD83E\uDDDD}} {{Action=Reroll lower die}} {{Third d20=${thirdRoll}}} {{=Choose the highest of all three rolls!}}`;\r\n\r\n  if (window.opener && !window.opener.closed) {\r\n    window.opener.postMessage({\r\n      action: 'announceSpell',\r\n      message: message\r\n    }, '*');\r\n  } else {\r\n    // Fallback: send directly to Roll20 via background script\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'relayRollToRoll20',\r\n      roll: { ...rerollData, result: thirdRoll }\r\n    });\r\n  }\r\n\r\n  showNotification(`\uD83E\uDDDD Elven Accuracy! Third die: ${thirdRoll}`, 'success');\r\n}\r\n\r\n// Lucky Modal (simple like metamagic)\r\nfunction showLuckyModal() {\r\n  debug.log('\uD83C\uDF96\uFE0F Lucky modal called');\r\n\r\n  const luckyResource = getLuckyResource();\r\n  if (!luckyResource || luckyResource.current <= 0) {\r\n    showNotification('\u274C No luck points available!', 'error');\r\n    return;\r\n  }\r\n\r\n  // Create modal overlay\r\n  const modal = document.createElement('div');\r\n  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';\r\n\r\n  // Create modal content\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = 'background: white; border-radius: 8px; padding: 20px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';\r\n\r\n  modalContent.innerHTML = `\r\n    <h3 style=\"margin: 0 0 15px 0; color: #f39c12;\">\uD83C\uDF96\uFE0F Use Lucky Point</h3>\r\n    <p style=\"margin: 0 0 15px 0; color: #666;\">Choose what to use Lucky for:</p>\r\n    <div style=\"margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;\">\r\n      <strong>Luck Points:</strong> ${luckyResource.current}/${luckyResource.max}\r\n    </div>\r\n    <div style=\"display: flex; flex-direction: column; gap: 8px;\">\r\n      <button id=\"luckyOffensive\" style=\"padding: 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;\">\u2694\uFE0F Attack/Check/Saving Throw</button>\r\n      <button id=\"luckyDefensive\" style=\"padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;\">\uD83D\uDEE1\uFE0F Against Attack on You</button>\r\n      <button id=\"luckyCancel\" style=\"padding: 10px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;\">Cancel</button>\r\n    </div>\r\n  `;\r\n\r\n  modal.appendChild(modalContent);\r\n  document.body.appendChild(modal);\r\n\r\n  // Add event listeners\r\n  document.getElementById('luckyOffensive').addEventListener('click', () => {\r\n    if (useLuckyPoint()) {\r\n      modal.remove();\r\n      // Roll a d20 for Lucky\r\n      rollLuckyDie('offensive');\r\n    }\r\n  });\r\n\r\n  document.getElementById('luckyDefensive').addEventListener('click', () => {\r\n    if (useLuckyPoint()) {\r\n      modal.remove();\r\n      // Roll a d20 for Lucky defense\r\n      rollLuckyDie('defensive');\r\n    }\r\n  });\r\n\r\n  document.getElementById('luckyCancel').addEventListener('click', () => {\r\n    modal.remove();\r\n  });\r\n\r\n  // Close on overlay click\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) modal.remove();\r\n  });\r\n\r\n  debug.log('\uD83C\uDF96\uFE0F Lucky modal displayed');\r\n}\r\n\r\nfunction rollLuckyDie(type) {\r\n  debug.log(`\uD83C\uDF96\uFE0F Rolling Lucky d20 for ${type}`);\r\n  \r\n  // Roll a d20\r\n  const luckyRoll = Math.floor(Math.random() * 20) + 1;\r\n  \r\n  // Send the Lucky roll to Roll20 chat\r\n  const rollData = {\r\n    name: `\uD83C\uDF96\uFE0F ${characterData.name} uses Lucky`,\r\n    formula: '1d20',\r\n    characterName: characterData.name\r\n  };\r\n\r\n  // Send the roll to Roll20\r\n  if (window.opener && !window.opener.closed) {\r\n    window.opener.postMessage({\r\n      action: 'rollFromPopout',\r\n      ...rollData\r\n    }, '*');\r\n    debug.log('\uD83C\uDF96\uFE0F Lucky roll sent via window.opener');\r\n  } else {\r\n    // Fallback: send directly to Roll20 via background script\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'relayRollToRoll20',\r\n      roll: rollData\r\n    });\r\n  }\r\n  \r\n  if (type === 'offensive') {\r\n    showNotification(`\uD83C\uDF96\uFE0F Lucky roll: ${luckyRoll}! Use this instead of your next d20 roll.`, 'success');\r\n  } else {\r\n    showNotification(`\uD83C\uDF96\uFE0F Lucky defense roll: ${luckyRoll}! Compare against attacker's roll.`, 'success');\r\n  }\r\n  \r\n  debug.log(`\uD83C\uDF96\uFE0F Lucky d20 result: ${luckyRoll} - sent to chat`);\r\n}\r\n\r\nfunction performHalflingReroll(originalRollData) {\r\n  debug.log('\uD83C\uDF40 Performing Halfling reroll for:', originalRollData);\r\n  \r\n  // Extract the base formula (remove any modifiers)\r\n  const formula = originalRollData.rollType;\r\n  const baseFormula = formula.split('+')[0]; // Get just the d20 part\r\n  \r\n  // Create a new roll with just the d20\r\n  const rerollData = {\r\n    name: `\uD83C\uDF40 ${originalRollData.rollName} (Halfling Luck)`,\r\n    formula: baseFormula,\r\n    color: '#2D8B83',\r\n    characterName: characterData.name\r\n  };\r\n  \r\n  debug.log('\uD83C\uDF40 Reroll data:', rerollData);\r\n  \r\n  // Send the reroll request\r\n  if (window.opener && !window.opener.closed) {\r\n    // Send via popup window opener (Roll20 content script)\r\n    window.opener.postMessage({\r\n      action: 'rollFromPopout',\r\n      ...rerollData\r\n    }, '*');\r\n  } else {\r\n    // Fallback: send directly to Roll20 via background script\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'relayRollToRoll20',\r\n      roll: rerollData\r\n    });\r\n  }\r\n  \r\n  showNotification('\uD83C\uDF40 Halfling Luck reroll initiated!', 'success');\r\n}\r\n\r\n// Halfling Luck Racial Trait\r\nconst HalflingLuck = {\r\n  name: 'Halfling Luck',\r\n  description: 'When you roll a 1 on an attack roll, ability check, or saving throw, you can reroll the die and must use the new roll.',\r\n  \r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    debug.log(`\uD83E\uDDEC Halfling Luck onRoll called with: ${rollResult}, ${rollType}, ${rollName}`);\r\n    debug.log(`\uD83E\uDDEC Halfling Luck DEBUG - rollType exists: ${!!rollType}, includes d20: ${rollType && rollType.includes('d20')}, rollResult === 1: ${parseInt(rollResult) === 1}`);\r\n\r\n    // Convert rollResult to number for comparison\r\n    const numericRollResult = parseInt(rollResult);\r\n    \r\n    // Check if it's a d20 roll and the result is 1\r\n    if (rollType && rollType.includes('d20') && numericRollResult === 1) {\r\n      debug.log(`\uD83E\uDDEC Halfling Luck: TRIGGERED! Roll was ${numericRollResult}`);\r\n\r\n      // Show the popup with error handling\r\n      try {\r\n        showHalflingLuckPopup({\r\n          rollResult: numericRollResult,\r\n          baseRoll: numericRollResult,\r\n          rollType: rollType,\r\n          rollName: rollName\r\n        });\r\n      } catch (error) {\r\n        debug.error('\u274C Error showing Halfling Luck popup:', error);\r\n        // Fallback notification\r\n        showNotification('\uD83C\uDF40 Halfling Luck triggered! Check console for details.', 'info');\r\n      }\r\n\r\n      return true; // Trait triggered\r\n    }\r\n\r\n    debug.log(`\uD83E\uDDEC Halfling Luck: No trigger - Roll: ${numericRollResult}, Type: ${rollType}`);\r\n    return false; // No trigger\r\n  }\r\n};\r\n\r\n// Lucky Feat Trait\r\nconst LuckyFeat = {\r\n  name: 'Lucky',\r\n  description: 'You have 3 luck points. When you make an attack roll, ability check, or saving throw, you can spend one luck point to roll an additional d20. You can then choose which of the d20 rolls to use.',\r\n  \r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    debug.log(`\uD83C\uDF96\uFE0F Lucky feat onRoll called with: ${rollResult}, ${rollType}, ${rollName}`);\r\n    \r\n    // Convert rollResult to number for comparison\r\n    const numericRollResult = parseInt(rollResult);\r\n    \r\n    // Check if it's a d20 roll (attack, ability check, or saving throw)\r\n    if (rollType && rollType.includes('d20')) {\r\n      debug.log(`\uD83C\uDF96\uFE0F Lucky: Checking if we should offer reroll for ${numericRollResult}`);\r\n      \r\n      // Check if character has luck points available\r\n      const luckyResource = getLuckyResource();\r\n      if (!luckyResource || luckyResource.current <= 0) {\r\n        debug.log(`\uD83C\uDF96\uFE0F Lucky: No luck points available (${luckyResource?.current || 0})`);\r\n        return false;\r\n      }\r\n      \r\n      debug.log(`\uD83C\uDF96\uFE0F Lucky: Has ${luckyResource.current} luck points available`);\r\n      \r\n      // For Lucky feat, we offer reroll on any roll (not just 1s)\r\n      // But we should prioritize low rolls\r\n      if (numericRollResult <= 10) { // Offer reroll on rolls of 10 or less\r\n        debug.log(`\uD83C\uDF96\uFE0F Lucky: TRIGGERED! Offering reroll for roll ${numericRollResult}`);\r\n        \r\n        // Show the Lucky popup with error handling\r\n        try {\r\n          showLuckyPopup({\r\n            rollResult: numericRollResult,\r\n            baseRoll: numericRollResult,\r\n            rollType: rollType,\r\n            rollName: rollName,\r\n            luckPointsRemaining: luckyResource.current\r\n          });\r\n        } catch (error) {\r\n          debug.error('\u274C Error showing Lucky popup:', error);\r\n          // Fallback notification\r\n          showNotification('\uD83C\uDF96\uFE0F Lucky triggered! Check console for details.', 'info');\r\n        }\r\n        \r\n        return true; // Trait triggered\r\n      }\r\n    }\r\n\r\n    debug.log(`\uD83C\uDF96\uFE0F Lucky: No trigger - Roll: ${numericRollResult}, Type: ${rollType}`);\r\n    return false; // No trigger\r\n  }\r\n};\r\n\r\n// ============================================================================\r\n// RACIAL TRAITS - ADDITIONAL\r\n// ============================================================================\r\n\r\n// Elven Accuracy\r\nconst ElvenAccuracy = {\r\n  name: 'Elven Accuracy',\r\n  description: 'Whenever you have advantage on an attack roll using Dexterity, Intelligence, Wisdom, or Charisma, you can reroll one of the dice once.',\r\n\r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    debug.log(`\uD83E\uDDDD Elven Accuracy onRoll called with: ${rollResult}, ${rollType}, ${rollName}`);\r\n\r\n    // Check if it's an attack roll with advantage using DEX/INT/WIS/CHA\r\n    // The rollType should contain \"advantage\" and the roll should be an attack\r\n    if (rollType && rollType.includes('advantage') && rollType.includes('attack')) {\r\n      debug.log(`\uD83E\uDDDD Elven Accuracy: TRIGGERED! Offering to reroll lower die`);\r\n\r\n      // Show popup asking if they want to reroll\r\n      showElvenAccuracyPopup({\r\n        rollName: rollName,\r\n        rollType: rollType,\r\n        rollResult: rollResult\r\n      });\r\n\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n};\r\n\r\n// Dwarven Resilience\r\nconst DwarvenResilience = {\r\n  name: 'Dwarven Resilience',\r\n  description: 'You have advantage on saving throws against poison.',\r\n\r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    debug.log(`\u26CF\uFE0F Dwarven Resilience onRoll called with: ${rollResult}, ${rollType}, ${rollName}`);\r\n\r\n    // Check if it's a poison save\r\n    const lowerRollName = rollName.toLowerCase();\r\n    if (rollType && rollType.includes('save') && lowerRollName.includes('poison')) {\r\n      debug.log(`\u26CF\uFE0F Dwarven Resilience: TRIGGERED! Auto-applying advantage`);\r\n      showNotification('\u26CF\uFE0F Dwarven Resilience: Advantage on poison saves!', 'success');\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n};\r\n\r\n// Gnome Cunning\r\nconst GnomeCunning = {\r\n  name: 'Gnome Cunning',\r\n  description: 'You have advantage on all Intelligence, Wisdom, and Charisma saving throws against magic.',\r\n\r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    debug.log(`\uD83C\uDFA9 Gnome Cunning onRoll called with: ${rollResult}, ${rollType}, ${rollName}`);\r\n\r\n    // Check if it's an INT/WIS/CHA save against magic\r\n    const lowerRollName = rollName.toLowerCase();\r\n    const isMentalSave = lowerRollName.includes('intelligence') ||\r\n                         lowerRollName.includes('wisdom') ||\r\n                         lowerRollName.includes('charisma') ||\r\n                         lowerRollName.includes('int save') ||\r\n                         lowerRollName.includes('wis save') ||\r\n                         lowerRollName.includes('cha save');\r\n\r\n    const isMagic = lowerRollName.includes('spell') ||\r\n                    lowerRollName.includes('magic') ||\r\n                    lowerRollName.includes('charm') ||\r\n                    lowerRollName.includes('illusion');\r\n\r\n    if (rollType && rollType.includes('save') && isMentalSave && isMagic) {\r\n      debug.log(`\uD83C\uDFA9 Gnome Cunning: TRIGGERED! Auto-applying advantage`);\r\n      showNotification('\uD83C\uDFA9 Gnome Cunning: Advantage on mental saves vs magic!', 'success');\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n};\r\n\r\n// ============================================================================\r\n// CLASS FEATURES\r\n// ============================================================================\r\n\r\n// Reliable Talent (Rogue 11+)\r\nconst ReliableTalent = {\r\n  name: 'Reliable Talent',\r\n  description: 'Whenever you make an ability check that lets you add your proficiency bonus, you treat a d20 roll of 9 or lower as a 10.',\r\n\r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    debug.log(`\uD83C\uDFAF Reliable Talent onRoll called with: ${rollResult}, ${rollType}, ${rollName}`);\r\n\r\n    const numericRollResult = parseInt(rollResult);\r\n\r\n    // Check if it's a skill check (proficient skills would be marked somehow)\r\n    if (rollType && rollType.includes('skill') && numericRollResult < 10) {\r\n      debug.log(`\uD83C\uDFAF Reliable Talent: TRIGGERED! Minimum roll is 10`);\r\n      showNotification(`\uD83C\uDFAF Reliable Talent: ${numericRollResult} becomes 10!`, 'success');\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n};\r\n\r\n// Jack of All Trades (Bard)\r\nconst JackOfAllTrades = {\r\n  name: 'Jack of All Trades',\r\n  description: 'You can add half your proficiency bonus (rounded down) to any ability check you make that doesn\\'t already include your proficiency bonus.',\r\n\r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    debug.log(`\uD83C\uDFB5 Jack of All Trades onRoll called with: ${rollResult}, ${rollType}, ${rollName}`);\r\n\r\n    // This would need to check if the skill is non-proficient\r\n    // For now, we'll show a reminder\r\n    if (rollType && rollType.includes('skill')) {\r\n      const profBonus = characterData.proficiencyBonus || 2;\r\n      const halfProf = Math.floor(profBonus / 2);\r\n      debug.log(`\uD83C\uDFB5 Jack of All Trades: Reminder to add +${halfProf} if non-proficient`);\r\n      showNotification(`\uD83C\uDFB5 Jack: Add +${halfProf} if non-proficient`, 'info');\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n};\r\n\r\n// Rage Damage Bonus (Barbarian)\r\nconst RageDamageBonus = {\r\n  name: 'Rage',\r\n  description: 'While raging, you gain bonus damage on melee weapon attacks using Strength.',\r\n\r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    debug.log(`\uD83D\uDE21 Rage Damage onRoll called with: ${rollResult}, ${rollType}, ${rollName}`);\r\n\r\n    // Check if character is raging (would need rage tracking)\r\n    const isRaging = characterData.conditions && characterData.conditions.some(c =>\r\n      c.toLowerCase().includes('rage') || c.toLowerCase().includes('raging')\r\n    );\r\n\r\n    if (isRaging && rollType && rollType.includes('attack')) {\r\n      const level = characterData.level || 1;\r\n      const rageDamage = level < 9 ? 2 : level < 16 ? 3 : 4;\r\n      debug.log(`\uD83D\uDE21 Rage Damage: TRIGGERED! Adding +${rageDamage} damage`);\r\n      showNotification(`\uD83D\uDE21 Rage: Add +${rageDamage} damage!`, 'success');\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n};\r\n\r\n// Brutal Critical (Barbarian)\r\nconst BrutalCritical = {\r\n  name: 'Brutal Critical',\r\n  description: 'You can roll one additional weapon damage die when determining the extra damage for a critical hit with a melee attack.',\r\n\r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    debug.log(`\uD83D\uDCA5 Brutal Critical onRoll called with: ${rollResult}, ${rollType}, ${rollName}`);\r\n\r\n    const numericRollResult = parseInt(rollResult);\r\n\r\n    // Check for natural 20 on melee attack\r\n    if (rollType && rollType.includes('attack') && numericRollResult === 20) {\r\n      const level = characterData.level || 1;\r\n      const extraDice = level < 13 ? 1 : level < 17 ? 2 : 3;\r\n      debug.log(`\uD83D\uDCA5 Brutal Critical: TRIGGERED! Roll ${extraDice} extra weapon die/dice`);\r\n      showNotification(`\uD83D\uDCA5 Brutal Critical: Roll ${extraDice} extra weapon die!`, 'success');\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n};\r\n\r\n// Portent Dice (Divination Wizard)\r\nconst PortentDice = {\r\n  name: 'Portent',\r\n  description: 'Roll two d20s and record the numbers. You can replace any attack roll, saving throw, or ability check made by you or a creature you can see with one of these rolls.',\r\n\r\n  portentRolls: [], // Store portent rolls for the day\r\n\r\n  rollPortentDice: function() {\r\n    const roll1 = Math.floor(Math.random() * 20) + 1;\r\n    const roll2 = Math.floor(Math.random() * 20) + 1;\r\n    this.portentRolls = [roll1, roll2];\r\n    debug.log(`\uD83D\uDD2E Portent: Rolled ${roll1} and ${roll2}`);\r\n    showNotification(`\uD83D\uDD2E Portent: You rolled ${roll1} and ${roll2}`, 'info');\r\n    return this.portentRolls;\r\n  },\r\n\r\n  usePortentRoll: function(index) {\r\n    if (index >= 0 && index < this.portentRolls.length) {\r\n      const roll = this.portentRolls.splice(index, 1)[0];\r\n      debug.log(`\uD83D\uDD2E Portent: Used portent roll ${roll}`);\r\n      showNotification(`\uD83D\uDD2E Portent: Applied roll of ${roll}`, 'success');\r\n      return roll;\r\n    }\r\n    return null;\r\n  },\r\n\r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    // Portent is applied manually, not automatically triggered\r\n    if (this.portentRolls.length > 0) {\r\n      showNotification(`\uD83D\uDD2E ${this.portentRolls.length} Portent dice available`, 'info');\r\n    }\r\n    return false;\r\n  }\r\n};\r\n\r\n// Wild Magic Surge Table (d100)\r\nconst WILD_MAGIC_EFFECTS = [\r\n  \"Roll on this table at the start of each of your turns for the next minute, ignoring this result on subsequent rolls.\",\r\n  \"Roll on this table at the start of each of your turns for the next minute, ignoring this result on subsequent rolls.\",\r\n  \"For the next minute, you can see any invisible creature if you have line of sight to it.\",\r\n  \"For the next minute, you can see any invisible creature if you have line of sight to it.\",\r\n  \"A modron chosen and controlled by the DM appears in an unoccupied space within 5 feet of you, then disappears 1 minute later.\",\r\n  \"A modron chosen and controlled by the DM appears in an unoccupied space within 5 feet of you, then disappears 1 minute later.\",\r\n  \"You cast Fireball as a 3rd-level spell centered on yourself.\",\r\n  \"You cast Fireball as a 3rd-level spell centered on yourself.\",\r\n  \"You cast Magic Missile as a 5th-level spell.\",\r\n  \"You cast Magic Missile as a 5th-level spell.\",\r\n  \"Roll a d10. Your height changes by a number of inches equal to the roll. If the roll is odd, you shrink. If the roll is even, you grow.\",\r\n  \"Roll a d10. Your height changes by a number of inches equal to the roll. If the roll is odd, you shrink. If the roll is even, you grow.\",\r\n  \"You cast Confusion centered on yourself.\",\r\n  \"You cast Confusion centered on yourself.\",\r\n  \"For the next minute, you regain 5 hit points at the start of each of your turns.\",\r\n  \"For the next minute, you regain 5 hit points at the start of each of your turns.\",\r\n  \"You grow a long beard made of feathers that remains until you sneeze, at which point the feathers explode out from your face.\",\r\n  \"You grow a long beard made of feathers that remains until you sneeze, at which point the feathers explode out from your face.\",\r\n  \"You cast Grease centered on yourself.\",\r\n  \"You cast Grease centered on yourself.\",\r\n  \"Creatures have disadvantage on saving throws against the next spell you cast in the next minute that involves a saving throw.\",\r\n  \"Creatures have disadvantage on saving throws against the next spell you cast in the next minute that involves a saving throw.\",\r\n  \"Your skin turns a vibrant shade of blue. A Remove Curse spell can end this effect.\",\r\n  \"Your skin turns a vibrant shade of blue. A Remove Curse spell can end this effect.\",\r\n  \"An eye appears on your forehead for the next minute. During that time, you have advantage on Wisdom (Perception) checks that rely on sight.\",\r\n  \"An eye appears on your forehead for the next minute. During that time, you have advantage on Wisdom (Perception) checks that rely on sight.\",\r\n  \"For the next minute, all your spells with a casting time of 1 action have a casting time of 1 bonus action.\",\r\n  \"For the next minute, all your spells with a casting time of 1 action have a casting time of 1 bonus action.\",\r\n  \"You teleport up to 60 feet to an unoccupied space of your choice that you can see.\",\r\n  \"You teleport up to 60 feet to an unoccupied space of your choice that you can see.\",\r\n  \"You are transported to the Astral Plane until the end of your next turn, after which time you return to the space you previously occupied or the nearest unoccupied space if that space is occupied.\",\r\n  \"You are transported to the Astral Plane until the end of your next turn, after which time you return to the space you previously occupied or the nearest unoccupied space if that space is occupied.\",\r\n  \"Maximize the damage of the next damaging spell you cast within the next minute.\",\r\n  \"Maximize the damage of the next damaging spell you cast within the next minute.\",\r\n  \"Roll a d10. Your age changes by a number of years equal to the roll. If the roll is odd, you get younger (minimum 1 year old). If the roll is even, you get older.\",\r\n  \"Roll a d10. Your age changes by a number of years equal to the roll. If the roll is odd, you get younger (minimum 1 year old). If the roll is even, you get older.\",\r\n  \"1d6 flumphs controlled by the DM appear in unoccupied spaces within 60 feet of you and are frightened of you. They vanish after 1 minute.\",\r\n  \"1d6 flumphs controlled by the DM appear in unoccupied spaces within 60 feet of you and are frightened of you. They vanish after 1 minute.\",\r\n  \"You regain 2d10 hit points.\",\r\n  \"You regain 2d10 hit points.\",\r\n  \"You turn into a potted plant until the start of your next turn. While a plant, you are incapacitated and have vulnerability to all damage. If you drop to 0 hit points, your pot breaks, and your form reverts.\",\r\n  \"You turn into a potted plant until the start of your next turn. While a plant, you are incapacitated and have vulnerability to all damage. If you drop to 0 hit points, your pot breaks, and your form reverts.\",\r\n  \"For the next minute, you can teleport up to 20 feet as a bonus action on each of your turns.\",\r\n  \"For the next minute, you can teleport up to 20 feet as a bonus action on each of your turns.\",\r\n  \"You cast Levitate on yourself.\",\r\n  \"You cast Levitate on yourself.\",\r\n  \"A unicorn controlled by the DM appears in a space within 5 feet of you, then disappears 1 minute later.\",\r\n  \"A unicorn controlled by the DM appears in a space within 5 feet of you, then disappears 1 minute later.\",\r\n  \"You can't speak for the next minute. Whenever you try, pink bubbles float out of your mouth.\",\r\n  \"You can't speak for the next minute. Whenever you try, pink bubbles float out of your mouth.\",\r\n  \"A spectral shield hovers near you for the next minute, granting you a +2 bonus to AC and immunity to Magic Missile.\",\r\n  \"A spectral shield hovers near you for the next minute, granting you a +2 bonus to AC and immunity to Magic Missile.\",\r\n  \"You are immune to being intoxicated by alcohol for the next 5d6 days.\",\r\n  \"You are immune to being intoxicated by alcohol for the next 5d6 days.\",\r\n  \"Your hair falls out but grows back within 24 hours.\",\r\n  \"Your hair falls out but grows back within 24 hours.\",\r\n  \"For the next minute, any flammable object you touch that isn't being worn or carried by another creature bursts into flame.\",\r\n  \"For the next minute, any flammable object you touch that isn't being worn or carried by another creature bursts into flame.\",\r\n  \"You regain your lowest-level expended spell slot.\",\r\n  \"You regain your lowest-level expended spell slot.\",\r\n  \"For the next minute, you must shout when you speak.\",\r\n  \"For the next minute, you must shout when you speak.\",\r\n  \"You cast Fog Cloud centered on yourself.\",\r\n  \"You cast Fog Cloud centered on yourself.\",\r\n  \"Up to three creatures you choose within 30 feet of you take 4d10 lightning damage.\",\r\n  \"Up to three creatures you choose within 30 feet of you take 4d10 lightning damage.\",\r\n  \"You are frightened by the nearest creature until the end of your next turn.\",\r\n  \"You are frightened by the nearest creature until the end of your next turn.\",\r\n  \"Each creature within 30 feet of you becomes invisible for the next minute. The invisibility ends on a creature when it attacks or casts a spell.\",\r\n  \"Each creature within 30 feet of you becomes invisible for the next minute. The invisibility ends on a creature when it attacks or casts a spell.\",\r\n  \"You gain resistance to all damage for the next minute.\",\r\n  \"You gain resistance to all damage for the next minute.\",\r\n  \"A random creature within 60 feet of you becomes poisoned for 1d4 hours.\",\r\n  \"A random creature within 60 feet of you becomes poisoned for 1d4 hours.\",\r\n  \"You glow with bright light in a 30-foot radius for the next minute. Any creature that ends its turn within 5 feet of you is blinded until the end of its next turn.\",\r\n  \"You glow with bright light in a 30-foot radius for the next minute. Any creature that ends its turn within 5 feet of you is blinded until the end of its next turn.\",\r\n  \"You cast Polymorph on yourself. If you fail the saving throw, you turn into a sheep for the spell's duration.\",\r\n  \"You cast Polymorph on yourself. If you fail the saving throw, you turn into a sheep for the spell's duration.\",\r\n  \"Illusory butterflies and flower petals flutter in the air within 10 feet of you for the next minute.\",\r\n  \"Illusory butterflies and flower petals flutter in the air within 10 feet of you for the next minute.\",\r\n  \"You can take one additional action immediately.\",\r\n  \"You can take one additional action immediately.\",\r\n  \"Each creature within 30 feet of you takes 1d10 necrotic damage. You regain hit points equal to the sum of the necrotic damage dealt.\",\r\n  \"Each creature within 30 feet of you takes 1d10 necrotic damage. You regain hit points equal to the sum of the necrotic damage dealt.\",\r\n  \"You cast Mirror Image.\",\r\n  \"You cast Mirror Image.\",\r\n  \"You cast Fly on a random creature within 60 feet of you.\",\r\n  \"You cast Fly on a random creature within 60 feet of you.\",\r\n  \"You become invisible for the next minute. During that time, other creatures can't hear you. The invisibility ends if you attack or cast a spell.\",\r\n  \"You become invisible for the next minute. During that time, other creatures can't hear you. The invisibility ends if you attack or cast a spell.\",\r\n  \"If you die within the next minute, you immediately come back to life as if by the Reincarnate spell.\",\r\n  \"If you die within the next minute, you immediately come back to life as if by the Reincarnate spell.\",\r\n  \"Your size increases by one size category for the next minute.\",\r\n  \"Your size increases by one size category for the next minute.\",\r\n  \"You and all creatures within 30 feet of you gain vulnerability to piercing damage for the next minute.\",\r\n  \"You and all creatures within 30 feet of you gain vulnerability to piercing damage for the next minute.\",\r\n  \"You are surrounded by faint, ethereal music for the next minute.\",\r\n  \"You are surrounded by faint, ethereal music for the next minute.\",\r\n  \"You regain all expended sorcery points.\",\r\n  \"You regain all expended sorcery points.\"\r\n];\r\n\r\n// Wild Magic Surge (Wild Magic Sorcerer)\r\nconst WildMagicSurge = {\r\n  name: 'Wild Magic Surge',\r\n  description: 'Immediately after you cast a sorcerer spell of 1st level or higher, the DM can have you roll a d20. If you roll a 1, roll on the Wild Magic Surge table.',\r\n\r\n  onSpellCast: function(spellLevel) {\r\n    if (spellLevel >= 1) {\r\n      const surgeRoll = Math.floor(Math.random() * 20) + 1;\r\n      debug.log(`\uD83C\uDF00 Wild Magic: Rolled ${surgeRoll} for surge check`);\r\n\r\n      if (surgeRoll === 1) {\r\n        const surgeTableRoll = Math.floor(Math.random() * 100) + 1;\r\n        const effect = WILD_MAGIC_EFFECTS[surgeTableRoll - 1];\r\n        debug.log(`\uD83C\uDF00 Wild Magic: SURGE! d100 = ${surgeTableRoll}: ${effect}`);\r\n        showWildMagicSurgePopup(surgeTableRoll, effect);\r\n        return true;\r\n      } else {\r\n        showNotification(`\uD83C\uDF00 Wild Magic check: ${surgeRoll} (no surge)`, 'info');\r\n      }\r\n    }\r\n    return false;\r\n  },\r\n\r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    // Wild Magic is triggered on spell cast, not regular rolls\r\n    return false;\r\n  }\r\n};\r\n\r\n// Bardic Inspiration (Bard)\r\nconst BardicInspiration = {\r\n  name: 'Bardic Inspiration',\r\n  description: 'You can inspire others through stirring words or music. As a bonus action, grant an ally a Bardic Inspiration die they can add to an ability check, attack roll, or saving throw.',\r\n\r\n  onRoll: function(rollResult, rollType, rollName) {\r\n    debug.log(`\uD83C\uDFB5 Bardic Inspiration onRoll called with: ${rollResult}, ${rollType}, ${rollName}`);\r\n\r\n    // Check if it's a d20 roll (ability check, attack, or save)\r\n    if (rollType && rollType.includes('d20')) {\r\n      debug.log(`\uD83C\uDFB5 Bardic Inspiration: Checking if we should offer inspiration for ${rollName}`);\r\n\r\n      // Check if character has Bardic Inspiration uses available\r\n      const inspirationResource = getBardicInspirationResource();\r\n      if (!inspirationResource || inspirationResource.current <= 0) {\r\n        debug.log(`\uD83C\uDFB5 Bardic Inspiration: No uses available (${inspirationResource?.current || 0})`);\r\n        return false;\r\n      }\r\n\r\n      debug.log(`\uD83C\uDFB5 Bardic Inspiration: Has ${inspirationResource.current} uses available`);\r\n\r\n      // Get the inspiration die size based on bard level\r\n      const level = characterData.level || 1;\r\n      const inspirationDie = level < 5 ? 'd6' : level < 10 ? 'd8' : level < 15 ? 'd10' : 'd12';\r\n\r\n      // Offer Bardic Inspiration on any d20 roll\r\n      debug.log(`\uD83C\uDFB5 Bardic Inspiration: TRIGGERED! Offering ${inspirationDie}`);\r\n\r\n      // Show the Bardic Inspiration popup with error handling\r\n      try {\r\n        showBardicInspirationPopup({\r\n          rollResult: parseInt(rollResult),\r\n          baseRoll: parseInt(rollResult),\r\n          rollType: rollType,\r\n          rollName: rollName,\r\n          inspirationDie: inspirationDie,\r\n          usesRemaining: inspirationResource.current\r\n        });\r\n      } catch (error) {\r\n        debug.error('\u274C Error showing Bardic Inspiration popup:', error);\r\n        // Fallback notification\r\n        showNotification(`\uD83C\uDFB5 Bardic Inspiration available! (${inspirationDie})`, 'info');\r\n      }\r\n\r\n      return true; // Trait triggered\r\n    }\r\n\r\n    debug.log(`\uD83C\uDFB5 Bardic Inspiration: No trigger - Type: ${rollType}`);\r\n    return false; // No trigger\r\n  }\r\n};\r\n\r\nfunction getBardicInspirationResource() {\r\n  if (!characterData || !characterData.resources) {\r\n    debug.log('\uD83C\uDFB5 No characterData or resources for Bardic Inspiration detection');\r\n    return null;\r\n  }\r\n\r\n  // Find Bardic Inspiration in resources (flexible matching)\r\n  const inspirationResource = characterData.resources.find(r => {\r\n    const lowerName = r.name.toLowerCase().trim();\r\n    return (\r\n      lowerName.includes('bardic inspiration') ||\r\n      lowerName === 'bardic inspiration' ||\r\n      lowerName === 'inspiration' ||\r\n      lowerName.includes('inspiration die') ||\r\n      lowerName.includes('inspiration dice')\r\n    );\r\n  });\r\n\r\n  if (inspirationResource) {\r\n    debug.log(`\uD83C\uDFB5 Found Bardic Inspiration resource: ${inspirationResource.name} (${inspirationResource.current}/${inspirationResource.max})`);\r\n  } else {\r\n    debug.log('\uD83C\uDFB5 No Bardic Inspiration resource found in character data');\r\n  }\r\n\r\n  return inspirationResource;\r\n}\r\n\r\nfunction useBardicInspiration() {\r\n  debug.log('\uD83C\uDFB5 useBardicInspiration called');\r\n  const inspirationResource = getBardicInspirationResource();\r\n  debug.log('\uD83C\uDFB5 Bardic Inspiration resource found:', inspirationResource);\r\n\r\n  if (!inspirationResource) {\r\n    debug.error('\u274C No Bardic Inspiration resource found');\r\n    return false;\r\n  }\r\n\r\n  if (inspirationResource.current <= 0) {\r\n    debug.error(`\u274C No Bardic Inspiration uses available (current: ${inspirationResource.current})`);\r\n    return false;\r\n  }\r\n\r\n  // Decrement Bardic Inspiration uses\r\n  const oldCurrent = inspirationResource.current;\r\n  inspirationResource.current--;\r\n\r\n  debug.log(`\u2705 Used Bardic Inspiration (${oldCurrent} \u2192 ${inspirationResource.current})`);\r\n\r\n  // Save to storage\r\n  browserAPI.storage.local.set({ characterData: characterData });\r\n\r\n  // Refresh resources display\r\n  buildResourcesDisplay();\r\n\r\n  return true;\r\n}\r\n\r\nfunction getLuckyResource() {\r\n  if (!characterData || !characterData.resources) {\r\n    debug.log('\uD83C\uDF96\uFE0F No characterData or resources for Lucky detection');\r\n    return null;\r\n  }\r\n\r\n  // Find Lucky points in resources (flexible matching)\r\n  const luckyResource = characterData.resources.find(r => {\r\n    const lowerName = r.name.toLowerCase().trim();\r\n    return (\r\n      lowerName.includes('lucky point') ||\r\n      lowerName.includes('luck point') ||\r\n      lowerName === 'lucky points' ||\r\n      lowerName === 'lucky'\r\n    );\r\n  });\r\n\r\n  if (luckyResource) {\r\n    debug.log(`\uD83C\uDF96\uFE0F Found Lucky resource: ${luckyResource.name} (${luckyResource.current}/${luckyResource.max})`);\r\n  } else {\r\n    debug.log('\uD83C\uDF96\uFE0F No Lucky resource found in character data');\r\n  }\r\n\r\n  return luckyResource;\r\n}\r\n\r\nfunction useLuckyPoint() {\r\n  debug.log('\uD83C\uDF96\uFE0F useLuckyPoint called');\r\n  const luckyResource = getLuckyResource();\r\n  debug.log('\uD83C\uDF96\uFE0F Lucky resource found:', luckyResource);\r\n  \r\n  if (!luckyResource) {\r\n    debug.error('\u274C No Lucky resource found');\r\n    return false;\r\n  }\r\n  \r\n  if (luckyResource.current <= 0) {\r\n    debug.error(`\u274C No Lucky points available (current: ${luckyResource.current})`);\r\n    return false;\r\n  }\r\n\r\n  // Decrement Lucky points\r\n  const oldCurrent = luckyResource.current;\r\n  luckyResource.current--;\r\n  debug.log(`\uD83C\uDF96\uFE0F Used Lucky point. ${oldCurrent} \u2192 ${luckyResource.current}/${luckyResource.max}`);\r\n  \r\n  // Save character data to preserve state when switching characters\r\n  saveCharacterData();\r\n  \r\n  // Update display (resources section won't show Lucky anymore)\r\n  buildResourcesDisplay();\r\n  \r\n  // Update Lucky button text\r\n  updateLuckyButtonText();\r\n  \r\n  debug.log('\uD83C\uDF96\uFE0F Lucky button updated and character data saved');\r\n  \r\n  return true;\r\n}\r\n\r\nfunction updateLuckyButtonText() {\r\n  const luckyButton = document.querySelector('#lucky-action-button');\r\n  if (luckyButton) {\r\n    const luckyResource = getLuckyResource();\r\n    const luckPointsAvailable = luckyResource ? luckyResource.current : 0;\r\n    luckyButton.innerHTML = `\r\n      <span style=\"font-size: 16px;\">\uD83C\uDF96\uFE0F</span>\r\n      <span>Use Lucky Point (${luckPointsAvailable}/3)</span>\r\n    `;\r\n    debug.log(`\uD83C\uDF96\uFE0F Lucky button updated to show ${luckPointsAvailable}/3`);\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// WINDOW SIZE PERSISTENCE\r\n// ============================================================================\r\n\r\n/**\r\n * Save current window dimensions to storage\r\n */\r\nfunction saveWindowSize() {\r\n  const width = window.outerWidth;\r\n  const height = window.outerHeight;\r\n  \r\n  browserAPI.storage.local.set({\r\n    popupWindowSize: { width, height }\r\n  });\r\n  \r\n  debug.log(`\uD83D\uDCBE Saved window size: ${width}x${height}`);\r\n}\r\n\r\n/**\r\n * Load and apply saved window dimensions\r\n */\r\nasync function loadWindowSize() {\r\n  try {\r\n    const result = await browserAPI.storage.local.get(['popupWindowSize']);\r\n    if (result.popupWindowSize) {\r\n      const { width, height } = result.popupWindowSize;\r\n      window.resizeTo(width, height);\r\n      debug.log(`\uD83D\uDCD0 Restored window size: ${width}x${height}`);\r\n    }\r\n  } catch (error) {\r\n    debug.warn('\u26A0\uFE0F Could not restore window size:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Initialize window size tracking\r\n */\r\nfunction initWindowSizeTracking() {\r\n  // Load saved size on startup\r\n  loadWindowSize();\r\n  \r\n  // Save size when window is resized\r\n  let resizeTimeout;\r\n  window.addEventListener('resize', () => {\r\n    clearTimeout(resizeTimeout);\r\n    resizeTimeout = setTimeout(() => {\r\n      saveWindowSize();\r\n    }, 500); // Debounce to avoid excessive saves\r\n  });\r\n  \r\n  debug.log('\uD83D\uDCD0 Window size tracking initialized');\r\n}\r\n\r\n// Initialize window size tracking when DOM is ready\r\nif (domReady) {\r\n  initWindowSizeTracking();\r\n} else {\r\n  pendingOperations.push(initWindowSizeTracking);\r\n}\r\n\r\n// ============================================================================\r\n// CUSTOM ROLL MACROS\r\n// ============================================================================\r\n\r\nlet customMacros = [];\r\n\r\n/**\r\n * Load custom macros from storage\r\n */\r\nasync function loadCustomMacros() {\r\n  try {\r\n    const result = await browserAPI.storage.local.get(['customMacros']);\r\n    customMacros = result.customMacros || [];\r\n    debug.log(`\uD83C\uDFB2 Loaded ${customMacros.length} custom macros`);\r\n    updateMacrosDisplay();\r\n  } catch (error) {\r\n    debug.error('\u274C Failed to load custom macros:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Save all custom macros to storage\r\n */\r\nfunction saveAllCustomMacros() {\r\n  browserAPI.storage.local.set({ customMacros });\r\n  debug.log(`\uD83D\uDCBE Saved ${customMacros.length} custom macros`);\r\n}\r\n\r\n/**\r\n * Add a new custom macro\r\n */\r\nfunction addCustomMacro(name, formula, description = '') {\r\n  const macro = {\r\n    id: Date.now().toString(),\r\n    name,\r\n    formula,\r\n    description,\r\n    createdAt: Date.now()\r\n  };\r\n  \r\n  customMacros.push(macro);\r\n  saveAllCustomMacros();\r\n  updateMacrosDisplay();\r\n  \r\n  debug.log(`\u2705 Added custom macro: ${name} (${formula})`);\r\n  return macro;\r\n}\r\n\r\n/**\r\n * Delete a custom macro\r\n */\r\nfunction deleteCustomMacro(macroId) {\r\n  customMacros = customMacros.filter(m => m.id !== macroId);\r\n  saveAllCustomMacros();\r\n  updateMacrosDisplay();\r\n  debug.log(`\uD83D\uDDD1\uFE0F Deleted macro: ${macroId}`);\r\n}\r\n\r\n/**\r\n * Execute a custom macro (roll the formula)\r\n */\r\nfunction executeMacro(macro) {\r\n  debug.log(`\uD83C\uDFB2 Executing macro: ${macro.name} (${macro.formula})`);\r\n  \r\n  // Use the existing roll announcement system\r\n  announceAction(\r\n    macro.name,\r\n    macro.formula,\r\n    '',\r\n    macro.description || `Custom macro: ${macro.formula}`\r\n  );\r\n}\r\n\r\n/**\r\n * Update the macros display in the UI\r\n */\r\nfunction updateMacrosDisplay() {\r\n  const container = document.getElementById('custom-macros-container');\r\n  if (!container) return;\r\n  \r\n  if (customMacros.length === 0) {\r\n    container.innerHTML = '<p style=\"text-align: center; color: #888; padding: 15px;\">No custom macros yet. Click \"Add Macro\" to create one.</p>';\r\n    return;\r\n  }\r\n  \r\n  container.innerHTML = customMacros.map(macro => `\r\n    <div class=\"macro-item\" style=\"\r\n      background: var(--bg-secondary);\r\n      border: 2px solid var(--border-color);\r\n      border-radius: 8px;\r\n      padding: 12px;\r\n      margin-bottom: 10px;\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      transition: all 0.2s;\r\n    \">\r\n      <div style=\"flex: 1;\">\r\n        <div style=\"font-weight: bold; color: var(--text-primary); margin-bottom: 4px;\">\r\n          ${macro.name}\r\n        </div>\r\n        <div style=\"font-family: monospace; color: var(--accent-info); font-size: 0.9em; margin-bottom: 4px;\">\r\n          ${macro.formula}\r\n        </div>\r\n        ${macro.description ? `<div style=\"font-size: 0.85em; color: var(--text-secondary);\">${macro.description}</div>` : ''}\r\n      </div>\r\n      <div style=\"display: flex; gap: 8px;\">\r\n        <button class=\"macro-roll-btn\" data-macro-id=\"${macro.id}\" style=\"\r\n          background: var(--accent-primary);\r\n          color: white;\r\n          border: none;\r\n          padding: 8px 16px;\r\n          border-radius: 6px;\r\n          cursor: pointer;\r\n          font-weight: bold;\r\n          transition: all 0.2s;\r\n        \">\r\n          \uD83C\uDFB2 Roll\r\n        </button>\r\n        <button class=\"macro-delete-btn\" data-macro-id=\"${macro.id}\" style=\"\r\n          background: var(--accent-danger);\r\n          color: white;\r\n          border: none;\r\n          padding: 8px 12px;\r\n          border-radius: 6px;\r\n          cursor: pointer;\r\n          transition: all 0.2s;\r\n        \">\r\n          \uD83D\uDDD1\uFE0F\r\n        </button>\r\n      </div>\r\n    </div>\r\n  `).join('');\r\n  \r\n  // Add event listeners\r\n  container.querySelectorAll('.macro-roll-btn').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      const macroId = btn.dataset.macroId;\r\n      const macro = customMacros.find(m => m.id === macroId);\r\n      if (macro) executeMacro(macro);\r\n    });\r\n  });\r\n  \r\n  container.querySelectorAll('.macro-delete-btn').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      const macroId = btn.dataset.macroId;\r\n      const macro = customMacros.find(m => m.id === macroId);\r\n      if (macro && confirm(`Delete macro \"${macro.name}\"?`)) {\r\n        deleteCustomMacro(macroId);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Show settings modal with tabs\r\n */\r\nfunction showSettingsModal() {\r\n  // Remove existing modal if any\r\n  const existingModal = document.getElementById('settings-modal');\r\n  if (existingModal) {\r\n    document.body.removeChild(existingModal);\r\n  }\r\n  \r\n  const modal = document.createElement('div');\r\n  modal.id = 'settings-modal';\r\n  modal.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background: rgba(0, 0, 0, 0.7);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10000;\r\n  `;\r\n  \r\n  modal.innerHTML = `\r\n    <div style=\"\r\n      background: var(--bg-secondary);\r\n      border: 2px solid var(--border-color);\r\n      border-radius: 12px;\r\n      max-width: 700px;\r\n      width: 90%;\r\n      max-height: 80vh;\r\n      display: flex;\r\n      flex-direction: column;\r\n      overflow: hidden;\r\n      box-shadow: 0 4px 20px rgba(0,0,0,0.3);\r\n    \">\r\n      <!-- Header -->\r\n      <div style=\"\r\n        padding: 20px;\r\n        border-bottom: 2px solid var(--border-color);\r\n        display: flex;\r\n        justify-content: space-between;\r\n        align-items: center;\r\n      \">\r\n        <h3 style=\"margin: 0; color: var(--text-primary);\">\u2699\uFE0F Settings</h3>\r\n        <button id=\"settings-close-btn\" style=\"\r\n          background: var(--accent-danger);\r\n          color: white;\r\n          border: none;\r\n          padding: 6px 12px;\r\n          border-radius: 6px;\r\n          cursor: pointer;\r\n          font-weight: bold;\r\n        \">\u2715</button>\r\n      </div>\r\n      \r\n      <!-- Tabs -->\r\n      <div style=\"\r\n        display: flex;\r\n        border-bottom: 2px solid var(--border-color);\r\n        background: var(--bg-tertiary);\r\n      \">\r\n        <button class=\"settings-tab active\" data-tab=\"theme\" style=\"\r\n          flex: 1;\r\n          padding: 12px;\r\n          background: transparent;\r\n          border: none;\r\n          cursor: pointer;\r\n          font-weight: bold;\r\n          color: var(--text-secondary);\r\n          transition: all 0.2s;\r\n        \">\uD83C\uDFA8 Theme</button>\r\n        <button class=\"settings-tab\" data-tab=\"macros\" style=\"\r\n          flex: 1;\r\n          padding: 12px;\r\n          background: transparent;\r\n          border: none;\r\n          cursor: pointer;\r\n          font-weight: bold;\r\n          color: var(--text-secondary);\r\n          transition: all 0.2s;\r\n        \">\uD83C\uDFB2 Custom Macros</button>\r\n        <button class=\"settings-tab\" data-tab=\"gm\" style=\"\r\n          flex: 1;\r\n          padding: 12px;\r\n          background: transparent;\r\n          border: none;\r\n          cursor: pointer;\r\n          font-weight: bold;\r\n          color: var(--text-secondary);\r\n          transition: all 0.2s;\r\n        \">\uD83D\uDC51 GM Integration</button>\r\n      </div>\r\n      \r\n      <!-- Content -->\r\n      <div style=\"\r\n        flex: 1;\r\n        overflow-y: auto;\r\n        padding: 20px;\r\n      \">\r\n        <!-- Theme Tab -->\r\n        <div id=\"theme-tab-content\" class=\"settings-tab-content\">\r\n          <h4 style=\"margin: 0 0 15px 0; color: var(--text-primary);\">Choose Theme</h4>\r\n          <div style=\"display: flex; gap: 15px; margin-bottom: 20px;\">\r\n            <button class=\"theme-option\" data-theme=\"light\" style=\"\r\n              flex: 1;\r\n              padding: 20px;\r\n              background: var(--bg-primary);\r\n              border: 3px solid var(--border-color);\r\n              border-radius: 8px;\r\n              cursor: pointer;\r\n              transition: all 0.2s;\r\n              display: flex;\r\n              flex-direction: column;\r\n              align-items: center;\r\n              gap: 8px;\r\n            \">\r\n              <span style=\"font-size: 2em;\">\u2600\uFE0F</span>\r\n              <span style=\"font-weight: bold; color: var(--text-primary);\">Light</span>\r\n            </button>\r\n            <button class=\"theme-option\" data-theme=\"dark\" style=\"\r\n              flex: 1;\r\n              padding: 20px;\r\n              background: var(--bg-primary);\r\n              border: 3px solid var(--border-color);\r\n              border-radius: 8px;\r\n              cursor: pointer;\r\n              transition: all 0.2s;\r\n              display: flex;\r\n              flex-direction: column;\r\n              align-items: center;\r\n              gap: 8px;\r\n            \">\r\n              <span style=\"font-size: 2em;\">\uD83C\uDF19</span>\r\n              <span style=\"font-weight: bold; color: var(--text-primary);\">Dark</span>\r\n            </button>\r\n            <button class=\"theme-option active\" data-theme=\"system\" style=\"\r\n              flex: 1;\r\n              padding: 20px;\r\n              background: var(--bg-primary);\r\n              border: 3px solid var(--accent-primary);\r\n              border-radius: 8px;\r\n              cursor: pointer;\r\n              transition: all 0.2s;\r\n              display: flex;\r\n              flex-direction: column;\r\n              align-items: center;\r\n              gap: 8px;\r\n            \">\r\n              <span style=\"font-size: 2em;\">\uD83D\uDCBB</span>\r\n              <span style=\"font-weight: bold; color: var(--text-primary);\">System</span>\r\n            </button>\r\n          </div>\r\n          <p style=\"color: var(--text-secondary); font-size: 0.9em; margin: 0;\">\r\n            System theme automatically matches your operating system's appearance settings.\r\n          </p>\r\n        </div>\r\n        \r\n        <!-- Macros Tab -->\r\n        <div id=\"macros-tab-content\" class=\"settings-tab-content\" style=\"display: none;\">\r\n          <!-- Setting: Show gear buttons on spells -->\r\n          <div style=\"background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 15px;\">\r\n            <label style=\"display: flex; align-items: center; gap: 10px; cursor: pointer;\">\r\n              <input type=\"checkbox\" id=\"show-macro-buttons-setting\" style=\"width: 18px; height: 18px;\" ${showCustomMacroButtons ? 'checked' : ''}>\r\n              <span style=\"color: var(--text-primary); font-weight: bold;\">Show \u2699\uFE0F macro buttons on spells</span>\r\n            </label>\r\n            <p style=\"margin: 8px 0 0 28px; color: var(--text-secondary); font-size: 0.85em;\">\r\n              When enabled, shows a gear button on each spell to configure custom Roll20 macros.\r\n            </p>\r\n          </div>\r\n\r\n          <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;\">\r\n            <h4 style=\"margin: 0; color: var(--text-primary);\">Your Custom Macros</h4>\r\n            <button id=\"add-macro-btn-settings\" style=\"\r\n              padding: 8px 16px;\r\n              background: var(--accent-primary);\r\n              color: white;\r\n              border: none;\r\n              border-radius: 6px;\r\n              cursor: pointer;\r\n              font-weight: bold;\r\n            \">\u2795 Add Macro</button>\r\n          </div>\r\n          <div id=\"custom-macros-container-settings\"></div>\r\n        </div>\r\n        \r\n        <!-- GM Integration Tab -->\r\n        <div id=\"gm-tab-content\" class=\"settings-tab-content\" style=\"display: none;\">\r\n          <h4 style=\"margin: 0 0 15px 0; color: var(--text-primary);\">\uD83D\uDC51 GM Integration</h4>\r\n\r\n          <!-- DiceCloud Sync Section -->\r\n          <div id=\"dicecloud-sync-section\" style=\"background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px; display: none;\">\r\n            <h5 style=\"margin: 0 0 10px 0; color: var(--text-primary);\">\uD83D\uDD04 DiceCloud Sync</h5>\r\n            <p style=\"margin: 0 0 15px 0; color: var(--text-secondary); font-size: 0.9em;\">\r\n              Manually sync all character data to DiceCloud. This updates HP, spell slots, Channel Divinity, class resources, and all other tracked values.\r\n            </p>\r\n            <button id=\"manual-sync-btn\" style=\"\r\n              background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);\r\n              color: white;\r\n              border: none;\r\n              border-radius: 8px;\r\n              padding: 12px 24px;\r\n              font-size: 1em;\r\n              font-weight: bold;\r\n              cursor: pointer;\r\n              transition: all 0.3s ease;\r\n              box-shadow: 0 2px 4px rgba(0,0,0,0.2);\r\n              width: 100%;\r\n            \">\r\n              \uD83D\uDD04 Sync to DiceCloud Now\r\n            </button>\r\n            <div id=\"sync-status\" style=\"margin-top: 10px; padding: 8px; border-radius: 6px; font-size: 0.9em; display: none;\"></div>\r\n          </div>\r\n\r\n          <div style=\"background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px;\">\r\n            <h5 style=\"margin: 0 0 10px 0; color: var(--text-primary);\">Share Character with GM</h5>\r\n            <p style=\"margin: 0 0 15px 0; color: var(--text-secondary); font-size: 0.9em;\">\r\n              Share your complete character sheet with the Game Master. This sends all your character data including abilities, skills, actions, spells, and equipment.\r\n            </p>\r\n            <button id=\"show-to-gm-btn\" class=\"show-to-gm-btn\" style=\"\r\n              background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);\r\n              color: white;\r\n              border: none;\r\n              border-radius: 8px;\r\n              padding: 12px 24px;\r\n              font-size: 1em;\r\n              font-weight: bold;\r\n              cursor: pointer;\r\n              transition: all 0.3s ease;\r\n              box-shadow: 0 2px 4px rgba(0,0,0,0.2);\r\n              width: 100%;\r\n            \">\r\n              \uD83D\uDC51 Share Character with GM\r\n            </button>\r\n          </div>\r\n          \r\n          <div style=\"background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px;\">\r\n            <h5 style=\"margin: 0 0 10px 0; color: var(--text-primary);\">How It Works</h5>\r\n            <ul style=\"margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 0.9em;\">\r\n              <li>Click the button above to share your character</li>\r\n              <li>Your character data appears in the Roll20 chat</li>\r\n              <li>The GM receives your complete character sheet</li>\r\n              <li>GM can view your stats, actions, and spells</li>\r\n              <li>Helps GM track party composition and abilities</li>\r\n            </ul>\r\n          </div>\r\n          \r\n          <div style=\"background: var(--bg-tertiary); padding: 16px; border-radius: 8px;\">\r\n            <h5 style=\"margin: 0 0 10px 0; color: var(--text-primary);\">Privacy Note</h5>\r\n            <p style=\"margin: 0; color: var(--text-secondary); font-size: 0.9em;\">\r\n              Only share character data when requested by your GM. The shared data includes your complete character sheet for game management purposes.\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `;\r\n  \r\n  document.body.appendChild(modal);\r\n  \r\n  // Set up tab switching\r\n  modal.querySelectorAll('.settings-tab').forEach(tab => {\r\n    tab.addEventListener('click', () => {\r\n      const tabName = tab.dataset.tab;\r\n      \r\n      // Update tab buttons\r\n      modal.querySelectorAll('.settings-tab').forEach(t => {\r\n        t.classList.remove('active');\r\n        t.style.color = 'var(--text-secondary)';\r\n        t.style.background = 'transparent';\r\n      });\r\n      tab.classList.add('active');\r\n      tab.style.color = 'var(--text-primary)';\r\n      tab.style.background = 'var(--bg-secondary)';\r\n      \r\n      // Update content\r\n      modal.querySelectorAll('.settings-tab-content').forEach(content => {\r\n        content.style.display = 'none';\r\n      });\r\n      modal.querySelector(`#${tabName}-tab-content`).style.display = 'block';\r\n    });\r\n  });\r\n  \r\n  // Set up theme options\r\n  const currentTheme = ThemeManager.getCurrentTheme();\r\n  modal.querySelectorAll('.theme-option').forEach(option => {\r\n    if (option.dataset.theme === currentTheme) {\r\n      option.style.borderColor = 'var(--accent-primary)';\r\n      option.classList.add('active');\r\n    }\r\n    \r\n    option.addEventListener('click', () => {\r\n      const theme = option.dataset.theme;\r\n      ThemeManager.setTheme(theme);\r\n      \r\n      // Update active state\r\n      modal.querySelectorAll('.theme-option').forEach(opt => {\r\n        opt.style.borderColor = 'var(--border-color)';\r\n        opt.classList.remove('active');\r\n      });\r\n      option.style.borderColor = 'var(--accent-primary)';\r\n      option.classList.add('active');\r\n    });\r\n  });\r\n  \r\n  // Load macros into settings\r\n  updateMacrosDisplayInSettings();\r\n  \r\n  // Initialize Show to GM button in settings\r\n  initShowToGM();\r\n\r\n  // Initialize manual DiceCloud sync button (experimental builds only)\r\n  initManualSyncButton();\r\n\r\n  // Set up add macro button\r\n  modal.querySelector('#add-macro-btn-settings').addEventListener('click', () => {\r\n    showAddMacroModal();\r\n  });\r\n\r\n  // Set up show macro buttons checkbox\r\n  const macroButtonsCheckbox = modal.querySelector('#show-macro-buttons-setting');\r\n  if (macroButtonsCheckbox) {\r\n    macroButtonsCheckbox.addEventListener('change', (e) => {\r\n      showCustomMacroButtons = e.target.checked;\r\n      localStorage.setItem('showCustomMacroButtons', showCustomMacroButtons ? 'true' : 'false');\r\n      debug.log(`\u2699\uFE0F Custom macro buttons ${showCustomMacroButtons ? 'enabled' : 'disabled'}`);\r\n      // Rebuild spells to show/hide gear buttons\r\n      rebuildSpells();\r\n    });\r\n  }\r\n\r\n  // Close button\r\n  modal.querySelector('#settings-close-btn').addEventListener('click', () => {\r\n    document.body.removeChild(modal);\r\n  });\r\n  \r\n  // Close on background click\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      document.body.removeChild(modal);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Show add macro modal (simplified version for settings)\r\n */\r\nfunction showAddMacroModal() {\r\n  const modal = document.createElement('div');\r\n  modal.id = 'add-macro-modal';\r\n  modal.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background: rgba(0, 0, 0, 0.8);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10001;\r\n  `;\r\n  \r\n  modal.innerHTML = `\r\n    <div style=\"\r\n      background: var(--bg-secondary);\r\n      border: 2px solid var(--border-color);\r\n      border-radius: 12px;\r\n      padding: 24px;\r\n      max-width: 500px;\r\n      width: 90%;\r\n      box-shadow: 0 4px 20px rgba(0,0,0,0.3);\r\n    \">\r\n      <h3 style=\"margin: 0 0 20px 0; color: var(--text-primary);\">\uD83C\uDFB2 Add Custom Macro</h3>\r\n      \r\n      <div style=\"margin-bottom: 16px;\">\r\n        <label style=\"display: block; margin-bottom: 6px; font-weight: bold; color: var(--text-primary);\">\r\n          Macro Name\r\n        </label>\r\n        <input type=\"text\" id=\"macro-name-input\" placeholder=\"e.g., Sneak Attack\" style=\"\r\n          width: 100%;\r\n          padding: 10px;\r\n          border: 2px solid var(--border-color);\r\n          border-radius: 6px;\r\n          font-size: 14px;\r\n          background: var(--bg-primary);\r\n          color: var(--text-primary);\r\n        \">\r\n      </div>\r\n      \r\n      <div style=\"margin-bottom: 16px;\">\r\n        <label style=\"display: block; margin-bottom: 6px; font-weight: bold; color: var(--text-primary);\">\r\n          Roll Formula\r\n        </label>\r\n        <input type=\"text\" id=\"macro-formula-input\" placeholder=\"e.g., 3d6\" style=\"\r\n          width: 100%;\r\n          padding: 10px;\r\n          border: 2px solid var(--border-color);\r\n          border-radius: 6px;\r\n          font-size: 14px;\r\n          font-family: monospace;\r\n          background: var(--bg-primary);\r\n          color: var(--text-primary);\r\n        \">\r\n        <small style=\"color: var(--text-secondary); font-size: 0.85em;\">\r\n          Examples: 1d20+5, 2d6+3, 8d6, 1d20+dexterity.modifier\r\n        </small>\r\n      </div>\r\n      \r\n      <div style=\"margin-bottom: 20px;\">\r\n        <label style=\"display: block; margin-bottom: 6px; font-weight: bold; color: var(--text-primary);\">\r\n          Description (optional)\r\n        </label>\r\n        <input type=\"text\" id=\"macro-description-input\" placeholder=\"e.g., Extra damage on hit\" style=\"\r\n          width: 100%;\r\n          padding: 10px;\r\n          border: 2px solid var(--border-color);\r\n          border-radius: 6px;\r\n          font-size: 14px;\r\n          background: var(--bg-primary);\r\n          color: var(--text-primary);\r\n        \">\r\n      </div>\r\n      \r\n      <div style=\"display: flex; gap: 10px; justify-content: flex-end;\">\r\n        <button id=\"macro-cancel-btn\" style=\"\r\n          padding: 10px 20px;\r\n          background: var(--bg-tertiary);\r\n          color: var(--text-primary);\r\n          border: 2px solid var(--border-color);\r\n          border-radius: 6px;\r\n          cursor: pointer;\r\n          font-weight: bold;\r\n        \">\r\n          Cancel\r\n        </button>\r\n        <button id=\"macro-save-btn\" style=\"\r\n          padding: 10px 20px;\r\n          background: var(--accent-primary);\r\n          color: white;\r\n          border: none;\r\n          border-radius: 6px;\r\n          cursor: pointer;\r\n          font-weight: bold;\r\n        \">\r\n          Save Macro\r\n        </button>\r\n      </div>\r\n    </div>\r\n  `;\r\n  \r\n  document.body.appendChild(modal);\r\n  \r\n  document.getElementById('macro-name-input').focus();\r\n  \r\n  document.getElementById('macro-cancel-btn').addEventListener('click', () => {\r\n    document.body.removeChild(modal);\r\n  });\r\n  \r\n  document.getElementById('macro-save-btn').addEventListener('click', () => {\r\n    const name = document.getElementById('macro-name-input').value.trim();\r\n    const formula = document.getElementById('macro-formula-input').value.trim();\r\n    const description = document.getElementById('macro-description-input').value.trim();\r\n    \r\n    if (!name || !formula) {\r\n      alert('Please enter both a name and formula for the macro.');\r\n      return;\r\n    }\r\n    \r\n    addCustomMacro(name, formula, description);\r\n    document.body.removeChild(modal);\r\n    updateMacrosDisplayInSettings();\r\n  });\r\n  \r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      document.body.removeChild(modal);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Update macros display in settings modal\r\n */\r\nfunction updateMacrosDisplayInSettings() {\r\n  const container = document.getElementById('custom-macros-container-settings');\r\n  if (!container) return;\r\n  \r\n  if (customMacros.length === 0) {\r\n    container.innerHTML = '<p style=\"text-align: center; color: #888; padding: 15px;\">No custom macros yet. Click \"Add Macro\" to create one.</p>';\r\n    return;\r\n  }\r\n  \r\n  container.innerHTML = customMacros.map(macro => `\r\n    <div class=\"macro-item\" style=\"\r\n      background: var(--bg-primary);\r\n      border: 2px solid var(--border-color);\r\n      border-radius: 8px;\r\n      padding: 12px;\r\n      margin-bottom: 10px;\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      transition: all 0.2s;\r\n    \">\r\n      <div style=\"flex: 1;\">\r\n        <div style=\"font-weight: bold; color: var(--text-primary); margin-bottom: 4px;\">\r\n          ${macro.name}\r\n        </div>\r\n        <div style=\"font-family: monospace; color: var(--accent-info); font-size: 0.9em; margin-bottom: 4px;\">\r\n          ${macro.formula}\r\n        </div>\r\n        ${macro.description ? `<div style=\"font-size: 0.85em; color: var(--text-secondary);\">${macro.description}</div>` : ''}\r\n      </div>\r\n      <div style=\"display: flex; gap: 8px;\">\r\n        <button class=\"macro-roll-btn\" data-macro-id=\"${macro.id}\" style=\"\r\n          background: var(--accent-primary);\r\n          color: white;\r\n          border: none;\r\n          padding: 8px 16px;\r\n          border-radius: 6px;\r\n          cursor: pointer;\r\n          font-weight: bold;\r\n          transition: all 0.2s;\r\n        \">\r\n          \uD83C\uDFB2 Roll\r\n        </button>\r\n        <button class=\"macro-delete-btn\" data-macro-id=\"${macro.id}\" style=\"\r\n          background: var(--accent-danger);\r\n          color: white;\r\n          border: none;\r\n          padding: 8px 12px;\r\n          border-radius: 6px;\r\n          cursor: pointer;\r\n          transition: all 0.2s;\r\n        \">\r\n          \uD83D\uDDD1\uFE0F\r\n        </button>\r\n      </div>\r\n    </div>\r\n  `).join('');\r\n  \r\n  container.querySelectorAll('.macro-roll-btn').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      const macroId = btn.dataset.macroId;\r\n      const macro = customMacros.find(m => m.id === macroId);\r\n      if (macro) {\r\n        executeMacro(macro);\r\n        // Close settings modal after rolling\r\n        const settingsModal = document.getElementById('settings-modal');\r\n        if (settingsModal) {\r\n          document.body.removeChild(settingsModal);\r\n        }\r\n      }\r\n    });\r\n  });\r\n  \r\n  container.querySelectorAll('.macro-delete-btn').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n      const macroId = btn.dataset.macroId;\r\n      const macro = customMacros.find(m => m.id === macroId);\r\n      if (macro && confirm(`Delete macro \"${macro.name}\"?`)) {\r\n        deleteCustomMacro(macroId);\r\n        updateMacrosDisplayInSettings();\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Initialize custom macros system\r\n */\r\nfunction initCustomMacros() {\r\n  loadCustomMacros();\r\n\r\n  // Load custom macro button setting (default: disabled)\r\n  const savedSetting = localStorage.getItem('showCustomMacroButtons');\r\n  showCustomMacroButtons = savedSetting === 'true';\r\n  debug.log(`\u2699\uFE0F Custom macro buttons setting: ${showCustomMacroButtons ? 'enabled' : 'disabled'}`);\r\n\r\n  debug.log('\uD83C\uDFB2 Custom macros system initialized');\r\n}\r\n\r\n/**\r\n * Initialize settings button\r\n */\r\nfunction initSettingsButton() {\r\n  const settingsBtn = document.getElementById('settings-btn');\r\n  if (settingsBtn) {\r\n    settingsBtn.addEventListener('click', showSettingsModal);\r\n    debug.log('\u2699\uFE0F Settings button initialized');\r\n  }\r\n}\r\n\r\n// Check if opened from GM panel and request character data\r\nif (window.opener && !characterData) {\r\n  // Request character data from parent window\r\n  window.opener.postMessage({ action: 'requestCharacterData' }, '*');\r\n  debug.log('\uD83D\uDCCB Requested character data from parent window');\r\n}\r\n\r\n// Initialize macros when DOM is ready\r\nif (domReady) {\r\n  initCustomMacros();\r\n  initSettingsButton();\r\n} else {\r\n  pendingOperations.push(initCustomMacros);\r\n  pendingOperations.push(initSettingsButton);\r\n}\r\n"],
  "mappings": "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",
  "names": ["result", "browserAPI", "result", "debug", "ThemeManager", "result", "condition", "roll", "formula", "current", "i", "customMacros", "spell", "skipNormalButtons", "part", "parts", "fullMatch", "argsString", "args", "expression", "conditionResult", "varValue", "trimmed", "num", "func", "arg", "varVal", "varPattern", "funcName", "match", "resolvedFormula", "name", "modifiedFormula", "effectNotes", "formulaWithAdvantage"]
}
