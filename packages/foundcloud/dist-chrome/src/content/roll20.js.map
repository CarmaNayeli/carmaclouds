{
  "version": 3,
  "sources": ["../../../../core/src/common/browser-polyfill.js", "../../../src/lib/meteor-ddp-client.js", "../../../src/lib/dicecloud-sync.js", "../../../src/content/roll20.js"],
  "sourcesContent": ["/**\r\n * Browser API Compatibility Layer - Chrome & Firefox Support\r\n *\r\n * This provides a consistent browserAPI interface across Chrome and Firefox.\r\n * Firefox uses the 'browser' namespace (Promise-based), while Chrome uses 'chrome' (callback-based).\r\n */\r\n\r\nconsole.log('\uD83C\uDF10 Loading browser polyfill...');\r\n\r\n// Use 'self' for service workers, 'window' for content scripts/popups\r\nconst globalScope = typeof window !== 'undefined' ? window : self;\r\n\r\n// Detect browser and use appropriate API\r\nlet browserAPI;\r\n\r\nif (typeof browser !== 'undefined' && browser.runtime) {\r\n  // Firefox - uses native Promise-based API\r\n  console.log('\uD83E\uDD8A Detected Firefox');\r\n  browserAPI = browser;\r\n} else if (typeof chrome !== 'undefined' && chrome.runtime) {\r\n  // Chrome - wrap callback-based API to be consistent with Firefox\r\n  console.log('\uD83C\uDF10 Detected Chrome');\r\n  // Helper to check if Chrome extension context is valid\r\n  const isChromeContextValid = () => {\r\n    try {\r\n      return chrome && chrome.runtime && chrome.runtime.id;\r\n    } catch (error) {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  browserAPI = {\r\n    runtime: {\r\n      sendMessage: (message, callback) => {\r\n        // If callback is provided, use callback-based API\r\n        if (typeof callback === 'function') {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              console.error('\u274C Extension context invalidated');\r\n              callback(null);\r\n              return;\r\n            }\r\n            chrome.runtime.sendMessage(message, callback);\r\n          } catch (error) {\r\n            // Handle \"Extension context invalidated\" error in Chrome\r\n            console.error('\u274C Extension context error:', error.message);\r\n            callback(null);\r\n          }\r\n          return;\r\n        }\r\n        // Otherwise return a Promise\r\n        return new Promise((resolve, reject) => {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              reject(new Error('Extension context invalidated'));\r\n              return;\r\n            }\r\n            chrome.runtime.sendMessage(message, (response) => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n              } else {\r\n                resolve(response);\r\n              }\r\n            });\r\n          } catch (error) {\r\n            // Handle \"Extension context invalidated\" error in Chrome\r\n            console.error('\u274C Extension context error:', error.message);\r\n            reject(error);\r\n          }\r\n        });\r\n      },\r\n      onMessage: chrome.runtime.onMessage,\r\n      getURL: (path) => {\r\n        try {\r\n          if (!isChromeContextValid()) return null;\r\n          return chrome.runtime.getURL(path);\r\n        } catch (error) {\r\n          console.error('\u274C Extension context error:', error.message);\r\n          return null;\r\n        }\r\n      },\r\n      getManifest: () => {\r\n        try {\r\n          if (!isChromeContextValid()) return null;\r\n          return chrome.runtime.getManifest();\r\n        } catch (error) {\r\n          console.error('\u274C Extension context error:', error.message);\r\n          return null;\r\n        }\r\n      },\r\n      get id() {\r\n        try {\r\n          if (!isChromeContextValid()) return null;\r\n          return chrome.runtime.id;\r\n        } catch (error) {\r\n          console.error('\u274C Extension context error:', error.message);\r\n          return null;\r\n        }\r\n      },\r\n      get lastError() {\r\n        try {\r\n          if (!isChromeContextValid()) return null;\r\n          return chrome.runtime.lastError;\r\n        } catch (error) {\r\n          return null;\r\n        }\r\n      },\r\n      connectNative: (application) => {\r\n        try {\r\n          if (!isChromeContextValid()) {\r\n            console.error('\u274C Extension context invalidated');\r\n            return null;\r\n          }\r\n          const port = chrome.runtime.connectNative(application);\r\n          // Check for immediate errors\r\n          if (chrome.runtime.lastError) {\r\n            console.warn('\u26A0\uFE0F Native messaging error:', chrome.runtime.lastError.message);\r\n            return null;\r\n          }\r\n          return port;\r\n        } catch (error) {\r\n          console.error('\u274C Native messaging error:', error.message);\r\n          return null;\r\n        }\r\n      }\r\n    },\r\n    storage: {\r\n      local: {\r\n        get: (keys) => {\r\n          return new Promise((resolve, reject) => {\r\n            try {\r\n              if (!isChromeContextValid()) {\r\n                reject(new Error('Extension context invalidated'));\r\n                return;\r\n              }\r\n              chrome.storage.local.get(keys, (result) => {\r\n                if (chrome.runtime.lastError) {\r\n                  reject(new Error(chrome.runtime.lastError.message));\r\n                } else {\r\n                  resolve(result);\r\n                }\r\n              });\r\n            } catch (error) {\r\n              reject(new Error('Extension context invalidated'));\r\n            }\r\n          });\r\n        },\r\n        set: (items) => {\r\n          return new Promise((resolve, reject) => {\r\n            try {\r\n              if (!isChromeContextValid()) {\r\n                reject(new Error('Extension context invalidated'));\r\n                return;\r\n              }\r\n              chrome.storage.local.set(items, () => {\r\n                if (chrome.runtime.lastError) {\r\n                  reject(new Error(chrome.runtime.lastError.message));\r\n                } else {\r\n                  resolve();\r\n                }\r\n              });\r\n            } catch (error) {\r\n              reject(new Error('Extension context invalidated'));\r\n            }\r\n          });\r\n        },\r\n        remove: (keys) => {\r\n          return new Promise((resolve, reject) => {\r\n            try {\r\n              if (!isChromeContextValid()) {\r\n                reject(new Error('Extension context invalidated'));\r\n                return;\r\n              }\r\n              chrome.storage.local.remove(keys, () => {\r\n                if (chrome.runtime.lastError) {\r\n                  reject(new Error(chrome.runtime.lastError.message));\r\n                } else {\r\n                  resolve();\r\n                }\r\n              });\r\n            } catch (error) {\r\n              reject(new Error('Extension context invalidated'));\r\n            }\r\n          });\r\n        },\r\n        clear: () => {\r\n          return new Promise((resolve, reject) => {\r\n            try {\r\n              if (!isChromeContextValid()) {\r\n                reject(new Error('Extension context invalidated'));\r\n                return;\r\n              }\r\n              chrome.storage.local.clear(() => {\r\n                if (chrome.runtime.lastError) {\r\n                  reject(new Error(chrome.runtime.lastError.message));\r\n                } else {\r\n                  resolve();\r\n                }\r\n              });\r\n            } catch (error) {\r\n              reject(new Error('Extension context invalidated'));\r\n            }\r\n          });\r\n        }\r\n      }\r\n    },\r\n    tabs: {\r\n      query: (queryInfo) => {\r\n        return new Promise((resolve, reject) => {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              reject(new Error('Extension context invalidated'));\r\n              return;\r\n            }\r\n            chrome.tabs.query(queryInfo, (tabs) => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n              } else {\r\n                resolve(tabs);\r\n              }\r\n            });\r\n          } catch (error) {\r\n            reject(new Error('Extension context invalidated'));\r\n          }\r\n        });\r\n      },\r\n      sendMessage: (tabId, message, callback) => {\r\n        // If callback is provided, use callback-based API\r\n        if (typeof callback === 'function') {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              console.error('\u274C Extension context invalidated');\r\n              callback(null);\r\n              return;\r\n            }\r\n            chrome.tabs.sendMessage(tabId, message, callback);\r\n          } catch (error) {\r\n            // Handle \"Extension context invalidated\" error in Chrome\r\n            console.error('\u274C Extension context error:', error.message);\r\n            callback(null);\r\n          }\r\n          return;\r\n        }\r\n        // Otherwise return a Promise\r\n        return new Promise((resolve, reject) => {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              reject(new Error('Extension context invalidated'));\r\n              return;\r\n            }\r\n            chrome.tabs.sendMessage(tabId, message, (response) => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n              } else {\r\n                resolve(response);\r\n              }\r\n            });\r\n          } catch (error) {\r\n            // Handle \"Extension context invalidated\" error in Chrome\r\n            console.error('\u274C Extension context error:', error.message);\r\n            reject(error);\r\n          }\r\n        });\r\n      },\r\n      create: (createProperties) => {\r\n        return new Promise((resolve, reject) => {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              reject(new Error('Extension context invalidated'));\r\n              return;\r\n            }\r\n            chrome.tabs.create(createProperties, (tab) => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n              } else {\r\n                resolve(tab);\r\n              }\r\n            });\r\n          } catch (error) {\r\n            reject(new Error('Extension context invalidated'));\r\n          }\r\n        });\r\n      },\r\n      update: (tabId, updateProperties) => {\r\n        return new Promise((resolve, reject) => {\r\n          try {\r\n            if (!isChromeContextValid()) {\r\n              reject(new Error('Extension context invalidated'));\r\n              return;\r\n            }\r\n            chrome.tabs.update(tabId, updateProperties, (tab) => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n              } else {\r\n                resolve(tab);\r\n              }\r\n            });\r\n          } catch (error) {\r\n            reject(new Error('Extension context invalidated'));\r\n          }\r\n        });\r\n      }\r\n    }\r\n  };\r\n} else {\r\n  console.error('\u274C FATAL: No browser API available!');\r\n  throw new Error('No browser API available');\r\n}\r\n\r\n// Expose as browserAPI for consistent naming\r\nglobalScope.browserAPI = browserAPI;\r\n\r\n// Verify API is available\r\nif (!globalScope.browserAPI || !globalScope.browserAPI.runtime) {\r\n  console.error('\u274C FATAL: Browser API not available!');\r\n  throw new Error('Browser API not available');\r\n}\r\n\r\nconsole.log('\u2705 Browser API ready:', (typeof browser !== 'undefined' && browserAPI === browser) ? 'Firefox' : 'Chrome');\r\n", "/**\r\n * Lightweight Meteor DDP Client for Browser Extensions\r\n *\r\n * Based on DDP protocol specification:\r\n * https://github.com/meteor/meteor/blob/devel/packages/ddp/DDP.md\r\n *\r\n * This client implements core DDP functionality:\r\n * - WebSocket connection with version negotiation\r\n * - Method calls (RPC)\r\n * - Authentication\r\n * - Heartbeat/ping-pong\r\n */\r\n\r\nclass MeteorDDPClient {\r\n  constructor(url) {\r\n    this.url = url;\r\n    this.ws = null;\r\n    this.sessionId = null;\r\n    this.connected = false;\r\n    this.nextId = 1;\r\n    this.pendingMethods = new Map(); // id -> { resolve, reject }\r\n    this.subscriptions = new Map(); // id -> { name, params, resolve, reject }\r\n    this.heartbeatInterval = null;\r\n    this.reconnectAttempts = 0;\r\n    this.maxReconnectAttempts = 5;\r\n\r\n    // Event handlers\r\n    this.onConnected = null;\r\n    this.onDisconnected = null;\r\n    this.onError = null;\r\n  }\r\n\r\n  /**\r\n   * Connect to DiceCloud Meteor server\r\n   */\r\n  async connect() {\r\n    return new Promise((resolve, reject) => {\r\n      // Use WebSocket directly (DiceCloud supports WebSockets)\r\n      const wsUrl = this.url.replace('https://', 'wss://').replace('http://', 'ws://');\r\n\r\n      console.log('[DDP] Connecting to:', wsUrl);\r\n\r\n      this.ws = new WebSocket(wsUrl);\r\n\r\n      this.ws.onopen = () => {\r\n        console.log('[DDP] WebSocket opened');\r\n        // Send connect message with DDP version negotiation\r\n        this.send({\r\n          msg: 'connect',\r\n          version: '1',\r\n          support: ['1', 'pre2', 'pre1']\r\n        });\r\n      };\r\n\r\n      this.ws.onmessage = (event) => {\r\n        try {\r\n          const message = JSON.parse(event.data);\r\n          this.handleMessage(message);\r\n\r\n          // Resolve connection promise when connected\r\n          if (message.msg === 'connected' && !this.connected) {\r\n            this.connected = true;\r\n            this.sessionId = message.session;\r\n            this.reconnectAttempts = 0;\r\n            this.startHeartbeat();\r\n            console.log('[DDP] Connected with session:', this.sessionId);\r\n            if (this.onConnected) this.onConnected();\r\n            resolve(this.sessionId);\r\n          }\r\n        } catch (error) {\r\n          console.error('[DDP] Failed to parse message:', error);\r\n          if (this.onError) this.onError(error);\r\n        }\r\n      };\r\n\r\n      this.ws.onerror = (error) => {\r\n        console.error('[DDP] WebSocket error:', error);\r\n        if (this.onError) this.onError(error);\r\n        reject(error);\r\n      };\r\n\r\n      this.ws.onclose = () => {\r\n        console.log('[DDP] WebSocket closed');\r\n        this.connected = false;\r\n        this.stopHeartbeat();\r\n        if (this.onDisconnected) this.onDisconnected();\r\n\r\n        // Attempt to reconnect\r\n        if (this.reconnectAttempts < this.maxReconnectAttempts) {\r\n          this.reconnectAttempts++;\r\n          const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);\r\n          console.log(`[DDP] Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts})`);\r\n          setTimeout(() => this.connect(), delay);\r\n        }\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Disconnect from server\r\n   */\r\n  disconnect() {\r\n    this.stopHeartbeat();\r\n    if (this.ws) {\r\n      this.ws.close();\r\n      this.ws = null;\r\n    }\r\n    this.connected = false;\r\n    this.sessionId = null;\r\n  }\r\n\r\n  /**\r\n   * Send a message to the server\r\n   */\r\n  send(message) {\r\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {\r\n      console.warn('[DDP] Cannot send message - WebSocket not open');\r\n      return false;\r\n    }\r\n\r\n    const json = JSON.stringify(message);\r\n    // Only log non-heartbeat messages to reduce console spam\r\n    if (message.msg !== 'ping' && message.msg !== 'pong') {\r\n      console.log('[DDP] Sending:', message.msg, message);\r\n    }\r\n    this.ws.send(json);\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Handle incoming messages from server\r\n   */\r\n  handleMessage(message) {\r\n    // Only log non-heartbeat messages to reduce console spam\r\n    if (message.msg !== 'ping' && message.msg !== 'pong') {\r\n      console.log('[DDP] Received:', message.msg, message);\r\n    }\r\n\r\n    switch (message.msg) {\r\n      case 'connected':\r\n        // Handled in onmessage\r\n        break;\r\n\r\n      case 'failed':\r\n        console.error('[DDP] Connection failed:', message);\r\n        break;\r\n\r\n      case 'ping':\r\n        // Respond to server heartbeat\r\n        this.send({ msg: 'pong', id: message.id });\r\n        break;\r\n\r\n      case 'pong':\r\n        // Server responded to our heartbeat\r\n        break;\r\n\r\n      case 'result':\r\n        // Method call result\r\n        this.handleMethodResult(message);\r\n        break;\r\n\r\n      case 'updated':\r\n        // Method writes have been reflected\r\n        console.log('[DDP] Methods updated:', message.methods);\r\n        break;\r\n\r\n      case 'ready':\r\n        // Subscription is ready\r\n        this.handleSubscriptionReady(message);\r\n        break;\r\n\r\n      case 'nosub':\r\n        // Subscription failed\r\n        this.handleSubscriptionError(message);\r\n        break;\r\n\r\n      case 'added':\r\n      case 'changed':\r\n      case 'removed':\r\n        // Collection updates (we don't need these for method calls)\r\n        break;\r\n\r\n      case 'error':\r\n        console.error('[DDP] Protocol error:', message);\r\n        break;\r\n\r\n      default:\r\n        console.warn('[DDP] Unknown message type:', message.msg);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle method call result\r\n   */\r\n  handleMethodResult(message) {\r\n    const { id, error, result } = message;\r\n    const pending = this.pendingMethods.get(id);\r\n\r\n    if (!pending) {\r\n      console.warn('[DDP] Received result for unknown method:', id);\r\n      return;\r\n    }\r\n\r\n    this.pendingMethods.delete(id);\r\n\r\n    if (error) {\r\n      console.error('[DDP] Method error:', error);\r\n      pending.reject(new Error(error.message || error.reason || 'Method call failed'));\r\n    } else {\r\n      console.log('[DDP] Method result:', result);\r\n      pending.resolve(result);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle subscription ready\r\n   */\r\n  handleSubscriptionReady(message) {\r\n    const { subs } = message;\r\n\r\n    for (const id of subs) {\r\n      const sub = this.subscriptions.get(id);\r\n      if (sub && sub.resolve) {\r\n        sub.resolve();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle subscription error\r\n   */\r\n  handleSubscriptionError(message) {\r\n    const { id, error } = message;\r\n    const sub = this.subscriptions.get(id);\r\n\r\n    if (sub && sub.reject) {\r\n      sub.reject(new Error(error?.message || 'Subscription failed'));\r\n    }\r\n\r\n    this.subscriptions.delete(id);\r\n  }\r\n\r\n  /**\r\n   * Call a Meteor method\r\n   */\r\n  async call(methodName, ...params) {\r\n    if (!this.connected) {\r\n      throw new Error('Not connected to server');\r\n    }\r\n\r\n    const id = String(this.nextId++);\r\n\r\n    return new Promise((resolve, reject) => {\r\n      this.pendingMethods.set(id, { resolve, reject });\r\n\r\n      this.send({\r\n        msg: 'method',\r\n        method: methodName,\r\n        params: params,\r\n        id: id\r\n      });\r\n\r\n      // Timeout after 30 seconds\r\n      setTimeout(() => {\r\n        if (this.pendingMethods.has(id)) {\r\n          this.pendingMethods.delete(id);\r\n          reject(new Error(`Method call timeout: ${methodName}`));\r\n        }\r\n      }, 30000);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Subscribe to a publication\r\n   */\r\n  async subscribe(name, ...params) {\r\n    if (!this.connected) {\r\n      throw new Error('Not connected to server');\r\n    }\r\n\r\n    const id = String(this.nextId++);\r\n\r\n    return new Promise((resolve, reject) => {\r\n      this.subscriptions.set(id, { name, params, resolve, reject });\r\n\r\n      this.send({\r\n        msg: 'sub',\r\n        id: id,\r\n        name: name,\r\n        params: params\r\n      });\r\n\r\n      // Timeout after 30 seconds\r\n      setTimeout(() => {\r\n        if (this.subscriptions.has(id)) {\r\n          const sub = this.subscriptions.get(id);\r\n          this.subscriptions.delete(id);\r\n          reject(new Error(`Subscription timeout: ${name}`));\r\n        }\r\n      }, 30000);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe from a publication\r\n   */\r\n  unsubscribe(subscriptionId) {\r\n    this.send({\r\n      msg: 'unsub',\r\n      id: subscriptionId\r\n    });\r\n    this.subscriptions.delete(subscriptionId);\r\n  }\r\n\r\n  /**\r\n   * Login with token (resume token from API)\r\n   */\r\n  async loginWithToken(token) {\r\n    try {\r\n      const result = await this.call('login', {\r\n        resume: token\r\n      });\r\n      console.log('[DDP] Logged in:', result);\r\n      return result;\r\n    } catch (error) {\r\n      console.error('[DDP] Login failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start heartbeat ping-pong\r\n   */\r\n  startHeartbeat() {\r\n    this.stopHeartbeat();\r\n\r\n    this.heartbeatInterval = setInterval(() => {\r\n      if (this.connected) {\r\n        const pingId = String(this.nextId++);\r\n        this.send({\r\n          msg: 'ping',\r\n          id: pingId\r\n        });\r\n      }\r\n    }, 25000); // Ping every 25 seconds\r\n  }\r\n\r\n  /**\r\n   * Stop heartbeat\r\n   */\r\n  stopHeartbeat() {\r\n    if (this.heartbeatInterval) {\r\n      clearInterval(this.heartbeatInterval);\r\n      this.heartbeatInterval = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get connection status\r\n   */\r\n  isConnected() {\r\n    return this.connected && this.ws && this.ws.readyState === WebSocket.OPEN;\r\n  }\r\n}\r\n\r\n// Export for browser extension\r\nif (typeof window !== 'undefined') {\r\n  window.DDPClient = MeteorDDPClient;\r\n}\r\n\r\n// ES6 export for bundlers\r\nexport default MeteorDDPClient;\r\n", "/**\r\n * DiceCloud Two-Way Sync Module\r\n *\r\n * Uses Meteor DDP to synchronize tracking values (uses, resources, HP, etc.)\r\n * back to DiceCloud character sheets.\r\n *\r\n * Based on DiceCloud's Meteor methods found in:\r\n * /app/imports/api/creature/creatureProperties/methods/\r\n */\r\n\r\nclass DiceCloudSync {\r\n  constructor(ddpClient) {\r\n    this.ddp = ddpClient;\r\n    this.characterId = null;\r\n    this.propertyCache = new Map(); // propertyName -> property _id\r\n    this.previousValues = new Map(); // propertyName -> last synced value\r\n    this.enabled = false;\r\n\r\n    // Request queue to prevent spamming DDP\r\n    this.requestQueue = [];\r\n    this.isProcessingQueue = false;\r\n    this.minRequestDelay = 250; // Minimum delay between requests (ms)\r\n    this.lastRequestTime = 0;\r\n    this.maxRetries = 3; // Maximum retries for failed requests\r\n\r\n    // Property variants map: canonical name -> array of all possible variable names\r\n    // This allows us to find properties regardless of which naming convention DiceCloud uses\r\n    this.propertyVariants = {\r\n      'Channel Divinity': ['channelDivinity', 'channelDivinityCleric', 'channelDivinityPaladin'],\r\n      'Ki Points': ['kiPoints', 'ki', 'kiPoint'],\r\n      'Sorcery Points': ['sorceryPoints', 'sorceryPoint', 'sorceryPt'],\r\n      'Bardic Inspiration': ['bardicInspiration', 'bardic', 'inspiration'],\r\n      'Superiority Dice': ['superiorityDice', 'superiority'],\r\n      'Lay on Hands': ['layOnHands', 'layOnHandsPool'],\r\n      'Wild Shape': ['wildShape', 'wildShapeUses'],\r\n      'Rage': ['rage', 'rageUses', 'rages'],\r\n      'Action Surge': ['actionSurge', 'actionSurgeUses'],\r\n      'Indomitable': ['indomitable', 'indomitableUses'],\r\n      'Second Wind': ['secondWind', 'secondWindUses'],\r\n      'Sneak Attack': ['sneakAttack', 'sneakAttackDice'],\r\n      'Cunning Action': ['cunningAction'],\r\n      'Arcane Recovery': ['arcaneRecovery', 'arcaneRecoveryUses'],\r\n      'Song of Rest': ['songOfRest'],\r\n      'Font of Magic': ['fontOfMagic'],\r\n      'Metamagic': ['metamagic'],\r\n      'Warlock Spell Slots': ['warlockSpellSlots', 'pactMagicSlots'],\r\n      'Pact Magic': ['pactMagic', 'pactMagicSlots'],\r\n      'Divine Sense': ['divineSense', 'divineSenseUses'],\r\n      'Divine Smite': ['divineSmite'],\r\n      'Aura of Protection': ['auraOfProtection'],\r\n      'Cleansing Touch': ['cleansingTouch', 'cleansingTouchUses'],\r\n      'Harness Divine Power': ['harnessDivinePower'],\r\n      'Wild Companion': ['wildCompanion', 'wildCompanionUses'],\r\n      'Natural Recovery': ['naturalRecovery'],\r\n      'Beast Spells': ['beastSpells'],\r\n      'Favored Foe': ['favoredFoe', 'favoredFoeUses'],\r\n      'Deft Explorer': ['deftExplorer'],\r\n      'Primal Awareness': ['primalAwareness'],\r\n      'Eldritch Invocations': ['eldritchInvocations'],\r\n      'Pact Boon': ['pactBoon'],\r\n      'Mystic Arcanum': ['mysticArcanum'],\r\n      'Eldritch Master': ['eldritchMaster'],\r\n      'Signature Spells': ['signatureSpells'],\r\n      'Spell Mastery': ['spellMastery'],\r\n      'Heroic Inspiration': ['heroicInspiration', 'inspiration'],\r\n      'Temporary Hit Points': ['temporaryHitPoints', 'tempHitPoints', 'tempHP'],\r\n      'Hit Points': ['hitPoints', 'hp', 'health'],\r\n      'Death Saves - Success': ['deathSaveSuccesses', 'succeededSaves', 'deathSaves.successes'],\r\n      'Death Saves - Failure': ['deathSaveFails', 'failedSaves', 'deathSaves.failures']\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Add a request to the queue\r\n   * @param {Function} requestFn - Async function that makes the DDP call\r\n   * @param {string} description - Description for logging\r\n   * @returns {Promise} - Resolves when request completes\r\n   */\r\n  async queueRequest(requestFn, description = 'DDP Request') {\r\n    return new Promise((resolve, reject) => {\r\n      const queueItem = {\r\n        requestFn,\r\n        description,\r\n        resolve,\r\n        reject,\r\n        retries: 0,\r\n        timestamp: Date.now()\r\n      };\r\n\r\n      this.requestQueue.push(queueItem);\r\n      console.log(`[DiceCloud Sync] Queued: ${description} (Queue size: ${this.requestQueue.length})`);\r\n\r\n      // Start processing if not already running\r\n      if (!this.isProcessingQueue) {\r\n        this.processQueue();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Process the request queue sequentially\r\n   */\r\n  async processQueue() {\r\n    if (this.isProcessingQueue) {\r\n      return;\r\n    }\r\n\r\n    this.isProcessingQueue = true;\r\n\r\n    while (this.requestQueue.length > 0) {\r\n      const item = this.requestQueue[0]; // Peek at first item\r\n\r\n      try {\r\n        // Rate limiting: ensure minimum delay between requests\r\n        const timeSinceLastRequest = Date.now() - this.lastRequestTime;\r\n        if (timeSinceLastRequest < this.minRequestDelay) {\r\n          const delayNeeded = this.minRequestDelay - timeSinceLastRequest;\r\n          console.log(`[DiceCloud Sync] Rate limiting: waiting ${delayNeeded}ms before next request`);\r\n          await this.sleep(delayNeeded);\r\n        }\r\n\r\n        console.log(`[DiceCloud Sync] Processing: ${item.description} (${this.requestQueue.length} remaining)`);\r\n\r\n        // Execute the request\r\n        this.lastRequestTime = Date.now();\r\n        const result = await item.requestFn();\r\n\r\n        // Success - remove from queue and resolve\r\n        this.requestQueue.shift();\r\n        item.resolve(result);\r\n\r\n        console.log(`[DiceCloud Sync] Completed: ${item.description}`);\r\n\r\n      } catch (error) {\r\n        console.error(`[DiceCloud Sync] Error: ${item.description}`, error);\r\n\r\n        // Check if it's a rate limit error\r\n        const isTooManyRequests =\r\n          error.message?.includes('too many requests') ||\r\n          error.message?.includes('rate limit') ||\r\n          error.error === 'too-many-requests' ||\r\n          error.error === 429;\r\n\r\n        if (isTooManyRequests && item.retries < this.maxRetries) {\r\n          // Retry with exponential backoff\r\n          item.retries++;\r\n          const backoffDelay = Math.min(1000 * Math.pow(2, item.retries), 10000); // Max 10s\r\n          console.warn(`[DiceCloud Sync] Rate limited. Retry ${item.retries}/${this.maxRetries} after ${backoffDelay}ms`);\r\n\r\n          await this.sleep(backoffDelay);\r\n          // Don't remove from queue - will retry on next iteration\r\n        } else {\r\n          // Max retries reached or different error - remove and reject\r\n          this.requestQueue.shift();\r\n          item.reject(error);\r\n\r\n          if (isTooManyRequests) {\r\n            console.error(`[DiceCloud Sync] Max retries reached for: ${item.description}`);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    this.isProcessingQueue = false;\r\n    console.log('[DiceCloud Sync] Queue processing complete');\r\n  }\r\n\r\n  /**\r\n   * Sleep utility\r\n   * @param {number} ms - Milliseconds to sleep\r\n   */\r\n  sleep(ms) {\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n  }\r\n\r\n  /**\r\n   * Initialize sync for a character\r\n   * @param {string} characterId - DiceCloud character ID\r\n   */\r\n  async initialize(characterId) {\r\n    this.characterId = characterId;\r\n    this.propertyCache.clear();\r\n\r\n    // Subscribe to character data to get property IDs\r\n    // This allows us to cache property _id values for faster updates\r\n    console.log('[DiceCloud Sync] Initializing for character:', characterId);\r\n    console.log('[DiceCloud Sync] DDP client status:', this.ddp.isConnected());\r\n\r\n    try {\r\n      // Connect to DDP if not already connected\r\n      if (!this.ddp.isConnected()) {\r\n        console.log('[DiceCloud Sync] Connecting to DDP...');\r\n        await this.ddp.connect();\r\n        console.log('[DiceCloud Sync] DDP connected successfully');\r\n      }\r\n\r\n      // Note: We'll need to fetch the full character data to build our cache\r\n      // The DiceCloud API GET /creature/:id returns all properties\r\n      await this.buildPropertyCache();\r\n\r\n      // Check user preference for auto backwards sync\r\n      const result = await browserAPI.storage.local.get(['autoBackwardsSync']);\r\n      const autoBackwardsSync = result.autoBackwardsSync !== false; // Default to true\r\n      this.enabled = autoBackwardsSync;\r\n\r\n      console.log('[DiceCloud Sync] Initialized successfully');\r\n      console.log('[DiceCloud Sync] Auto backwards sync preference:', autoBackwardsSync);\r\n      console.log('[DiceCloud Sync] Sync enabled:', this.enabled);\r\n    } catch (error) {\r\n      console.error('[DiceCloud Sync] Initialization failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Map all variant names to a single property ID\r\n   * @param {string} canonicalName - The canonical property name\r\n   * @param {string} foundVariableName - The variable name that was actually found in DiceCloud\r\n   * @param {string} propertyId - The property _id from DiceCloud\r\n   */\r\n  cachePropertyWithVariants(canonicalName, foundVariableName, propertyId) {\r\n    // Cache the canonical name\r\n    this.propertyCache.set(canonicalName, propertyId);\r\n\r\n    // Cache ALL possible variants for this property\r\n    const variants = this.propertyVariants[canonicalName];\r\n    if (variants) {\r\n      for (const variant of variants) {\r\n        this.propertyCache.set(variant, propertyId);\r\n      }\r\n      console.log(`[DiceCloud Sync] \uD83D\uDDFA\uFE0F  Mapped ${canonicalName} (found as \"${foundVariableName}\") to ${propertyId}`);\r\n      console.log(`[DiceCloud Sync]     All variants cached: ${variants.join(', ')}`);\r\n    } else {\r\n      // No variants defined, just cache the canonical name\r\n      console.log(`[DiceCloud Sync] Cached property: ${canonicalName} -> ${propertyId}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find a property in the raw API data by checking all possible variant names\r\n   * @param {Array} properties - Array of properties from DiceCloud API\r\n   * @param {string} canonicalName - The canonical property name to search for\r\n   * @param {Object} filter - Optional filter criteria (type, attributeType, etc.)\r\n   * @returns {Object|null} The found property or null\r\n   */\r\n  findPropertyByVariants(properties, canonicalName, filter = {}) {\r\n    const variants = this.propertyVariants[canonicalName];\r\n    if (!variants) {\r\n      // No variants defined, just search by canonical name\r\n      return properties.find(p => {\r\n        if (p.removed || p.inactive) return false;\r\n        if (p.name !== canonicalName && p.variableName !== canonicalName) return false;\r\n\r\n        // Apply additional filters\r\n        for (const [key, value] of Object.entries(filter)) {\r\n          if (p[key] !== value) return false;\r\n        }\r\n        return true;\r\n      });\r\n    }\r\n\r\n    // Search for any variant\r\n    for (const variant of variants) {\r\n      const property = properties.find(p => {\r\n        if (p.removed || p.inactive) return false;\r\n        if (p.variableName !== variant && p.name !== variant) return false;\r\n\r\n        // Apply additional filters\r\n        for (const [key, value] of Object.entries(filter)) {\r\n          if (p[key] !== value) return false;\r\n        }\r\n        return true;\r\n      });\r\n\r\n      if (property) {\r\n        console.log(`[DiceCloud Sync] \uD83D\uDD0D Found ${canonicalName} using variant \"${variant}\" (variableName: ${property.variableName})`);\r\n        return property;\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Build cache of property names to IDs\r\n   */\r\n  async buildPropertyCache() {\r\n    console.log('[DiceCloud Sync] Building property cache...');\r\n\r\n    // First, try to get the stored character data\r\n    const result = await browserAPI.storage.local.get(['activeCharacterId', 'characterProfiles']);\r\n    const { activeCharacterId, characterProfiles } = result;\r\n    console.log('[DiceCloud Sync] Storage result:', { activeCharacterId, characterProfilesKeys: characterProfiles ? Object.keys(characterProfiles) : null });\r\n\r\n    if (activeCharacterId && characterProfiles && characterProfiles[activeCharacterId]) {\r\n      const characterData = characterProfiles[activeCharacterId];\r\n      console.log('[DiceCloud Sync] Building cache from character data:', characterData.name);\r\n\r\n      // CRITICAL: Verify this character has DiceCloud data before proceeding\r\n      if (!characterData.id) {\r\n        console.warn('[DiceCloud Sync] Character data has no DiceCloud ID, skipping cache build');\r\n        console.warn('[DiceCloud Sync] This is likely the default/placeholder character');\r\n        return;\r\n      }\r\n\r\n      // Object to store current values extracted from API for initialization\r\n      // Declared here so it's in scope for initializePreviousValues call later\r\n      const currentValuesFromAPI = {};\r\n\r\n      // Get the DiceCloud API token for fetching raw data\r\n      const tokenResult = await browserAPI.storage.local.get(['diceCloudToken']);\r\n      const { diceCloudToken } = tokenResult;\r\n\r\n      if (diceCloudToken && characterData.id) {\r\n        console.log('[DiceCloud Sync] Fetching raw DiceCloud API data for property cache...');\r\n\r\n        try {\r\n          // Route API request through background script to avoid CORS\r\n          const response = await browserAPI.runtime.sendMessage({\r\n            action: 'fetchDiceCloudAPI',\r\n            url: `https://dicecloud.com/api/creature/${characterData.id}`,\r\n            token: diceCloudToken\r\n          });\r\n\r\n          if (response.success && response.data) {\r\n            const apiData = response.data;\r\n            console.log('[DiceCloud Sync] Received API data for property cache');\r\n            \r\n            // Build cache from raw creatureProperties\r\n            if (apiData.creatureProperties && Array.isArray(apiData.creatureProperties)) {\r\n              console.log(`[DiceCloud Sync] Processing ${apiData.creatureProperties.length} raw properties`);\r\n              \r\n              // First pass: collect all properties\r\n              const allProperties = {};\r\n              for (const property of apiData.creatureProperties) {\r\n                if (property._id && property.name) {\r\n                  if (!allProperties[property.name]) {\r\n                    allProperties[property.name] = [];\r\n                  }\r\n                  allProperties[property.name].push(property);\r\n                }\r\n              }\r\n              \r\n              /**\r\n               * Helper function to select the best property from duplicates\r\n               * Uses priority-based matching like we do for Hit Points\r\n               * @param {string} name - Property name\r\n               * @param {Array} properties - Array of properties with this name\r\n               * @param {object} criteria - Selection criteria\r\n               * @returns {object|null} - Best matching property\r\n               */\r\n              const selectBestProperty = (name, properties, criteria = {}) => {\r\n                if (properties.length === 1) return properties[0];\r\n\r\n                const {\r\n                  requiredType,\r\n                  requiredAttributeType,\r\n                  requiredFields = [],\r\n                  sortBy = null,\r\n                  debug = false\r\n                } = criteria;\r\n\r\n                if (debug) {\r\n                  console.log(`[DiceCloud Sync] All ${name} properties found:`);\r\n                  properties.forEach(p => {\r\n                    console.log(`  - ${p.name} (${p.type}): id=${p._id}, value=${p.value}, baseValue=${p.baseValue}, total=${p.total}, damage=${p.damage}, attributeType=${p.attributeType || 'none'}`);\r\n                  });\r\n                }\r\n\r\n                // Priority 1: Exact type + attributeType + has all required fields\r\n                if (requiredType && requiredAttributeType && requiredFields.length > 0) {\r\n                  const exactMatches = properties.filter(p =>\r\n                    p.type === requiredType &&\r\n                    p.attributeType === requiredAttributeType &&\r\n                    requiredFields.every(field => p[field] !== undefined) &&\r\n                    !p.removed &&\r\n                    !p.inactive\r\n                  );\r\n                  if (exactMatches.length > 0) {\r\n                    return sortBy ? exactMatches.sort(sortBy)[0] : exactMatches[0];\r\n                  }\r\n                }\r\n\r\n                // Priority 2: Exact type + attributeType\r\n                if (requiredType && requiredAttributeType) {\r\n                  const typeMatches = properties.filter(p =>\r\n                    p.type === requiredType &&\r\n                    p.attributeType === requiredAttributeType &&\r\n                    !p.removed &&\r\n                    !p.inactive\r\n                  );\r\n                  if (typeMatches.length > 0) {\r\n                    return sortBy ? typeMatches.sort(sortBy)[0] : typeMatches[0];\r\n                  }\r\n                }\r\n\r\n                // Priority 3: Just type match\r\n                if (requiredType) {\r\n                  const typeOnly = properties.filter(p =>\r\n                    p.type === requiredType &&\r\n                    !p.removed &&\r\n                    !p.inactive\r\n                  );\r\n                  if (typeOnly.length > 0) {\r\n                    return sortBy ? typeOnly.sort(sortBy)[0] : typeOnly[0];\r\n                  }\r\n                }\r\n\r\n                // Priority 4: Any property with required fields\r\n                if (requiredFields.length > 0) {\r\n                  const withFields = properties.filter(p =>\r\n                    requiredFields.every(field => p[field] !== undefined) &&\r\n                    !p.removed &&\r\n                    !p.inactive\r\n                  );\r\n                  if (withFields.length > 0) {\r\n                    return sortBy ? withFields.sort(sortBy)[0] : withFields[0];\r\n                  }\r\n                }\r\n\r\n                // Fallback: First non-removed, non-inactive property\r\n                const active = properties.find(p => !p.removed && !p.inactive);\r\n                return active || properties[0];\r\n              };\r\n\r\n              // Second pass: cache the best property for each name\r\n              for (const [propertyName, properties] of Object.entries(allProperties)) {\r\n                let selectedProperty = properties[0]; // default to first\r\n\r\n                // Handle Hit Points - find the healthBar that tracks current HP\r\n                if (propertyName === 'Hit Points') {\r\n                  selectedProperty = selectBestProperty('Hit Points', properties, {\r\n                    requiredType: 'attribute',\r\n                    requiredAttributeType: 'healthBar',\r\n                    requiredFields: ['damage'],\r\n                    sortBy: (a, b) => (b.total || 0) - (a.total || 0),\r\n                    debug: true\r\n                  });\r\n\r\n                  if (selectedProperty) {\r\n                    this.propertyCache.set('Hit Points', selectedProperty._id);\r\n                    console.log(`[DiceCloud Sync] Selected Hit Points property: ${selectedProperty.name} -> ${selectedProperty._id} (type: ${selectedProperty.type}, attributeType: ${selectedProperty.attributeType || 'none'}, value: ${selectedProperty.value}, total: ${selectedProperty.total}, baseValue: ${selectedProperty.baseValue}, damage: ${selectedProperty.damage})`);\r\n\r\n                    // Extract current HP value for initialization\r\n                    // Current HP = total - damage\r\n                    const currentHP = (selectedProperty.total || 0) - (selectedProperty.damage || 0);\r\n                    currentValuesFromAPI['Hit Points'] = currentHP;\r\n                    console.log(`[DiceCloud Sync] \uD83D\uDCCA Extracted current HP value: ${currentHP} (total: ${selectedProperty.total}, damage: ${selectedProperty.damage})`);\r\n                  } else {\r\n                    console.log(`[DiceCloud Sync] No suitable Hit Points property found`);\r\n                  }\r\n                  continue;\r\n                }\r\n                \r\n                // Cache class-specific HP as the main \"Hit Points\" if no main HP was found\r\n                // BUT: Don't cache Temporary Hit Points - only class-specific ones like \"Hit Points: Monk\"\r\n                if (propertyName.includes('Hit Points') &&\r\n                    propertyName !== 'Hit Points' &&\r\n                    !propertyName.includes('Temporary')) {\r\n                  const classHP = properties.find(p =>\r\n                    p.type !== 'skill' &&\r\n                    (p.value !== undefined || p.skillValue !== undefined)\r\n                  );\r\n\r\n                  if (classHP) {\r\n                    this.propertyCache.set('Hit Points', classHP._id);\r\n                    console.log(`[DiceCloud Sync] Cached class-specific HP as main Hit Points: ${propertyName} -> ${classHP._id} (type: ${classHP.type})`);\r\n                  }\r\n                  continue;\r\n                }\r\n\r\n                // Cache spell slots (1st Level, 2nd Level, etc.)\r\n                const spellSlotMatch = propertyName.match(/^(\\d+(?:st|nd|rd|th)) Level$/);\r\n                if (spellSlotMatch) {\r\n                  selectedProperty = selectBestProperty(propertyName, properties, {\r\n                    requiredType: 'attribute',\r\n                    requiredAttributeType: 'spellSlot',\r\n                    requiredFields: ['value'],\r\n                    debug: properties.length > 1\r\n                  });\r\n\r\n                  if (selectedProperty) {\r\n                    // Cache with both the full name and a short key\r\n                    this.propertyCache.set(propertyName, selectedProperty._id);\r\n                    const slotLevel = spellSlotMatch[1].replace(/\\D/g, '');\r\n                    this.propertyCache.set(`spellSlot${slotLevel}`, selectedProperty._id);\r\n                    console.log(`[DiceCloud Sync] Cached spell slot: ${propertyName} -> ${selectedProperty._id} (attributeType: ${selectedProperty.attributeType})`);\r\n\r\n                    // Extract current spell slot value for initialization\r\n                    const currentSlots = selectedProperty.value || 0;\r\n                    currentValuesFromAPI[`spellSlot${slotLevel}`] = currentSlots;\r\n                    console.log(`[DiceCloud Sync] \uD83D\uDCCA Extracted current spell slot value for level ${slotLevel}: ${currentSlots}`);\r\n                  }\r\n                  continue;\r\n                }\r\n\r\n                // Cache Channel Divinity\r\n                if (propertyName === 'Channel Divinity') {\r\n                  selectedProperty = selectBestProperty('Channel Divinity', properties, {\r\n                    requiredType: 'attribute',\r\n                    requiredAttributeType: 'resource',\r\n                    requiredFields: ['damage'],\r\n                    debug: properties.length > 1\r\n                  });\r\n\r\n                  if (selectedProperty) {\r\n                    this.propertyCache.set('Channel Divinity', selectedProperty._id);\r\n                    console.log(`[DiceCloud Sync] Cached Channel Divinity: ${selectedProperty._id} (attributeType: ${selectedProperty.attributeType})`);\r\n\r\n                    const currentCD = selectedProperty.value || 0;\r\n                    currentValuesFromAPI['Channel Divinity'] = currentCD;\r\n                    console.log(`[DiceCloud Sync] \uD83D\uDCCA Extracted current Channel Divinity value: ${currentCD}`);\r\n                  }\r\n                  continue;\r\n                }\r\n\r\n                // Cache all other properties normally\r\n                this.propertyCache.set(propertyName, selectedProperty._id);\r\n                console.log(`[DiceCloud Sync] Cached property: ${propertyName} -> ${selectedProperty._id}`);\r\n              }\r\n\r\n            // Note: Removed a closing brace that was here at line 521\r\n            // It was ending the apiData.creatureProperties if block too early,\r\n            // causing allProperties to go out of scope. The block continues below.\r\n\r\n            // Cache actions with limited uses from the raw API data\r\n            // Group by name first, then use comprehensive matching\r\n            const actionsByName = {};\r\n            apiData.creatureProperties.forEach(p => {\r\n              if (p.type === 'action' &&\r\n                  p.name &&\r\n                  p.uses !== undefined &&\r\n                  p.uses !== null &&\r\n                  !p.removed &&\r\n                  !p.inactive &&\r\n                  !this.propertyCache.has(p.name)) {\r\n                if (!actionsByName[p.name]) {\r\n                  actionsByName[p.name] = [];\r\n                }\r\n                actionsByName[p.name].push(p);\r\n              }\r\n            });\r\n\r\n            let actionCount = 0;\r\n            for (const [actionName, actions] of Object.entries(actionsByName)) {\r\n              const action = selectBestProperty(actionName, actions, {\r\n                requiredType: 'action',\r\n                requiredFields: ['uses'],\r\n                debug: actions.length > 1\r\n              });\r\n              if (action) {\r\n                this.propertyCache.set(action.name, action._id);\r\n                const maxUses = action.uses?.value ?? action.uses;\r\n                const usedUses = action.usesUsed ?? 0;\r\n                console.log(`[DiceCloud Sync] Cached action with uses: ${action.name} -> ${action._id} (${usedUses}/${maxUses} used)`);\r\n                actionCount++;\r\n              }\r\n            }\r\n            console.log(`[DiceCloud Sync] Found ${actionCount} actions with limited uses`);\r\n\r\n            // Cache Temporary Hit Points using comprehensive matching\r\n            if (allProperties['Temporary Hit Points']) {\r\n              const tempHP = selectBestProperty('Temporary Hit Points', allProperties['Temporary Hit Points'], {\r\n                requiredType: 'attribute',\r\n                requiredAttributeType: 'healthBar',\r\n                requiredFields: ['value'],\r\n                debug: allProperties['Temporary Hit Points'].length > 1\r\n              });\r\n              if (tempHP) {\r\n                this.propertyCache.set('Temporary Hit Points', tempHP._id);\r\n                console.log(`[DiceCloud Sync] Cached Temporary Hit Points: ${tempHP._id} (attributeType: ${tempHP.attributeType})`);\r\n\r\n                const currentTempHP = tempHP.value || 0;\r\n                currentValuesFromAPI['Temporary Hit Points'] = currentTempHP;\r\n                console.log(`[DiceCloud Sync] \uD83D\uDCCA Extracted current Temp HP value: ${currentTempHP}`);\r\n              }\r\n            }\r\n\r\n            // Cache Death Saves using comprehensive matching\r\n            ['Succeeded Saves', 'Failed Saves'].forEach(saveName => {\r\n              if (allProperties[saveName]) {\r\n                const deathSave = selectBestProperty(saveName, allProperties[saveName], {\r\n                  requiredType: 'attribute',\r\n                  requiredAttributeType: 'spellSlot',\r\n                  debug: allProperties[saveName].length > 1\r\n                });\r\n                if (deathSave) {\r\n                  this.propertyCache.set(saveName, deathSave._id);\r\n                  console.log(`[DiceCloud Sync] Cached Death Save: ${saveName} -> ${deathSave._id} (attributeType: ${deathSave.attributeType})`);\r\n                }\r\n              }\r\n            });\r\n\r\n            // Cache Hit Dice using comprehensive matching\r\n            ['d6 Hit Dice', 'd8 Hit Dice', 'd10 Hit Dice', 'd12 Hit Dice'].forEach(diceName => {\r\n              if (allProperties[diceName]) {\r\n                const hitDie = selectBestProperty(diceName, allProperties[diceName], {\r\n                  requiredType: 'attribute',\r\n                  requiredAttributeType: 'hitDice',\r\n                  debug: allProperties[diceName].length > 1\r\n                });\r\n                if (hitDie) {\r\n                  this.propertyCache.set(diceName, hitDie._id);\r\n                  console.log(`[DiceCloud Sync] Cached Hit Die: ${diceName} -> ${hitDie._id} (attributeType: ${hitDie.attributeType})`);\r\n                }\r\n              }\r\n            });\r\n\r\n            // Cache Heroic Inspiration using comprehensive matching\r\n            if (allProperties['Heroic Inspiration'] || allProperties['Inspiration']) {\r\n              const inspirationProps = allProperties['Heroic Inspiration'] || allProperties['Inspiration'];\r\n              const inspiration = selectBestProperty('Inspiration', inspirationProps, {\r\n                requiredType: 'attribute',\r\n                requiredAttributeType: 'resource',\r\n                debug: inspirationProps.length > 1\r\n              });\r\n              if (inspiration) {\r\n                this.propertyCache.set('Heroic Inspiration', inspiration._id);\r\n                this.propertyCache.set('Inspiration', inspiration._id);\r\n                console.log(`[DiceCloud Sync] Cached Inspiration: ${inspiration._id} (attributeType: ${inspiration.attributeType})`);\r\n              }\r\n            }\r\n\r\n            // Cache common class resources using comprehensive matching\r\n            const classResourceNames = [\r\n              'Ki Points', 'Sorcery Points', 'Bardic Inspiration', 'Superiority Dice',\r\n              'Lay on Hands', 'Wild Shape', 'Rage', 'Action Surge', 'Indomitable',\r\n              'Second Wind', 'Sneak Attack', 'Cunning Action', 'Arcane Recovery',\r\n              'Song of Rest', 'Font of Magic', 'Metamagic', 'Sorcery Point',\r\n              'Warlock Spell Slots', 'Pact Magic', 'Eldritch Invocations'\r\n            ];\r\n\r\n            let classResourceCount = 0;\r\n            for (const resourceName of classResourceNames) {\r\n              if (allProperties[resourceName] && !this.propertyCache.has(resourceName)) {\r\n                const resource = selectBestProperty(resourceName, allProperties[resourceName], {\r\n                  requiredType: 'attribute',\r\n                  requiredAttributeType: 'resource',\r\n                  requiredFields: ['damage'],\r\n                  debug: allProperties[resourceName].length > 1\r\n                });\r\n                if (resource) {\r\n                  this.propertyCache.set(resourceName, resource._id);\r\n                  console.log(`[DiceCloud Sync] Cached class resource: ${resourceName} -> ${resource._id} (attributeType: ${resource.attributeType})`);\r\n\r\n                  const currentValue = resource.value || 0;\r\n                  currentValuesFromAPI[resourceName] = currentValue;\r\n                  console.log(`[DiceCloud Sync] \uD83D\uDCCA Extracted current value for ${resourceName}: ${currentValue}`);\r\n                  classResourceCount++;\r\n                }\r\n              }\r\n            }\r\n            console.log(`[DiceCloud Sync] Found ${classResourceCount} class resources`);\r\n\r\n            // Cache any other attributes with reset fields (short/long rest resources)\r\n            // Group by name first, then use comprehensive matching\r\n            const restorableByName = {};\r\n            apiData.creatureProperties.forEach(p => {\r\n              if (p.type === 'attribute' &&\r\n                  p.name &&\r\n                  p.reset &&\r\n                  p.reset !== 'none' &&\r\n                  !p.removed &&\r\n                  !p.inactive &&\r\n                  !this.propertyCache.has(p.name)) {\r\n                if (!restorableByName[p.name]) {\r\n                  restorableByName[p.name] = [];\r\n                }\r\n                restorableByName[p.name].push(p);\r\n              }\r\n            });\r\n\r\n            let restorableCount = 0;\r\n            for (const [attrName, attrs] of Object.entries(restorableByName)) {\r\n              const attr = selectBestProperty(attrName, attrs, {\r\n                requiredType: 'attribute',\r\n                requiredFields: ['reset'],\r\n                debug: attrs.length > 1\r\n              });\r\n              if (attr) {\r\n                this.propertyCache.set(attr.name, attr._id);\r\n                console.log(`[DiceCloud Sync] Cached restorable attribute: ${attr.name} (resets on ${attr.reset}) -> ${attr._id}`);\r\n                restorableCount++;\r\n              }\r\n            }\r\n            console.log(`[DiceCloud Sync] Found ${restorableCount} additional restorable attributes`);\r\n\r\n            // IMPROVEMENT: Cache ALL remaining attributes (even without reset fields)\r\n            // This ensures custom resources and homebrew attributes sync properly\r\n            const customAttrsByName = {};\r\n            apiData.creatureProperties.forEach(p => {\r\n              if (p.type === 'attribute' &&\r\n                  p.name &&\r\n                  !p.removed &&\r\n                  !p.inactive &&\r\n                  !this.propertyCache.has(p.name) &&\r\n                  (p.value !== undefined || p.baseValue !== undefined)) {\r\n                if (!customAttrsByName[p.name]) {\r\n                  customAttrsByName[p.name] = [];\r\n                }\r\n                customAttrsByName[p.name].push(p);\r\n              }\r\n            });\r\n\r\n            let customAttrCount = 0;\r\n            for (const [attrName, attrs] of Object.entries(customAttrsByName)) {\r\n              const attr = selectBestProperty(attrName, attrs, {\r\n                requiredType: 'attribute',\r\n                requiredFields: ['value'],\r\n                debug: attrs.length > 1\r\n              });\r\n              if (attr) {\r\n                this.propertyCache.set(attr.name, attr._id);\r\n                console.log(`[DiceCloud Sync] Cached custom attribute: ${attr.name} -> ${attr._id} (value: ${attr.value}, baseValue: ${attr.baseValue})`);\r\n\r\n                // Extract current value for initialization\r\n                const currentValue = attr.value !== undefined ? attr.value : (attr.baseValue || 0);\r\n                currentValuesFromAPI[attr.name] = currentValue;\r\n                console.log(`[DiceCloud Sync] \uD83D\uDCCA Extracted current value for ${attr.name}: ${currentValue}`);\r\n                customAttrCount++;\r\n              }\r\n            }\r\n            console.log(`[DiceCloud Sync] Found ${customAttrCount} additional custom attributes to cache`);\r\n\r\n            // Cache important toggles (conditions, active features, etc.)\r\n            // Group by name first, then use comprehensive matching\r\n            const togglesByName = {};\r\n            apiData.creatureProperties.forEach(p => {\r\n              if (p.type === 'toggle' &&\r\n                  p.name &&\r\n                  !p.removed &&\r\n                  !p.inactive &&\r\n                  !this.propertyCache.has(p.name)) {\r\n                if (!togglesByName[p.name]) {\r\n                  togglesByName[p.name] = [];\r\n                }\r\n                togglesByName[p.name].push(p);\r\n              }\r\n            });\r\n\r\n            let toggleCount = 0;\r\n            for (const [toggleName, toggles] of Object.entries(togglesByName)) {\r\n              const toggle = selectBestProperty(toggleName, toggles, {\r\n                requiredType: 'toggle',\r\n                debug: toggles.length > 1\r\n              });\r\n              if (toggle) {\r\n                this.propertyCache.set(toggle.name, toggle._id);\r\n                console.log(`[DiceCloud Sync] Cached toggle: ${toggle.name} -> ${toggle._id}`);\r\n                toggleCount++;\r\n              }\r\n            }\r\n            console.log(`[DiceCloud Sync] Found ${toggleCount} toggles`);\r\n\r\n            // COMPREHENSIVE VARIANT MAPPING\r\n            // Search for all properties that match any variant name in our mapping\r\n            // This ensures we catch properties regardless of naming convention\r\n            console.log('[DiceCloud Sync] \uD83D\uDDFA\uFE0F  Starting comprehensive variant mapping...');\r\n\r\n            for (const [canonicalName, variants] of Object.entries(this.propertyVariants)) {\r\n              // Search for a property matching any variant\r\n              let foundProperty = null;\r\n              let foundVariant = null;\r\n\r\n              // Try each variant\r\n              for (const variant of variants) {\r\n                const property = apiData.creatureProperties.find(p => {\r\n                  if (p.removed || p.inactive) return false;\r\n\r\n                  // Check both name and variableName fields\r\n                  if (p.variableName === variant || p.name === variant) {\r\n                    // For resources and specific types, verify the type\r\n                    if (canonicalName === 'Channel Divinity' ||\r\n                        canonicalName === 'Ki Points' ||\r\n                        canonicalName === 'Sorcery Points' ||\r\n                        canonicalName === 'Bardic Inspiration') {\r\n                      // Must be attribute with resource type\r\n                      return p.type === 'attribute' && p.attributeType === 'resource';\r\n                    }\r\n\r\n                    if (canonicalName === 'Temporary Hit Points') {\r\n                      return p.type === 'attribute' && p.attributeType === 'healthBar';\r\n                    }\r\n\r\n                    if (canonicalName === 'Hit Points') {\r\n                      return p.type === 'attribute' && p.attributeType === 'healthBar';\r\n                    }\r\n\r\n                    // For other properties, just check it's an attribute\r\n                    return p.type === 'attribute' || p.type === 'action';\r\n                  }\r\n\r\n                  return false;\r\n                });\r\n\r\n                if (property) {\r\n                  foundProperty = property;\r\n                  foundVariant = variant;\r\n                  break;\r\n                }\r\n              }\r\n\r\n              // If we found a property, cache ALL variants to point to this ID\r\n              if (foundProperty) {\r\n                this.cachePropertyWithVariants(canonicalName, foundVariant, foundProperty._id);\r\n\r\n                // Extract current value for initialization\r\n                if (foundProperty.value !== undefined) {\r\n                  currentValuesFromAPI[canonicalName] = foundProperty.value;\r\n                  console.log(`[DiceCloud Sync] \uD83D\uDCCA Extracted current value for ${canonicalName}: ${foundProperty.value}`);\r\n                }\r\n              }\r\n            }\r\n\r\n            console.log('[DiceCloud Sync] \u2705 Comprehensive variant mapping complete');\r\n            } // Closes if (apiData.creatureProperties && Array.isArray(apiData.creatureProperties)) from line 330\r\n          } else {\r\n            console.warn('[DiceCloud Sync] Failed to fetch API data for property cache:', response.error);\r\n          }\r\n        } catch (error) {\r\n          console.error('[DiceCloud Sync] Error fetching API data for property cache:', error);\r\n        }\r\n      }\r\n      \r\n      // Also cache actions by name (fallback)\r\n      if (characterData.actions && Array.isArray(characterData.actions)) {\r\n        console.log(`[DiceCloud Sync] Processing ${characterData.actions.length} actions`);\r\n        for (const action of characterData.actions) {\r\n          if (action.name) {\r\n            // Check if we already have this property in cache\r\n            if (!this.propertyCache.has(action.name)) {\r\n              // Try to find matching property in cached properties by name\r\n              const propertyId = this.findPropertyId(action.name);\r\n              if (propertyId) {\r\n                this.propertyCache.set(action.name, propertyId);\r\n                console.log(`[DiceCloud Sync] Cached action: ${action.name} -> ${propertyId}`);\r\n              } else {\r\n                console.warn(`[DiceCloud Sync] No property ID found for action: ${action.name}`);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      console.log(`[DiceCloud Sync] Property cache built with ${this.propertyCache.size} entries`);\r\n      console.log('[DiceCloud Sync] Available properties:', Array.from(this.propertyCache.keys()));\r\n\r\n      // Initialize previousValues from current character data to avoid syncing everything on first update\r\n      console.log('[DiceCloud Sync] Initializing previousValues from current character data...');\r\n      await this.initializePreviousValues(characterData, currentValuesFromAPI);\r\n    } else {\r\n      console.warn('[DiceCloud Sync] No character data available for cache building');\r\n      console.warn('[DiceCloud Sync] activeCharacterId:', activeCharacterId);\r\n      console.warn('[DiceCloud Sync] characterProfiles:', characterProfiles);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize previousValues from character data to avoid syncing everything on first update\r\n   * @param {Object} characterData - Character data object\r\n   * @param {Object} apiValues - Current values extracted from DiceCloud API (optional)\r\n   */\r\n  async initializePreviousValues(characterData, apiValues = {}) {\r\n    console.log('[DiceCloud Sync] Populating previousValues to establish baseline...');\r\n\r\n    // HP values - prefer API values if available, otherwise use stored character data\r\n    if (apiValues['Hit Points'] !== undefined) {\r\n      this.previousValues.set('Hit Points', apiValues['Hit Points']);\r\n      console.log(`[DiceCloud Sync] \uD83D\uDCCA Initialized Hit Points from API: ${apiValues['Hit Points']}`);\r\n    } else if (characterData.hp !== undefined) {\r\n      this.previousValues.set('Hit Points', characterData.hp);\r\n    }\r\n\r\n    if (apiValues['Temporary Hit Points'] !== undefined) {\r\n      this.previousValues.set('Temporary Hit Points', apiValues['Temporary Hit Points']);\r\n      console.log(`[DiceCloud Sync] \uD83D\uDCCA Initialized Temp HP from API: ${apiValues['Temporary Hit Points']}`);\r\n    } else if (characterData.tempHp !== undefined) {\r\n      this.previousValues.set('Temporary Hit Points', characterData.tempHp);\r\n    }\r\n\r\n    if (characterData.maxHp !== undefined) {\r\n      this.previousValues.set('Max Hit Points', characterData.maxHp);\r\n    }\r\n\r\n    // Spell slots - use character data values (extension is source of truth)\r\n    // This ensures spell slots sync properly on first update if they differ from DiceCloud\r\n    for (let level = 1; level <= 9; level++) {\r\n      const cacheKey = `spellSlot${level}`;\r\n\r\n      if (characterData.spellSlots) {\r\n        const currentKey = `level${level}SpellSlots`;\r\n        const maxKey = `level${level}SpellSlotsMax`;\r\n\r\n        if (characterData.spellSlots[currentKey] !== undefined && characterData.spellSlots[maxKey] !== undefined) {\r\n          if (characterData.spellSlots[maxKey] > 0) {\r\n            this.previousValues.set(cacheKey, characterData.spellSlots[currentKey]);\r\n            console.log(`[DiceCloud Sync] \uD83D\uDCCA Initialized spell slot level ${level} from extension: ${characterData.spellSlots[currentKey]}`);\r\n          }\r\n        }\r\n      } else if (apiValues[cacheKey] !== undefined) {\r\n        // Fallback to API values only if character data doesn't have spell slots\r\n        this.previousValues.set(cacheKey, apiValues[cacheKey]);\r\n        console.log(`[DiceCloud Sync] \uD83D\uDCCA Initialized spell slot level ${level} from API (fallback): ${apiValues[cacheKey]}`);\r\n      }\r\n    }\r\n\r\n    // Channel Divinity - prefer API values if available\r\n    if (apiValues['Channel Divinity'] !== undefined) {\r\n      this.previousValues.set('Channel Divinity', apiValues['Channel Divinity']);\r\n      console.log(`[DiceCloud Sync] \uD83D\uDCCA Initialized Channel Divinity from API: ${apiValues['Channel Divinity']}`);\r\n    } else if (characterData.channelDivinity && characterData.channelDivinity.current !== undefined) {\r\n      this.previousValues.set('Channel Divinity', characterData.channelDivinity.current);\r\n    }\r\n\r\n    // Resources\r\n    if (characterData.resources && Array.isArray(characterData.resources)) {\r\n      for (const resource of characterData.resources) {\r\n        if (resource.name && resource.current !== undefined) {\r\n          this.previousValues.set(resource.name, resource.current);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Actions with uses\r\n    if (characterData.actions && Array.isArray(characterData.actions)) {\r\n      for (const action of characterData.actions) {\r\n        if (action.name && action.uses && action.usesUsed !== undefined) {\r\n          const cacheKey = `action_${action.name}`;\r\n          this.previousValues.set(cacheKey, action.usesUsed);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Death saves\r\n    if (characterData.deathSaves) {\r\n      if (characterData.deathSaves.successes !== undefined) {\r\n        this.previousValues.set('Succeeded Saves', characterData.deathSaves.successes);\r\n      }\r\n      if (characterData.deathSaves.failures !== undefined) {\r\n        this.previousValues.set('Failed Saves', characterData.deathSaves.failures);\r\n      }\r\n    }\r\n\r\n    // Inspiration\r\n    if (characterData.inspiration !== undefined) {\r\n      this.previousValues.set('Inspiration', characterData.inspiration);\r\n    }\r\n\r\n    // Initialize any remaining values from API that weren't explicitly handled above\r\n    // This catches class resources (Ki Points, Sorcery Points, etc.) and custom attributes\r\n    if (apiValues && Object.keys(apiValues).length > 0) {\r\n      for (const [key, value] of Object.entries(apiValues)) {\r\n        // Only set if not already set above\r\n        if (!this.previousValues.has(key)) {\r\n          this.previousValues.set(key, value);\r\n          console.log(`[DiceCloud Sync] \uD83D\uDCCA Initialized ${key} from API: ${value}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log(`[DiceCloud Sync] Initialized ${this.previousValues.size} previous values`);\r\n  }\r\n\r\n  /**\r\n   * Increment action uses (e.g., used 1 of 3 uses)\r\n   * @param {string} actionName - Name of the action\r\n   * @param {number} amount - Amount to increment (usually 1)\r\n   */\r\n  async incrementActionUses(actionName, amount = 1) {\r\n    if (!this.enabled) {\r\n      console.warn('[DiceCloud Sync] Sync not enabled');\r\n      return;\r\n    }\r\n\r\n    const propertyId = this.findPropertyId(actionName);\r\n    if (!propertyId) {\r\n      console.warn(`[DiceCloud Sync] Property not found: ${actionName}`);\r\n      return;\r\n    }\r\n\r\n    // Queue the request instead of calling directly\r\n    return this.queueRequest(\r\n      async () => {\r\n        console.log(`[DiceCloud Sync] Incrementing uses for ${actionName} (${propertyId}) by ${amount}`);\r\n\r\n        const result = await this.ddp.call('creatureProperties.update', {\r\n          _id: propertyId,\r\n          path: ['usesUsed'],\r\n          value: amount\r\n        });\r\n\r\n        console.log('[DiceCloud Sync] \u23F3 Increment request sent:', result);\r\n        return result;\r\n      },\r\n      `Increment ${actionName} uses`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Set action uses to a specific value\r\n   * @param {string} actionName - Name of the action\r\n   * @param {number} value - New value for usesUsed\r\n   */\r\n  async setActionUses(actionName, value) {\r\n    if (!this.enabled) {\r\n      console.warn('[DiceCloud Sync] Sync not enabled');\r\n      return;\r\n    }\r\n\r\n    const propertyId = this.findPropertyId(actionName);\r\n    if (!propertyId) {\r\n      console.warn(`[DiceCloud Sync] Property not found: ${actionName}`);\r\n      return;\r\n    }\r\n\r\n    // Queue the request instead of calling directly\r\n    return this.queueRequest(\r\n      async () => {\r\n        console.log(`[DiceCloud Sync] Setting uses for ${actionName} (${propertyId}) to ${value}`);\r\n\r\n        const result = await this.ddp.call('creatureProperties.update', {\r\n          _id: propertyId,\r\n          path: ['usesUsed'],\r\n          value: value\r\n        });\r\n\r\n        console.log('[DiceCloud Sync] \u23F3 Set uses request sent:', result);\r\n        return result;\r\n      },\r\n      `Set ${actionName} uses to ${value}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Update attribute value (HP, Ki Points, Sorcery Points, etc.)\r\n   * @param {string} attributeName - Name of the attribute\r\n   * @param {number} value - New value\r\n   */\r\n  async updateAttributeValue(attributeName, value) {\r\n    if (!this.enabled) {\r\n      console.warn('[DiceCloud Sync] Sync not enabled');\r\n      return;\r\n    }\r\n\r\n    const propertyId = this.findPropertyId(attributeName);\r\n    if (!propertyId) {\r\n      console.warn(`[DiceCloud Sync] Property not found: ${attributeName}`);\r\n      return;\r\n    }\r\n\r\n    console.log(`[DiceCloud Sync] Updating attribute ${attributeName} (${propertyId}) to ${value}`);\r\n\r\n    // Prepare the update - this runs BEFORE queueing\r\n    const updatePayload = {\r\n      _id: propertyId,\r\n      path: ['value'],  // Default, will be updated based on property type\r\n      value: value\r\n    };\r\n\r\n    // Check current value before update and determine correct field name\r\n    try {\r\n      const tokenResult = await browserAPI.storage.local.get(['diceCloudToken']);\r\n      const { diceCloudToken } = tokenResult;\r\n\r\n      if (diceCloudToken) {\r\n        // Use the character endpoint like the debug button does\r\n        const characterId = this.characterId;\r\n        const currentResponse = await browserAPI.runtime.sendMessage({\r\n          action: 'fetchDiceCloudAPI',\r\n          url: `https://dicecloud.com/api/creature/${characterId}`,\r\n          token: diceCloudToken\r\n        });\r\n\r\n        if (currentResponse.success && currentResponse.data) {\r\n          // Find the property in the full character data\r\n          const property = currentResponse.data.creatureProperties.find(p => p._id === propertyId);\r\n          if (property) {\r\n            console.log('[DiceCloud Sync] Property before update:', {\r\n              id: property._id,\r\n              name: property.name,\r\n              type: property.type,\r\n              attributeType: property.attributeType,\r\n              value: property.value,\r\n              baseValue: property.baseValue,\r\n              total: property.total,\r\n              damage: property.damage,\r\n              skillValue: property.skillValue,\r\n              dirty: property.dirty\r\n            });\r\n\r\n            // Determine the correct field name and value based on property type\r\n            let fieldName = 'value'; // default\r\n            let updateValue = value; // default to the passed value\r\n            let useHealthBarMethod = false; // Flag to use creatureProperties.damage method\r\n\r\n            if (property.type === 'skill') {\r\n              fieldName = 'skillValue';\r\n            } else if (property.type === 'effect') {\r\n              // For effects, check if there's a calculation or if it uses value\r\n              fieldName = property.calculation ? 'calculation' : 'value';\r\n            } else if (property.type === 'attribute' && property.attributeType === 'healthBar') {\r\n              // For healthBar attributes (like HP), we must use creatureProperties.damage method\r\n              // The damage field cannot be updated directly via creatureProperties.update\r\n              // Instead, use operation: 'set' with the new current HP value\r\n              console.log(`[DiceCloud Sync] HealthBar update: currentHP=${property.value}, newCurrentHP=${value}, total=${property.total}, currentDamage=${property.damage}`);\r\n              useHealthBarMethod = true;\r\n              updateValue = value; // Pass the new current HP value directly\r\n            } else if (property.type === 'attribute') {\r\n              // For other attributes, update the value directly\r\n              fieldName = 'value';\r\n            }\r\n            console.log(`[DiceCloud Sync] Using field name: ${fieldName} for property type: ${property.type}, attributeType: ${property.attributeType || 'none'}`);\r\n            console.log(`[DiceCloud Sync] Use healthBar method: ${useHealthBarMethod}`);\r\n\r\n            // Update the payload with the correct field name and value\r\n            if (useHealthBarMethod) {\r\n              // For healthBar, use different payload structure for creatureProperties.damage\r\n              updatePayload.operation = 'set';\r\n              updatePayload.value = updateValue;\r\n              delete updatePayload.path; // Remove path field, not used in damage method\r\n            } else {\r\n              updatePayload.path = [fieldName];\r\n              updatePayload.value = updateValue;\r\n            }\r\n          }\r\n        }\r\n      } else {\r\n        console.warn('[DiceCloud Sync] No DiceCloud token available for verification');\r\n      }\r\n    } catch (error) {\r\n      console.error('[DiceCloud Sync] Failed to get current property value:', error);\r\n    }\r\n\r\n    // Determine which DDP method to use based on property type\r\n    let methodName = 'creatureProperties.update';\r\n    if (updatePayload.operation === 'set' && !updatePayload.path) {\r\n      // For healthBar attributes, use the damage method\r\n      methodName = 'creatureProperties.damage';\r\n    }\r\n\r\n    console.log(`[DiceCloud Sync] Using DDP method: ${methodName}`);\r\n    console.log('[DiceCloud Sync] DDP update payload:', JSON.stringify(updatePayload, null, 2));\r\n\r\n    // Queue the actual DDP call\r\n    return this.queueRequest(\r\n      async () => {\r\n        const result = await this.ddp.call(methodName, updatePayload);\r\n\r\n        console.log(`[DiceCloud Sync] \u23F3 Update request sent using ${methodName}:`, result);\r\n        console.log('[DiceCloud Sync] Checking if update was applied...');\r\n\r\n        // Verify the update by checking the property again\r\n        setTimeout(async () => {\r\n          try {\r\n            const tokenResult = await browserAPI.storage.local.get(['diceCloudToken']);\r\n            const { diceCloudToken } = tokenResult;\r\n\r\n            if (diceCloudToken) {\r\n              console.log('[DiceCloud Sync] Verifying update for property:', propertyId);\r\n              console.log('[DiceCloud Sync] Character ID available:', this.characterId);\r\n\r\n              // Use the character endpoint like the debug button does\r\n              const characterId = this.characterId;\r\n              if (!characterId) {\r\n                console.error('[DiceCloud Sync] No character ID available for verification');\r\n                return;\r\n              }\r\n\r\n              const verifyResponse = await browserAPI.runtime.sendMessage({\r\n                action: 'fetchDiceCloudAPI',\r\n                url: `https://dicecloud.com/api/creature/${characterId}`,\r\n                token: diceCloudToken\r\n              });\r\n\r\n              console.log('[DiceCloud Sync] Verification API response:', verifyResponse);\r\n\r\n              if (verifyResponse.success && verifyResponse.data) {\r\n                console.log('[DiceCloud Sync] Verification API data received, looking for property:', propertyId);\r\n                console.log('[DiceCloud Sync] Total properties in response:', verifyResponse.data.creatureProperties?.length);\r\n\r\n                // Find the property in the full character data\r\n                const property = verifyResponse.data.creatureProperties.find(p => p._id === propertyId);\r\n                if (property) {\r\n                  console.log('[DiceCloud Sync] Property after update:', {\r\n                    id: property._id,\r\n                    name: property.name,\r\n                    type: property.type,\r\n                    attributeType: property.attributeType,\r\n                    value: property.value,\r\n                    total: property.total,\r\n                    baseValue: property.baseValue,\r\n                    damage: property.damage,\r\n                    dirty: property.dirty,\r\n                    lastUpdated: property.lastUpdated\r\n                  });\r\n\r\n                  // Check if the value actually changed\r\n                  if (property.value === value) {\r\n                    console.log('[DiceCloud Sync] \u2705 SUCCESS: Value updated correctly!');\r\n                  } else {\r\n                    console.warn('[DiceCloud Sync] \u274C ISSUE: Value did not change. Expected:', value, 'Actual:', property.value);\r\n                    if (property.total && property.damage !== undefined) {\r\n                      const calculatedValue = property.total - property.damage;\r\n                      console.log(`[DiceCloud Sync] Calculated value: ${property.total} - ${property.damage} = ${calculatedValue}`);\r\n                    }\r\n                  }\r\n                } else {\r\n                  console.warn('[DiceCloud Sync] Property not found in character data');\r\n                  console.log('[DiceCloud Sync] Available HP properties:', verifyResponse.data.creatureProperties\r\n                    .filter(p => p.name && p.name.toLowerCase().includes('hit points'))\r\n                    .map(p => ({ id: p._id, name: p.name, value: p.value }))\r\n                  );\r\n                }\r\n              } else {\r\n                console.error('[DiceCloud Sync] Failed to verify update:', verifyResponse.error);\r\n              }\r\n            } else {\r\n              console.warn('[DiceCloud Sync] No DiceCloud token available for verification');\r\n            }\r\n          } catch (error) {\r\n            console.error('[DiceCloud Sync] Failed to verify update:', error);\r\n          }\r\n        }, 1000);\r\n\r\n        return result;\r\n      },\r\n      `Update ${attributeName} to ${value}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Update spell slot current value\r\n   * @param {number} level - Spell level (1-9)\r\n   * @param {number} slotsRemaining - Number of slots remaining\r\n   */\r\n  async updateSpellSlot(level, slotsRemaining) {\r\n    if (!this.enabled) {\r\n      console.warn('[DiceCloud Sync] Sync not enabled');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Try both naming conventions\r\n      const slotKey = `spellSlot${level}`;\r\n      const slotName = `${level}${this.getOrdinalSuffix(level)} Level`;\r\n\r\n      let propertyId = this.findPropertyId(slotKey);\r\n      if (!propertyId) {\r\n        propertyId = this.findPropertyId(slotName);\r\n      }\r\n\r\n      if (!propertyId) {\r\n        console.warn(`[DiceCloud Sync] \u274C Spell slot level ${level} not found in property cache`);\r\n        console.warn(`[DiceCloud Sync] Tried keys: \"${slotKey}\", \"${slotName}\"`);\r\n\r\n        // Show spell slots that ARE cached\r\n        const spellSlotProps = Array.from(this.propertyCache.keys())\r\n          .filter(name => name.toLowerCase().includes('level') || name.toLowerCase().includes('spell'));\r\n        console.warn(`[DiceCloud Sync] Cached spell-related properties:`, spellSlotProps);\r\n\r\n        return;\r\n      }\r\n\r\n      console.log(`[DiceCloud Sync] Updating spell slot level ${level} to ${slotsRemaining} remaining`);\r\n\r\n      // First, let's debug what the spell slot property looks like\r\n      const debugTokenResult = await browserAPI.storage.local.get(['diceCloudToken']);\r\n      if (debugTokenResult.diceCloudToken && this.characterId) {\r\n        const debugResponse = await browserAPI.runtime.sendMessage({\r\n          action: 'fetchDiceCloudAPI',\r\n          url: `https://dicecloud.com/api/creature/${this.characterId}`,\r\n          token: debugTokenResult.diceCloudToken\r\n        });\r\n\r\n        if (debugResponse.success && debugResponse.data) {\r\n          const spellSlotProp = debugResponse.data.creatureProperties.find(p => p._id === propertyId);\r\n          if (spellSlotProp) {\r\n            // Log as JSON for easy reading (all fields auto-expanded)\r\n            console.log(`[DiceCloud Sync] \uD83D\uDD0D Spell slot property structure:\\n` +\r\n              JSON.stringify(spellSlotProp, null, 2));\r\n          }\r\n        }\r\n      }\r\n\r\n      const result = await this.queueRequest(\r\n        () => this.ddp.call('creatureProperties.update', {\r\n          _id: propertyId,\r\n          path: ['value'],\r\n          value: slotsRemaining\r\n        }),\r\n        `Update spell slot level ${level} to ${slotsRemaining}`\r\n      );\r\n\r\n      console.log(`[DiceCloud Sync] \u23F3 Spell slot level ${level} update request sent:`, result);\r\n      return result;\r\n    } catch (error) {\r\n      console.error(`[DiceCloud Sync] \u274C Failed to update spell slot level ${level}:`, error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetch character data from DiceCloud API\r\n   * @param {string} characterId - The character ID\r\n   * @returns {Promise<object>} The API response data\r\n   */\r\n  async fetchDiceCloudData(characterId) {\r\n    const tokenResult = await browserAPI.storage.local.get(['diceCloudToken']);\r\n    if (!tokenResult.diceCloudToken) {\r\n      throw new Error('No DiceCloud token found');\r\n    }\r\n\r\n    const response = await browserAPI.runtime.sendMessage({\r\n      action: 'fetchDiceCloudAPI',\r\n      url: `https://dicecloud.com/api/creature/${characterId}`,\r\n      token: tokenResult.diceCloudToken\r\n    });\r\n\r\n    if (!response.success) {\r\n      throw new Error('API request failed');\r\n    }\r\n\r\n    return response.data;\r\n  }\r\n\r\n  /**\r\n   * Update Channel Divinity uses\r\n   * @param {number} usesRemaining - Number of uses remaining\r\n   */\r\n  async updateChannelDivinity(usesRemaining) {\r\n    if (!this.enabled) {\r\n      console.warn('[DiceCloud Sync] Sync not enabled');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const propertyId = this.findPropertyId('Channel Divinity');\r\n      if (!propertyId) {\r\n        console.warn('[DiceCloud Sync] Channel Divinity not found');\r\n        return;\r\n      }\r\n\r\n      console.log(`[DiceCloud Sync] Updating Channel Divinity to ${usesRemaining} uses remaining`);\r\n\r\n      // Fetch the property to get its total\r\n      const apiData = await this.fetchDiceCloudData(this.characterId);\r\n      const property = apiData?.creatureProperties?.find(p => p._id === propertyId);\r\n\r\n      if (!property) {\r\n        console.error('[DiceCloud Sync] Could not find Channel Divinity property in API data');\r\n        return;\r\n      }\r\n\r\n      // Resources work like health bars: value = total - damage\r\n      // To set uses remaining, we use the damage method just like HP\r\n      const total = property.total || property.baseValue?.value || 3;\r\n\r\n      console.log(`[DiceCloud Sync] Resource calculation: total=${total}, usesRemaining=${usesRemaining}, damage=${property.damage || 0}`);\r\n      console.log(`[DiceCloud Sync] Channel Divinity before update:`, {\r\n        value: property.value,\r\n        damage: property.damage,\r\n        total: property.total\r\n      });\r\n\r\n      // Update the damage field using the damage method (same as HP sync)\r\n      // Resources work like health bars: we set the current value directly\r\n      const result = await this.queueRequest(\r\n        () => this.ddp.call('creatureProperties.damage', {\r\n          _id: propertyId,\r\n          value: usesRemaining,\r\n          operation: 'set'\r\n        }),\r\n        `Update Channel Divinity to ${usesRemaining}`\r\n      );\r\n\r\n      console.log('[DiceCloud Sync] \u23F3 Channel Divinity update request sent:', result);\r\n\r\n      // Verify the update was applied\r\n      if (this.characterId) {\r\n        console.log('[DiceCloud Sync] Verifying Channel Divinity update...');\r\n        try {\r\n          const verifyData = await this.fetchDiceCloudData(this.characterId);\r\n          if (verifyData && verifyData.creatureProperties) {\r\n            const verifiedProperty = verifyData.creatureProperties.find(p => p._id === propertyId);\r\n            if (verifiedProperty) {\r\n              const actualUsesRemaining = (verifiedProperty.total || total) - (verifiedProperty.damage || 0);\r\n              console.log(`[DiceCloud Sync] Channel Divinity after update:`, {\r\n                value: verifiedProperty.value,\r\n                damage: verifiedProperty.damage,\r\n                total: verifiedProperty.total,\r\n                calculatedUsesRemaining: actualUsesRemaining\r\n              });\r\n              if (actualUsesRemaining === usesRemaining || verifiedProperty.value === usesRemaining) {\r\n                console.log('[DiceCloud Sync] \u2705 SUCCESS: Channel Divinity updated correctly!');\r\n              } else {\r\n                console.warn(`[DiceCloud Sync] \u26A0\uFE0F WARNING: Channel Divinity value mismatch! Expected ${usesRemaining}, got ${actualUsesRemaining}`);\r\n              }\r\n            }\r\n          }\r\n        } catch (verifyError) {\r\n          console.warn('[DiceCloud Sync] Could not verify Channel Divinity update:', verifyError);\r\n        }\r\n      }\r\n\r\n      return result;\r\n    } catch (error) {\r\n      console.error('[DiceCloud Sync] Failed to update Channel Divinity:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update any generic resource by name\r\n   * @param {string} resourceName - Name of the resource (Ki Points, Sorcery Points, etc.)\r\n   * @param {number} value - New value\r\n   */\r\n  async updateResource(resourceName, value) {\r\n    if (!this.enabled) {\r\n      console.warn('[DiceCloud Sync] Sync not enabled');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const propertyId = this.findPropertyId(resourceName);\r\n      if (!propertyId) {\r\n        console.warn(`[DiceCloud Sync] \u274C Resource \"${resourceName}\" not found in property cache`);\r\n        console.warn(`[DiceCloud Sync] Available cached properties:`, Array.from(this.propertyCache.keys()).sort());\r\n\r\n        // Suggest similar property names (fuzzy matching)\r\n        const similarNames = Array.from(this.propertyCache.keys())\r\n          .filter(name => name.toLowerCase().includes(resourceName.toLowerCase()) ||\r\n                          resourceName.toLowerCase().includes(name.toLowerCase()))\r\n          .slice(0, 5);\r\n\r\n        if (similarNames.length > 0) {\r\n          console.warn(`[DiceCloud Sync] \uD83D\uDCA1 Did you mean one of these? ${similarNames.join(', ')}`);\r\n        }\r\n\r\n        return;\r\n      }\r\n\r\n      console.log(`[DiceCloud Sync] Updating ${resourceName} to ${value}`);\r\n\r\n      const result = await this.queueRequest(\r\n        () => this.ddp.call('creatureProperties.update', {\r\n          _id: propertyId,\r\n          path: ['value'],\r\n          value: value\r\n        }),\r\n        `Update ${resourceName} to ${value}`\r\n      );\r\n\r\n      console.log(`[DiceCloud Sync] \u23F3 ${resourceName} update request sent:`, result);\r\n      return result;\r\n    } catch (error) {\r\n      console.error(`[DiceCloud Sync] \u274C Failed to update ${resourceName}:`, error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update Temporary Hit Points\r\n   * @param {number} tempHP - Temporary HP value\r\n   */\r\n  async updateTemporaryHP(tempHP) {\r\n    return this.updateResource('Temporary Hit Points', tempHP);\r\n  }\r\n\r\n  /**\r\n   * Update Death Saves\r\n   * @param {number} succeeded - Number of succeeded death saves\r\n   * @param {number} failed - Number of failed death saves\r\n   */\r\n  async updateDeathSaves(succeeded, failed) {\r\n    const results = [];\r\n\r\n    if (succeeded !== undefined) {\r\n      results.push(await this.updateResource('Succeeded Saves', succeeded));\r\n    }\r\n\r\n    if (failed !== undefined) {\r\n      results.push(await this.updateResource('Failed Saves', failed));\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Update Hit Dice remaining\r\n   * @param {string} dieType - Die type ('d6', 'd8', 'd10', 'd12')\r\n   * @param {number} remaining - Number of hit dice remaining\r\n   */\r\n  async updateHitDice(dieType, remaining) {\r\n    const resourceName = `${dieType} Hit Dice`;\r\n    return this.updateResource(resourceName, remaining);\r\n  }\r\n\r\n  /**\r\n   * Update Inspiration/Heroic Inspiration\r\n   * @param {number} value - Inspiration value (typically 0 or 1)\r\n   */\r\n  async updateInspiration(value) {\r\n    return this.updateResource('Heroic Inspiration', value);\r\n  }\r\n\r\n  /**\r\n   * Update toggle state (conditions, active features, etc.)\r\n   * @param {string} toggleName - Name of the toggle\r\n   * @param {boolean} enabled - Whether the toggle is enabled\r\n   */\r\n  async updateToggle(toggleName, enabled) {\r\n    if (!this.enabled) {\r\n      console.warn('[DiceCloud Sync] Sync not enabled');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const propertyId = this.findPropertyId(toggleName);\r\n      if (!propertyId) {\r\n        console.warn(`[DiceCloud Sync] Toggle \"${toggleName}\" not found`);\r\n        return;\r\n      }\r\n\r\n      console.log(`[DiceCloud Sync] Setting toggle ${toggleName} to ${enabled ? 'enabled' : 'disabled'}`);\r\n\r\n      // Toggles use the 'enabled' field instead of 'value'\r\n      const result = await this.queueRequest(\r\n        () => this.ddp.call('creatureProperties.update', {\r\n          _id: propertyId,\r\n          path: ['enabled'],\r\n          value: enabled\r\n        }),\r\n        `Update toggle ${toggleName} to ${enabled ? 'enabled' : 'disabled'}`\r\n      );\r\n\r\n      console.log(`[DiceCloud Sync] \u23F3 Toggle ${toggleName} update request sent:`, result);\r\n      return result;\r\n    } catch (error) {\r\n      console.error(`[DiceCloud Sync] Failed to update toggle ${toggleName}:`, error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Helper to get ordinal suffix (1st, 2nd, 3rd, etc.)\r\n   */\r\n  getOrdinalSuffix(num) {\r\n    const j = num % 10;\r\n    const k = num % 100;\r\n    if (j === 1 && k !== 11) return 'st';\r\n    if (j === 2 && k !== 12) return 'nd';\r\n    if (j === 3 && k !== 13) return 'rd';\r\n    return 'th';\r\n  }\r\n\r\n  findPropertyId(attributeName) {\r\n    // Direct cache lookup (handles all mapped variants)\r\n    const propertyId = this.propertyCache.get(attributeName);\r\n    if (propertyId) {\r\n      console.log(`[DiceCloud Sync] \u2705 Found property ID for \"${attributeName}\": ${propertyId}`);\r\n      return propertyId;\r\n    }\r\n\r\n    // Try to find the canonical name for this attribute\r\n    // (in case the attribute name is a variant we haven't seen before)\r\n    for (const [canonicalName, variants] of Object.entries(this.propertyVariants)) {\r\n      if (variants.includes(attributeName) || canonicalName === attributeName) {\r\n        // Try to find the property by canonical name\r\n        const canonicalId = this.propertyCache.get(canonicalName);\r\n        if (canonicalId) {\r\n          console.log(`[DiceCloud Sync] \uD83D\uDD0D Found \"${attributeName}\" via canonical name \"${canonicalName}\": ${canonicalId}`);\r\n          // Cache this variant for future lookups\r\n          this.propertyCache.set(attributeName, canonicalId);\r\n          return canonicalId;\r\n        }\r\n\r\n        // Try each variant\r\n        for (const variant of variants) {\r\n          const variantId = this.propertyCache.get(variant);\r\n          if (variantId) {\r\n            console.log(`[DiceCloud Sync] \uD83D\uDD0D Found \"${attributeName}\" via variant \"${variant}\": ${variantId}`);\r\n            // Cache this variant for future lookups\r\n            this.propertyCache.set(attributeName, variantId);\r\n            return variantId;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Handle special cases for Hit Points (use class-specific HP instead of calculated base HP)\r\n    if (attributeName === 'Hit Points' || attributeName === 'hitPoints' || attributeName === 'hp') {\r\n      console.log('[DiceCloud Sync] Looking for Hit Points alternatives...');\r\n      const hpRelatedProps = Array.from(this.propertyCache.keys()).filter(name =>\r\n        name.toLowerCase().includes('hit points') ||\r\n        name.toLowerCase().includes('hp') ||\r\n        name.toLowerCase().includes('health')\r\n      );\r\n      console.log('[DiceCloud Sync] HP-related properties found:', hpRelatedProps);\r\n\r\n      // Try class-specific HP first (like \"Hit Points: Monk\")\r\n      const classSpecificHP = hpRelatedProps.find(name => name !== 'Hit Points' && name.includes('Hit Points'));\r\n      if (classSpecificHP) {\r\n        const classSpecificId = this.propertyCache.get(classSpecificHP);\r\n        console.log(`[DiceCloud Sync] Using class-specific HP: ${classSpecificHP} -> ${classSpecificId}`);\r\n        return classSpecificId;\r\n      }\r\n    }\r\n\r\n    // Handle special cases for Channel Divinity (search for class-specific variants)\r\n    if (attributeName === 'Channel Divinity' || attributeName === 'channelDivinity' ||\r\n        attributeName === 'channelDivinityCleric' || attributeName === 'channelDivinityPaladin') {\r\n      console.log('[DiceCloud Sync] Looking for Channel Divinity alternatives...');\r\n      const cdRelatedProps = Array.from(this.propertyCache.keys()).filter(name =>\r\n        name.toLowerCase().includes('channel divinity') ||\r\n        name.toLowerCase().includes('channeldivinity')\r\n      );\r\n      console.log('[DiceCloud Sync] Channel Divinity-related properties found:', cdRelatedProps);\r\n\r\n      // Try class-specific Channel Divinity first (like \"Channel Divinity: Cleric\" or \"Channel Divinity: Paladin\")\r\n      const classSpecificCD = cdRelatedProps.find(name =>\r\n        name !== 'Channel Divinity' &&\r\n        (name.includes('Channel Divinity') || name.includes('channelDivinity'))\r\n      );\r\n      if (classSpecificCD) {\r\n        const classSpecificId = this.propertyCache.get(classSpecificCD);\r\n        console.log(`[DiceCloud Sync] Using class-specific Channel Divinity: ${classSpecificCD} -> ${classSpecificId}`);\r\n        return classSpecificId;\r\n      }\r\n\r\n      // Fall back to any Channel Divinity variant found\r\n      if (cdRelatedProps.length > 0) {\r\n        const anyCD = cdRelatedProps[0];\r\n        const anyCDId = this.propertyCache.get(anyCD);\r\n        console.log(`[DiceCloud Sync] Using Channel Divinity variant: ${anyCD} -> ${anyCDId}`);\r\n        return anyCDId;\r\n      }\r\n    }\r\n\r\n    console.warn(`[DiceCloud Sync] \u274C Property ID not found for: \"${attributeName}\"`);\r\n    console.warn(`[DiceCloud Sync] Available properties (showing first 20):`, Array.from(this.propertyCache.keys()).slice(0, 20));\r\n\r\n    // Show potential matches\r\n    const potentialMatches = Array.from(this.propertyCache.keys()).filter(name =>\r\n      name.toLowerCase().includes(attributeName.toLowerCase()) ||\r\n      attributeName.toLowerCase().includes(name.toLowerCase())\r\n    );\r\n    if (potentialMatches.length > 0) {\r\n      console.warn(`[DiceCloud Sync] \uD83D\uDCA1 Potential matches:`, potentialMatches);\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  setupRoll20EventListeners() {\r\n    console.log('[DiceCloud Sync] Setting up Roll20 event listeners...');\r\n    \r\n    // Listen for character data updates from popup\r\n    window.addEventListener('message', (event) => {\r\n      if (event.data.type === 'characterDataUpdate') {\r\n        console.log('[SYNC DEBUG] Received characterDataUpdate message');\r\n        console.log('[SYNC DEBUG] Full event.data:', event.data);\r\n        console.log('[SYNC DEBUG] event.data.characterData:', event.data.characterData);\r\n        console.log('[SYNC DEBUG] channelDivinity in message:', event.data.characterData?.channelDivinity);\r\n        console.log('[SYNC DEBUG] resources in message:', event.data.characterData?.resources);\r\n        this.handleCharacterDataUpdate(event.data.characterData);\r\n      }\r\n    });\r\n\r\n    // Listen for action usage updates\r\n    window.addEventListener('message', (event) => {\r\n      if (event.data.type === 'actionUsageUpdate') {\r\n        this.handleActionUsageUpdate(event.data.actionName, event.data.usesUsed);\r\n      }\r\n    });\r\n\r\n    // Listen for attribute updates\r\n    window.addEventListener('message', (event) => {\r\n      if (event.data.type === 'attributeUpdate') {\r\n        this.handleAttributeUpdate(event.data.attributeName, event.data.value);\r\n      }\r\n    });\r\n\r\n    console.log('[DiceCloud Sync] Roll20 event listeners set up');\r\n  }\r\n\r\n  /**\r\n   * Handle character data updates from Roll20\r\n   * @param {Object} characterData - Updated character data\r\n   */\r\n  async handleCharacterDataUpdate(characterData) {\r\n    if (!this.enabled) {\r\n      console.warn('[DiceCloud Sync] Sync not enabled, ignoring update');\r\n      return;\r\n    }\r\n\r\n    console.log('[DiceCloud Sync] ========== HANDLING CHARACTER DATA UPDATE ==========');\r\n    console.log('[DiceCloud Sync] Character:', characterData.name);\r\n    console.log('[DiceCloud Sync] Received data keys:', Object.keys(characterData));\r\n    console.log('[DiceCloud Sync] Resources:', characterData.resources);\r\n    console.log('[DiceCloud Sync] Channel Divinity:', characterData.channelDivinity);\r\n    console.log('[DiceCloud Sync] Death Saves:', characterData.deathSaves);\r\n    console.log('[DiceCloud Sync] Inspiration:', characterData.inspiration);\r\n    console.log('[DiceCloud Sync] Actions:', characterData.actions);\r\n    console.log('[DiceCloud Sync] Property Cache size:', this.propertyCache.size);\r\n    console.log('[DiceCloud Sync] Property Cache keys:', Array.from(this.propertyCache.keys()));\r\n    console.log('[DiceCloud Sync] ========================================');\r\n\r\n    // If previousValues is completely empty, this is the very first update\r\n    // Initialize all values from this update without syncing\r\n    if (this.previousValues.size === 0) {\r\n      console.log('[DiceCloud Sync] \uD83D\uDD27 previousValues is empty, initializing from first update (no sync)');\r\n      await this.initializePreviousValues(characterData);\r\n      return; // Don't sync anything on first initialization\r\n    }\r\n\r\n    // Helper function to check if value has changed\r\n    const hasChanged = (key, newValue) => {\r\n      const oldValue = this.previousValues.get(key);\r\n\r\n      // If this is the first time we're seeing this value, initialize it without syncing\r\n      if (oldValue === undefined) {\r\n        console.log(`[DiceCloud Sync] \uD83D\uDCE5 Initializing ${key}: ${newValue} (no sync)`);\r\n        this.previousValues.set(key, newValue);\r\n        return false; // Don't sync on first initialization\r\n      }\r\n\r\n      const changed = oldValue !== newValue;\r\n      if (changed) {\r\n        console.log(`[DiceCloud Sync] \u270F\uFE0F Value changed for ${key}: ${oldValue} -> ${newValue} (will sync)`);\r\n        this.previousValues.set(key, newValue);\r\n      }\r\n      // Skip logging for unchanged values to reduce console spam\r\n      return changed;\r\n    };\r\n\r\n    // Update HP if changed\r\n    if (characterData.hp !== undefined && hasChanged('Hit Points', characterData.hp)) {\r\n      await this.updateAttributeValue('Hit Points', characterData.hp);\r\n    }\r\n\r\n    // Update temporary HP if changed\r\n    if (characterData.tempHp !== undefined && hasChanged('Temporary Hit Points', characterData.tempHp)) {\r\n      await this.updateAttributeValue('Temporary Hit Points', characterData.tempHp);\r\n    }\r\n\r\n    // Update max HP if changed\r\n    if (characterData.maxHp !== undefined && hasChanged('Max Hit Points', characterData.maxHp)) {\r\n      await this.updateAttributeValue('Max Hit Points', characterData.maxHp);\r\n    }\r\n\r\n    // Update spell slots if they exist (level1SpellSlots, level2SpellSlots, etc.)\r\n    if (characterData.spellSlots) {\r\n      for (let level = 1; level <= 9; level++) {\r\n        const currentKey = `level${level}SpellSlots`;\r\n        const maxKey = `level${level}SpellSlotsMax`;\r\n\r\n        if (characterData.spellSlots[currentKey] !== undefined && characterData.spellSlots[maxKey] !== undefined) {\r\n          // Only sync if max > 0 (character has slots of this level)\r\n          if (characterData.spellSlots[maxKey] > 0) {\r\n            const cacheKey = `spellSlot${level}`;\r\n            const currentValue = characterData.spellSlots[currentKey];\r\n            const previousValue = this.previousValues.get(cacheKey);\r\n\r\n            console.log(`[SYNC DEBUG] Spell Slot Level ${level} - previous: ${previousValue}, current: ${currentValue}`);\r\n            if (hasChanged(cacheKey, currentValue)) {\r\n              console.log(`[DiceCloud Sync] \u2705 Syncing spell slot level ${level}: ${currentValue}/${characterData.spellSlots[maxKey]}`);\r\n              await this.updateSpellSlot(level, currentValue);\r\n            } else {\r\n              console.log(`[SYNC DEBUG] \u23ED\uFE0F Spell slot level ${level} unchanged (${currentValue}), skipping sync`);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Update Channel Divinity if it exists\r\n    console.log('[SYNC DEBUG] characterData.channelDivinity:', characterData.channelDivinity);\r\n    console.log('[SYNC DEBUG] characterData.resources:', characterData.resources);\r\n    if (characterData.channelDivinity && characterData.channelDivinity.current !== undefined) {\r\n      const currentValue = characterData.channelDivinity.current;\r\n      const previousValue = this.previousValues.get('Channel Divinity');\r\n      console.log(`[SYNC DEBUG] Channel Divinity - previous: ${previousValue}, current: ${currentValue}`);\r\n      if (hasChanged('Channel Divinity', currentValue)) {\r\n        console.log(`[DiceCloud Sync] \u2705 Syncing Channel Divinity: ${currentValue}/${characterData.channelDivinity.max}`);\r\n        await this.updateChannelDivinity(currentValue);\r\n      } else {\r\n        console.log(`[SYNC DEBUG] \u23ED\uFE0F Channel Divinity unchanged (${currentValue}), skipping sync`);\r\n      }\r\n    } else {\r\n      console.log('[SYNC DEBUG] Channel Divinity check failed - object is null or current is undefined');\r\n    }\r\n\r\n    // Update other tracked resources\r\n    console.log('[SYNC DEBUG] Checking resources for sync...');\r\n    if (characterData.resources && Array.isArray(characterData.resources)) {\r\n      console.log(`[SYNC DEBUG] Found ${characterData.resources.length} resources in characterData`);\r\n      for (const resource of characterData.resources) {\r\n        console.log(`[SYNC DEBUG] Resource: ${resource.name} - current: ${resource.current}, max: ${resource.max}`);\r\n        if (resource.name && resource.current !== undefined) {\r\n          const propertyId = this.findPropertyId(resource.name);\r\n          console.log(`[SYNC DEBUG] Property ID for ${resource.name}: ${propertyId || 'NOT FOUND'}`);\r\n          if (hasChanged(resource.name, resource.current)) {\r\n            console.log(`[DiceCloud Sync] \u2705 Syncing resource ${resource.name}: ${resource.current}/${resource.max}`);\r\n            await this.updateResource(resource.name, resource.current);\r\n          } else {\r\n            console.log(`[SYNC DEBUG] \u23ED\uFE0F Resource ${resource.name} unchanged, skipping sync`);\r\n          }\r\n        } else {\r\n          console.log(`[SYNC DEBUG] \u274C Resource ${resource.name} missing name or current value`);\r\n        }\r\n      }\r\n    } else {\r\n      console.log('[SYNC DEBUG] No resources array in characterData');\r\n    }\r\n\r\n    // Update death saves if changed\r\n    console.log('[SYNC DEBUG] Checking death saves for sync...');\r\n    if (characterData.deathSaves) {\r\n      console.log(`[SYNC DEBUG] Death saves object:`, characterData.deathSaves);\r\n      if (characterData.deathSaves.successes !== undefined) {\r\n        const propertyId = this.findPropertyId('Succeeded Saves');\r\n        console.log(`[SYNC DEBUG] Property ID for Succeeded Saves: ${propertyId || 'NOT FOUND'}`);\r\n        if (hasChanged('Succeeded Saves', characterData.deathSaves.successes)) {\r\n          console.log(`[DiceCloud Sync] \u2705 Syncing Succeeded Saves: ${characterData.deathSaves.successes}`);\r\n          await this.updateDeathSaves(characterData.deathSaves.successes, undefined);\r\n        } else {\r\n          console.log(`[SYNC DEBUG] \u23ED\uFE0F Succeeded Saves unchanged, skipping sync`);\r\n        }\r\n      }\r\n      if (characterData.deathSaves.failures !== undefined) {\r\n        const propertyId = this.findPropertyId('Failed Saves');\r\n        console.log(`[SYNC DEBUG] Property ID for Failed Saves: ${propertyId || 'NOT FOUND'}`);\r\n        if (hasChanged('Failed Saves', characterData.deathSaves.failures)) {\r\n          console.log(`[DiceCloud Sync] \u2705 Syncing Failed Saves: ${characterData.deathSaves.failures}`);\r\n          await this.updateDeathSaves(undefined, characterData.deathSaves.failures);\r\n        } else {\r\n          console.log(`[SYNC DEBUG] \u23ED\uFE0F Failed Saves unchanged, skipping sync`);\r\n        }\r\n      }\r\n    } else {\r\n      console.log('[SYNC DEBUG] No deathSaves object in characterData');\r\n    }\r\n\r\n    // Update inspiration if changed\r\n    console.log('[SYNC DEBUG] Checking inspiration for sync...');\r\n    if (characterData.inspiration !== undefined) {\r\n      const propertyId = this.findPropertyId('Inspiration');\r\n      console.log(`[SYNC DEBUG] Inspiration value: ${characterData.inspiration}, Property ID: ${propertyId || 'NOT FOUND'}`);\r\n      if (hasChanged('Inspiration', characterData.inspiration)) {\r\n        console.log(`[DiceCloud Sync] \u2705 Syncing Inspiration: ${characterData.inspiration}`);\r\n        await this.updateInspiration(characterData.inspiration);\r\n      } else {\r\n        console.log(`[SYNC DEBUG] \u23ED\uFE0F Inspiration unchanged, skipping sync`);\r\n      }\r\n    } else {\r\n      console.log('[SYNC DEBUG] No inspiration value in characterData');\r\n    }\r\n\r\n    // Update action uses if changed\r\n    console.log('[SYNC DEBUG] Checking actions for sync...');\r\n    if (characterData.actions && Array.isArray(characterData.actions)) {\r\n      console.log(`[SYNC DEBUG] Found ${characterData.actions.length} actions in characterData`);\r\n      for (const action of characterData.actions) {\r\n        console.log(`[SYNC DEBUG] Action: ${action.name} - uses: ${action.uses}, usesUsed: ${action.usesUsed}, _id: ${action._id}`);\r\n        if (action.name && action.uses && action.usesUsed !== undefined && action._id) {\r\n          const cacheKey = `action_${action.name}`;\r\n          if (hasChanged(cacheKey, action.usesUsed)) {\r\n            console.log(`[DiceCloud Sync] \u2705 Syncing action ${action.name}: ${action.usesUsed} uses used`);\r\n            await this.setActionUses(action._id, action.usesUsed);\r\n          } else {\r\n            console.log(`[SYNC DEBUG] \u23ED\uFE0F Action ${action.name} unchanged, skipping sync`);\r\n          }\r\n        } else {\r\n          console.log(`[SYNC DEBUG] \u274C Action ${action.name} missing required fields (uses: ${action.uses}, usesUsed: ${action.usesUsed}, _id: ${action._id})`);\r\n        }\r\n      }\r\n    } else {\r\n      console.log('[SYNC DEBUG] No actions array in characterData');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle action usage updates from Roll20\r\n   * @param {string} actionName - Name of the action\r\n   * @param {number} usesUsed - New uses used value\r\n   */\r\n  async handleActionUsageUpdate(actionName, usesUsed) {\r\n    if (!this.enabled) {\r\n      console.warn('[DiceCloud Sync] Sync not enabled, ignoring action update');\r\n      return;\r\n    }\r\n\r\n    console.log(`[DiceCloud Sync] Handling action usage update: ${actionName} -> ${usesUsed}`);\r\n    await this.setActionUses(actionName, usesUsed);\r\n  }\r\n\r\n  /**\r\n   * Handle attribute updates from Roll20\r\n   * @param {string} attributeName - Name of the attribute\r\n   * @param {number} value - New value\r\n   */\r\n  async handleAttributeUpdate(attributeName, value) {\r\n    if (!this.enabled) {\r\n      console.warn('[DiceCloud Sync] Sync not enabled, ignoring attribute update');\r\n      return;\r\n    }\r\n\r\n    console.log(`[DiceCloud Sync] Handling attribute update: ${attributeName} -> ${value}`);\r\n    await this.updateAttributeValue(attributeName, value);\r\n  }\r\n\r\n  /**\r\n   * Check if sync is enabled\r\n   * @returns {boolean} True if sync is enabled\r\n   */\r\n  isEnabled() {\r\n    return this.enabled;\r\n  }\r\n\r\n  /**\r\n   * Disable sync\r\n   */\r\n  disable() {\r\n    this.enabled = false;\r\n    console.log('[DiceCloud Sync] Sync disabled');\r\n  }\r\n\r\n  /**\r\n   * Enable sync\r\n   */\r\n  enable() {\r\n    if (this.characterId && this.ddp.isConnected()) {\r\n      this.enabled = true;\r\n      console.log('[DiceCloud Sync] Sync enabled');\r\n    } else {\r\n      console.warn('[DiceCloud Sync] Cannot enable sync - not initialized');\r\n    }\r\n  }\r\n}\r\n\r\n// ES6 export for bundlers\r\nexport default DiceCloudSync;\r\n\r\n// Global initialization function\r\nif (typeof window !== 'undefined') {\r\n  window.initializeDiceCloudSync = async function() {\r\n  console.log('[DiceCloud Sync] Global initialization called');\r\n  console.log('[DiceCloud Sync] Current URL:', window.location.href);\r\n\r\n  try {\r\n    // Get DiceCloud token for authentication\r\n    const tokenResult = await browserAPI.storage.local.get(['diceCloudToken']);\r\n    const { diceCloudToken } = tokenResult;\r\n\r\n    // Check if we already have a DDP client that's connected\r\n    if (window.diceCloudSync && window.diceCloudSync.ddp && window.diceCloudSync.ddp.isConnected()) {\r\n      console.log('[DiceCloud Sync] DDP already connected, checking authentication...');\r\n\r\n      // If we now have a token but weren't authenticated before, authenticate now\r\n      if (diceCloudToken) {\r\n        console.log('[DiceCloud Sync] Authenticating existing DDP connection...');\r\n        try {\r\n          const result = await window.diceCloudSync.ddp.call('login', {\r\n            resume: diceCloudToken\r\n          });\r\n          console.log('[DiceCloud Sync] DDP authentication successful:', result);\r\n\r\n          // Re-initialize the sync with character data\r\n          const charResult = await browserAPI.storage.local.get(['activeCharacterId', 'characterProfiles']);\r\n          const { activeCharacterId, characterProfiles } = charResult;\r\n\r\n          if (activeCharacterId && characterProfiles && characterProfiles[activeCharacterId]) {\r\n            const profileData = characterProfiles[activeCharacterId];\r\n            if (profileData && profileData.id) {\r\n              console.log('[DiceCloud Sync] Re-initializing with character:', profileData.id);\r\n              await window.diceCloudSync.initialize(profileData.id);\r\n            }\r\n          }\r\n\r\n          return; // Don't create a new connection\r\n        } catch (error) {\r\n          console.error('[DiceCloud Sync] Authentication failed:', error);\r\n          // Fall through to create a new connection\r\n        }\r\n      } else {\r\n        console.log('[DiceCloud Sync] Already initialized, skipping');\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Create DDP client\r\n    console.log('[DiceCloud Sync] Creating new DDP client...');\r\n    const ddpClient = new DDPClient('wss://dicecloud.com/websocket');\r\n    \r\n    if (diceCloudToken) {\r\n      console.log('[DiceCloud Sync] Setting up DDP authentication...');\r\n      // Set up authentication after connection\r\n      ddpClient.onConnected = async () => {\r\n        console.log('[DiceCloud Sync] DDP connected, authenticating...');\r\n        try {\r\n          const result = await ddpClient.call('login', {\r\n            resume: diceCloudToken\r\n          });\r\n          console.log('[DiceCloud Sync] DDP authentication successful:', result);\r\n        } catch (error) {\r\n          console.error('[DiceCloud Sync] DDP authentication failed:', error);\r\n        }\r\n      };\r\n      \r\n      // Connect to DDP\r\n      console.log('[DiceCloud Sync] About to connect to DDP...');\r\n      try {\r\n        await ddpClient.connect();\r\n        console.log('[DiceCloud Sync] DDP connect() completed');\r\n      } catch (error) {\r\n        console.error('[DiceCloud Sync] DDP connect() failed:', error);\r\n      }\r\n    } else {\r\n      console.warn('[DiceCloud Sync] No DiceCloud token found for DDP authentication');\r\n      // Still connect without authentication\r\n      console.log('[DiceCloud Sync] About to connect to DDP without token...');\r\n      try {\r\n        await ddpClient.connect();\r\n        console.log('[DiceCloud Sync] DDP connect() completed without token');\r\n      } catch (error) {\r\n        console.error('[DiceCloud Sync] DDP connect() failed without token:', error);\r\n      }\r\n    }\r\n    \r\n    // Create sync instance\r\n    const sync = new DiceCloudSync(ddpClient);\r\n    window.diceCloudSync = sync;\r\n    \r\n    console.log('[DiceCloud Sync] Sync instance created, checking for active character...');\r\n    \r\n    // Try to initialize with active character\r\n    const tryInitialize = async () => {\r\n      try {\r\n        console.log('[DiceCloud Sync] Trying to initialize...');\r\n        \r\n        // Check if browser API is available\r\n        if (typeof browserAPI !== 'undefined') {\r\n          console.log('[DiceCloud Sync] Browser API available, checking storage...');\r\n          \r\n          const result = await browserAPI.storage.local.get(['activeCharacterId', 'characterProfiles']);\r\n          const { activeCharacterId, characterProfiles } = result;\r\n          console.log('[DiceCloud Sync] Storage result:', { activeCharacterId, characterProfilesKeys: characterProfiles ? Object.keys(characterProfiles) : null });\r\n          \r\n          if (activeCharacterId && characterProfiles && characterProfiles[activeCharacterId]) {\r\n            const characterData = characterProfiles[activeCharacterId];\r\n            console.log('[DiceCloud Sync] Character data for key:', activeCharacterId, characterData);\r\n            \r\n            // Check if we have character profiles and find the DiceCloud character ID\r\n            if (characterProfiles && typeof characterProfiles === 'object') {\r\n              console.log('[DiceCloud Sync] Checking characterProfiles object:', Object.keys(characterProfiles));\r\n              \r\n              // Find the character data in characterProfiles\r\n              const profileData = characterProfiles[activeCharacterId] || characterProfiles.default || characterProfiles['slot-1'];\r\n              if (profileData && profileData.id) {\r\n                console.log('[DiceCloud Sync] Found character data in characterProfiles:', profileData);\r\n                console.log('[DiceCloud Sync] Found DiceCloud character ID:', profileData.id);\r\n                \r\n                // Initialize sync with the character ID\r\n                await sync.initialize(profileData.id);\r\n                \r\n                // Set up event listeners\r\n                sync.setupRoll20EventListeners();\r\n                console.log('[DiceCloud Sync] Event listeners set up');\r\n                \r\n                console.log('[DiceCloud Sync] Global initialization complete');\r\n                return;\r\n              }\r\n            }\r\n          } else {\r\n            console.warn('[DiceCloud Sync] No active character found in storage');\r\n            console.log('[DiceCloud Sync] All storage keys:', Object.keys(result));\r\n            console.log('[DiceCloud Sync] All storage data:', result);\r\n          }\r\n        } else {\r\n          console.warn('[DiceCloud Sync] Browser API not available');\r\n        }\r\n        \r\n        // Retry after delay if no character found\r\n        console.log('[DiceCloud Sync] Retrying in 2 seconds...');\r\n        setTimeout(tryInitialize, 2000);\r\n      } catch (error) {\r\n        console.error('[DiceCloud Sync] Error during initialization:', error);\r\n        console.log('[DiceCloud Sync] Retrying in 5 seconds...');\r\n        setTimeout(tryInitialize, 5000);\r\n      }\r\n    };\r\n    \r\n    // Start initialization\r\n    tryInitialize();\r\n    \r\n  } catch (error) {\r\n    console.error('[DiceCloud Sync] Failed to create sync instance:', error);\r\n    console.error('[DiceCloud Sync] Error details:', error.stack);\r\n  }\r\n};\r\n\r\n// Auto-initialize if we're on Roll20\r\nif (window.location.hostname === 'app.roll20.net') {\r\n  console.log('[DiceCloud Sync] Detected Roll20, initializing sync...');\r\n  // Wait a bit for page to load\r\n  setTimeout(() => {\r\n    window.initializeDiceCloudSync();\r\n  }, 1000);\r\n\r\n  // Listen for storage changes (e.g., when user logs in via popup)\r\n  if (typeof browserAPI !== 'undefined' && browserAPI.storage && browserAPI.storage.onChanged) {\r\n    browserAPI.storage.onChanged.addListener((changes, areaName) => {\r\n      if (areaName === 'local' && changes.diceCloudToken) {\r\n        const newToken = changes.diceCloudToken.newValue;\r\n        const oldToken = changes.diceCloudToken.oldValue;\r\n\r\n        // If token was added or changed, re-initialize sync with authentication\r\n        if (newToken && newToken !== oldToken) {\r\n          console.log('[DiceCloud Sync] Token detected, re-initializing with authentication...');\r\n          // Re-initialize the sync with the new token\r\n          window.initializeDiceCloudSync();\r\n        }\r\n      }\r\n    });\r\n    console.log('[DiceCloud Sync] Storage listener registered for token changes');\r\n  }\r\n  };\r\n}\r\n", "/**\r\n * Roll20 Content Script\r\n * Handles roll announcements and character sheet overlay\r\n */\r\n\r\n// Import browser polyfill for cross-browser compatibility\r\nimport '@carmaclouds/core/common/browser-polyfill.js';\r\n\r\n// Import FoundCloud-specific lib modules for two-way sync (experimental)\r\nimport MeteorDDPClient from '../lib/meteor-ddp-client.js';\r\nimport DiceCloudSync from '../lib/dicecloud-sync.js';\r\n\r\n// Make them available globally for the IIFE\r\nwindow.DDPClient = MeteorDDPClient;\r\nwindow.DiceCloudSync = DiceCloudSync;\r\n\r\n// Define debug for content script context\r\nconst debug = window.debug || {\r\n  log: console.log.bind(console),\r\n  warn: console.warn.bind(console),\r\n  error: console.error.bind(console),\r\n  info: console.info.bind(console),\r\n  group: console.group.bind(console),\r\n  groupEnd: console.groupEnd.bind(console),\r\n  table: console.table.bind(console),\r\n  time: console.time.bind(console),\r\n  timeEnd: console.timeEnd.bind(console),\r\n  isEnabled: () => true\r\n};\r\n\r\n(function() {\r\n  'use strict';\r\n\r\n  debug.log('FoundCloud: Roll20 content script loaded');\r\n\r\n  /**\r\n   * Posts a message to Roll20 chat\r\n   */\r\n  function postChatMessage(message) {\r\n    try {\r\n      // Find the chat input textarea\r\n      const chatInput = document.querySelector('#textchat-input textarea');\r\n      if (!chatInput) {\r\n        debug.error('\u274C Could not find Roll20 chat input textarea (#textchat-input textarea)');\r\n        return false;\r\n      }\r\n\r\n      debug.log('\uD83D\uDCDD Setting chat input value:', message.substring(0, 80) + (message.length > 80 ? '...' : ''));\r\n      chatInput.focus();\r\n      chatInput.value = message;\r\n\r\n      // Dispatch input event so Roll20/jQuery recognizes the value change\r\n      chatInput.dispatchEvent(new Event('input', { bubbles: true }));\r\n      chatInput.dispatchEvent(new Event('change', { bubbles: true }));\r\n\r\n      // Trigger the send button\r\n      const sendButton = document.querySelector('#textchat-input .btn');\r\n      if (!sendButton) {\r\n        debug.error('\u274C Could not find Roll20 chat send button (#textchat-input .btn)');\r\n        return false;\r\n      }\r\n\r\n      sendButton.click();\r\n      debug.log('\u2705 Message posted to Roll20 chat');\r\n      return true;\r\n    } catch (error) {\r\n      debug.error('\u274C Error posting to Roll20 chat:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles roll messages from Dice Cloud\r\n   */\r\n  function handleDiceCloudRoll(rollData) {\r\n    debug.log('\uD83C\uDFB2 Handling roll:', rollData);\r\n    debug.log('\uD83C\uDFB2 Roll data keys:', Object.keys(rollData || {}));\r\n    if (rollData.source === 'discord') {\r\n      debug.log('\uD83D\uDCE1 Roll originated from Discord command');\r\n    }\r\n\r\n    // Use pre-formatted message if it exists (for spells, actions, etc.)\r\n    // Otherwise format the roll data\r\n    const formattedMessage = rollData.message || formatRollForRoll20(rollData);\r\n    debug.log('\uD83C\uDFB2 Formatted message:', formattedMessage);\r\n\r\n    const success = postChatMessage(formattedMessage);\r\n\r\n    if (success) {\r\n      debug.log('\u2705 Roll successfully posted to Roll20');\r\n\r\n      // Wait for Roll20 to process the roll and add it to chat\r\n      // Then parse the actual Roll20 result (not DiceCloud's roll)\r\n      observeNextRollResult(rollData);\r\n      return { success: true };\r\n    } else {\r\n      debug.error('\u274C Failed to post roll to Roll20 - chat input or send button not found');\r\n      return { success: false, error: 'Roll20 chat not ready. Make sure you are in a Roll20 game.' };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Observes Roll20 chat for the next roll result and checks for natural 1s/20s\r\n   */\r\n  function observeNextRollResult(originalRollData) {\r\n    debug.log('\uD83D\uDC40 Setting up observer for Roll20 roll result...');\r\n\r\n    const chatLog = document.querySelector('#textchat .content');\r\n    if (!chatLog) {\r\n      debug.error('\u274C Could not find Roll20 chat log');\r\n      return;\r\n    }\r\n\r\n    // Create observer to watch for new messages\r\n    const observer = new MutationObserver((mutations) => {\r\n      for (const mutation of mutations) {\r\n        for (const node of mutation.addedNodes) {\r\n          if (node.nodeType === Node.ELEMENT_NODE) {\r\n            // Check if this is a message with an inline roll\r\n            const inlineRoll = node.querySelector('.inlinerollresult');\r\n            if (inlineRoll) {\r\n              debug.log('\uD83C\uDFB2 Found new Roll20 inline roll:', inlineRoll);\r\n\r\n              // Parse the roll result from Roll20's display\r\n              const rollResult = parseRoll20InlineRoll(inlineRoll, originalRollData);\r\n\r\n              if (rollResult) {\r\n                debug.log('\uD83C\uDFB2 Parsed Roll20 roll result:', rollResult);\r\n\r\n                // Check for natural 1s or 20s\r\n                if (rollResult.baseRoll === 1 || rollResult.baseRoll === 20) {\r\n                  const rollType = rollResult.baseRoll === 1 ? 'Natural 1' : 'Natural 20';\r\n                  debug.log(`\uD83C\uDFAF ${rollType} detected in Roll20 roll!`);\r\n\r\n                  // Send to popup for racial trait checking\r\n                  browserAPI.runtime.sendMessage({\r\n                    action: 'rollResult',\r\n                    rollResult: rollResult.total.toString(),\r\n                    baseRoll: rollResult.baseRoll.toString(),\r\n                    rollType: originalRollData.formula,\r\n                    rollName: originalRollData.name,\r\n                    checkRacialTraits: true\r\n                  });\r\n\r\n                  debug.log(`\uD83E\uDDEC Sent ${rollType} result to popup`);\r\n                }\r\n              }\r\n\r\n              // Disconnect after processing first roll\r\n              observer.disconnect();\r\n              break;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    // Start observing\r\n    observer.observe(chatLog, { childList: true, subtree: true });\r\n    debug.log('\u2705 Observer set up for Roll20 chat');\r\n\r\n    // Auto-disconnect after 5 seconds to prevent memory leaks\r\n    setTimeout(() => {\r\n      observer.disconnect();\r\n      debug.log('\u23F1\uFE0F Roll observer timed out and disconnected');\r\n    }, 5000);\r\n  }\r\n\r\n  /**\r\n   * Parses Roll20's inline roll result to extract the base d20 roll\r\n   */\r\n  function parseRoll20InlineRoll(inlineRollElement, originalRollData) {\r\n    try {\r\n      // Roll20 inline rolls have a title attribute with the full roll breakdown\r\n      // e.g., \"Rolling 1d20+5 = (<span class=\"basicdiceroll\">17</span>)+5\"\r\n      const title = inlineRollElement.getAttribute('title') || '';\r\n      debug.log('\uD83D\uDCCA Roll20 inline roll title:', title);\r\n\r\n      // Strip HTML tags from the title to get plain text\r\n      const plainTitle = title.replace(/<[^>]*>/g, '');\r\n      debug.log('\uD83D\uDCCA Plain title:', plainTitle);\r\n\r\n      // Extract the base roll from parentheses in the title\r\n      // Format after stripping HTML: \"Rolling 1d20+5 = (17)+5\" or \"Rolling 1d20 = (1)\"\r\n      const baseRollMatch = plainTitle.match(/=\\s*\\(\\s*(\\d+)\\s*\\)/);\r\n      const baseRoll = baseRollMatch ? parseInt(baseRollMatch[1]) : null;\r\n\r\n      // Get the total from the visible text\r\n      const totalText = inlineRollElement.textContent?.trim() || '';\r\n      const total = parseInt(totalText);\r\n\r\n      debug.log(`\uD83D\uDCCA Extracted: baseRoll=${baseRoll}, total=${total}`);\r\n\r\n      // Only return if we successfully extracted a d20 roll (1-20)\r\n      if (baseRoll && baseRoll >= 1 && baseRoll <= 20) {\r\n        return {\r\n          baseRoll: baseRoll,\r\n          total: total,\r\n          formula: originalRollData.formula,\r\n          name: originalRollData.name\r\n        };\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      debug.error('\u274C Error parsing Roll20 inline roll:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calculates the base d20 roll from formula and final result\r\n   */\r\n  function calculateBaseRoll(formula, result) {\r\n    try {\r\n      debug.log(`\uD83E\uDDEE Calculating base roll - Formula: \"${formula}\", Result: \"${result}\"`);\r\n      \r\n      // Parse the formula to extract the modifier\r\n      // Formula format: \"1d20+X\" or \"1d20-X\"\r\n      const modifierMatch = formula.match(/1d20([+-]\\d+)/i);\r\n      \r\n      if (modifierMatch) {\r\n        const modifier = parseInt(modifierMatch[1]);\r\n        const totalResult = parseInt(result);\r\n        const baseRoll = totalResult - modifier;\r\n        \r\n        debug.log(`\uD83E\uDDEE Calculation: ${totalResult} - (${modifier}) = ${baseRoll}`);\r\n        \r\n        // Ensure the base roll is within valid d20 range (1-20)\r\n        if (baseRoll >= 1 && baseRoll <= 20) {\r\n          return baseRoll;\r\n        } else {\r\n          debug.warn(`\u26A0\uFE0F Calculated base roll ${baseRoll} is outside valid d20 range (1-20)`);\r\n          return baseRoll; // Still return it, but log warning\r\n        }\r\n      } else {\r\n        // No modifier found, assume the result is the base roll\r\n        debug.log(`\uD83E\uDDEE No modifier found in formula, using result as base roll: ${result}`);\r\n        return parseInt(result);\r\n      }\r\n    } catch (error) {\r\n      debug.error('\u274C Error calculating base roll:', error);\r\n      return parseInt(result); // Fallback to using the result directly\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Checks Roll20's inline roll elements for natural 1s\r\n   */\r\n  function checkRoll20InlineRolls(characterName) {\r\n    debug.log('\uD83D\uDD0D Checking Roll20 inline rolls for natural 1s for:', characterName);\r\n    \r\n    // Find all inline roll elements\r\n    const inlineRolls = document.querySelectorAll('.inlinerollresult, .rollresult');\r\n    debug.log(`\uD83D\uDD0D Found ${inlineRolls.length} inline roll elements`);\r\n    \r\n    inlineRolls.forEach((rollElement, index) => {\r\n      try {\r\n        // Get the roll data from Roll20's inline roll system\r\n        const rollData = getRoll20RollData(rollElement);\r\n        debug.log(`\uD83D\uDD0D Checking inline roll ${index + 1}:`, rollData);\r\n        \r\n        if (rollData && rollData.baseRoll === 1 && rollData.name.includes(characterName)) {\r\n          debug.log('\uD83C\uDF40 Natural 1 detected in Roll20 inline roll!');\r\n          debug.log('\uD83C\uDF40 Roll data:', rollData);\r\n          \r\n          // Send message to popup for Halfling Luck\r\n          browserAPI.runtime.sendMessage({\r\n            action: 'rollResult',\r\n            rollResult: rollData.total.toString(),\r\n            baseRoll: rollData.baseRoll.toString(),\r\n            rollType: rollData.formula,\r\n            rollName: rollData.name,\r\n            checkRacialTraits: true\r\n          });\r\n          \r\n          debug.log('\uD83E\uDDEC Sent natural 1 result to popup for Halfling Luck');\r\n        }\r\n      } catch (error) {\r\n        debug.warn('\u26A0\uFE0F Error checking inline roll:', error);\r\n      }\r\n    });\r\n    \r\n    debug.log('\uD83D\uDD0D Finished checking inline rolls');\r\n  }\r\n\r\n  /**\r\n   * Extracts roll data from Roll20's inline roll elements\r\n   */\r\n  function getRoll20RollData(rollElement) {\r\n    try {\r\n      // Roll20 stores roll data in the element's dataset or in a script tag\r\n      const rollName = rollElement.closest('.message')?.querySelector('.message-name')?.textContent || \r\n                     rollElement.closest('.message')?.textContent?.split('\\n')[0]?.trim() || '';\r\n      \r\n      // Try to get the roll formula from the inline roll\r\n      const formulaElement = rollElement.querySelector('.formula') || rollElement;\r\n      const formula = formulaElement.textContent?.trim() || '';\r\n      \r\n      // Look for the base roll value in the roll details\r\n      const rollDetails = rollElement.textContent || rollElement.innerText || '';\r\n      const baseRollMatch = rollDetails.match(/^(\\d+)/);\r\n      const baseRoll = baseRollMatch ? parseInt(baseRollMatch[1]) : null;\r\n      \r\n      // Look for the total result\r\n      const totalMatch = rollDetails.match(/(\\d+)\\s*$/);\r\n      const total = totalMatch ? parseInt(totalMatch[1]) : baseRoll;\r\n      \r\n      debug.log(`\uD83D\uDD0D Extracted roll data - Name: ${rollName}, Formula: ${formula}, Base: ${baseRoll}, Total: ${total}`);\r\n      \r\n      return {\r\n        name: rollName,\r\n        formula: formula,\r\n        baseRoll: baseRoll,\r\n        total: total\r\n      };\r\n    } catch (error) {\r\n      debug.warn('\u26A0\uFE0F Error extracting roll data:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get color emoji for character notification color (matches popup-sheet getColoredBanner)\r\n   */\r\n  function getColorEmoji(color) {\r\n    const colorEmojiMap = {\r\n      '#3498db': '\uD83D\uDD35', // Blue\r\n      '#e74c3c': '\uD83D\uDD34', // Red\r\n      '#27ae60': '\uD83D\uDFE2', // Green\r\n      '#9b59b6': '\uD83D\uDFE3', // Purple\r\n      '#e67e22': '\uD83D\uDFE0', // Orange\r\n      '#1abc9c': '\uD83D\uDD37', // Teal/Cyan\r\n      '#e91e63': '\uD83E\uDE77', // Pink\r\n      '#f1c40f': '\uD83D\uDFE1', // Yellow\r\n      '#95a5a6': '\u26AA', // Grey\r\n      '#34495e': '\u26AB', // Black\r\n      '#8b4513': '\uD83D\uDFE4'  // Brown\r\n    };\r\n    return colorEmojiMap[color] || '\uD83D\uDD35';\r\n  }\r\n\r\n  /**\r\n   * Formats roll data for Roll20 chat display with fancy template\r\n   */\r\n  function formatRollForRoll20(rollData) {\r\n    const { name, formula, characterName, advantage, disadvantage, checkType } = rollData;\r\n\r\n    // Handle advantage/disadvantage for d20 rolls\r\n    let rollFormula = formula;\r\n    let rollType = '';\r\n    \r\n    if ((advantage || disadvantage) && formula.includes('d20')) {\r\n      if (advantage && !disadvantage) {\r\n        rollFormula = formula.replace('1d20', '2d20kh1'); // 2d20 keep highest\r\n        rollType = ' (Advantage)';\r\n      } else if (disadvantage && !advantage) {\r\n        rollFormula = formula.replace('1d20', '2d20kl1'); // 2d20 keep lowest  \r\n        rollType = ' (Disadvantage)';\r\n      }\r\n    }\r\n\r\n    // Build character display name\r\n    let displayName = name;\r\n    if (characterName && !name.includes(characterName)) {\r\n      displayName = `${characterName} - ${name}`;\r\n    }\r\n\r\n    // Use Roll20's template system with inline rolls for fancy formatting\r\n    // [[formula]] creates an inline roll that Roll20 will calculate\r\n    return `&{template:default} {{name=${displayName}${rollType}}} {{Roll=[[${rollFormula}]]}}`;\r\n  }\r\n\r\n  /**\r\n   * Listen for messages from other parts of the extension\r\n   */\r\n  browserAPI.runtime.onMessage.addListener((request, sender, sendResponse) => {\r\n    debug.log('\uD83D\uDCE8 Roll20 content script received message:', request.action, request);\r\n    \r\n    if (request.action === 'postRollToChat') {\r\n      const result = handleDiceCloudRoll(request.roll);\r\n      sendResponse(result || { success: true });\r\n    } else if (request.action === 'sendRollToRoll20') {\r\n      // Handle the message that Dice Cloud is actually sending\r\n      debug.log('\uD83C\uDFB2 Received sendRollToRoll20 message:', request.roll);\r\n      const result = handleDiceCloudRoll(request.roll);\r\n      sendResponse(result || { success: true });\r\n    } else if (request.action === 'rollFromPopout') {\r\n      // Post roll directly to Roll20 - no DiceCloud needed!\r\n      debug.log('\uD83C\uDFB2 Received roll request from popup:', request);\r\n\r\n      const rollData = {\r\n        name: request.name || request.roll?.name,\r\n        formula: request.formula || request.roll?.formula,\r\n        characterName: request.characterName || request.roll?.characterName\r\n      };\r\n\r\n      // Check if silent rolls mode is enabled - if so, hide the roll instead of posting\r\n      if (silentRollsEnabled) {\r\n        debug.log('\uD83D\uDD07 Silent rolls active - hiding roll instead of posting');\r\n        const hiddenRoll = {\r\n          id: Date.now() + Math.random(), // Unique ID\r\n          name: rollData.name,\r\n          formula: rollData.formula,\r\n          characterName: rollData.characterName,\r\n          timestamp: new Date().toLocaleTimeString(),\r\n          result: null // Will be filled when revealed\r\n        };\r\n        hiddenRolls.push(hiddenRoll);\r\n        updateHiddenRollsDisplay();\r\n        sendResponse({ success: true, hidden: true });\r\n      } else {\r\n        // Normal flow - post to Roll20 chat\r\n        const formattedMessage = formatRollForRoll20(rollData);\r\n        const success = postChatMessage(formattedMessage);\r\n\r\n        if (success) {\r\n          debug.log('\u2705 Roll posted directly to Roll20 (no DiceCloud!)');\r\n          // Observe Roll20's result for natural 1s/20s\r\n          observeNextRollResult(rollData);\r\n        }\r\n\r\n        sendResponse({ success: success });\r\n      }\r\n    } else if (request.action === 'announceSpell') {\r\n      // Handle spell/action announcements relayed from background script (Firefox)\r\n      if (request.message) {\r\n        postChatMessage(request.message);\r\n      } else {\r\n        handleDiceCloudRoll(request);\r\n      }\r\n      sendResponse({ success: true });\r\n    } else if (request.action === 'postChatMessageFromPopup') {\r\n      // Handle character broadcast messages from popup\r\n      if (request.message) {\r\n        debug.log('\uD83D\uDCE8 Received postChatMessageFromPopup:', request.message);\r\n        const success = postChatMessage(request.message);\r\n        sendResponse({ success: success });\r\n      } else {\r\n        debug.warn('\u26A0\uFE0F postChatMessageFromPopup missing message');\r\n        sendResponse({ success: false, error: 'No message provided' });\r\n      }\r\n    } else if (request.action === 'testRoll20Connection') {\r\n      // Test if we can access Roll20 chat\r\n      const chatInput = document.querySelector('#textchat-input textarea');\r\n      sendResponse({\r\n        success: !!chatInput,\r\n        message: chatInput ? 'Roll20 chat accessible' : 'Roll20 chat not found'\r\n      });\r\n    } else if (request.action === 'showCharacterSheet') {\r\n      debug.log('\uD83D\uDD0D showCharacterSheet called, checking playerData:', playerData);\r\n      debug.log('\uD83D\uDD0D playerData keys:', Object.keys(playerData || {}));\r\n\r\n      // Check if there's any character data synced\r\n      if (!playerData || Object.keys(playerData).length === 0) {\r\n        debug.log('\u26A0\uFE0F No character data found - asking user about GM mode');\r\n\r\n        // Ask user if they want to open GM mode\r\n        const userConfirmed = confirm('No character data found.\\n\\nWould you like to open GM mode instead?');\r\n\r\n        if (userConfirmed) {\r\n          // User clicked \"Yes\" - open GM panel\r\n          try {\r\n            postChatMessage('\uD83D\uDC51 Opening GM mode...');\r\n            debug.log('\u2705 Chat message posted successfully');\r\n          } catch (error) {\r\n            debug.error('\u274C Error posting chat message:', error);\r\n          }\r\n\r\n          try {\r\n            toggleGMMode(true);\r\n            debug.log('\u2705 GM panel opened successfully');\r\n          } catch (error) {\r\n            debug.error('\u274C Error opening GM panel:', error);\r\n          }\r\n\r\n          sendResponse({ success: true, message: 'GM mode opened' });\r\n        } else {\r\n          // User clicked \"Cancel\" - do nothing\r\n          debug.log('\u2139\uFE0F User cancelled GM mode opening');\r\n          sendResponse({ success: false, error: 'No character data found' });\r\n        }\r\n        return;\r\n      }\r\n\r\n      // Show the character sheet overlay\r\n      try {\r\n        // Try to access the character sheet overlay script\r\n        // This will work if the overlay is already loaded\r\n        const overlayElement = document.getElementById('rollcloud-character-overlay');\r\n        if (overlayElement) {\r\n          overlayElement.style.display = 'block';\r\n          sendResponse({ success: true });\r\n        } else {\r\n          // Try to trigger the overlay creation\r\n          const event = new CustomEvent('showRollCloudSheet');\r\n          document.dispatchEvent(event);\r\n          sendResponse({ success: true });\r\n        }\r\n      } catch (error) {\r\n        debug.error('Error showing character sheet:', error);\r\n        sendResponse({ success: false, error: error.message });\r\n      }\r\n    } else if (request.action === 'forwardToPopup') {\r\n      // Forward roll result to popup for racial traits checking\r\n      debug.log('\uD83E\uDDEC Forwarding roll result to popup:', request);\r\n      debug.log('\uD83E\uDDEC Available popups:', Object.keys(characterPopups));\r\n      \r\n      // Send to all registered popup windows\r\n      Object.keys(characterPopups).forEach(characterName => {\r\n        const popup = characterPopups[characterName];\r\n        try {\r\n          if (popup && !popup.closed) {\r\n            debug.log(`\uD83E\uDDEC Sending to popup for ${characterName}:`, popup);\r\n            popup.postMessage({\r\n              action: 'rollResult',\r\n              rollResult: request.rollResult,\r\n              baseRoll: request.baseRoll,\r\n              rollType: request.rollType,\r\n              rollName: request.rollName,\r\n              checkRacialTraits: request.checkRacialTraits\r\n            }, '*');\r\n            \r\n            debug.log(`\uD83D\uDCE4 Sent rollResult to popup for ${characterName}`);\r\n          } else {\r\n            // Clean up closed popups\r\n            delete characterPopups[characterName];\r\n            debug.log(`\uD83D\uDDD1\uFE0F Removed closed popup for ${characterName}`);\r\n          }\r\n        } catch (error) {\r\n          debug.warn(`\u26A0\uFE0F Error sending rollResult to popup \"${characterName}\":`, error);\r\n          delete characterPopups[characterName];\r\n        }\r\n      });\r\n\r\n      sendResponse({ success: true });\r\n    } else if (request.action === 'setAutoBackwardsSync') {\r\n      // Handle auto backwards sync toggle from popup\r\n      debug.log('\uD83D\uDD04 Setting auto backwards sync:', request.enabled);\r\n\r\n      // Check if diceCloudSync exists (experimental build)\r\n      if (window.diceCloudSync) {\r\n        if (request.enabled) {\r\n          window.diceCloudSync.enable();\r\n          debug.log('\u2705 Auto backwards sync enabled');\r\n        } else {\r\n          window.diceCloudSync.disable();\r\n          debug.log('\u274C Auto backwards sync disabled');\r\n        }\r\n        sendResponse({ success: true });\r\n      } else {\r\n        debug.warn('\u26A0\uFE0F diceCloudSync not available (not experimental build?)');\r\n        sendResponse({ success: false, error: 'Sync not available' });\r\n      }\r\n    } else if (request.action === 'useActionFromDiscord') {\r\n      debug.log('\u2694\uFE0F Received useActionFromDiscord:', request);\r\n      const actionName = request.actionName || 'Unknown Action';\r\n      const commandData = request.commandData || {};\r\n      const charName = commandData.character_name || 'Character';\r\n\r\n      // If the action has a damage roll or attack bonus, roll it\r\n      const actionData = commandData.action_data || {};\r\n      if (actionData.damageRoll || actionData.attackBonus) {\r\n        const rollFormula = actionData.attackBonus\r\n          ? `1d20+${actionData.attackBonus}`\r\n          : actionData.damageRoll;\r\n        const msg = formatRollForRoll20({\r\n          name: `${charName} - ${actionName}`,\r\n          formula: rollFormula,\r\n          characterName: charName\r\n        });\r\n        postChatMessage(msg);\r\n      } else {\r\n        postChatMessage(`&{template:default} {{name=${charName} uses ${actionName}}}`);\r\n      }\r\n      sendResponse({ success: true });\r\n    } else if (request.action === 'castSpellFromDiscord') {\r\n      debug.log('\uD83D\uDD2E Received castSpellFromDiscord:', request);\r\n      const spellName = request.spellName || 'Unknown Spell';\r\n      const spellData = request.spellData || {};\r\n      const charName = spellData.character_name || 'Character';\r\n      const spell = spellData.spell_data || {};\r\n      const spellLevel = parseInt(spell.level) || 0;\r\n      const castLevel = parseInt(spellData.cast_level) || spellLevel;\r\n      const notificationColor = spellData.notification_color || '#3498db';\r\n\r\n      // Get color emoji banner (matches popup-sheet getColoredBanner)\r\n      const colorEmoji = getColorEmoji(notificationColor);\r\n\r\n      // Build concentration/ritual tags\r\n      let tags = '';\r\n      if (spell.concentration) tags += ' \uD83E\uDDE0 Concentration';\r\n      if (spell.ritual) tags += ' \uD83D\uDCD6 Ritual';\r\n\r\n      // Build spell announcement message with enhanced details\r\n      let announcement = `&{template:default} {{name=${colorEmoji} ${charName} casts ${spell.name || spellName}!${tags}}}`;\r\n\r\n      // Add spell level and school - show upcast level if different\r\n      if (spellLevel > 0) {\r\n        let levelText = castLevel > spellLevel\r\n          ? `Level ${castLevel} (upcast from ${spellLevel})`\r\n          : `Level ${spellLevel}`;\r\n        if (spell.school) levelText += ` ${spell.school}`;\r\n        announcement += ` {{Level=${levelText}}}`;\r\n      } else if (spell.school) {\r\n        announcement += ` {{Level=${spell.school} cantrip}}`;\r\n      }\r\n\r\n      // Add casting details\r\n      if (spell.castingTime) announcement += ` {{Casting Time=${spell.castingTime}}}`;\r\n      if (spell.range) announcement += ` {{Range=${spell.range}}}`;\r\n      if (spell.duration) announcement += ` {{Duration=${spell.duration}}}`;\r\n      if (spell.components) announcement += ` {{Components=${spell.components}}}`;\r\n      if (spell.source) announcement += ` {{Source=${spell.source}}}`;\r\n\r\n      // Add description\r\n      if (spell.description) {\r\n        announcement += ` {{Description=${spell.description}}}`;\r\n      }\r\n\r\n      // Post the announcement\r\n      postChatMessage(announcement);\r\n\r\n      // Helper function to scale damage formula for upcasting\r\n      const scaleFormulaForUpcast = (formula, baseLevel, actualCastLevel) => {\r\n        if (!formula || baseLevel <= 0 || actualCastLevel <= baseLevel) return formula;\r\n\r\n        // Replace slotLevel placeholder if present\r\n        let scaledFormula = formula.replace(/slotLevel/gi, actualCastLevel);\r\n\r\n        // If formula doesn't have slotLevel, try to scale it automatically\r\n        // Common pattern: XdY per spell level above base\r\n        // Match patterns like \"1d8\", \"2d6\", etc.\r\n        if (scaledFormula === formula) {\r\n          const levelDiff = actualCastLevel - baseLevel;\r\n          const diceMatch = formula.match(/^(\\d+)d(\\d+)/);\r\n          if (diceMatch && levelDiff > 0) {\r\n            const baseDice = parseInt(diceMatch[1]);\r\n            const dieSize = parseInt(diceMatch[2]);\r\n            // Add 1 die per level for most healing/damage spells\r\n            const scaledDice = baseDice + levelDiff;\r\n            scaledFormula = formula.replace(/^(\\d+)d(\\d+)/, `${scaledDice}d${dieSize}`);\r\n            debug.log(`\uD83D\uDCC8 Scaled formula from ${formula} to ${scaledFormula} (upcast by ${levelDiff} levels)`);\r\n          }\r\n        }\r\n\r\n        return scaledFormula;\r\n      };\r\n\r\n      // Roll attack if spell has attack roll\r\n      if (spell.attackRoll && spell.attackRoll !== '(none)') {\r\n        setTimeout(() => {\r\n          const attackMsg = formatRollForRoll20({\r\n            name: `${spell.name || spellName} - Attack`,\r\n            formula: spell.attackRoll,\r\n            characterName: charName\r\n          });\r\n          postChatMessage(attackMsg);\r\n        }, 100);\r\n      }\r\n\r\n      // Roll damage(s) from damageRolls array - scale for upcasting\r\n      if (spell.damageRolls && Array.isArray(spell.damageRolls) && spell.damageRolls.length > 0) {\r\n        spell.damageRolls.forEach((roll, index) => {\r\n          if (roll.damage) {\r\n            setTimeout(() => {\r\n              const damageType = roll.damageType || 'damage';\r\n              const isHealing = damageType.toLowerCase() === 'healing';\r\n              const isTempHP = damageType.toLowerCase().includes('temp');\r\n              let rollName;\r\n              if (isHealing) {\r\n                rollName = `${spell.name || spellName} - Healing`;\r\n              } else if (isTempHP) {\r\n                rollName = `${spell.name || spellName} - Temp HP`;\r\n              } else {\r\n                rollName = `${spell.name || spellName} - ${damageType}`;\r\n              }\r\n\r\n              // Scale formula for upcasting\r\n              const scaledFormula = scaleFormulaForUpcast(roll.damage, spellLevel, castLevel);\r\n\r\n              const damageMsg = formatRollForRoll20({\r\n                name: rollName,\r\n                formula: scaledFormula,\r\n                characterName: charName\r\n              });\r\n              postChatMessage(damageMsg);\r\n            }, 200 + (index * 100));\r\n          }\r\n        });\r\n      } else if (spell.damage) {\r\n        // Fallback to single damage field for backward compatibility\r\n        setTimeout(() => {\r\n          const damageType = spell.damageType || 'damage';\r\n          const isHealing = damageType.toLowerCase() === 'healing';\r\n          const rollName = isHealing ? `${spell.name || spellName} - Healing` : `${spell.name || spellName} - ${damageType}`;\r\n\r\n          // Scale formula for upcasting\r\n          const scaledFormula = scaleFormulaForUpcast(spell.damage, spellLevel, castLevel);\r\n\r\n          const damageMsg = formatRollForRoll20({\r\n            name: rollName,\r\n            formula: scaledFormula,\r\n            characterName: charName\r\n          });\r\n          postChatMessage(damageMsg);\r\n        }, 200);\r\n      }\r\n\r\n      sendResponse({ success: true });\r\n    } else if (request.action === 'useAbilityFromDiscord') {\r\n      debug.log('\u2728 Received useAbilityFromDiscord:', request);\r\n      const abilityName = request.abilityName || 'Unknown Ability';\r\n      const abilityData = request.abilityData || {};\r\n      const charName = abilityData.character_name || 'Character';\r\n      const action = abilityData.action_data || {};\r\n      const notificationColor = abilityData.notification_color || '#3498db';\r\n\r\n      // Get color emoji banner (matches popup-sheet getColoredBanner)\r\n      const colorEmoji = getColorEmoji(notificationColor);\r\n\r\n      // Build action announcement (matches popup-sheet announceAction)\r\n      let announcement = `&{template:default} {{name=${colorEmoji} ${charName} uses ${action.name || abilityName}!}}`;\r\n\r\n      // Add action type\r\n      if (action.actionType) {\r\n        announcement += ` {{Type=${action.actionType}}}`;\r\n      }\r\n\r\n      // Add range if available\r\n      if (action.range) {\r\n        announcement += ` {{Range=${action.range}}}`;\r\n      }\r\n\r\n      // Add description if available\r\n      if (action.description) {\r\n        announcement += ` {{Description=${action.description}}}`;\r\n      }\r\n\r\n      // Post the announcement\r\n      postChatMessage(announcement);\r\n\r\n      // Roll attack if action has attack roll\r\n      if (action.attackRoll || action.attackBonus) {\r\n        setTimeout(() => {\r\n          const attackFormula = action.attackRoll || `1d20+${action.attackBonus}`;\r\n          const attackMsg = formatRollForRoll20({\r\n            name: `${action.name || abilityName} - Attack`,\r\n            formula: attackFormula,\r\n            characterName: charName\r\n          });\r\n          postChatMessage(attackMsg);\r\n        }, 100);\r\n      }\r\n\r\n      // Roll damage if available\r\n      if (action.damageRoll || action.damage) {\r\n        setTimeout(() => {\r\n          const damageFormula = action.damageRoll || action.damage;\r\n          const damageType = action.damageType || 'damage';\r\n          const isHealing = damageType.toLowerCase() === 'healing';\r\n          const rollName = isHealing ? `${action.name || abilityName} - Healing` : `${action.name || abilityName} - ${damageType}`;\r\n          const damageMsg = formatRollForRoll20({\r\n            name: rollName,\r\n            formula: damageFormula,\r\n            characterName: charName\r\n          });\r\n          postChatMessage(damageMsg);\r\n        }, 200);\r\n      }\r\n\r\n      sendResponse({ success: true });\r\n    } else if (request.action === 'endTurnFromDiscord') {\r\n      debug.log('\u23ED\uFE0F Received endTurnFromDiscord');\r\n      postChatMessage('/e ends their turn.');\r\n      sendResponse({ success: true });\r\n    }\r\n  });\r\n\r\n  /**\r\n   * Listen for messages from popup windows\r\n   */\r\n  window.addEventListener('message', (event) => {\r\n    if (event.data.action === 'postRollToChat') {\r\n      handleDiceCloudRoll(event.data.roll);\r\n    } else if (event.data.action === 'postChat') {\r\n      // Handle general chat messages (like spell descriptions)\r\n      postChatMessage(event.data.message);\r\n    } else if (event.data.action === 'rollFromPopout') {\r\n      // Post roll directly to Roll20 - no DiceCloud needed!\r\n      debug.log('\uD83C\uDFB2 Received roll request from popup via postMessage:', event.data);\r\n\r\n      const rollData = {\r\n        name: event.data.name,\r\n        formula: event.data.formula,\r\n        characterName: event.data.characterName\r\n      };\r\n\r\n      // Check if silent rolls mode is enabled - if so, hide the roll instead of posting\r\n      if (silentRollsEnabled) {\r\n        debug.log('\uD83D\uDD07 Silent rolls active - hiding roll instead of posting');\r\n        const hiddenRoll = {\r\n          id: Date.now() + Math.random(), // Unique ID\r\n          name: rollData.name,\r\n          formula: rollData.formula,\r\n          characterName: rollData.characterName,\r\n          timestamp: new Date().toLocaleTimeString(),\r\n          result: null // Will be filled when revealed\r\n        };\r\n        hiddenRolls.push(hiddenRoll);\r\n        updateHiddenRollsDisplay();\r\n\r\n        // Send confirmation back to popup\r\n        if (event.source) {\r\n          event.source.postMessage({\r\n            action: 'rollHidden',\r\n            roll: hiddenRoll\r\n          }, '*');\r\n        }\r\n      } else {\r\n        // Normal flow - post to Roll20 chat\r\n        const formattedMessage = formatRollForRoll20(rollData);\r\n        const success = postChatMessage(formattedMessage);\r\n\r\n        if (success) {\r\n          debug.log('\u2705 Roll posted directly to Roll20 (no DiceCloud!)');\r\n          // Observe Roll20's result for natural 1s/20s\r\n          observeNextRollResult(rollData);\r\n        }\r\n      }\r\n    } else if (event.data.action === 'announceSpell') {\r\n      // Handle spell/action announcements with pre-formatted messages\r\n      if (event.data.message) {\r\n        postChatMessage(event.data.message);\r\n      } else {\r\n        handleDiceCloudRoll(event.data);\r\n      }\r\n    }\r\n  });\r\n\r\n  // ============================================================================\r\n  // GM INITIATIVE TRACKER\r\n  // ============================================================================\r\n\r\n  let gmModeEnabled = false;\r\n  let silentRollsEnabled = false; // Separate toggle for silent rolls\r\n  let gmPanel = null;\r\n  const characterPopups = {}; // Track popup windows by character name\r\n  let combatStarted = false; // Track if combat has been initiated\r\n  let initiativeTracker = {\r\n    combatants: [],\r\n    currentTurnIndex: 0,\r\n    round: 1,\r\n    delayedCombatants: [] // Track combatants who have delayed their turn\r\n  };\r\n  let hiddenRolls = []; // Store hidden GM rolls\r\n  let turnHistory = []; // Store turn history for logging\r\n  let playerData = {}; // Store player overview data { characterName: { hp, maxHp, ac, etc } }\r\n\r\n  /**\r\n   * Create GM Initiative Tracker Panel\r\n   */\r\n  function createGMPanel() {\r\n    if (gmPanel) return gmPanel;\r\n\r\n    // Create panel\r\n    gmPanel = document.createElement('div');\r\n    gmPanel.id = 'gm-panel';\r\n    gmPanel.style.cssText = `\r\n      position: fixed;\r\n      top: 20px;\r\n      right: 20px;\r\n      width: 500px;\r\n      height: 600px;\r\n      min-width: 400px;\r\n      min-height: 400px;\r\n      max-width: 90vw;\r\n      max-height: 90vh;\r\n      background: #1e1e1e;\r\n      border: 2px solid #4ECDC4;\r\n      border-radius: 12px;\r\n      z-index: 999998;\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\r\n      font-size: 14px;\r\n      color: #fff;\r\n      box-shadow: 0 8px 32px rgba(0,0,0,0.5);\r\n      display: none;\r\n      flex-direction: column;\r\n      overflow: hidden;\r\n      resize: both;\r\n      visibility: visible;\r\n      opacity: 1;\r\n    `;\r\n\r\n    // Create tab content containers\r\n    const initiativeTab = document.createElement('div');\r\n    initiativeTab.className = 'gm-tab-content';\r\n    initiativeTab.dataset.tab = 'initiative';\r\n    initiativeTab.style.display = 'block';\r\n\r\n    const hiddenRollsTab = document.createElement('div');\r\n    hiddenRollsTab.className = 'gm-tab-content';\r\n    hiddenRollsTab.dataset.tab = 'hidden-rolls';\r\n    hiddenRollsTab.style.display = 'none';\r\n\r\n    const playersTab = document.createElement('div');\r\n    playersTab.className = 'gm-tab-content';\r\n    playersTab.dataset.tab = 'players';\r\n    playersTab.style.display = 'none';\r\n\r\n    const historyTab = document.createElement('div');\r\n    historyTab.className = 'gm-tab-content';\r\n    historyTab.dataset.tab = 'history';\r\n    historyTab.style.display = 'none';\r\n\r\n    // ===== INITIATIVE TAB CONTENT =====\r\n    const controls = document.createElement('div');\r\n    controls.style.cssText = `\r\n      display: grid;\r\n      grid-template-columns: 1fr 1fr;\r\n      gap: 8px;\r\n      margin-bottom: 15px;\r\n    `;\r\n    controls.innerHTML = `\r\n      <button id=\"start-combat-btn\" style=\"padding: 12px; background: #27ae60; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; grid-column: span 2; box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);\">\u2694\uFE0F Start Combat</button>\r\n      <button id=\"prev-turn-btn\" style=\"padding: 8px 12px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em; display: none;\">\u2190 Prev</button>\r\n      <button id=\"next-turn-btn\" style=\"padding: 8px 12px; background: #4ECDC4; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em; display: none;\">Next \u2192</button>\r\n      <button id=\"clear-all-btn\" style=\"padding: 8px 12px; background: #e74c3c; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em; grid-column: span 2;\">\uD83D\uDDD1\uFE0F Clear All</button>\r\n    `;\r\n\r\n    const roundDisplay = document.createElement('div');\r\n    roundDisplay.id = 'round-display';\r\n    roundDisplay.style.cssText = `\r\n      text-align: center;\r\n      padding: 8px;\r\n      background: #34495e;\r\n      border-radius: 6px;\r\n      margin-bottom: 15px;\r\n      font-weight: bold;\r\n    `;\r\n    roundDisplay.textContent = 'Round 1';\r\n\r\n    const initiativeList = document.createElement('div');\r\n    initiativeList.id = 'initiative-list';\r\n    initiativeList.style.cssText = `\r\n      display: flex;\r\n      flex-direction: column;\r\n      gap: 8px;\r\n      margin-bottom: 15px;\r\n    `;\r\n\r\n    const addFormSection = document.createElement('div');\r\n    addFormSection.style.cssText = `\r\n      margin-top: 15px;\r\n      padding-top: 15px;\r\n      border-top: 2px solid #34495e;\r\n    `;\r\n\r\n    const addFormHeader = document.createElement('div');\r\n    addFormHeader.style.cssText = `\r\n      cursor: pointer;\r\n      user-select: none;\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      padding: 8px;\r\n      margin-bottom: 10px;\r\n      background: #34495e;\r\n      border-radius: 6px;\r\n      font-weight: bold;\r\n      transition: background 0.2s;\r\n    `;\r\n    addFormHeader.innerHTML = `\r\n      <span>\u2795 Add Combatant</span>\r\n      <span id=\"add-form-toggle\" style=\"transition: transform 0.3s; transform: rotate(-90deg);\">\u25BC</span>\r\n    `;\r\n\r\n    const addForm = document.createElement('div');\r\n    addForm.id = 'add-combatant-form';\r\n    addForm.style.cssText = `\r\n      display: block;\r\n      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;\r\n      overflow: hidden;\r\n      max-height: 0;\r\n      opacity: 0;\r\n    `;\r\n    addForm.innerHTML = `\r\n      <input type=\"text\" id=\"combatant-name-input\" placeholder=\"Combatant name\" style=\"width: 100%; padding: 8px; margin-bottom: 8px; border: 2px solid #34495e; border-radius: 4px; background: #34495e; color: #fff; font-size: 0.9em;\" />\r\n      <input type=\"number\" id=\"combatant-init-input\" placeholder=\"Initiative\" style=\"width: 100%; padding: 8px; margin-bottom: 8px; border: 2px solid #34495e; border-radius: 4px; background: #34495e; color: #fff; font-size: 0.9em;\" />\r\n      <button id=\"add-combatant-btn\" style=\"width: 100%; padding: 8px 12px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;\">\u2795 Add</button>\r\n    `;\r\n\r\n    addFormSection.appendChild(addFormHeader);\r\n    addFormSection.appendChild(addForm);\r\n\r\n    // Add initiative content to initiative tab\r\n    initiativeTab.appendChild(controls);\r\n    initiativeTab.appendChild(roundDisplay);\r\n    initiativeTab.appendChild(initiativeList);\r\n    initiativeTab.appendChild(addFormSection);\r\n\r\n    // ===== HIDDEN ROLLS TAB CONTENT =====\r\n    hiddenRollsTab.innerHTML = `\r\n      <div style=\"text-align: center; padding: 20px; color: #888;\">\r\n        <div style=\"font-size: 3em; margin-bottom: 10px;\">\uD83C\uDFB2</div>\r\n        <p style=\"margin: 0;\">No hidden rolls yet</p>\r\n        <p style=\"font-size: 0.85em; margin-top: 8px;\">Rolls made while GM Mode is active will appear here</p>\r\n      </div>\r\n      <div id=\"hidden-rolls-list\" style=\"display: flex; flex-direction: column; gap: 8px;\"></div>\r\n    `;\r\n\r\n    // ===== PLAYER OVERVIEW TAB CONTENT =====\r\n    playersTab.innerHTML = `\r\n      <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;\">\r\n        <h3 style=\"margin: 0; font-size: 1.2em; color: #4ECDC4;\">Party Overview</h3>\r\n        <div style=\"display: flex; gap: 8px;\">\r\n          <button id=\"import-players-btn\" style=\"padding: 8px 14px; background: #27ae60; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: bold;\">\uD83D\uDCE5 Import</button>\r\n          <button id=\"refresh-players-btn\" style=\"padding: 8px 14px; background: #9b59b6; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: bold;\">\uD83D\uDD04 Refresh</button>\r\n        </div>\r\n      </div>\r\n      <div style=\"text-align: center; padding: 20px; color: #888;\">\r\n        <div style=\"font-size: 3em; margin-bottom: 10px;\">\uD83D\uDC65</div>\r\n        <p style=\"margin: 0; font-size: 1.1em;\">No players tracked yet</p>\r\n        <p style=\"font-size: 1em; margin-top: 8px;\">Click Import to load character data from storage</p>\r\n      </div>\r\n      <div id=\"player-overview-list\" style=\"display: flex; flex-direction: column; gap: 10px;\"></div>\r\n    `;\r\n\r\n    // ===== TURN HISTORY TAB CONTENT =====\r\n    historyTab.innerHTML = `\r\n      <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;\">\r\n        <h3 style=\"margin: 0; font-size: 1em; color: #4ECDC4;\">Last 10 Turns</h3>\r\n        <button id=\"export-history-btn\" style=\"padding: 6px 12px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8em;\">\uD83D\uDCCB Copy</button>\r\n      </div>\r\n      <div id=\"turn-history-empty-state\" style=\"text-align: center; padding: 20px; color: #888;\">\r\n        <div style=\"font-size: 3em; margin-bottom: 10px;\">\uD83D\uDCDC</div>\r\n        <p style=\"margin: 0;\">No turn history yet</p>\r\n        <p style=\"font-size: 0.85em; margin-top: 8px;\">Combat actions will be logged here</p>\r\n      </div>\r\n      <div id=\"turn-history-list\" style=\"display: flex; flex-direction: column; gap: 8px;\"></div>\r\n    `;\r\n\r\n    // ===== CREATE HEADER =====\r\n    const header = document.createElement('div');\r\n    header.style.cssText = `\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      padding: 15px;\r\n      background: #1e1e1e;\r\n      border-bottom: 2px solid #4ECDC4;\r\n      cursor: move;\r\n      user-select: none;\r\n    `;\r\n    header.innerHTML = `\r\n      <div>\r\n        <h2 style=\"margin: 0; font-size: 1.2em; color: #4ECDC4;\">\uD83D\uDC51 GM Panel</h2>\r\n        <div style=\"display: flex; align-items: center; gap: 15px; margin-top: 8px;\">\r\n          <label style=\"display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: #aaa; cursor: pointer;\">\r\n            <input type=\"checkbox\" id=\"silent-rolls-toggle\" style=\"width: 16px; height: 16px; cursor: pointer;\" />\r\n            <span>\uD83D\uDD07 Silent Rolls</span>\r\n          </label>\r\n        </div>\r\n      </div>\r\n      <button id=\"gm-panel-close\" style=\"background: #e74c3c; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em;\">\u2716</button>\r\n    `;\r\n\r\n    // ===== CREATE TAB NAVIGATION =====\r\n    const tabNav = document.createElement('div');\r\n    tabNav.style.cssText = `\r\n      display: flex;\r\n      gap: 0;\r\n      background: #1e1e1e;\r\n      border-bottom: 1px solid #34495e;\r\n    `;\r\n    tabNav.innerHTML = `\r\n      <button class=\"gm-tab-btn\" data-tab=\"initiative\" style=\"flex: 1; padding: 12px; background: #2a2a2a; color: #4ECDC4; border: none; border-bottom: 3px solid #4ECDC4; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: all 0.2s;\">\u2694\uFE0F Initiative</button>\r\n      <button class=\"gm-tab-btn\" data-tab=\"history\" style=\"flex: 1; padding: 12px; background: transparent; color: #888; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: all 0.2s;\">\uD83D\uDCDC History</button>\r\n      <button class=\"gm-tab-btn\" data-tab=\"hidden-rolls\" style=\"flex: 1; padding: 12px; background: transparent; color: #888; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: all 0.2s;\">\uD83C\uDFB2 Hidden Rolls</button>\r\n      <button class=\"gm-tab-btn\" data-tab=\"players\" style=\"flex: 1; padding: 12px; background: transparent; color: #888; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: all 0.2s;\">\uD83D\uDC65 Players</button>\r\n    `;\r\n\r\n    // ===== CREATE CONTENT WRAPPER =====\r\n    const contentWrapper = document.createElement('div');\r\n    contentWrapper.style.cssText = `\r\n      padding: 15px;\r\n      background: #2a2a2a;\r\n      color: #fff;\r\n      border-radius: 0 0 12px 12px;\r\n      overflow-y: auto;\r\n      flex: 1;\r\n    `;\r\n\r\n    // Assemble all tabs into content wrapper\r\n    contentWrapper.appendChild(initiativeTab);\r\n    contentWrapper.appendChild(hiddenRollsTab);\r\n    contentWrapper.appendChild(playersTab);\r\n    contentWrapper.appendChild(historyTab);\r\n\r\n    // Assemble panel\r\n    gmPanel.appendChild(header);\r\n    gmPanel.appendChild(tabNav);\r\n    gmPanel.appendChild(contentWrapper);\r\n    document.body.appendChild(gmPanel);\r\n\r\n    // Make draggable\r\n    makeDraggable(gmPanel, header);\r\n\r\n    // Start listening for character broadcasts\r\n    startCharacterBroadcastListener();\r\n\r\n    // Load player data from storage\r\n    loadPlayerDataFromStorage();\r\n    \r\n    // Test storage functionality immediately\r\n    debug.log('\uD83E\uDDEA Testing storage functionality...');\r\n    \r\n    // Test 1: Promise-based API\r\n    if (browserAPI.storage.local.get instanceof Function) {\r\n      browserAPI.storage.local.get(['characterProfiles']).then(result => {\r\n        debug.log('\uD83E\uDDEA Promise storage test result:', result);\r\n        if (result.characterProfiles) {\r\n          debug.log('\uD83E\uDDEA Found characterProfiles:', Object.keys(result.characterProfiles));\r\n          Object.keys(result.characterProfiles).forEach(key => {\r\n            debug.log(`\uD83E\uDDEA Profile ${key}:`, result.characterProfiles[key].type);\r\n          });\r\n        } else {\r\n          debug.log('\uD83E\uDDEA No characterProfiles found in storage (Promise)');\r\n        }\r\n      }).catch(error => {\r\n        debug.error('\uD83E\uDDEA Promise storage error:', error);\r\n      });\r\n    }\r\n    \r\n    // Test 2: Callback-based API (fallback)\r\n    try {\r\n      browserAPI.storage.local.get(['characterProfiles'], (result) => {\r\n        debug.log('\uD83E\uDDEA Callback storage test result:', result);\r\n        if (browserAPI.runtime.lastError) {\r\n          debug.error('\uD83E\uDDEA Callback storage error:', browserAPI.runtime.lastError);\r\n        } else if (result.characterProfiles) {\r\n          debug.log('\uD83E\uDDEA Found characterProfiles (callback):', Object.keys(result.characterProfiles));\r\n        } else {\r\n          debug.log('\uD83E\uDDEA No characterProfiles found in storage (callback)');\r\n        }\r\n      });\r\n    } catch (error) {\r\n      debug.error('\uD83E\uDDEA Callback storage test failed:', error);\r\n    }\r\n\r\n    // Attach event listeners\r\n    attachGMPanelListeners();\r\n\r\n    debug.log('\u2705 GM Panel created');\r\n    return gmPanel;\r\n  }\r\n\r\n  /**\r\n   * Start listening for character broadcasts from players\r\n   */\r\n  function startCharacterBroadcastListener() {\r\n    // Monitor chat for character broadcasts\r\n    const chatObserver = new MutationObserver((mutations) => {\r\n      mutations.forEach((mutation) => {\r\n        mutation.addedNodes.forEach((node) => {\r\n          if (node.nodeType === Node.ELEMENT_NODE) {\r\n            // Check for character broadcast messages\r\n            const messageContent = node.textContent || node.innerText || '';\r\n            debug.log('\uD83D\uDD0D Chat message detected:', messageContent.substring(0, 100));\r\n            if (messageContent.includes('\uD83D\uDC51[ROLLCLOUD:CHARACTER:') && messageContent.includes(']\uD83D\uDC51')) {\r\n              debug.log('\uD83D\uDC51 Detected character broadcast in chat');\r\n              parseCharacterBroadcast(messageContent);\r\n            }\r\n          }\r\n        });\r\n      });\r\n    });\r\n\r\n    // Find the chat container and observe it\r\n    const chatContainer = document.querySelector('.chat-content') || \r\n                         document.querySelector('.chatlog') || \r\n                         document.querySelector('#textchat') ||\r\n                         document.querySelector('.chat');\r\n\r\n    if (chatContainer) {\r\n      chatObserver.observe(chatContainer, {\r\n        childList: true,\r\n        subtree: true\r\n      });\r\n      debug.log('\uD83D\uDC51 Started listening for character broadcasts in chat');\r\n    } else {\r\n      debug.warn('\u26A0\uFE0F Could not find chat container for character broadcast listener');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parse character broadcast message and import data\r\n   */\r\n  function parseCharacterBroadcast(message) {\r\n    try {\r\n      // Extract the encoded data\r\n      const match = message.match(/\uD83D\uDC51\\[ROLLCLOUD:CHARACTER:(.+?)\\]\uD83D\uDC51/);\r\n      if (!match) {\r\n        debug.warn('\u26A0\uFE0F Invalid character broadcast format');\r\n        return;\r\n      }\r\n\r\n      const encodedData = match[1];\r\n      const decodedData = JSON.parse(decodeURIComponent(escape(atob(encodedData))));\r\n      \r\n      if (decodedData.type !== 'ROLLCLOUD_CHARACTER_BROADCAST') {\r\n        debug.warn('\u26A0\uFE0F Not a character broadcast message');\r\n        return;\r\n      }\r\n\r\n      const character = decodedData.character;\r\n      const fullSheet = decodedData.fullSheet || character; // Use full sheet if available\r\n      debug.log('\uD83D\uDC51 Received character broadcast:', character.name);\r\n      debug.log('\uD83D\uDD0D Full sheet data keys:', fullSheet ? Object.keys(fullSheet) : 'null');\r\n      debug.log('\uD83D\uDD0D Full sheet sample:', fullSheet ? JSON.stringify(fullSheet, null, 2).substring(0, 500) + '...' : 'null');\r\n\r\n      // Import COMPLETE character data to GM panel\r\n      updatePlayerData(character.name, fullSheet);\r\n      \r\n      // Show notification to GM\r\n      debug.log(`\u2705 ${character.name} shared their character sheet! \uD83D\uDC51`);\r\n      \r\n    } catch (error) {\r\n      debug.error('\u274C Error parsing character broadcast:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Make element draggable with boundary constraints\r\n   */\r\n  function makeDraggable(element, handle) {\r\n    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;\r\n    handle.onmousedown = dragMouseDown;\r\n\r\n    function dragMouseDown(e) {\r\n      e.preventDefault();\r\n      pos3 = e.clientX;\r\n      pos4 = e.clientY;\r\n      document.onmouseup = closeDragElement;\r\n      document.onmousemove = elementDrag;\r\n    }\r\n\r\n    function elementDrag(e) {\r\n      e.preventDefault();\r\n      pos1 = pos3 - e.clientX;\r\n      pos2 = pos4 - e.clientY;\r\n      pos3 = e.clientX;\r\n      pos4 = e.clientY;\r\n\r\n      // Use requestAnimationFrame to avoid forced reflow\r\n      requestAnimationFrame(() => {\r\n        // Read layout properties first (batched reads)\r\n        const offsetTop = element.offsetTop;\r\n        const offsetLeft = element.offsetLeft;\r\n        const offsetWidth = element.offsetWidth;\r\n        const offsetHeight = element.offsetHeight;\r\n        const viewportWidth = window.innerWidth;\r\n        const viewportHeight = window.innerHeight;\r\n\r\n        // Calculate new position\r\n        let newTop = offsetTop - pos2;\r\n        let newLeft = offsetLeft - pos1;\r\n\r\n        // Apply boundary constraints\r\n        const minTop = 0;\r\n        const minLeft = 0;\r\n        const maxLeft = viewportWidth - offsetWidth;\r\n        const maxTop = viewportHeight - offsetHeight;\r\n\r\n        // Constrain within viewport\r\n        newTop = Math.max(minTop, Math.min(newTop, maxTop));\r\n        newLeft = Math.max(minLeft, Math.min(newLeft, maxLeft));\r\n\r\n        // Batch all style writes together\r\n        element.style.top = newTop + \"px\";\r\n        element.style.left = newLeft + \"px\";\r\n        element.style.right = 'auto';\r\n      });\r\n    }\r\n\r\n    function closeDragElement() {\r\n      document.onmouseup = null;\r\n      document.onmousemove = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Attach event listeners to GM panel controls\r\n   */\r\n  function attachGMPanelListeners() {\r\n    // Silent rolls toggle\r\n    const silentRollsToggle = document.getElementById('silent-rolls-toggle');\r\n    if (silentRollsToggle) {\r\n      silentRollsToggle.addEventListener('change', (e) => {\r\n        silentRollsEnabled = e.target.checked;\r\n        debug.log(`\uD83D\uDD07 Silent rolls ${silentRollsEnabled ? 'enabled' : 'disabled'}`);\r\n        \r\n        // Update hidden rolls tab description\r\n        const hiddenRollsTab = gmPanel.querySelector('[data-tab=\"hidden-rolls\"]');\r\n        if (hiddenRollsTab) {\r\n          const description = hiddenRollsTab.querySelector('p:nth-child(2)');\r\n          if (description) {\r\n            description.textContent = silentRollsEnabled \r\n              ? 'Rolls made while silent rolls is enabled will appear here'\r\n              : 'Rolls made while GM Mode is active will appear here';\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    // Tab switching\r\n    const tabButtons = gmPanel.querySelectorAll('.gm-tab-btn');\r\n    const tabContents = gmPanel.querySelectorAll('.gm-tab-content');\r\n\r\n    tabButtons.forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        const targetTab = btn.dataset.tab;\r\n\r\n        // Update button styles\r\n        tabButtons.forEach(b => {\r\n          if (b.dataset.tab === targetTab) {\r\n            b.style.background = '#2a2a2a';\r\n            b.style.color = '#4ECDC4';\r\n            b.style.borderBottom = '3px solid #4ECDC4';\r\n          } else {\r\n            b.style.background = 'transparent';\r\n            b.style.color = '#888';\r\n            b.style.borderBottom = '3px solid transparent';\r\n          }\r\n        });\r\n\r\n        // Show target tab content, hide others\r\n        tabContents.forEach(content => {\r\n          content.style.display = content.dataset.tab === targetTab ? 'block' : 'none';\r\n        });\r\n\r\n        debug.log(`\uD83D\uDCD1 Switched to GM tab: ${targetTab}`);\r\n      });\r\n    });\r\n\r\n    // Close button\r\n    const closeBtn = document.getElementById('gm-panel-close');\r\n    if (closeBtn) {\r\n      closeBtn.addEventListener('click', () => toggleGMMode(false));\r\n    }\r\n\r\n    // Turn controls\r\n    const startCombatBtn = document.getElementById('start-combat-btn');\r\n    const nextBtn = document.getElementById('next-turn-btn');\r\n    const prevBtn = document.getElementById('prev-turn-btn');\r\n    const clearAllBtn = document.getElementById('clear-all-btn');\r\n\r\n    debug.log('\uD83D\uDD0D GM Panel controls found:', {\r\n      startCombatBtn: !!startCombatBtn,\r\n      nextBtn: !!nextBtn,\r\n      prevBtn: !!prevBtn,\r\n      clearAllBtn: !!clearAllBtn\r\n    });\r\n\r\n    if (startCombatBtn) startCombatBtn.addEventListener('click', startCombat);\r\n    if (nextBtn) nextBtn.addEventListener('click', nextTurn);\r\n    if (prevBtn) prevBtn.addEventListener('click', prevTurn);\r\n    if (clearAllBtn) clearAllBtn.addEventListener('click', clearAllCombatants);\r\n\r\n    // Collapsible add form toggle\r\n    const addFormHeader = gmPanel.querySelector('div[style*=\"cursor: pointer\"]');\r\n    const addForm = document.getElementById('add-combatant-form');\r\n    const addFormToggle = document.getElementById('add-form-toggle');\r\n    let isFormCollapsed = true; // Start collapsed\r\n\r\n    if (addFormHeader && addForm && addFormToggle) {\r\n      addFormHeader.addEventListener('click', () => {\r\n        isFormCollapsed = !isFormCollapsed;\r\n        if (isFormCollapsed) {\r\n          addForm.style.maxHeight = '0';\r\n          addForm.style.opacity = '0';\r\n          addFormToggle.style.transform = 'rotate(-90deg)';\r\n        } else {\r\n          addForm.style.maxHeight = '500px';\r\n          addForm.style.opacity = '1';\r\n          addFormToggle.style.transform = 'rotate(0deg)';\r\n        }\r\n      });\r\n    }\r\n\r\n    // Add combatant form\r\n    const addBtn = document.getElementById('add-combatant-btn');\r\n    const nameInput = document.getElementById('combatant-name-input');\r\n    const initInput = document.getElementById('combatant-init-input');\r\n\r\n    if (addBtn && nameInput && initInput) {\r\n      addBtn.addEventListener('click', () => {\r\n        const name = nameInput.value.trim();\r\n        const initiative = parseInt(initInput.value);\r\n        if (name && !isNaN(initiative)) {\r\n          addCombatant(name, initiative, 'manual');\r\n          nameInput.value = '';\r\n          initInput.value = '';\r\n        }\r\n      });\r\n\r\n      // Enter key to add\r\n      initInput.addEventListener('keypress', (e) => {\r\n        if (e.key === 'Enter') {\r\n          addBtn.click();\r\n        }\r\n      });\r\n    }\r\n\r\n    // Export turn history button\r\n    const exportHistoryBtn = document.getElementById('export-history-btn');\r\n    if (exportHistoryBtn) {\r\n      exportHistoryBtn.addEventListener('click', exportTurnHistory);\r\n    }\r\n\r\n    // Import players button\r\n    const importPlayersBtn = document.getElementById('import-players-btn');\r\n    if (importPlayersBtn) {\r\n      importPlayersBtn.addEventListener('click', importPlayerData);\r\n    }\r\n\r\n    // Refresh players button\r\n    const refreshPlayersBtn = document.getElementById('refresh-players-btn');\r\n    if (refreshPlayersBtn) {\r\n      refreshPlayersBtn.addEventListener('click', () => {\r\n        updatePlayerOverviewDisplay();\r\n        debug.log('\uD83D\uDD04 Refreshed player overview');\r\n      });\r\n    }\r\n\r\n    debug.log('\u2705 GM Panel listeners attached');\r\n  }\r\n\r\n  /**\r\n   * Update Hidden Rolls Display\r\n   */\r\n  function updateHiddenRollsDisplay() {\r\n    const hiddenRollsList = document.getElementById('hidden-rolls-list');\r\n    if (!hiddenRollsList) return;\r\n\r\n    if (hiddenRolls.length === 0) {\r\n      hiddenRollsList.innerHTML = '';\r\n      // Show empty state if tab content exists\r\n      const tabContent = gmPanel.querySelector('[data-tab=\"hidden-rolls\"]');\r\n      if (tabContent) {\r\n        const emptyState = tabContent.querySelector('div[style*=\"text-align: center\"]');\r\n        if (emptyState) emptyState.style.display = 'block';\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Hide empty state\r\n    const tabContent = gmPanel.querySelector('[data-tab=\"hidden-rolls\"]');\r\n    if (tabContent) {\r\n      const emptyState = tabContent.querySelector('div[style*=\"text-align: center\"]');\r\n      if (emptyState) emptyState.style.display = 'none';\r\n    }\r\n\r\n    hiddenRollsList.innerHTML = hiddenRolls.map((roll, index) => `\r\n      <div style=\"background: #34495e; padding: 12px; border-radius: 8px; border-left: 4px solid #f39c12;\">\r\n        <div style=\"display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;\">\r\n          <div style=\"flex: 1;\">\r\n            <div style=\"font-weight: bold; color: #f39c12; margin-bottom: 4px;\">${roll.characterName}</div>\r\n            <div style=\"font-size: 0.9em; color: #ccc;\">${roll.name}</div>\r\n            <div style=\"font-size: 0.85em; color: #888; margin-top: 4px;\">${roll.timestamp}</div>\r\n          </div>\r\n          <div style=\"font-size: 1.2em; color: #f39c12;\">\uD83D\uDD12</div>\r\n        </div>\r\n        <div style=\"background: #2c3e50; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 0.9em; margin-bottom: 10px;\">\r\n          ${roll.formula}\r\n        </div>\r\n        <div style=\"display: flex; gap: 8px;\">\r\n          <button class=\"reveal-roll-btn\" data-roll-id=\"${roll.id}\" style=\"flex: 1; padding: 8px; background: #27ae60; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em;\">\r\n            \uD83D\uDCE2 Publish Roll\r\n          </button>\r\n          <button class=\"delete-roll-btn\" data-roll-id=\"${roll.id}\" style=\"padding: 8px 12px; background: #e74c3c; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em;\">\r\n            \uD83D\uDDD1\uFE0F\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `).join('');\r\n\r\n    // Add event listeners to reveal and delete roll buttons\r\n    const revealRollBtns = hiddenRollsList.querySelectorAll('.reveal-roll-btn');\r\n    const deleteRollBtns = hiddenRollsList.querySelectorAll('.delete-roll-btn');\r\n\r\n    revealRollBtns.forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        const rollId = btn.dataset.rollId;\r\n        revealHiddenRoll(rollId);\r\n      });\r\n    });\r\n\r\n    deleteRollBtns.forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        const rollId = btn.dataset.rollId;\r\n        deleteHiddenRoll(rollId);\r\n      });\r\n    });\r\n\r\n    debug.log(`\uD83D\uDCCB Updated hidden rolls display: ${hiddenRolls.length} rolls`);\r\n  }\r\n\r\n  /**\r\n   * Reveal a hidden roll (post it to Roll20 chat)\r\n   */\r\n  window.revealHiddenRoll = function(rollId) {\r\n    const rollIndex = hiddenRolls.findIndex(r => r.id === rollId);\r\n    if (rollIndex === -1) return;\r\n\r\n    const roll = hiddenRolls[rollIndex];\r\n    debug.log('\uD83D\uDD13 Revealing hidden roll:', roll);\r\n\r\n    // Format the message as \"GM roll: [Name] rolled [roll name]! **[calculated value]**\"\r\n    // Use Roll20's inline roll syntax [[formula]] to evaluate the roll\r\n    const formattedMessage = `GM roll: **${roll.characterName}** rolled ${roll.name}! **[[${roll.formula}]]**`;\r\n    const success = postChatMessage(formattedMessage);\r\n\r\n    if (success) {\r\n      debug.log('\u2705 Hidden roll revealed to Roll20');\r\n      // Remove from hidden rolls\r\n      hiddenRolls.splice(rollIndex, 1);\r\n      updateHiddenRollsDisplay();\r\n    } else {\r\n      debug.error('\u274C Failed to reveal hidden roll');\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Delete a hidden roll without revealing\r\n   */\r\n  window.deleteHiddenRoll = function(rollId) {\r\n    const rollIndex = hiddenRolls.findIndex(r => r.id === rollId);\r\n    if (rollIndex === -1) return;\r\n\r\n    hiddenRolls.splice(rollIndex, 1);\r\n    updateHiddenRollsDisplay();\r\n    debug.log('\uD83D\uDDD1\uFE0F Deleted hidden roll');\r\n  };\r\n\r\n  /**\r\n   * Create player header HTML\r\n   */\r\n  function createPlayerHeader(name, player, playerId) {\r\n    const hpPercent = player.maxHp > 0 ? (player.hp / player.maxHp) * 100 : 0;\r\n    const hpColor = hpPercent > 50 ? '#27ae60' : hpPercent > 25 ? '#f39c12' : '#e74c3c';\r\n    \r\n    return `\r\n      <div style=\"background: #34495e; border-radius: 8px; border-left: 4px solid ${hpColor}; overflow: hidden;\">\r\n        <!-- Player Header (always visible) -->\r\n        <div class=\"player-header-btn\" data-player-name=\"${name}\" style=\"padding: 12px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;\" onmouseover=\"this.style.background='#3d5a6e'\" onmouseout=\"this.style.background='transparent'\">\r\n          <div style=\"flex: 1;\">\r\n            <div style=\"font-weight: bold; font-size: 1.1em; color: #4ECDC4; margin-bottom: 4px;\">${name}</div>\r\n            <div style=\"display: flex; gap: 12px; font-size: 0.95em; color: #ccc;\">\r\n              <span>HP: ${player.hp}/${player.maxHp}</span>\r\n              <span>AC: ${player.ac || '\u2014'}</span>\r\n              <span>Init: ${player.initiative || '\u2014'}</span>\r\n            </div>\r\n          </div>\r\n          <div style=\"display: flex; align-items: center; gap: 8px;\">\r\n            <span id=\"${playerId}-toggle\" style=\"transition: transform 0.3s; transform: rotate(-90deg); color: #888; font-size: 1.1em;\">\u25BC</span>\r\n            <button class=\"player-delete-btn\" data-player-name=\"${name}\" style=\"padding: 4px 8px; background: #e74c3c; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: bold;\" title=\"Remove player\">\uD83D\uDDD1\uFE0F</button>\r\n          </div>\r\n        </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Update Player Overview Display\r\n   */\r\n  function updatePlayerOverviewDisplay() {\r\n    const playerOverviewList = document.getElementById('player-overview-list');\r\n    if (!playerOverviewList) return;\r\n\r\n    const players = Object.keys(playerData);\r\n\r\n    if (players.length === 0) {\r\n      playerOverviewList.innerHTML = '';\r\n      // Show empty state\r\n      const tabContent = gmPanel.querySelector('[data-tab=\"players\"]');\r\n      if (tabContent) {\r\n        const emptyState = tabContent.querySelector('div[style*=\"text-align: center\"]');\r\n        if (emptyState) emptyState.style.display = 'block';\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Hide empty state\r\n    const tabContent = gmPanel.querySelector('[data-tab=\"players\"]');\r\n    if (tabContent) {\r\n      const emptyState = tabContent.querySelector('div[style*=\"text-align: center\"]');\r\n      if (emptyState) emptyState.style.display = 'none';\r\n    }\r\n\r\n    playerOverviewList.innerHTML = players.map((name, index) => {\r\n      const player = playerData[name];\r\n      const playerId = `player-${index}`;\r\n      const hpPercent = player.maxHp > 0 ? (player.hp / player.maxHp) * 100 : 0;\r\n      const hpColor = hpPercent > 50 ? '#27ae60' : hpPercent > 25 ? '#f39c12' : '#e74c3c';\r\n\r\n      return createPlayerHeader(name, player, playerId) + `\r\n\r\n          <!-- Detailed View (collapsible) -->\r\n          <div id=\"${playerId}-details\" style=\"max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.3s ease-out;\">\r\n            <div style=\"padding: 0 12px 12px 12px;\">\r\n              <!-- Character Sub-tabs -->\r\n              <div style=\"display: flex; gap: 4px; margin-bottom: 10px; border-bottom: 1px solid #2c3e50;\">\r\n                <button class=\"player-subtab-btn\" data-player=\"${playerId}\" data-subtab=\"overview\" style=\"padding: 8px 12px; background: transparent; color: #4ECDC4; border: none; border-bottom: 2px solid #4ECDC4; cursor: pointer; font-size: 0.9em; font-weight: bold;\">Overview</button>\r\n                <button class=\"player-subtab-btn\" data-player=\"${playerId}\" data-subtab=\"combat\" style=\"padding: 8px 12px; background: transparent; color: #888; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 0.9em;\">Combat</button>\r\n                <button class=\"player-subtab-btn\" data-player=\"${playerId}\" data-subtab=\"status\" style=\"padding: 8px 12px; background: transparent; color: #888; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 0.9em;\">Status</button>\r\n              </div>\r\n\r\n              <!-- Overview Tab -->\r\n              <div class=\"player-subtab-content\" data-player=\"${playerId}\" data-subtab=\"overview\" style=\"display: block;\">\r\n                <!-- HP Bar -->\r\n                <div style=\"margin-bottom: 10px;\">\r\n                  <div style=\"display: flex; justify-content: space-between; font-size: 0.95em; color: #ccc; margin-bottom: 4px;\">\r\n                    <span>Hit Points</span>\r\n                    <span>${player.hp}/${player.maxHp}</span>\r\n                  </div>\r\n                  <div style=\"width: 100%; height: 12px; background: #2c3e50; border-radius: 5px; overflow: hidden;\">\r\n                    <div style=\"width: ${hpPercent}%; height: 100%; background: ${hpColor}; transition: width 0.3s;\"></div>\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- Stats Grid -->\r\n                <div style=\"display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;\">\r\n                  <div style=\"background: #2c3e50; padding: 8px; border-radius: 4px; text-align: center;\">\r\n                    <div style=\"font-size: 0.85em; color: #888;\">Armor Class</div>\r\n                    <div style=\"font-weight: bold; color: #fff; font-size: 1.3em;\">${player.ac || '\u2014'}</div>\r\n                  </div>\r\n                  <div style=\"background: #2c3e50; padding: 8px; border-radius: 4px; text-align: center;\">\r\n                    <div style=\"font-size: 0.85em; color: #888;\">Passive Perception</div>\r\n                    <div style=\"font-weight: bold; color: #fff; font-size: 1.3em;\">${player.passivePerception || '\u2014'}</div>\r\n                  </div>\r\n                  <div style=\"background: #2c3e50; padding: 8px; border-radius: 4px; text-align: center;\">\r\n                    <div style=\"font-size: 0.85em; color: #888;\">Initiative</div>\r\n                    <div style=\"font-weight: bold; color: #fff; font-size: 1.3em;\">${player.initiative || '\u2014'}</div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <!-- Combat Tab -->\r\n              <div class=\"player-subtab-content\" data-player=\"${playerId}\" data-subtab=\"combat\" style=\"display: none;\">\r\n                <div style=\"background: #2c3e50; padding: 10px; border-radius: 4px; margin-bottom: 8px;\">\r\n                  <div style=\"font-size: 0.95em; color: #888; margin-bottom: 6px;\">Attack Roll</div>\r\n                  <div style=\"font-size: 0.9em; color: #ccc;\">Click character sheet to make attacks</div>\r\n                </div>\r\n                <div style=\"background: #2c3e50; padding: 10px; border-radius: 4px;\">\r\n                  <div style=\"font-size: 0.95em; color: #888; margin-bottom: 6px;\">Combat Stats</div>\r\n                  <div style=\"display: flex; justify-content: space-between; margin-bottom: 4px;\">\r\n                    <span style=\"font-size: 0.9em; color: #ccc;\">AC:</span>\r\n                    <span style=\"font-size: 0.9em; color: #fff; font-weight: bold;\">${player.ac || '\u2014'}</span>\r\n                  </div>\r\n                  <div style=\"display: flex; justify-content: space-between;\">\r\n                    <span style=\"font-size: 0.9em; color: #ccc;\">Initiative:</span>\r\n                    <span style=\"font-size: 0.9em; color: #fff; font-weight: bold;\">${player.initiative || '\u2014'}</span>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <!-- Status Tab -->\r\n              <div class=\"player-subtab-content\" data-player=\"${playerId}\" data-subtab=\"status\" style=\"display: none;\">\r\n                <!-- Conditions -->\r\n                ${player.conditions && player.conditions.length > 0 ? `\r\n                  <div style=\"margin-bottom: 10px;\">\r\n                    <div style=\"font-size: 0.95em; color: #888; margin-bottom: 6px;\">Active Conditions</div>\r\n                    <div style=\"display: flex; flex-wrap: wrap; gap: 6px;\">\r\n                      ${player.conditions.map(c => `<span style=\"background: #e74c3c; padding: 5px 12px; border-radius: 4px; font-size: 0.9em; font-weight: bold;\">${c}</span>`).join('')}\r\n                    </div>\r\n                  </div>\r\n                ` : '<div style=\"padding: 10px; text-align: center; color: #888; font-size: 0.95em;\">No active conditions</div>'}\r\n\r\n                <!-- Concentration -->\r\n                ${player.concentration ? `\r\n                  <div style=\"background: #9b59b6; padding: 10px; border-radius: 4px; margin-bottom: 10px;\">\r\n                    <div style=\"font-size: 0.95em; font-weight: bold; margin-bottom: 4px;\">\uD83E\uDDE0 Concentrating</div>\r\n                    <div style=\"font-size: 0.9em;\">${player.concentration}</div>\r\n                  </div>\r\n                ` : ''}\r\n\r\n                <!-- Death Saves (if unconscious) -->\r\n                ${player.deathSaves ? `\r\n                  <div style=\"background: #c0392b; padding: 10px; border-radius: 4px;\">\r\n                    <div style=\"font-size: 0.95em; font-weight: bold; margin-bottom: 6px;\">\uD83D\uDC80 Death Saving Throws</div>\r\n                    <div style=\"display: flex; justify-content: space-around; font-size: 0.9em;\">\r\n                      <div>\r\n                        <div style=\"color: #27ae60; font-weight: bold;\">Successes</div>\r\n                        <div style=\"font-size: 1.3em; text-align: center;\">\u2713 ${player.deathSaves.successes || 0}</div>\r\n                      </div>\r\n                      <div>\r\n                        <div style=\"color: #e74c3c; font-weight: bold;\">Failures</div>\r\n                        <div style=\"font-size: 1.3em; text-align: center;\">\u2717 ${player.deathSaves.failures || 0}</div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                ` : ''}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      `;\r\n    }).join('');\r\n\r\n    debug.log(`\uD83D\uDC65 Updated player overview: ${players.length} players`);\r\n\r\n    // Add event listeners for player header buttons\r\n    document.querySelectorAll('.player-header-btn').forEach(btn => {\r\n      btn.addEventListener('click', (e) => {\r\n        const playerName = btn.dataset.playerName;\r\n        showFullCharacterModal(playerName);\r\n      });\r\n    });\r\n\r\n    // Add event listeners for delete buttons\r\n    document.querySelectorAll('.player-delete-btn').forEach(btn => {\r\n      btn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        const playerName = btn.dataset.playerName;\r\n        deletePlayerFromGM(playerName);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update player data from character sheet\r\n   */\r\n  function updatePlayerData(characterName, data) {\r\n    if (!playerData[characterName]) {\r\n      playerData[characterName] = {};\r\n    }\r\n\r\n    // Merge new data\r\n    Object.assign(playerData[characterName], data);\r\n\r\n    // Save to storage\r\n    savePlayerDataToStorage();\r\n\r\n    // Update display if GM panel is open\r\n    if (gmModeEnabled) {\r\n      updatePlayerOverviewDisplay();\r\n    }\r\n\r\n    debug.log(`\uD83D\uDC64 Updated player data for ${characterName}:`, playerData[characterName]);\r\n  }\r\n\r\n  /**\r\n   * Save player data to storage\r\n   */\r\n  function savePlayerDataToStorage() {\r\n    debug.log('\uD83D\uDCBE Attempting to save player data:', Object.keys(playerData));\r\n\r\n    // First, load existing characterProfiles to avoid overwriting synced character data\r\n    return browserAPI.storage.local.get(['characterProfiles']).then(result => {\r\n      const existingProfiles = result.characterProfiles || {};\r\n\r\n      // Remove old rollcloudPlayer entries first\r\n      Object.keys(existingProfiles).forEach(key => {\r\n        if (existingProfiles[key].type === 'rollcloudPlayer') {\r\n          delete existingProfiles[key];\r\n        }\r\n      });\r\n\r\n      // Add current player data to existing profiles\r\n      Object.keys(playerData).forEach(playerName => {\r\n        existingProfiles[playerName] = {\r\n          ...playerData[playerName],\r\n          type: 'rollcloudPlayer',\r\n          lastUpdated: new Date().toISOString()\r\n        };\r\n        debug.log(`\uD83D\uDCBE Preparing to save player: ${playerName}, type: rollcloudPlayer`);\r\n      });\r\n\r\n      // Save merged data back to storage (convert callback-based to Promise-based)\r\n      return new Promise((resolve, reject) => {\r\n        browserAPI.storage.local.set({\r\n          characterProfiles: existingProfiles\r\n        }, () => {\r\n          if (browserAPI.runtime.lastError) {\r\n            debug.error('\u274C Error saving to storage:', browserAPI.runtime.lastError);\r\n            reject(browserAPI.runtime.lastError);\r\n          } else {\r\n            debug.log('\u2705 Successfully saved player data to characterProfiles storage');\r\n            debug.log('\uD83D\uDCBE Total profiles in storage:', Object.keys(existingProfiles).length);\r\n            resolve();\r\n          }\r\n        });\r\n      });\r\n    }).catch(error => {\r\n      debug.error('\u274C Error reading existing profiles before save:', error);\r\n      throw error;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Load player data from storage\r\n   */\r\n  function loadPlayerDataFromStorage() {\r\n    return browserAPI.storage.local.get(['characterProfiles']).then(result => {\r\n      if (result.characterProfiles) {\r\n        // Load only rollcloudPlayer entries from characterProfiles\r\n        playerData = {};\r\n        Object.keys(result.characterProfiles).forEach(key => {\r\n          const profile = result.characterProfiles[key];\r\n          if (profile.type === 'rollcloudPlayer') {\r\n            playerData[key] = profile;\r\n          }\r\n        });\r\n\r\n        debug.log(`\uD83D\uDCC2 Loaded ${Object.keys(playerData).length} GM players from storage`);\r\n\r\n        // Update display if GM panel is open\r\n        if (gmModeEnabled) {\r\n          updatePlayerOverviewDisplay();\r\n        }\r\n      }\r\n    }).catch(error => {\r\n      debug.error('\u274C Error loading player data from storage:', error);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Delete player data\r\n   */\r\n  function deletePlayerData(characterName) {\r\n    if (playerData[characterName]) {\r\n      delete playerData[characterName];\r\n      \r\n      // Save to storage\r\n      savePlayerDataToStorage();\r\n      \r\n      // Update display if GM panel is open\r\n      if (gmModeEnabled) {\r\n        updatePlayerOverviewDisplay();\r\n      }\r\n      \r\n      debug.log(`\uD83D\uDDD1\uFE0F Deleted player data for ${characterName}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete player from GM panel\r\n   */\r\n  window.deletePlayerFromGM = function(characterName) {\r\n    if (confirm(`Remove ${characterName} from GM Panel?`)) {\r\n      deletePlayerData(characterName);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Toggle player details expansion\r\n   */\r\n  window.togglePlayerDetails = function(playerId) {\r\n    const details = document.getElementById(`${playerId}-details`);\r\n    const toggle = document.getElementById(`${playerId}-toggle`);\r\n\r\n    if (!details || !toggle) return;\r\n\r\n    const isExpanded = details.style.maxHeight && details.style.maxHeight !== '0px';\r\n\r\n    if (isExpanded) {\r\n      // Collapse\r\n      details.style.maxHeight = '0';\r\n      details.style.opacity = '0';\r\n      toggle.style.transform = 'rotate(-90deg)';\r\n    } else {\r\n      // Expand\r\n      details.style.maxHeight = '1000px';\r\n      details.style.opacity = '1';\r\n      toggle.style.transform = 'rotate(0deg)';\r\n\r\n      // Attach sub-tab listeners for this player\r\n      attachPlayerSubtabListeners(playerId);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Show full character sheet as popout window\r\n   */\r\n  window.showFullCharacterModal = function(playerName) {\r\n    const player = playerData[playerName];\r\n    if (!player) {\r\n      debug.warn(`\u26A0\uFE0F No data found for player: ${playerName}`);\r\n      return;\r\n    }\r\n\r\n    // Create popout window and load the EXISTING popup-sheet.html file\r\n    const popup = window.open(browserAPI.runtime.getURL('src/popup-sheet.html'), `character-${playerName}`, 'width=900,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no');\r\n    \r\n    if (!popup) {\r\n      debug.error('\u274C Failed to open popup window - please allow popups for this site');\r\n      return;\r\n    }\r\n\r\n    // Store player data for the popup to request\r\n    window.currentPopoutPlayer = player;\r\n    window.currentPopoutPlayerName = playerName;\r\n\r\n    // Listen for data requests from the popup\r\n    window.addEventListener('message', function(event) {\r\n      if (event.data && event.data.action === 'requestCharacterData') {\r\n        // Send the character data to the popup\r\n        popup.postMessage({\r\n          action: 'loadCharacterData',\r\n          characterData: window.currentPopoutPlayer\r\n        }, '*');\r\n      }\r\n    });\r\n\r\n    debug.log(`\uD83E\uDE9F Opened character popup for ${playerName}`);\r\n  };\r\n\r\n  /**\r\n   * Attach event listeners for player sub-tabs\r\n   */\r\n  function attachPlayerSubtabListeners(playerId) {\r\n    const subtabBtns = document.querySelectorAll(`.player-subtab-btn[data-player=\"${playerId}\"]`);\r\n    const subtabContents = document.querySelectorAll(`.player-subtab-content[data-player=\"${playerId}\"]`);\r\n\r\n    subtabBtns.forEach(btn => {\r\n      // Remove existing listener if any\r\n      btn.replaceWith(btn.cloneNode(true));\r\n    });\r\n\r\n    // Re-query after replacing\r\n    const newSubtabBtns = document.querySelectorAll(`.player-subtab-btn[data-player=\"${playerId}\"]`);\r\n\r\n    newSubtabBtns.forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        const targetSubtab = btn.dataset.subtab;\r\n\r\n        // Update button styles\r\n        newSubtabBtns.forEach(b => {\r\n          if (b.dataset.subtab === targetSubtab) {\r\n            b.style.color = '#4ECDC4';\r\n            b.style.borderBottom = '2px solid #4ECDC4';\r\n          } else {\r\n            b.style.color = '#888';\r\n            b.style.borderBottom = '2px solid transparent';\r\n          }\r\n        });\r\n\r\n        // Show target content, hide others\r\n        subtabContents.forEach(content => {\r\n          content.style.display = content.dataset.subtab === targetSubtab ? 'block' : 'none';\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Import player data from chrome storage\r\n   */\r\n  function importPlayerData() {\r\n    debug.log('\uD83D\uDCE5 Importing player data from storage...');\r\n\r\n    chrome.storage.local.get(['characterProfiles'], (result) => {\r\n      if (chrome.runtime.lastError) {\r\n        debug.error('\u274C Failed to import player data:', chrome.runtime.lastError);\r\n        postChatMessage('\u274C Failed to import character data');\r\n        return;\r\n      }\r\n\r\n      const characterProfiles = result.characterProfiles || {};\r\n      const profileKeys = Object.keys(characterProfiles);\r\n\r\n      if (profileKeys.length === 0) {\r\n        debug.log('\u26A0\uFE0F No character profiles found in storage');\r\n        postChatMessage('\u26A0\uFE0F No character data found. Please sync a character from Dice Cloud first.');\r\n        return;\r\n      }\r\n\r\n      // Clear existing player data\r\n      playerData = {};\r\n\r\n      // Import each character profile\r\n      profileKeys.forEach(profileId => {\r\n        const character = characterProfiles[profileId];\r\n\r\n        if (!character || !character.name) {\r\n          debug.warn(`\u26A0\uFE0F Skipping invalid character profile: ${profileId}`);\r\n          return;\r\n        }\r\n\r\n        // Import complete character data\r\n        playerData[character.name] = {\r\n          // Basic stats\r\n          hp: character.hp?.current ?? character.hitPoints?.current ?? 0,\r\n          maxHp: character.hp?.max ?? character.hitPoints?.max ?? 0,\r\n          ac: character.armorClass ?? character.ac ?? 10,\r\n          initiative: character.initiative ?? 0,\r\n          passivePerception: character.passivePerception ?? 10,\r\n          proficiency: character.proficiency ?? 0,\r\n          speed: character.speed ?? '30 ft',\r\n          \r\n          // Character info\r\n          name: character.name,\r\n          class: character.class || 'Unknown',\r\n          level: character.level || 1,\r\n          race: character.race || 'Unknown',\r\n          hitDice: character.hitDice || '10',\r\n          \r\n          // Abilities\r\n          attributes: character.attributes || {\r\n            strength: 10,\r\n            dexterity: 10,\r\n            constitution: 10,\r\n            intelligence: 10,\r\n            wisdom: 10,\r\n            charisma: 10\r\n          },\r\n          \r\n          // Skills\r\n          skills: character.skills || [],\r\n          \r\n          // Actions\r\n          actions: character.actions || [],\r\n          \r\n          // Combat status\r\n          conditions: character.conditions || [],\r\n          concentration: character.concentration || null,\r\n          deathSaves: character.deathSaves || null,\r\n          \r\n          // Type marking for storage\r\n          type: 'rollcloudPlayer',\r\n          lastUpdated: new Date().toISOString()\r\n        };\r\n\r\n        debug.log(`\u2705 Imported player: ${character.name} (HP: ${character.hp?.current ?? character.hitPoints?.current ?? 0}/${character.hp?.max ?? character.hitPoints?.max ?? 0}, AC: ${character.armorClass ?? character.ac ?? 10})`);\r\n      });\r\n\r\n      // Update display\r\n      updatePlayerOverviewDisplay();\r\n\r\n      const playerCount = Object.keys(playerData).length;\r\n      debug.log(`\u2705 Successfully imported ${playerCount} player(s)`);\r\n      postChatMessage(`\u2705 GM imported ${playerCount} character(s) to party overview`);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Export player data to clipboard\r\n   */\r\n  function exportPlayerData() {\r\n    if (Object.keys(playerData).length === 0) {\r\n      debug.log('\u26A0\uFE0F No player data to export');\r\n      return;\r\n    }\r\n\r\n    const exportText = Object.keys(playerData).map(name => {\r\n      const player = playerData[name];\r\n      return `**${name}**\r\nHP: ${player.hp}/${player.maxHp}\r\nAC: ${player.ac || '\u2014'}\r\nInitiative: ${player.initiative || '\u2014'}\r\nPassive Perception: ${player.passivePerception || '\u2014'}\r\n${player.conditions && player.conditions.length > 0 ? `Conditions: ${player.conditions.join(', ')}` : ''}\r\n${player.concentration ? `Concentrating: ${player.concentration}` : ''}\r\n${player.deathSaves ? `Death Saves: \u2713${player.deathSaves.successes || 0} / \u2717${player.deathSaves.failures || 0}` : ''}\r\n`;\r\n    }).join('\\n---\\n\\n');\r\n\r\n    // Copy to clipboard\r\n    navigator.clipboard.writeText(exportText).then(() => {\r\n      debug.log('\u2705 Player data copied to clipboard');\r\n      postChatMessage('\uD83D\uDCCB GM exported party overview to clipboard');\r\n    }).catch(err => {\r\n      debug.error('\u274C Failed to copy player data:', err);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Log turn action to history\r\n   */\r\n  function logTurnAction(action) {\r\n    const historyEntry = {\r\n      timestamp: new Date().toLocaleTimeString(),\r\n      round: initiativeTracker.round,\r\n      turnIndex: initiativeTracker.currentTurnIndex,\r\n      combatant: getCurrentCombatant()?.name || 'Unknown',\r\n      ...action\r\n    };\r\n\r\n    turnHistory.unshift(historyEntry); // Add to beginning\r\n    if (turnHistory.length > 10) {\r\n      turnHistory = turnHistory.slice(0, 10); // Keep only last 10\r\n    }\r\n\r\n    updateTurnHistoryDisplay();\r\n    debug.log('\uD83D\uDCDC Logged turn action:', historyEntry);\r\n  }\r\n\r\n  /**\r\n   * Update Turn History Display\r\n   */\r\n  function updateTurnHistoryDisplay() {\r\n    const turnHistoryList = document.getElementById('turn-history-list');\r\n    const emptyState = document.getElementById('turn-history-empty-state');\r\n    if (!turnHistoryList) return;\r\n\r\n    if (turnHistory.length === 0) {\r\n      turnHistoryList.innerHTML = '';\r\n      // Show empty state\r\n      if (emptyState) emptyState.style.display = 'block';\r\n      return;\r\n    }\r\n\r\n    // Hide empty state\r\n    if (emptyState) emptyState.style.display = 'none';\r\n\r\n    turnHistoryList.innerHTML = turnHistory.map((entry, index) => {\r\n      const actionIcon = entry.action === 'attack' ? '\u2694\uFE0F' :\r\n                        entry.action === 'spell' ? '\u2728' :\r\n                        entry.action === 'damage' ? '\uD83D\uDC94' :\r\n                        entry.action === 'healing' ? '\uD83D\uDC9A' :\r\n                        entry.action === 'condition' ? '\uD83C\uDFAF' :\r\n                        entry.action === 'turn' ? '\uD83D\uDD04' : '\uD83D\uDCDD';\r\n\r\n      return `\r\n        <div style=\"background: #34495e; padding: 10px; border-radius: 6px; border-left: 4px solid #3498db;\">\r\n          <div style=\"display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;\">\r\n            <div>\r\n              <span style=\"font-weight: bold; color: #4ECDC4;\">${entry.combatant}</span>\r\n              <span style=\"font-size: 0.75em; color: #888; margin-left: 8px;\">Round ${entry.round}</span>\r\n            </div>\r\n            <span style=\"font-size: 0.75em; color: #888;\">${entry.timestamp}</span>\r\n          </div>\r\n          <div style=\"display: flex; align-items: center; gap: 8px; font-size: 0.9em;\">\r\n            <span style=\"font-size: 1.2em;\">${actionIcon}</span>\r\n            <span style=\"color: #ccc;\">${entry.description}</span>\r\n          </div>\r\n          ${entry.damage ? `<div style=\"margin-top: 4px; font-size: 0.85em; color: #e74c3c;\">Damage: ${entry.damage}</div>` : ''}\r\n          ${entry.healing ? `<div style=\"margin-top: 4px; font-size: 0.85em; color: #27ae60;\">Healing: ${entry.healing}</div>` : ''}\r\n          ${entry.condition ? `<div style=\"margin-top: 4px; font-size: 0.85em; color: #f39c12;\">Condition: ${entry.condition}</div>` : ''}\r\n        </div>\r\n      `;\r\n    }).join('');\r\n\r\n    debug.log(`\uD83D\uDCDC Updated turn history: ${turnHistory.length} entries`);\r\n  }\r\n\r\n  /**\r\n   * Export turn history to clipboard\r\n   */\r\n  function exportTurnHistory() {\r\n    const historyText = turnHistory.map(entry => {\r\n      let text = `[Round ${entry.round}] ${entry.combatant} - ${entry.description}`;\r\n      if (entry.damage) text += ` (Damage: ${entry.damage})`;\r\n      if (entry.healing) text += ` (Healing: ${entry.healing})`;\r\n      if (entry.condition) text += ` (Condition: ${entry.condition})`;\r\n      return text;\r\n    }).join('\\n');\r\n\r\n    navigator.clipboard.writeText(historyText).then(() => {\r\n      postChatMessage('\uD83D\uDCCB Turn history copied to clipboard');\r\n      debug.log('\uD83D\uDCCB Turn history exported to clipboard');\r\n    }).catch(err => {\r\n      debug.error('\u274C Failed to copy turn history:', err);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Toggle GM Mode\r\n   */\r\n  function toggleGMMode(enabled) {\r\n    const previousState = gmModeEnabled;\r\n    gmModeEnabled = enabled !== undefined ? enabled : !gmModeEnabled;\r\n\r\n    debug.log(`\uD83D\uDC51 toggleGMMode called with enabled=${enabled}, previousState=${previousState}, newState=${gmModeEnabled}`);\r\n\r\n    if (!gmPanel) {\r\n      debug.log('\uD83D\uDC51 Creating GM panel...');\r\n      createGMPanel();\r\n    }\r\n\r\n    if (!gmPanel) {\r\n      debug.error('\u274C Failed to create GM panel!');\r\n      return;\r\n    }\r\n\r\n    // Use 'flex' not 'block' to maintain flexbox layout\r\n    gmPanel.style.display = gmModeEnabled ? 'flex' : 'none';\r\n\r\n    // Debug: Check if panel is actually visible\r\n    if (gmModeEnabled) {\r\n      debug.log('\uD83D\uDD0D GM Panel display set to flex');\r\n      debug.log('\uD83D\uDD0D GM Panel offsetWidth:', gmPanel.offsetWidth);\r\n      debug.log('\uD83D\uDD0D GM Panel offsetHeight:', gmPanel.offsetHeight);\r\n      debug.log('\uD83D\uDD0D GM Panel computed display:', window.getComputedStyle(gmPanel).display);\r\n      debug.log('\uD83D\uDD0D GM Panel parent:', gmPanel.parentElement);\r\n      debug.log('\uD83D\uDD0D GM Panel style:', gmPanel.style.cssText);\r\n\r\n      // Check if panel is in viewport\r\n      const rect = gmPanel.getBoundingClientRect();\r\n      debug.log('\uD83D\uDD0D GM Panel bounding rect:', rect);\r\n      debug.log('\uD83D\uDD0D Is panel in viewport:', rect.width > 0 && rect.height > 0);\r\n\r\n      // Force visibility check (especially for Firefox)\r\n      setTimeout(() => {\r\n        debug.log('\uD83D\uDD0D Delayed check - GM Panel display:', window.getComputedStyle(gmPanel).display);\r\n        debug.log('\uD83D\uDD0D Delayed check - GM Panel visible:', gmPanel.offsetWidth > 0);\r\n\r\n        // Try to force visibility if needed\r\n        if (gmPanel.offsetWidth === 0) {\r\n          debug.warn('\u26A0\uFE0F GM Panel has zero width, trying to force visibility...');\r\n          gmPanel.style.visibility = 'visible';\r\n          gmPanel.style.opacity = '1';\r\n          gmPanel.style.display = 'flex';\r\n          // Firefox sometimes needs explicit dimensions\r\n          gmPanel.style.width = '500px';\r\n          gmPanel.style.height = '600px';\r\n          debug.log('\uD83D\uDD0D Forced visibility styles applied');\r\n        }\r\n      }, 100);\r\n    }\r\n\r\n    // Visual feedback - enhance glow when active\r\n    if (gmModeEnabled) {\r\n      gmPanel.style.borderColor = '#4ECDC4'; // Cyan border\r\n      gmPanel.style.boxShadow = '0 8px 32px rgba(78, 205, 196, 0.6)'; // Enhanced cyan glow when active\r\n    } else {\r\n      gmPanel.style.borderColor = '#4ECDC4'; // Cyan border\r\n      gmPanel.style.boxShadow = '0 8px 32px rgba(0,0,0,0.5)'; // Default shadow\r\n    }\r\n\r\n    // Start/stop chat monitoring\r\n    if (gmModeEnabled) {\r\n      startChatMonitoring();\r\n    } else {\r\n      stopChatMonitoring();\r\n    }\r\n\r\n    // Post chat announcement only when state actually changes\r\n    if (previousState !== gmModeEnabled) {\r\n      const message = gmModeEnabled\r\n        ? '\uD83D\uDC51 GM Panel is now active - rolls will be hidden from players'\r\n        : '\uD83D\uDC51 GM Panel deactivated - rolls will post normally';\r\n\r\n      // Use setTimeout to ensure the chat is ready\r\n      setTimeout(() => {\r\n        postChatMessage(message);\r\n      }, 100);\r\n    }\r\n\r\n    debug.log(`\uD83D\uDC51 GM Mode ${gmModeEnabled ? 'enabled' : 'disabled'}`);\r\n  }\r\n\r\n  /**\r\n   * Add combatant to initiative tracker\r\n   */\r\n  function addCombatant(name, initiative, source = 'chat') {\r\n    // Check if already exists\r\n    const exists = initiativeTracker.combatants.find(c => c.name === name);\r\n    if (exists) {\r\n      debug.log(`\u26A0\uFE0F Combatant ${name} already in tracker, updating initiative`);\r\n      exists.initiative = initiative;\r\n      updateInitiativeDisplay();\r\n      return;\r\n    }\r\n\r\n    initiativeTracker.combatants.push({\r\n      name,\r\n      initiative,\r\n      source\r\n    });\r\n\r\n    // Sort by initiative (highest first)\r\n    initiativeTracker.combatants.sort((a, b) => b.initiative - a.initiative);\r\n\r\n    updateInitiativeDisplay();\r\n    debug.log(`\u2705 Added combatant: ${name} (Init: ${initiative})`);\r\n  }\r\n\r\n  /**\r\n   * Remove combatant from tracker\r\n   */\r\n  function removeCombatant(name) {\r\n    const index = initiativeTracker.combatants.findIndex(c => c.name === name);\r\n    if (index !== -1) {\r\n      initiativeTracker.combatants.splice(index, 1);\r\n\r\n      // Adjust current turn index if necessary\r\n      if (initiativeTracker.currentTurnIndex >= initiativeTracker.combatants.length) {\r\n        initiativeTracker.currentTurnIndex = 0;\r\n      }\r\n\r\n      updateInitiativeDisplay();\r\n      debug.log(`\uD83D\uDDD1\uFE0F Removed combatant: ${name}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all combatants\r\n   */\r\n  function clearAllCombatants() {\r\n    if (confirm('Clear all combatants from initiative tracker?')) {\r\n      initiativeTracker.combatants = [];\r\n      initiativeTracker.currentTurnIndex = 0;\r\n      initiativeTracker.round = 1;\r\n      combatStarted = false;\r\n\r\n      // Show Start Combat button again\r\n      const startBtn = document.getElementById('start-combat-btn');\r\n      const prevBtn = document.getElementById('prev-turn-btn');\r\n      const nextBtn = document.getElementById('next-turn-btn');\r\n\r\n      if (startBtn) startBtn.style.display = 'block';\r\n      if (prevBtn) prevBtn.style.display = 'none';\r\n      if (nextBtn) nextBtn.style.display = 'none';\r\n\r\n      updateInitiativeDisplay();\r\n      postChatMessage('\uD83D\uDED1 Combat ended. Initiative tracker cleared.');\r\n      debug.log('\uD83D\uDDD1\uFE0F All combatants cleared');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start combat - initialize first turn\r\n   */\r\n  function startCombat() {\r\n    if (initiativeTracker.combatants.length === 0) {\r\n      debug.warn('\u26A0\uFE0F Cannot start combat with no combatants');\r\n      return;\r\n    }\r\n\r\n    // Reset to beginning\r\n    initiativeTracker.currentTurnIndex = 0;\r\n    initiativeTracker.round = 1;\r\n    combatStarted = true;\r\n\r\n    // Update UI\r\n    document.getElementById('round-display').textContent = 'Round 1';\r\n    const startBtn = document.getElementById('start-combat-btn');\r\n    const prevBtn = document.getElementById('prev-turn-btn');\r\n    const nextBtn = document.getElementById('next-turn-btn');\r\n\r\n    if (startBtn) {\r\n      startBtn.style.display = 'none';\r\n    }\r\n    if (prevBtn) prevBtn.style.display = 'block';\r\n    if (nextBtn) nextBtn.style.display = 'block';\r\n\r\n    updateInitiativeDisplay();\r\n    notifyCurrentTurn();\r\n\r\n    // Announce combat start\r\n    postChatMessage('\u2694\uFE0F Combat has begun! Round 1 starts!');\r\n    announceTurn();\r\n\r\n    debug.log('\u2694\uFE0F Combat started!');\r\n  }\r\n\r\n  /**\r\n   * Next turn\r\n   */\r\n  function nextTurn() {\r\n    if (initiativeTracker.combatants.length === 0) return;\r\n\r\n    initiativeTracker.currentTurnIndex++;\r\n    if (initiativeTracker.currentTurnIndex >= initiativeTracker.combatants.length) {\r\n      initiativeTracker.currentTurnIndex = 0;\r\n      initiativeTracker.round++;\r\n      document.getElementById('round-display').textContent = `Round ${initiativeTracker.round}`;\r\n      // Announce new round\r\n      postChatMessage(`\u2694\uFE0F Round ${initiativeTracker.round} begins!`);\r\n      // Notify Discord of round change\r\n      postRoundChangeToDiscord(initiativeTracker.round);\r\n    }\r\n\r\n    updateInitiativeDisplay();\r\n    notifyCurrentTurn();\r\n    announceTurn();\r\n\r\n    // Log turn change\r\n    const current = getCurrentCombatant();\r\n    if (current) {\r\n      logTurnAction({\r\n        action: 'turn',\r\n        description: `${current.name}'s turn begins`\r\n      });\r\n    }\r\n\r\n    debug.log(`\u23ED\uFE0F Next turn: ${getCurrentCombatant()?.name}`);\r\n  }\r\n\r\n  /**\r\n   * Previous turn\r\n   */\r\n  function prevTurn() {\r\n    if (initiativeTracker.combatants.length === 0) return;\r\n\r\n    initiativeTracker.currentTurnIndex--;\r\n    if (initiativeTracker.currentTurnIndex < 0) {\r\n      initiativeTracker.currentTurnIndex = initiativeTracker.combatants.length - 1;\r\n      initiativeTracker.round = Math.max(1, initiativeTracker.round - 1);\r\n      document.getElementById('round-display').textContent = `Round ${initiativeTracker.round}`;\r\n    }\r\n\r\n    updateInitiativeDisplay();\r\n    notifyCurrentTurn();\r\n    announceTurn();\r\n    debug.log(`\u23EE\uFE0F Prev turn: ${getCurrentCombatant()?.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get current combatant\r\n   */\r\n  function getCurrentCombatant() {\r\n    return initiativeTracker.combatants[initiativeTracker.currentTurnIndex];\r\n  }\r\n\r\n  /**\r\n   * Delay current turn\r\n   */\r\n  function delayTurn(combatantIndex) {\r\n    const combatant = initiativeTracker.combatants[combatantIndex];\r\n    if (!combatant) return;\r\n\r\n    debug.log(`\u23F8\uFE0F Delaying turn for: ${combatant.name}`);\r\n\r\n    // Add to delayed list\r\n    initiativeTracker.delayedCombatants.push({\r\n      name: combatant.name,\r\n      initiative: combatant.initiative,\r\n      originalIndex: combatantIndex\r\n    });\r\n\r\n    // Log the action\r\n    logTurnAction({\r\n      action: 'turn',\r\n      description: `${combatant.name} delays their turn`\r\n    });\r\n\r\n    // Announce delay\r\n    postChatMessage(`\u23F8\uFE0F ${combatant.name} delays their turn`);\r\n\r\n    // Move to next turn\r\n    nextTurn();\r\n\r\n    updateInitiativeDisplay();\r\n  }\r\n\r\n  /**\r\n   * Undelay a combatant (cancel their delay)\r\n   */\r\n  function undelayTurn(combatantName) {\r\n    const delayedIndex = initiativeTracker.delayedCombatants.findIndex(d => d.name === combatantName);\r\n    if (delayedIndex === -1) return;\r\n\r\n    debug.log(`\u25B6\uFE0F Undelaying: ${combatantName}`);\r\n\r\n    // Remove from delayed list\r\n    initiativeTracker.delayedCombatants.splice(delayedIndex, 1);\r\n\r\n    // Log the action\r\n    logTurnAction({\r\n      action: 'turn',\r\n      description: `${combatantName} resumes their turn`\r\n    });\r\n\r\n    // Announce\r\n    postChatMessage(`\u25B6\uFE0F ${combatantName} resumes their turn`);\r\n\r\n    updateInitiativeDisplay();\r\n  }\r\n\r\n  /**\r\n   * Insert a delayed combatant's turn now\r\n   */\r\n  function insertDelayedTurn(combatantName) {\r\n    const delayedIndex = initiativeTracker.delayedCombatants.findIndex(d => d.name === combatantName);\r\n    if (delayedIndex === -1) return;\r\n\r\n    const delayed = initiativeTracker.delayedCombatants[delayedIndex];\r\n    debug.log(`\u25B6\uFE0F Inserting delayed turn for: ${delayed.name}`);\r\n\r\n    // Remove from delayed list\r\n    initiativeTracker.delayedCombatants.splice(delayedIndex, 1);\r\n\r\n    // Log the action\r\n    logTurnAction({\r\n      action: 'turn',\r\n      description: `${delayed.name} acts on delayed turn`\r\n    });\r\n\r\n    // Announce\r\n    postChatMessage(`\u25B6\uFE0F ${delayed.name} acts now (delayed turn)`);\r\n\r\n    // Notify the character sheet\r\n    notifyCurrentTurn();\r\n\r\n    updateInitiativeDisplay();\r\n  }\r\n\r\n  /**\r\n   * Update initiative display\r\n   */\r\n  function updateInitiativeDisplay() {\r\n    const list = document.getElementById('initiative-list');\r\n    if (!list) return;\r\n\r\n    if (initiativeTracker.combatants.length === 0) {\r\n      list.innerHTML = '<div style=\"text-align: center; color: #7f8c8d; padding: 20px;\">No combatants yet. Add manually or roll initiative in Roll20 chat!</div>';\r\n      return;\r\n    }\r\n\r\n    list.innerHTML = initiativeTracker.combatants.map((combatant, index) => {\r\n      const isActive = index === initiativeTracker.currentTurnIndex;\r\n      const isDelayed = initiativeTracker.delayedCombatants.some(d => d.name === combatant.name);\r\n\r\n      return `\r\n        <div style=\"padding: 10px; background: ${isActive ? '#4ECDC4' : isDelayed ? '#9b59b6' : '#34495e'}; border: 2px solid ${isActive ? '#4ECDC4' : isDelayed ? '#8e44ad' : '#2c3e50'}; border-radius: 6px; ${isActive ? 'box-shadow: 0 0 15px rgba(78, 205, 196, 0.4);' : ''}\">\r\n          <div style=\"display: flex; align-items: center; gap: 10px; margin-bottom: ${isActive ? '8px' : '0'};\">\r\n            <div style=\"font-weight: bold; font-size: 1.2em; min-width: 30px; text-align: center;\">${combatant.initiative}</div>\r\n            <div style=\"flex: 1; font-weight: bold;\">\r\n              ${combatant.name}\r\n              ${isDelayed ? '<span style=\"font-size: 0.85em; color: #f39c12; margin-left: 8px;\">\u23F8\uFE0F Delayed</span>' : ''}\r\n            </div>\r\n            <button class=\"rollcloud-remove-combatant\" data-combatant-name=\"${combatant.name}\" style=\"background: #e74c3c; color: #fff; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;\">\u2715</button>\r\n          </div>\r\n          ${isActive && !isDelayed ? `\r\n            <button class=\"rollcloud-delay-turn\" data-combatant-index=\"${index}\" style=\"width: 100%; background: #f39c12; color: #fff; border: none; border-radius: 4px; padding: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em;\">\u23F8\uFE0F Delay Turn</button>\r\n          ` : ''}\r\n          ${isActive && isDelayed ? `\r\n            <button class=\"rollcloud-undelay-turn\" data-combatant-name=\"${combatant.name}\" style=\"width: 100%; background: #27ae60; color: #fff; border: none; border-radius: 4px; padding: 6px; cursor: pointer; font-weight: bold; font-size: 0.85em;\">\u25B6\uFE0F Resume Turn</button>\r\n          ` : ''}\r\n        </div>\r\n      `;\r\n    }).join('');\r\n\r\n    // Show delayed combatants section if any exist\r\n    if (initiativeTracker.delayedCombatants.length > 0) {\r\n      list.innerHTML += `\r\n        <div style=\"margin-top: 15px; padding-top: 15px; border-top: 2px solid #34495e;\">\r\n          <div style=\"font-weight: bold; color: #f39c12; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;\">\r\n            <span>\u23F8\uFE0F</span> Delayed Actions\r\n          </div>\r\n          ${initiativeTracker.delayedCombatants.map(delayed => `\r\n            <div style=\"padding: 8px; background: #9b59b6; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;\">\r\n              <div style=\"flex: 1;\">\r\n                <div style=\"font-weight: bold;\">${delayed.name}</div>\r\n                <div style=\"font-size: 0.75em; opacity: 0.8;\">Initiative: ${delayed.initiative}</div>\r\n              </div>\r\n              <button class=\"rollcloud-insert-delayed\" data-delayed-name=\"${delayed.name}\" style=\"background: #27ae60; color: #fff; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-weight: bold; font-size: 0.85em;\">\u25B6\uFE0F Act Now</button>\r\n            </div>\r\n          `).join('')}\r\n        </div>\r\n      `;\r\n    }\r\n\r\n    // Attach event listeners (CSP-compliant)\r\n    const removeButtons = list.querySelectorAll('.rollcloud-remove-combatant');\r\n    removeButtons.forEach(button => {\r\n      button.addEventListener('click', () => {\r\n        const name = button.getAttribute('data-combatant-name');\r\n        removeCombatant(name);\r\n      });\r\n    });\r\n\r\n    const delayButtons = list.querySelectorAll('.rollcloud-delay-turn');\r\n    delayButtons.forEach(button => {\r\n      button.addEventListener('click', () => {\r\n        const index = parseInt(button.getAttribute('data-combatant-index'));\r\n        delayTurn(index);\r\n      });\r\n    });\r\n\r\n    const undelayButtons = list.querySelectorAll('.rollcloud-undelay-turn');\r\n    undelayButtons.forEach(button => {\r\n      button.addEventListener('click', () => {\r\n        const name = button.getAttribute('data-combatant-name');\r\n        undelayTurn(name);\r\n      });\r\n    });\r\n\r\n    const insertDelayedButtons = list.querySelectorAll('.rollcloud-insert-delayed');\r\n    insertDelayedButtons.forEach(button => {\r\n      button.addEventListener('click', () => {\r\n        const name = button.getAttribute('data-delayed-name');\r\n        insertDelayedTurn(name);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Notify current turn to character sheet and Discord\r\n   */\r\n  function notifyCurrentTurn() {\r\n    const current = getCurrentCombatant();\r\n    if (!current) return;\r\n\r\n    debug.log(`\uD83C\uDFAF Notifying turn for: \"${current.name}\"`);\r\n    debug.log(`\uD83D\uDCCB Registered popups: ${Object.keys(characterPopups).map(n => `\"${n}\"`).join(', ')}`);\r\n\r\n    // Helper function to normalize names for comparison\r\n    // Removes emoji prefixes, \"It's\", \"'s turn\", and trims\r\n    function normalizeName(name) {\r\n      return name\r\n        .replace(/^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)\\s*/, '') // Remove emoji prefixes\r\n        .replace(/^It's\\s+/i, '') // Remove \"It's\" prefix\r\n        .replace(/'s\\s+turn.*$/i, '') // Remove \"'s turn\" suffix\r\n        .trim();\r\n    }\r\n\r\n    const normalizedCurrentName = normalizeName(current.name);\r\n    debug.log(`\uD83D\uDD0D Normalized current combatant: \"${normalizedCurrentName}\"`);\r\n\r\n    // Send activateTurn/deactivateTurn to all popup windows\r\n    Object.keys(characterPopups).forEach(characterName => {\r\n      const popup = characterPopups[characterName];\r\n      try {\r\n        if (popup && !popup.closed) {\r\n          const normalizedCharName = normalizeName(characterName);\r\n\r\n          // Strict match: names must be exactly equal after normalization\r\n          const isTheirTurn = normalizedCharName === normalizedCurrentName;\r\n\r\n          debug.log(`\uD83D\uDD0D Comparing: \"${characterName}\" (normalized: \"${normalizedCharName}\") vs \"${current.name}\" (normalized: \"${normalizedCurrentName}\") \u2192 ${isTheirTurn ? 'ACTIVATE' : 'DEACTIVATE'}`);\r\n          debug.log(`\uD83D\uDD0D Raw comparison: \"${characterName}\" === \"${current.name}\" \u2192 ${characterName === current.name}`);\r\n\r\n          popup.postMessage({\r\n            action: isTheirTurn ? 'activateTurn' : 'deactivateTurn',\r\n            combatant: current.name\r\n          }, '*');\r\n\r\n          debug.log(`\uD83D\uDCE4 Sent ${isTheirTurn ? 'activateTurn' : 'deactivateTurn'} to \"${characterName}\"`);\r\n        } else {\r\n          // Clean up closed popups\r\n          delete characterPopups[characterName];\r\n          debug.log(`\uD83D\uDDD1\uFE0F Removed closed popup for ${characterName}`);\r\n        }\r\n      } catch (error) {\r\n        debug.warn(`\u26A0\uFE0F Error sending message to popup \"${characterName}\":`, error);\r\n        delete characterPopups[characterName];\r\n      }\r\n    });\r\n\r\n    // Post to Discord webhook\r\n    postTurnToDiscord(current);\r\n  }\r\n\r\n  /**\r\n   * Post turn notification to Discord webhook\r\n   */\r\n  function postTurnToDiscord(combatant) {\r\n    if (!combatant) return;\r\n\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'postToDiscord',\r\n      payload: {\r\n        type: 'turnStart',\r\n        characterName: combatant.name,\r\n        combatant: combatant.name,\r\n        initiative: combatant.initiative,\r\n        round: initiativeTracker.round\r\n      }\r\n    }).then(response => {\r\n      if (response && response.success) {\r\n        debug.log(`\uD83C\uDFAE Discord: Posted turn for ${combatant.name}`);\r\n      }\r\n    }).catch(err => {\r\n      // Webhook might not be configured - that's fine\r\n      debug.log('Discord webhook not configured or failed:', err.message);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Post round change to Discord webhook\r\n   */\r\n  function postRoundChangeToDiscord(round) {\r\n    const current = getCurrentCombatant();\r\n\r\n    browserAPI.runtime.sendMessage({\r\n      action: 'postToDiscord',\r\n      payload: {\r\n        type: 'roundChange',\r\n        round: round,\r\n        combatant: current ? current.name : null\r\n      }\r\n    }).then(response => {\r\n      if (response && response.success) {\r\n        debug.log(`\uD83C\uDFAE Discord: Posted round ${round} change`);\r\n      }\r\n    }).catch(err => {\r\n      debug.log('Discord webhook not configured or failed:', err.message);\r\n    });\r\n  }\r\n\r\n  function announceTurn() {\r\n    const current = getCurrentCombatant();\r\n    if (!current) return;\r\n\r\n    postChatMessage(`\uD83C\uDFAF It's ${current.name}'s turn! (Initiative: ${current.initiative})`);\r\n  }\r\n\r\n  /**\r\n   * Chat monitoring for initiative rolls\r\n   */\r\n  let chatObserver = null;\r\n\r\n  function startChatMonitoring() {\r\n    const chatLog = document.getElementById('textchat');\r\n    if (!chatLog) {\r\n      debug.warn('\u26A0\uFE0F Roll20 chat not found, cannot monitor for initiative');\r\n      return;\r\n    }\r\n\r\n    // Watch for new messages\r\n    chatObserver = new MutationObserver((mutations) => {\r\n      mutations.forEach((mutation) => {\r\n        mutation.addedNodes.forEach((node) => {\r\n          if (node.nodeType === 1 && node.classList && node.classList.contains('message')) {\r\n            checkForInitiativeRoll(node);\r\n            checkForPlayerRoll(node); // Track any character roll for player overview\r\n          }\r\n        });\r\n      });\r\n    });\r\n\r\n    chatObserver.observe(chatLog, {\r\n      childList: true,\r\n      subtree: true\r\n    });\r\n\r\n    debug.log('\uD83D\uDC40 Monitoring Roll20 chat for initiative rolls and player tracking');\r\n  }\r\n\r\n  function stopChatMonitoring() {\r\n    if (chatObserver) {\r\n      chatObserver.disconnect();\r\n      chatObserver = null;\r\n      debug.log('\uD83D\uDED1 Stopped monitoring chat');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check message for initiative roll\r\n   */\r\n  function checkForInitiativeRoll(messageNode) {\r\n    const text = messageNode.textContent || '';\r\n    const innerHTML = messageNode.innerHTML || '';\r\n\r\n    // Debug: Log the message to see format\r\n    debug.log('\uD83D\uDCE8 Chat message (text):', text);\r\n    debug.log('\uD83D\uDCE8 Chat message (html):', innerHTML);\r\n\r\n    // Skip our own announcements (turn changes, round starts, GM mode toggles)\r\n    // These start with specific emojis and should not be parsed as initiative rolls\r\n    const ownAnnouncementPrefixes = ['\uD83C\uDFAF', '\u2694\uFE0F', '\uD83D\uDC51'];\r\n    const trimmedText = text.trim();\r\n    for (const prefix of ownAnnouncementPrefixes) {\r\n      if (trimmedText.includes(prefix)) {\r\n        debug.log('\u23ED\uFE0F Skipping own announcement message');\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Check for Roll20's inline roll format in HTML\r\n    // Look for dice rolls with \"inlinerollresult\" class\r\n    const inlineRolls = messageNode.querySelectorAll('.inlinerollresult');\r\n    if (inlineRolls.length > 0) {\r\n      // Check if message contains \"initiative\" keyword\r\n      const lowerText = text.toLowerCase();\r\n      if (lowerText.includes('initiative') || lowerText.includes('init')) {\r\n        let characterName = null;\r\n\r\n        // Try to extract from roll template caption first\r\n        const rollTemplate = messageNode.querySelector('.sheet-rolltemplate-default, .sheet-rolltemplate-custom');\r\n        if (rollTemplate) {\r\n          const caption = rollTemplate.querySelector('caption, .sheet-template-name, .charname');\r\n          if (caption) {\r\n            const captionText = caption.textContent.trim();\r\n            // Extract name from patterns like \"\uD83D\uDD35 Test 2 rolls Initiative\" or \"Name: Initiative\"\r\n            const nameMatch = captionText.match(/^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)?\\s*(.+?)\\s+(?:rolls?\\s+)?[Ii]nitiative/i);\r\n            if (nameMatch) {\r\n              characterName = nameMatch[1].trim();\r\n            }\r\n          }\r\n        }\r\n\r\n        // Fallback: Extract character name from .by element (regular chat messages)\r\n        if (!characterName) {\r\n          const byElement = messageNode.querySelector('.by');\r\n          characterName = byElement ? byElement.textContent.trim().replace(/:/g, '') : null;\r\n        }\r\n\r\n        // Get the roll result from the last inline roll\r\n        const lastRoll = inlineRolls[inlineRolls.length - 1];\r\n        const rollResult = lastRoll.textContent.trim();\r\n        const initiative = parseInt(rollResult);\r\n\r\n        if (characterName && !isNaN(initiative) && initiative >= 0 && initiative <= 50) {\r\n          debug.log(`\uD83C\uDFB2 Detected initiative roll (inline): ${characterName} = ${initiative}`);\r\n          addCombatant(characterName, initiative, 'chat');\r\n          return;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Look for patterns like:\r\n    // \"Grey rolls Initiative Roll 21\"\r\n    // \"Test 1 rolls Initiative Roll 22\"\r\n    // \"CharacterName rolled a 15 for initiative\"\r\n    // \"Initiative: 18\"\r\n    const initiativePatterns = [\r\n      // Pattern 1: \"Name rolls Initiative Roll 21\" or \"Name: rolls Initiative 21\"\r\n      /^(.+?)(?::)?\\s+rolls?\\s+[Ii]nitiative.*?(\\d+)/,\r\n      // Pattern 2: \"Name rolled 15 for initiative\"\r\n      /^(.+?)\\s+rolled?\\s+(?:a\\s+)?(\\d+)\\s+for\\s+[Ii]nitiative/,\r\n      // Pattern 3: Generic \"Name ... initiative ... 15\" (case insensitive)\r\n      /^(.+?).*?[Ii]nitiative.*?(\\d+)/,\r\n      // Pattern 4: \"Name ... Init ... 15\"\r\n      /^(.+?).*?[Ii]nit.*?(\\d+)/\r\n    ];\r\n\r\n    for (const pattern of initiativePatterns) {\r\n      const match = text.match(pattern);\r\n      if (match) {\r\n        let name = match[1].trim();\r\n        // Remove trailing colons and \"rolls\" text\r\n        name = name.replace(/\\s*:?\\s*rolls?$/i, '').trim();\r\n        const initiative = parseInt(match[2]);\r\n\r\n        if (name && !isNaN(initiative) && initiative >= 0 && initiative <= 50) {\r\n          debug.log(`\uD83C\uDFB2 Detected initiative roll (text): ${name} = ${initiative}`);\r\n          addCombatant(name, initiative, 'chat');\r\n          return;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check message for any character roll and track player\r\n   */\r\n  function checkForPlayerRoll(messageNode) {\r\n    const text = messageNode.textContent || '';\r\n\r\n    // Skip our own announcements\r\n    const ownAnnouncementPrefixes = ['\uD83C\uDFAF', '\u2694\uFE0F', '\uD83D\uDC51', '\uD83D\uDD13', '\u23F8\uFE0F', '\u25B6\uFE0F', '\uD83D\uDCCB'];\r\n    const trimmedText = text.trim();\r\n    for (const prefix of ownAnnouncementPrefixes) {\r\n      if (trimmedText.includes(prefix)) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Skip system messages\r\n    if (text.includes('created the character') ||\r\n        text.includes('Welcome to Roll20') ||\r\n        text.includes('has joined the game')) {\r\n      return;\r\n    }\r\n\r\n    // Check for inline rolls (indicates a character is rolling)\r\n    const inlineRolls = messageNode.querySelectorAll('.inlinerollresult');\r\n    if (inlineRolls.length === 0) {\r\n      return; // No rolls, skip\r\n    }\r\n\r\n    let characterName = null;\r\n\r\n    // Try to extract character name from roll template\r\n    const rollTemplate = messageNode.querySelector('.sheet-rolltemplate-default, .sheet-rolltemplate-custom, [class*=\"rolltemplate\"]');\r\n    if (rollTemplate) {\r\n      const caption = rollTemplate.querySelector('caption, .sheet-template-name, .charname, [class*=\"charname\"]');\r\n      if (caption) {\r\n        const captionText = caption.textContent.trim();\r\n        // Extract name from patterns like \"\uD83D\uDD35 Character Name rolls Attack\" or \"Character Name: Attack\"\r\n        const nameMatch = captionText.match(/^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)?\\s*(.+?)\\s*(?:rolls?\\s+|\\s*:\\s*|$)/i);\r\n        if (nameMatch) {\r\n          characterName = nameMatch[1].trim();\r\n        }\r\n      }\r\n    }\r\n\r\n    // Fallback: Try to extract from message structure\r\n    if (!characterName) {\r\n      const byElement = messageNode.querySelector('.by');\r\n      if (byElement) {\r\n        characterName = byElement.textContent.trim();\r\n      }\r\n    }\r\n\r\n    // Fallback: Parse from message text\r\n    if (!characterName) {\r\n      // Pattern: \"Character Name: roll result\" or \"Character Name rolls\"\r\n      const patterns = [\r\n        /^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)?\\s*(.+?)\\s*:/,\r\n        /^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)?\\s*(.+?)\\s+rolls?/i\r\n      ];\r\n\r\n      for (const pattern of patterns) {\r\n        const match = text.match(pattern);\r\n        if (match) {\r\n          characterName = match[1].trim();\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // If we got a character name, track them\r\n    if (characterName && characterName.length > 0) {\r\n      // Skip obviously non-player names\r\n      const skipNames = ['gm', 'dm', 'roll20', 'system', 'the', 'a ', 'an '];\r\n      const lowerName = characterName.toLowerCase();\r\n      if (skipNames.some(skip => lowerName === skip || lowerName.startsWith(skip + ' '))) {\r\n        return;\r\n      }\r\n\r\n      // Add to player tracking if not already tracked\r\n      if (!playerData[characterName]) {\r\n        debug.log(`\uD83D\uDC65 New player detected from roll: ${characterName}`);\r\n\r\n        playerData[characterName] = {\r\n          hp: null, // Will be updated when popup sends data\r\n          maxHp: null,\r\n          ac: null,\r\n          passivePerception: null,\r\n          initiative: null,\r\n          conditions: [],\r\n          concentration: null,\r\n          deathSaves: null\r\n        };\r\n\r\n        updatePlayerOverviewDisplay();\r\n\r\n        // Log to turn history\r\n        logTurnAction({\r\n          action: 'turn',\r\n          description: `${characterName} detected in combat`\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Register a character popup window\r\n   * Called by character-sheet-overlay when opening a popup\r\n   */\r\n  window.rollcloudRegisterPopup = function(characterName, popupWindow) {\r\n    if (characterName && popupWindow) {\r\n      characterPopups[characterName] = popupWindow;\r\n      debug.log(`\u2705 Registered popup for: ${characterName}`);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Check recent chat messages to see if it's currently this character's turn\r\n   */\r\n  function checkRecentChatForCurrentTurn(characterName, popupWindow) {\r\n    try {\r\n      const chatLog = document.getElementById('textchat');\r\n      if (!chatLog) {\r\n        debug.warn('\u26A0\uFE0F Roll20 chat not found for turn check');\r\n        return;\r\n      }\r\n\r\n      // Get recent messages (last 20 or so)\r\n      const messages = chatLog.querySelectorAll('.message');\r\n      const recentMessages = Array.from(messages).slice(-20);\r\n      \r\n      debug.log(`\uD83D\uDD0D Checking recent ${recentMessages.length} messages for current turn of: ${characterName}`);\r\n\r\n      // Helper function to normalize names\r\n      function normalizeName(name) {\r\n        return name\r\n          .replace(/^(?:\uD83D\uDD35|\uD83D\uDD34|\u26AA|\u26AB|\uD83D\uDFE2|\uD83D\uDFE1|\uD83D\uDFE0|\uD83D\uDFE3|\uD83D\uDFE4)\\s*/, '') // Remove emoji prefixes\r\n          .replace(/^It's\\s+/i, '') // Remove \"It's\" prefix\r\n          .replace(/'s\\s+turn.*$/i, '') // Remove \"'s turn\" suffix\r\n          .trim();\r\n      }\r\n\r\n      const normalizedCharacterName = normalizeName(characterName);\r\n\r\n      // Look for recent turn announcement\r\n      for (let i = recentMessages.length - 1; i >= 0; i--) {\r\n        const message = recentMessages[i];\r\n        const text = message.textContent || '';\r\n        \r\n        // Check for turn announcement pattern\r\n        const turnMatch = text.match(/\uD83C\uDFAF It's (.+?)'s turn! \\(Initiative: (\\d+)\\)/);\r\n        if (turnMatch) {\r\n          const announcedCharacter = normalizeName(turnMatch[1]);\r\n          const initiative = parseInt(turnMatch[2]);\r\n          \r\n          debug.log(`\uD83D\uDD0D Found turn announcement: \"${turnMatch[1]}\" (normalized: \"${announcedCharacter}\") vs \"${characterName}\" (normalized: \"${normalizedCharacterName}\")`);\r\n          \r\n          if (announcedCharacter === normalizedCharacterName) {\r\n            debug.log(`\u2705 It's ${characterName}'s turn! Activating action economy...`);\r\n            \r\n            // Send activateTurn to this popup\r\n            popupWindow.postMessage({\r\n              action: 'activateTurn',\r\n              combatant: characterName\r\n            }, '*');\r\n            \r\n            return;\r\n          } else {\r\n            debug.log(`\u23F8\uFE0F It's ${turnMatch[1]}'s turn, not ${characterName}. Deactivating...`);\r\n            \r\n            // Send deactivateTurn to this popup\r\n            popupWindow.postMessage({\r\n              action: 'deactivateTurn',\r\n              combatant: characterName\r\n            }, '*');\r\n            \r\n            return;\r\n          }\r\n        }\r\n      }\r\n      \r\n      debug.log(`\uD83D\uDD0D No recent turn announcement found for ${characterName}`);\r\n      \r\n    } catch (error) {\r\n      debug.error('Error checking recent chat for current turn:', error);\r\n    }\r\n  }\r\n\r\n  // Listen for messages to toggle GM mode and post chat messages\r\n  window.addEventListener('message', (event) => {\r\n    debug.log('\uD83D\uDCE8 Received message:', event.data);\r\n    \r\n    if (event.data && event.data.action === 'toggleGMMode') {\r\n      debug.log('\uD83D\uDC51 Processing toggleGMMode message:', event.data.enabled);\r\n      toggleGMMode(event.data.enabled);\r\n    } else if (event.data && event.data.action === 'postChatMessageFromPopup') {\r\n      // Post message from character sheet popup to Roll20 chat\r\n      postChatMessage(event.data.message);\r\n    } else if (event.data && event.data.action === 'checkCurrentTurn') {\r\n      // Check if it's currently this character's turn by examining recent chat\r\n      if (event.data.characterName) {\r\n        checkRecentChatForCurrentTurn(event.data.characterName, event.source);\r\n      }\r\n    } else if (event.data && event.data.action === 'updatePlayerData') {\r\n      // Receive player data updates for GM overview\r\n      if (event.data.characterName && event.data.data) {\r\n        updatePlayerData(event.data.characterName, event.data.data);\r\n      }\r\n    } else if (event.data && event.data.action === 'postToDiscordFromPopup') {\r\n      // Forward Discord webhook post from popup to background script\r\n      if (event.data.payload) {\r\n        browserAPI.runtime.sendMessage({\r\n          action: 'postToDiscord',\r\n          payload: event.data.payload\r\n        }).then(response => {\r\n          if (response && response.success) {\r\n            debug.log(`\uD83C\uDFAE Discord: Forwarded action update from popup`);\r\n          }\r\n        }).catch(err => {\r\n          debug.log('Discord webhook not configured or failed:', err.message);\r\n        });\r\n      }\r\n    }\r\n  });\r\n\r\n  browserAPI.runtime.onMessage.addListener((request, sender, sendResponse) => {\r\n    if (request.action === 'toggleGMMode') {\r\n      toggleGMMode(request.enabled);\r\n      sendResponse({ success: true });\r\n    }\r\n\r\n    // Handle active character changes for experimental two-way sync\r\n    if (request.action === 'activeCharacterChanged') {\r\n      debug.log('\uD83D\uDD04 Active character changed, re-initializing sync:', request.characterId);\r\n\r\n      // Re-initialize the sync with the new character\r\n      if (window.diceCloudSync && typeof window.diceCloudSync.initialize === 'function') {\r\n        debug.log('\uD83D\uDD04 Re-initializing DiceCloud sync with character:', request.characterId);\r\n        window.diceCloudSync.initialize(request.characterId)\r\n          .then(() => {\r\n            debug.log('\u2705 DiceCloud sync re-initialized successfully');\r\n            sendResponse({ success: true });\r\n          })\r\n          .catch(error => {\r\n            debug.error('\u274C Failed to re-initialize DiceCloud sync:', error);\r\n            sendResponse({ success: false, error: error.message });\r\n          });\r\n        return true; // Keep message channel open for async response\r\n      } else {\r\n        debug.warn('\u26A0\uFE0F DiceCloud sync not available for re-initialization');\r\n        sendResponse({ success: false, error: 'Sync not available' });\r\n      }\r\n    }\r\n  });\r\n\r\n  // Listen for openGMMode custom event from character-sheet-overlay.js\r\n  document.addEventListener('openGMMode', () => {\r\n    debug.log('\u2705 Received openGMMode event - opening GM panel');\r\n    try {\r\n      postChatMessage('\uD83D\uDC51 Opening GM mode...');\r\n    } catch (error) {\r\n      debug.error(' Error posting chat message:', error);\r\n    }\r\n    toggleGMMode(true);\r\n  });\r\n\r\n  // Load player data from storage on initialization to ensure it's available\r\n  // for checks before GM panel is created\r\n  loadPlayerDataFromStorage();\r\n\r\n  // Initialize experimental two-way sync if available\r\n  if (typeof browserAPI !== 'undefined' && browserAPI.runtime) {\r\n    // Check if this is an experimental build by asking background script\r\n    browserAPI.runtime.sendMessage({ action: 'getManifest' }).then(response => {\r\n      if (response && response.success && response.manifest) {\r\n        debug.log('\uD83D\uDD0D Manifest check:', response.manifest);\r\n        debug.log('\uD83D\uDD0D Manifest name:', response.manifest.name);\r\n\r\n        if (response.manifest.name && response.manifest.name.toLowerCase().includes('experimental')) {\r\n          debug.log('\uD83E\uDDEA Experimental build detected, initializing two-way sync...');\r\n          \r\n          // Scripts are loaded as content scripts, just initialize\r\n          setTimeout(() => {\r\n            // Debug: Check what's available on window\r\n            debug.log('\uD83D\uDD0D Window objects check:', {\r\n              DDPClient: typeof window.DDPClient,\r\n              initializeDiceCloudSync: typeof window.initializeDiceCloudSync,\r\n              DiceCloudSync: typeof window.DiceCloudSync\r\n            });\r\n            \r\n            // Initialize the sync\r\n            if (typeof window.initializeDiceCloudSync === 'function') {\r\n              debug.log('\u2705 Calling initializeDiceCloudSync function...');\r\n              window.initializeDiceCloudSync();\r\n              debug.log('\u2705 Experimental two-way sync initialized');\r\n            } else {\r\n              debug.warn('\u26A0\uFE0F DiceCloud sync initialization function not found');\r\n              debug.warn('\u26A0\uFE0F Available window properties:', Object.keys(window).filter(key => key.toLowerCase().includes('dicecloud') || key.toLowerCase().includes('sync')));\r\n            }\r\n          }, 500); // Wait for content scripts to fully load\r\n        } else {\r\n          debug.log('\uD83D\uDCE6 Standard build detected, skipping experimental sync');\r\n        }\r\n      } else {\r\n        debug.log('\uD83D\uDCE6 Could not get manifest info, assuming standard build');\r\n      }\r\n    }).catch(error => {\r\n      debug.log('\uD83D\uDCE6 Standard build detected (error), skipping experimental sync:', error);\r\n    });\r\n  } else {\r\n    debug.log('\u274C browserAPI.runtime not available');\r\n  }\r\n\r\n  debug.log(' Roll20 script ready - listening for roll announcements and GM mode');\r\n})();"],
  "mappings": "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",
  "names": ["browserAPI", "debug", "chatObserver", "tabContent"]
}
